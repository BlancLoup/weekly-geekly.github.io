<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WiFi roaming - 802.11i / r / k / v / OKC, what we really need and how to recognize it</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When it comes to roaming, this concept usually hides two different processes. In the world of cellular networks, which came to us earlier, roaming mea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WiFi roaming - 802.11i / r / k / v / OKC, what we really need and how to recognize it</h1><div class="post__text post__text-html js-mediator-article">  When it comes to roaming, this concept usually hides two different processes.  In the world of cellular networks, which came to us earlier, roaming means the ability to work in a ‚Äúforeign‚Äù network, and not at all a seamless migration between base stations (handover).  The imperceptible movement between the cellular network BS is so natural that they remember very little about it. <br><br>  In the world of WiFi, things are different, and roaming usually implies an imperceptible for the user movement between access points of the same network - BSS transition, although the widespread introduction of SMS authentication in the near future should push operators to introduce roaming standards between foreign WiFi networks in the style of cellular infrastructure and based on its identification. <br><br>  The following is a description of existing roaming technologies and ways to identify them on unfamiliar equipment, it is assumed that the reader is familiar with the basic principles of WiFi. <br><a name="habracut"></a><br>  If you estimate switching roaming (which is a handover) on a WiFi network from the point of view of cellular networks, the most accurate description is this - it is <b>NO</b> , not provided by the standard, and for many years the situation has not changed.  In cellular networks, switching a subscriber to another BS initiates a network controller based on informational messages from the client, evaluating the signal from the neighboring bases on the client, the client always accepts the switch on WiFi itself - the database can only tell you how to do it faster.  But WiFi has a lot of standardized crutches, quite successfully allowing you to tuck in the process of changing the access point to 50 ms and keep the caller voice call over IP, as well as not standardized developments of each manufacturer, which can both help and exacerbate the already sad process (Ubiquity Zero HandOff - an example of when the crutch did worse than it was before).  Here you can easily throw a stone at the author, but what about 802.11r / v - but they are not at all obligatory within WiFi, are not supported by all devices, and do not imply anything like a forced translation with band reservation.  The choice of where and when to switch - all the same remains for the client.  Moreover, the inclusion of 802.11r will make it impossible for old clients to connect to the network, since  This is a required option on an 802.11 frame!  In some cases, it is not bad for you, but harmful (old drivers, scanners, printers, and the like). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Theory </h2><br>  Having a general introduction, it is worth briefly describing what and why it can be useful in WiFi for roaming (we will call it that way). <br><br><h3>  802.11i </h3><br>  The 2004 amendment to the standard in 2007 focuses on security and describes authentication and encryption (WPA2).  We are interested because  The key exchange procedure and interaction with external resources (RADIUS) together greatly slow down client switching between TDs.  The first principle of fast reconnection is described - the storage of the PMK key, though only for those points where the client has already completed the full procedure once - that is,  quick return to the network. <br><br><h3>  OKC (Opportunistic Key Caching) </h3><br>  The first known crutches, in the 802.1x authentication process, the access point retains the pairwise master key (PMK) key for each client, the idea was that this key be transmitted to neighboring points via the controller ‚Äî thereby eliminating new access to RADIUS and simplifying the exchange, was significantly reduced switching time to a new point.  It is not part of the standard, hence all that implies, but is supported by all serious manufacturers of WiFi-iron and some clients.  Without support from the client, the function is useless, for WPA2-PSK, however, too.  Some vendors forcibly try to use the method, seeing the stored key, even if the client did not request it in Request, sometimes works. <br><br><h3>  802.11k </h3><br>  <b>Radio Resource Management</b> , amendment of 2008, since 2012 in the standard, option.  The access point with a flag indicates support for the option in Beacon, sends a list of neighboring points to it when requested by the client, the client does not spend time scanning all available channels and immediately goes to the desired one and selects a new point.  The battery is saved, the general condition of the ether is also improved in High-Load.  Together with 802.11v, it can make the client's life comfortable enough not to think about other technologies (after all, the client chooses the candidate candidate anyway) - unless of course VoIP and 50 ms magic are important to WPA2-Enterprise.  Without customer support is useless. <br><br><h3>  802.11v </h3><br>  <b>Wireless Network Management (WNM)</b> amendments were published in 2011 and in 2012 entered the standard, a large number of options.  The main purpose is to efficiently manage the wireless environment ‚Äî to exchange data about the environment between the stations, to save the client, to improve the roaming and balancing process ‚Äî messages are sent to the client with suitable APs that address point-overload problems (Load-Balancing) and ‚Äústuck‚Äù clients with a weak signal, and some other features.  Assisted Power Saving sets the maximum timeout for the client, without requiring frequent keep-alive messages, the Direct Milticast Service allows you to receive multicast frames at the client‚Äôs connection speed, not cell speed ‚Äî which frees the air and saves the battery (these functions roam do not include).  But BSS Transition is very relevant - within its framework there are 3 types of messages, this is a request from the client to indicate the appropriate points, and two messages from the point - Load Balancing Request in case the point is overloaded, and asks the client to switch to another and Optimized Roaming Request if the RSSI and Data Rate do not meet the minimum requirements of the TD.  It is important to note that these are advisory messages, and the actions are left to the discretion of the client.  Forced disconnection is possible only within the framework of the proprietary technologies Band / Load Steering / Balancing, and may be incorrectly processed by the client, or ignored altogether (it is disabled by Disassociate frames). <br><br>  Sharing 802.11k / v gives a good result, and in most cases, home and low office networks are sufficient for customers, without creating problems for various devices.  Next comes heavy artillery - it radically solves the main problem, but can cause side effects - this is 802.11r. <br><br><h3>  802.11r / FT </h3> <br>  <b>Fast Roaming / Fast BSS Transition</b> - 802.11r is mandatory for the client when used on a spot, i.e.  those who do not support it cannot connect - this is a flag in management personnel and a modified key exchange mechanism, if the subscriber is old and does not know about its existence, he has a problem (on new devices, even without the support, functions sometimes add an understanding of this flag, although according to the standard, you need to fully implement the protocol).  It may also crash incorrect drivers of old client adapters - it‚Äôs a matter of using the 4 4-Way Handshake to distribute the shared key during the initial connection of the FT, this is what the standard says: " Protocol. <br><br>  Fast BSS Transition works with RSNA networks (Robust Security Network Association - WPA2) and fully open networks.  For WPA2-PSK, the meaning of fast roaming is lost, since  the client and the point are still exchanging 4 packets, there is nothing to speed up.  The calculations do not take into account the time to search for a suitable point, and for the 5 GHz range it can be fair - it is necessary to scan 16 channels and find a suitable AP, therefore the general strategy is to use the k / v and r protocols together. <br><br>  If you use RADIUS for authorization and want very fast roaming, you have no choice, only 802.11r! <br><br>  In addition to the roaming in 802.11r, there is potentially the possibility to poll the point about the availability of resources required by the client and to reserve them (QoS).  Accordingly, there are two subspecies of protocols - FT Protocol and FT Resource Request Protocol.  Communication between the client and the points can occur either directly through the air (Over-the-Air), or through the point used and controllers (Over-the-DS) - the second method is a little longer.  A QoS request from a point on clients is practically never implemented or used at all. <br><br>  The most important element of the frame is MDE, Mobility Domain Element, it is necessary for successful roaming, which is possible only within one domain. <br><br>  The time it takes to switch clients depending on the standard (‚ÄúPerformance Study of Fast BS Transition using IEEE 802.11r‚Äù by Sangeetha Bangolae, Carol Bell and Emily Qi): <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2bcfba7087735237.png"><br><br>  It is necessary to take into account that this is a ‚Äúpure‚Äù switching time, when the client has already decided that the connection is deteriorating and has found a new point! <br><br>  The practice of 802.11r roaming is perfectly described in the article <a href="https://habrahabr.ru/users/antonvn/" class="user_link">antonvn</a> , I see no reason to repeat. <br><br>  But the work of other additions can be considered by example.  Adding a line to a datasheet is not difficult, it‚Äôs harder to get this line to work.  I have a couple of Adtran Bluesocket points (BSAP 1925) at my disposal, this is the lower middle range, which is much under-functional in terms of functionality to market leaders, but provides good opportunities for integration into the carrier network and good stability and performance.  If you have only 2-3 points in one company, there is little sense for you in them (only if renting with a cloud controller), but for distributed or large-scale networks (10-20 +) it becomes interesting.  Cambium is next to them - they are not at hand for tests now, but colleagues praise them.  According to the description, Cambium has a little more functionality than Bluesocket (there is 802.11r, more types of tunnels for user traffic, the ability to work up to 24 points without an external controller, etc. small things), while Bluesocket has only 802.11k / v / OKC - full roaming r promise in the next software.  Aruba / Cisco / Ruckus predictably know everything that is available on the market - the truth is, will you really use it.  Testing cheap equipment is often an ungrateful task, Edimax brought us about a year ago, the stability of the portal manager then raised big questions, on which testing was completed without going into the depth of the functions.  There are doubts that in such a price category they were able to organize a full monitoring of the air and notifying about the client‚Äôs neighbors, I wonder if someone can check it out.  Ubiquiti does not support roaming yet, just like Mikrotik (which is a pity!). <br><br>  It should also be noted that the <b>presence of the function of notification of neighbors does not make much sense if the point does not know about them - i.e.</b>  <b>you need a background scan mode and a search for neighbors</b> .  The fact is that in the normal mode the points work only on their channel, and they simply cannot know about their neighbors!  The solution with the installation of all points on one channel was tested by Ubiquiti, proving in practice that this is a bad idea (nobody doubted it) - the capacity drops dramatically. <br><br><h2>  Used equipment </h2><br>  Two Bluesocket BSAP 1925 access points are used, two laptops use traffic on one AirMagnet WiFi Analyzer PRO software paired with an AirMagnet PCI Express Card 3 X 3, the second notebook for catching traffic on another channel - a MacBook 2016 with an 802.11ac adapter.  Judging by the dump, he coped with his task, using the program Airtool version 1.6.  Why not from one laptop?  We have 3 more Proxim Orinoco a / b / g / n USB adapters just for the purpose of simultaneous removal from 3 channels, but as it turned out, they do not work with most of the traffic of modern networks.  As soon as any fresh client or point appears on the air, the analyzer stops seeing most of the traffic.  Why is this happening, we tried to figure out, in the end, not having got to the depths of the details spat, something changes in the frame, probably 802.11ac.  The vendor reports that this is a physical feature of the adapters, and there will be no fix for them, keep in mind!  As a result, just recently Airmagnet released a software update and new USB adapters for it, but we don‚Äôt have them yet.  And you probably will not, like the Airmagnet analyzer, but do you really need it?  Everything described below can be seen on any device that can switch to monitor mode and parse all traffic in the 5 GHz band.  To understand the real-time transition, you need to run a dump on one computer for 2 channels with two independent adapters, since  When using 2 different machines, it is extremely difficult to accurately synchronize the time (I‚Äôm not sure exactly, but we are talking about milliseconds), and when one adapter goes over two channels, half of the traffic will be lost. <br><br>  Testing was done at home with friends, one point stood in the kitchen, another in the room, separated by a capital wall and saw each other with a minimum signal.  The situation and the presence of neighboring networks are similar to small offices.  The phone almost immediately when it entered the room switched to the point in it.  To complicate the task, the transition was made quickly, and the signal promptly fell immediately upon exiting the room around the corner - this scheme checked the client‚Äôs work more, the points did not have time to use the balancing system. <br><br><h2>  Work with dumps </h2><br>  Dumps were considered free and accessible to every Wireshark. <br><br>  <b>802.11k</b> <br>  The point announces the possibility of sending a list of neighbors in Beacon frames: <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2c47ad7806181070.png"><br><br>  The client, if he wants to receive a list of points by his SSID, sends an Action Frame.  In my case, the client requests a list of neighbors after connecting to the SSID (Wireshark filter by frame type wlan.fc.type_subtype eq 13): <br><br><img src="https://habrastorage.org/webt/59/e2/4e/59e24ee7eff34785947195.png"><br><br>  The answer with the list of neighboring points to the Neighbor List Report client from the current TD, indicating on which channel and which point to search for the client: <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2c47aea081150314.png"><br><br>  <b>802.11v</b> <br>  It did not work out to find traces of 802.11v work - to activate the work of balancing it is necessary to load the point well, and to wait for what will happen on the air, this time it was not possible to do this.  Bluesocket says adaptive balancing system, which always allows the client to connect to the desired radio, and then, if necessary, switches it.  It makes no sense to squeeze all the default to 5 GHz, when 2.4 is empty, also the client does not always have a sufficient signal level to use the five, and they prevent him from connecting to the pair.  By experience, balancing works, but I have not yet managed to catch her work in a full dump - this time only Disassociate messages were caught after the signal dropped and there was no response from the client, but the client reconnected by itself at that time.  Fresh devices, like my Xperia Z5, are immediately connected to 5 GHz, all new Apple devices come in the same way.  I limited myself to checking the provision of neighbors and dumping roaming on two channels simultaneously.  In the process of switching parsing, I saw quite an interesting thing: the device delayed transmission of certain packets when the channel is already installed and working, but there is no application traffic for a long time.  So, in real testing of a specific application, it is necessary to take into account the peculiarities of its operation and the network stack of your device - it is quite possible that it‚Äôs not your WiFi that is to blame for the delay! <br><br><h4>  Features of client stack </h4><br>  Next - the most interesting.  Dump from channel 44, where the client switched.  The dump shows that from the moment of the first request to the successful exchange of keys, 46 milliseconds take place - no 802.11r with the WPA2 using the preshared key is simply needed.  Everything depends on how quickly the client understands the need for switching and finds the right point.  But this is not the most interesting, the interesting lies in the fact that the traffic of the test application was absent for another 3 seconds!  For clarity, ping was launched at an interval of 15ms, the interval was not always followed due to the nature of WiFi and the lack of priority on traffic (Best Effort).  Ideally, of course, you need to test something more reasonable, but the program for launching ping was already on the device, so we were content with it. <br><br>  Authentication and successful connection: <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2cc27cc938668779.png"><br><br>  After connecting, network traffic appears, but this is not ICMP, but some other packets!  And only after 3 seconds, ICMP requests appear: <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2cc2c53546706082.png"><br><br>  This is what happens at the initial access point at this time. It‚Äôs hard to say whether the client started the connection procedure to a new point before completely disconnecting from the original one, as it follows from the dump, because  time may not be accurate: <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2c1260e549267475.png"><br><br>  After the access point receives the last packets from the client with a signal level of -80 dBm, and then the client does not acknowledge several packets, the point sends it Disassociate messages.  Probably, the client at this time is already conducting a successful transmission on a new channel, since  no one bothers him to switch to it to scan for available points without disconnecting from the current one, and in this case, it does not need to spend a lot of time. <br><br>  Visually, some switching delay is present, pings hang, but as the dump showed, this is not a WiFi problem.  A complete disconnection from the network on the device did not occur, the signal at the transition between the rooms falls, and then quickly returns to high values. <br><br>  If the <b>BSS Transition</b> functionality is supported, its presence in the dump is detected by the specified flag - the Probe Request frame from the client: <br><br><img src="https://habrastorage.org/webt/59/e2/3f/59e23f2bd6f3e547859577.png"><br><br><h3>  Findings? </h3><br>  Do not chase technology for the sake of technology, they do not always play a crucial role.  Even with the most fashionable WiFi-points, the last word for the client.  Focusing on the information provided, you yourself can check your points for compliance with the needs and functionality declared in the description, and choose the technologies that you need. <br><br>  Proper layout of the points in the room and network planning will provide good results even with low-cost equipment, just using top-end hardware, you can easily ruin the project with a thoughtless installation. </div><p>Source: <a href="https://habr.com/ru/post/340140/">https://habr.com/ru/post/340140/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340124/index.html">Crossing Task</a></li>
<li><a href="../340126/index.html">Automation of work with Logs API in AppMetrica. Lecture in Yandex</a></li>
<li><a href="../340132/index.html">Planning practices. Assessment of tasks</a></li>
<li><a href="../340136/index.html">Weekend Reading: 22 independent development, security, testing and game development blogs</a></li>
<li><a href="../340138/index.html">The digest of interesting materials for the mobile developer # 225 (October 9-October 15)</a></li>
<li><a href="../340144/index.html">Waf eyes hackers</a></li>
<li><a href="../340146/index.html">Five easy steps for understanding JSON Web Tokens (JWT)</a></li>
<li><a href="../340148/index.html">Digital events for the week</a></li>
<li><a href="../340150/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ284 (October 9 - 15, 2017)</a></li>
<li><a href="../340154/index.html">Change sex and race on a selfie using neural networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>