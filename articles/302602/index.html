<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a blog on symfony 2.8 lts [Part 4]</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Navigation in parts of the manual  Part 1 - Configuring Symfony2 and Templates 
 Part 2 - Contact page: validators, forms, and email 
 Part 3 - Doctri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a blog on symfony 2.8 lts [Part 4]</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/post/302602/"><img src="https://habrastorage.org/files/d15/094/63d/d1509463d7454fc799759026274e2d98.jpg"></a> <br><a name="habracut"></a><br><br><div class="spoiler">  <b class="spoiler_title">Navigation in parts of the manual</b> <div class="spoiler_text"><blockquote>  <a href="https://habrahabr.ru/post/301760/">Part 1 - Configuring Symfony2 and Templates</a> <br>  <a href="https://habrahabr.ru/post/302032/">Part 2 - Contact page: validators, forms, and email</a> <br>  <a href="https://habrahabr.ru/post/302438/">Part 3 - Doctrine 2 and Data Fixtures</a> <br>  <a href="https://habrahabr.ru/post/303114/">Part 5 - Twig Extensions, Sidebar (sidebar) and Assetic</a> <br>  <a href="https://habrahabr.ru/post/303578/">Part 6 - Modular and Functional Testing</a> <br></blockquote><br></div></div><br><br>  Project on <a href="">Github</a> <br><blockquote>  You can find out how to install the part of the manual you need in the description of the repository by the <a href="https://github.com/AntoscencoVladimir/symfony-blog">link</a> .  (For example, if you want to start with this lesson without going through the previous one) <br></blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Homepage </h4><br>  We will start this part by creating a home page.  In a regular blog posts are usually sorted from new to old.  The entire recording will be available via the link from the blog page.  Since we have already created a route, controller and display for the home page, we can easily update them. <br><br><h4>  Getting records.  Querying the database. </h4><br>  To display blog entries we need to retrieve them from the database.  Doctrine 2 provides us with <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/dql-doctrine-query-language.html">Doctrine Query Language (DQL)</a> and <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/query-builder.html">QueryBuilder</a> to achieve this goal (you can also do a normal SQL query through Doctrine 2, but this method is not recommended because it takes us away from the database abstraction that Doctrine 2 provides us. We will use QueryBuilder because it provides a good object-oriented way for us to generate a DQL that we can use for database queries. Let's update the indexAction method in the Page controller <code>src/Blogger/BlogBundle/Controller/PageController.php</code> to get entries from ba  s data. <div class="spoiler">  <b class="spoiler_title">Paste the following code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Controller/PageController.php class PageController extends Controller { public function indexAction() { $em = $this-&gt;getDoctrine() -&gt;getManager(); $blogs = $em-&gt;createQueryBuilder() -&gt;select('b') -&gt;from('BloggerBlogBundle:Blog', 'b') -&gt;addOrderBy('b.created', 'DESC') -&gt;getQuery() -&gt;getResult(); return $this-&gt;render('BloggerBlogBundle:Page:index.html.twig', array( 'blogs' =&gt; $blogs )); } // .. }</span></span></code> </pre> <br></div></div><br>  We started by getting an instance of QueryBuilder from Manager.  This will allow you to start creating a query using the many methods QueryBuilder provides us with.  A complete list of available methods can be found in the documentation for QueryBuilder.  Best to start with <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/query-builder.html">helper methods</a> .  These include select (), from (), and addOrderBy ().  As in the case of previous interactions with Doctrine 2, we can use short annotations to access the Blog entity via the BloggerBlogBundle: Blog <i>(</i> keep in mind <i>that this is the same as Blogger \ BlogBundle \ Entity \ Blog)</i> .  When we have finished specifying the criteria for the query, we call the getQuery () method, which returns an instance of DQL.  We cannot get results from the QueryBuilder object, we must always first convert it to a DQL instance.  An instance of the DQL object provides us with a getResult () method that returns a collection of Blog entries.  Later we will see that an instance of the DQL object has a variety of methods for returning results, including getSingleResult () and getArrayResult (). <br><br><h4>  Display </h4><br>  Now we have a collection of records and we need to display them.  Replace the content of the home page located <code>src/Blogger/BlogBundle/Resources/views/Page/index.html.twig</code> <div class="spoiler">  <b class="spoiler_title">as follows</b> <div class="spoiler_text"><pre> <code class="php hljs">{<span class="hljs-comment"><span class="hljs-comment"># src/Blogger/BlogBundle/Resources/views/Page/index.html.twig #} {% extends 'BloggerBlogBundle::layout.html.twig' %} {% block body %} {% for blog in blogs %} &lt;article class="blog"&gt; &lt;div class="date"&gt;&lt;time datetime="{{ blog.created|date('c') }}"&gt;{{ blog.created|date('l, F j, Y') }}&lt;/time&gt;&lt;/div&gt; &lt;header&gt; &lt;h2&gt;&lt;a href="{{ path('BloggerBlogBundle_blog_show', { 'id': blog.id }) }}"&gt;{{ blog.title }}&lt;/a&gt;&lt;/h2&gt; &lt;/header&gt; &lt;img src="{{ asset(['images/', blog.image]|join) }}" /&gt; &lt;div class="snippet"&gt; &lt;p&gt;{{ blog.blog(500) }}&lt;/p&gt; &lt;p class="continue"&gt;&lt;a href="{{ path('BloggerBlogBundle_blog_show', { 'id': blog.id }) }}"&gt;Continue reading...&lt;/a&gt;&lt;/p&gt; &lt;/div&gt; &lt;footer class="meta"&gt; &lt;p&gt;Comments: -&lt;/p&gt; &lt;p&gt;Posted by &lt;span class="highlight"&gt;{{blog.author}}&lt;/span&gt; at {{ blog.created|date('h:iA') }}&lt;/p&gt; &lt;p&gt;Tags: &lt;span class="highlight"&gt;{{ blog.tags }}&lt;/span&gt;&lt;/p&gt; &lt;/footer&gt; &lt;/article&gt; {% else %} &lt;p&gt;There are no blog entries for symblog&lt;/p&gt; {% endfor %} {% endblock %}</span></span></code> </pre><br></div></div><br><br>  We introduced one of the management structures of Twig, <i>for..else..endfor</i> .  If you have not previously used template engines, you will probably be familiar with the following PHP code. <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($blogs)): <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($blogs <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $blog): <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;h1&gt;<span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $blog-&gt;getTitle() <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span>h1&gt; &lt;!-- rest of content --&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">endforeach</span></span> <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> &lt;p&gt;There are no blog entries&lt;/p&gt; <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span> <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  The Twig <i>for..else..endfor</i> control structure is an easier way to accomplish this.  Most of the code in the homepage template concerns the output of blog information in HTML format.  However, there are several points that we need to take into account.  First, we use the Twig Path function to create routes.  Since the blog page requires the ID of the entry passed to the URL, we need to insert it as an argument to the path function.  This can be seen in this code snippet: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{ path('BloggerBlogBundle_blog_show', { 'id': blog.id }) }}"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ blog.title }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Secondly, we return content using <pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>{{blog.blog(500) }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre>  The number 500 is the maximum length of the post that we want to get back from the function.  To do this, we need to update the getBlog method that Doctrine 2 generated for us earlier.  Update the getBlog method in the Blog Entity, located <pre> <code class="php hljs"> src/Blogger/BlogBundle/Entity/Blog.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Blog.php public function getBlog($length = null) { if (false === is_null($length) &amp;&amp; $length &gt; 0) return substr($this-&gt;blog, 0, $length); else return $this-&gt;blog; }</span></span></code> </pre><br><br>  Since the getBlog method should return the entire blog post, we will set the <b>$ length</b> parameter which will have a default value of <b>null</b> .  If <b>null</b> is passed, the entire entry is returned. <br>  Now, if you enter <a href="http://localhost:8000/">localhost: 8000</a> into your browser, you should see a home page displaying the latest blog entries.  You should also have the opportunity to go to the full blog entry by clicking on the title of the post or on the link " <i>Continue reading ...</i> ". <br><br><img src="https://habrastorage.org/files/4cd/7ae/786/4cd7ae78695a4034aaf7796888318a0f.png"><br><br>  While we can request entries in the controller, this is not the best place for this.  The request will be better placed outside the controller due to a number of reasons: <br>  We will not be able to reuse the query anywhere else in the application, without duplicating the QueryBuilder code. <br>  If we duplicated the QueryBuilder code, we would have to make a few changes in the future if the query would need to be changed. <br>  Separating the request and controller will allow us to test the request independently of the controller. <br>  Doctrine 2 provides repository classes to facilitate this task. <br><br><h4>  Doctrine 2 Repositories </h4><br>  We already talked a little about the Doctrine 2 Repository classes in the previous chapter when we created the blog page.  We used the default implementation of the <i>Doctrine \ ORM \ EntityRepository class</i> to retrieve a blog entry from the database using the find () method.  Since we need a user request for the database, we need to create a user repository.  Doctrine 2 can help with this task.  Update Blog <i>Entity</i> Metadata in <i>src / Blogger / BlogBundle / Entity / Blog.php file</i> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Blog.php /** * @ORM\Entity(repositoryClass="Blogger\BlogBundle\Entity\Repository\BlogRepository") * @ORM\Table(name="blog") * @ORM\HasLifecycleCallbacks() */ class Blog { // .. }</span></span></code> </pre><br><br>  You can see that we have defined the namespace for the BlogRepository class with which this entity is associated.  Since we updated Doctrine 2 metadata for the Blog entity, we need to rerun the <b>doctrine: generate: entities</b> command as follows. <br><pre> <code class="bash hljs">$ php app/console doctrine:generate:entities Blogger\BlogBundle</code> </pre><br>  Doctrine 2 will create a wrapper around the BlogRepository class located at <code>src/Blogger/BlogBundle/Entity/Repository/BlogRepository.php</code> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Blogger</span></span>\<span class="hljs-title"><span class="hljs-title">BlogBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Repository</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * BlogRepository * * This class was generated by the Doctrine ORM. Add your own custom * repository methods below. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlogRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Doctrine</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ORM</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityRepository</span></span></span><span class="hljs-class"> </span></span>{ }</code> </pre><br><br>  The BlogRepository class extends the EntityRepository class, which is provided by the find () method that we used earlier.  Let's update the BlogRepository class by moving the QueryBuilder code from the Page controller to it. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Blogger</span></span>\<span class="hljs-title"><span class="hljs-title">BlogBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Repository</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * BlogRepository * * This class was generated by the Doctrine ORM. Add your own custom * repository methods below. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BlogRepository</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> \</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Doctrine</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ORM</span></span></span><span class="hljs-class">\</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLatestBlogs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($limit = null)</span></span></span><span class="hljs-function"> </span></span>{ $qb = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;createQueryBuilder(<span class="hljs-string"><span class="hljs-string">'b'</span></span>) -&gt;select(<span class="hljs-string"><span class="hljs-string">'b'</span></span>) -&gt;addOrderBy(<span class="hljs-string"><span class="hljs-string">'b.created'</span></span>, <span class="hljs-string"><span class="hljs-string">'DESC'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> === is_null($limit)) $qb-&gt;setMaxResults($limit); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $qb-&gt;getQuery() -&gt;getResult(); } }</code> </pre><br><br>  We created a getLatestBlogs method that will return the latest blog entries, in the same way as the QueryBuilder code did in the controller.  In the repository class, we have direct access to the QueryBuilder using the createQueryBuilder () method.  We also added the default parameter $ limit, so we can limit the number of returned results.  The result of the query will be the same as it was with the controller.  You may have noticed that we do not need to specify an object using the from () method.  This is due to the fact that we are in the BlogRepository, which is associated with the essence of Blog.  If we look at the implementation of the createQueryBuilder method in the EntityRepository class, we can see that the from () method was called for us. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// Doctrine\ORM\EntityRepository public function createQueryBuilder($alias, $indexBy = null) { return $this-&gt;_em-&gt;createQueryBuilder() -&gt;select($alias) -&gt;from($this-&gt;_entityName, $alias, $indexBy); }</span></span></code> </pre><br>  Finally, let's update the indexAction method in the Page controller to use BlogRepository. <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Controller/PageController.php class PageController extends Controller { public function indexAction() { $em = $this-&gt;getDoctrine() -&gt;getManager(); $blogs = $em-&gt;getRepository('BloggerBlogBundle:Blog') -&gt;getLatestBlogs(); return $this-&gt;render('BloggerBlogBundle:Page:index.html.twig', array( 'blogs' =&gt; $blogs )); } // .. }</span></span></code> </pre><br>  Now, when we update the homepage, the exact same thing as before will be displayed.  All we did was reorganize the code so that the well-formed classes perform the tasks correctly. <br><br><h4>  Read more about the model: Creating a Comment entity </h4><br>  Entries are only half the story when it comes to blogging.  We must also allow readers to comment on blog entries.  These comments should also be saved and linked to the essence of the Blog as the entry may contain many comments. <br>  We begin by defining the basis, the Comment entity class.  Create a new file located in <code>src/Blogger/BlogBundle/Entity/Comment.php</code> and paste <div class="spoiler">  <b class="spoiler_title">following</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Comment.php namespace Blogger\BlogBundle\Entity; use Doctrine\ORM\Mapping as ORM; /** * @ORM\Entity(repositoryClass="Blogger\BlogBundle\Entity\Repository\CommentRepository") * @ORM\Table(name="comment") * @ORM\HasLifecycleCallbacks */ class Comment { /** * @ORM\Id * @ORM\Column(type="integer") * @ORM\GeneratedValue(strategy="AUTO") */ protected $id; /** * @ORM\Column(type="string") */ protected $user; /** * @ORM\Column(type="text") */ protected $comment; /** * @ORM\Column(type="boolean") */ protected $approved; /** * @ORM\ManyToOne(targetEntity="Blog", inversedBy="comments") * @ORM\JoinColumn(name="blog_id", referencedColumnName="id") */ protected $blog; /** * @ORM\Column(type="datetime") */ protected $created; /** * @ORM\Column(type="datetime") */ protected $updated; public function __construct() { $this-&gt;setCreated(new \DateTime()); $this-&gt;setUpdated(new \DateTime()); $this-&gt;setApproved(true); } /** * @ORM\preUpdate */ public function setUpdatedValue() { $this-&gt;setUpdated(new \DateTime()); } }</span></span></code> </pre><br></div></div><br>  Most of what you see here is covered in the previous section, but we used metadata to create a link to the essence of Blog.  Since the comment relates to the post, we set the link in the Comment entity to the Blog entity to which it belongs.  We did this by pointing the ManyToOne link to the blog entity.  We also indicated that the feedback for this link will be available through comments.  To invert, we need to update the Blog Entity so Doctrine 2 will know that the post may contain many comments.  Update Blog Entity <code>src/Blogger/BlogBundle/Entity/Blog.php</code> <br><div class="spoiler">  <b class="spoiler_title">Insert code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Blog.php namespace Blogger\BlogBundle\Entity; use Doctrine\ORM\Mapping as ORM; use Doctrine\Common\Collections\ArrayCollection; /** * @ORM\Entity(repositoryClass="Blogger\BlogBundle\Entity\Repository\BlogRepository") * @ORM\Table(name="blog") * @ORM\HasLifecycleCallbacks */ class Blog { // .. /** * @ORM\OneToMany(targetEntity="Comment", mappedBy="blog") */ protected $comments; // .. public function __construct() { $this-&gt;comments = new ArrayCollection(); $this-&gt;setCreated(new \DateTime()); $this-&gt;setUpdated(new \DateTime()); } // .. }</span></span></code> </pre><br></div></div><br>  There are several changes to point out.  First, we added metadata to the $ comments object.  Remember, in the previous chapter, we didn‚Äôt add metadata to this object because we didn‚Äôt want Doctrine 2 to save it?  This is still the case, however, we want Doctrine 2 to be able to fill this object with the appropriate Comment entries.  That is what metadata allows to achieve.  Second, Doctrine 2 requires that we set the default value for the $ comments object in the ArrayCollection.  We will do this in the constructor.  Also note the <b>use</b> statement that imports the ArrayCollection class. <br><br>  Since we created the Comment entity and updated the Blog entity, let's create access methods.  Run the following Doctrine 2 command. <br><pre> <code class="bash hljs">$ php app/console doctrine:generate:entities Blogger\BlogBundle</code> </pre><br><br>  Both entities will be updated with the correct access methods.  You will also notice that in <br> <code>src/Blogger/BlogBundle/Entity/Repository/CommentRepository.php <br></code> <br>  The CommentRepository class has been created since we specified this in the metadata. <br><br>  Finally, we need to update the database to reflect the changes in our entities.  We could use the <i>doctrine: schema: update</i> command, which is shown below, to do this, but instead we‚Äôll tell you about Doctrine 2 Migrations. <br><pre> <code class="bash hljs">$ php app/console doctrine:schema:update --force</code> </pre><br><h4>  Doctrine Migrations 2 </h4><br>  The Doctrine 2 Migrations extension and the bundle is not supplied with symfony2, we have to manually install them.  Open the <i>composer.json</i> file located in the project root and paste the Doctrine 2 and Bundle Migration dependencies as shown below. <br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">"require"</span></span>: { <span class="hljs-comment"><span class="hljs-comment">// ... "doctrine/doctrine-migrations-bundle": "dev-master", "doctrine/migrations": "dev-master" }</span></span></code> </pre><br>  Next, update the library with the command. <br><pre> <code class="bash hljs">$ composer update</code> </pre><br>  This will update all the libraries from Github and install them in the necessary directories. <br>  Now let's register a bundle in a kernel located in <i>app / AppKernel.php</i> <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/AppKernel.php public function registerBundles() { $bundles = array( // ... new Doctrine\Bundle\MigrationsBundle\DoctrineMigrationsBundle(), // ... ); // ... }</span></span></code> </pre><br><br>  Now we are ready to update the database to reflect the changes in essence, this process will take place in 2 stages.  First, we must instruct Doctrine 2 Migrations to work with the differences between entities and the current database schema.  This is done by the doctrine: migrations: diff command.  Secondly, we need to perform a migration based on the data created by the first team.  This is done by the <i>doctrine: migrations: migrate</i> command. <br>  Run the following 2 commands to update the database schema. <br><pre> <code class="bash hljs">$ php app/console doctrine:migrations:diff $ php app/console doctrine:migrations:migrate</code> </pre><br>  The warning shown below is answered with <b>yes</b> . <br>  WARNING!  You can‚Äôt end up with a schema of changes and data lost.  Are you sure you want to continue?  (y / n): <b>yes</b> <br><br>  Now your database will reflect the latest changes to the entities and contain a new table of comments. <br><br><blockquote>  <i>The note</i> <br><br>  You will also see a new table in the database called <i>migration_versions</i> .  It stores the version numbers of the migrations so there is a command with which you can find out which version of the database is currently. <br></blockquote><br><br><blockquote>  <i>The board</i> <br><br>  Doctrine 2 Migrations are a great way to update a database on production, because the changes can be made programmatically.  This means that we can integrate this task into the project deployment scenario, so the database will update automatically when a new version of the application is deployed.  Doctrine 2 migrations also allow you to roll back the changes, since each migration has an up and down method.  To roll back to the previous version, you need to specify the version number to which you would like to return, you can do it, as shown below. <br><pre> <code class="bash hljs">$ php app/console doctrine:migrations:migrate 20110806183439</code> </pre><br></blockquote><br><h4>  Data patterns </h4><br><br>  Now that we have a Comment entity, let's add Data Fixtures.  This is a good moment, at the time when you are creating an entity.  We know that the comment must have a connection with the Blog entity, as we have indicated in the metadata, so when creating fixtures for the Comment entities, we will need to specify the Blog entity.  We already created fixtures for the Blog entity, so we could just update this file to add Comment entities.  This can be managed now, but what happens when we later add users and other entities to our bundle?  It would be best to create a new file for fixing the Comment entity.  The problem with this approach is how we get access to Blog entries from blog fixtures. <br><br>  Fortunately, this can be easily achieved by adding a reference to objects in the fixture file to which other fixture files have access.  Update the Data Entry Ficures of the Blog Entity located <code>src/Blogger/BlogBundle/DataFixtures/ORM/BlogFixtures.php</code> <br><div class="spoiler">  <b class="spoiler_title">as follows</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/DataFixtures/ORM/BlogFixtures.php namespace Blogger\BlogBundle\DataFixtures\ORM; use Doctrine\Common\DataFixtures\AbstractFixture; use Doctrine\Common\DataFixtures\OrderedFixtureInterface; use Doctrine\Common\Persistence\ObjectManager; use Blogger\BlogBundle\Entity\Blog; class BlogFixtures extends AbstractFixture implements OrderedFixtureInterface { public function load(ObjectManager $manager) { // .. $manager-&gt;flush(); $this-&gt;addReference('blog-1', $blog1); $this-&gt;addReference('blog-2', $blog2); $this-&gt;addReference('blog-3', $blog3); $this-&gt;addReference('blog-4', $blog4); $this-&gt;addReference('blog-5', $blog5); } public function getOrder() { return 1; } }</span></span></code> </pre><br></div></div><br>  The changes that are worth noting here are the extension of the AbstractFixture class and the implementation of the OrderedFixtureInterface.  Also pay attention to the 2 new <b>use</b> operators importing these classes. <br><br>  We add links to blog entities using the addReference () method.  This first parameter is the link identifier that we can use to retrieve the object later.  Finally, we must implement the getOrder () method to specify the order of loading the fixtures.  Entries must be uploaded before comments so we return 1. <br><br><h4>  Fixtures Comment </h4><br><br>  Now we are ready to define the fixtures for the Comment entity.  Create the <code>src/Blogger/BlogBundle/DataFixtures/ORM/CommentFixtures.php</code> <br>  and paste <div class="spoiler">  <b class="spoiler_title">following</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/DataFixtures/ORM/CommentFixtures.php namespace Blogger\BlogBundle\DataFixtures\ORM; use Doctrine\Common\DataFixtures\AbstractFixture; use Doctrine\Common\DataFixtures\OrderedFixtureInterface; use Doctrine\Common\Persistence\ObjectManager; use Blogger\BlogBundle\Entity\Comment; use Blogger\BlogBundle\Entity\Blog; class CommentFixtures extends AbstractFixture implements OrderedFixtureInterface { public function load(ObjectManager $manager) { $comment = new Comment(); $comment-&gt;setUser('symfony'); $comment-&gt;setComment('To make a long story short. You can\'t go wrong by choosing Symfony! And no one has ever been fired for using Symfony.'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-1'))); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('David'); $comment-&gt;setComment('To make a long story short. Choosing a framework must not be taken lightly; it is a long-term commitment. Make sure that you make the right selection!'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-1'))); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Dade'); $comment-&gt;setComment('Anything else, mom? You want me to mow the lawn? Oops! I forgot, New York, No grass.'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Kate'); $comment-&gt;setComment('Are you challenging me? '); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 06:15:20")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Dade'); $comment-&gt;setComment('Name your stakes.'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 06:18:35")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Kate'); $comment-&gt;setComment('If I win, you become my slave.'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 06:22:53")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Dade'); $comment-&gt;setComment('Your SLAVE?'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 06:25:15")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Kate'); $comment-&gt;setComment('You wish! You\'ll do shitwork, scan, crack copyrights...'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 06:46:08")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Dade'); $comment-&gt;setComment('And if I win?'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 10:22:46")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Kate'); $comment-&gt;setComment('Make it my first-born!'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-23 11:08:08")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Dade'); $comment-&gt;setComment('Make it our first-date!'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-24 18:56:01")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Kate'); $comment-&gt;setComment('I don\'t DO dates. But I don\'t lose either, so you\'re on!'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-2'))); $comment-&gt;setCreated(new \DateTime("2011-07-25 22:28:42")); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Stanley'); $comment-&gt;setComment('It\'s not gonna end like this.'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-3'))); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Gabriel'); $comment-&gt;setComment('Oh, come on, Stan. Not everything ends the way you think it should. Besides, audiences love happy endings.'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-3'))); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Mile'); $comment-&gt;setComment('Doesn\'t Bill Gates have something like that?'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-5'))); $manager-&gt;persist($comment); $comment = new Comment(); $comment-&gt;setUser('Gary'); $comment-&gt;setComment('Bill Who?'); $comment-&gt;setBlog($manager-&gt;merge($this-&gt;getReference('blog-5'))); $manager-&gt;persist($comment); $manager-&gt;flush(); } public function getOrder() { return 2; } }</span></span></code> </pre><br></div></div><br><br>  With the changes we made in the BlogFixtures class, the CommentFixtures class also extends the AbstractFixture class and implements the OrderedFixtureInterface.  This means that we must also implement the getOrder () method.  This time we return the value 2, thus providing the fixtures after the fixtures of the records. <br><br>    ,      Blog    . <br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$comment</span></span>-&gt;setBlog(<span class="hljs-variable"><span class="hljs-variable">$manager</span></span>-&gt;merge(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getReference(<span class="hljs-string"><span class="hljs-string">'blog-2'</span></span>)));</code> </pre><br>         <br><pre> <code class="bash hljs">$ php app/console doctrine:fixtures:load</code> </pre><br>   : <b>yes</b> <br> Careful, database will be purged. Do you want to continue y/N ? <b>yes</b> <br><br><h4>   </h4><br>     ,      .     CommentRepository ,        . <br><br><h4>  Comment </h4><br>   CommentRepository  <code>src/Blogger/BlogBundle/Entity/Repository/CommentRepository.php</code>   <br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Repository/CommentRepository.php namespace Blogger\BlogBundle\Entity\Repository; use Doctrine\ORM\EntityRepository; /** * CommentRepository * * This class was generated by the Doctrine ORM. Add your own custom * repository methods below. */ class CommentRepository extends EntityRepository { public function getCommentsForBlog($blogId, $approved = true) { $qb = $this-&gt;createQueryBuilder('c') -&gt;select('c') -&gt;where('c.blog = :blog_id') -&gt;addOrderBy('c.created') -&gt;setParameter('blog_id', $blogId); if (false === is_null($approved)) $qb-&gt;andWhere('c.approved = :approved') -&gt;setParameter('approved', $approved); return $qb-&gt;getQuery() -&gt;getResult(); } }</span></span></code> </pre><br></div></div><br> ,         .      where    .  where   ,      setParameter().       ,       <br> <code>-&gt;where('c.blog = ' . blogId)</code> <br>     $blogId           SQL injection. <br><br><h4>  Blog </h4><br>     showAction   Blog   .   Blog <code>src/Blogger/BlogBundle/Controller/BlogController.php</code> <br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Controller/BlogController.php public function showAction($id) { // .. if (!$blog) { throw $this-&gt;createNotFoundException('Unable to find Blog post.'); } $comments = $em-&gt;getRepository('BloggerBlogBundle:Comment') -&gt;getCommentsForBlog($blog-&gt;getId()); return $this-&gt;render('BloggerBlogBundle:Blog:show.html.twig', array( 'blog' =&gt; $blog, 'comments' =&gt; $comments )); }</span></span></code> </pre><br></div></div><br>      <i>CommentRepository</i>    .  <b>$comments</b>    . <br><br><h4>  Blog show </h4><br>             Blog show   .           Blog show,        ,   ,     ,     .            .   Blog <code>show src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig</code> <div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs">{<span class="hljs-comment"><span class="hljs-comment"># src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig #} {# .. #} {% block body %} {# .. #} &lt;section class="comments" id="comments"&gt; &lt;section class="previous-comments"&gt; &lt;h3&gt;Comments&lt;/h3&gt; {% include 'BloggerBlogBundle:Comment:index.html.twig' with { 'comments': comments } %} &lt;/section&gt; &lt;/section&gt; {% endblock %}</span></span></code> </pre><br></div></div><br>      Twig <b>include</b> .      <b>BloggerBlogBundle:Comment:index.html.twig</b> .         .         Comment   . <br><br><h4>  Comment show </h4><br> <b>BloggerBlogBundle:Comment:index.html.twig</b>       ,     .     ,   ,           .    <br> <code>src/Blogger/BlogBundle/Resources/views/Comment/index.html.twig</code> <br>   <div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs">{<span class="hljs-comment"><span class="hljs-comment"># src/Blogger/BlogBundle/Resources/views/Comment/index.html.twig #} {% for comment in comments %} &lt;article class="comment {{ cycle(['odd', 'even'], loop.index0) }}" id="comment-{{ comment.id }}"&gt; &lt;header&gt; &lt;p&gt;&lt;span class="highlight"&gt;{{ comment.user }}&lt;/span&gt; commented &lt;time datetime="{{ comment.created|date('c') }}"&gt;{{ comment.created|date('l, F j, Y') }}&lt;/time&gt;&lt;/p&gt; &lt;/header&gt; &lt;p&gt;{{ comment.comment }}&lt;/p&gt; &lt;/article&gt; {% else %} &lt;p&gt;There are no comments for this post. Be the first to comment...&lt;/p&gt; {% endfor %}</span></span></code> </pre><br></div></div><br><br>    ,     Comment   .        Twig, cycle.       ,   ,     .         <b>loop.index0</b> .     ,   0.       ,      .      HTML-ID  article .         . <br><br><h4> Comment show CSS </h4><br><br>  ,    CSS,    .  ,   <code>src/Blogger/BlogBundle/Resouces/public/css/blog.css</code> <br><pre> <code class="css hljs"><span class="hljs-comment"><span class="hljs-comment">/** src/Blogger/BlogBundle/Resorces/public/css/blog.css **/</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.comments</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">clear</span></span>: both; } <span class="hljs-selector-class"><span class="hljs-selector-class">.comments</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.odd</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#eee</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.comments</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.comment</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.comments</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.comment</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-selector-class"><span class="hljs-selector-class">.comments</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">h3</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: <span class="hljs-number"><span class="hljs-number">#eee</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">padding</span></span>: <span class="hljs-number"><span class="hljs-number">10px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">font-size</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">clear</span></span>: both; } <span class="hljs-selector-class"><span class="hljs-selector-class">.comments</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.previous-comments</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">margin-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">20px</span></span>; }</code> </pre><br><br><blockquote> <i></i> <br><br>           assets    web,       assets   . <br><pre> <code class="bash hljs">$ php app/console assets:install web</code> </pre><br></blockquote><br><br>       show pages, , <a href="http://localhost:8000/2">http://localhost:8000/2</a>       . <br><br><img src="https://habrastorage.org/files/ecb/d73/7fc/ecbd737fcbc64c4e82baf797f44f22bc.png"><br><br><h4>   </h4><br>          ,      .        blog show.        Symfony 2      .       ,    Symfony2,      .       CommentType   Comment. <br><pre> <code class="bash hljs">$ php app/console generate:doctrine:form BloggerBlogBundle:Comment</code> </pre><br><br>         Comment. <br><br><blockquote>  <i>hint</i> <br><br>  ,      <b>doctrine:generate:form</b> .      -. <br></blockquote><br><br>    CommentType  <code>src/Blogger/BlogBundle/Form/CommentType.php</code> <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Blogger</span></span>\<span class="hljs-title"><span class="hljs-title">BlogBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractType</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">FormBuilderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">OptionsResolver</span></span>\<span class="hljs-title"><span class="hljs-title">OptionsResolver</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> FormBuilderInterface $builder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $options */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormBuilderInterface $builder, array $options)</span></span></span><span class="hljs-function"> </span></span>{ $builder -&gt;add(<span class="hljs-string"><span class="hljs-string">'user'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'approved'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'created'</span></span>, <span class="hljs-string"><span class="hljs-string">'datetime'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'updated'</span></span>, <span class="hljs-string"><span class="hljs-string">'datetime'</span></span>) -&gt;add(<span class="hljs-string"><span class="hljs-string">'blog'</span></span>) ; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> OptionsResolver $resolver */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureOptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OptionsResolver $resolver)</span></span></span><span class="hljs-function"> </span></span>{ $resolver-&gt;setDefaults(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'data_class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Blogger\BlogBundle\Entity\Comment'</span></span> )); } }</code> </pre><br></div></div><br><br>   ,   ,    Enquiry Type.         ,      . <br><br><h4>   . </h4><br>    ,       blog show,        showAction  Blog       show.       ,       .          ,      ,   . <br><br><h4>  Route </h4><br>        .   ,  <code>src/Blogger/BlogBundle/Resources/config/routing.yml</code> <br><pre> <code class="php hljs">BloggerBlogBundle_comment_create: path: /comment/{blog_id} defaults: { _controller: <span class="hljs-string"><span class="hljs-string">"BloggerBlogBundle:Comment:create"</span></span> } requirements: methods: POST blog_id: \d+</code> </pre><br><br><h4>  </h4><br> ,     CommentControler    .   ,   src/Blogger/BlogBundle/Controller/CommentController.php   <div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Controller/CommentController.php namespace Blogger\BlogBundle\Controller; use Symfony\Bundle\FrameworkBundle\Controller\Controller; use Blogger\BlogBundle\Entity\Comment; use Blogger\BlogBundle\Form\CommentType; use Symfony\Component\HttpFoundation\Request; /** * Comment controller. */ class CommentController extends Controller { public function newAction($blog_id) { $blog = $this-&gt;getBlog($blog_id); $comment = new Comment(); $comment-&gt;setBlog($blog); $form = $this-&gt;createForm(CommentType::class, $comment); return $this-&gt;render('BloggerBlogBundle:Comment:form.html.twig', array( 'comment' =&gt; $comment, 'form' =&gt; $form-&gt;createView() )); } public function createAction(Request $request, $blog_id) { $blog = $this-&gt;getBlog($blog_id); $comment = new Comment(); $comment-&gt;setBlog($blog); $form = $this-&gt;createForm(CommentType::class, $comment); $form-&gt;handleRequest($request); if ($form-&gt;isValid()) { // </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Persist the comment entity return $this-&gt;redirect($this-&gt;generateUrl('BloggerBlogBundle_blog_show', array( 'id' =&gt; $comment-&gt;getBlog()-&gt;getId())) . '#comment-' . $comment-&gt;getId() ); } return $this-&gt;render('BloggerBlogBundle:Comment:create.html.twig', array( 'comment' =&gt; $comment, 'form' =&gt; $form-&gt;createView() )); } protected function getBlog($blog_id) { $em = $this-&gt;getDoctrine() -&gt;getManager(); $blog = $em-&gt;getRepository('BloggerBlogBundle:Blog')-&gt;find($blog_id); if (!$blog) { throw $this-&gt;createNotFoundException('Unable to find Blog post.'); } return $blog; } }</span></span></code> </pre><br></div></div><br><br>   2    Comment,   new    create.  new      ,  create     .       ,    ,      ,     . ,     ,      ,     Comment. <br><br><h4>   </h4><br><br>   ,            <b>user</b>  <b>comment</b> .   ,            .   Comment  <code>src/Blogger/BlogBundle/Entity/Comment.php</code> <br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Comment.php // .. use Symfony\Component\Validator\Mapping\ClassMetadata; use Symfony\Component\Validator\Constraints\NotBlank; // .. class Comment { // .. public static function loadValidatorMetadata(ClassMetadata $metadata) { $metadata-&gt;addPropertyConstraint('user', new NotBlank(array( 'message' =&gt; 'You must enter your name' ))); $metadata-&gt;addPropertyConstraint('comment', new NotBlank(array( 'message' =&gt; 'You must enter a comment' ))); } // .. }</span></span></code> </pre><br></div></div><br>      user  comment.      .      ClassMetadata  NotBlank,   . <br><br><h4>  </h4><br><br>     2    new  create .   ,   <code>src/Blogger/BlogBundle/Resources/views/Comment/form.html.twig</code>   <div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs">{<span class="hljs-comment"><span class="hljs-comment"># src/Blogger/BlogBundle/Resources/views/Comment/form.html.twig #} {{ form_start(form, { 'action': path('BloggerBlogBundle_comment_create' , { 'blog_id' : comment.blog.id }), 'method': 'POST', 'attr': {'class': 'blogger'} }) }} {{ form_widget(form) }} &lt;p&gt; &lt;input type="submit" value="Submit"&gt; &lt;/p&gt;</span></span></code> </pre><br></div></div><br><br>     ,     .   ,   action   POST     ,    <i>BloggerBlogBundle_comment_create</i> . <br><br>      create .   ,   <code>src/Blogger/BlogBundle/Resources/views/Comment/create.html.twig</code>   <div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs">{% extends <span class="hljs-string"><span class="hljs-string">'BloggerBlogBundle::layout.html.twig'</span></span> %} {% block title %}Add Comment{% endblock%} {% block body %} &lt;h1&gt;Add comment <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> blog post <span class="hljs-string"><span class="hljs-string">"{{ comment.blog.title }}"</span></span>&lt;/h1&gt; {% <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'BloggerBlogBundle:Comment:form.html.twig'</span></span> with { <span class="hljs-string"><span class="hljs-string">'form'</span></span>: form } %} {% endblock %}</code> </pre><br></div></div><br><br>    <i>createAction</i>  Comment     ,        ,      .    <i>BloggerBlogBundle:Comment:form.html.twig</i>       . <br><br>     blog show   .   <code>src/Blogger/BlogBundle/Resources/views/Blog/show.html</code> <br><pre> <code class="php hljs">{<span class="hljs-comment"><span class="hljs-comment"># src/Blogger/BlogBundle/Resources/views/Blog/show.html.twig #} {# .. #} {% block body %} {# .. #} &lt;section class="comments" id="comments"&gt; {# .. #} &lt;h3&gt;Add Comment&lt;/h3&gt; {{ render(controller('BloggerBlogBundle:Comment:new',{ 'blog_id': blog.id })) }} &lt;/section&gt; {% endblock %}</span></span></code> </pre><br><br>      Twig, render.       .       BloggerBlogBundle:Comment:new <br><br>         ,   <a href="http://localhost:8000/2">http://localhost:8000/2</a>   ,  . <br><img src="https://habrastorage.org/files/776/90f/d22/77690fd227274dd1a6b7084198cc6088.png"><br><br>     BloggerBlogBundle:Blog:show.html.twig.      23  <i>BloggerBlogBundle:Blog:show.html.twig</i>  ,    ,         <i>BloggerBlogBundle:Comment:create</i> . <br><br><pre> <code class="php hljs">{{ render(controller(<span class="hljs-string"><span class="hljs-string">'BloggerBlogBundle:Comment:new'</span></span>,{ <span class="hljs-string"><span class="hljs-string">'blog_id'</span></span>: blog.id })) }}</code> </pre> <br><br>               ,    . <br>     ,  ,        __toString ()  ,   .     ,      , ,  select ( ).    ,        ?        ,  ,        Twig {{form_widget(form)}}.     .         CommentType.   ,          FormBuilder.  ,    blog. <br><br>   ,    ,    ,  FormBuilder          ,   .        Comment  Blog, FormBuilder ,     choice ,     ,     .      choice          Symfony 2.        __toString()    Blog. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Entity/Blog.php public function __toString() { return $this-&gt;getTitle(); }</span></span></code> </pre><br><br><blockquote>  <i>hint</i> <br><br>    Symfony2     ,  .     ,         .       ,      ,   ,   . <br></blockquote><br><br> ,    ,      .   ,         approved, created, updated  blog.   ,       CommentType . <br><br><blockquote>  <i>hint</i> <br><br>  ,      .   text,   textarea, 2  DateTime   ,  . <br><br>   -  FormBuilder   ,    .       ,   .          Comment,  FormBuilder       . <br></blockquote><br><br>    ,   src/Blogger/BlogBundle/Form/CommentType.php     ,   , <div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Blogger</span></span>\<span class="hljs-title"><span class="hljs-title">BlogBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractType</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Form</span></span>\<span class="hljs-title"><span class="hljs-title">FormBuilderInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">OptionsResolver</span></span>\<span class="hljs-title"><span class="hljs-title">OptionsResolver</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommentType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> FormBuilderInterface $builder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $options */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildForm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FormBuilderInterface $builder, array $options)</span></span></span><span class="hljs-function"> </span></span>{ $builder-&gt;add(<span class="hljs-string"><span class="hljs-string">'user'</span></span>); $builder-&gt;add(<span class="hljs-string"><span class="hljs-string">'comment'</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> OptionsResolver $resolver */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureOptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OptionsResolver $resolver)</span></span></span><span class="hljs-function"> </span></span>{ $resolver-&gt;setDefaults(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'data_class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'Blogger\BlogBundle\Entity\Comment'</span></span> )); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBlockPrefix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'blogger_blogbundle_commenttype'</span></span>; } }</code> </pre><br></div></div><br> ,               .     ,       . ,         ,    .         ?   ,       .   createAction   . <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// src/Blogger/BlogBundle/Controller/CommentController.php public function createAction(Request $request, $blog_id) { //.. if ($form-&gt;isValid()) { $em = $this-&gt;getDoctrine() -&gt;getManager(); $em-&gt;persist($comment); $em-&gt;flush(); return $this-&gt;redirect($this-&gt;generateUrl('BloggerBlogBundle_blog_show', array( 'id' =&gt; $comment-&gt;getBlog()-&gt;getId())) . '#comment-' . $comment-&gt;getId() ); } //.. }</span></span></code> </pre><br>   Comment     <i>persist()</i>  <i>flush()</i> . ,      PHP-,  Doctrine 2     .             . <br><br>           . <br><br><img src="https://habrastorage.org/files/bbe/1c5/467/bbe1c5467616426c88d325b97d4f9d00.png"><br><br><h4>  Conclusion </h4><br><br>       .         .           ,   .  ,   ,          Doctrine 2          . <br><br>       (sidebar),         .       Twig         .      Assetic ,       assets. <br><br>    : <br><br> <a href="https://symfony.com/">https://symfony.com/</a> <br> <a href="http://tutorial.symblog.co.uk/">http://tutorial.symblog.co.uk/</a> <br> <a href="http://twig.sensiolabs.org/">http://twig.sensiolabs.org/</a> <br> <a href="http://www.doctrine-project.org/">http://www.doctrine-project.org/</a> <br> <a href="http://odiszapc.ru/doctrine/">http://odiszapc.ru/doctrine/</a> <br><br><div class="spoiler"> <b class="spoiler_title">Post Scriptum</b> <div class="spoiler_text"><blockquote>         ,       ,      ,   . </blockquote><br></div></div><br><blockquote>  <a href="https://habrahabr.ru/post/301760/">Part 1 - Configuring Symfony2 and Templates</a> <br>  <a href="https://habrahabr.ru/post/302032/">Part 2 - Contact page: validators, forms, and email</a> <br>  <a href="https://habrahabr.ru/post/302438/">Part 3 - Doctrine 2 and Data Fixtures</a> <br>  <a href="https://habrahabr.ru/post/303114/">Part 5 - Twig Extensions, Sidebar (sidebar) and Assetic</a> <br>  <a href="https://habrahabr.ru/post/303578/">Part 6 - Modular and Functional Testing</a> <br></blockquote><br><br> ,         <a href="https://github.com/AntoscencoVladimir/symfony-blog"> </a>  .  Thank. </div><p>Source: <a href="https://habr.com/ru/post/302602/">https://habr.com/ru/post/302602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302580/index.html">How I caught a Wi-Fi printer via OSPF, corporate network on MikroTik part 2</a></li>
<li><a href="../302590/index.html">Launch queues and the Laravel scheduler in the Elastic Beanstalk environment</a></li>
<li><a href="../302594/index.html">Client-side Linq to NHibernate</a></li>
<li><a href="../302598/index.html">SMS as a secret weapon</a></li>
<li><a href="../302600/index.html">BGP Inter-AS</a></li>
<li><a href="../302606/index.html">About the three-dimensional Z-order put in a word</a></li>
<li><a href="../302608/index.html">Create a secure IP messenger with Virgil and Twilio in 30 minutes</a></li>
<li><a href="../302610/index.html">How have the career ladders and elevators in the IT industry changed over the past week?</a></li>
<li><a href="../302612/index.html">A simple and free way to make payments with Payoneer</a></li>
<li><a href="../302614/index.html">The fight for the regions: How to online store to win against an offline retailer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>