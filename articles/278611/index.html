<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reverse engineering "Kazakov", part two: increase the queue</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In most cases, the word "turn" does not cause positive emotions, especially in combination with the word "enlarge". But if you like to play with milli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reverse engineering "Kazakov", part two: increase the queue</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/762/2f5/0f4/7622f50f486c4d1b878982981077d70b.png"><br><br>  In most cases, the word "turn" does not cause positive emotions, especially in combination with the word "enlarge".  But if you like to play with millions of resources at the beginning of the game, to throw thousands of soldiers into battle in the tenth minute, then the standard order for five units of combat using the Shift key will not be enough.  Now, if it were possible to order for 20 or 50 soldiers, or even better - to have several different modifier keys ... <a name="habracut"></a><br><br><h4>  Introduction </h4><br>  After the publication of the <a href="https://habrahabr.ru/post/277067/">previous article</a> and the interest from the <abbr title="League Cossackers Net">LCN</abbr> community, I was asked if I could increase the queue number of order of combat units from five to 20 or 50. ‚ÄúWhy not,‚Äù I thought, ‚Äúand in general, if you're lucky, you only need one byte from 0x05 to 0x14 to replace, and that's it. ‚Äù 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If I knew then what it would turn out ... But I did not know, so let's go! <br><br><h4>  Where do we start? </h4><br>  Naturally, with the search for the desired part of the machine code.  There is a choice: you can search for a place where mouse clicks are processed and try to track the code to the branch responsible for ordering combat units.  Or you can bypass all the places where the state of the Shift key is checked.  The second option seemed to me more promising.  We start the <abbr title="IDA Pro">program, which is our favorite for such cases,</abbr> and look at the list of imported functions. <br><br>  Hmm, GetKeyState sounds promising.  What we have on cross-references?  One hundred and eighteen calls?  Too much, we need to weed out those calls in which the Shift key is not checked.  The <a href="https://msdn.microsoft.com/de-de/library/windows/desktop/ms646301(v%3Dvs.85).aspx">GetKeyState</a> function takes only one parameter, namely the <a href="https://msdn.microsoft.com/de-de/library/windows/desktop/ms646301(v%3Dvs.85).aspx">keycode</a> , which for Shift is 0x10.  In my dmcr.exe, this corresponds to such a piece of machine code: <br><br><pre><code class="markdown hljs">push 10h 6A 10 call GetKeyState FF 15 EC C1 5C 00</code> </pre> <br>  The search for this byte sequence yielded 38 addresses where GetKeyState (VK_SHIFT) is called.  We arrange the breakpoint on each of them, launch the debugger and remove the extra ones, until we get to the necessary procedure.  To be precise, there are two procedures: one to order combat units and one to cancel.  But since they differ only in the address of the function called in them, then we will consider them as one procedure. <br><br>  This is what awaits us there: <br><br><img src="https://habrastorage.org/files/300/253/d13/300253d1339f4f3aab887228bf9f1932.png"><br><br>  Well, of course.  What does the compiler do when it sees a small loop with a small but constant number of executions?  That's right, it unfolds it into a repeating sequence of instructions for the loop body.  Hope for a single-byte patch waved a pen at ease. <br><br><h4>  Patch one or dwell in assembly language </h4><br>  For the cycle, we need a counter, an increment, a comparison, and a conditional jump.  The body of the cycle will remain unchanged except for editing the offset of the function call according to the new address of the call instruction. <br><br>  After some <s>smoking of the manuals</s> <a href="http://ref.x86asm.net/coder32.html">for studying the</a> <a href="http://www.mathemainzel.info/files/x86asmref.html">documentation</a> , the following machine code sketch was created: <br><br><pre> <code class="markdown hljs">;     push cx 66 51 ;   xor cx, cx 66 31 C9 ;   ;  -     push cx 66 51 ;  ,      mov dx, word ptr [ebp+arg<span class="hljs-emphasis"><span class="hljs-emphasis">_0] 66 8B 55 F0 push edx 52 xor eax, eax 33 C0 mov al, byte_</span></span>10FC290 A0 90 C2 0F 01 xor eax, 85h 35 85 00 00 00 push eax 50 call sub_4FD01E E8 .. .. .. .. add esp, 8 83 C4 08 ; ,    - pop cx 66 59 inc cx 66 41 cmp cx, 14h 66 83 F9 14 ;    ,    20 jl 7C DA ;      pop cx 66 59</code> </pre><br><div class="spoiler">  <b class="spoiler_title">A small digression about cx and 66h</b> <div class="spoiler_text">  The cx register is considered a ‚Äúloop register‚Äù and is used with the loop instruction.  Although I decided to use the usual combination of inc, cmp and jl instead of loop, I still left cx as a register counter.  However, when selecting machine commands, I had a problem: whatever I did, in the end, operations with the ecx register always came out instead of his younger brother.  I had to resort to the help of <a href="https://defuse.ca/online-x86-assembler.htm">online assembler</a> .  What was my surprise when, in response to my sketch, he issued mostly the same operational codes, but with the prefix 0x66.  The documentation describes operational code 66h as ‚ÄúOperand-size override prefix.  Reserved and may result in unpredictable behavior ".  With this description it is not surprising that he did not rush to my eyes before.  The prefix 0x66 causes the machine codes that operate with 32-bit registers to switch to their 16-bit counterparts and vice versa. <br></div></div><br>  Despite the fact that this patch leads to the desired result, it has one major drawback: without interfering with the logic of the game, you can override the size of the production queue created using the Shift modifier key, but no more.  Patching the line before each game, depending on the conditions of the game, is not a very attractive prospect, so the community quite quickly voiced the desire to have different queue modifiers on the Shift, Alt, and ~ keys.  Well, the challenge is accepted! <br><br><h4>  Patch two or ‚Äúprogram maximum‚Äù </h4><br>  Replacing a sequence of five repeating blocks with one cycle, we freed a decent amount of bytes.  But how to integrate the test of several keys and the adjustment of the cycle depending on the result into the resulting space?  The simplest solution in my opinion is the successive calls to GetKeyState, alternating with assigning the corresponding value to the register, with which the counter in the loop will be compared.  If a call to GetKeyState indicates that the key is not pressed, the assignment instruction is jumped over.  Thus, instead of forks, depending on the state of the keys, we will have a series of consecutive checks and assignments, ending in one cycle: <br><br><pre> <code class="markdown hljs">;   ,      ,     mov ebx, 01h BB 01 00 00 00 ;   push 10h 6A 10 call GetKeyState FF 15 EC C1 5C 00 movsx ecx, ax 0F BF C8 and ecx, 8000h 81 E1 00 80 00 00 test ecx, ecx 85 C9 ;      mov,      jz 74 05 mov ebx, 05h BB 05 00 00 00 ;   push 12h 6A 12 call GetKeyState FF 15 EC C1 5C 00 [...]</code> </pre><br>  This time I decided to use the ebx register to save the number of loop executions and the esi register as a loop counter.  There are two reasons for this.  Following the <a href="http://www.delorie.com/djgpp/doc/ug/asm/calling.html">convention on calling functions,</a> these registers are ‚Äúpermanent‚Äù, i.e.  if changes are made in the body of the function, the function must save their values ‚Äã‚Äãon the stack and restore them before completion.  This frees me from having to push and pop myself before each execution of the loop.  The second reason is that, unlike the cx register, I no longer need the 0x66 prefix, and this is saving one byte on every register operation except mov. <br><br>  As a result, we have the modifier keys Shift, Alt, TAB, F1 and F2.  The ~ key had to be abandoned, since different <a href="https://msdn.microsoft.com/de-de/library/windows/desktop/dd375731(v%3Dvs.85).aspx">identifiers</a> correspond to it on different layouts, for example VK_OEM_3 and VK_OEM_5. <br><br><div class="spoiler">  <b class="spoiler_title">Final Patch Code</b> <div class="spoiler_text"><pre> <code class="markdown hljs">;     push ebx 53 ;   ,      ,     mov ebx, 01h BB 01 00 00 00 ; Shift: 5   push 10h 6A 10 call GetKeyState FF 15 EC C1 5C 00 movsx ecx, ax 0F BF C8 and ecx, 8000h 81 E1 00 80 00 00 test ecx, ecx 85 C9 jz 74 05 mov ebx, 05h BB 05 00 00 00 ; Alt: 20   push 12h 6A 12 call GetKeyState FF 15 EC C1 5C 00 movsx ecx, ax 0F BF C8 and ecx, 8000h 81 E1 00 80 00 00 test ecx, ecx 85 C9 jz 74 05 mov ebx, 14h BB 14 00 00 00 ; TAB: 50   push 09h 6A 09 call GetKeyState FF 15 EC C1 5C 00 movsx ecx, ax 0F BF C8 and ecx, 8000h 81 E1 00 80 00 00 test ecx, ecx 85 C9 jz 74 05 mov ebx, 32h BB 32 00 00 00 ; F1: 15   push 70h 6A 70 call GetKeyState FF 15 EC C1 5C 00 movsx ecx, ax 0F BF C8 and ecx, 8000h 81 E1 00 80 00 00 test ecx, ecx 85 C9 jz 74 05 mov ebx, 0Fh BB 0F 00 00 00 ; F2: 36   push 71h 6A 71 call GetKeyState FF 15 EC C1 5C 00 movsx ecx, ax 0F BF C8 and ecx, 8000h 81 E1 00 80 00 00 test ecx, ecx 85 C9 jz 74 05 mov ebx, 24h BB 24 00 00 00 ;    -  push esi 56 xor esi, esi 31 F6 ;   mov dx, word ptr [ebp+arg<span class="hljs-emphasis"><span class="hljs-emphasis">_0] 66 8B 55 F0 push edx 52 xor eax, eax 33 C0 mov al, byte_</span></span>10FC290 A0 90 C2 0F 01 xor eax, 85h 35 85 00 00 00 push eax 50 call sub_4FD01E E8 .. .. .. .. add esp, 8 83 C4 08 ; , ,     inc esi 46 cmp esi, ebx 39 DE jl 7C E1 ;   pop esi 5E pop ebx 5B</code> </pre></div></div><br><h4>  Afterword </h4><br>  At this point, we can say that the task is completed and go to wash our hands.  Or you can write a miniature patcher that allows the players to set the queue size for each of the modifier keys ... But this is about in the next article. <br><br><h5>  Links </h5><ul><li>  <a href="http://www.mathemainzel.info/files/x86asmref.html">Intel 80x86 Machine Code List</a> </li><li>  <a href="http://ref.x86asm.net/coder32.html">Computer Operating x86 Codes</a> </li><li>  <a href="https://defuse.ca/online-x86-assembler.htm">Convenient online assembler and disassembler</a> </li><li>  <a href="http://www.delorie.com/djgpp/doc/ug/asm/calling.html">Function Call Agreement in GCC</a> </li><li>  <a href="http://www.tutorialspoint.com/assembly_programming/assembly_registers.htm">Registers in assembler</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/278611/">https://habr.com/ru/post/278611/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278599/index.html">We send Angular 2 routs through Laravel 5 router</a></li>
<li><a href="../278601/index.html">WG Labs Announces Developer Contest</a></li>
<li><a href="../278603/index.html">Build FreeType library for Android x86 using NDK</a></li>
<li><a href="../278605/index.html">The history of one technology. Mob</a></li>
<li><a href="../278607/index.html">libuniset2 is a library for creating ACS. It‚Äôs better to see once ... Part 5 (uniset2-testsuite)</a></li>
<li><a href="../278613/index.html">Juniper MX + IX + SynFlood</a></li>
<li><a href="../278615/index.html">ZeroNet - A truly distributed network - a year later</a></li>
<li><a href="../278617/index.html">Vivaldi Beta 3 browser release</a></li>
<li><a href="../278619/index.html">EDA approach in Angular</a></li>
<li><a href="../278621/index.html">Selection of materials for the novice developer of JavaScript games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>