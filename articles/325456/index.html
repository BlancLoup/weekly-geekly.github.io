<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create a bot for Skype. Step by step through REST API and in Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When looking for long-polling in the Skype API 

 A year ago, Microsoft introduced a platform for creating bots for Skype. The platform provides a con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create a bot for Skype. Step by step through REST API and in Python</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/a2a/559/31a/a2a55931a62040b8854ad542048817c5.jpg"></div><br>  <i>When looking for long-polling in the Skype API</i> <br><br>  A year ago, Microsoft <a href="https://geektimes.ru/post/273618/">introduced a</a> platform for creating bots for Skype.  The platform provides a convenient message format, you can send cards with buttons, as in a telegram, in a word, everything looks very cool. <br><br>  Recently, I needed to write a bot for Skype.  And despite the fact that the topic was raised on a habr ( <a href="https://habrahabr.ru/post/281296/">for example</a> ), I faced some difficulties, I really did not have enough step-by-step guide on working with REST API. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In fact, the bot for skype is written quite quickly, if you know about the pitfalls and know <a href="https://docs.botframework.com/en-us/restapi/connector/">where</a> to watch the documentation.  The main idea I had to learn was: No web polling.  If Telegram is provided by a long-polling and webbooks, then Skype can be managed only by webhacks.  From this, the following problems arise - communication with Skype servers occurs only via https, and only with a valid certificate.  We'll have to find the domain name, hosting, bother with the certificate. <br><a name="habracut"></a><br><h3>  How to do it? </h3><br>  So, from the very beginning.  Suppose that we have a bare hosting (I had this Raspberry Pi, on which I tested the bot, but it could be a server on Amazon, for example).  First, you need to get a domain name and a certificate for it.  Free domain names can be obtained for example <a href="http://www.freenom.com/en/index.html%3Flang%3Den">here</a> .  Next we need to get a certificate for this name.  This is easiest to do with <a href="https://certbot.eff.org/">Let's Encrypt</a> .  During the certificate installation process, select the option standalone server - certbot will launch its server to verify that you own this domain name before issuing a certificate for it.  After you have succeeded, you must have certificates in the ‚Äú/ etc / letsencrypt / archive‚Äù folder. <br><br>  Now that everything is ready for work, let's start writing a bot. <br><br>  <b>1.</b> Much is described in <a href="https://habrahabr.ru/post/281296/">this article</a> , we need two points: Here <a href="https://apps.dev.microsoft.com/">we</a> create our application, and <a href="https://developer.microsoft.com/en-us/skype/bots/manage">here we</a> register the bot.  When registering, you need to specify the endpoint, where Microsoft will send messages.  It is specified in the same form as it is written in the browser.  After endpoint, you can specify a port, then it will look like this: ‚Äúhttps: // endpoint_url: port‚Äù After registration, you will need to generate a password, and that's all we needed to get at the moment.  At the moment we should have: application_id (with which we registered the bot) and password (which we just received). <br><br>  <b>2.</b> You have not forgotten about the webcam?  It is time to raise the server for which we previously received certificates.  On the python for this fitsk.  First of all, let's define global variables (not a very nice solution, but very simple), and start automatically receiving and updating the token in a separate thread: <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre><code class="python hljs">FLASK = Flask(__name__) APP_ID = <span class="hljs-string"><span class="hljs-string">''</span></span> PASSWORD = <span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-comment"><span class="hljs-comment">#    context =('fullchain.pem', 'privkey.pem') #      ,   certbot TOKEN = {} def get_token(): global TOKEN url = 'https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token' payload = {'grant_type': 'client_credentials', 'client_id': APP_ID, 'client_secret': PASSWORD, 'scope': 'https://api.botframework.com/.default', } token = requests.post('https://login.microsoftonline.com/botframework.com/oauth2/v2.0/token', data=payload).content TOKEN = json.loads(str(token)[2:-1]) return json.loads(str(token)[2:-1]) def send_token_to_connector(token): url = 'https://groupme.botframework.com/v3/conversations' headers = {'Authorization': 'Bearer ' + token} r = requests.post(url, headers=headers) return r def get_and_verify_token(): global TOKEN while True: get_token() send_token_to_connector(TOKEN['access_token']) time.sleep(TOKEN['expires_in']*0.9)</span></span></code> </pre> <br></div></div><br>  <b>3.</b> Let's write a handler function for incoming messages: <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@FLASK.route('/', methods=['GET', 'POST']) def handle(): data = request.get_json() talk_id = data['conversation']['id'] msg = { "type": "message", "from": { "id": APP_ID, "name": "habraechobot" }, "conversation": { "id": talk_id, }, "text": data['text'], } url = data['serviceUrl'] + '/v3/conversations/{}/activities/'.format(data['conversation']['id']) headers = {'Authorization': 'Bearer ' + TOKEN['access_token'], 'content-type': 'application/json; charset=utf8'} r = requests.post(url, headers=headers, data=json.dumps(msg)) return 'success'</span></span></code> </pre> <br></div></div><br>  <b>4.</b> And finally, let's start the server: <br><br><div class="spoiler">  <b class="spoiler_title">View code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: thread = Thread( target=get_and_verify_token ) thread.start() FLASK.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">8080</span></span>, ssl_context=context)</code> </pre><br></div></div><br>  That's all - the full code of the bot can be taken <a href="https://github.com/AverageS/echobot">from here</a> , I hope my article was useful and will save someone time and effort. </div><p>Source: <a href="https://habr.com/ru/post/325456/">https://habr.com/ru/post/325456/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325446/index.html">Scala: parser combinators on the example of the formula parser</a></li>
<li><a href="../325448/index.html">The holy family of information technology (April theses in the form of critical criticism)</a></li>
<li><a href="../325450/index.html">We set up a free build for writing and debugging programs for microcontrollers based on the ARM kernel under Windows 10</a></li>
<li><a href="../325452/index.html">PHP: Storing sessions in protected cookies</a></li>
<li><a href="../325454/index.html">Go application development: logic reuse</a></li>
<li><a href="../325458/index.html">Secure access from anywhere in the world using Microsoft DirectAccess and Windows To Go. Part One - Theory</a></li>
<li><a href="../325460/index.html">Product Design Digest March 2017</a></li>
<li><a href="../325462/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ256 (March 27 - April 2, 2017)</a></li>
<li><a href="../325464/index.html">Vector pictures with gradient in Android 5.0</a></li>
<li><a href="../325468/index.html">How not to step on a rake in Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>