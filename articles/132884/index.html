<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does ConcurrentHashMap</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In October, a wonderful article appeared on Habr√© about the work of HashMap . Continuing this topic, I'm going to talk about the implementation of jav...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does ConcurrentHashMap</h1><div class="post__text post__text-html js-mediator-article">  In October, a wonderful <a href="http://habrahabr.ru/blogs/java/128017/">article</a> appeared on Habr√© <a href="http://habrahabr.ru/blogs/java/128017/">about the work of HashMap</a> .  Continuing this topic, I'm going to talk about the implementation of java.util.concurrent.ConcurrentHashMap. <br>  So, how did ConcurrentHashMap come about, what advantages did it have and how was it implemented. <br><a name="habracut"></a><br><h4>  Prerequisites for creating a ConcurrentHashMap </h4><br>  Before the introduction of ConcurrentHashMap in JDK 1.5, there were several ways to describe hash tables. <br>  Initially, JDK 1.0 was Hashtable class.  Hashtable is a thread-safe and easy-to-use hash table implementation.  The problem of the HashTable was, first of all, that when accessing the table elements it was completely locked.  All Hashtable methods were synchronized.  This was a serious limitation for a multi-threaded environment, since the cost of locking the entire table was very large. <br>  In JDK 1.2, HashMap came to the aid of Hashtable and its thread-safe view, Collections.synchronizedMap.  There were several reasons for this separation: <br><ul><li>  Not every programmer and not every solution needed a thread-safe hash table. </li><li>  The programmer had to give a choice, which option is convenient for him to use </li></ul><br>  Thus, with JDK 1.2, the list of options for the implementation of hash cards in Java has been extended in two more ways.  However, these methods did not save the developers from appearing race conditions in their code, which could lead to the appearance of ConcurrentModificationException.  <a href="http%253A%252F%252Fwww.ibm.com%252Fdeveloperworks%252Fjava%252Flibrary%252Fj-jtp07233%252Findex.html%26ei%3DKA7GToKaMMyP4gTwyLwq%26usg%3DAFQjCNGtNGy_kSensR24ApSUPDVTL1cPLw%26sig2%3DAUkyNoUufyEVR6blpQO0nw%26cad%3Drja">This article</a> describes in more detail the possible reasons for their appearance in the code. <br>  And so, in JDK 1.5, a more productive and scalable version finally appears. <br><br><h4>  ConcurrentHashMap </h4><br>  By the time ConcurrentHashMap appeared, Java developers needed the following implementation of a hash map: <br><ul><li>  Thread safety </li><li>  No locks of the entire table while it is being accessed </li><li>  It is desirable that there were no table locks when performing a read operation. </li></ul><br>  <a href="http://en.wikipedia.org/wiki/Doug_Lea">Doug Lea</a> is an embodiment of a data structure that is included in JDK 1.5. <br>  What are the main ideas for implementing ConcurrentHashMap? <br><br><h5>  1. Map elements </h5><br>  Unlike the HashMap elements, the Entry in ConcurrentHashMap is declared as volatile.  This is an important feature, also associated with changes in the JMM.  Doug Lea's response to the need to use volatile and possible race condition can be found <a href="http://stackoverflow.com/questions/5002428/concurrenthashmap-reorder-instruction">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> static final class HashEntry &lt;K, V&gt; {
     final K key;
     final int hash;
     volatile V value;
     final HashEntry &lt;K, V&gt; next;

     HashEntry (K key, int hash, HashEntry &lt;K, V&gt; next, V value) {
         this .key = key;
         this .hash = hash;
         this .next = next;
         this .value = value;
      }

     @SuppressWarnings ("unchecked")
     static final &lt;K, V&gt; HashEntry &lt;K, V&gt; [] newArray (int i) {
         return new HashEntry [i];
     }
 }
</pre><br><h5>  2. Hash function </h5><br>  ConcurrentHashMap also uses an improved hash function. <br>  Let me remind you what it was in HashMap from JDK 1.2: <br><br><pre> static int hash (int h) {
     h ^ = (h &gt;&gt;&gt; 20) ^ (h &gt;&gt;&gt; 12);
     return h ^ (h &gt;&gt;&gt; 7) ^ (h &gt;&gt;&gt; 4);
 }
</pre><br>  ConcurrentHashMap JDK 1.5 version: <br><br><pre> private static int hash (int h) {
     h + = (h &lt;&lt; 15) ^ 0xffffcd7d;
     h ^ = (h &gt;&gt;&gt; 10);
     h + = (h &lt;&lt; 3);
     h ^ = (h &gt;&gt;&gt; 6);
     h + = (h &lt;&lt; 2) + (h &lt;&lt; 14);
     return h ^ (h &gt;&gt;&gt; 16);
 }
</pre><br>  What is the need to complicate the hash function?  Tables in a hash map have a length determined by a power of two.  For hash codes whose binary representations do not differ in the junior and senior positions, we will have collisions.  Complicating the hash function just solves this problem, reducing the likelihood of collisions in the map. <br><br><h5>  3. Segments </h5><br>  The map is divided into N different segments (16 by default, the maximum value can be 16-bit and be a power of two).  Each segment is a thread-safe table of map elements. <br>  A dependency is established between the hash codes of the keys and their corresponding segments based on the application of a bit mask to the high-order bits. <br>  Here‚Äôs how the map stores the elements: <br><br><pre>     final Segment &lt;K, V&gt; [] segments;
     transient Set &lt;K&gt; keySet;
     transient Set &lt;Map.Entry &lt;K, V &gt;&gt; entrySet;
     transient Collection &lt;V&gt; values;
</pre><br>  Consider what a segment class is: <br><br><pre> static final class Segment &lt;K, V&gt; extends ReentrantLock implements 
                     Serializable {
     private static final long serialVersionUID = 2249069246763182397L;
     transient volatile int count;
     transient int modCount;
     transient int threshold;
     transient volatile HashEntry &lt;K, V&gt; [] table;

      final float loadFactor;

     Segment (int initialCapacity, float lf) {
          loadFactor = lf;
          setTable (HashEntry. &lt;K, V&gt; newArray (initialCapacity));
      }

     ...
 }
</pre><br>  Given the pseudo-random distribution of key hashes within the table, it can be understood that increasing the number of segments will cause the modification operations to affect different segments, which will reduce the likelihood of locks during execution. <br><br><h5>  4. ConcurrencyLevel </h5><br>  This parameter affects the use of the memory card and the number of segments in the card. <br>  Let's look at the creation of the map and how the concurrencyLevel specified as a parameter of the constructor affects: <br><br><pre> public ConcurrentHashMap (int initialCapacity, float loadFactor, int concurrencyLevel) {
      if (! (loadFactor&gt; 0) || initialCapacity &lt;0
           ||  concurrencyLevel &lt;= 0)
      throw new IllegalArgumentException ();

      if (concurrencyLevel&gt; MAX_SEGMENTS)
      concurrencyLevel = MAX_SEGMENTS;

      // Find the power-of-two sizes
      int sshift = 0;
      int ssize = 1;
      while (ssize &lt;concurrencyLevel) {
           ++ sshift;
           ssize &lt;&lt; = 1;
      }
      segmentShift = 32 - sshift;
      segmentMask = ssize - 1;
      this .segments = Segment.newArray (ssize);

      if (initialCapacity&gt; MAXIMUM_CAPACITY)
           initialCapacity = MAXIMUM_CAPACITY;
      int c = initialCapacity / ssize;
      if (c * ssize &lt;initialCapacity)
           ++ c;
      int cap = 1;
      while (cap &lt;c)
           cap &lt;&lt; = 1;

      for (int i = 0; i &lt;this .segments.length; ++ i)
           this .segments [i] = new Segment &lt;K, V&gt; (cap, loadFactor);
 }
</pre><br><br>  The number of segments will be chosen as the nearest power of two, greater than concurrencyLevel.  The capacity of each segment, respectively, will be defined as the ratio of the default card capacity value rounded to the nearest greater degree two to the number of segments obtained. <br>  It is very important to understand the following two things.  An understating of concurrencyLevel leads to the fact that blocking by streams of map segments during recording is more likely.  An overestimation of the indicator leads to inefficient use of memory. <br><br><h6>  How to choose concurrencyLevel? </h6><br>  If only one stream will change the map, and the rest will read, it is recommended to use the value 1. <br><br>  It must be remembered that resize tables for storage inside a picture is an operation that requires additional time (and, often, is not performed quickly).  Therefore, when creating a map, it is necessary to have some rough estimates of the statistics for the performance of possible read and write operations. <br><br><h4>  Scalability estimates </h4><br>  On javamex you can find <a href="http://www.javamex.com/tutorials/concurrenthashmap_scalability.shtml">an article</a> on synchronizedMap versus ConcurrentHashMap scalability comparison: <br><img src="https://habrastorage.org/getpro/habr/post_images/9ec/0eb/5fb/9ec0eb5fb73d6bd0e4d79cae2fd20bf6.png" alt="image"><br>  As can be seen from the graph, between 5 and 10 million card access operations is a noticeable serious discrepancy, which determines the effectiveness of using ConcurrentHashMap in the case of a high amount of stored data and access operations to them. <br><br><h4>  Total </h4><br>  So, the main advantages and features of the implementation of ConcurrentHashMap: <br><ul><li>  The card has a hashmap-like interaction interface. </li><li>  Read operations do not require locks and are performed in parallel </li><li>  Recordings can often also be performed concurrently without locks. </li><li>  During creation, the required concurrencyLevel is specified, which is determined by the read and write statistics </li><li>  Map elements have value declared as volatile. </li></ul><br>  In conclusion, I would like to say that ConcurrentHashMap should be applied correctly, with a preliminary assessment of the ratio of reading and writing to the card.  It also still makes sense to use HashMap in programs where there is no multiple access from multiple threads to a stored map. <br>  Thank you for your attention! <br><br>  Useful resources for parallel collections in Java and, in particular, for the work of ConcurrentHashMap: <br><ol><li>  <a href="http://www.ibm.com/developerworks/ru/library/j-jtp07233/index.html">www.ibm.com/developerworks/ru/library/j-jtp07233/index.html</a> </li><li>  <a href="http://stas-blogspot.blogspot.com/2010/08/concurrenthashmap-revealed.html">stas-blogspot.blogspot.com/2010/08/concurrenthashmap-revealed.html</a> </li><li>  <a href="http://www.codercorp.com/blog/java/why-concurrenthashmap-is-better-than-hashtable-and-just-as-good-hashmap.html">www.codercorp.com/blog/java/why-concurrenthashmap-is-better-than-hashtable-and-just-as-good-hashmap.html</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/132884/">https://habr.com/ru/post/132884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132875/index.html">Writing the function of saving pictures to the SD card</a></li>
<li><a href="../132876/index.html">HTA Interactive Card</a></li>
<li><a href="../132880/index.html">Worst Passwords 2011</a></li>
<li><a href="../132881/index.html">Public transport routes in Saratov and Engels</a></li>
<li><a href="../132883/index.html">We fill nanoCAD subscriptions with buns - or is it possible to earn money for free?</a></li>
<li><a href="../132886/index.html">Three innovations in Evernote for Android</a></li>
<li><a href="../132888/index.html">Malefactors received remote control over water treatment system of one of the US water treatment plants</a></li>
<li><a href="../132890/index.html">Red Hat: Allow the OpenShift cloud to compile your Java applications.</a></li>
<li><a href="../132892/index.html">Electronic cigarette "I like Dark Passion" - what it consists of</a></li>
<li><a href="../132893/index.html">How scary to live: from viruses in QR codes to hacking industrial giants</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>