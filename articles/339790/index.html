<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Contravariant tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I present to your attention the translation of the article Test Contra-variance 


 From the translator: frankly, the choice of words is co-...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Contravariant tests</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  I present to your attention the translation of the article <a href="http://blog.cleancoder.com/uncle-bob/2017/10/03/TestContravariance.html">Test Contra-variance</a> </p><br><p>  From the translator: frankly, the choice of words is co-contravariance, with respect to the design of tests, is a bit strange.  The semantics of course can be traced, but very metaphorical.  Most likely, just for the red-word and the headline that attracts attention, so do not much carp.  The rest - a great note on the topic of TDD in the format of a dialogue.  It is told why TDD is so painful as to make a pleasant tool out of unit tests and does not treat them as necessarily breaking violence against freedom of expression. </p><a name="habracut"></a><br><p>  Do you write unit tests? </p><br><blockquote>  Of course! </blockquote><p>  First tests, and then the code? </p><br><blockquote>  Yes, I follow the <a href="http://www.softwaretestingmagazine.com/knowledge/the-three-rules-of-test-driven-development/">three TDD rules</a> . </blockquote><p>  Is there a difference in the structure of test modules and code? </p><br><blockquote>  I make one test class for each class in the code. </blockquote><p>  That is, if the class in the main code is called User, then you will have a test <br>  class named UserTest? </p><br><blockquote>  Yes, almost always. </blockquote><p>  It turns out that the test structure is covariant to the code structure? </p><br><blockquote>  Well, I suppose so. </blockquote><p>  So you tie the test structure to the code? </p><br><blockquote>  I never thought it was connectedness, but apparently yes. </blockquote><p>  And when you refactor the structure of the code classes without affecting the behavior, <br>  tests break down? </p><br><blockquote>  Yes it's true. </blockquote><p>  Therefore, you can not run tests during refactoring? </p><br><blockquote>  Why? </blockquote><p>  Because refactoring is a sequence of minor edits that do not break <br>  tests. </p><br><blockquote>  Well, based on the definition, then it really is not a refactoring. </blockquote><p>  Instead of minor edits, you have to make one big change and hope <br>  that then you collect everything back, including tests. </p><br><blockquote>  Yes, and so what? </blockquote><p>  This is an example of the Fragile Test Problem. </p><br><blockquote>  The Problem of Fragile Tests? </blockquote><p>  Yes, a common complaint among developers who have tried TDD for the first time. <br>  They notice that minor changes in the code lead to significant <br>  edits in tests. </p><br><blockquote>  Exactly, very annoying.  Almost threw TDD when I first encountered <br>  a problem. </blockquote><p>  Unfortunately, this is a common reaction. </p><br><blockquote>  And what to do? </blockquote><p>  The structure of the tests should be contravariant to the code. </p><br><blockquote>  Contravariant? </blockquote><p>  Yes, the test structure should not reflect the structure of the code.  From the fact that <br>  some class is called X, should not follow the appearance of the test with <br>  name XTest. </p><br><blockquote>  But wait, this is not by the rules! </blockquote><p>  What are the rules? </p><br><blockquote>  For each class there must be an appropriate test. </blockquote><p>  There is no such rule. </p><br><blockquote>  How not?  I just read about it. </blockquote><p>  Not everything you read is the rule. </p><br><blockquote>  Well, if the structure of the tests should be contravariant, then how to do it like this? </blockquote><p>  Let's first define the simple fact.  If a small change in one module <br>  system leads to significant changes in other components, then the system has <br>  bad design. </p><br><blockquote>  Obviously, software design 101 talks about the same thing. </blockquote><p>  Therefore, if a small change in the code leads to a big change <br>  in tests, this is also a design problem. </p><br><blockquote>  The idea is clear, I agree. </blockquote><p>  Therefore, tests should have their own design.  He can't just repeat <br>  structure of the main code. </p><br><blockquote>  Hm  That is, if the designs are the same, then they are connected, and connectedness leads <br>  to fragility. </blockquote><p>  Exactly.  The connectivity of tests and code should be minimal. </p><br><blockquote>  Stop!  But tests and code must be related, as they describe the same thing. <br>  behavior. </blockquote><p>  True, their behavior is connected, but this does not mean the coherence of the code structure <br>  and tests.  And even connectedness of behavior should not be as strong as you <br>  you think. </p><br><blockquote>  Is there an example? </blockquote><p>  Suppose I start writing a new class.  Let's call it X. And I'm doing a new test. <br>  named XTest. </p><br><blockquote>  But you just said, "don't do that." </blockquote><p>  Do not get ahead of events, we just started.  As you add new tests to XTest, <br>  I am adding new code in X. </p><br><blockquote>  And refactor the code! </blockquote><p>  Naturally.  By separating private methods from original functions that <br>  are called in XTest. </p><br><blockquote>  And you refactor tests, right? </blockquote><p>  For sure!  I look at the connection between XTest and X and work on minimizing it. <br>  This can be done by adding parameters to the constructor X or increasing <br>  level of abstraction of arguments.  Or even the introduction of a polymorphic interface <br>  between XTest and X. (1) </p><br><blockquote>  And all this just to write a test? </blockquote><p>  Look at it from the other side.  XTest is X's first client. I always strive <br>  reduce connectivity between client and server.  Therefore, I use the same <br>  techniques applicable to reduce connectivity in normal code. </p><br><blockquote>  Well, but the structure of the tests still follows the structure of the code.  X and XTest <br>  don't go anywhere. </blockquote><p>  Yes, at the class level, they are the same, but this will change.  But mind you that <br>  we already have significant differences at the level of methods. </p><br><blockquote>  Indeed, XTest simply uses public methods X, and the main part <br>  code in private methods that you have highlighted. </blockquote><p>  Right!  Structural symmetry is broken, but I'm going to break even more. </p><br><blockquote>  What is it like? </blockquote><p>  As I peer at private methods, I inevitably begin to see <br>  how can they be grouped into classes.  If the group of methods uses <br>  a subset of the fields X, it can be separated into a separate class.  (2) </p><br><blockquote>  But you do not write a new test? </blockquote><p>  Yes!  More and more functions will be allocated, more and more classes will be <br>  detected.  And after a while we will have a whole family of classes, <br>  sitting behind a simple API X. </p><br><blockquote>  And they will all be covered with XTest. </blockquote><p>  Right!  The structure will be almost completely independent.  And also API X gradually <br>  will become so clean and abstract that it will be minimally connected <br>  with customers, including XTest. </p><br><blockquote>  Clear.  It seems that the structure of the tests can develop independently of <br>  code and I agree that this is good.  But what about the behavior, they still <br>  pores are strongly related by behavior. </blockquote><p>  Think about what happens during the development of X. How does this affect XTest? </p><br><blockquote>  Well, there will be more and more tests, and the interface with X will be cleaner and <br>  more abstract. </blockquote><p>  Right, now repeat the first part again. </p><br><blockquote>  There will be more and more tests? </blockquote><p>  Yes, and each of the tests is very specific, which is a small specification. <br>  certain behavior.  And in the sum they will give ... </p><br><blockquote>  Full requirements for the behavior of the X API. </blockquote><p>  Exactly!  As development progresses, the test suite becomes <br>  specification - tests begin to be more specific, specific. </p><br><blockquote>  Of course I understand. </blockquote><p>  But what happens to the classes hidden behind the X API?  What makes every good <br>  designer to cope with the growing list of requirements? </p><br><blockquote>  To cope with the abundance of requirements, it is naturally necessary to generalize. </blockquote><p>  Right!  Instead of writing code for every single case, we <br>  generalize it. </p><br><blockquote>  And how does this affect related behavior? </blockquote><p>  During the development process, test behavior becomes more and more defined, <br>  while the code becomes more common, they move in opposite <br>  directions along the axis of generality. </p><br><blockquote>  And it reduces connectivity? </blockquote><p>  Yes, because if the code meets the requirements described in the tests, <br>  it also has the ability to cover undescribed requirements.  (3) </p><br><p>  And this is a very important point.  Because no test suite can take into account <br>  all behaviors.  The code <em>must</em> be so general as to cover <br>  sets of tests begin to satisfy <em>all</em> system requirements. </p><br><blockquote>  Are you saying that tests are incomplete? </blockquote><p>  Of course!  It is simply impractical to describe absolutely everything.  So what happens <br>  if we gradually increase the code commonality, until any possible <br>  tests will not pass? </p><br><blockquote>  Wow!  We continue to write failing tests that increase <br>  code commonality, until we can write a failing test. <br>  Wow! </blockquote><p>  So much for wow.  Backfilling - the process of generalization is the process of unleashing, <br>  we unleash a generalize! </p><br><blockquote>  Incredible!  That is, we unleash both structure and behavior. </blockquote><p>  Right, can you retell the point? </p><br><blockquote>  Okay, so the test structure should not reflect the structure of the code, because <br>  such coherence makes the system fragile and makes refactoring difficult. <br>  In other words, test design should not be code dependent to avoid coherence. <br>  with him. </blockquote><p>  Well, what about behavior? </p><br><blockquote>  While the tests are becoming more specific, the code will be increasingly <br>  general  The behavior of the tests and the code moves in opposite directions along <br>  community axes until we can no longer write a new failing test. </blockquote><p>  Great, I think you understand everything! </p><br><blockquote>  Forward to victory with contravariant tests! </blockquote><br><hr><br><p> (1) Here Uncle Bob skidded a little.  Most likely he wanted to tell about one of the stages of writing tests / code - the formation of a public interface.  Depending on the experience, the developer can either immediately know (design in the head) what the interface should be, or it will be a gradual morphing of tests and code in the right direction.  At this stage, edits will be significant on both sides.  Newbies throw TDD also because they do not know how to make good interfaces yet and they have to rewrite twice as much code.  But this is a great practice!  Moves to the side to sit with a notebook, draw and think. </p><br><p>  (2) By no means a guide to action!  This is just an example.  Not all classes can be divided by this feature. </p><br><p>  (3) It may seem quite controversial, but Uncle Bob suggests that we can no longer come up with a test or requirements that would break the code.  The code is already so general that it takes into account many undescribed details. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/339790/">https://habr.com/ru/post/339790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../339774/index.html">Memorize Less, Know More: Operator Tips</a></li>
<li><a href="../339782/index.html">Black triangles</a></li>
<li><a href="../339784/index.html">The relationship between the number of combinations and the binomial coefficients</a></li>
<li><a href="../339786/index.html">Like the others: Monitoring & Tracing Tools in Odnoklassniki</a></li>
<li><a href="../339788/index.html">Modeling objects, functions and operations. Mereological relations between objects of this type</a></li>
<li><a href="../339794/index.html">Cocos2d-x - Action Handling</a></li>
<li><a href="../339796/index.html">GoToChain: how schoolchildren of the blockchain in the village wrote</a></li>
<li><a href="../339798/index.html">How to determine the sample size?</a></li>
<li><a href="../339800/index.html">Simple Scada in Python and Arduino</a></li>
<li><a href="../339806/index.html">On the way to natural intelligence</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>