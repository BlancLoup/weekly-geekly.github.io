<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We take away mail without sms and registration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Less than a month, we decided that it was time to write articles on the results of our performances on OFFZONE-2018. The first article will be based o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We take away mail without sms and registration</h1><div class="post__text post__text-html js-mediator-article">  Less than a month, we decided that it was time to write articles on the results of our performances on OFFZONE-2018.  The first article will be based on the FastTrack report ‚ÄúMS Exchange Relay attack without sms and registration‚Äù. <br><br>  When RedTeam is used, the use of phishing is mandatory - you can build excellent protection on the perimeter, but some user will lead to phishing and give the attacker the opportunity to be immediately inside the network.  Everyone knows that mostly for phishing use links to third-party sites that the user needs to go to or a document with a macro.  Security services under the threat of sanctions "train" users, saying that in no case should you click on the "include content" button.  And in principle, there is success - users on such mailings are conducted less and less.  But the attackers are also not standing still - phishing is becoming more interesting.  Customers also require some interesting phishing e-mails from us.  And we are also interested in the fact that the Customer‚Äôs employees are led to phishing, and we can explain to them what to look for when receiving a letter. <br><a name="habracut"></a><br><h3>  Why such phishing methods? </h3><br>  Many companies use MS Exchange as a corporate mail server.  This is convenient for the company, but also convenient for the attacker.  It is interesting for an attacker to send messages from the victim‚Äôs mail, as well as to download any letters.  We, like RedTeam, want to completely imitate the actions of the attacker and we are interested to perform the same actions with the mail.  Naturally, in our case, the mail is not fully downloaded, and the Customer is notified of this in advance.  For confidential information, all the cases. <br><br>  To perform this kind of action, we need a user's mail session.  The first thing to think about is how to intercept such a session.  We decided to use the good old NTLM Relay (as most companies still use NTLM).  Yes, in the case of Kerberos will not work - you can close the article and do not read further. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      NTLM Relay has long been known and its implementations are also sufficient.  We also did not reinvent the wheel and took one of the implementations with GitHub from Arno0x0x.  However, everything was not so easy and I had to write a little.  Namely: <br><br><ul><li>  to make everything work with all modern versions of Windows OS (did not work on win10 and win server2016); </li><li>  make it work with the latest Impacket; </li><li>  add a convenient logging system. </li></ul><br>  A modified version can be found on our <a href="https://github.com/mis-team/MSExchangeRelay">github</a> . <br><br>  Microsoft Office documents were selected as the delivery container, as they are most often sent by corporate mail, and users open them.  Moreover, it was decided to use the attached documents (SubDocument), because it is a legal operation with the document, and no antivirus will respond to such a file.  You can include both smb and http resources as a nested link.  More will be discussed further. <br><br><h3>  How to generate a phishing document? </h3><br>  As an example, consider the completely ‚Äúclean‚Äù document mydoc3.docx, which is the most common Microsoft Word document. <br><br><img src="https://habrastorage.org/webt/qh/fz/u4/qhfzu4immrvbunyhhtkquijf_6w.jpeg"><br><br>  Any Microsoft Office document is a zip-archive consisting of xml, which ultimately form your beautiful document.  In order to make an attached document, we need to make changes to the files with the .rels extension.  Depending on the version of MS Office, changes need to be made either in document.xml.rels, or in settings.xml.rels.  This article covers Office 365, and changes are made to settings.xml.rels. <br><br><img src="https://habrastorage.org/webt/gv/l_/el/gvl_el9spieruf3-oi7ebyn8kum.jpeg"><br><br>  As an attached document, we give a link to the resource on which this most attached document is located.  In our case, the attached document is on the smb-resource \\ 127.0.0.1 \ subdoctest \ <br><br><img src="https://habrastorage.org/webt/vo/8e/k6/vo8ek6cjbb3ujb25muzizw3dsis.jpeg"><br><br>  Save the changes and open the resulting document.  If successful, the document will look like this: <br><br><img src="https://habrastorage.org/webt/5s/rd/r6/5srdr6cwcqyckb-wa2hx5fdxfue.jpeg"><br><br>  However, in this form, it causes suspicion of users.  It is necessary to change it a little and try to hide the link by using different styles and white font color. <br><br><img src="https://habrastorage.org/webt/ss/xx/9q/ssxx9qy8acppddbgoxee3bjoi3q.jpeg"><br><br>  As a result, we received a completely non-suspicious document, at the opening of which Word itself will go to the resource for its part, which is registered as an attached document. <br><br><h3>  And where will all come? </h3><br>  The document will be knocked to your server (in fact, they should be given a link to it).  The server can be an SMB server or an HTTP server (see cases below).  This article only considers an example of sending a message from the mail of the user whose session we intercepted. <br><br>  In order to run everything, the minimum set is enough - the last <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> , <a href="https://github.com/mis-team/MSExchangeRelay">MSExchangeRelay</a> and Python2.7 tools. <br>  Run everything with the command: <br><br><pre><code class="plaintext hljs">python MsExchangeRelay.py -v -t https://exchange_addr/ews/exchange.asmx -r sendMail -d "example@email.com" -s Hello -m sampleMsg.html -o out.txt</code> </pre> <br><pre> <code class="plaintext hljs">exchange_addr ‚Äì  exchange   example@email.com ‚Äì           . -s Hello ‚Äì   -m sampleMsg.html ‚Äì  ,    -o out.txt ‚Äì    .</code> </pre><br>  After starting the server, SMB and HTTP servers are raised that are waiting to connect to them. <br><br><img src="https://habrastorage.org/webt/fb/v_/gd/fbv_gdeuf-sslphsu7dgwcolhym.jpeg"><br><br>  After a successful connection, you can see with which login and from which IP address the user logged in: <br><br><img src="https://habrastorage.org/webt/b5/ql/nc/b5qlncntglraiglm3ssvhtdactc.jpeg"><br><br><h3>  How to apply it now? </h3><br>  You can use this method on different cases. <br><br>  <b>Case 1. External violator, outgoing port 445 is open at the Customer</b> <br><br>  In this case, you can use the link to the smb-resource.  The beauty of such a link is that Windows does not want to disturb the user once again if it can cope.  Accordingly, when opening a document with a link to the smb-resource, Windows itself sends the domain credits of the user to this resource.  That is, nothing happens for the user.  The user opens the document.  And that's all.  Suspicion causes nothing.  And we already have a user mail session. <br>  The open port 445, although rare, is still encountered.  Therefore, it is also considered and left. <br><br>  <b>Case 2. Internal violator</b> <br><br><img src="https://habrastorage.org/webt/ua/-n/rt/ua-nrturlt8wmhhttmjpxmtozgq.jpeg" align="left" width="300" height="1000"><br>  Here we also use the link to the smb-resource.  In case of successful interception of the session, a letter will be sent to the specified postal address, which we have indicated. <br><br>  <b>Case 3. External intruder and outgoing port 445 closed</b> <br><br><img src="https://habrastorage.org/webt/rk/hj/z7/rkhjz7iomq_a6g5wbtqeq65eh4q.jpeg" align="left" width="300" height="1000"><br>  We can use the link to the HTTP server.  However, in this case, everything will not be so transparent to the user.  When you open the document, the user will see the standard window from Windows, in which the username and password are requested.  The moment that can confuse the user - the domain name evil_http_server - it should be as similar as possible to the domain name exchange server of the Customer. <br><br><img src="https://habrastorage.org/webt/qg/mu/q1/qgmuq1qmzgin7fjeiwcrwjh-lug.jpeg" align="left" width="300">  After the user enters his credits, we get his session and send an email. <br><br><br><br><br><br><br><br><h3>  Instead of conclusion </h3><br>  NTLMRelay can be wrapped in different containers and come up with completely different approaches to phishing users.  While NTLM is alive, such attacks are still alive.  So experiment! <br><br>  PS Thanks to the organizers of OFFZONE-2018 for an excellent conference! </div><p>Source: <a href="https://habr.com/ru/post/432182/">https://habr.com/ru/post/432182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../432172/index.html">Dangerous invitation, or How does the combat load to a phishing email</a></li>
<li><a href="../432174/index.html">How to competently and effectively develop a software product</a></li>
<li><a href="../432176/index.html">How we doubled the speed of working with Float in Mono</a></li>
<li><a href="../432178/index.html">... and a guarantee for projectors - enlarge</a></li>
<li><a href="../432180/index.html">How to pump your career through GitHub</a></li>
<li><a href="../432184/index.html">Problem personalities among testers</a></li>
<li><a href="../432186/index.html">Using STP to create p2p channels</a></li>
<li><a href="../432188/index.html">Hackers from the APT28 group attacked email-boxes of hundreds of employees of the Czech ministries</a></li>
<li><a href="../432190/index.html">Underside client-side physics prediction</a></li>
<li><a href="../432192/index.html">4 signs that you are not ready to implement a project management solution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>