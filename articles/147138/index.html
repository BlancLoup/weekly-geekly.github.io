<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transport Tycoon Deluxe / Emscripten Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Transport Tycoon (Transport Tycoon) - pretty old, but still delivering, especially maniacs, the game in the genre of economic RTS. /.../ 

 There is a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transport Tycoon Deluxe / Emscripten Part 2</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://play-ttd.com/"><img align="left" title="play-ttd" src="https://habrastorage.org/getpro/habr/post_images/172/a4f/025/172a4f0255269af999a9abaedb124985.jpg" width="150" height="119"></a>  <i>Transport Tycoon (Transport Tycoon) - pretty old, but still delivering, especially maniacs, the game in the genre of economic RTS.</i>  <i>/.../</i> <i><br><br></i>  <i>There is also OpenTTD, an open product of unixoids, so that you can not be distracted from the game even in the outhouse and the metro by installing it on your device or PDA.</i>  lurkmore <br><a name="habracut"></a><br>  I can honestly say: I killed a huge amount of time playing Transport Tycoon Deluxe.  Yes, I'm just a fan of this game.  Therefore, when an article appeared on Habr√© about how the guys from mozilla ported Doom, I fired up this idea - to transfer one of my favorite games here, to the Internet.  By the way, the article was scarce, but I learned the main thing - porting can be done using <a href="https://github.com/kripken/emscripten">emscripten</a> .  From the moment of the birth of the very thought about the possibility of implementing such a project, it took at least a year (my first attempt to break on the rocks of misunderstanding).  And today I hurry to make you all happy: I did it!  Now you can sit behind the game in the TTD from any point connected to the Internet. <br><br>  And here is the video: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/3Ovut2taLdM%3Ffeature%3Doembed&amp;xid=25657,15700019,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhirnzVxhZV3FawNKIEEYz7w1WsU-w" frameborder="0" allowfullscreen=""></iframe><br><br>  Impatient can start <a href="http://play-ttd.com/">playing</a> now.  Please treat with understanding if something goes wrong.  This version is only being tested.  The game definitely works in FF13 (recommended browser) and Chrome (ium).  I hope my slow server can handle the load.  And yes, I know about pink tiles, I'm working on it. <br><br><h2>  OpenTTD </h2><br>  I want to say a few words about the project OpenTTD, which has become a donor of the source code for the JavaScript version.  The project includes, according to general estimates, about <strong>300,000</strong> lines of C ++ code.  Moreover, the possibilities of the project are amazing.  Judge for yourself: <br><ul><li>  Four graphics subsystems (drivers) </li><li>  Five sound drivers </li><li>  little / big-endian </li><li>  At the source code level, the possibility of single-threaded and multi-threaded execution is supported. </li><li>  Work in the network environment (download graphic and music sets from the network) and without it </li><li>  Multiplayer game </li><li>  Compressing save files with lzma </li><li>  Caching rendering </li><li>  Animation of tiles through the rotation of the color palette </li><li>  Built scripting language <a href="http://www.squirrel-lang.org/">squirel</a> </li></ul><br>  Most of the code is written with a twinkle, creatively.  It was very interesting to delve into the guts of this project.  Unfortunately, one has to pay for such omnivorousness, and in this case I ran into a monstrous assembly system.  I had to write a perl script that automates the patching of OpenTTD makefiles for porting. <br><br>  OpenTTD port managed in the following configuration: <br><ul><li>  single-flow mode </li><li>  little-endian </li><li>  completely disabled network capabilities </li><li>  Video Driver - Patched SDL </li><li>  self-written sound driver </li><li>  patched mechanism for saving games on the server </li><li>  patched game resource locator </li></ul><br>  The rest is the default. <br><br><h2>  Emscipten </h2><br>  Over porting code emscripten conjured, and I conjured over him, so that he could digest this lump.  Developing my previous <a href="http://habrahabr.ru/post/143583/">article</a> , I will describe how this esoteric technology works. <br><br><img title="em1" src="https://habrastorage.org/getpro/habr/post_images/a7a/7ed/fae/a7a7edfae90a81f3f1cf2d77fc6b1a1d.jpg" width="273" height="284"><br><br>  The idea is simple: C ++ code is compiled into LLVM bytecode using <a href="http://clang.llvm.org/">clang</a> .  The byte code is in turn compiled into JavaScript using emscripten.  LLVM bytecode is an intermediate code that can run on a low-level virtual machine.  The LLVM bytecode specifications are well documented and this is one of the reasons why it was chosen by the authors of the project as an intermediate presentation of the code.  The emscripten compiler tries to convert bytecode instructions into one-to-one JavaScript code, as in the figure below (byte code on the left, corresponding to the right of JavaScript). <br><br><img title="em2" src="https://habrastorage.org/getpro/habr/post_images/1b0/951/b14/1b0951b14625a18976cd9bd6fb686525.jpg" width="434" height="138"><br><br>  For most instructions, this scheme works fine.  However, it cannot be said that developing such a compiler is an easy task.  LLVM bytecode and javascript vary greatly.  To implement more complex things (pointer arithmetic, cycles, error handling), additional work has to be done.  Here is a simple example of the different behaviors of C ++ and JavaScript. <br><br><img title="em3" src="https://habrastorage.org/getpro/habr/post_images/b34/63c/d72/b3463cd720064c03990526019f0690bb.jpg" width="410" height="47"><br><br>  Performing a division in C ++ will result in a drop of the fractional part of the number.  To get the same functionality in JavaScript, you have to resort to tricks like Math.floor (the code is not correct for all cases, it is true for most). <br><br>  A more complex example is the implementation of a loop in LLVM bytecode and JavaScript: <br><br><img title="em4" src="https://habrastorage.org/getpro/habr/post_images/c8b/69f/149/c8b69f149c1079aefbf081b7e02760e4.jpg" width="420" height="105"><br><br>  Implementing similar functionality in JavaScript can be done in numerous ways, but many of them will be poorly productive, and here the task of emscripten is to generate the most efficient code. <br><br>  In addition to these low-level things, emscripten provides implementations for: libc, libcxx, POSIX, SDL, GL, GLES, and other libraries.  Fully implemented file subsystem C (fopen, fclose, fread, ...).  Most programs can be compiled using emscripten without any problems.  The beauty of the emscripten ideology is that there is no need to edit the source code - it will work that way.  In this case, in the case of successful porting of a project to JavaScript, the transition from version to version is carried out easily and naturally.  For example, while I sawed emscripten, the community managed to release the next minor version of OpenTTD, I simply synchronized the sources and got the latest port of the latest version, conveniently. <br><br><h2>  Transport Tycoon Deluxe </h2><br>  Using emscripten in JavaScript, a sufficiently large number of serious projects have already been compiled: Doom, zlib, Poppler, OpenJPEG, FreeType, Bullet, SQLite, Python, Ruby, Lua and others.  Now in the emscripten discussion group there is an active Fortran compilation discussion. <br><br>  However, in order to successfully compile a complex project, you need C ++ knowledge.  Here, for example, what result did I get at the first successful compilation of OpenTTD. <br><br><img title="em5" src="https://habrastorage.org/getpro/habr/post_images/87a/721/57d/87a72157df9e18325560a25d8c5a0496.jpg" width="640" height="485"><br><br>  In this version, neither the mouse nor the keyboard worked.  Only here is the image and all. <br><br>  The emscripten authors declare support for a large number of libraries, but this support is not fully implemented.  For example, emscripten implements only a small subset of SDL 2.0 with an admixture of SDL 1.2.  Accordingly, I was faced with the lack of necessary functions in emscripten, and I had to implement them myself.  But I became one of the committers of the project ( <a href="https://github.com/kripken/emscripten/blob/master/AUTHORS">ChSV !!!</a> ). <br><br>  The problem captured in the screenshot above was caused by the fact that the SDL 1.2 implementation in emscripten supported only 32-bit surfaces and did not know anything about the SDL_HWPALLETE flag.  The image in SDL_HWPALLETE mode is encoded by eight bits (256 colors).  This is what is connected with the image compression.  Why it is reflected horizontally to me is not clear until now.  In addition, I had to implement the following functions: SDL_VideoModeOK, SDL_VideoDriverName, SDL_QuitSubSystem and strndump.  I have identified a serious performance problem that was reported to the authors and they fixed it.  Unfortunately, my audio subsystem edits are not included in the emscripten code base at the moment. <br><br>  Many problems have been identified with the emscripten optimization flags.  The pink tiles that you see in the video are problems of optimization - without flags, they are the right color.  It is very difficult to deal with problems of this kind.  The problem itself is irresponsible (only water tiles are pink with an inclination of 45 degrees in two directions) and porting with optimizations turned on takes a very long time (more than 2 hours), so you often don‚Äôt test it.  But it delivers that the project is developing quite quickly, bugs are closed within a day or two (mine, at least). <br><br>  In general, porting a complex project using emscripten can, if you really want.  In any case, you will have to face the need to make minor changes to emscripten or to the project itself.  But, having coped once, you can repeat the porting over and over again without any problems. <br><br><h2>  It's terribly slow isn't it? </h2><br>  Alon Zakai (the author of the project), speaking at the conference with a <a href="http://jsconf.eu/2011/emscripten.html">report</a> on emscripten, expressed the opinion that JavaScript itself is fast enough and the bottleneck is the compiler and its not always optimal code conversions.  He cited the following sign: <br><br><img title="em6" src="https://habrastorage.org/getpro/habr/post_images/d2c/7d6/98f/d2c7d698f3345e3fb0fe8054acfe39cd.jpg" width="410" height="305"><br><br>  <a href="https://developer.mozilla.org/en/SpiderMonkey">SpiderMonker</a> (SM) is a Firefox JavaScript engine;  Typed Arrays (TA) is currently the fastest way to emulate heaps in JavaScript, which is provided by emscripten.  In the cells of the table, the numbers indicate how many times the execution of the code compiled in JavaScript turned out to be slower than the native code.  The scatter, as we see, from one to eight times (although the average is somewhere around 3-5). <br><br>  The numbers in the figure below show how many times a particular language is slower than C ++ in the test suite <a href="http://shootout.alioth.debian.org/">http://shootout.alioth.debian.org/</a> .  (note: This information is already quite outdated and aims to show that JavaScript is a fast language. If anyone disagrees with this, please speak, and let's not touch other languages ‚Äã‚Äã- they probably already have other numbers in these tests.) <br><br><img title="em7" src="https://habrastorage.org/getpro/habr/post_images/fb4/8bf/0ef/fb48bf0efbad1cb6dce1bc8306af2962.jpg" width="433" height="302"><br><br>  In general, I agree with these figures and say that the JavaScript version of OpenTTD works about 5-7 times slower than the native one.  But only in the FireFox browser.  And this is the most amazing moment that I discovered for myself.  I was developing c nodejs + chromium.  I myself am a fan of FF, but unfortunately, the debug versions of JavaScript OpenTTD were the size of fifty megabytes and hung FF tightly, while the chromium worked very fast.  I thought chromium on the wave, but suddenly it turned out that the release version works non-illusory faster in FF (2-3 times) than in chromium.  Therefore, I recommend everyone to play using FireFox. <br><br>  I am very glad that I took up the project and brought it to completion.  I learned a lot about clang, llvm, python and javascript.  Talked to interesting people.  The community really liked my project, the authors recently added it to the emscripten demonstration projects page.  I received great satisfaction from the work done.  In general, I wish you all. <br><br>  Once again a reference: <a href="http://play-ttd.com/">play-ttd.com</a> <br>  <a href="http://vk.com/app3023298_2396267">Vkontakte application</a> <br><br>  <b>UPD.</b>  New <a href="http://epicport.com/">project site.</a> </div><p>Source: <a href="https://habr.com/ru/post/147138/">https://habr.com/ru/post/147138/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147133/index.html">MVC approach to developing user interfaces in Delphi. Part 1. Tick</a></li>
<li><a href="../147134/index.html">White Nights Results: Mobile Games Conference</a></li>
<li><a href="../147135/index.html">Cloud4Y cloud is now in the Netherlands</a></li>
<li><a href="../147136/index.html">Apple has registered a patent for head-mounted display technology</a></li>
<li><a href="../147137/index.html">Tracks Flow from the inside</a></li>
<li><a href="../147139/index.html">Ask.com is changing or How plugin for wordpress generated sitemap</a></li>
<li><a href="../147140/index.html">European Parliament voted against ACTA</a></li>
<li><a href="../147141/index.html">Indie Game: The Movie</a></li>
<li><a href="../147142/index.html">Google+ is one year old. When will the infamous bugs disappear?</a></li>
<li><a href="../147144/index.html">We say no to investments</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>