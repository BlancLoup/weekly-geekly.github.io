<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How does cloud billing work?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When we created the cloud, writing billing was one of the hardest tasks. We decided to follow the path of maximum separation of components and weak li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How does cloud billing work?</h1><div class="post__text post__text-html js-mediator-article">  When we created the cloud, writing billing was one of the hardest tasks.  We decided to follow the path of maximum separation of components and weak linking.  Thanks to this, the whole process is divided into several independent components: collecting information about the resource consumption of the virtual machine components, storing this information, debiting customers' accounts, storing the history of debiting funds (somewhere near the replenishment history and written paper invoices, etc. d.) <br><br>  As you can see, there are two big stages: collecting information about consumption (at this stage there is still no money, but there are bytes, seconds, requests) and the process of turning them into money (as well as everything related to this - writing off, storing history) . <br><br>  Here is a teaser - a weekly chart of total customer debits: <br><img src="https://habrastorage.org/getpro/habr/post_images/fa2/946/cbb/fa2946cbb15df6e1c2c15c6e4c4e5d4f.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  It is between ‚Äúconsumption‚Äù and ‚Äúwrite-off of money‚Äù that the weakest link is found.  For each client-owned object, we store fields with one or more counted resources.  As previously described, memory and processor time is an attribute of the virtual machine, disk operations vbd, disk storage vdi, network vif. <br><br>  The system that collects information turned out to be naturally distributed.  The service itself is called consumption.  The data of this service is stored in the ha-cluster in the centralized b / d (so that when the machine is migrated / restarted between the cloud nodes, the statistics continue to be considered another service, but to the same database). <br><br>  The service of writing off money is ‚Äúcloser‚Äù to the base with money and is completely independent of the other components, it takes consumption, price, balance and issues a new balance and write-off at the output, without thinking about anything else.  It receives data from the service via SCAPI (I will write a lot about it when we present it to the public, while this is only an internal means of interaction between the components). <br><br>  When we made the system, it was decided once and for all to abandon fractional kopecks on the client's account.  The minimum write-off unit is a penny.  To do this, we introduced a simple rule: the funds for the resource are written off only when they run to a penny and it is written off so that fractional kopecks do not exist (that is, there remains a small unpaid balance).  At the moment, the service of write-offs runs through the machines once a minute, although nothing prevents (except for issues of excessive server load) to do it at any speed.  When a client sees resource consumption in the ‚Äú0‚Äù box, it usually means that the resource has not yet counted at least one per penny. <br><br>  At the same time, as is clear, the idea of ‚Äã‚Äã‚Äúwriting off only whole kopecks‚Äù has nothing to do with the metering accuracy in the service consumption, where accuracy is determined by the size of int64 (therefore, we refused nanoseconds in favor of microseconds for processor time) and the meaning of the value (for example, the base value for RAM, we have kilobytes, not bytes, because it is impossible to allocate less kilobytes, more precisely, four kilobytes - the size of the memory page). <br><br>  Of course, no "traffic is rounded up to megabytes in a big way" and other inventions.  How many thought - so much thought.  From this consumption is deducted for the whole amount of rubles / kopecks, this is what is written off from the client's account.  The balance will be summarized with subsequent consumption and will be written off at the same time. <br><br>  Later, when transmitting by the ‚Äúlist‚Äù, the values ‚Äã‚Äãare enlarged, although the accuracy is not lost, since the integration does not affect the adders.  For interest, here's a chain of aggregations for CPU time: xen: nanosecond;  consumption: microsecond;  service charges: second;  web interface: hour </div><p>Source: <a href="https://habr.com/ru/post/112617/">https://habr.com/ru/post/112617/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112609/index.html">What is behind the asterisks?</a></li>
<li><a href="../112611/index.html">Sun Scanner is not just another linux distribution.</a></li>
<li><a href="../112612/index.html">Google has published a preview of the Android 3.0 SDK</a></li>
<li><a href="../112613/index.html">Significant progress of the experimental ARWINSS branch of the ReactOS operating system</a></li>
<li><a href="../112614/index.html">Error - class names match</a></li>
<li><a href="../112621/index.html">JPA entity proxying method for client (anti-lazy initialization)</a></li>
<li><a href="../112623/index.html">Google, Yandex and startups</a></li>
<li><a href="../112624/index.html">Full Circle Magazine Special Edition - The Perfect Server</a></li>
<li><a href="../112625/index.html">Atomic tablet Odeon TPC-10, part three</a></li>
<li><a href="../112626/index.html">Periodic system of elements of API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>