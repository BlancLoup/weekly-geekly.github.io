<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing a simple pixel game in the Ethereum blockchain</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Inspired by r / place and wanting to finally realize our first smart contract on the blockchain, we decided to make everyone an accessible and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing a simple pixel game in the Ethereum blockchain</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Inspired by r / place and wanting to finally realize our first smart contract on the blockchain, we decided to make everyone an accessible and fun application on the Ethereum network that allows you to draw on a canvas of 1000 x 1000 px, keeping each pixel selected and colored by the user in blockchain  You can also draw in real time with your friends and observe how the color of the selected pixel changes in real time as the smart contract's transactions are confirmed on the network. <br><br>  The smart contract does not require payment for changes in the color of the pixels, but you will need to pay a small commission to the miners for confirming the transaction. <br><br>  In this article I would like to tell you how we got the current first version of the application and what technical difficulties we had to face. <br><a name="habracut"></a><br><h2>  Components </h2><br>  Planning to focus more on writing a smart contract, we did not want to spend a lot of time on the server architecture and made everything as simple as possible. <br>  The main condition for working with the application is an Ethereum-compatible browser and browser plug-in (Metamask etc) with access to the wallet.  In this case, the client sends the transactions to the blockchain itself and the server only returns the updated contract status via Nginx.  Thus, the entire integrity and security of data is guaranteed by a smart contract in the blockchain. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/s-/uz/gf/s-uzgfbkmnnezi6o0_uodyyhpre.png" alt="image"><br><br>  Thus, we have turned out: <br><br><ul><li>  A smart contract written in Solidity and mapped to the core network. </li><li>  Front-end - written in Vanilla JS and using the web3.js library and Metamask plugin required to work with the contract. </li><li>  Server-side is a client written in Scala using Web3J for working with a blockchain node. </li><li>  Parity - node closed on DigitalOcean to synchronize with the network. </li></ul><br><h2>  Smart contract </h2><br>  First of all, we took up the implementation of the smart contract and taking into account our initial experience in working with Solidity, and relying on the best practices available in the network, we decided to go through MVC and make a model for storing the contract state and controller that can update this model. <br><br>  The biggest plus of this approach is that in the future, if there are changes and as new functionality appears, we do not need to migrate the application state and only the controller needs to be updated. <br><br>  The only disadvantage of this approach is the high cost of the smart contract when it is initialized on the Ethereum network (about $ 1,100 at that time). <br><br><h3>  Naive implementation </h3><br>  Initially, we did not think about the effectiveness of our implementation and premature optimization, so we made the first contract as clumsy as possible.  Considering the size of our canvas for drawing at 1000px x 1000px, we got an array of 1 million uints in which we stored all the pixels. <br><br>  An example of the implementation of the contract below: <br><br><pre><code class="java hljs">contract PixelsField is Controllable { uint[<span class="hljs-number"><span class="hljs-number">1000000</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> colors; <span class="hljs-function"><span class="hljs-function">event </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PixelChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinates, uint clr)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinates, uint clr)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> onlyController </span></span>{ require(clr &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>); require(coordinates &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>); colors[coordinates] = clr; PixelChanged(coordinates, clr); } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allPixels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> view </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1000000</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> colors; } }</code> </pre> <br><h3>  Difficulties </h3><br>  At first glance, everything worked just fine, we were able to save the first pixels in the blockchain, but as soon as we tried to read the state from the network, we were in for a huge disappointment. <br><br><ul><li>  It was impossible to transfer an array with a size of 1 million pixels to the client stored in a contract with the uint256 data type in a reasonable time and besides, due to its huge size, this array was almost impossible to parse on the client. </li><li>  As a result, the option of writing the whole pixel to one data type as uint256 was very expensive and inefficient and we needed to come up with a compression option. </li></ul><br><h3>  Improved version </h3><br>  Being upset by the failure in the first version of implementation, we began to think about a possible algorithm for compressing and reading pixels, how to make a more compact version of the array, and also save one of the possible 16 colored pixels there. <br><br>  Having carefully studied the data types available in Solidity, we decided to stay with uint256, but we started recording both the position and the color of the pixel in it, thereby hoping to place each pixel in 4 bit of the 256 available. <br><br>  To do this, we needed a bit of bitwise magic, in which we encode the X and Y coordinates of each pixel into the index of the array element and apply a bit shift and mask. <br><br>  An example implementation below: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinate, uint color)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> onlyController </span></span>{ require(color &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>); require(coordinate &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>); uint idx = coordinate / ratio; uint bias = coordinate % ratio; uint old = colors[idx]; uint zeroMask = ~(bitMask &lt;&lt; (n * bias)); colors[idx] = (old &amp; zeroMask) | (color &lt;&lt; (n * bias)); PixelChanged(coordinate, color); }</code> </pre> <br>  A quick calculation of our implemented optimization showed that in order to store 1 million pixels, we would need only 1,000 0000 / 64bit = 15,625 elements of the uint256 type. <br><br>  Thus, we reduced the initial array from our naive implementation 64 times and were able to read the entire array in a reasonable time on the client. <br><br>  A full example of a state contract is below: <br><br><pre> <code class="java hljs">contract PixelsField is Controllable { <span class="hljs-function"><span class="hljs-function">event </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PixelChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinates, uint clr)</span></span></span></span>; uint[<span class="hljs-number"><span class="hljs-number">15625</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> colors; uint bitMask; uint n = <span class="hljs-number"><span class="hljs-number">4</span></span>; uint ratio = <span class="hljs-number"><span class="hljs-number">64</span></span>; <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PixelsField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span></span>{ bitMask = (uint8(<span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; n) - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setPixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinate, uint color)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> onlyController </span></span>{ require(color &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>); require(coordinate &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>); uint idx = coordinate / ratio; uint bias = coordinate % ratio; uint old = colors[idx]; uint zeroMask = ~(bitMask &lt;&lt; (n * bias)); colors[idx] = (old &amp; zeroMask) | (color &lt;&lt; (n * bias)); PixelChanged(coordinate, color); } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinate)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> view </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> idx = coordinate / ratio; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bias = coordinate % ratio; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (colors[idx] &gt;&gt; (n * bias)) &amp; bitMask; } <span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allPixels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> view </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">15625</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> colors; } }</code> </pre><br><h3>  Contract Interaction </h3><br>  To interact with the contract from the UI, we added the following functions that have access to the status of the contract: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPixel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint coordinate)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> view </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint)</span></span></span><span class="hljs-function"> function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">allPixels</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> view </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">15625</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span></span></code> </pre><br><h3>  User interface </h3><br>  Our goal was to make the UI as simple and easy as possible, where the user focuses on the canvas for drawing and from the available tools there is only a choice of colors and the possibility of zoom. <br><br>  Rendering the entire canvas is a fairly quick and inexpensive operation, primarily because of the compact size of the array of pixels in the blockchain and the use of Canvas in the browser. <br><br>  Moreover, we took into account that among visitors there may also be those who do not have an Ethereum-compatible browser or browser plug-in (Metamask etc), so we allowed our server to generate the current state of all pixels on the canvas from the blockchain and give the client a static image via nginx. <br><br>  To repaint a pixel, we use the web3.js library.  The function call from the contract is shown below: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> colorSelected = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">color</span></span></span><span class="hljs-function">) =&gt;</span></span> () =&gt; { hidePicker(); web3.eth.getAccounts(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_error, accounts</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (accounts.length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { alert(<span class="hljs-string"><span class="hljs-string">"Please login in you wallet. Account not found ¬Ø\_(„ÉÑ)_/¬Ø."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = { <span class="hljs-attr"><span class="hljs-attr">from</span></span>: accounts[<span class="hljs-number"><span class="hljs-number">0</span></span>], <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: <span class="hljs-number"><span class="hljs-number">2500000000</span></span>, <span class="hljs-attr"><span class="hljs-attr">gasLimit</span></span>: <span class="hljs-number"><span class="hljs-number">50000</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { controllerContract.methods.setPixel(settings.selectedcoordinate, color).send(config, (error, addr) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } userPixels.push({ <span class="hljs-attr"><span class="hljs-attr">coord</span></span>: settings.selectedcoordinate, <span class="hljs-attr"><span class="hljs-attr">color</span></span>: color }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> {x, y} = numberToCoord(settings.selectedcoordinate); setPixel(ctx, x, y, settings.colors[color]); }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(error); } }); }</code> </pre><br><h3>  Server </h3><br>  The implementation of the API was not our priority, as we hoped to rely entirely on the client‚Äôs web3.js library. <br><br>  But since there are a number of users of browsers without Ethereum compatible plug-ins and mobile devices, we decided to raise our Parity nodes in the DigitalOcean environment and synchronize it with the network. <br><br>  In order to interact with Parity, we wrote a lightweight API that poll the Parity node, takes the current state of the contract and draws this latest state, saving the image in png format on the server.  Then it‚Äôs Nginx‚Äôs concern to give the picture to the client. <br><br>  Since the contract state is an array of uint256 data, the approximate payload of what we get from the contract looks like this: <br><blockquote>  0x0000000000000000000000000000000000000000000000000000000000000b ... <br></blockquote><br>  And we have to do the transformation given our 16 available colors on the client and the required result in the form of png pictures: <br><br>  Example below: <br><br><pre> <code class="scala hljs">mport java.awt.{<span class="hljs-type"><span class="hljs-type">Color</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">AwtColor</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.{<span class="hljs-type"><span class="hljs-type">File</span></span>, <span class="hljs-type"><span class="hljs-type">FileOutputStream</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.time.<span class="hljs-type"><span class="hljs-type">Instant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sksamuel.scrimage.nio.<span class="hljs-type"><span class="hljs-type">PngWriter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sksamuel.scrimage.{<span class="hljs-type"><span class="hljs-type">Image</span></span>, <span class="hljs-type"><span class="hljs-type">Pixel</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.typesafe.scalalogging.<span class="hljs-type"><span class="hljs-type">StrictLogging</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.web3j.utils.{<span class="hljs-type"><span class="hljs-type">Numeric</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">NumericTools</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.util.<span class="hljs-type"><span class="hljs-type">Try</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Composer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrictLogging</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> colorMapping: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">Char</span></span>, <span class="hljs-type"><span class="hljs-type">String</span></span>] = <span class="hljs-type"><span class="hljs-type">Map</span></span>(  '<span class="hljs-number"><span class="hljs-number">0</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#FFFFFF"</span></span>,  '<span class="hljs-number"><span class="hljs-number">1</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#9D9D9D"</span></span>,  '<span class="hljs-number"><span class="hljs-number">2</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#000000"</span></span>,  '<span class="hljs-number"><span class="hljs-number">3</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#BE2633"</span></span>,  '<span class="hljs-number"><span class="hljs-number">4</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#E06F8B"</span></span>,  '<span class="hljs-number"><span class="hljs-number">5</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#493C2B"</span></span>,  '<span class="hljs-number"><span class="hljs-number">6</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#A46422"</span></span>,  '<span class="hljs-number"><span class="hljs-number">7</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#EB8931"</span></span>,  '<span class="hljs-number"><span class="hljs-number">8</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#F7E26B"</span></span>,  '<span class="hljs-number"><span class="hljs-number">9</span></span>' -&gt; <span class="hljs-string"><span class="hljs-string">"#2F484E"</span></span>,  'a' -&gt; <span class="hljs-string"><span class="hljs-string">"#44891A"</span></span>,  'b' -&gt; <span class="hljs-string"><span class="hljs-string">"#A3CE27"</span></span>,  'c' -&gt; <span class="hljs-string"><span class="hljs-string">"#1B2632"</span></span>,  'd' -&gt; <span class="hljs-string"><span class="hljs-string">"#005784"</span></span>,  'e' -&gt; <span class="hljs-string"><span class="hljs-string">"#31A2F2"</span></span>,  'f' -&gt; <span class="hljs-string"><span class="hljs-string">"#B2DCEF"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> pixelsMapping: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">Char</span></span>, <span class="hljs-type"><span class="hljs-type">Pixel</span></span>] = hex2Pixels(colorMapping) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> canvasHeight = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> canvasWidth = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> segmentLength = <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hex2Pixels</span></span></span></span>(map: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">Char</span></span>, <span class="hljs-type"><span class="hljs-type">String</span></span>]): <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">Char</span></span>, <span class="hljs-type"><span class="hljs-type">Pixel</span></span>] = {  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pixel</span></span></span></span>(hex: <span class="hljs-type"><span class="hljs-type">String</span></span>) = {    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> {      color &lt;- <span class="hljs-type"><span class="hljs-type">Try</span></span>(<span class="hljs-type"><span class="hljs-type">AwtColor</span></span>.decode(hex)).toOption      pixel = <span class="hljs-type"><span class="hljs-type">Pixel</span></span>(color.getRed, color.getGreen, color.getBlue, <span class="hljs-number"><span class="hljs-number">255</span></span>)    } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pixel  }  <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> {    (color, hex) &lt;- map    pixel &lt;- pixel(hex)  } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> color -&gt; pixel } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span></span>(encoded: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = {  <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> startedAt = <span class="hljs-type"><span class="hljs-type">Instant</span></span>.now  <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> pixels = translateToPixels(encoded)  write(pixels, fileName)  logger.info(<span class="hljs-string"><span class="hljs-string">s"Successfully wrote </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$fileName</span></span></span><span class="hljs-string">, took </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ Instant.now.toEpochMilli - startedAt.toEpochMilli }</span></span></span><span class="hljs-string"> ms"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">translateToPixels</span></span></span></span>(encoded: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">Pixel</span></span>] = {  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(color: <span class="hljs-type"><span class="hljs-type">Char</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (pixel &lt;- pixelsMapping.get(color)) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> pixel  <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> extracted = <span class="hljs-type"><span class="hljs-type">NumericTools</span></span>.cleanHexPrefix(encoded)  extracted.grouped(segmentLength)    .toList    .par    .flatMap(_.reverse.toSeq)    .flatMap(decode)    .toList } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span></span>(pixels: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">Pixel</span></span>], fileName: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = {  <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">File</span></span>(fileName)  <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">FileOutputStream</span></span>(file, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-comment"><span class="hljs-comment">// don't append existing file  val image = Image(canvasWidth, canvasHeight, pixels.toArray)  val pngWriter = PngWriter()  pngWriter.write(image, out)  out.flush()  out.close() } }</span></span></code> </pre><br><h2>  Result </h2><br><h3>  What have learned: </h3><br>  Summing up, it was very interesting and informative for us to make the first application on the blockchain and put it on mainnet and we hope that it will also be exciting for users to try to draw something on the blockchain and keep it in history :) <br><br><h3>  Future plans </h3><br>  We are going to develop ethplace.io and will be happy to share with you soon news about new interesting features we are working on! </div><p>Source: <a href="https://habr.com/ru/post/348174/">https://habr.com/ru/post/348174/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348162/index.html">Anonymous cryptocurrencies: why Edward Snowden supports the concept of proof with zero disclosure</a></li>
<li><a href="../348164/index.html">Great developer, true engineer and real leader - RIP Shawn O. Pearce</a></li>
<li><a href="../348168/index.html">Basics of programming on the SAS Base. Lesson 1</a></li>
<li><a href="../348170/index.html">JS Transducers - Are They Necessary?</a></li>
<li><a href="../348172/index.html">SQL keys in full detail</a></li>
<li><a href="../348176/index.html">Automate when you can, program when necessary</a></li>
<li><a href="../348182/index.html">Testing the performance of hyperconvergent systems and SDS do it yourself</a></li>
<li><a href="../348184/index.html">Wine 3.0 and many goodies</a></li>
<li><a href="../348188/index.html">Introduction to Data Vault</a></li>
<li><a href="../348190/index.html">Reactive work with Bluetooth in real conditions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>