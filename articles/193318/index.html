<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Banking Trojan Hesperbot - Detailed Analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We already wrote about Hesperbot , this threat is a new banking malware and has a modular architecture. Malefactors used it for carrying out attacks t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Banking Trojan Hesperbot - Detailed Analysis</h1><div class="post__text post__text-html js-mediator-article">  We already wrote about <a href="http://habrahabr.ru/company/eset/blog/192684/">Hesperbot</a> , this threat is a new banking malware and has a modular architecture.  Malefactors used it for carrying out attacks to users of various countries, including Turkey, the Czech Republic, Portugal and Great Britain.  The main purpose of the attacks was to steal confidential data from online banking of users and install the mobile component of malicious code on devices running Symbian, Android, Blackberry.  Cybercriminals used a convincing phishing scheme to lure users into malicious links, which made their approach even more practical. <br><br><img src="https://habrastorage.org/storage3/f92/85f/2d2/f9285f2d20fc8556023102f95f1c30bd.jpg"><br><br>  Compromise user occurs when clicking on a malicious link.  Below is a diagram used by attackers. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage3/8a5/ee7/34d/8a5ee734dc9ac0b1c20291410d72514d.jpg"><br>  Fig.  Scheme of compromise user. <br><br><a name="habracut"></a>  The main task of the dropper is to inject the payload (payload or core) into the context of the trusted explorer.exe process.  This code then downloads from the network and executes additional modules. <br><br><img src="https://habrastorage.org/storage3/a77/406/ea4/a77406ea46f84a79b41ce1e3c92c65f7.png"><br><br>  <b>Win32 / Spy.Hesperbot</b> is a cross-platform threat and the various modules listed are available in x86 and x64 versions.  Various internal functions of some modules are available for use in other modules through a special table of virtual methods (vtable).  Most of the Hesperbot code is written in C and compiled using Visual Studio 2010 without using the run-time library. <br><br>  <b>Payload</b> <br><br>  A dropper can use one of the following methods to inject the <b>core</b> component into the explorer.exe address space: <br><br><ul><li>  Start a new instance of explorer.exe and fix (patching) the bytes of its entry point using <i>ntdll! NtGetContextThread</i> and <i>ntdll! NtWriteProcessMemory</i> .  After that, the entry point will point to the malware code. </li><li>  Embed your code in the already existing explorer.exe process using the method based on the <i>Shell_TrayWnd</i> / <i>SetWindowLong</i> / <i>SendNotifyMessage functions</i> .  This method was used in the malicious code PowerLoader, which was previously described by Alexander Matrosov [ <a href="http://habrahabr.ru/company/eset/blog/191904/">1</a> , <a href="http://habrahabr.ru/company/eset/blog/174169/">2</a> , <a href="http://www.welivesecurity.com/2012/12/27/win32gapz-steps-of-evolution/">3</a> ]. </li><li>  Deploy code to explorer.exe using the regular <i>CreateRemoteThread</i> function. </li></ul><br>  After successful implementation, the core component starts its work in the system: it is responsible for interacting with the C &amp; C managing server, launching auxiliary modules, and writing the startup parameters of the malicious code to the registry.  To work with C &amp; C, Hesperbot uses a list of hard-wired URLs in the body (which differ in the case of different countries and botnets) or generates a list of new addresses using a special DGA-algorithm.  The malicious code sends the following information to the C &amp; C server: <br><br><ul><li>  The name of the bot, which is based on the Computer Name. </li><li>  The name of the botnet, which is formed on the basis of the country to which the threat was aimed by the attackers.  For example, ‚Äúcz-botnet‚Äù, ‚Äútr-botnet‚Äù, ‚Äúpt-botnet‚Äù, ‚Äúuk-botnet‚Äù and ‚Äúsuper-botnet‚Äù (the latter was used in early beta versions). </li><li>  IP addresses of network adapters. </li><li>  Names of installed smart cards. </li><li>  Information about installed Hesperbot plugins. </li></ul><br><img src="https://habrastorage.org/storage3/c5e/5f9/895/c5e5f9895e1986f21713dce5c4287c7c.png"><br>  Fig.  ID of the Czech botnet. <br><br>  The server response may contain the following information or files: <br><br><ul><li>  Configuration file </li><li>  Plugin files. </li><li>  Arbitrary executable file for later launch. </li><li>  New version of Hesperbot. </li></ul><br>  The malicious code retrieves a list of active <a href="http://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BC%25D0%25B0%25D1%2580%25D1%2582-%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D0%25B0">smart cards</a> in the system using the following APIs: <i>SCardEstablishContext</i> , <i>SCardListReaders,</i> and <i>SCardConnect</i> .  Unlike other, more complex cases of threats [ <a href="http://www.welivesecurity.com/2012/06/05/smartcard-vulnerabilities-in-modern-banking-malware/">1</a> , <a href="http://www.welivesecurity.com/2010/11/05/dr-zeus-the-bot-in-the-hat/">2</a> ], Win32 / Spy.Hesperbot collects only the names of smart cards and does not have the ability to interact with them. <br><br>  Downloadable files (configuration files and executable plug-in files) are encrypted using the <a href="http://ru.wikipedia.org/wiki/Twofish">Twofish algorithm</a> , whose 256-bit hash is based on data: <br><br><ul><li>  Computer Name (Computer Name). </li><li>  The ‚ÄúInstallDate‚Äù parameter of the [HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion] registry key. </li><li>  OS versions. </li><li>  Processor Architecture (x86, x64, IA64). </li><li>  The "MachineGuid" setting of the [HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Cryptography] registry key. </li><li>  The "DigitalProductId" parameter of the registry key is [HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion]. </li></ul><br>  To store data downloaded from C &amp; C and other auxiliary files (for example, a keylogger log file), Hesperbot creates a directory with an arbitrary name in the% APPDATA% folder. <br><br>  The Core module has the ability to embed its code not only in explorer.exe, but also in other running processes.  Malicious code uses an undocumented trick to intercept UserNotifyProcessCreate inside csrss.exe in order to ensure that its code is active in every running process. <br><br>  The keylogger component intercepts keystrokes through the functions <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644936%2528v%3Dvs.85%2529.aspx">GetMessage</a> and <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms644955%2528v%3Dvs.85%2529.aspx">TranslateMessage</a> .  The symbols are then saved to a log file with information about the process and the name of the window in which they were entered.  After that, the file is sent to the attackers server. <br><br>  The capture module screenshots of the desktop and the video is called httpi.  Video capture was also used in the Zeus banking Trojan program.  This feature allows attackers to see a more complete picture of what is happening with the user in the system.  This <i>feature</i> is implemented using the <i>AVIFileCreateStream</i> API, <i>AVIFileMakeCompressedStream</i> , <i>AVIStreamWrite</i> from the Avifil32.dll library. <br><br><img src="https://habrastorage.org/storage3/650/17c/920/65017c920f91066ddda210977b473e5f.png"><br>  Fig.  Video creation code. <br><br>  Screenshots of the desktop are created using the functions of the Gdi32.dll library. <br><br>  The possibility of a VNC connection was <a href="http://habrahabr.ru/company/eset/blog/174281/">previously observed</a> in the famous Carberp Trojan program.  It allows you to create a VNC server on the side of the infected computer, which the attacker will have access to.  Since, unlike RDP, VNC does not perform a user log off operation, an attacker can connect to the victim during its operation.  This is achieved by creating an auxiliary desktop ( <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/ms682124(v%3Dvs.85).aspx">CreateDesktop</a> ), which is invisible to the user.  This module provides an attacker with the ability to run a browser process installed on the system.  In this case, the attacker gets access to his stored data (cookies, sessions, etc.). <br><br>  <b>Networking and Web Injecting</b> <br><br>  Hesperbot is not the first banking malware that uses WinSock library functions ( <i>send</i> , <i>WSASend</i> , etc.) and WinInet libraries ( <i>HttpSendRequest</i> , <i>InternetReadFile</i> , etc.) to gain complete control over user HTTP / HTTPS network traffic.  Similar mechanisms were used in the famous Zeus and SpyEye trojans.  Using this approach allows attackers to perform web injections (web-injects), receive form-grabbing data and perform other operations to steal information that the user enters into the pages opened in the web browser.  These methods are called "Man-in-the-Browser" attack.  Win32 / Spy.Hesperbot uses a slightly different approach when attacking a user, which we <a href="http://www.welivesecurity.com/2012/06/28/win32gataka-a-banking-trojan-ready-to-take-off/">have already seen</a> in another Win32 / Gataka banking Trojan. <br><br>  Interception of traffic and the introduction of HTML-code modules nethk, httphk and httpi, which were mentioned above in the table of components. <br><br><img src="https://habrastorage.org/storage3/430/83d/314/43083d3146d01831bb2b81ceca1ea0f3.jpg"><br>  Fig.  The interaction of different modules Hesperbot. <br><br><ul><li>  <b>nethk</b> - used to deploy a local proxy, intercepts functions for working with sockets when tracking connections;  contains hooks for SSL certificate validation functions in the browser. </li><li>  <b>httphk</b> - used when parsing HTTP traffic. </li><li>  <b>httpi</b> - used for taking screenshots, capturing video, removing data forms and introducing HTML-code (web-injects). </li></ul><br>  The <b>nethk</b> module is the first downloadable malicious code plugin.  It is downloaded by the <b>core</b> component.  Win32 / Spy.Hesperbot performs a man-in-the-middle attack by creating a local proxy (local proxy) through which it can control all connections initiated by the browser process. <br><br><img src="https://habrastorage.org/storage3/dcb/a45/c89/dcba45c891d56c7a1484054b5d767d8d.png"><br>  Fig.  Proxy creation code. <br><br><img src="https://habrastorage.org/storage3/592/97a/c33/59297ac330a2bee3547bf988d19fd4ea.png"><br>  Fig.  Internet Explorer network connections through the established Hesperbot proxy. <br><br>  A Trojan program using the <b>nethk</b> module creates a proxy on an arbitrary port with the address 127.0.1.1 and intercepts the following functions of the mswsock.dll library: <i>WSPSocket</i> , WSPIoctl, <i>WSPConnect</i> , <i>WSPCloseSocket</i> .  Pointers to these functions are modified in the <i>WSPPROC_TABLE</i> table.  To understand how this redirection works, the malicious version of <i>WSPConnect</i> is presented below. <br><br><img src="https://habrastorage.org/storage3/45c/b0d/741/45cb0d741f8f1c294eeb4266be83d1e9.png"><br>  Fig.  Malicious version of WSPConnect API. <br><br>  For example, if a user wants to log in to the online banking system and the browser tries to establish a secure connection to the bank‚Äôs website, the connection request will be intercepted by the Hesperbot code to create a local proxy, after which the online banking system will deal with the attacker's socket. <br><br><img src="https://habrastorage.org/storage3/a03/904/5d3/a039045d3de8097f0ea5b7b4e7965f27.jpg"><br>  Fig.  Scheme of the malicious proxy. <br><br>  The httphk module's callback function is called each time the proxy intercepts the request from the browser before sending it to the real server.  In addition, httphk is called every time a proxy intercepts a response to a request from a real server, before sending it to the browser.  Further httphk continues to work with traffic. <br><br>  There are differences in the processing of HTTP and HTTPS traffic.  In the case of a simple HTTP connection, the data in request / response mode is simply transmitted from httphk and vice versa.  In the case of a secure HTTPS connection, the malicious code uses the capabilities of the nethk module in order to ‚Äúget rid of encryption‚Äù.  When an HTTPS request initiated by the browser is intercepted (the request data is already encrypted using a fake certificate, see below as), it is decrypted and this data is sent to the httphk module via the callback function and then encrypted with this server certificate (i.e. certificate of the bank‚Äôs website), and then sent to the destination.  With the arrival of the server's response, i.e., the HTTPS response, the proxy decrypts it using this certificate and sends this data to the httphk for encryption with a fake certificate before sending it to the browser. <br><br>  Thus, using the "man-in-the-middle" proxy, Win32 / Spy.Hesperbot can access the victim's outgoing HTTPS traffic before it is encrypted with this certificate.  Zeus and SpyEye use a similar approach, but their MitB implementation is different from that used in Hesperbot. <br><br>  Malicious code gives the browser its certificate to simulate an HTTPS connection.  The <b>nethk</b> module has its own self-signed SSL certificate on board. <br><br><img src="https://habrastorage.org/storage3/373/a58/b09/373a58b09df05fbd8481b9f68729abdc.png"><br>  Fig.  SSL certificate inside nethk. <br><br><img src="https://habrastorage.org/storage3/ab1/33e/b9b/ab133eb9b03aee26be7d1fbf8db21c96.png"><br>  Fig.  An example of using a fake certificate Hesperbot.  On a regular system, you can see a real Google certificate instead of a fake. <br><br>  In order to trick the browser certificate validation component, the malicious code intercepts the corresponding certificate verification functions.  The release of such interceptions depends on the victim‚Äôs browser.  The table below shows the browsers supported by Win32 / Spy.Hesperbot and the functions that are intercepted. <br><br><img src="https://habrastorage.org/storage3/b89/fbd/5e4/b89fbd5e4f09ea139599642b78b0907b.png"><br><br>  The authors of the malicious code used hashes of process names, instead of string-based comparisons to complicate the analysis. <br><br><img src="https://habrastorage.org/storage3/c12/b7a/e74/c12b7ae746eb5e5b12124ff7ed3a41fc.png"><br><br>  The screenshot below shows the interception code <i>CertVerifyCertificateChainPolicy</i> . <br><br><img src="https://habrastorage.org/storage3/4e0/c22/ffd/4e0c22ffd63c3c4151063456337e7856.png"><br><br>  The <b>httphk</b> module <b>is</b> responsible for analyzing the HTTP protocol data.  When the callback function of this module is called, it performs the analysis of HTTP headers, data, and fills its internal data structures.  In the future, this structure will be available through the module <b>httpi</b> .  httphk provides two callback functions to call httpi: httpi_request_callback and httpi_response_callback. <br><br>  The <b>httpi</b> module <b>modifies the</b> HTTP protocol data according to the configuration file settings.  When it calls httpi_request_callback, the following actions are performed. <br><br><ul><li>  Capture video and desktop screenshots.  The malicious code reads the configuration file data and checks the requested URL.  In the case of a match, the video is captured or screenshots are created. </li><li>  Extract form data (form grabbing).  The malicious code checks the content-type parameter in the header of the HTTPS POST request for a match with ‚Äúapplication / x-www-form-urlencoded‚Äù or ‚Äútext / plain‚Äù.  In the event of a match, it is assumed that data is being transmitted for the login form.  If this URL is specified in the configuration file, then the data is written to a log file. </li></ul><br>  When you call httpi_response_callback, the Trojan program checks the HTTP response code for the value 200 (OK).  After that, the configuration file is read and if web injections are specified for the site, they are inserted into the web page. <br><br>  The figure below shows the decrypted configuration file that was used in the Portuguese botnet.  You may notice that the first group of domains will be ignored by the httpi module.  This suggests that Facebook and Google account data is considered to be not as valuable to attackers as the online banking account data below. <br><br><img src="https://habrastorage.org/storage3/27e/0c5/f18/27e0c5f182198c1c6aef8b1ced6998f1.png"><br><br>  It seems that people who wrote the code for web-inject scripts speak Russian, as evidenced by the accompanying comments.  However, it should be noted that the scripts could have been written by quite different people, other than the authors of Win32 / Spy.Hesperbot.  The web-inject scripts are quite similar among different families of malicious programs and their use is quite common among cybercriminals. <br><br>  <b>Mobile component</b> <br><br>  Hesperbot is not the first such malware that uses mobile components (ZitMo or SpitMo) to bypass the SMS-based authentication confirmation system ( <a href="http://en.wikipedia.org/wiki/Transaction_authentication_number">Mobile Transaction Authentication Number</a> ).  This banking transaction confirmation system is widely used in many European countries and in Russia. <br><br>  Hesperbot implements the introduction of special JS scripts into web pages through which the user is asked to install an application for a mobile phone.  The compromised user is offered a special list of phone models and after entering the phone number, he is sent a link to download a malicious mobile application.  The application exists in versions for Symbian, Android and Blackberry. <br><br><img src="https://habrastorage.org/storage3/a0b/1cc/185/a0b1cc1858633878015fbd2df7669880.png"><br><br>  We were able to analyze malicious components for the Symbian and Android platforms.  They have similar capabilities.  First, this is the ‚Äúactivation procedure‚Äù (activation procedure).  A special web injection on the infected computer generates a random ‚Äúactivation number‚Äù that is displayed to the user.  Next, he will need to duplicate this number on his device when such an action is offered by the mobile application.  The mobile application displays the "response code", which is calculated through the activation code.  This user code must be entered back into the web page for confirmation.  The malicious script is equipped with the same algorithm for calculating the code as the mobile one.  Thus, by simulating a trusted application on a user's mobile device and using a fake web page on his computer, attackers can bypass the code verification system for conducting operations related to online banking. <br><br><img src="https://habrastorage.org/storage3/958/ad6/55c/958ad655ccf77bf388d203abb208e3f9.png"><br>  Fig.  Screenshot malware component for Android [ <b>Android / Spy.Hesperbot.A</b> ]. <br><br>  This malicious mobile application registers a special service that waits for incoming SMS messages and forwards them to the attacker's number.  Thus, the attacker will receive this code to conduct a transaction or other banking transaction. <br><br>  ESET anti-virus applications detect mobile malware like <b>Android / Spy.Hesperbot.A</b> and <b>SymbOS9 / Spy.Hesperbot.A</b> . </div><p>Source: <a href="https://habr.com/ru/post/193318/">https://habr.com/ru/post/193318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193306/index.html">NORD data center on Korovinsky highway</a></li>
<li><a href="../193308/index.html">Challenge for $ 500. How a startup programmer was looking for</a></li>
<li><a href="../193310/index.html">Klipsch KMC 3 Wireless Bluetooth Audio System Overview</a></li>
<li><a href="../193312/index.html">PrioVR - another piece of a set of "avoiding reality"</a></li>
<li><a href="../193314/index.html">Drive Market: shopping and driving</a></li>
<li><a href="../193320/index.html">Zero without a wand?</a></li>
<li><a href="../193322/index.html">RailsClub'Moscow 2013. Interview with Eric Hodel</a></li>
<li><a href="../193326/index.html">Dear Reader, you are one year old. Congratulations!</a></li>
<li><a href="../193330/index.html">Arduino Y√∫n - Wi-Fi and Ethernet with it</a></li>
<li><a href="../193332/index.html">Highly Available RabbitMQ Cluster</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>