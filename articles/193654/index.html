<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Application of EDS in SAP NetWeaver web templates</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is devoted to the rather nontrivial task of integrating electronic digital signatures into SAP Business Templates Web Applications that I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Application of EDS in SAP NetWeaver web templates</h1><div class="post__text post__text-html js-mediator-article">  The article is devoted to the rather nontrivial task of integrating electronic digital signatures into SAP Business Templates Web Applications that I work with in SAP NetWeaver. <br>  I apologize in advance if the article will make mistakes in terminology or in logic. <br><a name="habracut"></a><br>  General information about EDS can be obtained in Wikipedia <a href="http://ru.wikipedia.org/wiki/%25D0%25AD%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2582%25D1%2580%25D0%25BE%25D0%25BD%25D0%25BD%25D0%25B0%25D1%258F_%25D1%2586%25D0%25B8%25D1%2584%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D1%258F_%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">EDS</a> <br><br><h4>  What was the task </h4><br>  There is SAP NetWeaver in the role of data warehouse Business Warehouse. <br>  All data is stored in cubes.  Documents are stored in cubes.  The document, in fact, is a set of cube rows that have the same attribute ‚Äî the document number.  Work with data is based on web templates of Business Explorer Web Application.  The contents of the documents are displayed in the analisys item component. <br><br>  A few words for those unfamiliar with Bex Web.  The technology of web templates (web forms) essentially resembles ASP.NET.  In the designer, you create a form layout using components similar to ASP (dataGrid, button, etc.).  Using wizards you hook up event handlers (these can be certain commands or arbitrary ABAP code).  When you run a web form - it is processed on the server and clients are given an HTML page with JS.  Reaction to user actions - performed on the server side when the page is updated.  In the web template code, there is usually no need to generate HTML, as in PHP. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In a certain web form, users enter data into a table represented by the analisys item.  The entered data is saved to the cube.  After entering the data, the user must change their status (for example, from ‚ÄúNew‚Äù to ‚ÄúProcessed‚Äù: status is transferred using the repost function according to the values ‚Äã‚Äãof the status data storing feature; this feature is also in the same cube). <br>  So, it is necessary to sign the entered data using an EDS after entering / saving the data and before the user transfers this data from the ‚ÄúNew‚Äù status to ‚ÄúProcessed‚Äù (the user who entered the data must sign). <br><br>  An online search has shown that using EDS is not as easy as we would like.  Most countries have their own laws governing the use of cryptographic tools.  <a href="http://www.rg.ru/2002/01/10/podpis-dok.html">Federal Law of the Russian Federation of January 10, 2002 N 1-FZ "On Electronic Digital Signature"</a> <br>  In particular, algorithms are established that should be used in encrypting and generating a signature.  For example, the algorithm for the formation and verification of electronic digital signature <a href="http://ru.wikipedia.org/wiki/%25D0%2593%25D0%259E%25D0%25A1%25D0%25A2_%25D0%25A0_34.10-2001">GOST R 34.10-2001</a> <br><br>  Of course, it makes no sense to try to implement these algorithms ourselves, so we look at what is offered on the market. <br>  For example, solutions "LISSI" <br>  <a href="http://www.lissi.ru/solution/">http://www.lissi.ru/solution/</a> <br><br>  Position themselves saviors on a white horse for SAP'ovtsev. The complex of software from them will cost more than 300,000 rubles.  The software is an API for SAP products that can be accessed through ABAP. <br>  The problem is that these products imply signing data through an ABAP code.  On the client, we only have a web page with JS.  You can execute ABAP code only on the server, for example using an AJAX request.  But there is a problem - the user's private key is available only on the client.  It should not be sent to the server.  The LISSI solution implies working on a client machine of a full-fledged, non-thin SAP client, in which ABAP can be performed. <br>  Therefore, I refused ready-made solutions and implemented EDS through CAPICOM <a href="http://ru.wikipedia.org/wiki/CAPICOM">CAPICOM</a> <br><br><h4>  Realization of EDS </h4><br>  Here is a description of how implemented the EDS <br><br><h5>  1 Order of application of EDS </h5><br>  1) The security administrator registers the certificate in the certificate database.  The certificate must be obtained from an authentic certification authority. <br><br>  2) The user works in the system, creates a document and signs it using his private key on an external medium.  Wherein: <br>  a) A ‚Äúcast‚Äù of the document is created (all its content is selected). <br>  b) A cryptographic signing operation is performed on the contents, resulting in a signature. <br>  c) The fingerprint is extracted from the signer's certificate and compared with the fingerprint registered to this user.  In case of coincidence - the signature is saved in the database, otherwise the signature is canceled. <br><br>  3) On subsequent document views, the signature is checked when the document is opened.  The signature is retrieved from the database.  Over the signature and the contents of the document are carried out cryptographic verification of the signature. <br><br>  4) The security administrator can add user certificates to the certificate database, suspend them temporarily or permanently. <br><br><h5>  2 Implementation of data storage </h5><br>  Signatures are stored in a flat table "Signatures". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0e3/766/8a1/0e37668a19c0f57e25c7fafd36f6fb33.png" alt="image"><br><br>  Database certificates - a set of two flat tables: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f98/a70/dd9/f98a70dd9a4ba3552a61a50a7e3234cb.png" alt="image"><br><br>  Keys - certificates themselves.  The table stores the key-tied user, the date of the beginning and end of the key's validity, the key itself, the status (blocked or not), a description. <br><br>  Suspensions - a set of possible key stoppages.  Stores the start, end, and pause date.  Also stores ID of the suspended key. <br><br><h5>  3 Digital Signature System Architecture </h5><br>  The digital signature mechanism is based on the following components. <br>  1) ActiveX component to access the cryptographic API.  (CAPICOM) <br>  2) Using JS, we get the contents of the document <br>  3) Call the ActiveX method of the component to sign the data. <br>  4) Send a signature to the server (ABAP class) in order to place in the database of signatures. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6f5/f99/23f/6f5f9923f50b7b8aa7544212d10a0e34.png" alt="image"><br><br>  CAPICOM is a library from MS that provides an interface to crypto providers. <br>  1 - by means of JS code, calls to the CAPICOM library occur <br>  2 - A web template forms the data for the signature (XML, describing the DataProvider). <br>  3 - The received signature is transmitted by AJAX to the ABAP class, which maintains the signature in a flat table. <br>  4 - the interaction of the crypto provider with eToken occurs automatically. <br><br><h5>  4 API implementation </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/bee/0fb/36e/bee0fb36e510b2c28356ed572fabd79c.png" alt="image"><br><br>  Signer class - implements custom methods - <br>  Sign, verify signature, get latest signature <br>  The CryptoProvider class is a Capicom wrapper. <br>  ZCL_AJAX_DIG_SIGN - implementation of interface methods via Ajax. <br>  Z_DIGITAL_SIGNER - implementation of methods for saving and searching for a signature, methods for checking the validity of a public key using a key database. <br><br><h5>  5 Optional verbal description </h5><br>  Consider the procedure for signing \ document verification. <br><br>  The user clicks on the form button "Approve (save) the document."  JS collects the content of the document previously uploaded there from the html code of the template.  Appeals to CAPICOM, which asks a person to select the desired certificate.  When choosing a certificate made for cryptoPro specifically for work in the system - CAPICOM contact the provider CryptoPRO, the same will ask for a token with a private key.  When the token is inserted - the document content will be signed.  The AJAX signature is thrown into the BSP application; it passes the signature to the interface class Z_DIGITAL_SIGNER.  The class will verify the certificate from the signature, the fact that such a certificate is tied to this logged in user.  If verification is successful, it will write the signature to the signature database.  There will be changes on the form - a mark about a successful signature will appear. <br><br>  When another user opens a document, the signing status will appear.  This will happen as follows.  JS by AJAX will request signatures for the document, will receive a signature (a priori - it is made by the right person and signed by a certificate from the database of allowed certificates).  Then js jerks CAPICOM - ‚Äúsignature verification‚Äù method with ‚Äúsignature‚Äù and ‚Äúdocument content‚Äù parameters.  If everything is in order with the document and signature, the method returns true, therefore, the document is signed and correct. <br>  There is also a GUI for the security administrator - maintaining a database of active certificates. <br><br><h4>  Connecting EDS to a web template </h4><br><br>  1) connect the CAPICOM component to the XHTML web template of the ActiveX, for example <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">object</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CapicomObj"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">codebase</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bwmimerep:///sap/bw/mime/Customer/JS/bin/capicom.cab"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clsid:A996E48C-D3DC-4244-89F7-AFA33EC60679"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">VIEWASTEXT</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><br>  2) Create a new data provider with the same query as the main one.  That is, make a copy of the provider.  Thus, we will get the uploaded document in HTML, which we will sign.  It is impossible to sign the provider who displays the document in the user's table, because when sorting or filtering the table, the data in the providers will change, and we need the document in its initial form. <br><br>  3) Place on the form the component "data provider-information". <br>  Let's call it DATA_PROVIDER_TO_SIGN. <br><img src="https://habrastorage.org/getpro/habr/post_images/732/800/267/73280026734ddd85b3475c5685549565.png" alt="image"><br>  Blue is the ‚Äúdata provider-information‚Äù component, red is in the component palette, yellow is the data provider supplying the document content <br><br>  4) Specify in the settings DATA_PROVIDER_TO_SIGN: <br>  Data Provider: We specify the provider‚Äôs copy created in step 2. <br>  Navigation Status - Output: Off <br>  Report data: output: On <br><br>  5) Place the code on the form <br>  It all depends on your imagination.  I will not post ALL my code, including AJAX, ABAP, JavaScript, I will leave only a simple wrapper for CAPICOM, which I made based on examples from the Microsoft website. <br><br>  <a href="http://pastebin.com/tCHbZ5TZ">Pastebin code</a> <br><br>  And an example of its use <br>  Signing <br><pre> <code class="javascript hljs">SignerProv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoProvider(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CapicomObj); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SignerProv.IsCAPICOMInstalled()) { SignerProv.Init(); Sign = SignerProv.SignedData(DataToSign); }</code> </pre><br>  Signature verification <br><pre> <code class="javascript hljs">SignerProv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoProvider(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CapicomObj); SignerProv.VerifySert = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<span class="hljs-comment"><span class="hljs-comment">//false ‚Äì         if (SignerProv.IsCAPICOMInstalled()) { var SRes = SignerProv.VerifySig(ContentToVerif, SignToVerify); }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/193654/">https://habr.com/ru/post/193654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193640/index.html">Access control based on behavioral characteristics</a></li>
<li><a href="../193642/index.html">Asm.js practice</a></li>
<li><a href="../193644/index.html">Homemade LED illuminator for photo and video</a></li>
<li><a href="../193646/index.html">Direct data transfer between FPGA Virtex-7 over the bus PCI Express</a></li>
<li><a href="../193650/index.html">How to buy a 3D printer in China, or Toy for $ 1000</a></li>
<li><a href="../193658/index.html">Applying local binary patterns to solving face recognition tasks</a></li>
<li><a href="../193660/index.html">Media Center from MacMini and Rapsberry PI</a></li>
<li><a href="../193662/index.html">Sharing SAML 2.0 SSO Integration Experience</a></li>
<li><a href="../193666/index.html">Steganography in .NET applications or watermarks</a></li>
<li><a href="../193668/index.html">Straight lines in a hexagonal raster</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>