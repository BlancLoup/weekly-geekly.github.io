<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Is it possible to automatically solve the Mercator puzzle from Google?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently there was an article about a cool cartographic puzzle from Google . After I spent about 20 minutes trying to figure it out, I wondered if I c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Is it possible to automatically solve the Mercator puzzle from Google?</h1><div class="post__text post__text-html js-mediator-article">  Recently there was an article about a <a href="http://habrahabr.ru/post/168735/">cool cartographic puzzle from Google</a> .  After I spent about 20 minutes trying to figure it out, I wondered if I could do it automatically? <br><br><a name="habracut"></a><br><br>  The first thing to do is get all the polygons.  After reading the source code of the page and opening the developer console, the following code was born: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (polyIdx=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;polys.length;polyIdx++){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> paths = polys[polyIdx].getPaths().getArray(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arMultiPolygons=[]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (j=<span class="hljs-number"><span class="hljs-number">0</span></span>;j&lt;paths.length;j++){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arPolygons=[]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i=<span class="hljs-number"><span class="hljs-number">0</span></span>;i&lt;paths[j].length;i++) { arPolygons.push([paths[j].getArray()[i].lng(),paths[j].getArray()[i].lat()]); } arMultiPolygons.push(p) } }</code> </pre> <br>  In the array <code>polys</code> - all polygons are stored.  Then it is easy to get the coordinates of all the vertices of the polygons, but you need not forget that all the same it is <a href="http://technet.microsoft.com/en-us/library/bb964739.aspx">MultiPolygons</a> .  Next you need to put these polygons in the database.  Solution: <a href="http://pypi.python.org/pypi/selenium">selenium</a> , which allows js code to be executed.  Base - PostgreSQL + Postgis. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> selenium <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> webdriver <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> shapely.geometry <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> polygon,multipolygon <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> shapely.wkt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> loads <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 con = psycopg2.connect(database=<span class="hljs-string"><span class="hljs-string">"WB"</span></span>,user=<span class="hljs-string"><span class="hljs-string">'postgres'</span></span>,password=<span class="hljs-string"><span class="hljs-string">'pass'</span></span>, host=<span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>, port=<span class="hljs-string"><span class="hljs-string">'5432'</span></span>) cur = con.cursor() <span class="hljs-comment"><span class="hljs-comment">#  ur.execute("create table googlePolygons ( idx integer, googlegeom geometry );") browser = webdriver.Firefox() browser.get("http://gmaps-samples.googlecode.com/svn/trunk/poly/puzzledrag.html") polysCount = browser.execute_script('return polys.length;') for iPoly in xrange(polysCount): element = browser.execute_script('var paths = polys[%s].getPaths().getArray();var arMultiPolygons=[];' 'for (j=0;j&lt;paths.length;j++){ var arPolygons=[];' 'for (i=0;i&lt;paths[j].length;i++) ' '{arPolygons.push([paths[j].getArray()[i].lng(),paths[j].getArray()[i].lat()]);} arMultiPolygons.push(p)}' 'return arMultiPolygons;'% str(iPoly)) polygons = [] #    for i in element: polygons.append(polygon.Polygon(i)) #   cur.execute("insert into googlePolygons (googlegeom,idx) values (geomfromewkt('"+multipolygon.MultiPolygon(polygons).wkt+"')," + str(iPoly)+");") con.commit()</span></span></code> </pre><br>  Here a wonderful <a href="http://pypi.python.org/pypi/Shapely">shapely</a> library was used, which allows you to work with geo-objects right in python.  Then I thought that in general, why then cling to the base, if everything is so cool.  But the output was bad - except for how to serialize objects this library did not suit me.  The first difference that caught my eye is different centroids with post-gap in cases where there are more than one polygon.  And since I was going to compare the areas of countries, the algorithm would be as follows: <ul><li>  The polygon was taken, the centroid was subtracted from it, then the centroid of the country with which the reconciliation was carried out would be added (in other words, it moved the polygon) </li><li>  Next would be considered the ratio by which you need to bring \ distance each point on the border of the polygon from the centroid (increase / decrease due to projection) </li><li>  Was considered the area </li></ul><br>  And the algorithm is such just because shapely does not know how to count the area of ‚Äã‚Äãgeographical objects (at least I did not find how).  Therefore, all the same, I decided to leave a binding to postgis, because there it is possible to convert geometries into geography. <br>  Well, then everything is easier: you need to find on the Internet a shape file with the countries polygons, fill it with postgis and make comparisons. <br>  Shapes I took <a href="http://thematicmapping.org/downloads/world_borders.php">from here</a> .  How to load them into the database is written a lot, problems can only be in the encoding, which is not UTF-8. <br><br>  The simplest part remains: compare squares <br><br><pre> <code class="python hljs">cur.execute(<span class="hljs-string"><span class="hljs-string">"select idx,st_area(geography(st_setsrid(googlegeom,4326)))/1000000, "</span></span> <span class="hljs-string"><span class="hljs-string">"st_astext(st_centroid(st_setsrid(googlegeom,4326))) "</span></span> <span class="hljs-string"><span class="hljs-string">"from googlePolygons order by idx;"</span></span>) unRealC = cur.fetchall() cur.execute(<span class="hljs-string"><span class="hljs-string">"select name, st_area(geography(st_setsrid(geom,4326)))/1000000, "</span></span> <span class="hljs-string"><span class="hljs-string">"st_astext(st_centroid(st_setsrid(geom,4326))) from tm_world_borders;"</span></span>) realC = cur.fetchall() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> urc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> unRealC: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> realC: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> float(abs(rc[<span class="hljs-number"><span class="hljs-number">1</span></span>]-urc[<span class="hljs-number"><span class="hljs-number">1</span></span>])) /rc[<span class="hljs-number"><span class="hljs-number">1</span></span>]&lt;<span class="hljs-number"><span class="hljs-number">0.02</span></span>: browser.execute_script(<span class="hljs-string"><span class="hljs-string">'pl = new google.maps.Polyline('</span></span> <span class="hljs-string"><span class="hljs-string">'{path: [new google.maps.LatLng('</span></span>+str(loads(rc[<span class="hljs-number"><span class="hljs-number">2</span></span>]).y)+<span class="hljs-string"><span class="hljs-string">','</span></span>+ str(loads(rc[<span class="hljs-number"><span class="hljs-number">2</span></span>]).x)+<span class="hljs-string"><span class="hljs-string">'),'</span></span> <span class="hljs-string"><span class="hljs-string">' new google.maps.LatLng('</span></span>+str(loads(urc[<span class="hljs-number"><span class="hljs-number">2</span></span>]).y)+<span class="hljs-string"><span class="hljs-string">','</span></span>+ str(loads(urc[<span class="hljs-number"><span class="hljs-number">2</span></span>]).x)+<span class="hljs-string"><span class="hljs-string">')],'</span></span> <span class="hljs-string"><span class="hljs-string">'map: map});'</span></span>)</code> </pre><br>  I put the <code>float(abs(rc[1]-urc[1])) /rc[1]&lt;0.02</code> - 2% error.  Added a line that connected the center of the original polygon with the center of its likely actual location.  <code>loads()</code> - converting WKT to an object. <br>  Here's what happened: <br><img src="http://habrastorage.org/storage2/dc7/d9b/cfc/dc7d9bcfc4d977aec154ea9dc0c6f832.png"><br>  What did not work: Greenland, South Africa, Iceland, Thailand.  Using another shape found on the disk, it was possible to achieve with the same 2% that only South Africa and Thailand were undecided. <br><br>  From the above, it follows that I did not succeed, due to the fact that I do not know from what Google builds the borders of states, and it is also not known how much they have simplified these borders. <br><br>  I think it would be possible to achieve the result: add a check of the similarity of the polygon shape.  But the basic methods of the same Postgis can not do this.  The algorithm I think is this: a strong simplification of the geometry, and then a comparison of angles in the allowable range. </div><p>Source: <a href="https://habr.com/ru/post/169493/">https://habr.com/ru/post/169493/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169481/index.html">In iOS 6.1, password bypass is possible</a></li>
<li><a href="../169483/index.html">Digital equipment sales statistics in Russia</a></li>
<li><a href="../169485/index.html">Review of the antique computer company NEXT</a></li>
<li><a href="../169487/index.html">The hierarchy of design principles, or the most important words for engineers</a></li>
<li><a href="../169489/index.html">The Start-Up Visa Program is a new emigration program to Canada for startups and research participants.</a></li>
<li><a href="../169497/index.html">A history of irresponsibility and one vulnerability</a></li>
<li><a href="../169499/index.html">Review ultrabook SONY VAIO SVS13A1V8RS</a></li>
<li><a href="../169503/index.html">Meteor Rain?</a></li>
<li><a href="../169505/index.html">Intellectual property in the field of software. Expert answers</a></li>
<li><a href="../169507/index.html">How to prepare and make a crowd movie about music from around the world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>