<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>.Net Core, 1C, dynamic compilation, Scripting API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to the people of Habratchane! Today I will continue to torment you with the great and mighty Ruslish. This is a continuation of the articles:...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>.Net Core, 1C, dynamic compilation, Scripting API</h1><div class="post__text post__text-html js-mediator-article">  Good day to the people of Habratchane!  Today I will continue to torment you with the great and mighty Ruslish.  This is a continuation of the articles: <br><br>  ¬ª <a href="https://habrahabr.ru/post/304482/">Development ‚Üí Cross-platform use of .Net classes from unmanaged code.</a>  <a href="https://habrahabr.ru/post/304482/">Or analogue IDispatch on Linux</a> <br>  ¬ª <a href="https://habrahabr.ru/post/304542/">Development ‚Üí Cross-platform use of .Net classes in 1C through Native VK.</a>  <a href="https://habrahabr.ru/post/304542/">Or replacing COM with Linux</a> <br>  ¬ª <a href="http://habrahabr.ru/post/307188">Cross-platform use of .Net classes in 1C through Native VK.</a>  <a href="http://habrahabr.ru/post/307188">Or replacing COM with Linux II</a> <br>  ¬ª <a href="https://habrahabr.ru/topic/edit/307360/">Asynchronous programming in 1C via .Net Native VK</a> <br>  <a href="https://habrahabr.ru/post/308216/">1C, Linux, Excel, Word, OpenXML, ADO and Net Core</a> <br><br>  Currently in .Net Core 2 dynamic compilation options 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. This is an analogue of CodeDom Microsoft.CodeAnalysis.CSharp.CSharpCompilation <br>  2. Roslyn Scripting Api.  Examples <a href="https://github.com/dotnet/roslyn/wiki/Scripting-API-Samples">here</a> <br><a name="habracut"></a><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> compilation = Microsoft.CodeAnalysis.CSharp.CSharpCompilation.Create(<span class="hljs-string"><span class="hljs-string">"a"</span></span>) .WithOptions(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Microsoft.CodeAnalysis.CSharp.CSharpCompilationOptions(Microsoft.CodeAnalysis.OutputKind.DynamicallyLinkedLibrary)) .AddReferences( Microsoft.CodeAnalysis.MetadataReference.CreateFromFile(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>).GetTypeInfo().Assembly.Location)) .AddSyntaxTrees(Microsoft.CodeAnalysis.CSharp.CSharpSyntaxTree.ParseText( <span class="hljs-string"><span class="hljs-string">@" using System; public class C { public C(){} public string M() { return ""Hello Roslyn.""; } }"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileName = <span class="hljs-string"><span class="hljs-string">@"d:\NetStandart\TestCoreNetApp\src\TestCoreNetApp\bin\Debug\netcoreapp1.0\a.dll"</span></span>; compilation.Emit(fileName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = System.Runtime.Loader.AssemblyLoadContext.Default.LoadFromAssemblyPath(fileName); Type  = a.GetType(<span class="hljs-string"><span class="hljs-string">"C"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj = Activator.CreateInstance(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = .GetMethod(<span class="hljs-string"><span class="hljs-string">"M"</span></span>).Invoke(obj, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); Console.WriteLine(res.ToString());</code> </pre> <br>  This approach is good when you need to update the library.  But this creates a DLL with all the consequences. <br><br>  I like the second way more.  Take the example of getting a delegate. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> words = <span class="hljs-string"><span class="hljs-string">"        "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> pattern = <span class="hljs-string"><span class="hljs-string">@"\w+"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scr = Microsoft.CodeAnalysis.Scripting.ScriptOptions.Default; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mscorlib = Assembly.Load(System.Runtime.Loader.AssemblyLoadContext.GetAssemblyName(<span class="hljs-string"><span class="hljs-string">@"c:\Users\Smirnov_SA\.nuget\packages\Microsoft.NETCore.Portable.Compatibility\1.0.1\ref\netcore50\mscorlib.dll"</span></span>)); scr =scr.WithReferences(mscorlib, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MulticastDelegate).GetTypeInfo().Assembly, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(System.Runtime.CompilerServices.IStrongBox).GetTypeInfo().Assembly, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MatchEvaluator).GetTypeInfo().Assembly, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Regex).GetTypeInfo().Assembly) .WithImports(<span class="hljs-string"><span class="hljs-string">"System"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.Text.RegularExpressions"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  = <span class="hljs-string"><span class="hljs-string">@"return (MatchEvaluator)((match) =&gt; { string x = match.Value; // If the first char is lower case... if (char.IsLower(x[0])) { // Capitalize it. return char.ToUpper(x[0]) + x.Substring(1, x.Length - 1); } return x; });"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = Microsoft.CodeAnalysis.CSharp.Scripting.CSharpScript.EvaluateAsync(, scr).Result; MatchEvaluator evaluator = (MatchEvaluator)result; Console.WriteLine(Regex.Replace(words, pattern, evaluator));</code> </pre><br>  Be sure to include links to: <br><blockquote>  mscorlib.dll <br>  System.Private.CoreLib.ni.dll <br>  System.Runtime.dll </blockquote><br>  The following libraries are used for compilation: <br><blockquote>  "Microsoft.CodeAnalysis.CSharp": "2.0.0-beta3", <br>  "Microsoft.CodeAnalysis.CSharp.Scripting": "2.0.0-beta3", <br>  "Microsoft.CodeAnalysis.Scripting.Common": "2.0.0-beta3", <br>  Microsoft.CodeAnalysis.Scripting </blockquote><br>  By dynamic compilation.  At one time he worked with spare parts for cars.  And there are a lot of suppliers and customers.  At the same time prices for millions of positions.  And everyone is ready to give data in its own format.  It was easier for each client to write code in the directory and use it through Run or Calculate.  True, when working with millions of prices, this approach was inhibited. <br><br>  One way or another, I had to write DLLs and work through COM. <br><br>  With the help of dynamic compilation, you can store the text of the code and apply it depending on the conditions.  Including dynamically form the conditions, and the compiled delegate can be cached for reuse. <br>  The compilation speed is quite high (except for the first time seconds 5). <br><br>  Let's go to 1C.  So the algorithm on 1C looks like this <br><br><pre> <code class="1c hljs"> = <span class="hljs-string"><span class="hljs-string">"return (MatchEvaluator)((match) =&gt; |{ | string x = match.Value; |// If the first char is lower case... |if (char.IsLower(x[0])) |{ |// Capitalize it. |return char.ToUpper(x[0]) + x.Substring(1, x.Length - 1); |} |return x; | |});"</span></span>;  = <span class="hljs-string"><span class="hljs-string">"        "</span></span>;  = <span class="hljs-string"><span class="hljs-string">"\w+"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// MatchEvaluator evaluator = (MatchEvaluator)(); ScriptOptions=("Microsoft.CodeAnalysis.Scripting.ScriptOptions","Microsoft.CodeAnalysis.Scripting"); CSharpScript=("Microsoft.CodeAnalysis.CSharp.Scripting.CSharpScript","Microsoft.CodeAnalysis.CSharp.Scripting"); scr = (ScriptOptions.Default); mscorlib = (.("mscorlib.dll",)); Private_CoreLib=(.("System.Private.CoreLib.ni",)); System_Runtime=(.("System.Runtime",)); RegularExpressions=(.("System.Text.RegularExpressions",)); Regex=(RegularExpressions.GetType("System.Text.RegularExpressions.Regex")); scr =(scr.WithReferences(mscorlib.(), Private_CoreLib.(), System_Runtime.(), RegularExpressions.())); scr =(scr.WithImports("System", "System.Text.RegularExpressions")); evaluator = ((CSharpScript.EvaluateAsync(, scr.())).Result); (Regex.Replace(, , evaluator.()));</span></span></code> </pre><br>  In general, nothing special.  Received the assembly, gave links to them compiled, called. <br><br>  Let us turn to more complex examples.  So in the previous article I showed examples of using DocumentFormat.OpenXml on the example of reading Excel and Word. <br><br>  There was a problem in speed due to bringing the string to the object through the function  and the call rate itself from 1C is 5 times slower than its native code. <br><br>  Therefore, we will render most of the code in .Net.  A similar option is on the large .Net <br>  <a href="http://infostart.ru/public/466196/">.Net in 1C.</a>  <a href="http://infostart.ru/public/466196/">On the example of using HTTPClient, AngleSharp.</a>  <a href="http://infostart.ru/public/466196/">Convenient parsing of sites using the AngleSharp library, including authorization ala JQuery using CSS selectors.</a>  <a href="http://infostart.ru/public/466196/">Dynamic compilation</a> (example at the end of the article). <br><br>  Create a class and copy it into the layout.  The essence of the class is to read the data cells and group them by line number. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>  { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExcelReader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Regex  = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Regex(<span class="hljs-string"><span class="hljs-string">"[A-Za-z]+"</span></span>); OpenXmlElementList ; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ,  ) { . = ; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> match = .Match(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>  = match.Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>  = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(.Substring(.Length)); . = ; . = ; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (List&lt;&gt; , Cell cell) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span>  = cell.CellReference.InnerText; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text = cell.CellValue?.Text; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> DataType = cell.DataType; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> res = text; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DataType != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; DataType == CellValues.SharedString) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ssid = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(text); res = [ssid].InnerText; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (); (, result); result. = res; .Add(result); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;&gt; ReadExcel(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fileName) { List&lt;&gt;  = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (FileStream fs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(fileName, FileMode.Open, FileAccess.Read, FileShare.ReadWrite)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (SpreadsheetDocument doc = SpreadsheetDocument.Open(fs, <span class="hljs-literal"><span class="hljs-literal">false</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> workbookPart = doc.WorkbookPart; <span class="hljs-comment"><span class="hljs-comment">//    //     var pt = workbookPart.GetPartsOfType&lt;SharedStringTablePart&gt;(); var sstpart = pt.First(); var sst = sstpart.SharedStringTable;  = sst.ChildElements; var workbook = workbookPart.Workbook; //    var sheet = workbook.Descendants&lt;Sheet&gt;().First(); var worksheetPart = (DocumentFormat.OpenXml.Packaging.WorksheetPart)workbookPart.GetPartById(sheet.Id); var worksheet = worksheetPart.Worksheet; var cells = worksheet.Descendants&lt;Cell&gt;(); // One way: go through each cell in the sheet foreach (Cell cell in cells) { (, cell); } } } return ; } static string (List&lt;&gt; ) { var  = ""; var  = 0; foreach (var  in ) { var  = .; var  = .Length; if ( &gt; ) {  = ;  = ; } else if ( ==  &amp;&amp; string.Compare(, , true) &gt; 0)  = ; } return ; } public static object (string fileName) { var res = new ExcelReader(); var  = res.ReadExcel(fileName); var  = .GroupBy( =&gt; .).Select( =&gt; new {  = .Key,  = .ToArray() }).OrderBy( =&gt; .); var  = (); return new {  = .ToList(),  =  }; } } return new Func&lt;string, object&gt;(ExcelReader.);</span></span></code> </pre><br>  We have described a reading class and return a reference to the delegate that takes the path to the file and returns an anonymous class.  All the same, in 1C we will work with him through reflection.  Please note that 2 classes are described here. <br><br>  Now let's call this code from 1C. <br><br><pre> <code class="1c hljs">ScriptOptions=(<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.Scripting.ScriptOptions"</span></span>,<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.Scripting"</span></span>); CSharpScript=(<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.CSharp.Scripting.CSharpScript"</span></span>,<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.CSharp.Scripting"</span></span>); scr = (ScriptOptions.Default); mscorlib = (.(<span class="hljs-string"><span class="hljs-string">"mscorlib.dll"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); Private_CoreLib=(.(<span class="hljs-string"><span class="hljs-string">"System.Private.CoreLib.ni"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); System_Runtime=(.(<span class="hljs-string"><span class="hljs-string">"System.Runtime"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); RegularExpressions=(.(<span class="hljs-string"><span class="hljs-string">"System.Text.RegularExpressions"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); OpenXml=(.(<span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml.dll"</span></span>)); Linq=(.(<span class="hljs-string"><span class="hljs-string">"System.Linq"</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>)); FileSystem=(.(<span class="hljs-string"><span class="hljs-string">"System.IO.FileSystem"</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>)); Regex=(RegularExpressions.GetType(<span class="hljs-string"><span class="hljs-string">"System.Text.RegularExpressions.Regex"</span></span>)); scr =(scr.WithReferences(mscorlib.(), Private_CoreLib.(), System_Runtime.(), RegularExpressions.(),OpenXml.(),Linq.(),FileSystem.())); scr =(scr.WithImports(<span class="hljs-string"><span class="hljs-string">"System"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.Collections.Generic"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.Linq"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.IO"</span></span>, <span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml"</span></span>, <span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml.Packaging"</span></span>, <span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml.Spreadsheet"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.Text.RegularExpressions"</span></span>)); =(<span class="hljs-string"><span class="hljs-string">""</span></span>).();  = ((CSharpScript.EvaluateAsync(, scr.())).Result); = (.DynamicInvoke()); <span class="hljs-built_in"><span class="hljs-built_in"></span></span>(.); =<span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-type"><span class="hljs-type"></span></span>; =.; (.,); =.; =(.); =(.(.())); =<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       .MoveNext()  = (.Current); =.;  &lt;  =+1; .(); ; =+1; =.(); //     =(.); =(.(.()));  .MoveNext()  = (.Current); =.; =.; //        64  1  26   //         =.(); .(.(),); ; ;</span></span></code> </pre><br>  Now Excel's processing speed has increased significantly, and the compilation costs are commensurate with the cost of reading files. <br><br>  Let's look at the process of reading Word.  Without further ado, I took a ready class <a href="https://code.msdn.microsoft.com/office/CSOpenXmlGetPlainText-554918c3/sourcecode%3FfileId%3D71592%26pathId%3D851860130">here</a> .  Moreover, everything is in English. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//     //https://code.msdn.microsoft.com/office/CSOpenXmlGetPlainText-554918c3/sourcecode?fileId=71592&amp;pathId=851860130 public class GetWordPlainText : IDisposable { // Specify whether the instance is disposed. private bool disposed = false; // The word package private WordprocessingDocument package = null; /// &lt;summary&gt; /// Get the file name /// &lt;/summary&gt; private string FileName = string.Empty; /// &lt;summary&gt; /// Initialize the WordPlainTextManager instance /// &lt;/summary&gt; /// &lt;param name="filepath"&gt;&lt;/param&gt; public GetWordPlainText(string filepath) { this.FileName = filepath; if (string.IsNullOrEmpty(filepath) || !File.Exists(filepath)) { throw new Exception("The file is invalid. Please select an existing file again"); } this.package = WordprocessingDocument.Open(filepath, true); } /// &lt;summary&gt; /// Read Word Document /// &lt;/summary&gt; /// &lt;returns&gt;Plain Text in document &lt;/returns&gt; public string ReadWordDocument() { StringBuilder sb = new StringBuilder(); OpenXmlElement element = package.MainDocumentPart.Document.Body; if (element == null) { return string.Empty; } sb.Append(GetPlainText(element)); return sb.ToString(); } /// &lt;summary&gt; /// Read Plain Text in all XmlElements of word document /// &lt;/summary&gt; /// &lt;param name="element"&gt;XmlElement in document&lt;/param&gt; /// &lt;returns&gt;Plain Text in XmlElement&lt;/returns&gt; public string GetPlainText(OpenXmlElement element) { StringBuilder PlainTextInWord = new StringBuilder(); foreach (OpenXmlElement section in element.Elements()) { switch (section.LocalName) { // Text case "t": PlainTextInWord.Append(section.InnerText); break; case "cr": // Carriage return case "br": // Page break PlainTextInWord.Append(Environment.NewLine); break; // Tab case "tab": PlainTextInWord.Append("\t"); break; // Paragraph case "p": PlainTextInWord.Append(GetPlainText(section)); PlainTextInWord.AppendLine(Environment.NewLine); break; default: PlainTextInWord.Append(GetPlainText(section)); break; } } return PlainTextInWord.ToString(); } #region IDisposable interface public void Dispose() { Dispose(true); GC.SuppressFinalize(this); } protected virtual void Dispose(bool disposing) { // Protect from being called multiple times. if (disposed) { return; } if (disposing) { // Clean up all managed resources. if (this.package != null) { this.package.Dispose(); } } disposed = true; } #endregion public static string GetText(string FileName) { using (var pt = new GetWordPlainText(FileName)) { return pt.ReadWordDocument(); } } } return new Func&lt;string,string&gt;(GetWordPlainText.GetText);</span></span></code> </pre><br>  But back to Ruslish: <br><br><pre> <code class="1c hljs">ScriptOptions=(<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.Scripting.ScriptOptions"</span></span>,<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.Scripting"</span></span>); CSharpScript=(<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.CSharp.Scripting.CSharpScript"</span></span>,<span class="hljs-string"><span class="hljs-string">"Microsoft.CodeAnalysis.CSharp.Scripting"</span></span>); scr = (ScriptOptions.Default); mscorlib = (.(<span class="hljs-string"><span class="hljs-string">"mscorlib.dll"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); Private_CoreLib=(.(<span class="hljs-string"><span class="hljs-string">"System.Private.CoreLib.ni"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); System_Runtime=(.(<span class="hljs-string"><span class="hljs-string">"System.Runtime"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); RegularExpressions=(.(<span class="hljs-string"><span class="hljs-string">"System.Text.RegularExpressions"</span></span>,<span class="hljs-literal"><span class="hljs-literal"></span></span>)); OpenXml=(.(<span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml.dll"</span></span>)); Linq=(.(<span class="hljs-string"><span class="hljs-string">"System.Linq"</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>)); FileSystem=(.(<span class="hljs-string"><span class="hljs-string">"System.IO.FileSystem"</span></span>, <span class="hljs-literal"><span class="hljs-literal"></span></span>)); Regex=(RegularExpressions.GetType(<span class="hljs-string"><span class="hljs-string">"System.Text.RegularExpressions.Regex"</span></span>)); scr =(scr.WithReferences(mscorlib.(), Private_CoreLib.(), System_Runtime.(),OpenXml.(),FileSystem.())); scr =(scr.WithImports(<span class="hljs-string"><span class="hljs-string">"System"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.Text"</span></span>, <span class="hljs-string"><span class="hljs-string">"System.IO"</span></span>, <span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml"</span></span>, <span class="hljs-string"><span class="hljs-string">"DocumentFormat.OpenXml.Packaging"</span></span>)); =(<span class="hljs-string"><span class="hljs-string">""</span></span>).();  = ((CSharpScript.EvaluateAsync(, scr.())).Result);  = .DynamicInvoke(); =<span class="hljs-keyword"><span class="hljs-keyword"></span></span> <span class="hljs-type"><span class="hljs-type"></span></span>; .(); .();</code> </pre><br>  The main task is to provide links to the used assemblies and namespace. <br><br>  In the next article, I will create a dynamic wrapper over objects using events, by analogy with <br>  <a href="http://infostart.ru/public/417830/">.NET (C #) for 1C.</a>  <a href="http://infostart.ru/public/417830/">Dynamic compilation of a wrapper class for using .Net events in 1C via Add Handler or Processing an External Event</a> </div><p>Source: <a href="https://habr.com/ru/post/309340/">https://habr.com/ru/post/309340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309326/index.html">How does MySQL replication work?</a></li>
<li><a href="../309328/index.html">The basics of indexing and EXPLAIN in MySQL</a></li>
<li><a href="../309330/index.html">Database scaling through sharding and partitioning</a></li>
<li><a href="../309332/index.html">Principles and techniques for processing queues</a></li>
<li><a href="../309338/index.html">Future is now: what will happen on JavaDay Kharkiv 2016, September 17</a></li>
<li><a href="../309342/index.html">We invite you on October 19, Moscow to the IX conference "Embedded Technologies 2016. Industrial Internet of Things"</a></li>
<li><a href="../309344/index.html">Contact Service Desk. Where do customers care more: in IT services or repair of air conditioners?</a></li>
<li><a href="../309346/index.html">IT news. August</a></li>
<li><a href="../309348/index.html">Spam protection at 8800 in FreePBX</a></li>
<li><a href="../309350/index.html">Ecosystem R as a tool for automating business tasks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>