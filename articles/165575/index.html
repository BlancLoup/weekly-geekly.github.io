<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Downloading GNU / Linux without a third-party bootloader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will give an example of how you can refuse to use a third-party bootloader, be it Grub or Lilo, if your computer supports the moder...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Downloading GNU / Linux without a third-party bootloader</h1><div class="post__text post__text-html js-mediator-article">  In this article, I will give an example of how you can refuse to use a third-party bootloader, be it Grub or Lilo, if your computer supports the modern UEFI standard, which came to replace the BIOS.  An interesting feature is that we carry out all the work on the already installed and working system. <br>  In terms of complexity, this article is aimed at experienced Linux users, because  Some of the points I touch superficially, relying on evidence, so as not to go away from the main topic covered. <br><br><a name="habracut"></a><br><br><h4>  Introduction </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I'll tell you a bit of history - I have been a Gentoo Linux user for over 5 years now, and as the main and only OS on all the laptops I use: Lenovo (from X61s to X1) and Apple MacBook Pro.  Always with the new installation used the classic method of installing Gentoo on a clean hard drive, using chroot.  I set up the partition table and system boot in the old-fashioned way, as bequeathed by <a href="http://www.gentoo.org/doc/en/handbook/">Handbook</a> , based on the traditional MBR. <br><br><h4>  Kernel configuration </h4><br><br>  You must provide support for booting using UEFI in our kernel: <br><ul><li>  CONFIG_EFI = y - enable support for the UEFI standard </li><li>  CONFIG_EFI_STUB = y - enable the ability to load the kernel with UEFI firmware, which is what we need </li><li>  CONFIG_EFI_VARS = y - enabling the UEFI management interface via the variables / sys / firmware / efi / vars / *, you will need to specify where to look for the kernel to be loaded, used by the <i>efibootmgr</i> utility </li></ul><br><br>  When switching to UEFI, it is necessary to take into account the fact that it does not accept kernel boot parameters, therefore we will add all our parameters to the kernel itself: <br><pre><code class="bash hljs">CONFIG_CMDLINE=<span class="hljs-string"><span class="hljs-string">"root=/dev/sda2 rootfstype=ext4 quiet splash=silent,fadein,theme:natural_gentoo console=tty1"</span></span></code> </pre> <br>  In the example, the parameters I use, if we talk about the required minimum, then there‚Äôs enough of where the root file system is located: <br><pre> <code class="bash hljs">CONFIG_CMDLINE=<span class="hljs-string"><span class="hljs-string">"root=/dev/sda2"</span></span></code> </pre><br><br>  After making these changes, we compile and install the kernel according to the usual procedure.  Gentoo has a very handy tool called genkernel for this.  After assembly, we need to restart the computer, because  We need some new parameters for working with UEFI firmware. <br><br><h4>  Testing </h4><br>  To check the performance of our kernel, you need to try to load the OS via UEFI, but in order not to risk the boot partition of our working system, we will use a usb flash drive, after removing all partitions from it. <br><br><h5>  Training </h5><br>  To load with UEFI, we need a special partition called EFI Secure Partition or abbreviated ESP, which will have only one file on it - this is the UEFI support kernel that we prepared earlier.  At its core, this is a regular GPT partition with a specific type and FAT32 file system. <br><br><h5>  Creating an ESP Partition </h5><br>  To create an ESP partition, we need the gptfdisk package, information from the Gentoo package base: <br><pre> <code class="bash hljs">* sys-apps/gptfdisk Available versions: 0.8.4 ~0.8.5 {{kernel_linux}} Homepage: http://www.rodsbooks.com/gdisk/ Description: gdisk - GPT partition table manipulator <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Linux</code> </pre><br><br>  You can install it by running the command as root: <br><pre> <code class="bash hljs">emerge sys-apps/gptfdisk</code> </pre><br>  Working with this tool is almost no different from all the familiar fdisk.  Suppose that our usb flash drive was defined in the system as / dev / sdb and we, of course, have root rights.  Perform the following steps: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># gdisk /dev/sdb Command (? for help): n Partition number (2-128, default 1): 1 First sector (34-3790814, default = 2048) or {+-}size{KMGTP}: 2048 Last sector (2049-3790814, default = 3790814) or {+-}size{KMGTP}: +100M Current type is 'Linux filesystem' Hex code or GUID (L to show codes, Enter = 8300): EF00 Changed type of partition to 'EFI System' Command (? for help): w Final checks complete. About to write GPT data. THIS WILL OVERWRITE EXISTING PARTITIONS!! Do you want to proceed? (Y/N): y OK; writing new GUID partition table (GPT) to /dev/sdb. The operation has completed successfully.</span></span></code> </pre><br><br>  As a result, we created a new sdb1 partition with a type of 'EFI System' and 100 MB in size, which is enough for testing.  Now, as with any new partition, we need to create a file system on it, in our case it is FAT32.  It's very simple to do - just execute just one command with root rights: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkfs.vfat -F 32 /dev/sdb1</span></span></code> </pre><br>  After executing the command, the file system will be created. <br><br><h5>  Copy core </h5><br>  Mount the new sdb1 partition into any directory and copy our prepared kernel there, with CONFIG_EFI_STUB enabled and other parameters described above (all commands should be executed with root privileges): <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mount /dev/sdb1 /mnt/ # cp /usr/src/linux/arch/x86_64/boot/bzImage /mnt/bzImage.efi # umount /dev/sdb1</span></span></code> </pre><br><br><h5>  BIOS setup </h5><br>  After preparing the test usb flash drive, you need to restart the computer and go to the BIOS settings and select the use of UEFI in the section responsible for the boot process.  After that, the system should boot up without any problems if the kernel and flash drive were prepared without errors.  Testing can be considered as passed and leave the system loaded from a flash drive. <br><br><h4>  Migrating boot on a production system </h4><br>  According to the results of the test passed above, we checked that our kernel works correctly with the UEFI firmware on our computer, so let's start migrating our working system to use a new type of boot.  The main problem is that the system is located on the partition created by the traditional MBR (Master Boot Record) based partitioning scheme, and for the UEFI you need a GPT partition.  This problem is solved by a tool we already know ‚Äî gdisk from the sys-apps / gptfdisk package.  When you first run gdisk for our hard disk, let it be / dev / sda, it will prompt us to convert partition tables to GTP format, warning of possible data loss.  Then we will do everything that we did when creating a usb-flash drive, but with a few changes. <br>  In view of the above, the work plan will be as follows: <br><ol><li>  disable boot partition </li><li>  backup partition </li><li>  convert MBR -&gt; GPT </li><li>  create a new file system on the boot partition </li><li>  connect to mount point and copy core </li><li>  configure UEFI firmware </li><li>  reboot the system and check the result </li></ol><br>  Next, we will focus on each item in more detail. <br><br><h6>  Disable boot partition </h6><br>  In most cases, the boot partition is connected to the / boot directory and has the first number among the partitions of the block device, i.e.  / dev / sda1, given that sda is our system disk.  Everything on my system is exactly the same, so we run the following command, with root privileges: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># umount /boot</span></span></code> </pre><br>  If this directory is not used by any applications, then it silently and without problems disconnect from the root and we will be able to back up the entire partition / dev / sda1. <br><br><h6>  Backup Boot Partition </h6><br>  At this stage, we need to make a backup of the entire section in order to be able to quickly roll back all changes.  Ideally, you can backup the entire system if you have the necessary tools at hand.  Copying the partition is done as follows, again as root: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># dd if=/dev/sda1 of=/root/sda1_backup.img</span></span></code> </pre><br>  Check the suitability of our backup: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mount -o loop /root/sda1_backup.img /mnt # ls -al /mnt &amp;&amp; umount /mnt</span></span></code> </pre><br>  After executing the ls command, we should see the contents of the directory similar to what was on the production system before disabling the / boot mount point. <br><br><h6>  Convert MBR table -&gt; GPT </h6><br>  Moving on to the gdisk utility.  The whole conversion process is simple and requires a minimum of participation on our part.  We need to run the gdisk command, change the sda1 partition type to EF00 (EFI System) and save the changes, i.e.  the procedure is completely analogous to the one we did with a usb flash drive, except for the fact that the partitions have already been created.  After saving the settings, our table will be transferred to the new format used by GPT and suitable for working with UEFI. <br><br><h6>  Create a new file system on a new bootable GPT partition </h6><br>  By analogy with the procedure for creating a usb-flash drive, we need to prepare the FAT32 file system on our boot partition, now of the type 'EFI System', by running the command: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mkfs.vfat -F 32 /dev/sda1</span></span></code> </pre><br>  After executing the command, the file system will be created. <br><br><h6>  Connect sda1 and copy core </h6><br>  At this stage, we need to copy the prepared kernel to the new partition.  To do this, run: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># mount /dev/sda1 /boot # cp /usr/src/linux/arch/x86_64/boot/bzImage /boot/bzImage.efi # umount mount /dev/sda1</span></span></code> </pre><br>  Preparation of the boot partition is over. <br><br><h6>  Configure UEFI firmware </h6><br>  In order for UEFI to transfer control to our kernel, you need to specify where it is located.  Configuring the UEFi firmware settings is a tool called efibootmgr: <br><pre> <code class="bash hljs">* sys-boot/efibootmgr Available versions: (~)0.5.4 Homepage: http://developer.intel.com/technology/efi Description: Interact with the EFI Boot Manager on IA-64 Systems</code> </pre><br>  It must be installed by running the command: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"sys-boot/efibootmgr"</span></span> &gt;&gt; /etc/portage/package.keywords emerge sys-boot/efibootmgr</code> </pre><br>  After installation, configure UEFI with the following command: <br><pre> <code class="bash hljs">efibootmgr --create --label <span class="hljs-string"><span class="hljs-string">'Gentoo-3.6.11'</span></span> --loader <span class="hljs-string"><span class="hljs-string">'\bzImage.efi'</span></span> --part 1</code> </pre><br>  A detailed description of all parameters can be found in the efibootmgr man page.  We use the following parameters: <br><ul><li>  --create - create a new variable in the loader </li><li>  --label 'Gentoo-3.6.11' - the name that will be displayed in the list of boot devices </li><li>  --loader '\ bzImage.efi' is the path to the bootloader, in our case it is built into the kernel, the path is absolute and using the "\" </li><li>  --part 1 - use the first partition of the sda ‚Äã‚Äãblock device </li></ul><br>  After executing the command, a detailed conclusion will be shown about the changes that have been made to UEFI. <br><br><h6>  Reboot the system and check the result. </h6><br>  This completes the setup and we have to reboot the system by disconnecting the usb flash drive to see how the system boots without using a third-party bootloader. <br><br>  After a successful boot, the bootloader package can be removed: <br><pre> <code class="bash hljs">grep sys-boot /var/lib/portage/world | xargs emerge -Cv</code> </pre><br><br>  That's all you can work with the system. <br><br><h4>  Updating the kernel with genkernel </h4><br>  When updating the kernel in the future, using the genkernel tool, the procedure will change somewhat, since  the kernel no longer needs to be installed in / boot.  Therefore, instead of 'genkernel all', you need to run the 'genkernel kernel', having previously corrected the parameter to the value INSTALL = "no" in the configuration of /etc/genkernel.conf.  After building the kernel, it must be renamed and manually copied to the / boot directory. <br><br>  The upgrade process in the end will look like this: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># genkernel kernel * Gentoo Linux Genkernel; Version 3.4.45 * Running with options: kernel ... * Kernel compiled successfully! ... * Do NOT report kernel bugs as genkernel bugs unless your bug * is about the default genkernel configuration... * * Make sure you have the latest ~arch genkernel before reporting bugs. # cp /usr/src/linux/arch/x86_64/boot/bzImage /boot/bzImage.efi # init 6</span></span></code> </pre><br><br><h4>  Results </h4><br><br>  Pros: <br><ul><li>  abandoned one laying in the OS boot process </li><li>  decreased system boot time </li><li>  learned how to work with the new UEFI standard, which replaced the BIOS </li></ul><br><br>  Minuses: <br><ul><li>  not found </li></ul><br><br><h4>  Information sources: </h4><br><ul><li>  <a href="http://www.ibm.com/developerworks/ru/library/l-gpt/">GPT article on IBM developerWorks</a> </li><li>  <a href="http://git.kernel.org/%3Fp%3Dlinux/kernel/git/stable/linux-stable.git%3Ba%3Dblob_plain%3Bf%3DDocumentation/x86/efi-stub.txt%3Bhb%3DHEAD">EFI-STUB documentation in the Linux kernel</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/165575/">https://habr.com/ru/post/165575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../165563/index.html">Simulate the night vision of a person in a 3D game</a></li>
<li><a href="../165565/index.html">Knockoutjs Grow a tree</a></li>
<li><a href="../165567/index.html">OpenVPN 2.3 released</a></li>
<li><a href="../165569/index.html">Yota site was hacked</a></li>
<li><a href="../165571/index.html">Timothy Farris - How to work 4 hours a week</a></li>
<li><a href="../165577/index.html">TextBox with cookies using User Control, Windows Phone / Store</a></li>
<li><a href="../165579/index.html">Facebook offers to write a message to Zuckerberg for $ 100.</a></li>
<li><a href="../165581/index.html">The European Commission may force Google to change the search results</a></li>
<li><a href="../165583/index.html">First impressions of PinBoard II R2 AVR + STM32</a></li>
<li><a href="../165585/index.html">Oh, let's go! Distributed computing yesterday and today</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>