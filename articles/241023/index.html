<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>BlackHole.js with leaflet.js maps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to you community! 

 I want to offer to your attention, all the same, brought to a certain point, my library for visualizing blackHole.js da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>BlackHole.js with leaflet.js maps</h1><div class="post__text post__text-html js-mediator-article">  Greetings to you community! <br><br>  I want to offer to your attention, all the same, brought to a certain point, my library for visualizing <a href="">blackHole.js</a> data using <a href="http://d3js.org/">d3.js.</a> <br>  This library allows you to create visualizations of such a plan: <br>  <i>pictures are clickable</i> <br> <a href="http://clearspending.artzub.com/"><img width="350" src="https://habrastorage.org/files/80c/ac7/b2c/80cac7b2c65f4bcb8caa3fed89d45eb1.gif" alt="image"></a>  or <a href="http://codepen.io/artzub/pen/vcfyd"><img width="350" src="https://habrastorage.org/files/2be/357/2fa/2be3572fade84c2ca8305686ffd3f0c3.gif"></a> <br><br>  The article will be devoted to the example of using <a href="">blackHole.js in</a> conjunction with <a href="http://leafletjs.com/">leaflet.js</a> and similar <a href="https://www.mapbox.com/">mapbox</a> types. <br>  But there will also be considered the use of: <a href="https://developers.google.com/maps/">google maps</a> , <a href="">leaflet.heat</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It turns out like this =) <br> <a href="http://codepen.io/artzub/pen/molHj"><img src="https://habrastorage.org/files/fee/82f/58d/fee82f58db1f40e5ac4642e71b335b2c.gif"></a> <br><blockquote>  <i>The behavior of the point depends on where I was in the opinion of google at a certain point in time.</i> </blockquote><br>  <a href="http://codepen.io/artzub/pen/molHj">Look, how did you move? ...</a> <br><a name="habracut"></a><br>  <i>The example is based on the <a href="http://theopolis.me/location-history-visualizer/">location-history-visualizer</a> project from <a href="http://theopolis.me/">@theopolisme</a></i> <br><br>  In the text of the article only interesting places will be disassembled. You can ‚Äúdig out‚Äù the rest of the code on <a href="http://codepen.io/artzub/pen/molHj">codepen.io</a> . <br><br><h4>  <b>In the article</b> </h4><br><ul><li>  <a href="https://habr.com/ru/post/241023/">Training</a> </li><li>  <a href="https://habr.com/ru/post/241023/">JS application</a> <br><ul><li>  <a href="https://habr.com/ru/post/241023/">Connection layer with blackHole.js</a> </li><li>  <a href="https://habr.com/ru/post/241023/">Personalization and display of Google Maps</a> </li><li>  <a href="https://habr.com/ru/post/241023/">Connecting layer c heatmap</a> </li><li>  <a href="https://habr.com/ru/post/241023/">Preparation and processing of data</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/241023/">Conclusion</a> </li></ul><br><h4>  <b>Training</b> </h4><a name="begin"></a><br>  First we need: <br><ul><li>  <a href="">leaflet.js</a> is an open source library written by Vladimir Agafonkin (CloudMade) in JavaScript for displaying maps on websites (¬© wikipedia). </li><li>  <a href="">Leaflet.heat</a> is a lightweight heatmap palgin for leaflet. </li><li>  <a href="http://maps.google.com/maps/api/js%3Fv%3D3%26sensor%3Dfalse">Google Maps Api</a> - to connect custom maps to google maps </li><li>  <a href="https://github.com/shramov/leaflet-plugins">Leaflet-plugins by Pavel Shramov</a> - the plugin allows you to <a href="http://leafletjs.com/">connect</a> google, yandex, bing to <a href="http://leafletjs.com/">leaflet.js</a> .  But we in particular need only the script <a href="">Google.js</a> </li><li>  <a href="http://d3js.org/">d3.js</a> is a library for working with data, possessing a set of tools for manipulating them and a set of methods for displaying them. </li><li>  Well, actually <a href="">blackHole.js</a> </li><li>  Your geo position data is carefully collected for us by Google. <br><div class="spoiler">  <b class="spoiler_title">How to upload data</b> <div class="spoiler_text">  To get started, you must go to <a href="https://google.com/takeout">Google Takeout</a> to download LocationHistory information.  On the page, click the <b>Select none</b> button, then find and mark it in the <b>‚ÄúLocation History‚Äù</b> list.  Click the <b>Next</b> button and click the <b>Create archive</b> button.  Wait for the work to complete.  Click the <b>Download</b> button and unzip the archive to the directory you need. <br></div></div><br></li></ul><br><br>  The example consists of three files index.html, index.css and index.js. <br>  The code of the first two you can look at <a href="http://codepen.io/artzub/pen/molHj">codepen.io</a> <br>  But in a nutshell, I can say that we really need the following DOM structure: <br><pre><code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"map"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--    --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br><h4>  <b>JS application</b> </h4><a name="appjs"></a><br><br>  The application itself consists of several parts. <br><ul><li>  <a href="https://habr.com/ru/post/241023/">Connect layer with blackHole.js</a> . </li><li>  <a href="https://habr.com/ru/post/241023/">Personalization and display of Google Maps</a> . </li><li>  <a href="https://habr.com/ru/post/241023/">Connection layer c heatmap</a> . </li><li>  <a href="https://habr.com/ru/post/241023/">Preparation and data processing</a> . </li></ul><br><br><h5>  <b>Class wrapper for blackHole for leaflet</b> </h5><a name="wbh"></a><br>  In order for us to share <a href="">blackHole.js</a> and <a href="http://leafletjs.com/">leaflet.js</a> , we need to create a wrapper layer to display our visualization on top of the map.  At the same time, we will keep all the mechanisms for working with the map and the interactive features of the blackHole.js library. <br>  The leaflet.js library has the tools we need: <b>L.Class</b> . <br>  In it we need to "overload" the methods: <b>initialize</b> , <b>onAdd</b> , <b>onRemove</b> , <b>addTo</b> . <br>  In fact, these are just methods for standard work with layers in <a href="http://leafletjs.com/">leaflet.js</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Class with description</b> <div class="spoiler_text"><pre> <code class="javascript hljs">!<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ L.BlackHoleLayer = L.Class.extend({ <span class="hljs-comment"><span class="hljs-comment">//     initialize: function () { }, //          onAdd: function (map) { //      ,      if (this._el) { this._el.style('display', null); //       if (this._bh.IsPaused()) this._bh.resume(); return; } this._map = map; //          div, //    this._el = d3.select(map.getPanes().overlayPane).append('div'); //   blackHole this._bh = d3.blackHole(this._el); //   div var animated = map.options.zoomAnimation &amp;&amp; L.Browser.any3d; this._el.classed('leaflet-zoom-' + (animated ? 'animated' : 'hide'), true); this._el.classed('leaflet-blackhole-layer', true); //     map.on('viewreset', this._reset, this) .on('resize', this._resize, this) .on('move', this._reset, this) .on('moveend', this._reset, this) ; this._reset(); }, //     leaflet    onRemove: function (map) { //           . this._el.style('display', 'none'); //   ,     if (this._bh.IsRun()) this._bh.pause(); }, //          . addTo: function (map) { map.addLayer(this); return this; }, //      resize _resize : function() { //      . this._bh.size([this._map._size.x, this._map._size.y]); this._reset(); }, //            _reset: function () { var topLeft = this._map.containerPointToLayerPoint([0, 0]); var arr = [-topLeft.x, -topLeft.y]; var t3d = 'translate3d(' + topLeft.x + 'px, ' + topLeft.y + 'px, 0px)'; this._bh.style({ "-webkit-transform" : t3d, "-moz-transform" : t3d, "-ms-transform" : t3d, "-o-transform" : t3d, "transform" : t3d }); this._bh.translate(arr); } }); L.blackHoleLayer = function() { return new L.BlackHoleLayer(); }; }();</span></span></code> </pre></div></div><br>  There is nothing special about this; any plugin, or layer, or control for <a href="http://leafletjs.com/">leaflet.js is</a> created in a similar way. <br>  Here for example visualization process <a href="">controls</a> for <a href="">blackHole.js</a> . <br><br><h5>  <b>Personalize google maps</b> </h5><a name="gmap"></a><br>  The Google Maps API provides the ability to personalize the displayed map.  To do this, you can read the <a href="https://developers.google.com/maps/documentation/javascript/styling">documentation</a> .  There are a lot of parameters and their combination that will give you the desired result.  But quickly use <a href="http://snazzymaps.com/">ready-made kits</a> . <br><br>  Let's now create a map and request google titles in the style we need. <br><br><div class="spoiler">  <b class="spoiler_title">Add code google maps</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//     div#map var map = new L.Map('map', { maxZoom : 19, //    minZoom : 2 //   }).setView([0,0], 2); //       //     google c  ROADMAP   . var ggl = new L.Google('ROADMAP', { mapOptions: { backgroundColor: "#19263E", styles : [ { "featureType": "water", "stylers": [ { "color": "#19263E" } ] }, { "featureType": "landscape", "stylers": [ { "color": "#0E141D" } ] }, { "featureType": "poi", "elementType": "geometry", "stylers": [ { "color": "#0E141D" } ] }, { "featureType": "road.highway", "elementType": "geometry.fill", "stylers": [ { "color": "#21193E" } ] }, { "featureType": "road.highway", "elementType": "geometry.stroke", "stylers": [ { "color": "#21193E" }, { "weight": 0.5 } ] }, { "featureType": "road.arterial", "elementType": "geometry.fill", "stylers": [ { "color": "#21193E" } ] }, { "featureType": "road.arterial", "elementType": "geometry.stroke", "stylers": [ { "color": "#21193E" }, { "weight": 0.5 } ] }, { "featureType": "road.local", "elementType": "geometry", "stylers": [ { "color": "#21193E" } ] }, { "elementType": "labels.text.fill", "stylers": [ { "color": "#365387" } ] }, { "elementType": "labels.text.stroke", "stylers": [ { "color": "#fff" }, { "lightness": 13 } ] }, { "featureType": "transit", "stylers": [ { "color": "#365387" } ] }, { "featureType": "administrative", "elementType": "geometry.fill", "stylers": [ { "color": "#000000" } ] }, { "featureType": "administrative", "elementType": "geometry.stroke", "stylers": [ { "color": "#19263E" }, { "lightness": 0 }, { "weight": 1.5 } ] } ] } }); //    . map.addLayer(ggl);</span></span></code> </pre></div></div><br>  As a result, we get just such a card <br><img src="https://habrastorage.org/files/e82/e00/28e/e82e0028ecee41189e152d1af238bc3b.png"><br>  I came to this solution after some time in the <a href="http://mapbox.com/">MapBox</a> project, which provides a tool for conveniently styling maps and much more, but with more requests it becomes paid. <br><br><h5>  <b>Heatmap</b> </h5><a name="heatmap"></a><br>  <a href="https://ru.wikipedia.org/wiki/%25D0%25A2%25D0%25B5%25D0%25BF%25D0%25BB%25D0%25BE%25D0%25BA%25D0%25B0%25D1%2580%25D1%2582%25D0%25B0">Heatmap or heatmap</a> allows you to display the frequency of mentioning a particular coordinate, highlighting the intensity of a gradient of colors and grouping data when scaling.  It turns out something like <br><img src="https://habrastorage.org/files/2fc/4d9/e96/2fc4d9e9684d40f7b1cae041b2bfc52d.png"><br><br>  To build it, we use the <a href="">leaflet.heatmap</a> plugin.  But there are <a href="http://leafletjs.com/plugins.html">others</a> . <br><br>  In order for our visualization to always be on top of other layers, and in particular over the heatmap, and not lose its interactive features, you need to add <a href="">blackHole.js</a> after other layers of plug-ins are added to the map. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    blackHole.js var visLayer = L.blackHoleLayer() , heat = L.heatLayer( [], { //    heatmap opacity: 1, //  radius: 25, //  blur: 15 //   }).addTo( map ) //     heatmap ; visLayer.addTo(map); //    blackHole.js</span></span></code> </pre><br><br><h5>  <b>Data preparation and visualization</b> </h5><a name="data"></a><br>  The library is ready to work immediately from the "box" with a specific data format, namely: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rawData = [ { <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-number"><span class="hljs-number">237</span></span>, <span class="hljs-string"><span class="hljs-string">"category"</span></span>: <span class="hljs-string"><span class="hljs-string">"nemo,"</span></span>, <span class="hljs-string"><span class="hljs-string">"parent"</span></span>: { <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"cumque5"</span></span>, <span class="hljs-string"><span class="hljs-string">"key"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, <span class="hljs-string"><span class="hljs-string">"date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2014-01-30T12:25:14.810Z"</span></span> }, <span class="hljs-comment"><span class="hljs-comment">//...      ]</span></span></code> </pre><br><br>  Then, to run the visualization, you need nothing more than js code: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = rawData.map(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">d</span></span></span><span class="hljs-function">) </span></span>{ d.date = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>(d.date); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> d; }) , stepDate = <span class="hljs-number"><span class="hljs-number">864e5</span></span> , d3bh = d3.blackHole(<span class="hljs-string"><span class="hljs-string">"#canvas"</span></span>) ; d3bh.setting.drawTrack = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; d3bh.on(<span class="hljs-string"><span class="hljs-string">'calcRightBound'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">l</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> +l + stepDate; }) .start(data) ;</code> </pre><br>  <i>more in the <a href="">documentation</a></i> <br><br>  But it turned out that we live in a world where there are ideal cases - once or twice and miscalculated. <br>  Therefore, the library provides programmers the <a href="">opportunity to</a> prepare <a href="">blackHole.js</a> to work with their data format. <br><br>  In our case, we are dealing with <a href="https://www.google.com/settings/takeout">LocationHistory.json</a> from Google. <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"somePointsTruncated"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"locations"</span></span> : [ { <span class="hljs-string"><span class="hljs-string">"timestampMs"</span></span> : <span class="hljs-string"><span class="hljs-string">"1412560102986"</span></span>, <span class="hljs-string"><span class="hljs-string">"latitudeE7"</span></span> : <span class="hljs-number"><span class="hljs-number">560532385</span></span>, <span class="hljs-string"><span class="hljs-string">"longitudeE7"</span></span> : <span class="hljs-number"><span class="hljs-number">929207681</span></span>, <span class="hljs-string"><span class="hljs-string">"accuracy"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"velocity"</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">"heading"</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">"altitude"</span></span> : <span class="hljs-number"><span class="hljs-number">194</span></span>, <span class="hljs-string"><span class="hljs-string">"verticalAccuracy"</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span> }, { <span class="hljs-string"><span class="hljs-string">"timestampMs"</span></span> : <span class="hljs-string"><span class="hljs-string">"1412532992732"</span></span>, <span class="hljs-string"><span class="hljs-string">"latitudeE7"</span></span> : <span class="hljs-number"><span class="hljs-number">560513299</span></span>, <span class="hljs-string"><span class="hljs-string">"longitudeE7"</span></span> : <span class="hljs-number"><span class="hljs-number">929186602</span></span>, <span class="hljs-string"><span class="hljs-string">"accuracy"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">"velocity"</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">"heading"</span></span> : <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">"altitude"</span></span> : <span class="hljs-number"><span class="hljs-number">203</span></span>, <span class="hljs-string"><span class="hljs-string">"verticalAccuracy"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> }, <span class="hljs-comment"><span class="hljs-comment">//...   ]}</span></span></code> </pre><br><br>  Let's prepare the data and configure blackHole.js to work with them. <br><div class="spoiler">  <b class="spoiler_title">Start / restart function</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ bh.stop(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !locations || !locations.length) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">//       heatmap heat.setLatLngs([]); //       bh.start(locations, map._size.x, map._size.y, true); visLayer._resize(); }</span></span></code> </pre></div></div><br><br>  Now data parsing <br><div class="spoiler">  <b class="spoiler_title">File reading and data preparation</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parentHash; <span class="hljs-comment"><span class="hljs-comment">//        . function stageTwo ( file ) { bh.stop(); //       //      LocationHistory    leaflet.js var SCALAR_E7 = 0.0000001; //    processFile( file ); function processFile ( file ) { // FileReader var reader = new FileReader(); reader.onprogress = function ( e ) { //      }; reader.onload = function ( e ) { try { locations = JSON.parse( e.target.result ).locations; if ( !locations || !locations.length ) { throw new ReferenceError( 'No location data found.' ); } } catch ( ex ) { //   console.log(ex); return; } parentHash = {}; //       var sw = [-Infinity, -Infinity] , se = [Infinity, Infinity]; locations.forEach(function(d, i) { d.timestampMs = +d.timestampMs; //    //   d.lat = d.latitudeE7 * SCALAR_E7; d.lon = d.longitudeE7 * SCALAR_E7; //     parent d.pkey = d.latitudeE7 + "_" + d.longitudeE7; //   sw[0] = Math.max(d.lat, sw[0]); sw[1] = Math.max(d.lon, sw[1]); se[0] = Math.min(d.lat, se[0]); se[1] = Math.min(d.lon, se[1]); //   ,     . d.parent = parentHash[d.pkey] || makeParent(d); }); //     locations.sort(function(a, b) { return a.timestampMs - b.timestampMs; }); //   id   locations.forEach(function(d, i) { d._id = i; }); //       map.fitBounds([sw, se]); //   restart(); }; reader.onerror = function () { console.log(reader.error); }; //     reader.readAsText(file); } } function makeParent(d) { var that = {_id : d.pkey}; //     leaflet that.latlng = new L.LatLng(d.lat, d.lon); //          //     that.x = { valueOf : function() { var pos = map.latLngToLayerPoint(that.latlng); return pos.x; } }; that.y = { valueOf : function() { var pos = map.latLngToLayerPoint(that.latlng); return pos.y; } }; return parentHash[that.id] = that; }</span></span></code> </pre></div></div><br>  Thanks to the ability to set the <b>valueOf</b> function to get the value of an object, we can always get the exact coordinates of the parent objects on the map. <br><br><div class="spoiler">  <b class="spoiler_title">Configure blackHole.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//         bh.setting.increaseChild = false; bh.setting.createNearParent = false; bh.setting.speed = 100; //     bh.setting.zoomAndDrag = false; bh.setting.drawParent = false; //   parent bh.setting.drawParentLabel = false; //     bh.setting.padding = 0; //     bh.setting.parentLife = 0; //    bh.setting.blendingLighter = true; //     Canvas bh.setting.drawAsPlasma = true; //        bh.setting.drawTrack = true; //    var stepDate = 1; //   //  , ,       (d) bh.on('getGroupBy', function (d) { //          return d._id //d.timestampMs; }) .on('getParentKey', function (d) { return d._id; //     }) .on('getChildKey', function (d) { return 'me'; //    ,       }) .on('getCategoryKey', function (d) { return 'me; //     ,      }) .on('getCategoryName', function (d) { return 'location'; //    }) .on('getParentLabel', function (d) { return ''; //       }) .on('getChildLabel', function (d) { return 'me'; //    }) .on('calcRightBound', function (l) { //            . return l + stepDate; }) .on('getVisibleByStep', function (d) { return true; //    }) .on('getParentRadius', function (d) { return 1; //    }) .on('getChildRadius', function (d) { return 10; //    }) .on('getParentPosition', function (d) { return [dx, dy]; //       }) .on('getParentFixed', function (d) { return true; //      }) .on('processing', function(items, l, r) { //     heatmap setTimeout(setMarkers(items), 10); }) .sort(null) ; //     heatmap function setMarkers(arr) { return function() { arr.forEach(function (d) { var tp = d.parentNode.nodeValue; //      heatmap heat.addLatLng(tp.latlng); }); } }</span></span></code> </pre></div></div><br>  How the library works.  When launched, it analyzes the data provided to it, identifying the parent and child unique elements.  Defines the rendering boundaries according to the function passed in for the <a href="">getGroupBy</a> event.  Behind that starts two <a href="https://github.com/mbostock/d3/wiki/Force-Layout">d3.layout.force</a> one is responsible for calculating the position of the parent elements, the other for the child elements.  Methods are also applied to child elements for resolving collisions and clustering according to the parent element. <br><br>  With our setup, we get the following behavior: <br><ul><li>  At each step that occurs after 100 milliseconds ( <i>bh.setting. <a href="">Speed</a> = 100</i> ), the library selects only one item from the source data; </li><li>  calculates its position relative to the parent element; </li><li>  starts drawing and moves to the next step; </li></ul><br>  Since we have one child object, it starts flying from one parent to another.  And it turns out the picture that is shown at the very beginning of the article. <br> <a href="http://codepen.io/artzub/pen/molHj"><img src="https://habrastorage.org/files/fee/82f/58d/fee82f58db1f40e5ac4642e71b335b2c.gif"></a> <br><br><h4>  <b>Conclusion</b> </h4><a name="end"></a><br><br>  The library was made to solve their own problems, since after the publication of <a href="http://ghv.artzub.com/">GitHub Visualizer</a> , there appeared a certain number of orders to remake it for various needs, and some wanted to just figure out what and how to change it to solve their problem. <br>  As a result, I made everything I needed to create visualizations like <a href="http://ghv.artzub.com/">GitHub Visualizer</a> into a separate library and have already done a number of projects, one of which took the first place in <a href="http://clearspending.ru/page/contest/result/">the GosHealth contest</a> . <br><br>  The simplified <a href="http://ghv.artzub.com/">GitHub Visualizer</a> on <a href="">blackHole.js, which</a> works with xml files obtained by running code_swarm, can be found <a href="http://codepen.io/artzub/pen/pygqo">here</a> . <br>  You can use this <a href="https://github.com/rictic/code_swarm/tree/master/bin">guide</a> to generate the file. <br><br>  I hope that there will be co-authors who will make their improvements and correct my misconceptions. <br><br>  At the moment, the library consists of 4 components: <br><ul><li>  <a href="">Parser</a> - creating objects for visualization from transferred data </li><li>  <a href="">Render</a> - engaged in drawing pictures </li><li>  <a href="">Processor</a> - calculation of visualization steps </li><li>  <a href="">Core</a> - collects all the parts in itself, manages them and is engaged in the calculation of the position of objects </li></ul><br>  In the near future, I plan to bring Parser and Render into separate classes in order to facilitate the task of preparing data and provide the opportunity to draw not only on the canvas, but also, if desired, on WebGL. <br><br>  Waiting for useful comments! <br>  Thank! <br><br>  <b>PS</b> Friends please write about errors in private messages. </div><p>Source: <a href="https://habr.com/ru/post/241023/">https://habr.com/ru/post/241023/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241011/index.html">Good morning, Vietnam!</a></li>
<li><a href="../241015/index.html">Mark Andressen: why optimism is always a winning strategy</a></li>
<li><a href="../241017/index.html">Simple examples of genuine customer focus</a></li>
<li><a href="../241019/index.html">Crash test for high-availability cloud platform</a></li>
<li><a href="../241021/index.html">Overview of the ready solution FlexPod</a></li>
<li><a href="../241025/index.html">How we developed our push notification system (and why)</a></li>
<li><a href="../241029/index.html">Radar hack</a></li>
<li><a href="../241031/index.html">How I did management accounting in Excel</a></li>
<li><a href="../241037/index.html">What conference do I like C # /. Net developer would like to go</a></li>
<li><a href="../241045/index.html">How to cook Skype-4.3 for Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>