<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we moved the cloud from 10G Ethernet to Infiniband 56G</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mellanox MC2609125-005 cable 

 In our case, Infiniband would work five times faster than Ethernet, and it would cost as much. There was only one diff...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we moved the cloud from 10G Ethernet to Infiniband 56G</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/712/01c/769/71201c7690a444b19fa9f3c22aff001d.jpeg"><br>  <i>Mellanox MC2609125-005 cable</i> <br><br>  <b>In our case, Infiniband would work five times faster than Ethernet, and it would cost as much.</b>  There was only one difficulty - all this had to be done without interrupting cloud services in the data center.  Well, this is about how to rebuild a car engine while driving. <br><br>  <b>In Russia, such projects simply did not exist.</b>  All those who have so far tried to switch from Ethernet to Infiniband have somehow stopped their infrastructure for a day or two.  <a href="https://cloud.croc.ru/%3Futm_source%3Dhabr%26utm_medium%3Dblog%26utm_campaign%3Did232509">We have</a> about 60 large customers <a href="https://cloud.croc.ru/%3Futm_source%3Dhabr%26utm_medium%3Dblog%26utm_campaign%3Did232509">in the cloud ‚Äúshoulder‚Äù</a> , which is located in the data center on Volochaevskaya-1 (including banks, retail, insurance and critical infrastructure) on almost 500 virtual machines located on about a hundred physical servers.  We were the first in the country to have the experience of rebuilding the infrastructure and network infrastructure without downtime, and we are a little proud of it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/35b/aeb/9af/35baeb9afac14004adf1168d4a61808f.jpeg"><br>  <i>Infiniband-cable at the entrance to the server</i> <br><br>  As a result, the bandwidth of the communication channels between the "cloud" servers increased from 10 Gb / s to 56 Gb / s. <a name="habracut"></a><br><br><h4>  What happened </h4><br>  In the data center on Volochaevskoy-1 there was Ethernet 10 GB, which united servers.  We began to seriously consider Infiniband for ourselves at the moment of designing our next data center - Compressor (TIER-3 level).  Comparing the total cost of ownership, taking into account the cards, switches, cable, maintenance, it turned out that Infiniband cost almost as much as Ethernet.  But it provided much less network latency and was corny faster at least 5 times. <br><br>  Well, plus it is worth mentioning the great fact that Infiniband at such facilities is an order of magnitude easier to set up and maintain.  The network is designed once and then quietly expands simply by plugging in new hardware.  No dancing with a tambourine as in the case of complex Ethernet-architectures, no bypass switches and settings for the situation.  If somewhere on the switch problems, only he falls, and not the entire segment.  Inside the infrastructure is a real plug-and-play. <br><br>  So, having built a cloud shoulder in the data center Compressor on Infiniband and feeling how great this technology is, we thought about rebuilding the cloud shoulder of the data center on Volochaevskaya-1 using FDR InfiniBand. <br><br><h4>  Provider </h4><br>  There are four large Infiniband suppliers, but the practice is that it is worth building the entire network on homogeneous equipment from one vendor, namely Mellanox.  In addition, at the time of design, it was the only vendor that supported the most modern Infinband standard - FDR.  Actually, we had a wonderful experience of reducing network delays for several customers (including a large financial company) with the use of Mellanox - their technology has proven itself well. <br><br>  Infiniband FDR latency is on the order of 1-1.5 microseconds, and on Ethernet on the order of 30-100 microseconds.  That is, the difference is two orders of magnitude, in practice in this particular case, too, something like this. <br><br>  Regarding the topology and architecture, we decided to greatly simplify our lives.  It turned out that it is not very difficult and costly to make exactly the same scheme as in the second cloud arm (our cloud is based in two data centers) - in the Compressor Data Center - this allowed us to get two identical sites.  What for?  It is easier to reserve replacement equipment, it is easier to maintain, there is no zoo equipment, each of which needs its own approach.  Plus, we just had quite a bit before the release of some equipment from the support - we also replaced the old servers.  I will clarify: this fact did not affect the decision-making, but it turned out to be a nice bonus. <br><br>  The most important reason was the reduction of network delays.  Many of our customers in the "cloud" use synchronous replication, and therefore reducing network delays can indirectly speed up work, for example, storage systems.  In addition, using Infiniband allows you to migrate virtual machines much faster.  If we are not talking about the current moment, but about the future, then since Infinband supports RDMA, then in the future we will be able to add the ability to migrate virtual machines a few times faster, replacing TCP with RDMA. <br>  Of course, now RDMA, TRILL, ECMP technologies appear in the Ethernet world, which together provide the same capabilities as Infiniband - but in Infinband the possibilities of building Leaf-Spine topology, RDMA, autotuning have been around for a long time and were designed at the protocol level rather than were added as AD-HOC solutions, as in Ethernet. <br><br><h4>  Transfer </h4><br>  In the cloud shoulder on Volochaiskaya, we had a network and storage segment on a 10-gigabit network.  We connected the infrastructure segment built on Mellanox to it, so that we got one L2 segment, and everything that was on the first stand in the online mode migrated to a new one.  The customers didn‚Äôt feel anything other than increasing the speed of the services, no machines were turned off, no critical problems occurred during the move. <br><br>  Here is the transfer scheme in a simplified version: <br><br><img src="https://habrastorage.org/files/1c9/c27/27d/1c9c2727d1fb4d8aaa1a4e8b8775e983.png"><br><br><img src="https://habrastorage.org/files/c2d/896/e57/c2d896e57ade479d99a17277bae79cf7.png"><br><br>  Here is more complicated: <br><br><img src="https://habrastorage.org/files/f66/358/813/f663588130c54bbdbebfe5611c5c2d85.png"><br><br>  In fact, we created one data transmission medium between these two stands, although the technologies are not very compatible in principle.  Transferred virtual infrastructure of customers, and then disconnected the stands. <br><br>  To combine the two environments, we used Mellanox SX6036 managed switches.  Before designing a test stand for cloud migration, an engineer from Mellanox came to us for advice and technical assistance.  After agreeing with him on our plans and capabilities of the Mellanox equipment, he sent us GW licenses, allowing us to use the switch as a Proxy-ARP gateway, which can transmit traffic from the Ethernet network to the Infiniband segment.  In total, the move made about a month (not counting work on the project).  It was divided into several stages, the first - we assembled a test stand - a mini-model of the "cloud" - in order to test the viability of the idea (it was necessary to migrate not only the usual, but also the storage network).  Worked several times transfers on the test stand and began to write a plan for combat migration. <br><br><img src="https://habrastorage.org/files/802/a2d/9d7/802a2d9d7aed44c3bb9566f42dc25344.png"><br>  <i>Testbed layout</i> <br><br>  Next - the operation service switched to the night schedule and slowly began to mount everything you need.  The story about the wife, whose husband went at night where it was not clear where and claimed that he went to work - it was just about such transfers. <br><br><img src="https://habrastorage.org/files/f2d/55f/23f/f2d55f23f1cb47a8a61516d0a29c401d.png"><br>  <i>The specific scheme (ip addresses, vlans, pkey necessary equipment settings for the day) to implement the transition from 10G network to Infiniband.</i> <br><br><img src="https://habrastorage.org/files/6b4/4e2/700/6b44e2700fa849f3846ce5804a21e46b.jpeg"><br>  <i>During installation</i> <br><br><img src="https://habrastorage.org/files/250/d4f/fb0/250d4ffb0a194121b98b2fd1fe81cba9.jpeg"><br>  <i>QSFP-4xSFP + Hybrid cable connected to Mellanox SX6036</i> <br><br><img src="https://habrastorage.org/files/5bb/95f/76c/5bb95f76c83a41a4b70e36797c3b030d.jpeg"><br>  <i>The same cable connected to the 10G switch Ethernet module</i> <br><br><img src="https://habrastorage.org/files/3eb/681/0fd/3eb6810fdddd4f8c84fb30de1e125c0e.jpeg"><br>  <i>Optics at the entrance to the 10G-Ethernet part</i> <br><br>  Old equipment is now standing aside, and we have already begun to disassemble it.  Slowly and quietly remove it from the racks and dismantle it.  Most likely, it will go to test environments to help us work out even more complex technical cases, which we will still please you with. <br><br>  Everything, at least formally, we have not finished the move yet (we need to remove the old stands), the result is already very warm.  I am pleased to answer your questions about the move in the comments or by mail <b>mberezin@croc.ru</b> . </div><p>Source: <a href="https://habr.com/ru/post/232509/">https://habr.com/ru/post/232509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232495/index.html">Wikimedia rejects photographer claims to monkey selfie</a></li>
<li><a href="../232499/index.html">How to manage a team - the story of one success</a></li>
<li><a href="../232501/index.html">Evolutionary Game Design</a></li>
<li><a href="../232505/index.html">Interfaces in the real world</a></li>
<li><a href="../232507/index.html">How to make sure that before you engineer</a></li>
<li><a href="../232511/index.html">Happy birthday, Jimmy Wales (father of Wikipedia)</a></li>
<li><a href="../232513/index.html">Manipulations with objects in photos in 3D</a></li>
<li><a href="../232515/index.html">See the invisible</a></li>
<li><a href="../232519/index.html">Sensor Hug helps to track water consumption throughout the day</a></li>
<li><a href="../232521/index.html">What is your procrastinator?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>