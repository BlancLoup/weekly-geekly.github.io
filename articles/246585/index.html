<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Declustering of MSCS Windows 2003 + SQL2005 server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to all. 

 In this article, I will describe my experience in converting an ‚Äúiron‚Äù MSCS cluster into a virtual server. 

 Our cluster has bee...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Declustering of MSCS Windows 2003 + SQL2005 server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/4af/726/859/4af72685987c49898b390ebdfb9aa00b.png" alt="image"><br><br>  Greetings to all. <br><br>  In this article, I will describe my experience in converting an ‚Äúiron‚Äù MSCS cluster into a virtual server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Our cluster has been working since 2008, there are a lot of tasks accumulated, including critical ones, and it was impossible to pick up a new server.  In addition, worn equipment was about to fail.  For us, there was only one way out - server virtualization in our data center, on VMware.  And for me the task was set - to leave clustering.  Having studied a lot of information in the network, I did not find a suitable step-by-step instruction, so I decided to compose my own. <br><a name="habracut"></a><br>  The initial state was as follows: <br><br><ul><li>  MSCS cluster on Windows 2003 Enterprise edition SP2.  Two nodes in Active \ Passive mode; </li><li>  SQL Server 2005 Standard Edition, running in cluster mode; </li><li>  Multiple WWW / FTP sites on IIS, not in cluster mode.  For each of the 32 Web sites, one IP Address is a cluster resource.  Roughly speaking, additional IP were attached to the network card.  Sites only worked on the intranet; </li><li>  9 logical data drives, 152 File Share resources, all data is stored on a disk array; </li><li>  A customized task scheduler, through it, some industry-specific programs were launched. </li></ul><br>  For preliminary preparation and testing of the server, we have created a virtual "laboratory". <br>  We connected three machines to an isolated virtual network: a virtual copy of the active node of the cluster, a virtual copy of the domain controller and a regular machine with Windows 7, on which we will test everything.  In advance, several disks with SQL databases, www / ftp sites, network folders, quorum disk were converted to VMDK. <br><br>  We start the machines, configure network cards with the same TCP / IP parameters as in the real network.  We connect the disks to our server, assign the appropriate letters, reboot.  After this, the cluster should start.  By the way, in the single node mode, the cluster immediately started working, but we no longer need it, all the more there is a risk that such a configuration will not work correctly in a virtual environment. <br><br>  Now you need to save the network card settings and network resource settings, because  after removing the cluster service, they will have to be manually restored.  I previously prepared dump TCP / IP settings using the netsh command.  I planned to create network resources again using the ‚Äúnet share‚Äù command.  Perhaps there is a way to backup network balloon settings, but I did not find it. <br><br>  So, we have a file ip.cfg and shares.txt (list of net share commands).  Make a snapshot in order to roll back in case of failure. <br><br><h4>  <b>We start declustering</b> </h4><br><ol><li>  After starting the virtual copy, the second cluster node will no longer be available.  Remove it with the Evict Node team. <br><br><img src="https://habrastorage.org/files/e18/d0d/af4/e18d0daf48c540fd96b3826954ca8d53.JPG" alt="image"><br><br>  There may be such a message, here without options, click OK. <br><br><img src="https://habrastorage.org/files/80b/b58/56d/80bb5856d458403a95d5a5edad6e490f.JPG" alt="image"><br></li><li>  Next, configure SQL.  We need it to run as usual.  In the instructions found on the Internet, they suggest making copies of databases, deleting a clustered Instance, then installing Standalone Instance.  I found a simpler way through the registry: <br>  Remove branches <br><br>  HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Microsoft SQL Server \ MSSQL.1 \ Cluster <br>  HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Microsoft SQL Server \ MSSQL.2 \ Cluster <br><br><img src="https://habrastorage.org/files/80c/63f/e0a/80c63fe0a5044402b4bdfee28f8bddce.JPG" alt="image"><br><br>  Change keys <br><br>  HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Microsoft SQL Server \ MSSQL.1 \ Setup \ SqlCluster = 0 <br>  HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Microsoft SQL Server \ MSSQL.2 \ Setup \ SqlCluster = 0 <br><br><img src="https://habrastorage.org/files/931/88d/0bd/93188d0bd9c14348b8898565f65c376d.JPG" alt="image"><br><br>  In the SQL Server configuration manager, we set services for autorun. <br><br><img src="https://habrastorage.org/files/76e/53b/c4c/76e53bc4cf124abc9d3ee59dd8b2f189.JPG" alt="image"><br></li><li>  We include services WWW Publishing Service, Task Scheduler for autorun.  Previously, they were started manually only on the active node. <br><br><img src="https://habrastorage.org/files/8ec/567/8b3/8ec5678b30f1448c801bc806fd9614b4.JPG" alt="image"><br><br><img src="https://habrastorage.org/files/a6e/6f2/912/a6e6f29127fb4d818482b0664c0fe892.JPG" alt="image"><br><br></li><li>  Remove the last node from the cluster.  After this, cluster resources such as IP address and File Share are permanently deleted from the system. <br><br><img src="https://habrastorage.org/files/485/034/3bb/4850343bbfee425fad2574dd8adf6ac8.JPG" alt="image"><br><br></li><li>  So that users can then work normally with network folders, we again edit the registry: <br>  In the registry section HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Services \ LanmanServer \ Parameters <br>  add the DWORD parameter "DisableStrictNameChecking", with the value 1 <br><br><img src="https://habrastorage.org/files/04a/858/f1b/04a858f1b077465d9f12983722c4b8bf.JPG" alt="image"><br><br></li><li>  Restoring network settings: <br>  Netsh exec c: \ ip.cfg <br><br></li><li>  Restore network resources from the text file shares.txt.  Just copy the commands and paste into cmd.  I tried to make a bat-nickname, but there was a problem with the display of Russian characters in the resource descriptions. <br><br></li><li>  Reboot the server.  After that, we check the operation of all ftp-, www-, share-resources in our laboratory. <br><br></li></ol><br>  If everything is in order, then the virtual server is ready to move to a regular network. <br><br><h4>  <b>Briefly about the transition</b> </h4><br>  The nuances here may be different, but the principle is the same: you need to disable the iron cluster, transfer resources and settings to the new server and enable it.  In my case, resources are IP addresses, logical data disks, network spheres. <br>  We did not completely remove the iron cluster from the network and AD, so that in case of failure we could return everything. <br><br>  Our actions: <br><br><ol><li>  Disconnect from the network and from the disks iron cluster.  IP addresses are released. </li><li>  The total amount of data is 1.5 TB, so all the disks in the VMDK cannot be transferred at once, the information is constantly updated.  We decided to temporarily connect them to the virtual server as RDM, thereby reducing downtime during the transition.  As experience has shown, it is better to connect them to the machine turned off.  After launch, the same letters should be assigned to these disks as on the old cluster, for example, in our database, the SQL server databases were launched from disk S. </li><li>  We include the virtual server in the general network, we reboot. </li></ol><br><br>  After a reboot, FTP, WWW services, SQL have earned correctly.  All actions took a little less than an hour. <br>  Some time later, there was a glitch with network balls, when some users cannot log in using the old cluster name.  Possible fixes: <br><br><ol><li>  Check the execution of paragraph 5 of the instructions. </li><li>  Delete old entries on the WINS server for the cluster name </li><li>  When deploying an MSCS cluster, in AD, besides the accounts of the first and second nodes, a third account is created with the cluster name: its description is ‚ÄúServer cluster virtual network name account‚Äù.  This account must be disabled. </li><li>  In DNS, an alias was created by the name of the cluster on the first node. </li></ol><br>  Currently, the virtual server is working properly.  No glitches are observed.  Now you can safely celebrate the New Year 2015. Thank you all for your attention. </div><p>Source: <a href="https://habr.com/ru/post/246585/">https://habr.com/ru/post/246585/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../246575/index.html">The first month of the promotion of a free non-game application: rakes, cones, good luck, conclusions</a></li>
<li><a href="../246577/index.html">Do you make these 5 mistakes when connecting clients?</a></li>
<li><a href="../246579/index.html">Robotale: a radio-controlled machine with Arduino and Bluetooth, which will help to learn the basics of working with Arduino and not only</a></li>
<li><a href="../246581/index.html">Disaster tolerance: DR for small businesses, enthusiasts and other geeks using Microsoft Azure</a></li>
<li><a href="../246583/index.html">Approved professional standard manager of IT products</a></li>
<li><a href="../246587/index.html">New technology to build cellular networks</a></li>
<li><a href="../246591/index.html">Fresh baked goods from TestCafe - 14.2 release</a></li>
<li><a href="../246593/index.html">RealSense webinar. For those who have questions</a></li>
<li><a href="../246599/index.html">Results of the year for Android developers</a></li>
<li><a href="../246601/index.html">10 tips to reduce returns to the online store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>