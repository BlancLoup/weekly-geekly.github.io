<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do not be afraid to use HandlerSocket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(example of the protocol HandlerSocket in the picture) 

 Introduction 
 In the previous project, there was a need for unloading the database, then li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do not be afraid to use HandlerSocket</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/877/032/6ee/8770326ee5fd4d0babd6ce070b3e36b8.png"><br>  (example of the protocol HandlerSocket in the picture) <br><br><h2>  Introduction </h2><br>  In the previous project, there was a need for unloading the database, then life and pushed me with the HandlerSocket. <br><br>  HandlerSocket is a protocol implemented in the eponymous plugin for MySQL RDBMS, which allows using the NoSQL method to access data stored in InnoDB tables.  The main reason for using NoSQL solutions is a very fast search by primary key. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">More about HandlerSocket</b> <div class="spoiler_text">  HandlerSocket runs as a daemon inside the mysql process, accepting TCP connections and performing client requests.  It does not support SQL queries; instead, it provides a simple query language for CRUD table operations.  That is why it is much faster than mysqld / libmysql in some cases: <br><br>  HandlerSocket handles data without parsing an SQL query, which leads to a decrease in CPU usage. <br>  It supports batch query execution.  You can send several requests at once and get the result at once, which again reduces the load on the processor and the network. <br>  The HandlerSocket protocol is more compact than mysql / libmysql, which leads to a reduction in network load. <br><br>  More details can be read here: <br><br><ul><li>  <a href="https://github.com/DeNA/HandlerSocket-Plugin-for-MySQL">Official repository</a> ; </li><li> <a href="http://tokarchuk.ru/2010/12/handlersocket-protocol-and-php-handlersocket-extension/"><img src="https://habrastorage.org/storage2/c72/991/4ca/c729914ca9c21661c5abd81052c6a10e.gif"></a>  <a href="http://tokarchuk.ru/2010/12/handlersocket-protocol-and-php-handlersocket-extension/">Introduction to HandlerSocket: protocol description and php-handlersocket extensions</a> ; </li><li> <a href="http://www.slideshare.net/php-user-group-minsk/07-130425052738phpapp01"><img src="https://habrastorage.org/storage2/c72/991/4ca/c729914ca9c21661c5abd81052c6a10e.gif"></a>  <a href="http://www.slideshare.net/php-user-group-minsk/07-130425052738phpapp01">What you wanted to know about HandlerSocket, but could not google</a> ; </li><li> <a href="http://habrahabr.ru/post/113040/"><img src="https://habrastorage.org/storage2/c57/b92/af4/c57b92af4ee0d37f787c211a068b1b95.png"></a>  <a href="http://habrahabr.ru/post/113040/">First experience with Handler Socket &amp; php_handlersocket</a> . </li></ul><br></div></div><br>  Under the cut waiting for you: <br><ul><li>  New library for working with HS, written in PHP; </li><li>  Comparing the performance of existing solutions + new; </li><li>  Symfony2 bundle for working with HS; </li><li>  Munin plugins for monitoring HS activity; </li><li>  Different thoughts out loud and stories about the "cones". </li></ul><br><a name="habracut"></a><br>  Studying the issue of introducing HS into a project, I was quite surprised that under it there was no normal PHP library that would just be easy to use and cover the protocol functionality.  The solutions available at that time were similar to those being developed, but not to any ready-to-use ones. <br><br>  We were not satisfied with ready-made solutions and they didn‚Äôt give me a watch from the project, so that I could take and throw something of my own, so the option of introducing HS was discarded.  The project is long gone, but the idea that HS has a cool thing seized me.  And now more than a year has passed, when I tried again to find solutions and found that nothing had moved from that dead center. <br><br>  The cool guys from Badoo once told me that they were using HS under their hood, but I could not find in the public domain what they use, I suspect that something samopisny. <br><br><h2>  Analysis of ready-made solutions </h2><br>  There were three ready solutions: 1 written in PHP ( <a href="https://github.com/tz-lom/HSPHP">HSPHP</a> ) and 2 extensions to the interpreter, written in C. <br><br>  All 3 had a couple of common problems: <br><br><ul><li>  lack of support for suffixes; </li><li>  lack of authorization support; </li><li>  poor documentation; </li><li>  The level of test coverage is not very high. </li></ul><br>  With such a set of problems, the C extensions were immediately rejected, because there was no desire to understand them and finish on C at all, HSPHP remained. <br><br>  While I was dealing with HSPHP, I managed to make a couple pull requests.  Inside, everything is written through callbacks, which I don‚Äôt really like.  All this together made me abandon this library.  By the way, recently added support for authorization in HSPHP, but it all broke down completely. <br><br><h2>  Why your bike </h2><br>  I needed an easy-to-use tool that out of the box would not require any modifications, was easy to use and clearly kept up to date.  Since I did not find anything like this, and the interest in the protocol has not cooled, time and desire were found by themselves and the body sat down to write code in semi-automatic mode. <br><br><h2>  Meet - HandlerSocketLibrary </h2><br>  Briefly about the results: <br><br><ul><li>  at the moment the library covers 100% of the protocol; </li><li>  distributed under the MIT license; </li><li>  several ways to send a request; </li><li>  select queries can return an associative array (for example, array ('id' =&gt; '1', 'message' =&gt; 'text')), in other libraries it was necessary to have everything with columns on their own or to remember the order of columns when opening an index; <br></li><li>  The HS code was studied, based on which it turned out to create an Exception for each HS protocol error.  Inside the class it is described in a human-understandable language that can lead to the appearance of such an error; <br></li><li>  written script for benchmark libraries ( <a href="https://github.com/KonstantinKuklin/PHPBenchHS">PHPBenchHs</a> ); <br></li><li>  documentation is written in <a href="">Russian</a> and <a href="">English</a> ; <br></li><li>  covered with tests <img src="https://scrutinizer-ci.com/g/KonstantinKuklin/HandlerSocketLibrary/badges/coverage.png?b=master">  ; <br></li><li>  code quality <img src="https://scrutinizer-ci.com/g/KonstantinKuklin/HandlerSocketLibrary/badges/quality-score.png?b=master">  . <br></li></ul><br><br><h2>  Architecture </h2><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/319/598/655/319598655e5d6fe549cb5f866d9be9d4.png"></a> <br>  (Image is clickable) <br><br>  This is a graph of methods called under the hood of the library, drawn using the <a href="https://github.com/phacility/xhprof">XHProf</a> profiler.  It clearly shows that the 2 slowest sections of the code are working with the socket and parsing the answer.  I use a wrapper for working with streams / sockets <a href="https://github.com/KonstantinKuklin/StreamLibrary">SteamLibrary</a> . <br><br>  The idea is simple - create a connection to the socket, send a command, get an answer.  The architecture has the ability to flexibly play with various options for reading data through a socket (fgets, fgetc, fread ...).  I have not tested the speed of work through various wrappers on sockets, but this is all already embedded in the architecture. <br><br><h2>  Query examples </h2><br>  I will not consider all possible requests here, because they are described in the documentation (link to the documentation), I will try to give common examples and tell about the features. <br><br>  There are 2 sockets - reading and writing.  The difference in them all comes down to supported teams.  A reading socket can handle 3 commands: <br><br><ul><li>  authorization command; </li><li>  index opening command; </li><li>  reading information from an open index. </li></ul><br>  To connect to a reading socket: <br><br><pre><code class="php hljs">$reader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \HS\Reader(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-number"><span class="hljs-number">9998</span></span>, <span class="hljs-string"><span class="hljs-string">'passwordRead'</span></span>);</code> </pre> <br><br>  The constructor accepts - host, port and password for authorization (optional).  Authorization command is sent automatically. <br><br>  Open the index: <br><br><pre> <code class="php hljs">$indexId = $reader-&gt;getIndexId( <span class="hljs-string"><span class="hljs-string">'database'</span></span>, <span class="hljs-string"><span class="hljs-string">'tableName'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRIMARY'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'num'</span></span>) );</code> </pre><br>  It is necessary to specify the database, table and key (if the key is empty, then by default the work will continue with the PRIMARY key), then the list of columns (key, text) to be opened, and the additional column for filtering (num).  Filtering is optional, but only these columns will be available for filtering in the future, and the values ‚Äã‚Äãof these columns will not be returned when the server responds. <br><br>  On subsequent calls, the index will not open, it will be used already open. <br><br>  To obtain data through an open index, execute the code: <br><br><pre> <code class="php hljs">$selectQuery = $reader-&gt;selectByIndex($indexId, Comparison::EQUAL, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>));</code> </pre><br>  We take values ‚Äã‚Äãthat are equal to 42, because in the list of columns of this index the sequence goes (key, text), then 42 is assigned to 1 column, namely key, the type of comparison is equality (Comparison :: EQUAL). <br><br>  By default, HS returns just a list of values.  At the output, you can get data in the form of an associative array (values ‚Äã‚Äãare automatically mapped into an array by column name) or a vector. <br><br>  To do this, just add after the request and before sending it the line: <br><br><pre> <code class="php hljs">$selectQuery-&gt;setReturnType(SelectQuery::ASSOC); <span class="hljs-comment"><span class="hljs-comment">//     </span></span></code> </pre><br>  To get the data, you need to send a query and parse the results: <br><br><pre> <code class="php hljs">$resultList = $reader-&gt;getResultList();</code> </pre><br>  The $ resultList variable contains an array of the results of all the commands that were sent for this iteration, but it‚Äôs not quick and inconvenient to clear all the answers, so all answers are automatically mapped to queries. <br><br><pre> <code class="php hljs">$selectResult = $selectQuery-&gt;getResult(); <span class="hljs-comment"><span class="hljs-comment">//   NULL    $reader-&gt;getResultList(); $arrayResultList = $selectResult-&gt;getData(); //    .</span></span></code> </pre><br>  Another way is to open the index and send the command at once: <br><br><pre> <code class="php hljs">$selectQuery = $reader-&gt;select( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>), <span class="hljs-comment"><span class="hljs-comment">//  'database', 'tableName', 'PRIMARY', Comparison::MORE, //  ,     &gt; array('1'), // sql like: key &gt; 1 0, // offset 99, // limit array('num'), //   array(new Filter(Comparison::EQUAL, 0, '3')) //  sql like: num = 3 ); // SELECT key,text from database.tableName WHERE key &gt; 1 and num = 3 LIMIT 0,99; $this-&gt;getReader()-&gt;getResultList();</span></span></code> </pre><br>  First of all, it will be checked whether there is an index that contains the entire list of columns.  If yes, it will be used, and if not, a new index will open with the required number of columns. <br><br>  The third way is through the ‚ÄúBuilder Inquiries‚Äù (QueryBuilder), I think there is no point in commenting here: <br><br><pre> <code class="php hljs">$selectQueryBuilder = \HS\QueryBuilder::select(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'key'</span></span>, <span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'varchar'</span></span>, <span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'set'</span></span>, <span class="hljs-string"><span class="hljs-string">'union'</span></span>)) -&gt;fromDataBase(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDatabase()) -&gt;fromTable(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getTableName()) -&gt;where(Comparison::MORE, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'key'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>)) -&gt;andWhere(<span class="hljs-string"><span class="hljs-string">'float'</span></span>, Comparison::EQUAL, <span class="hljs-number"><span class="hljs-number">3</span></span>); $selectQuery = $reader-&gt;addQueryBuilder($selectQueryBuilder); $reader-&gt;getResultList(); $selectQuery-&gt;getResult()-&gt;getData();</code> </pre><br>  These are all commands that can work through a reading socket.  All others will fall out with ReadOnlyError. <br><br>  The writing socket handles these 3 commands and 5 more: <br><br><ul><li>  insert </li><li>  delete </li><li>  update </li><li>  increment </li><li>  decrement </li></ul><br>  Examples of how to work with these commands are in <a href="">the HandlerSocketLibrary docks</a> .  I generally consider the first 3 to be intuitive and it will be enough just to see examples, so I‚Äôm missing them. <br><br>  But increment and decrement are commands that increase or decrease values ‚Äã‚Äãin the database.  You need to know that in the case when the value in the process of the operation should change from negative to positive or vice versa, such an operation will not pass and the value will not change.  That is, the value -1 will never become 0 using the increment command.  This is a feature of the HS plugin itself. <br><br>  If in modifying commands you set the flag $ suffix = true, then the answer will be SelectResult with values ‚Äã‚Äãthat meet your criteria for modification BEFORE the modification process.  That is, if you update 2 columns and specify suffix = true, then the values ‚Äã‚Äãof these columns will return to you before the update, and not after. <br><br>  If the limit and offset are not specified, then by default they are 1 and 0, respectively. <br><br>  It is important not to forget such a feature of incremental \ decrement queries: the value of the limit is multiplied with the value by which you need to increase or decrease the record. <br><br><h2>  Performance comparison with analogues </h2><br>  On the graphs, the comparison took place according to the speed of processing requests and the RAM consumed for it.  A total of 1000 requests were executed. <br><br>  The measurements were made on a synthetic database running Mac Os X, i5 + 4Gb Ram.  Absolute values ‚Äã‚Äãwere not critical for me, I needed a percentage ratio, but you can do the same on your hardware.  To do this, you can use my test scripts laid out on <a href="https://github.com/KonstantinKuklin/PHPBenchHS">github</a> . <br><br>  With Insert, I ‚Äúcheated‚Äù and simply inserted the entire 1000 elements with the 1st request. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a1/157/e4a/1a1157e4af6ede43ca2e4e2301b158e2.png"><br>  More is better. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cbe/622/af7/cbe622af7a894a9239a30a65f920146f.png"><br>  Less is better. <br><br>  It is necessary to give HSPHP, I thought that it would be stronger to lose in speed and consumed memory to SISH extensions, but it turned out in practice that it was quite a bit.  But such a huge gap in performance just caught me in a blunder, I was expecting a maximum 30-50% lag. <br><br>  It was necessary to correct, it was necessary to look for what the trouble was.  First of all, I pulled XHProf out from under the table and wrote down the result for 1000 Select queries: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/b36/257/daa/b36257daaa29135184e55401aa25b93c.png"></a> <br>  The first problem is working through an array. <br><br>  When designing, the array was selected for internal communication.  I, of course, understood that I would lose in productivity, but in order to ... <br><br>  A heavily stripped <a href="https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/ParameterBag.php">ParameterBag</a> class from HttpFoundation components was used to work with the array.  The point is that if there are values ‚Äã‚Äãin the array with the key N, then we return them, if not - defaultValue, which you can specify for yourself for any value. <br><br>  On the graph above, it is just clear that working through ParameterBag takes with it an inadmissible amount of processor time. <br><br>  The nagging is to check whether something is there or not, there are 2 most obvious ways: <a href="http://php.net/manual/ru/function.isset.php">isset</a> and <a href="http://php.net/manual/ru/function.array-key-exists.php">array_key_exists</a> . <br>  Isset does not handle null correctly, so if you use it, you need to remove all possible moments from the architecture when null or an empty string comes to the array, since the element will not be located through the isset.  In array_key_exists, everything is fine with this, that's why I chose it initially.  But thanks to the profiler, the discovery was unexpected and by googling the problem of speed found that array_key_exists loses at about 10!  times isset'y  The most obvious solution was a temporary crutch - change the condition of checking the value in the array - add isset before the array_key_exists.  It turned out this check: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($array[$key]) || array_key_exists($array, $key)) { <span class="hljs-comment"><span class="hljs-comment">// ~(0.0)~ }</span></span></code> </pre><br>  Just adding an isset check before array_key_exists has increased the performance of the entire library by <b>4%</b> !  It was cool, but 4% is not a cool enough result as a whole, so I had to completely get rid of ParameterBag, rewriting everything for specific values ‚Äã‚Äãin the queries. <br><br>  The result was expected: <br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c5a/08b/86f/c5a08b86fdb774a9eb3bc6bf80bc538f.png"></a> <br>  The dropped array reduced the execution time for Select requests by 44%, and the memory consumed by 45%. <br><br>  I can not say that the speed of work is excellent now, I am still not happy with it.  Next you have to get rid of unnecessary abstractions and internal optimizations for each specific request.  This work is still to be done, but the backlog is reduced to 2.5-3 times, instead of 5. <br><br><h2>  Error list </h2><br>  Another nice thing that appeared due to the large number of questions on the network about decoding HS errors.  HS source codes were studied and all possible types of errors were written out, since it was written in plain language and there are not so many source codes.  Below is a list of what errors can be returned when working with HS using HandlerSocketLibrary and what they mean.  I would not lay out this list in the article, if it were not for a shortage of information on this topic in the network. <br><br><div class="spoiler">  <b class="spoiler_title">error list</b> <div class="spoiler_text"><ul><li>  <b>AuthenticationError</b> - the server requires authorization and you have not passed; </li><li>  <b>ComparisonOperatorError</b> - an invalid comparison operator was passed (only 4&gt; =, &lt;=, &lt;,&gt; is available); <br></li><li>  <b>InListSizeError</b> - the search mode by the list of values ‚Äã‚Äãis selected and the number of these values ‚Äã‚Äãis specified incorrectly; <br></li><li>  <b>KeyIndexError</b> - the specified column number exceeds the total number of columns in the open index; </li><li>  <b>ModifyOperatorError</b> - an invalid modifying operator was passed. (+, -, D, U, +?, -?, D?, U?); </li><li>  <b>UnknownError</b> - super prize - aaaaaavtomobil!  If you won a car - create this issue; <br></li><li>  <b>ColumnParseError</b> - invalid column values ‚Äã‚Äãpassed; </li><li>  <b>FilterColumnError</b> - you are trying to open a column with a number greater than the number of open columns to filter; <br></li><li>  <b>IndexOverFlowError</b> - you are trying to use a non-initialized index number; </li><li>  <b>KeyLengthError</b> - the length of the list of keys is either greater than the list, or &lt;1; </li><li>  <b>OpenTableError</b> - trying to open a nonexistent table, or a nonexistent index; </li><li>  <b>CommandError</b> - you sent an invalid command; </li><li>  <b>FilterTypeError</b> - passed the wrong type of filtering. (F, W); </li><li>  <b>InternalMysqlError</b> - MySQL could not execute the command (for example, insert an already existing value); <br></li><li>  <b>LockTableError</b> - you are trying to open a locked table; </li><li>  <b>ReadOnlyError</b> - the modifying command was sent to the reading socket. </li></ul><br><br>  Here in this <a href="https://github.com/KonstantinKuklin/HandlerSocketLibrary/blob/master/src/HS/Result/ResultAbstract.php">php file you</a> can see the error parsing logic. <br></div></div><br><br><h2>  Plans </h2><br>  First of all, you need to add all possible use cases and cover them with tests.  As a result of the struggle for the speed of query execution, rudiments appeared in the code that need to be refactored.  Not all requests have a full list of features, that is, some requests may have missed the opportunity to use filters or lists of keys (yes, the code is still slightly damp).  In already existing tests, an easy mess, because at the beginning I wrote neatly, in the end it was already just to cover the case.  Tests for database modification do not check the state of the entire table after the modifying query. <br><br>  It is necessary to add the ability to return values ‚Äã‚Äãin the form of an object on Select queries.  HS supports CRUD - so you can add a wrapper to the ORM, for example, to the same Doctrine. <br><br><h2>  Why so little information about HS and a small community? </h2><br>  I want to clarify right away: HS is a great thing that can and should be used, it‚Äôs just that not everyone can do it due to the peculiarities of the protocol and its limitations. <br><br>  So why isn‚Äôt the community growing and why is it so hard to start working with real projects in HS? <br><br>  I am sure that there were other developers in my place, when between the idea of ‚Äã‚Äãintroducing HS and the actual implementation of HS, tasks emerge to finish the infrastructure associated with HS, which is completely unrelated to the business objectives of the project.  The result is a choice: either your manager \ those director \ someone else pays for this work and generally gives you good for it, or you do it yourself after hours, and afterwards you raise the question that everything is ready and can be implemented only profit, or you score on HS, which is most often the case, apparently. <br><br>  Naturally, the fact that HS does not have access control on databases;  this sharply limits the scope of application, all hosting with the number of clients&gt; 1 disappear. <br><br>  I tried to slightly contribute to solving this problem. <br><br><h2>  Monitoring </h2><br>  We decided, therefore, to use HS on the project, but how to measure the load passing through it?  HS has the ability to configure the number of workers, here are their status and download will be monitored using <a href="http://munin-monitoring.org/">Munin</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/724/5e2/a6c/7245e2a6c845e1852371653ddb45fbef.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/695/511/b1b/695511b1ba2e7d7f8d629db9fa8e1d81.png"><br><br>  Plugins connect to MySQL and parse the output of the show processlist command.  Available for download <a href="https://github.com/munin-monitoring/contrib/tree/master/plugins/mysql">from here</a> .  This data should be enough to assess how loaded all the peaks are. <br><br><h2>  Symfony2 bundle </h2><br>  If your project uses the 2nd version of the <a href="http://symfony.com/">symfony</a> framework, then you have the option of messing with HS out of the box.  You only need to add a new dependency to composer.json: ‚Äúkonstantin-kuklin / handlersocket-bundle‚Äù: ‚Äúdev-master‚Äù. <br><br>  Setup: <br><br>  Add configs for the socket for reading and writing: <br><br><pre> <code class="php hljs">hs: reader: host: localhost port: <span class="hljs-number"><span class="hljs-number">9998</span></span> debug: <span class="hljs-string"><span class="hljs-string">"%kernel.debug%"</span></span> auth_key: <span class="hljs-string"><span class="hljs-string">"Password_Read1"</span></span> writer: host: localhost port: <span class="hljs-number"><span class="hljs-number">9999</span></span> debug: <span class="hljs-string"><span class="hljs-string">"%kernel.debug%"</span></span></code> </pre><br>  The auth_key parameter is optional and its absence means that there is no need for authorization (your CO).  The debug flag changes the operating mode of the HS library under the hood, requests are sent individually and the processing time for each request is recorded, and the operative charge for additional storage of requests is also increased.&gt; <br><br>  Then everything is simple - we work with 2 services: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \HS\Reader $reader */</span></span> $reader = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;get(<span class="hljs-string"><span class="hljs-string">"hs_reader"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> \HS\Writer $writer */</span></span> $writer = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;get(<span class="hljs-string"><span class="hljs-string">"hs_writer"</span></span>);</code> </pre><br><br>  There are ‚ÄúNishtyak‚Äù for debag: <br>  In dev mode, go to the site and see a new icon on the line of the web-profiler: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5d/22e/1d7/d5d22e1d7a17ba06bb872045b3476a10.jpg"><br><br>  A very simplified statistics is collected: how many requests and how much time it took to complete them (full time - sending, receiving, parsing).  When you click on this new button, we will see more detailed information about the requests: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b81/8f0/72e/b818f072e71086cdb1c4186b36c6d92e.jpg"><br><br>  Above the information where the requests and information about the requests were sent, if you click on Display Data, then we get the data of the query result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cc6/fe8/d64/cc6fe8d6439e9f27401d35f1f584300e.jpg"><br><br>  In fact, here my fantasy has dried up, at this moment I got to know the protocol quite well and therefore it was hard to invent cases to display such information.  I would be glad to get your ideas on what information would still be useful for debugging. <br><br>  Of the minuses - the bundle is not tested at all. <br><br>  I plan to make 1 entry point in HS with the indication of the Database, that is, in the queries you will not have to transfer the database. <br><br><h2>  Conclusion </h2><br>  All this can theoretically be used in production, but I need help with testing and I hope this article will gather people who have experience with people using HS. <br><br>  Constructive criticism, pull requests, suggestions, found bugs are welcome. <br><br>  Now it's easy to start using HS; <a href="http://www.percona.com/doc/percona-server/5.5/performance/handlersocket.html">PerconaServer</a> and <a href="https://mariadb.com/kb/en/mariadb/documentation/nosql/handlersocket/handlersocket-installation/">MariaDB</a> have this plugin in their builds.  Act! <br><br>  Thanks for attention! <br><br>  PS On Saturday, the news flew by that the <a href="https://vk.com/badoocom%3Fw%3Dwall-38989008_290">Badoo code will be posted</a> . </div><p>Source: <a href="https://habr.com/ru/post/239637/">https://habr.com/ru/post/239637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../239625/index.html">200 microcomputers in 3 hours, or small-scale production of microelectronics in Shenzhen (on the example of the VoCore project)</a></li>
<li><a href="../239627/index.html">Algorithmic trading on the stock market in Russia: trends and technologies</a></li>
<li><a href="../239629/index.html">Check Network Security Services Library</a></li>
<li><a href="../239633/index.html">We use MongoDB in a cloud backend of mobile applications</a></li>
<li><a href="../239635/index.html">Creating OS X Applications with JavaScript</a></li>
<li><a href="../239639/index.html">Exoskeletons in medicine</a></li>
<li><a href="../239641/index.html">Instructions for obtaining a radio call sign and certificate of registration of RES</a></li>
<li><a href="../239643/index.html">Alternative outcome of creating a strong AI</a></li>
<li><a href="../239645/index.html">Cloud Autotest Selenium + Ubuntu (step by step instructions)</a></li>
<li><a href="../239647/index.html">How I created the application, but was forced to close due to the law</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>