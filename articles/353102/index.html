<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Effective use of AWS spot instances</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spot instances are essentially the sale of currently free resources with a great discount. In this case, the instance can at any time turn it off and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Effective use of AWS spot instances</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/900/b5f/c66/900b5fc6647f7833a3de5e37faabe506.png" alt="image"><br><p>  Spot instances are essentially the sale of currently free resources with a great discount.  In this case, the instance can at any time turn it off and take it back.  In the article I will talk about the features and practices of working with this proposal from AWS. </p><a name="habracut"></a><br><p>  The cost of using a spot instance may vary from time to time.  At the time of the order you place a bid (bid) - specify the maximum price you are willing to pay for use.  It is the balance of rates and free resources that forms the final cost, which at the same time differs in different regions and even in the availability zones of the region. </p><br><img src="https://habrastorage.org/getpro/habr/post_images/6bf/01e/50b/6bf01e50bab4dabceb391da85b10aa50.png" alt="image"><br><p>  At some point, the weighted price may exceed the price of a regular on-demand instance.  That is why you should not make excess bets - you can really sell an instance for $ 1000 per hour.  You do not know what bet to make - specify the price of the on-demand instance (namely, it is used by default). </p><br><h3>  The life cycle of the spot instance <br></h3><br><p>  So, we form a request, and AWS allocates us instances.  As soon as Amazon needed the issued instances or the price exceeded the limit we specified, the request closes.  This means that our instances will be terminated / hibernated. </p><br><p>  Also, the request may be closed due to an error in the request.  And here you have to be careful.  For example, you created a request and received instances.  And then they removed the associated IAM role.  Your request will close with the status ‚Äúerror‚Äù.  The instances will be stopped. </p><br><p>  And of course, you can cancel the request at any time, which will also stop the instances. </p><br><p>  The request itself may be: </p><br><ul><li>  One-time - as soon as the instances are taken from us, the request closes </li><li>  Permanent - instansy return to us after re-inclusion. </li><li>  With guaranteed service for 1-6 hours. </li></ul><br><p>  As a result, we have two main tasks for the service with the desired 100% uptime: </p><br><ul><li>  Form optimal spot-requests </li><li>  Handle instance disconnection events </li></ul><br><h3>  Facilities <br></h3><br><p>  One of the most powerful tools for working with spot queries is spot fleet.  It allows you to dynamically form requests in such a way as to satisfy the specified conditions.  For example, if instances went up in one AvailabilityZone, then you can quickly run the same in another.  Also, there is such a wonderful factor as the ‚Äúweight‚Äù of the instance.  For example, to perform the task we need 100 single core nodes.  Or 50 dual core.  And this means, on the example of T2-type instances, that we can use 100 small or 50 large or 25 xlarge.  It is the optimal distribution and redistribution that minimizes both the cost and the likelihood that the request will be unmet.  Now, however, there is a possibility that in all AvailabilityZones there will not be the necessary number of instances with our parameters. </p><br><p>  Fortunately, AWS leaves us <strong>2 minutes</strong> between making the decision to stop and shutting down.  It is at this point that the shutdown timer starts to return via the link: </p><br><pre><code class="bash hljs">http://169.254.169.254/latest/meta-data/spot/termination-time</code> </pre> <br><p>  Something like this would look like the simplest handler that we can run as a daemon: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash while true do if [ -z $(curl -Is http://169.254.169.254/latest/meta-data/spot/termination-time | head -1 | grep 404 | cut -d \ -f 2) ] then echo ‚ÄúInstane is going to be terminated soon‚Äù # Execute pre-shutdown stuff break else # Spot instance is fine. sleep 5 fi done</span></span></code> </pre> <br><p>  Let's complicate the task a bit - our instances are connected to the Elastic Load Balancer (ELB).  You can use the demon from the snippet above and report the status to the balancer via the API.  But there is a more elegant way - the <a href="https://github.com/opszero/seespot">project <strong>SeeSpot</strong></a> .  In short, the daemon looks at the same time in / spot / termination-time and, optionally, in the healthcheck url of your service.  As soon as AWS is about to withdraw an instance, it is marked as OutOfService in ELB and can optionally perform the final CleanUP task. </p><br><p>  So, we figured out how to properly handle the trip.  It remains only to learn how to maintain the required performance of the system, if we suddenly decide to take instances.  Here <a href="https://github.com/cristim/autospotting">the <strong>autospotting</strong> project</a> will help us.  The idea is as follows: we create a regular autoscaling group containing on-demand instances.  The autospotting script finds these instances and, one by one, replaces them with fully relevant spot instances (the search is done by tag).  Autoscaling groups have their own Healthcheck.  As soon as one of its members fails the test, the group tries to recover its volume and creates a ‚Äúhealthy‚Äù instance of the original type (and this was on-demand).  In this way, we can wait out, for example, price races.  Once the spot-requests are satisfied again, autospotting will begin a gradual replacement.  From myself I will add that the project is done fairly well, and has, among other things, approaches for configuration using terraform or cloudformation. </p><br><p>  In conclusion I would like to recommend, if possible, to use spot instances for stateless services.  Or use S3 / EFS.  For ECS configurations, you need to think about re-balancing tasks. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/353102/">https://habr.com/ru/post/353102/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353088/index.html">We write the plugin for Unity correctly. Part 1: iOS</a></li>
<li><a href="../353090/index.html">IT asset management: how myths affect projects (Part 2)</a></li>
<li><a href="../353092/index.html">Digital events in Moscow from April 9 to 15</a></li>
<li><a href="../353094/index.html">ECO Flow in Vivado or working in netlist editing mode</a></li>
<li><a href="../353100/index.html">Explicit Proxy with authorization by AD Group + Interception Proxy with authorization by MAC</a></li>
<li><a href="../353104/index.html">Procedural maze generation in Unity</a></li>
<li><a href="../353108/index.html">Is it possible to enter the closed door, or how patches vulnerabilities</a></li>
<li><a href="../353110/index.html">Mitap Cocoaheads in Tutu.ru office</a></li>
<li><a href="../353112/index.html">Security violations of mobile applications as a result of insufficient attention of the developers</a></li>
<li><a href="../353114/index.html">Kubernetes 1.10: a review of major innovations</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>