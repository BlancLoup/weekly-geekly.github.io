<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Common mistakes when working with PostgreSQL. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to publish videos and transcripts of the best reports from the PGConf.Russia 2019 conference. The first part of the report by Ivan Frolkov...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Common mistakes when working with PostgreSQL. Part 2</h1><div class="post__text post__text-html js-mediator-article"> We continue to publish videos and transcripts of the best reports from the <a href="https://pgconf.ru/2019/talks-and-tutorials"><b>PGConf.Russia 2019</b></a> conference.  <a href="https://habr.com/ru/company/postgrespro/blog/442462/">The first part of the</a> report by <b>Ivan Frolkov</b> was about inconsistent naming, about constraints, about where it is better to concentrate the logic - in the database or in the application.  In this part, you will find analysis of error handling, concurrent access, non-cancellable operations, CTE and JSON. <br><br><img src="https://habrastorage.org/webt/f7/ro/mc/f7romcfk7jnjqrlwyalubebwxbo.jpeg"><br><br>  I will tell this story.  Our client says: ‚ÄúThe base is working slowly, and our application deals with serving the population.  We are afraid that we will be raised on the pitchfork here. ‚Äù  It turned out that they had a lot of processes in <b>idle in transaction</b> state.  The application has started a transaction, does nothing, but the transaction does not complete.  If you interact with some external services, then, in principle, this is a normal situation.  Another thing is that if your <b>idle in transaction</b> state lasts a long time (more than a minute is already suspicious), then this is bad because PostgreSQL doesn‚Äôt like long transactions: VACUUM will not be able to clean all the lines that it could see and hang for a long time transaction effectively blocks VACUUM.  Tables begin to swell, indexes are becoming less and less effective. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/mf/ml/t8/mfmlt8ovoywmqjplbggaszfvj-q.jpeg"><a name="habracut"></a><br><br>  In this case, people did not quite correctly write requests and receive Cartesian works ‚Äî such requests were executed for several days.  Well, the user, he will press the button, wait for the result and, if there is no result, press the button again. <br><br>  But this did not explain why they have so many processes in <b>idle in transaction</b> .  And they appeared in what situation: the application climbs into the database, starts a transaction, climbs on some external service, gets an error there, and then everything just crumbles, we print the <b>trace trace</b> in the log, and we calm down on that.  The connection remains abandoned, hangs and interferes. <br><br>  What to do with it?  First, you need to handle errors always.  If an error has arrived, please do not ignore it.  It's good if PostgreSQL has lost the connection: it will roll back the transaction, we will survive.  On this I will stop.  Well, if there is a code that doesn‚Äôt have time to edit at all, then we still have <b>max idle in transaction</b> - it can be delivered, and it will just knock out inactive transactions. <br><br><img src="https://habrastorage.org/webt/jf/nn/gj/jfnngjpf_bkmogvxhjzxigrwlli.jpeg"><br><br>  A typical case of "processing" errors: EXCEPTION WHEN OTHERS THAN NULL.  We once argued with a colleague about terminology.  I said that it translates as "burn it all with a blue flame", and he - "damn it all with a shit."  If something bad happened, even if everything fell into the log with curses, it is still better than complete silence - like here. <br><br><img src="https://habrastorage.org/webt/wt/ya/u0/wtyau0lfirp6ftxlbxw7lpkrqpa.jpeg"><br><br>  If you do not know what to do with an error, then do not intercept it.  A very common practice: they caught the error, logged it and ran on, as if nothing had happened.  If you, again, engage in cash transactions, and you have an error that you ignored, the results can be unpredictable.  In the 90s they could have been transported to the forest, for example, in the trunk.  Now times have become softer, but also a little pleasant. <br><br><img src="https://habrastorage.org/webt/yh/p0/zv/yhp0zvuubrxfxgdqoqxy6xoai0a.jpeg"><br><br>  If we perform an operation on the client, then, usually, we return the value: everything went well or unsuccessfully.  And we handle every mistake.  I saw how people specifically wrote the <b>plpgsql</b> code, where they intercepted the error, wrote to the log that, they say, yes, there was a mistake and rather gross, they inserted their message text.  But SQLSTATE did not return.  This is always done, so if they forgot to check something, then they started having problems. <br><br>  All, for some reason, are afraid of exceptions - both in <b>plpgsql</b> , and in other languages.  And if you do not invent something of your own, and use the standard features of the language, everything usually turns out well.  Especially this problem often occurs when the connection drops.  It fell, the <b>idle in transaction</b> process, the base is filled, the performance drops.  By the way, such a transaction may still leave locks, but this, for some reason, is not as common.  Therefore, add the <b>finally</b> error handling code and clean the connection there, give it back to the server. <br><br><img src="https://habrastorage.org/webt/z-/9-/dx/z-9-dxwfwub-ayln3xckyuzd9xy.jpeg"><br><br>  Moreover, if you have well, the constraints are correctly named, you can already, when handling an error, throw an exception not from the database, but from the application.  In <b>spring</b> there is an <b>exception translation</b> , <b>in php</b> , respectively, <b>set_exception_handler</b> .  Pay attention to the tools that your framework provides to you, they appeared there for a reason. <br><br>  So: do not intercept an error with which you do not know what to do;  call errors carefully and accurately;  classify errors. <br><br><img src="https://habrastorage.org/webt/ly/ow/iu/lyowiutps2aojvxrwr0mu-tuopg.jpeg"><br><br>  Personally, I classify according to such criteria: the operation can be repeated (for example, we have a deadlock);  the operation cannot be repeated, it has already been completed;  the operation cannot be performed in principle. <br><br>  Paradoxically, from the point of view of the application, the situation when a deadlock occurs, when the connection is lost and when we run out of money to pay, these situations are the same: the error handler will try again after some time to perform the operation. <br><br><img src="https://habrastorage.org/webt/i4/8v/tt/i48vttsmqdtuxbu3am8jtpa2swm.jpeg"><br><br>  On the other hand, what is written in the application is, in general, not my business: I work on the base.  I only urge you to handle errors carefully, otherwise: idle in transaction, locked lines, puffing bases, and so on. <br><br>  Most developers believe that they work with the base alone, and their application performs operations strictly consistently.  And this is a plus for all relational DBMSs because, oddly enough, everything works, as a rule, very well, even with the standard isolation level of READ COMMITTED, and not SERIALIZABLE.  At the same time, there are situations when updates are lost: one loads the form, another loads the same form, one wrote and saved, the other saved the old one - the changes were erased.  The first one came to curse: ‚Äúhow is it that I have written so much, and all is lost.‚Äù <br><br><img src="https://habrastorage.org/webt/e_/ct/vz/e_ctvzfp_f1uqnunhhqllgds3cg.jpeg"><br><br>  From my experience: once a week on Fridays, two managers made payments.  They have to <br>  were changed every other time, but, nevertheless, they once climbed at the same time and made two payments per person.  If you have at least some possibility of a competitive access error, it will happen sooner or later.  The question is when. <br><br>  In addition, I draw your attention to the restrictions.  I have repeatedly seen how uniqueness they tried to provide with triggers.  Immediately triggers uniqueness in the table you do not provide.  Either then you will need to block the entire table, or do some more complex gestures.  You sooner or later stumble on this. <br><br><img src="https://habrastorage.org/webt/ih/wo/ql/ihwoqlt5ysrheu4x4hqv5-pk1by.jpeg"><br><br>  A couple of times I ran across a completely horrible thing: an external web service is being called from the database.  There were some operations that change external entities.  This is bad because the transaction can be rolled back in the database, but operations on the remote service will not be rolled out. <br><br>  Even more subtle moment - deadlock-and.  Let's imagine: we process a transaction, call an external web service, change something, then we have a deadlock, and we roll back, then we try to perform the operation again, call again, with good circumstances, deadlock again occurs roll back - so can <br>  happen many times (I ran across a couple of hundred repetitions).  And here you are processing these deadlock-and more or less correctly, repeat the operation and suddenly find out that within two months you are paying someone double the amount. <br><br><img src="https://habrastorage.org/webt/sp/lj/-v/splj-vecns-wphpahy3oqig9wuw.jpeg"><br><br>  I met with payment services that had a poor API: ‚Äúpay such a sum to such a user‚Äù;  the function returns the result - paid / not paid.  First, there is a problem in the case of repetition, and secondly, it is not clear what to do if the connection is interrupted.  For some reason, very few people bother about this topic either. <br><br><img src="https://habrastorage.org/webt/z7/wt/pu/z7wtpuektoi3jxhedlabwntji-a.jpeg"><br><br>  In the slide example: such an operation should be performed in two stages: as if a warning - ‚Äúwe will do something now‚Äù;  the operation itself. <br><br><img src="https://habrastorage.org/webt/gl/49/jl/gl49jl1nror_ototnhr13hwpt8q.jpeg"><br><br>  If we suddenly stop - you never know, turn off the power - we can re-perform the operation.  If we are dead in the second stage, then at least in the world, the second time we will not do it, and it can be disassembled manually.  In fact, the overwhelming majority of such operations normally work out for the first time, but these measures are not theoretical speculations.  Everything can work normally for months, and suddenly the admin begins to be wise with the network, the service starts to blink actively and problems start. <br><br><img src="https://habrastorage.org/webt/sd/rd/ii/sdrdiiksbqdpczcux786fux_wik.jpeg"><br>  On the slide 4 types of non-cancellable operations.  The latter is nonidempotent operations.  This is a very sad case.  At the beginning I spoke about a comrade who did everything on triggers precisely to ensure the idempotency of his operations. <br><br><img src="https://habrastorage.org/webt/1z/1k/i4/1z1ki4ljohxetbual3kekohv_uu.jpeg"><br>  At the conference, people will talk about Common Table Expressions, how it‚Äôs good.  Unfortunately, CTEs in PostgreSQL are not free: they require work_mem for themselves.  If you have a small sample, then, in general, do not worry.  And if suddenly you have it big, then you start having problems.  People very often use CTE as a sort of mini-view, so that you can somehow structure the application.  CTE is very popular. <br><br><img src="https://habrastorage.org/webt/gx/tp/m8/gxtpm8kn0aplloqxdenlq2_hm8m.jpeg"><br><br><img src="https://habrastorage.org/webt/wq/eo/bp/wqeobptq8vshxvzc0fhvryxqf00.jpeg"><br><br>  You can make a temporary view, but, unfortunately, each takes a line in pg_class, and if it is very actively used, then there may be problems with the swelling of the catalog. <br>  In this case, it is advisable to make a parameterized view, or dynamically form a query, but unfortunately, inside PostgreSQL, this is not very cool from the inside. <br><br><img src="https://habrastorage.org/webt/8s/1s/eg/8s1seg0zjkz85dhp_gdf56p4u1q.jpeg"><br><br>  About JSON is usually told in excellent tones, but there is a tendency in the application in JSON to push anything at all.  In principle, everything works well.  On the other hand, from JSON, data gets, though quickly, but not as quickly as from columns.  Even worse, if you have a big JSON, and it was brought to TOAST.  To get JSON from there, you need to raise it from TOAST. <br><br>  If all the columns are in JSON, and even a functional index is built on them, you still need to get it from there.  Even worse is obtained with a large volume, when the base is large, when you have a <b>bitmap index scan</b> .  Then we have links not to lines, but to a whole page, and, in order to understand what to take from the page, PostgreSQL will make <b>Recheck</b> , that is, it raises the line from TOAST and checks whether this value is there or not, and accordingly skips or does not skip.  If it works fine with small columns, this is a big problem with JSON.  It is not necessary to get involved in JSON too much. <br><br><img src="https://habrastorage.org/webt/i1/sx/et/i1sxeth5byhikfdkucqwy8uswk4.jpeg"><br><br>  <i>- How to check when several users work with a string?</i>  <i>What options are there?</i> <br><br>  - First, you can read the values ‚Äã‚Äãof all columns before displaying the line in the form and make sure that they have not changed.  The second option, more convenient: calculate the hash at all <br>  columns, especially since the columns there can be large and thick.  And the hash is not so big. <br><br>  <i>- You say that constraints should be called good names so that the user can understand what is happening.</i>  <i>But there is a limit of 60 characters in the name constraint.</i>  <i>This is often not enough.</i>  <i>How to deal with it?</i> <br><br>  - I think to fight self-restraint.  In PostgreSQL, this is a special type with a length of 64. In principle, you can recompile to a great length, but this is not very good. <br><br>  <i>- In the report, you are intrigued by the fact that we need to do something with the archives.</i>  <i>What is the most accurate mechanism for placing obsolete data in the archive?</i> <br><br>  - As I said at the very beginning, with due diligence everything works.  Which way is more convenient for you, so use it. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/sdVfBkoz_Fc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <b>Timing: Part 2 of the report starts at 25:16</b> <br><br>  <i>- There is a certain procedure that is called in parallel by several users.</i>  <i>How to limit the parallel execution of this procedure, that is, to build all</i> <i><br></i>  <i>users in a queue so that until one finishes the procedure, the next one can not start using it?</i> <br><br>  - That is the procedure?  Or enough transaction? <br><br>  <i>- It is the procedure that is called in some transaction.</i> <br><br>  - You can put a lock on an object.  There would be difficulties if you had a condition, say, no more than 3 at a time.  But it is also realizable.  I usually use transactional locks, but I can also use extra-transactional locks. <br><br>  <i>- I would still like to return to the archive data.</i>  <i>You talked about</i> <i><br></i>  <i>archive storage options so that data is also available from the application.</i>  <i>It occurred to me to simply make a separate archive database.</i>  <i>What other options are there?</i> <br><br>  - Yes, you can make an archive database.  You can write a function and wrap it in a view.  In the function, you can create everything that comes to your head: you can go to the archive database, you can pick up some files from the disk, you can go to an external web service, you can combine all this, you can generate some random data yourself - choice limited only by fantasy. <br><br>  <i>- To the question about the archival data: you can use partitions - new chips of the 11th version, when we make the whole table partized, and then just detail the partition and leave it as an archive.</i>  <i>It can also be accessed.</i> <br><br>  - Of course, why not.  I give the place to the next speaker. </div><p>Source: <a href="https://habr.com/ru/post/443792/">https://habr.com/ru/post/443792/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443770/index.html">Domain Driven Design: Value Objects and Entity Framework Core in practice</a></li>
<li><a href="../443772/index.html">Antiquities: IBM ThinkPad T40, the first wireless</a></li>
<li><a href="../443776/index.html">China introduces experimental face recognition system when paying for subway fares</a></li>
<li><a href="../443782/index.html">Developers can now use Valve's Network API for their games on Steam</a></li>
<li><a href="../443790/index.html">Survivor error</a></li>
<li><a href="../443794/index.html">The main directions for IT startups in real estate sales</a></li>
<li><a href="../443800/index.html">Smart speakers with "Alice" on a low start</a></li>
<li><a href="../443804/index.html">C # is a low level language?</a></li>
<li><a href="../443806/index.html">All Boeing 737 MAX flights are discontinued until aircraft software updates.</a></li>
<li><a href="../443808/index.html">Analytics of girls with low social responsibility (Power BI, Qlik Sense, Tableau)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>