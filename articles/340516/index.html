<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search memory leaks in applications on .NET Core under Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=".NET Core is becoming more and more mature platform. It is already quite comfortable to develop it using the same Rider or VS Code. 


 However, every...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search memory leaks in applications on .NET Core under Linux</h1><div class="post__text post__text-html js-mediator-article"><p>  .NET Core is becoming more and more mature platform.  It is already quite comfortable to develop it using the same Rider or VS Code. </p><br><p>  However, everything is not smooth there.  For example, debugging code on .NET Core 2 worked only in Rider 2017.2, which was released just a few days ago (there were more EAP builds).  Had to use VS Code.  Debugging works in it, however, in order for the tests to start running, you need to manually install the beta version of the <a href="https://github.com/OmniSharp/omnisharp-vscode">extension for C #</a> . </p><br><p>  I think the essence is clear that the instrumental support is still far from similar when developing under Windows. </p><br><p>  For some things, there are no ready-made tools yet.  For example, for profiling. </p><br><p>  From the sources that are available on the web, the most informative, in my opinion, are currently the articles of Sasha Goldstein: </p><br><ul><li>  <a href="http://blogs.microsoft.co.il/sasha/2017/02/26/analyzing-a-net-core-core-dump-on-linux/">Analyzing a .NET Core Core Dump on Linux</a> </li><li>  <a href="http://blogs.microsoft.co.il/sasha/2017/02/27/profiling-a-net-core-application-on-linux/">Profiling a .NET Core Application on Linux</a> </li><li>  <a href="http://blogs.microsoft.co.il/sasha/2017/03/30/tracing-runtime-events-in-net-core-on-linux/">Tracing Runtime Events in .NET Core on Linux</a> </li><li>  <a href="http://blogs.microsoft.co.il/sasha/2017/04/02/tracing-net-core-on-linux-with-usdt-and-bcc/">Tracing .NET Core on Linux with USDT and BCC</a> </li></ul><br><p>  However, I could not find a ready-made recipe for finding a memory leak.  So I decided to describe the method I found. </p><a name="habracut"></a><br><h2 id="kak-by-my-deystvovali-pod-windows">  How would we act under Windows </h2><br><p>  Personally, I would, without hesitation, connect to a running application using dotMemory, take 2 snapshots over a period of time and compare them using a nice GUI. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/49b/41b/c59/49b41bc59ff85bedfbefe4f2f32042a3.png" alt="image"></p><br><p>  How great it would be if under Linux we could do something similar. </p><br><p>  Let's try. </p><br><h2 id="primer-kotoryy-budem-rassmatrivat">  An example that will be considered </h2><br><p>  There is nothing difficult.  Of course, you do not need to resort to any tools to find a leak in the following code.  But for educational purposes will fit. </p><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">leak_example</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { Function1(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> leakClass = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LeakClass(); leakClass.DoWork(); } } }</code> </pre> <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Concurrent; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">leak_example</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LeakClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BlockingCollection&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _collection; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LeakClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _collection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlockingCollection&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentQueue&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoWork</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { _collection.Add(System.Guid.NewGuid().ToString()); Thread.Sleep(<span class="hljs-number"><span class="hljs-number">20</span></span>); } } } }</code> </pre> <br><h2 id="kak-sdelat-snapshot-rabotayuschego-prilozheniya-pod-linux">  How to make a snapshot of a running Linux application </h2><br><p>  It‚Äôs easy to make a similar snapshot (core dump) under Linux for a running application.  The following 2 commands do this: </p><br><pre> <code class="hljs ruby">$ ulimit -c unlimited $ sudo gcore -o dump1 $(pidof dotnet)</code> </pre> <br><p>  And after a while we do the second snapshot </p><br><pre> <code class="hljs ruby">$ sudo gcore -o dump2 $(pidof dotnet)</code> </pre> <br><p>  We received 2 dumps of our application: </p><br><pre> <code class="hljs lua">$ ls -lah <span class="hljs-built_in"><span class="hljs-built_in">dump</span></span>* -rw-r<span class="hljs-comment"><span class="hljs-comment">--r-- 1 root root 5,7G  18 17:01 dump1.13486 -rw-r--r-- 1 root root 6,2G  18 17:03 dump2.13486</span></span></code> </pre> <br><p>  which we can now try to compare. </p><br><h2 id="kak-v-teorii-zaglyanut-v-snapshot-net-core-prilozheniya">  How in theory to glance in snapshot .NET Core applications </h2><br><p>  Microsoft provides a plugin for LLDB that can help us with this.  This is a ported SOS extension from WinDBG with a similar set of commands. </p><br><p>  In theory, to view memory allocations, having the snapshot obtained above, we would have to execute the following commands: </p><br><pre> <code class="hljs haskell">$ lldb $(which <span class="hljs-keyword"><span class="hljs-keyword">dotnet</span></span>) <span class="hljs-comment"><span class="hljs-comment">--core &lt;dump&gt; (lldb) plugin load libsosplugin.so (lldb) sos DumpHeap -stat</span></span></code> </pre> <br><p>  Sasha Goldstein‚Äôs articles still set the path to the CLR with the command </p><br><pre> <code class="hljs pgsql">(lldb) setclrpath /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/dotnet/shared/Microsoft.NETCore.App/<span class="hljs-number"><span class="hljs-number">2.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br><p>  But to investigate the problems with the Debug build of my test application, I didn‚Äôt need it. </p><br><h2 id="surovaya-realnost">  Harsh reality </h2><br><ol><li><p>  Microsoft ships <code>libsoplugin.so</code> with .NET Core.  So, most likely you have it in the system. </p><br></li><li><p>  As Sasha wrote in his article, unfortunately, this plugin is linked with a specific version of LLVM.  Accordingly, a specific version of LLDB is required to use it. </p><br></li><li><p>  View a specific version, it will not work as before, using the <code>ldd</code> command: </p><br><pre> <code class="hljs go">$ ldd /usr/share/dotnet/shared/Microsoft.NETCore.App/<span class="hljs-number"><span class="hljs-number">2.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/libsosplugin.so linux-vdso.so<span class="hljs-number"><span class="hljs-number">.1</span></span> =&gt; (<span class="hljs-number"><span class="hljs-number">0x00007ffc31d</span></span>cb000) libstdc++.so<span class="hljs-number"><span class="hljs-number">.6</span></span> =&gt; /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="hljs-number"><span class="hljs-number">.6</span></span> (<span class="hljs-number"><span class="hljs-number">0x00007f</span></span>65b93bb000) libm.so<span class="hljs-number"><span class="hljs-number">.6</span></span> =&gt; /lib/x86_64-linux-gnu/libm.so<span class="hljs-number"><span class="hljs-number">.6</span></span> (<span class="hljs-number"><span class="hljs-number">0x00007f</span></span>65b90b2000) libgcc_s.so<span class="hljs-number"><span class="hljs-number">.1</span></span> =&gt; /lib/x86_64-linux-gnu/libgcc_s.so<span class="hljs-number"><span class="hljs-number">.1</span></span> (<span class="hljs-number"><span class="hljs-number">0x00007f</span></span>65b8e9c000) libc.so<span class="hljs-number"><span class="hljs-number">.6</span></span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="hljs-number"><span class="hljs-number">.6</span></span> (<span class="hljs-number"><span class="hljs-number">0x00007f65b8ad</span></span>2000) /lib64/ld-linux-x86<span class="hljs-number"><span class="hljs-number">-64.s</span></span>o<span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-number"><span class="hljs-number">0x00007f</span></span>65b994e000)</code> </pre> <br><p>  The fact is that <code>liblldd.so</code> in different distributions was called differently and was <a href="https://github.com/dotnet/coreclr/issues/12098">removed from explicit dependencies</a> . </p><br></li><li><p>  In some of the issues on GitHub there is information that in .NET Core 2.0 this plugin is compiled from lldb-3.8, and the version in .NET Core 2.0.1 will already be compiled from lldb-3.9. </p><br></li><li><p>  It would seem that now we know the version and can simply put the correct version in the lldb system.  But no.  The fact is that lldb before version 4.0 could not load on-demand core dump.  Just as we did (in the process of the program). </p><br></li><li>  So it turns out that we have 2 paths, either build a plugin for lldb-4.0, or <a href="https://bugs.llvm.org/show_bug.cgi%3Fid%3D26322">patch it</a> and build it on lldb-3.8 itself.  I went the first way. </li></ol><br><h2 id="sobiraem-libsoplugin-s-lldb-40">  Build libsoplugin with lldb-4.0 </h2><br><p>  Fortunately, we only need the plugin.  No need to use custom .NET Core, etc.  The plugin will be used directly from the folder in which we collect it, so that the system does not litter. </p><br><p>  Actually, in the CoreCLR repository there <a href="">are instructions</a> for building under Linux.  We'll just tweak them a bit to use lldb-4.0. </p><br><p>  I use Ubuntu 16.04.  For other distributions, the command set may differ slightly. </p><br><ol><li><p>  We put the necessary tools for assembly: </p><br><pre> <code class="hljs sql">$ sudo apt <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> cmake llvm<span class="hljs-number"><span class="hljs-number">-4.0</span></span> clang<span class="hljs-number"><span class="hljs-number">-4.0</span></span> lldb<span class="hljs-number"><span class="hljs-number">-4.0</span></span> liblldb<span class="hljs-number"><span class="hljs-number">-4.0</span></span>-dev libunwind8 libunwind8-dev gettext libicu-dev liblttng-ust-dev libcurl4-openssl-dev libssl-dev <span class="hljs-keyword"><span class="hljs-keyword">uuid</span></span>-dev libnuma-dev libkrb5-dev</code> </pre> <br></li><li><p>  Clone repository: </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dotnet</span></span><span class="hljs-regexp"><span class="hljs-regexp">/coreclr.git $ git checkout release/</span></span><span class="hljs-number"><span class="hljs-number">2.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br></li><li><p>  Apply the following patch: </p><br><pre> <code class="diff hljs">diff --git a/src/ToolBox/SOS/lldbplugin/CMakeLists.txt b/src/ToolBox/SOS/lldbplugin/CMakeLists.txt index fe816ab..ef9846d 100644 --- a/src/ToolBox/SOS/lldbplugin/CMakeLists.txt +++ b/src/ToolBox/SOS/lldbplugin/CMakeLists.txt @@ -76,6 +76,7 @@ endif() find_path(LLDB_H "lldb/API/LLDB.h" PATHS "${WITH_LLDB_INCLUDES}" NO_DEFAULT_PATH) find_path(LLDB_H "lldb/API/LLDB.h") +find_path(LLDB_H "lldb/API/LLDB.h" PATHS "/usr/lib/llvm-4.0/include") find_path(LLDB_H "lldb/API/LLDB.h" PATHS "/usr/lib/llvm-3.9/include") find_path(LLDB_H "lldb/API/LLDB.h" PATHS "/usr/lib/llvm-3.8/include") find_path(LLDB_H "lldb/API/LLDB.h" PATHS "/usr/lib/llvm-3.7/include")</code> </pre> <br></li><li><p>  Putting CoreCLR: </p><br><pre> <code class="hljs ruby">$ ./build.sh clang4.<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br></li></ol><br><p>  Hurray, we got a working plugin for lldb-4.0. </p><br><h2 id="primenyaem-teoriyu-na-praktike">  We apply the theory in practice </h2><br><ol><li><p>  Open our snapshot in lldb: </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">sudo</span></span> lldb<span class="hljs-number"><span class="hljs-number">-4.0</span></span> $(which <span class="hljs-keyword"><span class="hljs-keyword">dotnet</span></span>) <span class="hljs-comment"><span class="hljs-comment">--core ./dump1.13486</span></span></code> </pre> <br></li><li><p>  Load the assembled plugin: </p><br><pre> <code class="hljs pgsql">(lldb) plugin <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> /home/<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>/works/coreclr/bin/Product/Linux.x64.<span class="hljs-keyword"><span class="hljs-keyword">Debug</span></span>/libsosplugin.so</code> </pre> <br></li><li><p>  Dumping heap usage statistics: </p><br><pre> <code class="hljs css">(<span class="hljs-selector-tag"><span class="hljs-selector-tag">lldb</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">sos</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">DumpHeap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-stat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Statistics</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">MT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Count</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TotalSize</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Class</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Name</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe36870b4c8</span></span> 1 24 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Generic</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.GenericEqualityComparer</span></span>`1<span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.Int32, System.Private.CoreLib]</span></span>] 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe3686efea8</span></span> 1 24 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.AsyncLocalValueMap</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">EmptyAsyncLocalValueMap</span></span> ... 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe367cf7038</span></span> 1 131096 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Collections</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Concurrent</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConcurrentQueue</span></span>`1+<span class="hljs-selector-tag"><span class="hljs-selector-tag">Segment</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">Slot</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[[System.Threading.IThreadPoolWorkItem, System.Private.CoreLib]</span></span>]<span class="hljs-selector-attr"><span class="hljs-selector-attr">[]</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe3686dcec8</span></span> 19898 477552 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.TimerHolder</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe3686bfc70</span></span> 19898 477552 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Timer</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe3686dcd18</span></span> 16261 650440 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.QueueUserWorkItemCallback</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe3686c4430</span></span> 19898 1751024 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.TimerQueueTimer</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe3686bfbb8</span></span> 19898 2228576 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Threading</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Tasks</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Task</span></span>+<span class="hljs-selector-tag"><span class="hljs-selector-tag">DelayPromise</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">fe367d08498</span></span> 19 268435400 <span class="hljs-selector-tag"><span class="hljs-selector-tag">UNKNOWN</span></span> 0000000001<span class="hljs-selector-tag"><span class="hljs-selector-tag">b465a0</span></span> 3069079 449192802 <span class="hljs-selector-tag"><span class="hljs-selector-tag">Free</span></span> 00007<span class="hljs-selector-tag"><span class="hljs-selector-tag">f53bc74b460</span></span> 13903273 1362548770 <span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.String</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Total</span></span> 17068427 <span class="hljs-selector-tag"><span class="hljs-selector-tag">objects</span></span></code> </pre> <br><p>  The first column is the address of the method table for objects of this class, the second is the number of allocated objects of this class, the third is the number of allocated bytes, the fourth is the name of the class. </p><br><p>  According to the conclusion is not difficult to guess who flows. </p><br></li><li><p>  We get the stack in which the object is created (commands can be executed sooo long): </p><br><pre> <code class="hljs go">(lldb) sos DumpHeap -mt <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 ... <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d0712c0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071420 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071580 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d0716e0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071840 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d0719a0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071b00 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071c60 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071dc0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d071f20 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d072080 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d0721e0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d072340 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d0724a0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d072600 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d072760 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d0728c0 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d072a20 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> <span class="hljs-number"><span class="hljs-number">00007f</span></span>539d072b80 <span class="hljs-number"><span class="hljs-number">00007f</span></span>53bc74b460 <span class="hljs-number"><span class="hljs-number">98</span></span> ...</code> </pre><br><p>  We get a huge table in which the first column is the address of the instance of this class, the second is the address of the method table, the third is the size of the instance in bytes. </p><br><p>  Select an instance and execute the command: </p><br><pre> <code class="hljs vhdl">(lldb) sos GCRoot <span class="hljs-number"><span class="hljs-number">00007</span></span>f539d072b80 Thread <span class="hljs-number"><span class="hljs-number">4303</span></span>: <span class="hljs-number"><span class="hljs-number">00007</span></span>FFC92921910 <span class="hljs-number"><span class="hljs-number">00007</span></span>F53BC9C0E30 leak_example.LeakClass.DoWork() [/home/ilya/works/trading/leak-example/LeakClass.cs @ <span class="hljs-number"><span class="hljs-number">18</span></span>] rbp-<span class="hljs-number"><span class="hljs-number">48</span></span>: <span class="hljs-number"><span class="hljs-number">00007</span></span>ffc92921918 -&gt; <span class="hljs-number"><span class="hljs-number">00007</span></span>F539D072B80 System.<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-number"><span class="hljs-number">00007</span></span>FFC92921910 <span class="hljs-number"><span class="hljs-number">00007</span></span>F53BC9C0E30 leak_example.LeakClass.DoWork() [/home/ilya/works/trading/leak-example/LeakClass.cs @ <span class="hljs-number"><span class="hljs-number">18</span></span>] rbp-<span class="hljs-number"><span class="hljs-number">40</span></span>: <span class="hljs-number"><span class="hljs-number">00007</span></span>ffc92921920 -&gt; <span class="hljs-number"><span class="hljs-number">00007</span></span>F5394014878 &lt;<span class="hljs-literal"><span class="hljs-literal">error</span></span>&gt; -&gt; <span class="hljs-number"><span class="hljs-number">00007</span></span>F5394014530 &lt;<span class="hljs-literal"><span class="hljs-literal">error</span></span>&gt; -&gt; <span class="hljs-number"><span class="hljs-number">00007</span></span>F53984B4A10 &lt;<span class="hljs-literal"><span class="hljs-literal">error</span></span>&gt; -&gt; <span class="hljs-number"><span class="hljs-number">00007</span></span>F53A47E35F0 &lt;<span class="hljs-literal"><span class="hljs-literal">error</span></span>&gt; -&gt; <span class="hljs-number"><span class="hljs-number">00007</span></span>F539D072B80 System.<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> Found <span class="hljs-number"><span class="hljs-number">2</span></span> unique roots (run '!GCRoot -<span class="hljs-keyword"><span class="hljs-keyword">all</span></span>' <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> see <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> roots).</code> </pre> <br><p>  And as we see, we are pointed at the line </p><br><pre> <code class="hljs css">_<span class="hljs-selector-tag"><span class="hljs-selector-tag">collection</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Add</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">System</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Guid</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.NewGuid</span></span>()<span class="hljs-selector-class"><span class="hljs-selector-class">.ToString</span></span>());</code> </pre> <br><p>  in the source file. </p><br></li></ol><br><h2 id="sravnenie-snapshotov">  Snapshot comparison </h2><br><p>  Since I started talking about comparing snapshots, I‚Äôll have to somehow compare them. </p><br><p>  <code>dump1.txt</code> <code>dump2.txt</code> output of <code>sos DumpHeap -stat</code> for both snapshots to <code>dump1.txt</code> and <code>dump2.txt</code> files (I just copied from the console), I processed them with such a simple script (in fact, I wrote directly to the iPython console, so this isn‚Äôt is very similar): </p><br><pre> <code class="python hljs">dump1 = open(<span class="hljs-string"><span class="hljs-string">'dump1.txt'</span></span>) lines1 = dump1.readlines() methodTables = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> lines1: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> s.startswith(<span class="hljs-string"><span class="hljs-string">'000'</span></span>): (mt, cnt, sz, name) = s.split(maxsplit=<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> mt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> methodTables: methodTables[mt] = {<span class="hljs-string"><span class="hljs-string">'cnt1'</span></span>: cnt, <span class="hljs-string"><span class="hljs-string">'sz1'</span></span>: sz, <span class="hljs-string"><span class="hljs-string">'name'</span></span>: name} dump2 = open(<span class="hljs-string"><span class="hljs-string">'dump2.txt'</span></span>) lines2 = dump2.readlines() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> lines2: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> s.startswith(<span class="hljs-string"><span class="hljs-string">'000'</span></span>): (mt, cnt, sz, name) = s.split(maxsplit=<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> mt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> methodTables: methodTables[mt] = {<span class="hljs-string"><span class="hljs-string">'cnt2'</span></span>: cnt, <span class="hljs-string"><span class="hljs-string">'sz2'</span></span>: sz, <span class="hljs-string"><span class="hljs-string">'name'</span></span>: name} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: methodTables[mt][<span class="hljs-string"><span class="hljs-string">'cnt2'</span></span>] = cnt methodTables[mt][<span class="hljs-string"><span class="hljs-string">'sz2'</span></span>] = sz <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> mt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> methodTables.keys(): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'cnt1'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> methodTables[mt] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'cnt2'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> methodTables[mt]: cnt1 = int(methodTables[mt][<span class="hljs-string"><span class="hljs-string">'cnt1'</span></span>]) sz1 = int(methodTables[mt][<span class="hljs-string"><span class="hljs-string">'sz1'</span></span>]) cnt2 = int(methodTables[mt][<span class="hljs-string"><span class="hljs-string">'cnt2'</span></span>]) sz2 = int(methodTables[mt][<span class="hljs-string"><span class="hljs-string">'sz2'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cnt2 &gt; cnt1 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cnt2 &gt; <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sz2 &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>): print(mt, cnt1, cnt2, methodTables[mt][<span class="hljs-string"><span class="hljs-string">'name'</span></span>])</code> </pre> <br><p>  Having received as a result, a list of "hot spots" that are worth paying attention to: </p><br><p><img src="https://habrastorage.org/webt/59/e8/67/59e867c2911be536536115.png"></p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  I hope this improvised way of searching for memory leaks will be useful to someone. </p><br><p>  An attentive reader, of course, will notice that it would be nice to automate the entire process using lldb scripts.  But so far I have no time for it.  It was not possible to immediately solve the problem with the fact that <code>python-lldb-4.0</code> installed from the repository refuses to load <code>libsoplugin.so</code> .  Perhaps someone else will move on. </p><br><p>  Thanks for attention! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/340516/">https://habr.com/ru/post/340516/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340502/index.html">Creating a platformer for a virtual console TIC-80</a></li>
<li><a href="../340504/index.html">Issue price - 10 million. Softline Venture Partners accepts applications in the IT business accelerator</a></li>
<li><a href="../340508/index.html">How JS works: event loop, asynchrony, and five ways to improve code with async / await</a></li>
<li><a href="../340510/index.html">How we created Raiffeisen Online ...</a></li>
<li><a href="../340514/index.html">Testing React-Redux Applications</a></li>
<li><a href="../340518/index.html">Search for documents in network balloons and file dumps</a></li>
<li><a href="../340520/index.html">Five planning observations</a></li>
<li><a href="../340522/index.html">BEM + React: flexible design system architecture</a></li>
<li><a href="../340524/index.html">How to make a Public API to be used</a></li>
<li><a href="../340528/index.html">Implementing Mars IS Service Introduction Process</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>