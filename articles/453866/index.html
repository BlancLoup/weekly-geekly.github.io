<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>API Request with React Hooks, HOC or Render Prop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Consider the implementation of a data request to the API using a new friend React Hooks and good old friends Render Prop and HOC (Higher Order Compone...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>API Request with React Hooks, HOC or Render Prop</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/s8/xs/sy/s8xssyovbjdd26lj5n-4sbi5obu.jpeg"></p><br><p>  Consider the implementation of a data request to the API using a new friend React Hooks and good old friends Render Prop and HOC (Higher Order Component).  Find out whether the new friend is better than the old two. </p><a name="habracut"></a><br><p>  Life does not stand still, React is changing for the better.  In February 2019, React Hooks appeared in React 16.8.0.  Now in the functional components, you can work with the local state and perform side effects.  Nobody believed that this was possible, but everyone always wanted it.  If you are not aware of the details yet, for details <a href="https://reactjs.org/docs/hooks-intro.html">here</a> . </p><br><p>  React Hooks make it possible to finally abandon such patterns as HOC and Render Prop.  Because during the use of them a number of complaints have accumulated: </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  RProp </th><th>  HOC </th></tr></thead><tbody><tr><td>  1. There are many wrapper components that are difficult to understand in React DevTools and in the code. </td><td>  (‚óïÔ∏µ‚óï) </td><td>  (‚óïÔ∏µ‚óï) </td></tr><tr><td>  2. Difficult to type (Flow, TypeScript). </td><td></td><td>  (‚óïÔ∏µ‚óï) </td></tr><tr><td>  3. It is not obvious from which HOC which component the props receives, which complicates the process of debugging and understanding how the component works. </td><td></td><td>  (‚óïÔ∏µ‚óï) </td></tr><tr><td>  4. Render Prop most often does not add layout, although it is used inside JSX. </td><td>  (‚óïÔ∏µ‚óï) </td><td></td></tr><tr><td>  5. Props key collision.  When transmitting props from parents, the same keys can be overwritten with values ‚Äã‚Äãfrom the HOC. </td><td></td><td>  (‚óïÔ∏µ‚óï) </td></tr><tr><td>  6. It is difficult to read git diff, since all indents in JSX are shifted when JSX is wrapped in Render Prop. </td><td>  (‚óïÔ∏µ‚óï) </td><td></td></tr><tr><td>  7. If several HOC, then you can make a mistake with the sequence of the composition.  The correct order is not always obvious, since the logic is hidden inside the HOC.  For example, when we first check whether the user is authorized, and only then we request personal data. </td><td></td><td>  (‚óïÔ∏µ‚óï) </td></tr></tbody></table></div><br><p>  Not to be unfounded, let's look at an example of how React Hooks is better (and maybe worse) Render Prop.  We will consider Render Prop, not HOC, since they are very similar in implementation and HOC has more drawbacks.  Let's try to write a utility that processes the data request to the API.  I am sure that many have written this in their lives hundreds of times, so what can we see if it can be even better and simpler. </p><br><p>  For this we will use the popular axios library.  In the simplest scenario, the following states need to be processed: </p><br><ul><li>  data acquisition process (isFetching) </li><li>  data successfully received (responseData) </li><li>  data error (error) </li><li>  Cancellation of the request, if the request parameters have changed during the process </li><li>  canceling a request if this component is no longer in the DOM </li></ul><br><p>  <strong>1. Simple script</strong> </p><br><p>  We write the default state and the function (reducer), which changes the state depending on the result of the request: success / error. </p><br><div class="spoiler">  <b class="spoiler_title">What is a Reducer?</b> <div class="spoiler_text"><p>  For reference.  Reducer came to us from functional programming, and for most JS developers from Redux.  This is a function that takes the previous state and action (action) and returns the next state. </p></div></div><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> defaultState = { <span class="hljs-attr"><span class="hljs-attr">responseData</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reducer1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"fetched"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ...state, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">responseData</span></span>: action.payload }; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"error"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ...state, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: action.payload }; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state; } }</code> </pre> <br><p>  We reuse this function in two approaches. </p><br><p>  <strong>Render prop</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RenderProp1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ state = defaultState; axiosSource = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; tryToCancel() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.axiosSource) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.axiosSource.cancel(); } } dispatch(action) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prevState</span></span></span><span class="hljs-function"> =&gt;</span></span> reducer(prevState, action)); } fetch = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tryToCancel(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.axiosSource = axios.CancelToken.source(); axios .get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.url, { <span class="hljs-attr"><span class="hljs-attr">cancelToken</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.axiosSource.token }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"fetched"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: response.data }); }) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: error }); }); }; componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetch(); } componentDidUpdate(prevProps) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prevProps.url !== <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.url) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetch(); } } componentWillUnmount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tryToCancel(); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.children(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state); }</code> </pre><br><p>  <strong>React hooks</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useRequest1 = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [state, dispatch] = React.useReducer(reducer, defaultState); React.useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> source = axios.CancelToken.source(); axios .get(url, { <span class="hljs-attr"><span class="hljs-attr">cancelToken</span></span>: source.token }) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"fetched"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: response.data }); }) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"error"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: error }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source.cancel; }, [url]); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [state]; };</code> </pre> <br><p>  By url from the used component we get the data - axios.get ().  We process success and error, changing state through dispatch (action).  We return state in component.  And don't forget to cancel the request if the url is changed or if the component is removed from the DOM.  Everything is simple, but you can write in different ways.  Highlight the pros and cons of the two approaches: </p><br><div class="scrollable-table"><table><thead><tr><th></th><th>  Hooks </th><th>  RProp </th></tr></thead><tbody><tr><td>  1. Less code. </td><td>  (‚óë‚Äø‚óê) </td><td></td></tr><tr><td>  2. The call to the side effect (data request to the API) is easier to read, since it is written linearly, not spread over the component life cycles. </td><td>  (‚óë‚Äø‚óê) </td><td></td></tr><tr><td>  3. Cancel request written immediately after the call request.  All in one place. </td><td>  (‚óë‚Äø‚óê) </td><td></td></tr><tr><td>  4. A simple code that describes the tracking parameters for calling side effects. </td><td>  (‚óë‚Äø‚óê) </td><td></td></tr><tr><td>  5. Obviously, the life cycle of the component will execute our code. </td><td></td><td>  (‚óë‚Äø‚óê) </td></tr></tbody></table></div><br><p>  React Hooks allow you to write less code, and this is an indisputable fact.  So, the effectiveness of you as a developer is growing.  But you have to master the new paradigm. </p><br><p>  When there are names of life cycles of a component, everything is very clear.  First, we receive the data after the component appears on the screen (componentDidMount), then we re-receive if the props.url has changed and do not forget to cancel the previous request (componentDidUpdate) before that, if the component is removed from the DOM, then cancel the request (componentWillUnmount) . </p><br><p>  But now we are causing the side effect right in the render, but we were taught that it was wrong.  Although stop, not quite in the render.  And inside the useEffect function, which will perform something asynchronously after each render, or rather, the commit and draw of a new DOM. </p><br><p>  But we do not need after each render, but only on the first render, and if the url is changed, we specify the second argument in useEffect. </p><br><div class="spoiler">  <b class="spoiler_title">New paradigm</b> <div class="spoiler_text"><p>  Understanding how React Hooks work requires an awareness of new things.  For example, the difference between the phases: commit and render.  In the render phase, React calculates which changes to apply in the DOM by comparing with the result of the previous render.  And in the commit phase, React applies these changes to the DOM.  It is during the commit phase that the methods are called: componentDidMount and componentDidUpdate.  But what is written in useEffect will be called asynchronously after the commit and, thus, will not block the DOM drawing if you accidentally decide something to synchronize a lot in the side effect. </p><br><p>  Conclusion - use useEffect.  Write less and safer. </p><br><p>  And another great feature: useEffect can clean up after the previous effect and after removing a component from the DOM.  Thanks to Rx who inspired the React team to take this approach. </p></div></div><br><p>  Using our utility with React Hooks is also much more convenient. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AvatarRenderProp1 = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ username }</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RenderProp</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">https:</span></span></span></span><span class="xml"><span class="hljs-tag">//</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">api.github.com</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">users</span></span></span></span><span class="xml"><span class="hljs-tag">/${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">username</span></span></span></span><span class="xml"><span class="hljs-tag">}`}&gt;</span></span></span><span class="xml"> {state =&gt; { if (state.isFetching) { return "Loading"; } if (state.error) { return "Error"; } return </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">img</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{state.responseData.avatar_url}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"avatar"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; }} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RenderProp</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> );</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AvatarWithHook1 = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ username }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [state] = useRequest(<span class="hljs-string"><span class="hljs-string">`https://api.github.com/users/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.isFetching) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Loading"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.error) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Error"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">img</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{state.responseData.avatar_url}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">alt</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"avatar"</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; };</span></span></code> </pre> <br><p>  The React Hooks option again looks more compact and obvious. </p><br><p>  Cons Render Prop: </p><br><p>  1) it is not clear whether the layout is added or only the logic <br>  2) if it is necessary to process the state from Render Prop in the local state or the life cycles of the child component, you will have to create a new component </p><br><p>  Add a new functionality - data acquisition with new parameters according to user action.  I wanted, for example, a button that gets the avatar of your favorite developer. </p><br><p>  <strong>2) Update user action data</strong> </p><br><p>  Add a button that sends a request with a new username.  The simplest solution is to store the username in the local state of the component and transfer the new username from the state, not props as it is now.  But then we have to copy-paste wherever we need similar functionality.  So we will carry out this functionality in our utility. </p><br><p>  We will use this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Avatar2 = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ username }</span></span></span><span class="hljs-function">) =&gt;</span></span> { ... &lt;button onClick={() =&gt; update(<span class="hljs-string"><span class="hljs-string">"https://api.github.com/users/NewUsername"</span></span>)} &gt; Update avatar <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> New Username &lt;<span class="hljs-regexp"><span class="hljs-regexp">/button&gt; ... };</span></span></code> </pre> <br><p>  Let's write the implementation.  Only the changes from the original version are written below. </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reducer2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action.type) { ... case <span class="hljs-string"><span class="hljs-string">"update url"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ...state, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: action.payload, <span class="hljs-attr"><span class="hljs-attr">defaultUrl</span></span>: action.payload }; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"update url manually"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ...state, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: action.payload, <span class="hljs-attr"><span class="hljs-attr">defaultUrl</span></span>: state.defaultUrl }; ... } }</code> </pre> <br><p>  <strong>Render prop</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RenderProp2</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ state = { <span class="hljs-attr"><span class="hljs-attr">responseData</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.url, <span class="hljs-attr"><span class="hljs-attr">defaultUrl</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.url, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> getDerivedStateFromProps(props, state) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.defaultUrl !== props.url) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reducer(state, { <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"update url"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: props.url }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } ... componentDidUpdate(prevProps, prevState) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prevState.url !== <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.url) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetch(); } } ... update = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"update url manually"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: url }); }; render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.children(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update); } }</code> </pre> <br><p>  <strong>React hooks</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useRequest2 = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [state, dispatch] = React.useReducer(reducer, { url, <span class="hljs-attr"><span class="hljs-attr">defaultUrl</span></span>: url, <span class="hljs-attr"><span class="hljs-attr">responseData</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (url !== state.defaultUrl) { dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"update url"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: url }); } React.useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ‚Ä¶(fetch data); }, [state.url]); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> update = React.useCallback( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function"> =&gt;</span></span> { dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"update url manually"</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: url }); }, [dispatch] ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [state, update]; };</code> </pre> <br><p>  If you carefully looked at the code, you noticed: </p><br><ul><li>  the url began to be stored inside our utility; </li><li>  defaultUrl appeared to identify that url was updated via props.  We need to monitor the change of props.url, otherwise a new request will not be sent; </li><li>  added the update function, which we return to the component to send a new request by clicking on the button. </li></ul><br><p>  Pay attention with Render Prop, we had to use getDerivedStateFromProps to update the local state in case of changing props.url.  And with React Hooks, no new abstractions, you can immediately cause a state update in the render - hooray, comrades, finally! </p><br><p>  The only complication with React Hooks was that the update function had to be memorized so that it would not change between component updates.  When, like in Render Prop, the update function is a class method. </p><br><p>  <strong>3) Poll API at equal time or polling</strong> </p><br><p>  Let's add another popular functionality.  Sometimes you need to constantly poll the API.  Not only did your favorite developer change the avatar, and you do not know.  Add parameter spacing. </p><br><p>  Using: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AvatarRenderProp3 = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ username }</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RenderProp</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">https:</span></span></span></span><span class="xml"><span class="hljs-tag">//</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">api.github.com</span></span></span></span><span class="xml"><span class="hljs-tag">/</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">users</span></span></span></span><span class="xml"><span class="hljs-tag">/${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">username</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pollInterval</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{1000}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ...</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AvatarWithHook3 = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ username }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [state, update] = useRequest( <span class="hljs-string"><span class="hljs-string">`https://api.github.com/users/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${username}</span></span></span><span class="hljs-string">`</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span> ); ...</code> </pre> <br><p>  Implementation: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reducer3</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, action</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action.type) { ... case <span class="hljs-string"><span class="hljs-string">"poll"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { ...state, <span class="hljs-attr"><span class="hljs-attr">requestId</span></span>: state.requestId + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">isFetching</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; ... } }</code> </pre> <br><p>  <strong>Render prop</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RenderProp3</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">React</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ state = { ... requestId: <span class="hljs-number"><span class="hljs-number">1</span></span>, } ... timeoutId = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; ... tryToClearTimeout() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeoutId) { clearTimeout(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeoutId); } } poll = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tryToClearTimeout(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeoutId = setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'poll'</span></span> }); }, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.pollInterval); }; ... componentDidUpdate(prevProps, prevState) { ... if (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.pollInterval) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( prevState.isFetching !== <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.isFetching &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.isFetching ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.poll(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prevState.requestId !== <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.requestId) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fetch(); } } } componentWillUnmount() { ... this.tryToClearTimeout(); } ...</code> </pre><br><p>  <strong>React hooks</strong> </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useRequest3 = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, pollInterval</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [state, dispatch] = React.useReducer(reducer, { ... requestId: <span class="hljs-number"><span class="hljs-number">1</span></span>, }); React.useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { ‚Ä¶(fetch data) }, [state.url, state.requestId]); React.useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!pollInterval || state.isFetching) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> timeoutId = setTimeout(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { dispatch({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"poll"</span></span> }); }, pollInterval); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { clearTimeout(timeoutId); }; }, [pollInterval, state.isFetching]); ... }</code> </pre> <br><p>  There is a new prop - pollInterval.  Upon completion of the previous request via setTimeout, we increment the requestId.  With hooks, we have another useEffect in which we call setTimeout.  And our old useEffect, which sends the request, began to follow one more variable - requestId, which tells us that setTimeout has worked, and it's time to send the request for a new avatar. </p><br><p>  In Render Prop I had to write: </p><br><ol><li>  compare previous and new requestId and isFetching </li><li>  clear timeoutId in two places </li><li>  add timeoutId property to class </li></ol><br><p>  React Hooks allow us to write shortly and clearly what we are used to describe in more detail and is not always clear. </p><br><p>  <strong>4) What's next?</strong> <br>  We can continue to expand the functionality of our utility: to accept different configurations of query parameters, data caching, response and error conversion, forced data update with the same parameters ‚Äî routine operations in any large web application.  On our project, we have long carried this into a separate (attention!) Component.  Yes, because it was Render Prop.  But with the release of Hooks, we rewrote the function (useAxiosRequest) and even found some bugs in the old implementation.  You can see and try <a href="https://github.com/Turanchoks/use-axios-request">here</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/453866/">https://habr.com/ru/post/453866/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453852/index.html">Microbiota How to care for intestinal bacteria</a></li>
<li><a href="../45386/index.html">Open Source Multi Theft Auto</a></li>
<li><a href="../453860/index.html">AMD has introduced its new custom 7 nm processors Ryzen third generation</a></li>
<li><a href="../453862/index.html">Why you should use pathlib</a></li>
<li><a href="../453864/index.html">Using a mouse and keyboard on consoles is cheating?</a></li>
<li><a href="../453868/index.html">Touch mini switch co with glass panel on nRF52832</a></li>
<li><a href="../453870/index.html">We write Reverse socks5 proxy on powershell. Part 1</a></li>
<li><a href="../453872/index.html">We restore photos using neural networks</a></li>
<li><a href="../453874/index.html">From Russian Roulette to secure LOTO: how to protect data center personnel</a></li>
<li><a href="../453876/index.html">How Yandex.Practicum won the front-end desync: acrobatic number with Redux-Saga, postMessage and Jupyter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>