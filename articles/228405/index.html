<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Receive notifications from Zabbix in WhatsApp</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are many ways to get notifications from Zabbix on the net. It seemed to me convenient to receive alerts in WhatsApp - it is cheaper than sms and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Receive notifications from Zabbix in WhatsApp</h1><div class="post__text post__text-html js-mediator-article">  There are many ways to get notifications from Zabbix on the net.  It seemed to me convenient to receive alerts in WhatsApp - it is cheaper than sms and, in my case, more convenient than mail - to receive notifications, we use a corporate email account, access to which is restricted from the outside, besides, the alert can be lost among other emails . <br><a name="habracut"></a><br>  Setting up is pretty simple.  We will need: <br><br>  1) yowsup and its dependencies: <br>  1.1) python 2.6+ <br>  1.2) python-dateutil <br>  1.3) argparse for python &lt;2.7 <br>  1.4) libxml2 if yowsup will be used with the old version of the API (--v1 flag) <br>  2) Zabbix server access to the Internet <br>  3) A phone with a SIM card, the number of which will be registered with WhatsApp account <br><br><h5>  Step 1: Install the yowsup dependencies </h5><br>  First you need to install dependencies for yowsup. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      On Debian-like distributions or using the DEB package format, this is done like this: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># aptitude install python python-dateutil python-argparse</span></span></code> </pre> <br><br>  On RedHat-based distributions or using the RPM package format: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># yum install python python-dateutil python-argparse</span></span></code> </pre><br><br>  In my case there was no python-argparse package in the repository, I had to download it separately and install it manually.  For RHEL 6, this can be done, for example, <a href="">here</a> . <br><br>  Installation: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># rpm -i python-argparse-1.2.1-5.1.noarch.rpm</span></span></code> </pre><br><br><h5>  Step 2: Install yowsup </h5><br>  After installing the dependencies, we install yowsup itself.  The official project page is located on <a href="https://github.com/tgalal/yowsup">GitHub</a> .  Directly from the Zabbix server, yowsup can be downloaded in this way: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># wget https://github.com/tgalal/yowsup/archive/master.zip</span></span></code> </pre><br><br>  Unpack the archive and go to the directory yowsup-master / src: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># unzip master.zip # cd yowsup-master/src</span></span></code> </pre><br><br>  Copy the config example to the working config: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cp config.example yowsup-cli.config</span></span></code> </pre><br><br>  There are only four lines: <br><br><pre> <code class="bash hljs">cc=7 phone= id= password=</code> </pre><br><br>  <i>cc</i> is the country code.  A list of codes can be found on the page <a href="http://countrycode.org/">CountryCode.org</a> .  Code of Russia - 7; <br><br>  <i>phone</i> - the phone number to which the WhatsApp account will be associated.  Must begin with country code; <br><br>  <i>id</i> - this field is required if you want to use an existing WhatsApp account and an old version of the API (launch yowsup with the --v1 flag).  If the account was created on a Nokia or Android device, then in the id field you need to write the device's IMEI.  If the device is based on iOS, then you need to write the MAC address of the WLAN interface.  In new versions of the API, this field is not used, you can leave it blank; <br><br>  <i>password</i> - WhatsApp password that will be received automatically after registration.  In principle, you can pull this password out of an existing account, then it will be possible to use one account on two devices, but I have not tried it. <br><br>  So, fill in the config fields: <br><br><pre> <code class="bash hljs">cc=7 phone=79123456789 id= password=</code> </pre><br><br>  Next, you need to go through the registration procedure, during which the sms with the confirmation code will come to the phone number specified in the config file.  In general, problems on this step should arise.  Make sure that the Zabbix server has access to the WhatsApp server using the https protocol.  If Zabbix is ‚Äã‚Äãbehind the firewall and the security policy does not allow it to open full access to the Internet, you can get a list of addresses by running tcpdump on the server‚Äôs network interface and see where yowsup is applying by launching the registration procedure.  I will not dwell on this in detail, there are a lot of tcpdump manuals on the network, I can only say that this command came in handy for me (all tcp traffic on the eth0 interface, which does not go within the local network 10.0.0.0/8): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># tcpdump -i eth0 -n tcp and not src net 10.0.0.0/8 and dst net 10.0.0.0/8</span></span></code> </pre><br><br>  We send a request for registration: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./yowsup-cli -c yowsup-cli.config -r sms</span></span></code> </pre><br><br>  If everything went well, we will receive an SMS with a six-digit confirmation code (for example, 123-456).  We send this code to the WhatsApp server: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./yowsup-cli -c yowsup-cli.config -R 123456</span></span></code> </pre><br><br>  After that, a password should appear in the password field of our config.  This registration procedure is completed, you can try to send a message to another WhatsApp user. <br><br>  You can send a message with the command <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./yowsup-cli --send 79123456780 "Test message" --wait --config yowsup-cli.config</span></span></code> </pre><br><br>  Accept message: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./yowsup-cli --listen --autoack --keepalive --config yowsup-cli.config</span></span></code> </pre><br><br>  And you can generally chat in chat mode: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./yowsup-cli --interactive 79123456780 --wait --autoack --keepalive --config yowsup-cli.config</span></span></code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/996/221/aa1/996221aa1fc4cf12a8aea782b18d2e25.png" alt="image"><br><br>  This completes the yowsup setup. <br><br><h5>  Step 3: Writing an alert sending script </h5><br>  To make friends yowsup and Zabbix, you need to write a script to send notifications.  Let me remind you that Zabbix takes notification scripts from the directory defined in the <i>AlertScriptsPath</i> variable of the <i>zabbix_server.conf</i> <i>config</i> .  In my directory, this directory was located in <i>/ usr / local / share / zabbix / alertscripts</i> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cat /usr/local/etc/zabbix_server.conf | grep AlertScriptsPath ### Option: AlertScriptsPath # AlertScriptsPath=/usr/local/share/zabbix/alertscripts</span></span></code> </pre><br><br>  We put there a script (I called it <i>whatsapp</i> ), consisting of literally three lines: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash DIR='/usr/local/share/zabbix/alertscripts/yowsup-master/src/' #    yowsup $DIR/yowsup-cli --send $1 "$2 $3" --wait --config $DIR/yowsup-cli.config</span></span></code> </pre><br><br>  I put the yowsup files in the alertscripts directory - maybe this is not the best solution, but it seemed to me that it would be more convenient to search for configs / scripts if anything happens. <br><br>  <i>$ 1 $ 2 $ 3</i> is the value of the Zabbix variables, meaning, respectively, "to whom to send the notification", "subject" and "notification body".  We will configure these fields further from the Zabbix interface. <br><br>  Making the script executable: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># chmod +x /usr/local/share/zabbix/alertscripts/whatsup</span></span></code> </pre><br><br><h5>  Step 4: Configure Zabbix </h5><br>  We act according to the standard algorithm: <br><br>  1) Create a notification method <br>  2) Create an action associated with this alert. <br>  3) We connect the notification to users <br><br><h6>  1) Create a notification method </h6><br>  In the <i>Administration -&gt; Alerts</i> menu <i>(Administration -&gt; Media types),</i> click the <i>Create media type</i> button. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e57/5c5/53f/e575c553f02c7a1a7aba9a553a970348.png"><br><br>  <i>Name (Name):</i> Any at your request <br>  <i>Type (Type):</i> - Script (Script) <br>  <i>Script Name:</i> - Must match the name of the script created in the previous step ( <i>whatsapp</i> in our case) <br><br><h6>  2) Create an action </h6><br>  By default, Zabbix is ‚Äã‚Äãconfigured with an action that sends all types of alerts to all administrators: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/745/d6c/37a/745d6c37adf71129255604f2e2a93685.png"><br><br>  If you do not have such an action, then you need to create your own.  The <i>Settings -&gt; Actions</i> menu <i>(Configuration -&gt; Action)</i> , create a new action with the <i>Create Action</i> button. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4f9/88b/ede/4f988bede3c9dab7973a36912834d0f7.png"><br><br>  On the <i>Action</i> tab, you can define the message format that will be sent to WhatsApp.  I left everything by default <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b60/809/154/b60809154f9e6c98ab3f6b84239e83b6.png"><br><br>  The <i>Conditions</i> tab sets the conditions under which the action will be performed.  Also left by default. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/732/ba3/c46/732ba3c462b93268539070a04988c269.png"><br><br>  Well, on the <i>Operations</i> tab, we indicate what Zabbix should do: send a message <i>(Send message) to a</i> group of users or to an individual user by the WhatsApp notification method. <br><br>  Save the settings and proceed to the next step. <br><br><h6>  3) We connect the notification to users </h6><br>  Go to the user settings <i>(Administration -&gt; Users or Administration -&gt; Users)</i> , select the desired user and configure the <i>Notification Method (Media) for him</i> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a4a/49c/85a/a4a49c85a056353e5f58b535adb923ad.png"><br><br>  <i>Alert Type (Type):</i> WhatsApp <br>  <i>Send to (Send to):</i> Phone number with country code (for example, 79123456789) <br>  We select the time when you can send messages and the degree of their criticality.  Save the settings. <br><br>  This completes the setup, but still needs to check that the messages go away and are successfully delivered.  You can follow the sending of notifications in the <i>Administration -&gt; Audit</i> menu <i>(Administration -&gt; Audit)</i> by selecting the <i>Actions</i> item: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/924/d73/548/924d7354894469b702d6bc3000c13d67.png"><br><br>  We see that the notification was successfully sent: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b2/640/bce/0b2640bce1fe34bac43a334996365785.png"><br><br>  Checking WhatsApp on your smartphone: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d64/9a9/2be/d649a92beaf62d2a72cbb3bcb82d7299.png"><br><br>  Works! <br><br>  <b>UPDATE:</b> The comments ask why WhatsApp, and not something else, such as sms.  The fact is that now our Zabbix generates quite a lot of alerts, including false ones.  I tried to fasten a 3G modem to it and send sms from it, but it turned out quite expensive in terms of the cost of paying them.  And since almost all colleagues have WhatsApp, I thought that it would be nice to send notifications exactly there, besides, it is free (first year) and does not require installing any applications (in our case).  It is clear that this is not the most reliable way - they can change the API, the phone may be without the Internet, the channel between Zabbix and the Internet will fall, etc., but for sending uncritical alerts, IMHO, it can be used to spend less on SMS.  If suddenly the shop is closed, we will use something else, for example Pushover or Boxcar, <a href="http://habrahabr.ru/post/228405/">suggested by</a> <a href="https://habrahabr.ru/users/kemko/" class="user_link">kemko</a> </div><p>Source: <a href="https://habr.com/ru/post/228405/">https://habr.com/ru/post/228405/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228391/index.html">Wind generator energetically pays off in 5-7 months</a></li>
<li><a href="../228393/index.html">Annual online conference MegaIndex.tv 2014</a></li>
<li><a href="../228395/index.html">UNET - new network technology in Unity 3D</a></li>
<li><a href="../228397/index.html">Brave Octopus Adventure - the brave octopus is ready to conquer your Android smartphones</a></li>
<li><a href="../228401/index.html">Gaming Conferences: DevGamm, White Nights and Health Industry</a></li>
<li><a href="../228409/index.html">Values ‚Äã‚Äãof using email for small and medium businesses</a></li>
<li><a href="../228411/index.html">Django widgets and a couple more tricks</a></li>
<li><a href="../228413/index.html">Return Mail is a simple way to increase the number of customers by more than 13%.</a></li>
<li><a href="../228415/index.html">Transoceanic Submarine Communication Cables</a></li>
<li><a href="../228417/index.html">Published a single rating of seo-companies in 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>