<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting MIPSfpga to other cards and integrating peripherals into the system. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MIPSfpga microprocessor MIPS32 microAptiv described in Verilog language for educational purposes of the company Imagination, which has a cache memory ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting MIPSfpga to other cards and integrating peripherals into the system. Part 2</h1><div class="post__text post__text-html js-mediator-article">  MIPSfpga microprocessor MIPS32 microAptiv described in Verilog language for educational purposes of the company Imagination, which has a cache memory and a memory management unit.  The processor code is available to the user ( <a href="http://www.silicon-russia.com/2015/12/11/mipsfpga-download-instructions/">download instructions</a> ) and can be used to simulate and implement a processor on an FPGA board. <br><br>  This article is a continuation of the article on how <a href="https://habrahabr.ru/post/329808/">to port MIPSfpga-plus to other boards</a> , and it will describe how to integrate peripherals into the MIPSfpga-plus system using the example of 16 Digillent Pmod KYPD keyboard: <br><br><img src="https://habrastorage.org/web/987/724/9b2/9877249b202e4c3ba61b012379e10c79.JPG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Connecting the keyboard to the processor will allow the user to communicate with him.  In general, 16-button keypads come in different representations, but the implementation and operation principle is the same for them.  Therefore, according to this example, similar keyboards can be integrated. <br><br>  The integration of the built-in ADC board, as well as the display connections from the Nokia 5100 is described in the following part of my tutorial: <br><br>  <a href="https://habrahabr.ru/post/329854/">Porting MIPSfpga to other cards and integrating peripherals into the system.</a>  <a href="https://habrahabr.ru/post/329854/">Part 3</a> <br><br>  Also, how to start working with MIPSfpga is written in the <a href="https://habrahabr.ru/post/275215/">article</a> . <br><a name="habracut"></a><br>  MIPS architecture is one of the first computer architectures with reduced instruction set (RISC).  It emerged as a result of research at Stanford University in 1981 and revolutionized the efficiency of computer architectures.  The commercial use of MIPS architecture began in 1984 by MIPSfpga 2: Getting Started Imagination Technologies v1.3, March 1, 2016 MIPS Computer Systems, which in 2013 was acquired by Imagination Technologies. <br><br>  MIPS processors were used in Silicon Graphics high-performance workstations that were manufactured in the 1980s and 1990s.  The first commercially successful product was the MIPS R3000 processor, which had a five-stage pipeline.  It was followed by the R4000, which added 64-bit commands, a superscalar R8000, a processor with an extraordinary execution of R10000 commands, and many other high-performance cores. <br><br>  Over time, the MIPS architecture has evolved for applications in low-cost, low-power products, such as consumer electronics, networking equipment, and microcontrollers.  The M4K family is based on the classic 32-bit architecture with a five-stage pipeline.  In the M14K family, a set of 16-bit microMIPS instructions has been added, which allows reducing the size of programs for embedded applications, in which cost is very important.  In the microAptiv family, the M14K instruction set is extended with additional digital signal processing instructions.  The M14K core exists in two versions: microcontroller (UC) and microprocessor (UP).  The microprocessor version contains cache memory and supports virtual memory, which provides the ability to run an operating system such as Linux or Android.  Perhaps you are familiar with Microchip's popular PIC32 microcontroller line, which is based on the M4K architecture. <br><br>  The processor uses a memory interface to communicate with peripheral devices.  That is, this means that data is written and read from the connected peripherals in the same way as from a RAM block.  The integration of peripherals into the processor is carried out by connecting to the AHB-Lite bus ( <a href="https://github.com/zhelnio/memos/blob/master/public/02_mips_uart/doc/D2_MicroAptiv_UP_AHB_Lite_Interface_MD01082.pdf">detailed documentation</a> ).  Try to understand the connection process in more detail. <br><br>  First you need to have an idea of ‚Äã‚Äãhow the signals will pass through the AHB-Lite bus: <br><img src="https://habrastorage.org/web/ca4/fd7/54d/ca4fd754da4e4a0fb43e06f8efe1d14a.png"><br><br>  It is seen that the process of reading data from the periphery is carried out by the HRDATA signal, data is transmitted via HWRITE with an active high level on the write resolution signal, the choice of GPIO is performed by selecting the address on HADDR. <br><br><h2>  1. Keyboard connection Digilent Pmod KYPD </h2><br>  The first sensor that was connected is the 16-button pmod KYPD ( <a href="https://reference.digilentinc.com/_media/reference/pmod/pmodkypd/pmodkypd_rm.pdf">datasheet</a> ). <br><br><img src="https://habrastorage.org/web/aca/227/b54/aca227b54af341e786c7c3c121a90b7e.png"><br><br>  In my case, the Pmod interface was used to connect the keyboard, but you can use any other pins of your board, but then you will need to register them in the file with * .xdc restrictions.  To which pins to connect the keyboard is described below in the table. <br><br>  Pinout and keyboard signals are described in the table: <br><table><tbody><tr><th>  Pin </th><th>  Signal </th><th>  Purpose </th><th>  Pin </th><th>  Signal </th><th>  Purpose </th></tr><tr><td>  one </td><td>  Col4 </td><td>  4 column </td><td>  7 </td><td>  ROW4 </td><td>  4 row </td></tr><tr><td>  2 </td><td>  Col3 </td><td>  3 column </td><td>  eight </td><td>  ROW3 </td><td>  3 row </td></tr><tr><td>  3 </td><td>  Col2 </td><td>  2 column </td><td>  9 </td><td>  ROW2 </td><td>  2 row </td></tr><tr><td>  four </td><td>  Col1 </td><td>  1 column </td><td>  ten </td><td>  ROW1 </td><td>  1 row </td></tr><tr><td>  five </td><td>  GND </td><td>  ground contact </td><td>  eleven </td><td>  GND </td><td>  ground contact </td></tr><tr><td>  6 </td><td>  GND </td><td>  power contact </td><td>  12 </td><td>  VCC </td><td>  power contact </td></tr></tbody></table><br>  Keyboard wiring is very simple: <br><img src="https://habrastorage.org/web/906/7de/0d9/9067de0d92b44228ba372e22aa29cdff.png"><br>  The next step to integrate the keyboard to the AHB-lite bus is to write a module on Verilog. <br>  The keyboard uses 4 rows and columns to create an array of 16 clock buttons. <br><br>  The diagram shows that the rows are pulled up to the power supply with resistances at R = 10k, which means that by actuating the lines of the columns to a low logic level, a clock signal with a certain frequency is supplied.  At the moment when the active signal at the input coincides with the column (col) on which the button is pressed, a low level will appear at the output of the row.  To implement such a process, you need to write a decoder (an example of the implementation of the module is also described in this <a href="https://habrahabr.ru/post/323360/">article</a> ). <br><br><img src="https://habrastorage.org/web/3eb/bab/711/3ebbab7111b84f138f8508b4428eb721.png"><br><br>  The module itself has the form: <br><br><pre><code class="hljs pgsql">module kypd_decoder( <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> i_clk, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> i_rst_n, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] i_row, output reg [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] o_col, output reg [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] o_number ); reg [<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] counter; reg [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] col; reg [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> col parameter ZERO = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b11100111, ONE = 8'</span></span>b01110111, TWO = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b01111011, THREE = 8'</span></span>b01111101, FOUR = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b10110111, FIVE = 8'</span></span>b10111011, SIX = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b10111101, SEVEN = 8'</span></span>b11010111, EIGHT = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b11011011, NINE = 8'</span></span>b11011101, A = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b01111110, B = 8'</span></span>b10111110, C = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b11011110, D = 8'</span></span>b11101110, E = <span class="hljs-number"><span class="hljs-number">8</span></span><span class="hljs-string"><span class="hljs-string">'b11101101, F = 8'</span></span>b11101011; <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge i_clk <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge i_rst_n) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i_rst_n == <span class="hljs-number"><span class="hljs-number">0</span></span>) counter &lt;= <span class="hljs-number"><span class="hljs-number">20</span></span><span class="hljs-string"><span class="hljs-string">'b0; else counter &lt;= counter + 1'</span></span>b1; <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge i_clk <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge i_rst_n) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i_rst_n == <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">'b0) begin o_col &lt;= 4'</span></span>b1110; col &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'b1110; row &lt;= 4'</span></span>b1111; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!counter) <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> o_col &lt;= {o_col [<span class="hljs-number"><span class="hljs-number">0</span></span>], o_col [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>]}; col &lt;= o_col; <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> &lt;= i_row; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> @(posedge i_clk <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> negedge i_rst_n) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i_rst_n == <span class="hljs-number"><span class="hljs-number">0</span></span>) o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'b0; else case ({row, col}) ZERO: o_number &lt;= 4'</span></span>h0; ONE: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h1; TWO: o_number &lt;= 4'</span></span>h2; THREE: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h3; FOUR: o_number &lt;= 4'</span></span>h4; FIVE: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h5; SIX: o_number &lt;= 4'</span></span>h6; SEVEN: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h7; EIGHT: o_number &lt;= 4'</span></span>h8; NINE: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'h9; A: o_number &lt;= 4'</span></span>hA; B: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'hB; C: o_number &lt;= 4'</span></span>hC; D: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'hD; E: o_number &lt;= 4'</span></span>hE; F: o_number &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-string"><span class="hljs-string">'hF; endcase endmodule</span></span></code> </pre> <br>  The scheme of the module in Vivado will be: <br><br><img src="https://habrastorage.org/web/65c/2df/19f/65c2df19fbd843ea92ace5a274098876.png"><br><br>  In short, you need to add the decoder module to the Vivado project as follows: Add Sources ‚Üí Add ‚Üí create ‚Üí ‚Üí ‚Üí Create File ‚Üí (write the file name) ‚Üí Ok ‚Üí Ok ‚Üí Ok ‚Üí Yes.  An empty Verilog file was created, after creating the file, you need to find it in the hierarchy of the MIPSfpga-plus system, write the decoder code and save it.  A more detailed description of how to add a module to a project and just how to work with Vivado is described in my previous article: <br><br>  <a href="https://habrahabr.ru/post/329808/">Porting MIPSfpga to other cards and integrating peripherals into the system.</a>  <a href="https://habrahabr.ru/post/329808/">Part 1</a> <br><br>  Now let's get down to connecting the inputs and outputs to the AHB-Lite bus and the physical outputs of our board. <br><br>  The mipsfpga_ahb hierarchy is: <br><br><img src="https://habrastorage.org/web/e05/126/a74/e05126a74d6b4b069d526cc1ac6f6ee1.png"><br><br>  For starters, in the Verilog Header directory, mfp_ahb_lite_matrix_config.vh, we will specify using the `define directive name of the peripheral we will connect.  To do this, we will find a line with the identifier for adding an illumination sensor to the system (for more information about the sensor, see the previous article): <br><br>  The line needs to be commented out, this will turn off all the lines related to the connection code of the light sensor to the AHB-Lite bus: <br><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//`define MFP_DEMO_LIGHT_SENSOR</span></span></code> </pre> <br>  Let's write and uncomment the line for our periphery: <br><br><pre> <code class="hljs">`define MFP_PMOD_KYPD</code> </pre> <br>  Open ‚Äúmfp_system‚Äù and find the connection strings for the instance of the light sensor: <br><br><pre> <code class="hljs">`ifdef MFP_DEMO_LIGHT_SENSOR</code> </pre> <br>  And next we add an instance of your decoder module: <br><br><pre> <code class="hljs css">`<span class="hljs-selector-tag"><span class="hljs-selector-tag">ifdef</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MFP_PMOD_KYPD</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kypd_decoder</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">kypd_decoder</span></span> ( <span class="hljs-selector-class"><span class="hljs-selector-class">.i_clk</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">SI_ClkIn</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.i_rst_n</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">KEY_0</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.o_col</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">KYPD_DATA</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[3:0]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.i_row</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">KYPD_DATA</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[7:4]</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.o_number</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">KYPD_OUT</span></span> ) ); `<span class="hljs-selector-tag"><span class="hljs-selector-tag">endif</span></span></code> </pre> <br>  The signals of the decoder module need to be connected to the bus instance mfp_ahb_lite_matrix_with_loader (where you can watch the required lines using the example of the integration of the illumination sensor using the module MFP_DEMO_LIGHT_SENSOR): <br><br><pre> <code class="hljs markdown"><span class="hljs-code"><span class="hljs-code">`ifdef MFP_PMOD_KYPD .KYPD_OUT ( KYPD_OUT ), `</span></span>endif</code> </pre> <br>  To connect the instances of the decoder module and bus, add a signal of the wire type: <br><br><pre> <code class="hljs markdown"><span class="hljs-code"><span class="hljs-code">`ifdef MFP_PMOD_KYPD wire [3:0] KYPD_OUT; `</span></span>endif</code> </pre> <br>  After connecting our decoder module to the bus, go to ‚Äúmfp_ahb_lite_matrix_with_loader‚Äù which is located in the hierarchy below the ‚Äúmfp_system‚Äù module and add an input / output port: <br><br><pre> <code class="hljs pgsql">`ifdef MFP_PMOD_KYPD <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] KYPD_OUT, `endif</code> </pre> <br>  Also add these signals to the instance ‚Äúmfp_ahb_lite_matrix‚Äù: <br><br><pre> <code class="hljs markdown"><span class="hljs-code"><span class="hljs-code">`ifdef MFP_PMOD_KYPD .KYPD_OUT ( KYPD_OUT ), `</span></span>endif</code> </pre> <br>  We will do the same in ‚Äúmfp_ahb_lite_matrix‚Äù which is located in the hierarchy below the ‚Äúmfp_ahb_lite_matrix_with_loader‚Äù module and add an input / output port: <br><br><pre> <code class="hljs pgsql">`ifdef MFP_PMOD_KYPD <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] KYPD_OUT, `endif</code> </pre> <br>  Also add these signals to the instance ‚Äúmfp_ahb_gpio_slave‚Äù: <br><br><pre> <code class="hljs markdown"><span class="hljs-code"><span class="hljs-code">`ifdef MFP_PMOD_KYPD .KYPD_OUT ( KYPD_OUT ), `</span></span>endif</code> </pre> <br>  Let's go to the ‚Äúmfp_ahb_gpio_slave‚Äù module, this is exactly the block (GPIO) in which we were so torn, we will add an input / output port: <br><br><pre> <code class="hljs pgsql">`ifdef MFP_PMOD_KYPD <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> [<span class="hljs-number"><span class="hljs-number">3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] KYPD_OUT, `endif</code> </pre> <br>  Now we need to change the ‚Äúmfp_ahb_gpio_slave‚Äù module so that it detects the I / O address with memory mapping (which we still define) and writes the data (HWDATA) into the register corresponding to the detected address: <br><br><pre> <code class="hljs scala">`ifdef <span class="hljs-type"><span class="hljs-type">MFP_PMOD_KYPD</span></span> `<span class="hljs-type"><span class="hljs-type">MFP_PMOD_KYPD_IONUM</span></span> : <span class="hljs-type"><span class="hljs-type">HRDATA</span></span> &lt;= { <span class="hljs-number"><span class="hljs-number">28</span></span><span class="hljs-symbol"><span class="hljs-symbol">'b0</span></span>, <span class="hljs-type"><span class="hljs-type">KYPD_OUT</span></span> }; `endif</code> </pre> <br>  To specify the address at which we will contact, open the header file "mfp_ahb_lite_matrix_config.vh" and add: <br><br><pre> <code class="hljs scala">`ifdef <span class="hljs-type"><span class="hljs-type">MFP_PMOD_KYPD</span></span> `define <span class="hljs-type"><span class="hljs-type">MFP_PMOD_KYPD_ADDR</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h1f800018</span></span> `endif</code> </pre> <br>  The GPIO module uses the lower bits of the address to determine which peripheral device should read or write information. <br><br><pre> <code class="hljs scala">`ifdef <span class="hljs-type"><span class="hljs-type">MFP_PMOD_KYPD</span></span> `define <span class="hljs-type"><span class="hljs-type">MFP_PMOD_KYPD_IONUM</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span><span class="hljs-symbol"><span class="hljs-symbol">'h6</span></span> `endif</code> </pre> <br>  Let's go back through the hierarchy to the mfp_system module and add I / O ports: <br><br><pre> <code class="hljs pgsql"> `ifdef MFP_PMOD_KYPD <span class="hljs-keyword"><span class="hljs-keyword">inout</span></span> [<span class="hljs-number"><span class="hljs-number">7</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>] KYPD_DATA, <span class="hljs-keyword"><span class="hljs-keyword">input</span></span> KEY_0, `endif</code> </pre> <br>  It is worth noting that these are not exactly the ports that we connected to the bus.  Go to the top module shell (I have "cmoda7") and add to the instance "mfp_system" line: <br><br><pre> <code class="hljs css"> `<span class="hljs-selector-tag"><span class="hljs-selector-tag">ifdef</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MFP_PMOD_KYPD</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.KYPD_DATA</span></span> ( <span class="hljs-selector-tag"><span class="hljs-selector-tag">JA</span></span> ), <span class="hljs-selector-class"><span class="hljs-selector-class">.KEY_0</span></span> ( ~ <span class="hljs-selector-tag"><span class="hljs-selector-tag">i_btn1</span></span> ), `<span class="hljs-selector-tag"><span class="hljs-selector-tag">endif</span></span></code> </pre> <br>  Thus, we added the module of our decoder to JA [7: 0] pins and connected the decoder to the processor via the AHB-Lite bus. <br><br>  In our case, the JA I / O ports in the module shell and in the restriction file (I have ‚Äúcmoda7.xdc‚Äù) will not need to be added because they have already been used for the light sensor.  But in other cases, such actions will be required, because for understanding I will simply show these lines: <br><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">module</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cmoda7</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ... ... ... inout [ </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">7</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">] JA )</span></span></span></span>;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">cmoda7.xdc</b> <div class="spoiler_text"><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">## Pmod Header JA set_property -dict {PACKAGE_PIN G17 IOSTANDARD LVCMOS33} [get_ports {JA[0]}] set_property -dict {PACKAGE_PIN G19 IOSTANDARD LVCMOS33} [get_ports {JA[1]}] set_property -dict {PACKAGE_PIN N18 IOSTANDARD LVCMOS33} [get_ports {JA[2]}] set_property -dict {PACKAGE_PIN L18 IOSTANDARD LVCMOS33} [get_ports {JA[3]}] set_property -dict {PACKAGE_PIN H17 IOSTANDARD LVCMOS33} [get_ports {JA[4]}] set_property -dict {PACKAGE_PIN H19 IOSTANDARD LVCMOS33} [get_ports {JA[5]}] set_property -dict {PACKAGE_PIN J19 IOSTANDARD LVCMOS33} [get_ports {JA[6]}] set_property -dict {PACKAGE_PIN K18 IOSTANDARD LVCMOS33} [get_ports {JA[7]}]</span></span></code> </pre><br></div></div><br>  And if we recall in ‚Äúmfp_ahb_lite_matrix_config.vh‚Äù we commented out the line: <br><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//`define MFP_DEMO_LIGHT_SENSOR</span></span></code> </pre> <br>  thus, during the synthesis of the system, all the code written between <br><br><pre> <code class="hljs markdown"><span class="hljs-code"><span class="hljs-code">`ifdef MFP_DEMO_LIGHT_SENSOR ... `</span></span>endif</code> </pre> <br>  will be ignored, and there will be no port conflicts. <br><br>  We can see the scheme of the created MIPSfpga-plus system with a built-in decoder for our keyboard, for this, open the tab RTL Analysys ‚Üí Open Elaborated Design ‚Üí Schematic.  The entire system diagram is displayed here to check the correctness of the connected module of the decoder, it is advisable to go through the RTL Netlist and check all contacts. <br><br>  Now you can generate a bitstream file (.bit) and load it into FPGA. <br><br>  We write a simple program for the interaction of the keyboard and processor. <br><br>  To download the code to the system, go to the folder downloaded mipsfpga plus ‚Üí github ‚Üí mipsfpga-plus ‚Üí programs ‚Üí 01_pmod_kypd open ‚Äúmfp_memory_mapped_registers.h‚Äù <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MFP_PMOD_KYPD_ADDR 0xBF800018  #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MFP_PMOD_KYPD (* (volatile unsigned *) MFP_PMOD_KYPD_ADDR )</span></span></code> </pre><br>  next, open main.c and write a couple of lines to demonstrate: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mfp_memory_mapped_registers.h"</span></span></span><span class="hljs-meta"> int main () { int n = 0; for (;;) { MFP_7_SEGMENT_HEX = MFP_PMOD_KYPD; } return 0; }</span></span></code> </pre><br>  After in the folder we find the script that compiles the code: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">02</span></span>_compile_and_link</code> </pre><br>  Generate the motorola_s_record file: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">08</span></span>_generate_motorola_s_record_file</code> </pre> <br>  Check to which COM port the USB UART converter is connected: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">11</span></span>_check_which_com_port_is_used</code> </pre> <br>  Modify the 12_upload_to_the_board_using_uart file: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">set</span></span> a=<span class="hljs-number"><span class="hljs-number">7</span></span> mode com%a% baud=<span class="hljs-number"><span class="hljs-number">115200</span></span> parity=n data=<span class="hljs-number"><span class="hljs-number">8</span></span> stop=<span class="hljs-number"><span class="hljs-number">1</span></span> to=off xon=off odsr=off octs=off dtr=off rts=off idsr=off type program.rec &gt;\.\COM%a%</code> </pre> <br>  where a is the number of the COM port to which the USB UART converter is connected.  And load the program: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">12</span></span>_upload_to_the_board_using_uart</code> </pre> <br>  Result: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/h1uKdSAKOwA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  In the next part, I‚Äôll tell you how to add to the MIPSfpga built-in cmoda7 OCA, and LCD display from Nokia 5100. <br><br>  <a href="https://habrahabr.ru/post/329854/">Porting MIPSfpga to other cards and integrating peripherals into the system.</a>  <a href="https://habrahabr.ru/post/329854/">Part 3</a> </div><p>Source: <a href="https://habr.com/ru/post/329852/">https://habr.com/ru/post/329852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329836/index.html">Security in web development: checklist</a></li>
<li><a href="../329838/index.html">Apache Spark - advantages, disadvantages, wishes</a></li>
<li><a href="../329840/index.html">DevOps on Amazon AWS</a></li>
<li><a href="../329842/index.html">"For the same functionality that SQL Server provides, Oracle asks 10 times more," - Konstantin Taranov about SQL Server</a></li>
<li><a href="../329844/index.html">Ruby on Rails agreement. Part 3</a></li>
<li><a href="../329854/index.html">Porting MIPSfpga to other cards and integrating peripherals into the system. Part 3</a></li>
<li><a href="../329856/index.html">Postgres and Void</a></li>
<li><a href="../329858/index.html">Comparison of Elbrus-4–° and Elbrus-8–° in several problems of computer vision</a></li>
<li><a href="../329862/index.html">Remote connection to protected computers from corporate antivirus</a></li>
<li><a href="../329864/index.html">Chip for smart cameras ELISE - one of the most high-tech products in Russia in 2017. Developer fee and camera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>