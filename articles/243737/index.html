<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Evolution: graphics and mechanics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In January of this year, our gaming department released the mobile game Evolution: Battle for Utopia. The game was well received, people like to play ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Evolution: graphics and mechanics</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://habrahabr.ru/company/mailru/blog/243737/"><img src="https://habrastorage.org/files/8e9/892/e7e/8e9892e7eedd460c82fb68acea2baa99.jpg"></a> <br><br>  In January of this year, our gaming department released the mobile game Evolution: Battle for Utopia.  The game was well received, people like to play it.  I often see people with "Evolution" in the subway.  I even started to make wishes when I find myself between players.  And in this post, prepared according to my report at KRI 2014, I would like to tell you more about the development process and the features of the ‚ÄúEvolution‚Äù. <br><a name="habracut"></a><br>  Recently we have released a large content update ‚ÄúBlack Legion‚Äù.  It naturally attracted a lot of new players, but most importantly, we returned most of our players who have already gone through the main storyline.  In this article I will talk about how our game mechanics developed during the development process.  Briefly mention the third-party tools that we used.  And I will pay more attention to the graphic "chips", I will tell you how to get real dynamic shadows and dynamic lighting on weak devices. <br><br><h1>  Game mechanics </h1><br>  At the beginning of development, in the first concepts, ‚ÄúEvolution‚Äù looked quite different than it is now.  We had two cameras, split screen, and they displayed two armies, which were located quite far from each other.  This distance between them was not felt at all.  For example, one army throws grenades.  They fly to the center of the screen, disappear for a while and then appear on the second part of the screen.  The players were uncomfortable.  We did some research, drew various schemes, brainstormed, invented a new mechanic and gameplay.  Then they slowly began to realize all this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/236/090/03d/23609003d81449878eafef1dd08070df.jpg"><br><br>  In earlier versions, we didn't even have auto-fire.  We forced the player to constantly press the appropriate button to shoot at the selected opponent.  Plus, we had a sight imitating the dispersion of bullets during recoil: you shoot, the scope moves apart and begins to gradually converge.  Until it is reduced, you do a little less damage.  It was all too difficult, even for our hardcore audience.  At this time, the game "Dead Trigger 2" was released.  This is the usual First Person Shooter.  But, to our surprise, auto-fire was introduced in this game.  We looked, tried to introduce a similar control scheme in Evolution and came to such mechanics, which is presented in the game today. <br><br><img src="https://habrastorage.org/files/632/61a/bce/63261abcee964a67ae1f43e70df5bb44.jpg"><br><br>  Do not be afraid to develop your project.  This is the price of the original gameplay that you have to pay as developers.  If you have an original game mechanic, then you need to check it on real people, you may have to give up something, you will have to add something. <br><br><h1>  Third Party Tools </h1><br>  In our game, almost 80% of all game mechanics are built around a GUI.  In ‚ÄúJuggernaut‚Äù we used our own developed GUI system, it still works in some state there.  But when we designed the Evolution, we looked at what was offered on the market.  So we found NGUI and compared its functionality with what we had.  After that, they came to the conclusion that we will either have to complete our system for several months, or we can take a ready-made solution. <br><br>  We use <a href="http://www.tasharen.com/%3Fpage_id%3D140">NGUI</a> version 2.2.3, which had several bugs.  We have a lot of things in it patch.  For example, they wrote an automatic scaling for different resolutions and a special atlas manager that unloads large textures when changing screens.  Due to this, the lags disappeared when switching screens and stopped falling from memory. <br><br><img src="https://habrastorage.org/files/71c/bf0/560/71cbf0560c7e42609b96fde274501b7b.png"><br><br>  Look at these buildings, they are animated in the game.  This is the usual flash animation.  To import it, we used another tool called <a href="http://uniswf.com/">uniSWF</a> .  They interact well with NGUI. <br><br>  Another great framework we used in Evolution is <a href="http://www.hutonggames.com/">PlayMaker</a> .  When we started to design the ‚ÄúEvolution‚Äù, we needed some kind of technology for animated and, in general, for gaming machines of states (Finite state machines or finite state machines).  The technology of <a href="http://unity3d.com/unity/animation">Mecanim</a> at that time was in its infancy, and did not allow us to do something very necessary for us, namely, to switch animation sets.  The player can take into battle two types of weapons - a pistol and something heavier: a machine gun, a shotgun, etc.  Mecanim was not allowed to do this in that state of development.  Therefore, we have taken the PlayMaker technology as a basis, which not only allows us to describe a good state machine for animation, but also allows us to add some logic from the scripts. <br><br><h1>  Lighting system </h1><br>  For Evolution, we wrote our own lighting system.  In general, why write something of your own, if everything is already ready in the engine, just take it and use it?  The thing is that the systems built into Unity are pretty versatile.  For maintenance of these systems have to pay performance.  Especially if the target device is poorly productive.  In fact, you need to pay for a universal lighting system with your FPS.  Therefore, we abandoned this approach in favor of the so-called Dynamic Light Probe.  We also completely abandoned the conventional dynamic light sources that Unity has.  We cover all static geometry using Lightmap.  For the characters we use a special Light Probe, and our own shader. <br><br>  Light Probe is a spherical harmonic containing information about the light at a specified point.  There are dozens of such Light Probe on stage.  The engine selects the 4 closest to the character Light Probe and interpolates them into one.  Then we add light to it from our special dynamic light sources.  Thus, it turns out Dynamic Light Probe - i.e.  spherical harmonic with the addition of dynamic light.  After this, the rendering of the character with a shader that can work with spherical harmonics begins. <br><br><img src="https://habrastorage.org/files/e1a/7fd/ba9/e1a7fdba9bc6417d97d9fcaef51d8822.png"><br><br>  If you imagine a spherical harmonic simplified, then its functionality will be similar to the cubic texture (Cube map).  In the shader, we sample the spherical harmonics by vector (similar to the Cube map).  For diffuse illumination we use the surface normal vector, for specular - the reflected vector of gaze. <br><br>  Diffuse lighting is considered to be in a vertex shader, reflected - in a pixel shader.  Thus, we are for one Draw Call render character model with dynamic lighting from multiple light sources. <br><br><h1>  Shadows </h1><br>  Before joining Mail.Ru Group, for several years I developed my own engine, and managed to work out almost all algorithms for rendering shadows and lighting, and I understand how Unity and shadow rendering works in particular.  It uses shadow mapping, or rather PSSM - parallel split shadow mapping.  It is not possible on a weak device to get a high FPS using this technique. <br><br>  Therefore, I have developed three systems to try which one will be more productive.  I stopped at the planar-shadows algorithm, or shadows, which are drawn on a plane.  This is the easiest algorithm, but at the same time the most productive. <br><br>  What are planar shadows?  This is a rendering of the same model, only flattened along one of the axes to zero.  The selection of the scaling axis depends on the angle of the light source. <br><br>  On the Internet you can find a bunch of examples of how to calculate such a scaling matrix.  I would like to focus on other aspects.  First is the shadow blending.  If you blend it directly, you get such artifacts as in the following figure. <br><br><img src="https://habrastorage.org/files/e68/162/fad/e68162fad0ca4c0d9a2cc87ffe8f170d.png"><br><br>  Where several polygons intersect, they blend several times.  And the shadow turns out in some places more darkly.  How to deal with it?  We draw all these shadows first in the stencil buffer, disabling the record in the back buffer.  Then, when all the shadows are in the stencil buffer, we make the final rendering pass, on which we fill the entire screen with the desired color, taking into account the stencil mask.  We get the correct dynamic shadows, which in no way (!) Affect the FPS.  Secondly, planar shadows can only be rendered on flat surfaces (no wonder they are called planar shadows). <br><br><img src="https://habrastorage.org/files/403/302/d18/403302d1804e41d8bc222087a2e88426.png"><br><br>  With this fight does not make sense, in our opinion.  We simply reworked the content so that the shadows always fall on a continuous plane. <br><br><h1>  Post effects </h1><br>  The standard post effects solution used in all Unity examples is the use of the <i>OnRenderImage</i> method.  Its essence is as follows: not only programmers work with Unity, but also game designers, artists, animators and other specialists.  They all have different qualifications, and Unity developers are forced to make universal decisions so that users simply take the engine out of the box and get some more or less working post-process.  Because of this versatility, Unity resorted to the following technique - they copy the back buffer into a separate texture for you and give it to you for processing.  What is the problem here?  Copying back buffer to a texture on iPad 2 will kill more than half of the FPS.  Even a simple method call <i>OnRenderImage</i> without further processing reduces performance by more than 2 times.  How to deal with it?  We specify a separate render texture for the camera and process it in the <i>OnPostRender</i> method.  The only thing that needs to be done additionally is to draw the result in the back buffer. <br><br><img src="https://habrastorage.org/files/424/5b5/1fd/4245b51fdbc04eef9ec685b773eaa51d.png"><br><br>  Also, if possible, if you can figure out how to replace such a powerful pixel post-process with some kind of geometric effects, then this should be done, because geometric effects work obviously faster. <br><br><img src="https://habrastorage.org/files/02e/730/346/02e730346971433b9689791ac58914dd.png"><br><br>  A couple of words about the geometric post-process: since we still render the whole scene into our render-texture, we can later use it as we like.  In this case, by drawing a sniper scope, we impose a texture on a specially prepared mesh, whose texture coordinates are stretched, in such a way that it creates the impression of refraction at the edges.  In dynamics, it looks as if you are looking through a lens.  This post process does not affect the FPS at all. <br><br>  With these methods and tricks we got our 30 FPS (and higher) on iPad 2 and iPhone 4S.  With some effort, we got, practically, free-of-charge dynamic lighting and shadows in terms of performance.  We have come a long way to develop, have changed a lot of mechanics and approaches to get the game that you see now.  If you have any questions, I will be glad to answer them in the comments. <br><br>  Presentation with KRI: <br><br><div class="slideshow"><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=http://www.slideshare.net/slideshow/embed_code/42043386&amp;xid=25657,15700021,15700186,15700191,15700253&amp;usg=ALkJrhiE4dubrcNLzJyHmDaaYL3TLBmTFQ" width="425" height="355" frameborder="0" marginwidth="0" marginheight="0" scrolling="no"></iframe></div><br>  <i>Alexander Chernyakov</i> <i><br></i>  <i>IT Territory Programmer, Mail.Ru Group Studios</i> </div><p>Source: <a href="https://habr.com/ru/post/243737/">https://habr.com/ru/post/243737/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243723/index.html">Gov.uk: basic aspects of the agile methodology</a></li>
<li><a href="../243725/index.html">Cooling server. Divide and rule</a></li>
<li><a href="../243727/index.html">Just backup btrfs</a></li>
<li><a href="../243731/index.html">Update on Android 5 Lolipop kills self-signed applications without the possibility of recovery</a></li>
<li><a href="../243733/index.html">The Seven Laws of the Jedi Freelancer</a></li>
<li><a href="../243741/index.html">Cards, money, two ... factors</a></li>
<li><a href="../243743/index.html">To the issue of costing</a></li>
<li><a href="../243747/index.html">Learn WatchKit - create the first application for Apple Watch</a></li>
<li><a href="../243749/index.html">Unity3D nonplayer application</a></li>
<li><a href="../243751/index.html">"Holes" of startups: the most common problems of young companies that hinder their development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>