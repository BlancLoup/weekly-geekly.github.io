<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple DICOM client on GO with task balancer and web interface</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi Habr! Recently, I have been very keen on developing in the GO language. Elegant and expressive programming language. I have long wanted to do somet...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple DICOM client on GO with task balancer and web interface</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/7a6/072/855/7a6072855a2a468fb6560fb42ad0b478.jpeg"><br>  Hi Habr!  Recently, I have been very keen on developing in the GO language.  Elegant and expressive programming language.  I have long wanted to do something useful.  According to the specifics of my work, I have to work with medical archives of DICOM-images PACS. <br><a name="habracut"></a><br><br>  Github: <a href="https://github.com/Loafter/dtools">github.com/Loafter/dtools</a> <br>  Linux-amd64 version: <a href="https://github.com/Loafter/dtools/releases/download/1.0/dcmjsser">github.com/Loafter/dtools/releases/download/1.0/dcmjsser</a> <br><br>  I decided it was time to create my dicom-client with (blackjack ..) web interface, which can perform the following standard operations: <br><ul><li>  Dicom ping; </li><li>  Download research; </li><li>  Loading research </li><li>  As well as the search for details </li></ul><br>  (c-echo, c-move, c-store, c-find, respectively). <br>  The GrassRoot SDK library was chosen as dicom-library.  Our client will be parallelizing tasks.  Go language is well adapted for this. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      A similar work scenario was described by <a href="http://habrahabr.ru/post/198150/">habrahabr.ru/post/198150</a> . <br>  Our script is somewhat different: <br>  We have a certain task balancer that receives tasks from a dicom-service, checks the possibility of execution and executes them asynchronously.  In order to avoid a situation where 1000 tasks are executed in parallel, we implement the task queue so that there are active tasks and those that are in the sleeping state.  By default, only 10 tasks will be active.  Otherwise, we could do without a balancer at all, stupidly in parallel to perform 1000 tasks in parallel without any control. <br>  All code balancer is in the file job_ballancer.go. <br><br>  At the beginning there is a description of handler interfaces.  If the work was completed successfully, in the event that the error and the process of processing the task were returned. <br><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> JobDispatcher <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { Dispatch(<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}) (<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{}, error) } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> ErrDispatcher <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { DispatchError(FaJob) error } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> CompDispatcher <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { DispatchSuccess(CompJob) error }</code> </pre> <br><br>  When we create a dispatcher instance, we initialize it with the appropriate handlers. <br><pre> <code class="go hljs">srv.jbBal.Init(&amp;srv.dDisp, srv, srv) <span class="hljs-comment"><span class="hljs-comment">//   type JobBallancer struct { jChan chan interface{} //      acJob map[string]Job //   slJob map[string]Job //   errDisp ErrDispatcher //   error jobDisp JobDispatcher //  compDisp CompDispatcher //    JbDone sync.WaitGroup //    aJobC int //  () } //  func (jbal *JobBallancer) Init(jdis JobDispatcher, cmd CompDispatcher, erd ErrDispatcher) { jbal.errDisp = erd jbal.jobDisp = jdis jbal.compDisp = cmd jbal.acJob = make(map[string]Job) jbal.slJob = make(map[string]Job) jbal.aJobC = 10 jbal.jChan = make(chan interface{}) go jbal.takeJob() //     //  log.Println("info: job ballancer inited") }     .  , ..    ,   takeJob    . func (jbal *JobBallancer) PushJob(jdat interface{}) error { if jbal.checkInit() { return errors.New("error: JobChan is not inited") } uid := genUid() job := Job{JobId: uid, Data: jdat} jbal.jChan &lt;- job return nil } func (jbal *JobBallancer) takeJob() { for { //    recivedTask := &lt;-jbal.jChan log.Println("info: job taken") switch job := recivedTask.(type) { case TermJob: //         log.Println("info: recive terminate dispatch singal") return case Job: //  (             ) if len(jbal.acJob) &lt; jbal.aJobC { jbal.JbDone.Add(1) jbal.addActiveJob(job) go jbal.startJob(job) log.Println("info: normal dispatch") } else { jbal.addSleepJob(job) jbal.JbDone.Add(1) log.Println("info: attend maximum active job") } case CompJob: //   if err := jbal.compDisp.DispatchSuccess(job); err != nil { log.Println("error: failed dispatch success" + job.Job.JobId) } //       jbal.removeJob(job.Job.JobId) jbal.JbDone.Done() jbal.resumeJobs() case FaJob: //   if err := jbal.errDisp.DispatchError(job); err != nil { log.Println("error: failed dispatch error" + job.Job.JobId) } //      jbal.removeJob(job.Job.JobId) jbal.JbDone.Done() jbal.resumeJobs() default: log.Fatalln("error: unknown job type") jbal.JbDone.Done() } } } //   func (jbal *JobBallancer) removeJob(jid string) error { if _, isFind := jbal.acJob[jid]; isFind { delete(jbal.acJob, jid) } else { return errors.New("error: can't remove job because job with id not found") } return nil } //     ,        ,      func (jbal *JobBallancer) TerminateTakeJob() error { if jbal.checkInit() { return errors.New("error: is not inited") } jbal.JbDone.Wait() jbal.jChan &lt;- TermJob{} close(jbal.jChan) if len(jbal.acJob) &gt; 0 { return errors.New("error: list job is not empty") } log.Println("info: greacefully terminate take job") return nil }</span></span></code> </pre><br><br>  We will not consider the remaining auxiliary functions.  full code can be viewed <br>  <a href="">github.com/Loafter/dtools/blob/master/dcmjsser/job_ballancer.go</a> <br><br>  Despite that the code is not complicated and I have been thinking about it for a long time.  But still, to test the reliability, I implemented a load test for dozens of tasks: <br><pre> <code class="go hljs">testJobDispatcher := TestJobDispatcher{} testErrorDispatcher := TestErrorDispatcher{} testSuccessDispatcher := TestCompletedDispatcher{} jobBallancer := JobBallancer{} jobBallancer.Init(&amp;testJobDispatcher, &amp;testSuccessDispatcher, &amp;testErrorDispatcher) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">40</span></span>; i++ { jobBallancer.PushJob(<span class="hljs-string"><span class="hljs-string">"data: "</span></span> + strconv.Itoa(i)) } jobBallancer.TerminateTakeJob()</code> </pre><br>  He worked fine.  All tasks were completed, and the TerminateTakeJob function ended when all tasks were completed.  To control the work done, the sync.WaitGroup JbDone synchronization object is used, which counts the number of completed jobs.  As I noted above, the code of the balancer is universal and in order for our balancer to work differently, it is enough for us to instantiate it with the appropriate handlers. <br><br>  As well as in the last hand-made article) (http://habrahabr.ru/post/247727/) I implemented the application interface as a web interface. <br><img src="//habrastorage.org/files/15c/a5f/da3/15ca5fda32964d42a9360af3abe3fa19.png"><br><br>  For the test, I used the public dicom-archive 213.165.94.158:11112.  You can download studies from it if there is a direct ip and if the port 11112 is open on the client side. I also checked the work on the free dcm4che archive archive <a href="http://sourceforge.net/projects/cdmedicpacsweb/files/latest/download%3Fsource%3Dfiles">sourceforge.net/projects/cdmedicpacsweb/files/latest/download?source=files</a> . <br>  I managed to build a working version for Linux, unfortunately I could not build it under Widows.  The grassroot library was successfully built, but the error occurs when the application itself is linked. <br>  cmd / ld: Malformed PE file: Unexpected flags for PE section. <br><br>  Much has been written about this error here: <a href="https://github.com/golang/go/issues/4069">github.com/golang/go/issues/4069</a> . <br>  Unfortunately, I‚Äôm not so familiar with the intricacies of the build, so I only got the Linux version.  Maybe the ‚Äúhabra-effect‚Äù will get this problem off the ground.  For Windows users who want to check and see how it works, I prepared a CoreOS based virtual machine (https://yadi.sk/d/y81KC-tyfar6A).  In the demo machine, our dicom client works as a systemd service. <br>  If you have the desire, for example, you can implement a service that downloads research from various dicom-nodes, and puts it in a zip-archive for download.  You can use json messages to control the service, just like our GUI does. <br>  And you can do what I did: screw some html5 web viewer into our application. <br><br><img src="//habrastorage.org/files/7d4/994/d68/7d4994d686974d72bb8045a784e5227b.png"></div><p>Source: <a href="https://habr.com/ru/post/254581/">https://habr.com/ru/post/254581/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254565/index.html">Top 5 most stupid antiviruses. Notes bully</a></li>
<li><a href="../254567/index.html">Backslant - slim styling engine</a></li>
<li><a href="../254569/index.html">Reactive programming in the tabular processor</a></li>
<li><a href="../254571/index.html">Files are different or the story about the "file" for java programs</a></li>
<li><a href="../254577/index.html">Golden rule of backup</a></li>
<li><a href="../254583/index.html">Another XSS on SoundCloud</a></li>
<li><a href="../254587/index.html">Factorial on Church numbers - now in emoticons</a></li>
<li><a href="../254591/index.html">A simple gaming TV set-top box on the Arduino</a></li>
<li><a href="../254593/index.html">Import Substitution Part 2. Huawei OceanStor Family</a></li>
<li><a href="../254597/index.html">Five obvious mistakes that for some reason continue to make</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>