<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Subtleties nodejs. Part I: the notorious app.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have been working with node.js for more than three years and during this time I managed to become familiar with the platform, its strengths and weak...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Subtleties nodejs. Part I: the notorious app.js</h1><div class="post__text post__text-html js-mediator-article">  I have been working with node.js for more than three years and during this time I managed to become familiar with the platform, its strengths and weaknesses.  During this time, the platform has changed a lot, just like javascript itself.  The idea of ‚Äã‚Äãusing one medium on both the server and the client was much to the liking.  Still would!  It is convenient and easy!  But, unfortunately, in practice, everything turned out to be not so rosy, along with the pluses, the platform absorbed the minuses of the language used, and the different approach to implementation almost nullified the advantages of using a single environment.  So all attempts to implement server js before the node did not take off, take the same Rhino.  And, most likely, the node was waiting for the same fate, if not for the legendary V8, non-blocking code and amazing performance.  That is why developers love it so much.  In this series of articles, I will try to talk about the problems that are unobvious at first glance and the intricacies of work that you will encounter in the development on nodejs. <br><br><a name="habracut"></a><br><br>  At once I will make a reservation that the recommendations are more applicable to large projects with a complex structure. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I want to start with the most common and common implementation of the application - the main entry point - app.js, using the example of a web application using express.  It usually looks like this: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// config.js exports.port = 8080; // app.js var express = require('express'); var config = require('./config.js'); var app = express(); app.get('/hello', function(req, res) { res.end('Hello world'); }); app.listen(config.port);</span></span></code> </pre>  At first glance, everything is fine, the code is clear, the configuration is moved to a separate file and can be changed for virgin and production.  Such an implementation is found on all resources devoted to the creation of web applications on nodejs.  So we laid the foundation of our error in ten lines of the purest code.  But first things first. <br><br>  And so, we wrote hello world.  But, this is an overly abstract example.  Let's add specifics and write an application that will display a list of files from the specified directory and display the contents of individual files, requesting data from mongo. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// config.js exports.port = 8080; exports.mongoUrl = 'mongodb://localhost:27017/test'; // app.js var express = require('express'); var MongoClient = require('mongodb').MongoClient; var config = require('./config.js'); //     var db; MongoClient.connect(config.mongoUrl, function(err, client){ if (err) { console.error(err); process.exit(1); } db = client; }); //  - var app = express(); app.get('/', function(req, res, next) { db.collection('files').find({}).toArray(function(err, list){ if (err) return next(err); res.type('text/plain').end(list.map(function(file){ return file.path; }).join('\r')); }); }); app.get('/file', function(req, res, next){ db.collection('files').findOne({path:req.query.file}).toArray(function(err, file){ if (err) return next(err); res.type('text/plain').end(file.content); }); }); app.listen(config.port);</span></span></code> </pre>  Ok, everything is simple and clear: connect to the base, create a server, assign handles for the paths.  But let's think about what disadvantages the code has: <br><br><ol><li>  It is difficult to test it, since there is no possibility to directly check the result returned by the methods. </li><li>  It is difficult to configure - it is impossible to change the configuration for two instances of the application. </li><li>  Application components are not available for external code, and therefore for the extension. </li><li>  Errors are not transmitted anywhere and must be processed on the spot or thrown to the highest level. </li></ol><br>  In practice, this leads to a monolithic code.  And fast refactoring.  What can be done?  It is necessary to separate the logic and interface. <br>  As for the application, let's leave everything in app.js, and everything as regards the web http interface in http.js. <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// app.js var MongoClient = require('mongodb').MongoClient; var EventEmitter = require('event').EventEmitter; var util = require('util'); module.exports = App; function App(config) { var self = this; //  event emitter EventEmitter.call(this); MongoClient.connect(config.mongoUrl, function(err, db){ if (err) return self.emit("error", err); self.db = db; }); this.list = function(callback) { self.db .collection('files') .find({}) .toArray(function(err, files){ if (err) return callback(err); files = files.map(function(file){ return file.path }); callback(null, files); }); }; this.file = function(file, callback) { self.db .collection('files') .findOne({path:file}) .toArray(callback); }; } util.inherits(App, EventEmitter); // config.js exports.mongoUrl = "mongo://localhost:27017/test"; exports.http = { port : 8080 }; // http.js var App = require('./app.js'); var express = require('express'); var configPath = process.argv[2] || process.env.APP_CONFIG_PATH || './config.js'; var config = require(configPath); var app = new App(config); app.on("error", function(err){ console.error(err); process.exit(1); }); var server = express(); server.get('/', function(req, res, next){ app.list(function(err, files){ if (err) return next(err); res.type('text/plain').end(files.join('\n')); }); }); server.get('/file', function(req, res, next){ app.file(req.query.file, function(err, file){ if (err) return next(err); res.type('text/plain').end(file); }); }); server.listen(config.http.port);</span></span></code> </pre>  What have we done?  Added event model for catching errors.  Added the ability to specify the configuration path for each application instance. <br>  Thus, we got rid of the problems listed above: <br><ol><li>  Any method is directly accessible via the app object. </li><li>  Configuration management has become flexible: you can specify the path in the console or via export APP_CONFIG_PATH = ... </li><li>  Appeared centralized access to components. </li><li>  Application errors are caught by the app object and can be handled with context. </li></ol><br>  Now we can easily add a new command line interface: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// cli.js var App = require('./app.js'); var program = require('commander'); var app; program .version('0.1.0') .option('-c, --config &lt;file&gt;', 'Config path', 'config.js', function(configPath){ var config = require(configPath); app = new App(config); app.on("error", function(err){ console.error(err); process.exit(1); }); }); program.command('list') .description('List files') .action(function(){ app.list(function(err, files){ if (err) return app.emit("error", err); console.log(files.join('\n')); }); }); program.command('print &lt;file&gt;') .description('Print file content') .action(function(cmd){ app.file(cmd.file, function(err, file){ if (err) return app.emit("error", err); console.log(file); }); });</span></span></code> </pre>  or test <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// test.js var App = require('App'); var app = new App({ mongoUrl : "mongo://testhost:27017/test" }); //       : // {path:'README.md', content:'This is README.md'} app.on("error", function(err){ console.error('Test failed', err); process.exit(1); }); //     nodeunit module.exports = { "Test file list":function(test) { app.list(function(err, files){ test.ok(Array.isArray(files), "Files is an Array."); test.equals(files.length, 1, "Files length is 1."); test.equals(file[0], "README.md", "Filename is 'README.md'."); test.done(); }); } }</span></span></code> </pre>  Of course, the application now does not look as minimalistic as in the examples, but it is more flexible.  In the next part I will tell about catching errors. </div><p>Source: <a href="https://habr.com/ru/post/241788/">https://habr.com/ru/post/241788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../241772/index.html">Report from SQA Days - Automation testing: discarding too much and checking the essence</a></li>
<li><a href="../241774/index.html">Interactive site with post-hawk? Easy!</a></li>
<li><a href="../241776/index.html">Expressive JavaScript: E-Life Project</a></li>
<li><a href="../241778/index.html">How we did the school of mobile developers in Saransk</a></li>
<li><a href="../241784/index.html">Incompatibility between the String.split method in Java 8 and Java 7</a></li>
<li><a href="../241792/index.html">E-mail marketing: about the frequency of mailings - bluntly</a></li>
<li><a href="../241796/index.html">HTML5 standard has reached W3C recommendation status</a></li>
<li><a href="../241798/index.html">From bike to ...</a></li>
<li><a href="../241804/index.html">JBOSS 4.2.3 Manual</a></li>
<li><a href="../241810/index.html">GDP, money supply and dynamic equilibrium</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>