<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TDD implementation rules in the old project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article ‚ÄúSliding responsibility of the Repository pattern‚Äù raised several questions that are very difficult to answer. Do I need a repository, if ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TDD implementation rules in the old project</h1><div class="post__text post__text-html js-mediator-article">  The article <a href="https://habrahabr.ru/post/304824/">‚ÄúSliding responsibility of the Repository pattern‚Äù</a> raised several questions that are very difficult to answer.  Do I need a repository, if it is completely impossible to abstract from technical details?  How complicated can the repository be so that its writing remains appropriate?  The answer to these questions differs depending on the emphasis that is being made when developing systems.  Probably the most difficult question: is a repository necessary at all?  The problem of "fluid abstraction" and the increase in coding complexity with an increase in the level of abstraction make it impossible to find a solution that would satisfy both camps.  For example, in reporting, intention design leads to the creation of a large number of methods for each filter and sorting, while a generic solution creates a large overhead on coding.  You can continue indefinitely ... <br><br>  For a more complete picture, I looked at the problem of abstractions from the side of applying them in the already ready code, in the legacy code.  The repository, in this case, we are only interested in, as a tool for achieving high-quality and meaningless code.  Of course, this pattern is not the only thing necessary for the application of TDD practices.  After eating ‚Äútasteless food‚Äù in several large projects and watching what works and what doesn't, I brought out for myself a few rules that help me follow TDD practices.  I am pleased to hear constructive criticism and other techniques for implementing TDD. <br><a name="habracut"></a><br><h3>  Foreword </h3><br>  Some may notice that in the old project it is impossible to apply TDD.  There is an opinion that different types of integration tests (UI-tests, end-to-end) are more suitable for them, since  it‚Äôs too hard to figure out the old code.  You can also hear that writing tests before encoding itself only leads to loss of time, since  we may not know how the code will work.  I had to work in several projects where I was limited only to integration tests, considering that unit tests are not indicative.  At the same time, a lot of tests were written, they launched a bunch of services, etc., etc. As a result, only one person could actually figure this out, who actually wrote them. <br><br>  During my practice I managed to work on several very large projects, where there was a lot of legacy code.  In some there were tests, in others they were only going to implement it.  I myself managed to raise 2 large projects.  And everywhere I somehow tried to apply the TDD approach.  In the initial stages of understanding TDD, it was perceived as Test First development.  But the further, the more clearly the differences between this simplified understanding and the current presentation, called shortly BDD, were visible.  Whatever language is used, the main points that I called the rules remain similar.  Someone may find parallels between the rules and other good code writing principles. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Rule 1: Use Bottom-Up (Inside-Out) </h3><br>  This rule is more relevant to the way software is analyzed and designed when new pieces of code are embedded in an existing project. <br><br>  When you are designing a new project, it is absolutely natural to represent the entire system.  At this stage, you control the set of components and the future flexibility of the architecture.  Therefore, you can write modules that are conveniently and better integrated with each other.  Such a top-down approach allows you to perform a good upfront design of the future architecture, describe the necessary guidelines and have a holistic view of what you want in the end.  After some time, the project turns into what is called the legacy code.  And here the most interesting begins. <br><br>  At a stage when a new functionality needs to be built into an existing project with a bunch of modules and dependencies, it can be very difficult to put them all in my head so that the design is correct.  The other side of this problem is the amount of work needed to complete such a task.  Therefore, in this case the approach from below will be more effective.  In other words, first you create a complete module that solves the necessary problem, and then embed it into the existing system, making only the necessary changes.  In this case, you can vouch for the quality of this module, since  it is a complete unit of functionality. <br><br>  It should be noted that the approaches are not so simple.  For example, when designing a new functional in the old system, you will not use both approaches.  In the initial analysis, you still need to evaluate the system, then lower it to the module level, implement it, and then return to the system level again.  In my opinion, the main thing here is not to forget that the new module should be a complete functionality and be independent, as a specific tool.  The clearer it will be to stick to this approach, the fewer changes will be made to the old code. <br><br><h3>  Rule 2: Test only modified code </h3><br>  When working with an old project, there is absolutely no need to write tests for all possible scenarios of the method / class.  Moreover, you may not be aware of some scenarios at all, since  There may be a lot of them.  The project is already in production, the client is satisfied, so you can relax.  In the generalized case, in such a system, only your changes introduce problems.  Therefore, only they should be tested. <br><br><h3>  Example </h3><br>  There is an online store module that creates a basket of selected items and saves it to the database.  The concrete implementation does not bother us.  How done so done - this is the legacy code.  Now we need to introduce a new behavior here: send a notification to the accounting department in the case when the basket value exceeds $ 1000.  This is the code we see.  How to implement a change? <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeShop</span></span> : <span class="hljs-title"><span class="hljs-title">Shop</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSale</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = LoadSelectedItemsFromDb(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> taxes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EuropeTaxes(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> saleItems = items.Select(item =&gt; taxes.ApplyTaxes(item)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cart = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cart(); cart.Add(saleItems); taxes.ApplyTaxes(cart); SaveToDb(cart); } }</code> </pre> <br>  According to the first rule, the changes should be minimal and atomic.  We are not interested in downloading data, not interested in accounting for taxes and saving to the database.  But we are interested in already calculated basket.  If there was a module that does what is necessary, then it would perform the necessary task.  Therefore, doing so. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeShop</span></span> : <span class="hljs-title"><span class="hljs-title">Shop</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSale</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = LoadSelectedItemsFromDb(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> taxes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EuropeTaxes(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> saleItems = items.Select(item =&gt; taxes.ApplyTaxes(item)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cart = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cart(); cart.Add(saleItems); taxes.ApplyTaxes(cart); <span class="hljs-comment"><span class="hljs-comment">// NEW FEATURE new EuropeShopNotifier().Send(cart); SaveToDb(cart); } }</span></span></code> </pre><br>  Such a notifier is working by itself, can be tested, and the changes made to the old code are minimal.  This is exactly what the second rule says. <br><br><h3>  Rule 3: We test only requirements </h3><br>  In order not to bury oneself in the number of scenarios that require unit testing, think about what is actually needed from the module.  Write first for the minimum set of conditions that can be presented as module requirements.  The minimum set is such that, when added to which a new one, the behavior of the module almost does not change, and when removed, the module becomes inoperative.  Very well helps to put brains on the right rails approach BDD. <br><br>  Just imagine how other classes that are clients of your module interact with it.  Do they need to write 10 lines of code to configure your module?  The easier the communication between parts of the system, the better.  Therefore, it is better to select the modules responsible for something specific from the old code.  This is where SOLID comes to the rescue. <br><br><h4>  Example </h4><br>  Now let's see how everything about what he wrote above will help us with the code.  First select all the modules that are only indirectly related to the creation of the basket.  This is how the responsibility of the modules is distributed. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeShop</span></span> : <span class="hljs-title"><span class="hljs-title">Shop</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSale</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1) load from DB var items = LoadSelectedItemsFromDb(); // 2) Tax-object creates SaleItem and // 4) goes through items and apply taxes var taxes = new EuropeTaxes(); var saleItems = items.Select(item =&gt; taxes.ApplyTaxes(item)).ToList(); // 3) creates a cart and 4) applies taxes var cart = new Cart(); cart.Add(saleItems); taxes.ApplyTaxes(cart); new EuropeShopNotifier().Send(cart); // 4) store to DB SaveToDb(cart); } }</span></span></code> </pre><br>  And so they can be distinguished.  Such changes at once are, of course, impossible in a large system, but they can be made gradually.  For example, when changes concern a tax module, it is possible to simplify dependencies on it from other parts of the system.  This can help get rid of strong dependencies on it and use it further as a self-sufficient tool. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeShop</span></span> : <span class="hljs-title"><span class="hljs-title">Shop</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSale</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1) extracted to a repository var itemsRepository = new ItemsRepository(); var items = itemsRepository.LoadSelectedItems(); // 2) extracted to a mapper var saleItems = items.ConvertToSaleItems(); // 3) still creates a cart var cart = new Cart(); cart.Add(saleItems); // 4) all routines to apply taxes are extracted to the Tax-object new EuropeTaxes().ApplyTaxes(cart); new EuropeShopNotifier().Send(cart); // 5) extracted to a repository itemsRepository.Save(cart); } }</span></span></code> </pre><br>  As for the tests, you can get by with these scenarios.  While their implementation does not interest us. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeTaxesTests</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_not_fail_for_null</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_apply_taxes_to_items</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_apply_taxes_to_whole_cart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_apply_taxes_to_whole_cart_and_change_items</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeShopNotifierTests</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_not_send_when_less_or_equals_to_1000</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_send_when_greater_than_1000</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Should_raise_exception_when_cannot_send</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre><br><h3>  Rule 4: Add only tested code </h3><br>  As I wrote above, you should minimize changes to the old code.  To do this, the old and the new / modified code can be divided.  New code can be distinguished in the methods that can test the unit tests.  This approach will help reduce the associated risks.  There are two techniques that were described in the book ‚ÄúWorking Effectively with the Legacy Code‚Äù (link to the book below). <br><br>  Sprout method / class - this technique allows you to embed a very safe new code into the old one.  The way I added the notifier is an example of this approach. <br><br>  The wrap method is somewhat more complicated, but the essence is the same.  Not always suitable, but only in cases when a new code is called before / after the old one.  In assigning responsibilities, two calls to the ApplyTaxes method were replaced by one call.  For this, it was necessary to change the second method so that the logic of the work did not break much and could be checked.  This is how the class looked like before the changes. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeTaxes</span></span> : <span class="hljs-title"><span class="hljs-title">Taxes</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> SaleItem </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyTaxes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Item item</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> saleItem = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SaleItem(item) { SalePrice = item.Price*<span class="hljs-number"><span class="hljs-number">1.2</span></span>m }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> saleItem; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyTaxes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart cart</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cart.TotalSalePrice &lt;= <span class="hljs-number"><span class="hljs-number">300</span></span>m) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exclusion = <span class="hljs-number"><span class="hljs-number">30</span></span>m/cart.SaleItems.Count; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cart.SaleItems) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item.SalePrice - exclusion &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>m) item.SalePrice -= exclusion; } }</code> </pre><br>  And so after.  The logic of working with the elements of the basket has changed a bit, but on the whole, everything remains the same.  In this case, the old method first calls the new ApplyToItems, and then its previous version.  This is the essence of this technique. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeTaxes</span></span> : <span class="hljs-title"><span class="hljs-title">Taxes</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyTaxes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart cart</span></span></span><span class="hljs-function">)</span></span> { ApplyToItems(cart); ApplyToCart(cart); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyToItems</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart cart</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cart.SaleItems) item.SalePrice = item.Price*<span class="hljs-number"><span class="hljs-number">1.2</span></span>m; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyToCart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Cart cart</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cart.TotalSalePrice &lt;= <span class="hljs-number"><span class="hljs-number">300</span></span>m) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exclusion = <span class="hljs-number"><span class="hljs-number">30</span></span>m / cart.SaleItems.Count; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> cart.SaleItems) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item.SalePrice - exclusion &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>m) item.SalePrice -= exclusion; } }</code> </pre><br><h3>  Rule 5: "Breaking" hidden dependencies </h3><br>  This rule is about the biggest evil in the old code: about using the new operator inside the method of one BO to create other BOs, repositories, or other complex objects.  Why is that bad?  The simplest explanation: it makes parts of the system strongly connected and helps to reduce their consistency.  Even shorter: leads to a violation of the principle of "low coupling, high cohesion".  If you look at it from the other side, then such code will be too difficult to separate into a separate, independent tool.  Getting rid of such hidden dependencies at once is very time consuming.  But this can be done gradually. <br><br>  First, you should transfer the initialization of all dependencies to the constructor.  In particular, this concerns the operators new and the creation of classes.  If you have a ServiceLocator for getting instances of classes, you should also remove it into the constructor where you pull out all the necessary interfaces from it. <br><br>  Secondly, the variables storing the instance of the external BO / repository must have an abstract type, and better the interface.  The interface is better, because  more unlocks the hands of the developer.  Ultimately, this will make the module an atomic tool. <br><br>  Thirdly, do not leave large methods-sheets.  This is a clear indication that a method does more than what its name suggests.  And then it testifies to the possible violation of SOLID, the Law of Demeter.  <s>As well as logic and Earth order.</s> <br><br><h4>  Example </h4><br>  Now let's take a look at how the code that creates the cart has changed after what is above.  Only the block of code that creates the basket remained unchanged.  The rest is allocated to external classes and can be replaced by any implementation.  Now the EuropeShop class takes on the form of an atomic tool that needs certain things that are explicitly represented in the constructor.  The code becomes easier to perceive. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeShop</span></span> : <span class="hljs-title"><span class="hljs-title">Shop</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IItemsRepository _itemsRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Taxes.Taxes _europeTaxes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> INotifier _europeShopNotifier; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EuropeShop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _itemsRepository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ItemsRepository(); _europeTaxes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EuropeTaxes(); _europeShopNotifier = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EuropeShopNotifier(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateSale</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> items = _itemsRepository.LoadSelectedItems(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> saleItems = items.ConvertToSaleItems(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cart = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Cart(); cart.Add(saleItems); _europeTaxes.ApplyTaxes(cart); _europeShopNotifier.Send(cart); _itemsRepository.Save(cart); } }</code> </pre><br><h3>  Rule 6: The smaller the big tests, the better. </h3><br>  Large tests are various integration tests that user scripts are trying to test.  Sure, they are important, but it is very expensive to check the logic of some IF in the depth of the code.  As a result, only one developer, only in a special suit, surrounded by talismans, will be able to change something there.  Writing such a test takes as much time, if not more, than writing the functionality itself.  Supporting them is like another legacy code that is scary to change.  However, these are just tests! <br><br>  In order not to step on the rake of the grief of designers who are trying to test their holes with integration tests and hope that they will warn them of a possible facsape, we should separate what tests are needed for and adhere to this division.  If you need an integration check, write a minimum test suite that includes positive and negative interaction scenarios.  If you need to check the algorithm, write unit tests too, limiting yourself to the minimum set. <br><br><h3>  Rule 7: Do not test private methods </h3><br>  If suddenly you wanted to test a private method, then, apparently, you yearned for crutches.  Some see nothing wrong with that.  But let's look at the reasons for your Wishlist.  The private method may be too complex or contain code that is not called from public methods.  I am sure that any other reason that you can think of will turn out to be a characteristic of a ‚Äúbad‚Äù code or design.  Most likely, a part of the code from the private method should be separated into a separate method / class.  Check if the first principle of SOLID is violated?  This is the first reason why this is not worth doing.  The second is that this way you check not the behavior of the whole module, but how it does it.  The internal implementation can change regardless of the module behavior.  Therefore, in this case, you get fragile tests, for the support that takes more time than necessary. <br><br>  To avoid having to test private methods, present your classes as a set of atomic tools about which device you do not know anything.  You expect some behavior that you are testing.  This view is also true for assembly classes.  Classes available to clients (from other assemblies) will be public, and those that perform internal work privately.  Although, there is a difference from the methods.  Internal classes can be complex, so they can be internal and also tested. <br><br><h4>  Example </h4><br>  For example, in order to test one condition in a private method of the EuropeTaxes class, I will not write a test for this method.  I will expect that taxes will be applied in a certain way, so the test will reflect exactly that.  In the test itself, I considered the handles what should happen, I took it as a standard and expect the same result from the class. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EuropeTaxes</span></span> : <span class="hljs-title"><span class="hljs-title">Taxes</span></span> { <span class="hljs-comment"><span class="hljs-comment">// code skipped private void ApplyToCart(Cart cart) { if (cart.TotalSalePrice &lt;= 300m) return; // &lt;&lt;&lt; I WANT TO TEST THIS CONDIFTION var exclusion = 30m / cart.SaleItems.Count; foreach (var item in cart.SaleItems) if (item.SalePrice - exclusion &gt; 100m) item.SalePrice -= exclusion; } } // test suite public class EuropeTaxesTests { // code skipped [Fact] public void Should_apply_taxes_to_cart_greater_300() { #region arrange // list of items which will create a cart greater 300 var saleItems = new List&lt;Item&gt;(new[]{new Item {Price = 83.34m}, new Item {Price = 83.34m},new Item {Price = 83.34m}}) .ConvertToSaleItems(); var cart = new Cart(); cart.Add(saleItems); const decimal expected = 83.34m*3*1.2m; #endregion // act new EuropeTaxes().ApplyTaxes(cart); // assert Assert.Equal(expected, cart.TotalSalePrice); } }</span></span></code> </pre><br><h3>  Rule 8: Do not test algorithm methods </h3><br>  The name of the rule was unsuccessfully chosen here, but I haven‚Äôt yet come up with a better one.  Among the ‚ÄúMokists‚Äù (these are those who mock up in tests) there are those who check the number of calls to certain methods, verify the call itself, etc. In other words, it checks the internal workings of methods.  This is as bad as private testing.  The difference is only in the level of application of such verification.  This approach again gives a lot of fragile tests, because of what TDD is not perceived by some as normal. <br><br><h3>  Rule 9: Do not modify legacy code without tests </h3><br>  This is the most important rule, since  reflects the desire of the team to follow this path.  Without the desire to move in this direction, everything that was said above does not make much sense.  Since  if the developer does not want to use TDD (does not understand its meaning, does not see the benefits, etc.), then its real benefits will be eroded by constant discussion of how difficult and inefficient it is. <br><br>  If you are going to apply TDD, discuss in a team, add to Definition of Done and apply.  At first it will be hard, as with everything new.  Like any art, TDD requires constant practice, and pleasure comes as you learn.  Gradually, the unit tests will be written a lot, you will begin to feel the health of your system and begin to appreciate the simplicity of writing code, describing the requirements in the first stage.  There are TDD studies conducted on real large projects at Microsoft and IBM, showing a decrease in production bugs from 40% to 80%.  (see link below). <br><br><h3>  Additionally </h3><br><ol><li>  <a href="https://www.amazon.com/Working-Effectively-Legacy-Michael-Feathers/dp/0131177052">Book ‚ÄúWorking Effectively with Legacy Code‚Äù by Michael Feathers</a> </li><li>  <a href="https://danlimerick.wordpress.com/2012/04/25/tdd-when-up-to-your-neck-in-legacy-code/">TDD when up to your neck in Legacy Code</a> </li><li>  <a href="https://danlimerick.wordpress.com/2012/06/11/breaking-hidden-dependencies/">Breaking Hidden Dependencies</a> </li><li>  <a href="https://danlimerick.wordpress.com/2012/04/25/the-legacy-code-lifecycle/">The Legacy Code Lifecycle</a> </li><li>  <a href="https://www.quora.com/Should-you-unit-test-private-methods-on-a-class">Should you test private methods on a class?</a> </li><li>  <a href="http://blog.ploeh.dk/2015/09/22/unit-testing-internals/">Unit testing internals</a> </li><li>  <a href="https://medium.com/javascript-scene/5-common-misconceptions-about-tdd-unit-tests-863d5beb3ce9">5 Common Misconceptions About TDD &amp; Unit Tests</a> </li><li>  <a href="http://www.daedtech.com/intro-to-unit-testing-5-invading-legacy-code-in-the-name-of-testability/">Intro to Unit Testing 5: Invading Legacy Code in the Name of Testability</a> </li><li>  <a href="https://en.wikipedia.org/wiki/Law_of_Demeter">Law of demeter</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/306962/">https://habr.com/ru/post/306962/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306950/index.html">Hackers got access to Telegram user accounts in Iran</a></li>
<li><a href="../306954/index.html">As we NoSQL in "Relation" replicated</a></li>
<li><a href="../306956/index.html">Will Twitter be the second ‚ÄúYahoo!‚Äù</a></li>
<li><a href="../306958/index.html">Another version of TFS settings for team work</a></li>
<li><a href="../306960/index.html">Throwing large volumes of documentation</a></li>
<li><a href="../306964/index.html">Windows 10 Anniversary Update became available</a></li>
<li><a href="../306970/index.html">Welcome to the NeuroHack hackathon on August 5</a></li>
<li><a href="../306972/index.html">Digital advertising kills optimists</a></li>
<li><a href="../306974/index.html">Unexpected certificate validation feature in Windows</a></li>
<li><a href="../306976/index.html">Twenty-one free tools every system administrator should know about</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>