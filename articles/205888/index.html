<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Validating Sql Code with .net and git-hook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello Habr! 

 Most recently, our company held another Hackathon. And within its framework, I wanted to kill time more interestingly to do a useful th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Validating Sql Code with .net and git-hook</h1><div class="post__text post__text-html js-mediator-article">  Hello Habr! <br><br>  Most recently, our company held another Hackathon.  And within its framework, I wanted to <s>kill time more interestingly</s> to do a useful thing, both for myself and for other developers.  The choice fell on a sort of validator sql code, which would check it for different rules that the compiler cannot do, and those that the guys who make Code Review can skip.  You can create a lot of such rules, starting from a simple ‚ÄúAdd GO at the end of the query‚Äù and ending with more complex ‚ÄúUse View instead of Table‚Äù.  And most importantly, this validator in no way should add time to the developer to use it, i.e.  to put it simply, it should validate itself somewhere automatically, regardless of the developer‚Äôs actions. <br><br>  Historically, the entire sql code before going into production (i.e. running on the main database) is saved in our GIT repository, which gets directly from the developers (of course, after Code Review).  So, there was an idea to add git-hook in this repository which would validate the sql-code and if it is not valid, then the commit would be returned to the developer for revision.  A bit hard to imagine, easier to draw: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/597/f43/a61/597f43a61475ff765a184b559d6c9eab.png"><br><a name="habracut"></a><br><br><h4>  Git hook </h4><br>  So, for starters, I decided to dig in the direction of git-hooks, to figure out how to still cancel the commit (if necessary).  In short, what is git-hook: this is a certain bash-script that is executed whenever a certain specific event occurs associated with a change in the state of the repository.  There are two types of such scripts: client and server.  And there are a lot of events, as well as scripts.  More details can be read <a href="http://git-scm.com/book/ru/%25D0%259D%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-Git-%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D1%2585%25D0%25B2%25D0%25B0%25D1%2582%25D1%2587%25D0%25B8%25D0%25BA%25D0%25B8-%25D0%25B2-Git">here</a> . <br>  The git-hook ‚Äúupdate‚Äù (server script) is the best for our purposes.  It runs right before updating the status of the branch (s) on the server, in fact, before your changes are sent to the server are applied.  And, importantly, if the exit code of such a script is non-zero, the changes will be rejected.  The script has three incoming parameters: <br><br><ul><li>  The name of the branch that is being updated </li><li>  Link to commit before updating branch </li><li>  Link to commit after branch update </li></ul><br>  Having such a set of parameters you can, for a start, get a list of files that have been changed using the second and third parameters of our script: <br><br><pre><code class="bash hljs">git diff --name-only --diff-filter=[AMCR] <span class="hljs-variable"><span class="hljs-variable">$2</span></span> <span class="hljs-variable"><span class="hljs-variable">$3</span></span></code> </pre> <br>  Having received the file list, you need to reach the content of each file using the git-show command.  And having already the content itself, you can try to check it out.  Below is the listing of the git-hook update script, as well as two supporting scripts: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ex=0 okResult="OK" originalPath='/git/test.git/' #   git printf "---- 'Sql checker' hook ----" listOfFiles=$(git diff --name-only --diff-filter=[AMCR] $2 $3) #   for changedFile in $listOfFiles do printf "checking:$changedFile" fullFilePath="$3:$changedFile" git-show $fullFilePath &gt;tmp_sql result=$($originalPath/hooks/check-sql tmp_sql) #  if [ "$result" != $okResult ] then res=${result//|/\\n } printf " $res\n" #  ex=1 else printf "ok!\n" fi done printf "---- Done ----" exit $ex</span></span></code> </pre><br>  The check-sql script makes a request for an external resource for checking a file with sql code, and also parses the result obtained in the form of <a href="http://en.wikipedia.org/wiki/SOAP">soap</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh soap-template $1 tmp_soap wget -qO- --post-file=tmp_soap --header="Content-type: text/xml; charset=utf-8" 127.0.0.1/check-sql.asmx | gawk -v re="&lt;CheckFileResult.*&gt;(.*)/CheckFileResult&gt;" '{match($0,re,RMATCH); print RMATCH[1]}'</span></span></code> </pre><br>  And after the soap-template script, which sql-code draws a query in soap: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh encodedFile=$(base64 $1) echo '&lt;?xml version="1.0" encoding="utf-8"?&gt;' &gt;$2 echo '&lt;soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSc ma" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/"&gt;' &gt;&gt; $2 echo ' &lt;soap:Body&gt;' &gt;&gt;$2 echo ' &lt;CheckFile xmlns="http://tempuri.org/"&gt;' &gt;&gt;$2 echo " &lt;base64&gt;$encodedFile&lt;/base64&gt;" &gt;&gt;$2 echo ' &lt;/CheckFile&gt;' &gt;&gt;$2 echo ' &lt;/soap:Body&gt;' &gt;&gt;$2 echo '&lt;/soap:Envelope&gt;' &gt;&gt;$2</span></span></code> </pre><br>  So, I am not so strong in bash scripts to do a check of the sql code on them, according to this, I decided to take it to my favorite environment .Net. <br><br><h4>  .Net part </h4><br>  I chose the .net web service as a communication bridge between git-hook and .Net, so the ‚Äúcheck-sql‚Äù script in our git-hook script requests this service with a parameter that contains the content of the sql file: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">WebMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> base64</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errors = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;SqlCheckError&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = OkResult; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//  sql- string sqlScript = Encoding.Default.GetString(Convert.FromBase64String(base64)); //    ISqlCheck var containerProvider = new SqlCheckUnityProvider(); //    var checker = new SqlCheckProcess(containerProvider); errors.AddRange(checker.CheckSql(sqlScript)); } catch (Exception e) { Log(e); // return OkResult; //      ,       . } //  ( )     git-hook if (errors.Count &gt; 0) { result = string.Join("|", errors.Select(error =&gt; string.Format("{1}: {0}", error.Message, error.Type))); } return result; }</span></span></code> </pre><br>  Having already .net environment and provided us with sql-code for validation, you can think of a lot of things.  I created a small framework for such validation, but I think it‚Äôs not very appropriate to bring all its code here.  In the near future I will post it on github.  In a nutshell, everything is based on such a simple interface: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISqlCheck</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckSql</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sqlCode</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">SqlCheckError </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sqlCode</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  This interface is a validation rule.  Having a lot of implementations of this interface in conjunction with the <a href="http://msdn.microsoft.com/en-us/library/ff647202.aspx">Unity Container,</a> we can manage the set of rules applicable to validation as a whole.  Also, with the sql-parser ( <a href="http://msdn.microsoft.com/en-us/library/microsoft.data.schema.scriptdom.sql.tsql100parser(v%3Dvs.100).aspx">TSql100Parser</a> ) built into the .net, you can implement the verification of almost any rule. <br><br><h4>  Practice </h4><br>  This simple system has already begun to operate in our company, it is too early to draw conclusions about some enormous benefit, but with a potentially large margin for expanding opportunities, we can confidently say that the benefits from this will be much more than harm. <br>  In conclusion, I cite the console log when this system is running: <br><br><pre> <code class="bash hljs">$ git push origin master Counting objects: 7, <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Delta compression using up to 8 threads. Compressing objects: 100% (3/3), <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Writing objects: 100% (4/4), 347 bytes, <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. Total 4 (delta 2), reused 0 (delta 0) remote: remote: ---- <span class="hljs-string"><span class="hljs-string">'Sql checker'</span></span> hook ---- remote: remote: checking: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/create_sp.sql remote: Error: Missed <span class="hljs-string"><span class="hljs-string">'GO'</span></span> statement after stored procedure. remote: remote: ---- Done ---- remote: remote: error: hook declined to update refs/heads/master To ssh://user@git.local/git/test.git ! [remote rejected] master -&gt; master (hook declined) error: failed to push some refs to <span class="hljs-string"><span class="hljs-string">'ssh://user@git.local/git/test.git'</span></span></code> </pre><br>  As you can see from the penultimate line, the commit was rejected by the system due to the presence of errors in the variable sql-script. <br><br>  That's all I wanted to tell about this post. <br>  Thanks for attention.  Convenient to all development! </div><p>Source: <a href="https://habr.com/ru/post/205888/">https://habr.com/ru/post/205888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205872/index.html">Billion pixels for a billion stars</a></li>
<li><a href="../205874/index.html">x86-compatible, part 1: "Dark Horse from Taiwan"</a></li>
<li><a href="../205878/index.html">How does Meteor work from the inside?</a></li>
<li><a href="../205880/index.html">Speech technology. Voice biometrics for teapots on the example of work in the contact center</a></li>
<li><a href="../205886/index.html">Secret knowledge of stock exchange tickers</a></li>
<li><a href="../205890/index.html">A little bit about packing backpack</a></li>
<li><a href="../205892/index.html">Generating abstract images using genetic algorithms</a></li>
<li><a href="../205894/index.html">Knight's move using canvas</a></li>
<li><a href="../205900/index.html">How did the Tesla Power Transmission Tower work - its own ‚Äúinvestigation‚Äù</a></li>
<li><a href="../205902/index.html">JavaScript video course in Russian</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>