<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Under the hood: a patch for Dalvik from Facebook for Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Facebook is one of the most functional apps available on Android. With features such as push notifications, news feeds and a built-in version of Faceb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Under the hood: a patch for Dalvik from Facebook for Android</h1><div class="post__text post__text-html js-mediator-article">  Facebook is one of the most functional apps available on Android.  With features such as push notifications, news feeds and a built-in version of Facebook Messenger (in fact, a full-fledged application) that work simultaneously in real time, the complexity and amount of code generates a number of technical difficulties encountered by other Android developers. - especially on older versions of the platform.  (Our latest applications support the old version of Android 2.2 - Froyo, which is almost 3 years old). <br><br>  One such problem is how the Android virtual machine, Dalvik, handles Java methods.  At the end of last year, we <a href="https://www.facebook.com/notes/facebook-engineering/under-the-hood-rebuilding-facebook-for-android/10151189598933920">completed the processing of our Android application</a> , which included the translation of a large amount of JavaScript code in Java, as well as the use of new abstractions that generated a large number of small methods (in most cases, this is considered a good programming practice).  Unfortunately, this led to a sharp increase in the number of methods in our application. <br><br><a name="habracut"></a><br>  As we found out, the problem first manifested itself, as described in <a href="http://code.google.com/p/android/issues/detail%3Fid%3D22586">this</a> bug, which made it impossible to install our application on older versions of Android.  During standard installation, the dexopt program is launched to prepare the application for installation on a specific phone.  dexopt uses a fixed-size buffer (the ‚ÄúLinearAlloc‚Äù buffer) to store information about all methods of the application.  The latest versions of Android use a buffer of 8 or 16 MB in size, but Froyo and Gingerbread (versions 2.2 and 2.3, respectively) have a limit of only 5 MB.  Therefore, a large number of our methods led to the excess of its size and dexopt crash on older versions of Android. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After a little panic, we realized that we could try to avoid this problem by breaking our application into several dex files using the technique described <a href="http://code.google.com/p/android/issues/detail%3Fid%3D22586">here</a> , which is to use additional dex files for expansion modules, but not the main part of the program. <br><br>  However, this was not the way in which we could break our application ‚Äî too many classes refer directly to the Android framework.  Instead, it was necessary to inject our additional dex files directly into the system class loader.  This cannot be done in a standard way, but we examined the Android source code and used reflection to directly modify some of its internal structures.  Of course, we are very pleased and grateful that Android is an open source project, otherwise these changes would have been impossible. <br><br>  But as soon as we came closer to the launch of our updated application, we faced a new problem.  LinearAlloc buffer is used not only in dexopt - it exists in every running Android program.  While dexopt uses LinearAlloc to store information about all the methods of your dex file, the running application only needs it for the class methods that are currently being used.  Unfortunately, now we use too many methods for Android versions down to Gingerbread, and our application began to fall almost immediately after the start. <br><br>  There was no way around this problem with dex files, since  all our classes were loaded in one process and we could not find information about someone who had encountered this problem before (for it is possible if you use multiple dex files, which in itself is a complicated technique).  We were left to ourselves. <br><br>  We tried various ways to get memory, including aggressive use of ProGuard and reworking the source code in order to reduce the number of methods.  We even developed a profiler using LinearAlloc to find its largest consumers.  Nothing helped, and we still needed to write more methods to support different types of content in our improved news feed and timeline. <br><br>  The release of the long-awaited version 2.0 of Facebook for Android is under threat.  It seemed we had to choose: either significantly reduce the functionality of the application or deliver our application only for the latest versions of Android (Ice Cream Sandwich and above).  Neither was acceptable.  We needed the best solution. <br><br>  And so, we again turned to Android source code.  Looking at the <a href="">declaration of the LinearAlloc buffer</a> , we realized that if it were possible to increase the buffer size from 5 to 8 MB, we would be saved! <br><br>  That's when we got the idea to use the JNI extension to replace the existing buffer with a larger buffer.  At first glance, this idea seems completely insane.  Modifying the insides of the Java class loader is one thing, but changing the Dalvik virtual machine while it is executing our code can be very dangerous. <br>  But as soon as we mastered the code, analyzing the use of LinearAlloc, we began to understand that it should be safe if done at the very beginning of the program.  All we had to do was find the LinearAllocHdr object, block it and replace the buffer. <br><br>  The search turned out to be the most difficult part.  This is where the object <a href="">is located</a> , inside the DvmGlobals object, about 700 bytes from the beginning.  Finding an entire object can be risky, but fortunately, we had a pivot point - a vmList object just a few bytes earlier.  It contains a value that we could compare to a JavaVM pointer accessible via JNI. <br><br>  The plan finally came together: find the right value from vmList, find a match in DvmGlobals, jump a few bytes back to the LinearAlloc header and replace the buffer.  Thus, we developed the JNI extension, embedded it in our application and ... saw how our application runs on a Gingerbread phone for the first time in weeks.  The plan worked. <br><br>  But for some reason it did not launch on the Samsung Galaxy S II ... <br>  The most popular gingerbread phone ... <br>  All the times ... <br><br>  It seems that Samsung made a small change in Android, which misled our code.  Other manufacturers could do the same, so we decided to make our code more reliable. <br><br>  Manual verification of the GSII code showed that the LinearAlloc buffer was only 4 bytes from where we were waiting for it, so we rewrote our code so that we could look at a few bytes in each direction if LinearAlloc could not be found in its intended location.  This made it necessary to parse the memory table of our process to make sure that we do not make any references to non-valid memory (which can lead to instant crash), as well as to build a strong heuristic algorithm to be sure that we will recognize LinearAlloc when we find it .  Finally, we found the safest way to scan the entire hip process to find the buffer. <br><br>  Now we had a version of the code that worked on several popular phones ‚Äî but we needed more than just a few.  Therefore, we have embedded our code in a test application that could run the same procedure that we use in our Facebook application, and simply show a green or red block in case of success or failure. <br><br>  We used manual testing, DeviceAnywhere and a test lab provided by Google to test our application on 70 different devices and fortunately it worked on each one of them! <br><br>  We released this code along with Facebook for Android 2.0 in December.  Now, it works on hundreds of different phone models.  A big speed boost in this release would have been impossible without this crazy hack.  And, of course, without the source code of Android, we would not have had the opportunity to release our best version of the application.  Android provides extensive development capabilities and we are excited to bring Facebook to an increasing number of devices. <br></div><p>Source: <a href="https://habr.com/ru/post/171623/">https://habr.com/ru/post/171623/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../171609/index.html">Ubuntu Global Jam 13.04 in Novosibirsk</a></li>
<li><a href="../171611/index.html">Available 3D anti-aliasing technology</a></li>
<li><a href="../171613/index.html">Wireless communications "smart home"</a></li>
<li><a href="../171615/index.html">Spring warming at DevCon 2013: ticket prices are melting</a></li>
<li><a href="../171617/index.html">How Halfbrick Studios develops games like Fruit Ninja, Age Of Zombies and Jetpack Joyride</a></li>
<li><a href="../171629/index.html">Secure Cryptographic Execution Environment</a></li>
<li><a href="../171631/index.html">Project "Creation Creation". Do it yourself</a></li>
<li><a href="../171633/index.html">Cyber ‚Äã‚Äãinvitation to a wedding or how to effectively destroy patterns</a></li>
<li><a href="../171635/index.html">We invite you to a large IT conference Superjob</a></li>
<li><a href="../171637/index.html">How to make money on IT conferences: our findings and mistakes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>