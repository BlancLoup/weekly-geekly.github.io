<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast filter catalog for online stores based on Redis bitmaps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is no secret that every online store should help users find what they need. Especially if you have a lot of goods (> 10). Cataloging of goods comes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast filter catalog for online stores based on Redis bitmaps</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/143/8ba/beb/1438babeb25e4abcbcde35a74614199b.PNG"><br><br>  It is no secret that every online store should help users find what they need.  Especially if you have a lot of goods (&gt; 10).  Cataloging of goods comes to the rescue, but it is half the battle to break up products into categories.  Products within the category need to be able to filter by their properties.  Especially if you have mixed goods, for example, clothes, electronics, jewelry, etc.  And here any developer who writes his e-commerce product faces unpleasant realities of life: products may have completely different properties, some products may be missing, some products may fall under different values ‚Äã‚Äãfor one property (the color of the dress is either blue, either blue, respectively, it would be nice to show it in both blue and blue).  Simply put, you have an <a href="https://en.wikipedia.org/wiki/Entity%25E2%2580%2593attribute%25E2%2580%2593value_model">EAV</a> .  It also happens that EAV is diagnosed to you by the customer closer to the end of development, and even asks you to add a filter on dynamic properties after the release. <br><a name="habracut"></a><br>  You start to scratch behind the ear, knowing that nothing fits into the relational model, you have already chosen MySQL as a DBMS, if you are a good web developer, or maybe PostgreSQL, if you read about it, and adherents of different corporations can generally choose their products, no one forbids.  Most often, however, these are all RDBMS, and dynamic properties are not very easily screwed in (read: difficult), not everyone can do it. <br>  Here, for example, a small piece of the database diagram in the popular e-commerce platform Magento: <br> <a href=""><img src="https://habrastorage.org/files/77d/d13/9d2/77dd139d2a914b57a9f4df88eb2d60e6.PNG"></a> <br>  <i>(on click in full size)</i> <br><br>  So we were tasked to make such a catalog filter for a <a href="http://www.ohmygold.ru/">jewelry store</a> .  And the properties of the goods we then generally lay in json-e in MySQL, because  needed only on the page of the product itself and nowhere else.  Our position was slightly improved by the fact that it was a jewelry online store, and the properties in it could be set initially, such as ring size, metal type, metal color, insert.  Nevertheless, the solution obtained is universal; you can easily modify the code under fully dynamic sets of properties for goods. <br>  It was decided that changing half of the database and more than half of the code for adding a filter is not good, so we called in-memory key-value storage called <a href="http://redis.io/">Redis</a> , in particular, its cool ability to work bit by bit with strings, operations: SETBIT, GETBIT, BITOP, BITCOUNT.  It is easy to guess the meaning of the commands without looking into the documentation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The filter storage scheme in Redis was as follows: <br><ol><li>  One key is one value of the product property, for example, <i>size-18:</i> or <i>color-red:</i> </li><li>  Data in each key was bitmap long N bits, where N is the total amount of goods in the store.  Accordingly, the position of the bit in the bitmap is the product ID, and the bit itself indicates whether the given ID belongs to a filter with such a value. </li></ol><br>  An example for better understanding: <br><table><tbody><tr><td align="right">  <i>Product ID (bit position)</i> </td><td>  ID: 1 </td><td>  ID: 2 </td><td>  ID: 3 </td><td>  ID: 4 </td><td>  ID: 5 </td></tr><tr><td>  <i>redis-key</i> </td><td colspan="5">  <i>redis-value</i> </td></tr><tr><td>  size-17: </td><td>  0 </td><td>  0 </td><td>  one </td><td>  0 </td><td>  one </td></tr><tr><td>  size-18: </td><td>  one </td><td>  one </td><td>  0 </td><td>  0 </td><td>  0 </td></tr><tr><td>  size-19: </td><td>  0 </td><td>  0 </td><td>  0 </td><td>  one </td><td>  0 </td></tr><tr><td>  color-red: </td><td>  one </td><td>  one </td><td>  one </td><td>  0 </td><td>  one </td></tr><tr><td>  color green: </td><td>  0 </td><td>  0 </td><td>  one </td><td>  one </td><td>  one </td></tr></tbody></table><br>  Thus, in radish we have 5 key value pairs, because  we have two filters - by color (2 options) and by size (3 options).  There are only 5 products in the store, so bitmap consists of 5 bits.  The table shows that the product with ID 2 is red, size 18, and the product with ID 3 is size 17, but it has both red and green color. <br>  To apply the filter to the product catalog, it is sufficient to perform a bitwise AND operation for the filter values ‚Äã‚Äãselected by the user.  For example, a person wants a green goods size 18, pokes two jackdaws in the filter, and we do: <br> <code>BITOP AND result-key size-18 color-green <br></code> <br>  then in the result-key we will have a bitmap, representing the bitwise multiplication of these two bitmaps.  It remains for us only to calculate the places in which we have units, positions of units and will be ID of products with the specified filters: <br><pre> <code class="php hljs">$bytes = str_split($result_key); $ids = []; <span class="hljs-comment"><span class="hljs-comment">// resulting product IDs for ($i = 0; $i &lt; count($bytes); $i++) // iterate in bytes (8 products at once) for ($j = 7; $j &gt;= 0; $j--) // iterate over bits in current 8-products chunk if ($bytes[$i] &amp; (1 &lt;&lt; $j)) // &gt;0 if bit was 1, otherwise 0 $ids[] = 8*$i + (8-$j); // calculate product ID and append it</span></span></code> </pre> <br><br>  The generation of bitmaps occurs at the moment of adding / changing the goods in the admin panel, depending on the available properties of the goods, we make BITSET into the necessary filter, that's all. <br><br><img src="https://habrastorage.org/files/e32/6f9/b35/e326f9b356d342df82d4e60050d9a940.png">  Advantages of such a decision: <br>  1) Eats little memory.  We have&gt; 50,000 products, about 100 filter values, that is, 50,000 * 100 = 5,000,000 bits = just 625 kilobytes of memory. <br>  2) Very fast.  The complexity of the bitwise O (N) operation, however, the strings are not measured in millions of bytes, but multiplying a couple of bitmaps with about 50,000 bits is a task of a couple of microseconds for the processor.  Overall, in the worst case (multiplication of all filters), measuring the time difference in PHP before sending the command to REDIS and after receiving the result - <b>40ms</b> (this is with the additional function from item 3, below).  Quite realtime page generation, for the web will go.  If it seems a lot, please cache the result, but we are completely satisfied with this. <br>  3) <b>Ability to count the number of products in each filter and category</b> .  This has become a useful side effect.  We can now calculate the number of products for each filter value that is currently available.  Yes, this requires a bitwise multiplication of the current result-key (the current selection of products) by each filter value, and then the execution of BITCOUNT.  We realized this, now we can dynamically hide filters with an empty set of goods (a person, having chosen platinum diamond rings, does not see the filter at the price ‚Äúup to 3,000 rubles‚Äù). <br><br><img src="https://habrastorage.org/files/074/851/6d0/0748516d009c43c9a9d9c585cef5b0be.png">  cons of such a decision: <br>  1) Inability to code range filters, for example, where the price can be manually filtered by the user up to a ruble.  Well, such, with sliders OT and TO, you know.  Who still do not work on mobile phones.  In our store, the filter at prices was just five options (up to 3000, 3000-10000, etc.), respectively, encoded them as 5 price-0-3000 bitmaps :, price-3000-10000: etc. . <br>  2) The need to transfer the list of selected IDs in MySQL to fetch their data.  This, of course, is not good that we throw a list of IDs for sampling from radish. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> products <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (....)</code> </pre><br>  But as it turned out, it works extremely fast.  In the worst case, the entire catalog page with all the selected filters for all categories was generated in 600ms, if not mistaken.  Proof for several filters: <br><img src="https://habrastorage.org/files/c55/1b4/47a/c551b447a6ac417a88b718b96c75b90d.png"><br><br>  As a result, this business turned out to be very fast, there are <a href="https://github.com/phpredis/phpredis">Redis bindings for PHP</a> , Redis itself is very primitive and easy to learn in one day. </div><p>Source: <a href="https://habr.com/ru/post/261137/">https://habr.com/ru/post/261137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261119/index.html">Western bestsellers in our book market. Career IT Project Manager</a></li>
<li><a href="../261123/index.html">Eat filed, sit down, please connect</a></li>
<li><a href="../261127/index.html">Delete phantom server entries from SCVMM</a></li>
<li><a href="../261131/index.html">Internal representation of values ‚Äã‚Äãin PHP 7 (part 2)</a></li>
<li><a href="../261133/index.html">Vulnerability iOS and OS X, the success of Bethesda, a reward from Google - and other news of the week for a mobile developer</a></li>
<li><a href="../261139/index.html">How we developed our DNS manager</a></li>
<li><a href="../261141/index.html">JavaScript Modules</a></li>
<li><a href="../261143/index.html">Virtual PBX 3CX Phone System v14 in 3CX company cloud</a></li>
<li><a href="../261145/index.html">Using monads in C ++. Part 2: state monad</a></li>
<li><a href="../261147/index.html">New Cherry Framework 4 | Cherry ripened</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>