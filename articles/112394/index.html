<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monoids and their applications: monoidal calculations in trees</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings, Habrahabr. Today I want, in my usual style, to arrange for the community a small educational program on data structures. Only this time it ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monoids and their applications: monoidal calculations in trees</h1><div class="post__text post__text-html js-mediator-article">  Greetings, Habrahabr.  Today I want, in my usual style, to arrange for the community a small educational program on data structures.  Only this time it will be much more comprehensive, and its applications and practicality will reach far into the most diverse areas of programming.  The most beautiful applications, I, of course, will show and describe directly in the article. <br><br>  We need a bit of abstract thinking, knowledge of some balanced search tree (for example, the <a href="http://habrahabr.ru/blogs/algorithm/101818/">Cartesian tree</a> I described earlier), the ability to read simple C # code, and the desire to apply the knowledge gained. <br><br>  So, on the agenda today - <em>monoids</em> and their main use for caching calculations in trees. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Monoid as a concept </h3><br>  Imagine a set of <em>anything</em> , a set consisting of objects that we are going to manipulate.  Call it <em><strong>M.</strong></em>  On this set, we introduce a binary operation, that is, a function that associates a new element with a pair of set elements.  Hereinafter, we will denote this abstract operation by "‚äó", and write the expressions in infix form: if <em><strong>a</strong></em> and <em><strong>b</strong></em> are elements of a set, then <em><strong>c</strong></em> = <em><strong>a</strong></em> ‚äó <em><strong>b</strong></em> is also some element of this set. <br><br>  For example, consider all the lines that exist in the world.  And consider the operation of string concatenation, traditionally denoted in mathematics "‚ó¶", and in most programming languages ‚Äã‚Äã"+": <nobr><code>"John"</code> ‚ó¶ <code>"Doe"</code> = <code>"JohnDoe"</code></nobr> .  Here, the set <em><strong>M</strong></em> is a string, and "‚ó¶" acts as the operation "‚äó". <br>  Or another example is the <em>fst</em> function, known in functional languages ‚Äã‚Äãwhen manipulating tuples.  Of its two arguments, it returns the first in order as a result.  So, <nobr><em>fst</em> (5, 2) = 5</nobr> ;  <nobr><em>fst</em> ( <code>"foo"</code> , <code>"bar"</code> ) = <code>"foo"</code></nobr> .  It makes no difference on which set to consider this binary operation, so in your will to choose any. <br><br>  Next, we impose a restriction of <em>associativity</em> on our operation "‚äó".  This means that it requires the following: if a sequence of objects is combined with the help of "‚äó", then the result should remain the same regardless of the order of application of "‚äó".  More strictly, for <em>any</em> three objects <em><strong>a</strong></em> , <em><strong>b</strong></em> and <em><strong>c</strong></em> should occur: <br>  <nobr>( <strong><em>a</em></strong> ‚äó <em><strong>b</strong></em> ) ‚äó <em><strong>c</strong></em> = <em><strong>a</strong></em> ‚äó ( <em><strong>b</strong></em> ‚äó <em><strong>c</strong></em> )</nobr> <br>  It is easy to see that string concatenation is associative: it does not matter which stitching in the sequence of strings to perform earlier, and which later, in the end, you still get the general merging of all strings in the sequence.  The same applies to the <em>fst</em> function, because: <br>  <em>fst</em> ( <em>fst</em> ( <em>a</em> , <em>b</em> ), <em>c</em> ) = <em>a</em> <br>  <em>fst</em> ( <em>a</em> , <em>fst</em> ( <em>b</em> , <em>c</em> )) = <em>a</em> <br>  A chain of applications of <em>fst</em> to a sequence in any order will still produce its head element. <br><br>  And the last thing we need: in the set <strong><em>M</em></strong> in relation to the operation there must be a <em>neutral element</em> , or a <em>unit of</em> operation.  This is an object that can be combined with any element of the set, and it does not change the latter.  Formally speaking, if <strong><em>e</em></strong> is a neutral element, then for any <em>a</em> from the set it takes place: <br>  <em>a</em> ‚äó <em>e</em> = <em>e</em> ‚äó <em>a</em> = <em>a</em> <br>  In the example with strings, the neutral element is the empty string <code>""</code> : from which side to which line you should not glue it, the string will not change.  But the <em>fst</em> in this regard, we are satisfied with the trick: it is impossible to come up with a neutral element for it.  Indeed, <nobr><em>fst</em> ( <em>e</em> , <em>a</em> ) = <em>e is</em></nobr> always, and if <nobr><em>a</em> ‚â† <em>e</em></nobr> , then we lose the neutrality property.  You can, of course, consider <em>fst</em> on a set of one element, but who needs this boredom?  :) <br><br>  Each such triple <strong><em>&lt;M, ‚äó, e&gt;</em></strong> we will solemnly call a <strong>monoid</strong> .  Fix this knowledge in the code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMonoid</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { T Zero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T a, T b</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  More examples of monoids, as well as where we actually apply them, will be under the cut. <br><a name="habracut"></a><br><br><h3>  Examples </h3><br><br>  Before moving on, we must convince the reader that there is darkness and darkness in various monoids in the world.  We will use some of them further in the text as examples, others may meet in their practice.  I will make a simple list, for each monoid, indicating the set in question, a combining operation and a neutral element.  You are invited to verify the associativity of all the operations yourself, I simply don‚Äôt have enough space here :) In addition, I‚Äôm a little clever and will not include some of the most interesting and unusual monoids in the enumeration, because in the subsequent article they will be devoted to entire chapters. <br><br>  So, popular monoids: <br><ul><li>  &lt;Numbers, +, 0&gt;.  By numbers is meant any numerical set - from natural to complex. </li><li>  &lt;Numbers, *, 1&gt;. </li><li>  &lt;Boolean, &amp;&amp;, True&gt;. </li><li>  &lt;Boolean, ||, False&gt;. </li><li>  &lt;Strings, concatenation ‚ó¶, empty string <code>""</code> &gt;. </li><li>  &lt;Lists, concatenation ++, empty list []&gt;. </li><li>  &lt;Sets, union ‚à™, empty set ‚àÖ&gt;. </li><li>  &lt;Sorted lists, merge, empty list []&gt;.  Here <em>merge</em> is understood as the linear operation of merging two ordered lists, surely known to you by the Merge Sort sorting algorithm.  By the way, the correctness of the Merge Sort algorithm itself follows precisely from the fact that <em>merge</em> is a monoidal operation.  Moreover, an idea similar to its main idea, we will use more than once today. </li><li>  &lt;Integers, LCM, 1&gt;. </li><li>  &lt;Polynomials of one variable, LCM, 1&gt;. </li><li>  &lt;Integers and Polynomials, GCD, 0&gt;.  The associativity of the greatest common divisor is clear.  As for zero as a neutral element, this property is often assumed by definition, because it is easily consistent with the Euclidean algorithm. </li><li>  &lt;Matrices, *, unit matrix&gt;.  What is interesting, if we restrict the set to nondegenerate matrices (for which the determinant is not equal to 0), the resulting structure will still remain a monoid - the product of nondegenerate matrices gives a nondegenerate matrix.  This simple statement follows from the properties of the determinant. </li><li>  &lt;Numbers, min, + ‚àû&gt;. </li><li>  &lt;Numbers, max, -‚àû&gt;. </li><li>  &lt;Permutations of numbers from 1 to N, the product of permutations ‚ó¶, the identity permutation (123..N)&gt;. <br>  The product of permutations <em>s</em> and <em>t</em> in discrete mathematics is understood as the following operation: take the number in the first position <em>s</em> , take the number in <em>t</em> by this index and put it in the first position of the result;  then we repeat this double indexing for the second position and so on until the Nth.  That is, if <em>u</em> = <em>s</em> ‚ó¶ <em>t</em> , then <code>u[i] = t[s[i]], i = 1..N</code> .  Permutations and their works are very often found in various problems arising in programming. </li><li>  Consider some set <em>X.</em>  Under <em>X <sup>X</sup></em> in mathematics it is customary to denote the set of <strong>endomorphisms</strong> ‚Äî arbitrary functions from the set <em>X</em> into it.  So, if <em>X</em> is an integer, then any function of the form <code>int ‚Üí int</code> is an endomorphism on it.  What is the composition of the functions "‚ó¶", it is the same "."  in Haskell and "&gt;&gt;" in F #, everyone knows. <br>  So, &lt;Endomorphisms, the composition of functions, the identical function <em>id</em> &gt; is a monoid. </li><li>  Take the usual linear integer operation ("+" or "*") and limit its use to numbers that take the remainder of a certain number <em>P.</em>  For example, one can consider multiplication modulo 7, where 3 * 4 = 5, because 12% 7 = 5. The resulting operations on such a set will remain closed and also form a monoid - an extremely important monoid for number theory and cryptography. <br>  By the way, if we take <em>P</em> = 2, then we get bitwise operations.  Thus, "&amp;" is multiplication modulo 2, and "^", also known as XOR, is addition modulo 2. Thus, <nobr>&lt;Boolean, ^, False&gt;</nobr> is also a monoid. </li><li>  &lt;Dictionaries (associative arrays), union, empty dictionary&gt;.  The data stored in the dictionary itself must form a monoid, thus resolving conflicts when merging: <code>(map1 ‚à™ map2)[key] = map1[key] ‚äó map2[key]</code> . <br>  Or you can consider not just dictionaries from keys to values ‚Äã‚Äã( <code>K -&gt; V</code> ), but multi-dictionaries from keys to lists of values ‚Äã‚Äã( <code>K -&gt; [V]</code> ), then when combining dictionaries, lists with the same keys can simply be merged using that the lists themselves form a monoid. </li></ul><br>  On it (!) We will finish with examples and we will pass to practice.  Before actually presenting this long-awaited practice, I will write down on C # the definitions of a couple of simple monoids from this list, with which we will work in the next chapter. <br><blockquote>  All monoids we will implement as singltons.  To make it easier to subsequently access the instance for any unknown monoid type, I rendered its creation into a separate static class. </blockquote><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Singleton</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">new</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T Instance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _instance; } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddMonoid</span></span> : <span class="hljs-title"><span class="hljs-title">IMonoid</span></span>&lt;<span class="hljs-title"><span class="hljs-title">int</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddMonoid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Zero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FunctionMonoid</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IMonoid</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Func</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">T</span></span>&gt;&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FunctionMonoid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Func&lt;T, T&gt; Zero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x =&gt; x; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Func&lt;T, T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;T, T&gt; f, Func&lt;T, T&gt; g</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x =&gt; g(f(x)); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GCDMonoid</span></span> : <span class="hljs-title"><span class="hljs-title">IMonoid</span></span>&lt;<span class="hljs-title"><span class="hljs-title">int</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GCDMonoid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gcd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> b == <span class="hljs-number"><span class="hljs-number">0</span></span> ? a : gcd(b, a % b); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Zero { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> gcd(a, b); } }</code> </pre><br><br><h3>  Where in computer science rope </h3><br><br>  From this point on we enter the field of practical applications. <br><br>  First we need a definition of a data structure called <a href="http://en.wikipedia.org/wiki/Rope_(computer_science)" title="Rope">Rope</a> .  Rare Russian-speaking sources, without further ado, translate it as a <strong>rope</strong> , I will not back down from this tradition.  So, the rope was first proposed in 1995 as a convenient implementation of immutable strings with additional features ‚Äî for example, a very fast operation of taking substrings and merging strings.  With such goals, this structure continues to be used, for example, in the Java library. <br><br>  Imagine an arbitrary balanced binary tree.  Let us suspend the words to this tree as leaves - i.e.  character arrays.  The resulting tree may look like this: <br><img src="https://habrastorage.org/storage/f930338d/73dd07dd/e3316f57/6e51cbd0.png"><br>  This data structure will be called a <em>rope</em> . <br><br><h5>  Access by index </h5><br>  From past articles on the <a href="http://habrahabr.ru/blogs/algorithm/102006/">Cartesian tree,</a> we remember how it is possible in such a tree, for example, to define a character request by index ‚Äî it is enough to store the sizes of subtrees in intermediate vertices, in this case the total length of the string suspended from the subtree.  For this tree, this scheme will look like this: <br><img src="https://habrastorage.org/storage/583a4eb8/2c3640cb/05ea4f6d/5b27282c.png"><br>  Now, using the familiar algorithm of the K-th ordinal statistics, you can reach the array containing the character under the desired number, and return the desired character by direct indexation in the memory of the array.  It is worth noting that on the leaves of the tree arrays are suspended instead of individual characters solely for reasons of optimizing memory on large lines and performance on small ones. <br><br><h5>  Glueing </h5><br>  To glue the two ropes, it is enough to create a new root vertex and attach two given trees to it as sons.  Since the original trees were balanced, the new rope will also be balanced.  Often, people also look at, and if the stitched ropes are not too small, is there no point in combining some sheet segments in the rope-result. <br><br><h5>  Query substring </h5><br>  To select a substring in a string, it is enough to apply a simple algorithm, similar to the K-th ordinal statistics.  Let it be necessary to select in the rope <em><strong>T a</strong></em> substring of length <strong><em>len</em></strong> , starting with the symbol <em><strong>start</strong></em> . <br><br>  We first consider two extreme cases. <br>  If <nobr><code>start = 0</code></nobr> , and <nobr><code>len = T.Left.Size</code></nobr> , then the answer is the entire subtree of <code>T.Left</code> .  Similarly, if <nobr><code>start = T.Left.Size</code></nobr> , and <nobr><code>len = T.Right.Size</code></nobr> , then the answer is the entire subtree of <code>T.Right</code> .  In the figure above, the second case is implemented if you call the <code>Substring( <em>start</em> : 18, <em>len</em> : 37)</code> function <code>Substring( <em>start</em> : 18, <em>len</em> : 37)</code> , then the function will immediately return the right subtree with the required substring of <code>" ,     "</code> . <code>" ,     "</code> <br><br>  Further, it is possible that the required substring lies entirely in the left subtree, that is, <nobr><code>start &lt; T.Left.Size</code></nobr> and <nobr><code>start + len ‚â§ T.Left.Size</code></nobr> .  Then the search function substring is recursively called for the left subtree. <br>  The symmetric case is the entire substring in the right subtree, that is, <nobr><code>start ‚â• T.Left.Size</code></nobr> and <nobr><code>start + len ‚â§ T.Left.Size + T.Right.Size</code></nobr> .  Then the recursive search goes to the right subtree, only you need to remember to subtract the <code>start</code> size of the left subtree - after all, indexing in the right subtree will start from scratch, it considers itself an independent tree. <br>  In our example, you can make a call to <code>Substring( <em>start</em> : 18, <em>len</em> : 18)</code> .  Then, in the first step, the function will determine that it is necessary to descend recursively to the right and make a call to <code>Substring( <em>start</em> : 0, <em>len</em> : 18)</code> on the right subtree.  And he, in turn, according to the first case, will return to us entirely his left subtree, corresponding to the substring <code>" , "</code> . <code>" , "</code> <br><br><img src="https://habrastorage.org/storage/afce3866/0b74c4b5/8f07fae7/f1328424.png" align="right">  And finally, the most tricky case - the required substring overlaps a piece of both the left and right subtree. <br>  In this case, we will have to select the piece that is included only in the left subtree, then the piece that is included only in the right one, and merge them.  We already know how to merge two ropes together. <br>  Determining the indexes of the desired pieces is a snap.  Recursive call for the left subtree: <br> <nobr><code>Substring( <em>start</em> : start, <em>len</em> : T.Left.Size - start)</code></nobr> <br>  For the right: <br>  <nobr><code>Substring( <em>start</em> : 0, <em>len</em> : len - (T.Left.Size - start))</code></nobr> . <br>  Again, we had to pass a zero to the right subtree as a <code>start</code> argument, because the function on it will work independently. <br>  If these indices do not seem obvious - take a look at the picture. <br><br clear="right">  In the end, recursive calls reach the leaves, in which the query for the substring is already done in the usual linear fashion of the segment.  This ensures maximum performance.  The overall complexity of the operation is O (log N). <br><br><h5>  Other </h5><br>  I think there is no need to say that such a data structure can be used not only to implement strings.  Any giant sequence of elements can be represented in a similar form, it is enough to choose the optimal length for the underlying leaf segments, and - voila!  - we get a convenient data structure for manipulating immutable sequences of colossal length.  True, you will say that so far the operations have not been demonstrated enough to serve as a convincing argument for such a transition.  Nothing, it's fixable :) <br><br><blockquote>  As for the choice of structure.  You can choose an arbitrary self-balancing binary tree that stores its data in the leaves, for example, a <a href="http://ru.wikipedia.org/wiki/2-3-%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE" title="2-3 tree">2-3 tree</a> or a <a href="http://ru.wikipedia.org/wiki/B-%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE" title="B-tree">B-tree</a> .  Many search trees, created primarily to implement sets, store their data at each vertex, including a <a href="http://ru.wikipedia.org/wiki/%25D0%259A%25D1%2580%25D0%25B0%25D1%2581%25D0%25BD%25D0%25BE-%25D1%2587%25D1%2591%25D1%2580%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE" title="red and black tree">red-ebony</a> and a Cartesian tree.  Implementing string strings on them is impractical, it will lead to a large number of memory allocations during operations and somewhat complicated code, but the main task of this article is to parameterize trees with monoids - it is easy for both trees of the first and second types.  So in the course of the story, I will sometimes refer to the text of an article on the Cartesian tree, and sometimes to the <a href="http://en.wikipedia.org/wiki/Finger_tree" title="Finger tree">Finger tree</a> , in order to simplify my presentation and not litter it with details of realizations of various balanced trees, which would be completely superfluous here.  I hope the reader will perfectly understand and take any approach. </blockquote><br><br><h3>  Parameterization, or how to measure a tree </h3><br><br>  I hope you remember how, using the example of the Cartesian tree, we made multiple requests at sub-slices.  In brief, I will remind the essence of the concept: a certain <em>annotation</em> was stored in each vertex of the tree - a parameter equal to the requested value for a subsegment corresponding to the subtree with a root in this vertex.  For example, it could be the sum of the elements of a subtree, the maximum of the elements of a subtree, the presence or absence of a Boolean flag on the sub-crop, and so on.  When the user wanted to make a request for a subdivision, we didn‚Äôt have to re-consider it each time as O (N) for all the sought vertices, because for some subtrees the answers were already cached in the vertices, and it remained only to combine them. <br><br>  In the Cartesian tree, the Split function did all the ‚Äúhard work‚Äù to restore justice at each vertex for us; we just had to cut the required sub-segment from the tree and take the calculated value as the root of the query response.  But you could do otherwise.  Remember the algorithm for taking a substring in a rope?  He recursively descended from the top to the top, localizing the left and right border of the desired substring, and then merged everything that he finds along the way.  This approach could be perfectly applied here. <br><br>  Consider again the implicit Cartesian tree with annotations ‚Äî the sums of subtrees ‚Äî at the vertices, and we will try to make on it a request for the sum in a sub-section <code>[4; 8]</code>  <code>[4; 8]</code> . <br><img src="https://habrastorage.org/storage/6b5066e8/a162db0b/7b8a9389/cdfab6e6.png" align="right"><br>  Initialize the result to 0. <br>  At iteration 1, we descend into the left subtree [0;  9].  The result remains 0. <br>  At iteration 2 we descend into the right subtree [5;  9].  The result is increased by the value at the root - 42. <br>  At iteration 3 we descend into the right subtree [8;  9].  The result is increased by the sum of the left subtree [5;  6] plus the value at the root and becomes equal to 42 + 23 + 3 = 68. <br>  At iteration 4, we descend into the left subtree [8;  eight].  The result is 68. <br>  At iteration 5, we add to the result the value in the root (29), we get a total of 97, and this is the answer to the problem. <br><br>  The scheme is very simple, based on the already familiar case analysis at each vertex: how does the requested segment relate to the segments corresponding to my left son, right son and myself?  Based on this, we make either one or two recursive calls that calculate the values ‚Äã‚Äãin the left and right sub-spars and sum them (in the example above, two recursive calls were never needed).  Only now in the analysis of cases still have to take into account the data stored in the root. <br><br>  It is easy to imagine a rope storing segments of numbers in its leaves, and annotations at the vertices corresponding to the amounts in the sub-splines.  Then the sum request on any sub-row will be structurally identical to the algorithm for taking a substring from the previous paragraph, only along the way it will accumulate this sum, and returning from recursion add the answer to the result and transfer it higher.     ,   ,        . <br><br>     .       ,           ,     )   ; )      .     : <br>  : (C <sub>l</sub> + C <sub>l+1</sub> + ‚Ä¶ + C <sub>r</sub> ) <br>   : (C <sub>l</sub> + (((C <sub>l+1</sub> + ‚Ä¶ + C <sub>i</sub> ) + (C <sub>i+1</sub> + ‚Ä¶ + C <sub>j</sub> )) + (C <sub>j+1</sub> + ‚Ä¶ + C <sub>r-1</sub> ) + ‚Ä¶ + C <sub>r</sub> )) <br>        -  ,         ,  "+" ‚Äî  ! ,       :) ,      ‚Ä¶ <br><br><h5>  </h5><br>  ,   ,   , <strong></strong> .    ‚Äî    ,        .    :  ,  ,       .      , ,      . <br><br>   ,     ,       .                , <em>    </em> .               . <br><br>     : ,         ,        .    ,  -  !          ,   ‚Äî   .     O(log N).  Awesome <br><br>      .          .     ?  Very simple.        ,             .        ,        .       : <em>    ,     </em> . <br><br>  ¬´¬ª ‚Äî   <em>x</em>     &lt;, max, -‚àû&gt;. <br>  ¬´ ¬ª ‚Äî   <em>x <sup>2</sup></em>     &lt;, +, 0&gt;. <br>  ¬´ ¬ª ‚Äî   <em>¬´100%    ¬ª</em>     &lt;,      ,  &gt;.            . <br><br>  ,      ,  .         Haskell,        C#     : ,        ! <br>           //.    ,            , ,    ,    .        <code>Tree</code> , , <code>FingerTree</code> .    <code>ImplicitTreap</code> ,      ¬´ ¬ª  ,       ,         (null). <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,   . public interface IMeasured&lt;V&gt; { V Measure { get; } } //  :      public class IdentityMeasure&lt;T&gt; : IMeasured&lt;T&gt; { public readonly T Data; public IdentityMeasure(T data) { Data = data; } public T Measure { get { return Data; } } } // T -      // V -      // M - ,         public class Tree&lt;T, M, V&gt; : IMeasured&lt;V&gt; where M: IMonoid&lt;V&gt;, new() where T: IMeasured&lt;V&gt; { public readonly T Data; //    public readonly Tree&lt;T, M, V&gt; Left; public readonly Tree&lt;T, M, V&gt; Right; private readonly V _measure; public V Measure { get { return _measure; } } public Tree(T data) //   { Left = Right = null; Data = data; _measure = data.Measure; } public Tree(Tree&lt;T, M, V&gt; left, Tree&lt;T, M, V&gt; right) //   { Left = left; Right = right; Data = default(T); _measure = Singleton&lt;M&gt;.Instance.Append(left.Measure, right.Measure); } } //  ,      public class SumTree : Tree&lt;IdentityMeasure&lt;int&gt;, AddMonoid, int&gt; { public SumTree(int data) //   : base(new IdentityMeasure&lt;int&gt;(data)) {} public SumTree(SumTree left, SumTree right) //   : base(left, right) {} } //  ,      public class PriorityTree : Tree&lt;IdentityMeasure&lt;double&gt;, MaxMonoid, double&gt; { public PriorityTree(double data) //   : base(new IdentityMeasure&lt;double&gt;(data)) {} public PriorityTree(PriorityTree left, PriorityTree right) //   : base(left, right) {} }</span></span></code> </pre><br><br>              . <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//  . //      : Size = 1 + left.Size + right.Size; public readonly int Size = 1; public V MeasureOn(int start, int length) { if (start == 0 &amp;&amp; length == Left.Size) return Left.Measure; if (start == Left.Size &amp;&amp; length == Right.Size) return Right.Measure; if (start + length &lt;= Left.Size) return Left.MeasureOn(start, length); if (start &gt;= Left.Size) return Right.MeasureOn(start - Left.Size, length); var monoidV = Singleton&lt;M&gt;.Instance; var leftValue = Left.MeasureOn(start, Left.Size - start); var rightValue = Right.MeasureOn(0, length - (Left.Size - start)); return monoidV.Append(leftValue, rightValue); }</span></span></code> </pre><br><br><h3>  :  </h3><br>      ,      ,  .         .          ,    ,  ¬´  ¬ª    . <br><br> ,   ‚Äî   ,    ,         .            .   ,   ,     ‚Äî         ,     .  ,        . <br><br>   <em></em> <em><strong>p</strong></em> ,       . <br>       <nobr><em>a <sub>1</sub></em> ‚Ä¶ <em>a <sub>N</sub></em></nobr> .    - . ,    . <br><br>    <em> </em>  .     : <br> <em>a <sub>1</sub></em> <br> <em>a <sub>1</sub></em> ‚äó <em>a <sub>2</sub></em> <br> <em>a <sub>1</sub></em> ‚äó <em>a <sub>2</sub></em> ‚äó <em>a <sub>3</sub></em> <br>  ... <br> <em>a <sub>1</sub></em> ‚äó <em>a <sub>2</sub></em> ‚äó <em>a <sub>3</sub></em> ‚äó‚Ä¶ ‚äó <em>a <sub>N</sub></em> <br>  "‚äó",    , ‚Äî  .       . <br><br>         .    . <br>  ,   <strong></strong> ,          False,      False  True,     True   . <br>  ,   False  0,  True  1,       . <br><br>         .  <em>p</em> ( <em>s</em> ) = { <em>s</em>  <code>""</code>  }. <br>    ‚Äî   ,     . <br><img src="https://habrastorage.org/storage/5d6d0d37/3beae551/6f6fca46/0c109806.png"><br>     :      ,  ‚Äî  .            ,     ¬´¬ª. <br> ,      ,  ,  <nobr><em>p</em> ( <code>"   "</code> ) = False</nobr> , ,     ,    .         <nobr><em>p</em> ( <code>"    , "</code> ) = True</nobr> ,  ,     . <br><br>         ,             . <br><br>           ,    .           ,    . ,       :     ¬´  ¬ª  ¬´   ¬ª.   ,      . <br><br>    ¬´ ¬ª   ¬´ 256¬ª,  ,              ,     . <br><br>  .        ,   ,         <em>split</em> .        :        ,    ‚Äî  .    <em>split</em>         :) <br>  ,         . <br><blockquote>  ,               .           ,                 .          . </blockquote><br><br>   , ,  ,      <em>i</em> ‚Äî         ¬´  &gt; <em>i</em> ¬ª.   ‚Äî   ,     ,      .      ‚Äî  ,      &lt;, +, 0&gt;.  ‚Ññ <em>i</em> ‚Äî    ,       <em>i</em> . <br><br><h3>   </h3><br><br> ,     ,     ,     .      ¬´¬ª       ,        .    ,     ,       .      ,      .          ,     ,     . <br><br><h5>  ‚Ññ1:  </h5><br><br>      -   ,   .     ‚Ä¶ . <br><br> ,          ,   .     : <br> <strong><em>N</em></strong> ‚Äî  . <br> <strong><em>M</em></strong> ‚Äî   . <br> <strong><em>V</em></strong> ‚Äî  ,         . <br>   <em> </em> ,        .        ,     <em>N</em> . <br><img src="https://habrastorage.org/getpro/habr/post_images/42a/95b/e69/42a95be69539442684bfed608882de49.png" align="left"><img src="https://habrastorage.org/getpro/habr/post_images/603/a97/d4a/603a97d4a0d8ec02122f821213f46d23.png" align="left"><br><br clear="all"><br>    ,   ¬´  ¬ª. ,        :)           . <br> --,  ,         ‚Äî  ?   -?  -  , ?   ? <br><br>    .       <strong><em>A</em></strong>  <strong><em>B</em></strong>    .     ,    <strong><em>X</em></strong> ,   ‚Äî   . ,    1979  Tony Chan,           : <br><img src="https://habrastorage.org/getpro/habr/post_images/c8d/1c6/054/c8d1c60547bf21b1be362d5d6b8c1514.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/17e/35e/9df/17e35e9df442431188dba74a6baac66f.png"><br><img src="https://habrastorage.org/getpro/habr/post_images/1d4/a14/720/1d4a1472032e284c6b00dd985fb453cc.png"><br><br> ,    ,       ‚Äî        .  ,   . <br>    ,     .  , , 0,       0,       . ,    ‚Äî           . <br><br>      ,    ,   <a href="http://pastie.org/1491997">  pastie.org</a> ,           :) <br><br>       ,    ¬´¬ª  <strong><em>K</em></strong> , ..         <em>K</em> .  ,       ,   ,          .  Beauty. <br><br><h5>  ‚Ññ2: -  </h5><br><img src="https://habrastorage.org/storage/85362cc8/4bf33d76/21e347f3/254979fb.png" align="left"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are two translucent images (with alpha channel). </font><font style="vertical-align: inherit;">We want to define the </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">overlay</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> operator </font><em><font style="vertical-align: inherit;">of</font></em><font style="vertical-align: inherit;"> two images, better known as </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alpha composition</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Everyone who has ever played with translucent images in Photoshop is familiar with his action. </font></font><br><br clear="left"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Images have two parameters for each pixel: color </font></font><strong><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C</font></font></em></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and alpha channel </font></font><strong><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Œ±</font></font></em></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Setting the formulas for calculating these values ‚Äã‚Äãcompletely and uniquely defines the overlay operator. </font><font style="vertical-align: inherit;">So, it turns out that you can easily derive mathematically the following facts:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The overlap operator is associative; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Any image with an alpha channel of 0 is used for the overlay operator by one. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For proof of these facts and specific formulas I refer you to the corresponding </font></font><a href="http://en.wikipedia.org/wiki/Alpha_compositing"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wikipedia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> article </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, translucent images on the operation of alpha-composition form a monoid. </font><font style="vertical-align: inherit;">This gives us the opportunity to process gigantic sets of images that have to be superimposed one after another with the help of the corresponding tree.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Example # 3: regular expressions </font></font></h5><br>  , ,    ,             ,           .       <em> </em> ‚Äî ,       ,        ,        .       <a href="http://fprog.ru/2010/issue6/dan-piponi-fast-incremental-regular-expression/">  </a>      <a href="http://fprog.ru/2010/issue6/eugene-kirpichov-incremental-regular-expressions/">-</a>  . -: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/df1/a6e/d74/df1a6ed74e92815c769705981e45649e.png"></div><br><br>       . </div><p>Source: <a href="https://habr.com/ru/post/112394/">https://habr.com/ru/post/112394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112388/index.html">Another hot offer from GoDaddy.com</a></li>
<li><a href="../112389/index.html">The number of downloads of applications from the Apple App Store has exceeded 10 billion</a></li>
<li><a href="../112390/index.html">Virtual Juniper`s Mythbusters: Policies & Filters</a></li>
<li><a href="../112392/index.html">In Russia, more and more mobile phone owners are using mobile Internet access.</a></li>
<li><a href="../112393/index.html">Who will take a pack of tickets, he will receive a water pump!</a></li>
<li><a href="../112396/index.html">The creators of Pirate Bay are planning to launch Music Bay</a></li>
<li><a href="../112399/index.html">‚ÄúWhen ideas are worth something‚Äù or what if the scheme is ‚Äúflipped‚Äù?</a></li>
<li><a href="../112400/index.html">Exposing rasterization algorithms fonts (2/2)</a></li>
<li><a href="../112401/index.html">Exposing font rasterization algorithms (1/2)</a></li>
<li><a href="../112402/index.html">The fastest settings for PHP scripts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>