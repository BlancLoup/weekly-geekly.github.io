<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write our intermediate driver. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrayuzer! 
 Have you ever wondered how the sniffer works and what it is? Or how your favorite firewall protects you from trojans and oth...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write our intermediate driver. Part 1</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habrayuzer! <br>  Have you ever wondered how the sniffer works and what it is?  Or how your favorite firewall protects you from trojans and other nastiness at the network level?  Anyway, how does it work?  I am sure that you asked yourself this kind of questions, but still, if not, then I‚Äôll tell you in part about it.  Starting from this article, we will gradually master the writing of our sniffer-like driver.  Today we will look at some of the general provisions that we will need to understand everything that will happen in subsequent articles.  Before reading this article, so that you begin to develop a more or less clear picture, I recommend you to read the past topic <a href="http://habrahabr.ru/blogs/programming/111592/">Overview of the drivers of the NDIS specification</a> <br><br>  Anyone interested is asking for cat. <br><a name="habracut"></a><br>  I‚Äôll say right away that the article is focused on users who have little knowledge of this topic, so I will try to explain some things in detail.  Well, let's get started. <br><br><h4>  What do we need and where to start? </h4><br>  In many forums, very often you can see the issues of such a setting: ‚ÄúI am a novice programmer, I want to write drivers, but I don‚Äôt know how.  Where should I start? ‚ÄùTherefore, trying to describe everything consistently, I found it necessary to tell us what we need. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you decide to start writing drivers, whether they are regular drivers or whether they are networked, you will definitely need to <a href="http://www.microsoft.com/whdc/devtools/wdk/wdkpkg.mspx">download the</a> WDK-Windows Driver Kits (also known as NT DDK).  By installing this stuff on your workhorse, you will become armed to write your driver.  Together with the WDK comes its own documentation, headings, or examples (we will need them, becoming the skeleton of our future driver).  Working in Visual Studio, you can also <a href="http://visualddk.sysprogs.org/">download</a> a VS plugin called Visual DDK.  This integration tool will help you write (and build) drivers directly from Visual Studio.  <a href="http://visualddk.sysprogs.org/quickstart/">Here</a> you can find a brief help on the use of this tool.  I want to emphasize that the installation of Visual DDK for working with drivers from the studio is not at all mandatory; you can write and assemble your drivers in VS without this tool!  This is just a plugin. <br><br>  We will consider an example of an intermediate driver from the WDK and modify it.  Why interim?  Those familiar with the previous <a href="http://habrahabr.ru/blogs/programming/111592/">article</a> or simply summarizing in the NDIS specification know that the intermediate network driver combines the behavior of both protocol drivers and miniport drivers, being a layer between them.  Thus, this example can cover at least partially all types of NDIS drivers. <br><br>  So, the Passthru driver from the WDK will be the skeleton of our driver.  By installing the WDK, you can find its source in the \ src \ network \ ndis \ passthru directory.  More information about this source can be found <a href="http://msdn.microsoft.com/en-us/library/ff569982(VS.85).aspx">here</a> . What does this driver do?  So far, nothing, he just is and everything.  What will our driver do?  It will play the role of a sniffer, accepting and sending packets, receiving information about them and possibly blocking or modifying it.  To begin with, we will add some functionality to it, write a client program through which we will communicate with our driver, but this will be only in the next articles, but for now we will study a little theory. <br><br><h4>  A bit of theory </h4><br>  As you probably know, the DriverEntry function is an analogue of the main function in the drivers, the intermediate driver has a number of things he needs to do before starting to function.  And he should do the following in DriverEntry: <br><ul><li>  register yourself with NDIS (using the NdisMInitializeWrapper function); </li><li>  register your ‚Äútop view‚Äù - a virtual adapter (using the NdisIMRegisterLayeredMiniport function); </li><li>  register your ‚Äúbottom view‚Äù (virtual protocol) (using the NdisRegisterProtocol function); </li><li>  report to NDIS that "top view" and "bottom view" are different types of the same driver (using the NdisIMAssociateMiniport function). </li></ul><br>  That's all.  Remember in the last article I wrote about the callback system of the miniport and protocol drivers?  So, performing these 4 actions, the intermediate driver registers its callback functions here.  If you have previously dealt with miniport and / or protocol drivers, you will notice that the NdisIMRegisterLayeredMiniport function is very similar to the NdisMRegisterMiniport function (called when a non-virtual adapter is registered), and when creating both a virtual protocol and a non-virtual protocol, one and the same same function NdisRegisterProtocol.  Initially, you fill in the fields of the NDIS_PROTOCOL_CHARACTERISTICS and NDIS_MINIPORT_CHARACTERISTICS structures (the names of the used callbacks are recorded here), and then pass them as parameters to the corresponding functions. <br><br>  Now let's talk a bit about sniffers. <br><br><h4>  A little bit about sniffer, quite a bit </h4><br>  <b>A sniffer</b> is a driver that intercepts and possibly modifies the network traffic of a local computer or all computers of the current network segment.  I hate everything you know what it is and at least once in your life used it or at least just saw it.  Let's consider the possible schemes for constructing a sniffer: <br><ol><li>  The sniffer is <u>an intermediate driver</u> that is stuck in all the available bindings of the protocols to the adapters.  This is actually the easiest way possible.  In addition to the advantages, each method has its drawbacks: <br><ul><li>  to make new bindings work, you need to restart all network adapters present in the system; </li><li>  if there is more than one network adapter in the system, the sniffer has to either restrict interception to only one subnetwork, or prohibit routing, or create more than one virtual adapter; </li><li>  each time a new adapter, protocol, or intermediate driver appears in the system, it is necessary to reconfigure protocol bindings to adapters.  If this is not done, the sniffer, at best, will stop intercepting some of the traffic, and at worst, it will crash the system altogether; </li><li>  if the processor is slow, the memory is low, and the network channel is very fast, slowing down the system operation by the intermediate driver can become critical. </li></ul><br></li><li>  The sniffer is a driver filter.  What is meant by this?  And the following is implied: we kind of join a device that we suspect (each driver has its own device), for example, on \ Device \ Tcp (this device is the driver-protocol tcpip.sys), and after that each IRP directed to this device first sent to our driver.  Again the disadvantages: <br><ul><li>  driver filter can intercept only those information flows that are implemented through the IRP, i.e.  only information flows between protocol drivers and their clients; </li><li>  the driver-filter should be loaded before all the kernel-mode clients of the device of interest to us, otherwise some of the traffic will go past; </li><li>  driver filter greatly slows down the system; </li><li>  it is very difficult to properly debug the driver filter (we will talk about debugging in subsequent articles).  There can be a lot of various glitches. </li></ul><br></li><li>  The sniffer is a protocol driver that binds to all adapters in the system.  So, almost all sniffers intercept <u>incoming</u> traffic, including WinPCAP and Microsoft Network Monitor ( <u>outgoing</u> traffic is intercepted according to scheme 5).  The method is almost perfect. </li><li>  Sniffer is a regular driver, whose functions are called from NDIS as needed.  This is how Windows XP's built-in packet filter works.  No one else can work this way, since support for such a driver should be initially incorporated into NDIS by Microsoft programmers. </li><li>  The sniffer is a regular driver that just blatantly patches NDIS structures in which the addresses of NDIS driver callbacks are written.  As a result, when calling any intercepted callback of any NDIS driver, the sniffer gets control.  So almost all third-party packet filters work (OutPost for example).  Only one drawback - it is not very reliable. </li></ol><br><h5>  Mini conclusion </h5><br>  Well, here it is about all the basic information that we will need to write our intermediate driver.  In the next article we will start writing code directly, let's talk about IRP.  Next, we will also look at installing and debugging drivers.  I really hope that this topic is interesting for you and if it is so, then I will gladly cover it for you. <br>  Thank you for attention. </div><p>Source: <a href="https://habr.com/ru/post/111672/">https://habr.com/ru/post/111672/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111664/index.html">Software engineer and mathematician - the best professions of 2011 in the USA</a></li>
<li><a href="../111666/index.html">Creating and publishing an extension</a></li>
<li><a href="../111668/index.html">Google Goggles - Solve Sudoku</a></li>
<li><a href="../111670/index.html">Choosing from a long list, speeding up the process correctly</a></li>
<li><a href="../111671/index.html">We create an original gift with the help of chemistry, physics and electronics: part 3</a></li>
<li><a href="../111673/index.html">Duokan. Or how to read DJVU on Kindle</a></li>
<li><a href="../111674/index.html">Software life cycle models</a></li>
<li><a href="../111675/index.html">Construction of the suffix tree: Ukkonen algorithm</a></li>
<li><a href="../111676/index.html">loop_dance - quick deployment background scheduler</a></li>
<li><a href="../111678/index.html">System automatically generate settings for the DNS server Bind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>