<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to fasten a tracing from the browser to any project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 My name is Kostya, I am developing a Yandex Browser. Recently, we had a small C ++ party in our Novosibirsk office in Akademgorodok, where I ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to fasten a tracing from the browser to any project</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  My name is Kostya, I am developing a Yandex Browser.  Recently, we had a small C ++ party in our Novosibirsk office in Akademgorodok, where I talked about what tools we use to develop a browser and what can be borrowed for other large projects, for example, <a href="http://martine.github.io/ninja/manual.html">ninja</a> , <a href="https://www.chromium.org/developers/owners-files">OWNERS</a> .  During development, we are very closely monitoring performance: CPU utilization, memory consumption, execution time for various operations, and so on.  At the same time various utilities are actively used, but also internal browser debugging tools, for example, the internal browser: // tracing page (for Yandex Browser, chrome: // tracing for Chromium and Chrome). <br><div class="spoiler">  <b class="spoiler_title">Screenshot browser: // tracing</b> <div class="spoiler_text"> <a href=""><img src="https://habrastorage.org/files/44a/8e3/9ad/44a8e39ad03042399ac0287376136825.png"></a> <br></div></div><br>  In short, on this page you can trace the duration of the execution of various functions and the number of calls broken down by processes, threads and passed arguments.  Of course, there is no magic in it, and in order for this to work, you need to place special macros on the code.  As it seems to me, this is a very handy tool that allows you to find a bunch of different problems.  I believe that such a tool can be useful in other projects, so I decided to show how to use it. <br><a name="habracut"></a><br><h4>  Why do you need it? </h4><br>  Of course, in order to track projects there are a variety of tools, but they all have a huge minus - they cannot be used by a specific user, although this can be very important for understanding and diagnosing a problem.  Diagnostics that the browser collects on the browser: // tracing can be collected at any time.  It can be included only for a certain period in order to repeat the bug, and in other moments it does not bring a big overhead projector. <br><br><h4>  What do we need? </h4><br>  First of all, of course, source codes will be needed.  By and large, what we need is located in the <a href="https://code.google.com/p/chromium/codesearch">base / trace_event folder</a> inside it, including other components from the base subfolder, for example, time, threading, synchronization, etc.  I decided to do very simply and simply link with base.dll from the chromium assembly.  Fortunately, I have a chromium repository even on a home computer, not to mention the workers.  For those who want to go the same way, <a href="https://www.chromium.org/developers/how-tos">there</a> are links to instructions for building for different platforms.  Important: for component assembly you need to set the environment variable <b>GYP_DEFINES = "component = shared_library"</b> . <br>  Secondly, we need header files that can be taken <a href="https://chromium.googlesource.com/chromium/src.git/%2B/master/base/">here</a> . <br>  Alternatively, instead of these two points, you can make it easier and add files from the base to your project. <br><br><h4>  Turn on tracing and use </h4><br>  First we need to turn on the tracing.  To do this, you need to create a category filter that we want to apply.  A category is an identifier for a group of a tracked operation.  Categories are needed to select which groups we want to track at the moment.  Then you need to call the SetEnabled method on the singleton class TraceLog. <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> kCategoryName[] = <span class="hljs-string"><span class="hljs-string">"my_category"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartTracing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ base::trace_event::<span class="hljs-function"><span class="hljs-function">CategoryFilter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">category_filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(kCategoryName)</span></span></span></span>; base::trace_event::TraceLog::GetInstance()-&gt;SetEnabled( category_filter, base::trace_event::TraceLog::RECORDING_MODE, base::trace_event::TraceOptions(base::trace_event::RECORD_UNTIL_FULL)); }</code> </pre> <br>  Now we‚Äôll come up with a complex task, the execution time of which we want to track and add the TRACE_EVENT macro in the right places.  This macro expands to instantiate an object of the ScopedTracer class, which, as you might guess, will report on the execution duration within the scope.  More details can be found <a href="https://code.google.com/p/chromium/codesearch">here.</a> <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeHardcoreTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> max_num)</span></span></span><span class="hljs-function"> </span></span>{ TRACE_EVENT1(kCategoryName, <span class="hljs-string"><span class="hljs-string">"SomeHardcoreTask"</span></span>, <span class="hljs-string"><span class="hljs-string">"max_num"</span></span>, max_num); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x = <span class="hljs-number"><span class="hljs-number">1.5f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; max_num; ++i) x *= <span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(x) / <span class="hljs-built_in"><span class="hljs-built_in">atan</span></span>(x) * <span class="hljs-built_in"><span class="hljs-built_in">tanh</span></span>(x) * <span class="hljs-built_in"><span class="hljs-built_in">sqrt</span></span>(x); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeHardcoreAsyncTask</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( base::WaitableEvent* event, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> base::Callback&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)&gt;&amp; out_cb)</span></span></span><span class="hljs-function"> </span></span>{ TRACE_EVENT0(kCategoryName, <span class="hljs-string"><span class="hljs-string">"SomeHardcoreAsyncTask"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i : {<span class="hljs-number"><span class="hljs-number">20000000</span></span>, <span class="hljs-number"><span class="hljs-number">5000000</span></span>, <span class="hljs-number"><span class="hljs-number">80000000</span></span>}) out_cb.Run(SomeHardcoreTask(i)); event-&gt;Signal(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AsyncTaskCb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoWork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ TRACE_EVENT0(kCategoryName, <span class="hljs-string"><span class="hljs-string">"DoWork"</span></span>); base::<span class="hljs-function"><span class="hljs-function">Thread </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"HardcoreTaskThread"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; thread.Start(); base::<span class="hljs-function"><span class="hljs-function">WaitableEvent </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; thread.message_loop_proxy()-&gt;PostDelayedTask( FROM_HERE, base::Bind(&amp;SomeHardcoreAsyncTask, &amp;event, base::Bind(&amp;AsyncTaskCb)), base::TimeDelta::FromSeconds(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i : {<span class="hljs-number"><span class="hljs-number">10000000</span></span>, <span class="hljs-number"><span class="hljs-number">20000000</span></span>, <span class="hljs-number"><span class="hljs-number">50000000</span></span>}) <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; SomeHardcoreTask(i); event.Wait(); }</code> </pre><br>  The final part is left - you need to turn off the tracing and save the results to disk.  I admit right <a href="https://code.google.com/p/chromium/codesearch">away</a> that basically the code is taken <a href="https://code.google.com/p/chromium/codesearch">from here.</a> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> kTracingJsonPath[] = <span class="hljs-string"><span class="hljs-string">"D:\\trace.json"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// -,          . void WriteTraceDataCollected( base::File* output_file, const scoped_refptr&lt;base::RefCountedString&gt;&amp; events_str, bool has_more_events) { output_file-&gt;WriteAtCurrentPos(events_str-&gt;data().c_str(), events_str-&gt;data().length()); if (has_more_events) output_file-&gt;WriteAtCurrentPos(",", 1); } //       . void StopTracingAndFlushToDisk() { base::trace_event::TraceLog::GetInstance()-&gt;SetDisabled(); base::File output(base::FilePath::FromUTF8Unsafe(kTracingJsonPath), base::File::FLAG_CREATE_ALWAYS | base::File::FLAG_WRITE); CHECK(output.IsValid()); static const char kStart[] = "{\"traceEvents\":["; static const char kEnd[] = "]}"; output.WriteAtCurrentPos(kStart, strlen(kStart)); base::trace_event::TraceLog::GetInstance()-&gt;SetDisabled(); base::trace_event::TraceLog::GetInstance()-&gt;Flush( base::Bind(&amp;WriteTraceDataCollected, &amp;output)); output.WriteAtCurrentPos(kEnd, strlen(kEnd)); output.Close(); }</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, everything you need is there, it remains only to collect everything in one pile. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ StartTracing(); DoWork(); StopTracingAndFlushToDisk(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><div class="spoiler">  <b class="spoiler_title">All code together</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NOMINMAX #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;base/files/file.h&gt; #include &lt;base/synchronization/waitable_event.h&gt; #include &lt;base/trace_event/trace_event.h&gt; namespace { const char kCategoryName[] = "my_category"; const char kTracingJsonPath[] = "D:\\trace.json"; void WriteTraceDataCollected( base::File* output_file, const scoped_refptr&lt;base::RefCountedString&gt;&amp; events_str, bool has_more_events) { output_file-&gt;WriteAtCurrentPos(events_str-&gt;data().c_str(), events_str-&gt;data().length()); if (has_more_events) output_file-&gt;WriteAtCurrentPos(",", 1); } void StartTracing() { base::trace_event::CategoryFilter category_filter(kCategoryName); base::trace_event::TraceLog::GetInstance()-&gt;SetEnabled( category_filter, base::trace_event::TraceLog::RECORDING_MODE, base::trace_event::TraceOptions(base::trace_event::RECORD_UNTIL_FULL)); } void StopTracingAndFlushToDisk() { base::trace_event::TraceLog::GetInstance()-&gt;SetDisabled(); base::File output(base::FilePath::FromUTF8Unsafe(kTracingJsonPath), base::File::FLAG_CREATE_ALWAYS | base::File::FLAG_WRITE); CHECK(output.IsValid()); static const char kStart[] = "{\"traceEvents\":["; static const char kEnd[] = "]}"; output.WriteAtCurrentPos(kStart, strlen(kStart)); base::trace_event::TraceLog::GetInstance()-&gt;SetDisabled(); base::trace_event::TraceLog::GetInstance()-&gt;Flush( base::Bind(&amp;WriteTraceDataCollected, &amp;output)); output.WriteAtCurrentPos(kEnd, strlen(kEnd)); output.Close(); } float SomeHardcoreTask(int max_num) { TRACE_EVENT1(kCategoryName, "SomeHardcoreTask", "max_num", max_num); float x = 1.5f; for (int i = 0; i &lt; max_num; ++i) x *= sin(x) / atan(x) * tanh(x) * sqrt(x); return x; } void SomeHardcoreAsyncTask( base::WaitableEvent* event, const base::Callback&lt;void(float)&gt;&amp; out_cb) { TRACE_EVENT0(kCategoryName, "SomeHardcoreAsyncTask"); for (int i : {20000000, 5000000, 80000000}) out_cb.Run(SomeHardcoreTask(i)); event-&gt;Signal(); } void AsyncTaskCb(float x) { } void DoWork() { TRACE_EVENT0(kCategoryName, "DoWork"); base::Thread thread("HardcoreTaskThread"); thread.Start(); base::WaitableEvent event(false, false); thread.message_loop_proxy()-&gt;PostDelayedTask( FROM_HERE, base::Bind(&amp;SomeHardcoreAsyncTask, &amp;event, base::Bind(&amp;AsyncTaskCb)), base::TimeDelta::FromSeconds(2)); for (int i : {10000000, 20000000, 50000000}) std::cout &lt;&lt; SomeHardcoreTask(i); event.Wait(); } } // namespace int main() { StartTracing(); DoWork(); StopTracingAndFlushToDisk(); return 0; }</span></span></span></span></code> </pre><br></div></div><br><br><h4>  Result </h4><br>  As a result, we get the trace.json file, which can be opened on the browser: // tracing and see the following: <br> <a href=""><img src="//habrastorage.org/files/87b/02b/831/87b02b8316a14100a1e1ff79e9a84800.png"></a> <br><br><h4>  Conclusion </h4><br>  As you can see, it turned out to be very easy to borrow quite useful functionality from chromium and apply it.  I would like to emphasize that in addition to this, the source code of chromium has a lot of interesting approaches and simply ready-made solutions that you can apply in one way or another in your project. <br>  If someone has more similar examples - tell us about them in the comments.  From myself I can add that, for example, in the YT Yandex distributed computing framework, chromium callbacks are used, which were slightly modified with a file.  I also once heard a story about Indians who made a client for a cloud drive on the basis of chromium, but I can‚Äôt find proofs now. <br><br><h4>  useful links </h4><br>  <a href="https://www.chromium.org/developers/design-documents">https://www.chromium.org/developers/design-documents</a> <br>  <a href="https://code.google.com/p/chromium/codesearch">https://code.google.com/p/chromium/codesearch#chromium/src/base/</a> <br>  <a href="https://www.chromium.org/developers/how-tos/trace-event-profiling-tool">https://www.chromium.org/developers/how-tos/trace-event-profiling-tool</a> </div><p>Source: <a href="https://habr.com/ru/post/256907/">https://habr.com/ru/post/256907/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256893/index.html">Work with date and time in Perl6</a></li>
<li><a href="../256895/index.html">How to recover data from faulty SSD</a></li>
<li><a href="../256899/index.html">Announcement of the fourth meeting of the Java User Group EKB</a></li>
<li><a href="../256901/index.html">55 questions to ask when designing a logo</a></li>
<li><a href="../256905/index.html">Writing Your Spliterator</a></li>
<li><a href="../256909/index.html">NGINX 1.8 and 1.9 release</a></li>
<li><a href="../256911/index.html">PLC Ace: small controller for smart home</a></li>
<li><a href="../256915/index.html">Preparatory stage of software development</a></li>
<li><a href="../256917/index.html">Overview of the new Microsoft Azure Management Portal - Azure Preview</a></li>
<li><a href="../256919/index.html">What is wrong with air service interfaces # 2: How Aviageek changed after the post on Habr√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>