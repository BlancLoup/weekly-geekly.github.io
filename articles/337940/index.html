<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write telegrams of a bot parser of vacancies on JS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The subject of creating bots for Telegram is becoming increasingly popular, attracting programmers to try their hand at this field. Everyone periodica...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write telegrams of a bot parser of vacancies on JS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/d3/86/59d3867ce9243909001139.jpeg"><br><br>  The subject of creating bots for Telegram is becoming increasingly popular, attracting programmers to try their hand at this field.  Everyone periodically has ideas and tasks that can be solved by writing a thematic bot.  For me, as a JS programmer, an example of such an urgent task is to monitor the job market on relevant topics. <br><br>  However, one of the most popular languages ‚Äã‚Äãand technologies in the field of creating bots is Python, offering the programmer a huge amount of good libraries for processing and parsing various sources of information in the form of text.  I also wanted to do it in JavaScript ‚Äî one of my favorite languages. <br><a name="habracut"></a><br><h4>  Task </h4><br>  The main task: to create a detailed job tape with tagging and nice visual markup.  It can be divided into separate subtasks: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  interaction with the Telegram API; </li><li>  parsing RSS feeds of job sites; </li><li>  parsing a single job; </li><li>  thematic tagging; </li><li>  visual design information; </li><li>  duplication prevention. </li></ul><br>  At first, I thought of using a generic ready-made bot, for example, <a href="https://t.me/TheFeedReaderBot">@TheFeedReaderBot</a> .  But after his detailed study, it turned out that tagging was completely absent, and the possibilities for customizing the display of content were severely limited.  Fortunately, modern Javascript provides many libraries to help solve these problems.  But first things first. <br><br><h4>  Bot frame </h4><br>  Of course, it would be possible to interact directly with the Telegram REST API, but in terms of labor costs it is easier to take ready-made solutions.  Therefore, I selected the <a href="https://github.com/edisonchee/slimbot">slimbot</a> npm package referenced in the official bot tutorials.  And although we will only send messages, this package will significantly simplify life by allowing you to create an internal bot API as an entity: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Slimbot = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'slimbot'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config.json'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Slimbot(config.TELEGRAM_API_KEY); bot.startPolling(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logMessageToAdmin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message, type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Error'</span></span></span></span></span><span class="hljs-function">) </span></span>{ bot.sendMessage(config.ADMIN_USER, <span class="hljs-string"><span class="hljs-string">`&lt;b&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${type}</span></span></span><span class="hljs-string">&lt;/b&gt;\n&lt;code&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${message}</span></span></span><span class="hljs-string">&lt;/code&gt;`</span></span>, { <span class="hljs-attr"><span class="hljs-attr">parse_mode</span></span>: <span class="hljs-string"><span class="hljs-string">'HTML'</span></span> }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postVacancy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ bot.sendMessage(config.TARGET_CHANNEL, message, { <span class="hljs-attr"><span class="hljs-attr">parse_mode</span></span>: <span class="hljs-string"><span class="hljs-string">'HTML'</span></span>, <span class="hljs-attr"><span class="hljs-attr">disable_web_page_preview</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">disable_notification</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }); } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { postVacancy, logMessageToAdmin };</code> </pre> <br>  We will use the usual setInterval as a scheduler, and <a href="https://www.npmjs.com/package/feed-read">feed-read</a> will be used for parsing RSS, and the source of vacancies will be My Circle sites and hh.ru. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> feed = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"feed-read"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config.json'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> HhAdapter = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./adapters/hh'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MoikrugAdapter = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./adapters/moikrug'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bot = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./bot'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { FeedItemModel } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./lib/models'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processFeed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">articles, adapter</span></span></span><span class="hljs-function">) </span></span>{ articles.forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">article</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (adapter.isValid(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">article</span></span></span><span class="hljs-function">))) { </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">const</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">key</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">getKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">article</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FeedItemModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ key, data: article }</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">then</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> model =&gt; adapter.parseItem(article</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">then</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bot.postVacancy</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> {} ); } }); } setInterval(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { feed(config.HH_FEED, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, articles</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { bot.logMessageToAdmin(err); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } processFeed(articles, HhAdapter); }); feed(config.MOIKRUG_FEED, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, articles</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { bot.logMessageToAdmin(err); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } processFeed(articles, MoikrugAdapter); }); }, config.REQUEST_PERIOD_TIME);</code> </pre><br><h4>  Parsing a single job </h4><br>  Due to the different structure of the vacancy pages for each source site, the implementation of parsing is different.  Therefore, adapters providing a unified interface were used.  To work with DOM on the server, the <a href="https://www.npmjs.com/package/jsdom">jsdom</a> library came <a href="https://www.npmjs.com/package/jsdom">up</a> , with which you can perform standard operations: finding an element by a CSS selector, getting the contents of an element that we actively use. <br><br><div class="spoiler">  <b class="spoiler_title">MoikrugAdapter</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'superagent'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> jsdom = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jsdom'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { JSDOM } = jsdom; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { getTags } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/tagger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { getJobType } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/jobType'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { render } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/render'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { request .get(item.link) .end(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); reject(err); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSDOM(res.text); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> element = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">".vacancy_description"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> salaryElem = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">".footer_meta .salary"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> salary = salaryElem ? salaryElem.textContent : <span class="hljs-string"><span class="hljs-string">' .'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> locationElem = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">".footer_meta .location"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> location = locationElem &amp;&amp; locationElem.textContent; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> title = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">".company_name"</span></span>).textContent; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> titleFooter = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">".footer_meta"</span></span>).textContent; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pureContent = element.textContent; resolve(render({ <span class="hljs-attr"><span class="hljs-attr">tags</span></span>: getTags(pureContent), <span class="hljs-attr"><span class="hljs-attr">salary</span></span>: <span class="hljs-string"><span class="hljs-string">`: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${salary}</span></span></span><span class="hljs-string">`</span></span>, location, title, <span class="hljs-attr"><span class="hljs-attr">link</span></span>: item.link, <span class="hljs-attr"><span class="hljs-attr">description</span></span>: element.innerHTML, <span class="hljs-attr"><span class="hljs-attr">jobType</span></span>: getJobType(titleFooter), <span class="hljs-attr"><span class="hljs-attr">important</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.from(element.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'strong'</span></span>)).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.textContent) })) }); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> item.link; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { getKey, isValid, parseItem };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Hhadapter</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> request = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'superagent'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> jsdom = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jsdom'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { JSDOM } = jsdom; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { getTags } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/tagger'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { getJobType } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/jobType'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { render } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../lib/render'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseItem</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> splited = item.content.split(<span class="hljs-regexp"><span class="hljs-regexp">/\n&lt;p&gt;|&lt;\/p&gt;&lt;p&gt;|&lt;\/p&gt;\n/</span></span>).filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function"> =&gt;</span></span> i); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [ title, date, region, salary ] = splited; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { request .get(item.link) .end(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); reject(err); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dom = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSDOM(res.text); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> element = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">'.b-vacancy-desc-wrapper'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> title = dom.window.document.querySelector(<span class="hljs-string"><span class="hljs-string">'.companyname'</span></span>).textContent; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> pureContent = element.textContent; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tags = getTags(pureContent); resolve(render({ title, <span class="hljs-attr"><span class="hljs-attr">location</span></span>: region.split(<span class="hljs-string"><span class="hljs-string">': '</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>] || region, <span class="hljs-attr"><span class="hljs-attr">salary</span></span>: <span class="hljs-string"><span class="hljs-string">`: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${salary.split(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">': '</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)[</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">1</span></span></span></span><span class="hljs-string"><span class="hljs-subst">] || salary}</span></span></span><span class="hljs-string">`</span></span>, tags, <span class="hljs-attr"><span class="hljs-attr">description</span></span>: element.innerHTML, <span class="hljs-attr"><span class="hljs-attr">link</span></span>: item.link, <span class="hljs-attr"><span class="hljs-attr">jobType</span></span>: getJobType(pureContent), <span class="hljs-attr"><span class="hljs-attr">important</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.from(element.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'strong'</span></span>)).map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.textContent) })) }); }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> item.link; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { getKey, isValid, parseItem };</code> </pre><br></div></div><br><h4>  Formatting </h4><br>  After parsing, you need to present information in a convenient form, but with the Telegram API there are not so many possibilities for this: only unicode tags and symbols can be put in messages (emoticons and stickers do not count).  At the input we get a pair of semantic fields in the description and the description itself in raw HTML.  After a short search, we find the solution - the <a href="https://www.npmjs.com/package/html-to-text">html-to-text</a> library.  After a detailed study of the API and its implementation, one involuntarily wonders why the formatting functions are called not from a dynamic config, but through a closure, which eliminates many of the advantages provided by configuration parameters.  And in order to beautifully display bullets instead of <code>li</code> in lists, you have to cheat a little: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> htmlToText = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'html-to-text'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> whiteSpaceRegex = <span class="hljs-regexp"><span class="hljs-regexp">/^\s*$/</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ title, location, salary, tags, description, link, important = [], jobType=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params"> }</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> formattedDescription = htmlToText .fromString(description, { <span class="hljs-attr"><span class="hljs-attr">wordwrap</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">noLinkBrackets</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">hideLinkHrefIfSameAsText</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">format</span></span>: { <span class="hljs-attr"><span class="hljs-attr">unorderedList</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">formatUnorderedList</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">elem, fn, options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> nonWhiteSpaceChildren = (elem.children || []).filter( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">c</span></span></span><span class="hljs-function"> =&gt;</span></span> c.type !== <span class="hljs-string"><span class="hljs-string">'text'</span></span> || !whiteSpaceRegex.test(c.data) ); nonWhiteSpaceChildren.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">elem</span></span></span><span class="hljs-function">) </span></span>{ result += <span class="hljs-string"><span class="hljs-string">' &lt;b&gt;‚óè&lt;/b&gt; '</span></span> + fn(elem.children, options) + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'\n'</span></span> + result + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>; } } }) .replace(<span class="hljs-regexp"><span class="hljs-regexp">/\n\s*\n/g</span></span>, <span class="hljs-string"><span class="hljs-string">'\n'</span></span>); important.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function"> =&gt;</span></span> text.includes(<span class="hljs-string"><span class="hljs-string">':'</span></span>)).forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function"> =&gt;</span></span> { formattedDescription = formattedDescription.replace( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">RegExp</span></span>(text, <span class="hljs-string"><span class="hljs-string">'g'</span></span>), <span class="hljs-string"><span class="hljs-string">`&lt;b&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${text}</span></span></span><span class="hljs-string">&lt;/b&gt;`</span></span> ) }); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> formattedTags = tags.map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'#'</span></span> + t).join(<span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> locationFormatted = location ? <span class="hljs-string"><span class="hljs-string">`#</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${location.replace(</span></span><span class="hljs-regexp"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-regexp">/ |-/g</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'_'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string"> `</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`&lt;b&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${title}</span></span></span><span class="hljs-string">&lt;/b&gt;\n</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${locationFormatted}</span></span></span><span class="hljs-string">#</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${jobType}</span></span></span><span class="hljs-string">\n&lt;b&gt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${salary}</span></span></span><span class="hljs-string">&lt;/b&gt;\n</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${formattedTags}</span></span></span><span class="hljs-string">\n</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${formattedDescription}</span></span></span><span class="hljs-string">\n</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${link}</span></span></span><span class="hljs-string">`</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { render };</code> </pre><br><h4>  Tagging </h4><br>  Suppose we have beautiful job descriptions, but not enough tagging.  To resolve this issue, I tokenized the natural Russian language using the <a href="https://www.npmjs.com/package/az">az</a> library.  So I got the filtering of words in the stream of tokens and replacing with tags if there are corresponding words in the tag dictionary. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Az = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'az'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> namesMap = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../resources/tagNames.json'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyUnique</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value, index, self</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.indexOf(value) === index; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTags</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pureContent</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tokens = Az.Tokens(pureContent).done(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> tags = tokens.filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> t.type.toString() === <span class="hljs-string"><span class="hljs-string">'WORD'</span></span>) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> t.toString().toLowerCase().replace(<span class="hljs-string"><span class="hljs-string">'-'</span></span>, <span class="hljs-string"><span class="hljs-string">'_'</span></span>)) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function"> =&gt;</span></span> namesMap[name]) .filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function"> =&gt;</span></span> t) .filter(onlyUnique); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tags; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { getTags };</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Dictionary format</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"js"</span></span>: <span class="hljs-string"><span class="hljs-string">"JS"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"javascript"</span></span>: <span class="hljs-string"><span class="hljs-string">"JS"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sql"</span></span>: <span class="hljs-string"><span class="hljs-string">"SQL"</span></span>, <span class="hljs-attr"><span class="hljs-attr">""</span></span>: <span class="hljs-string"><span class="hljs-string">"Angular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"angular"</span></span>: <span class="hljs-string"><span class="hljs-string">"Angular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"angularjs"</span></span>: <span class="hljs-string"><span class="hljs-string">"Angular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"react"</span></span>: <span class="hljs-string"><span class="hljs-string">"React"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"reactjs"</span></span>: <span class="hljs-string"><span class="hljs-string">"React"</span></span>, <span class="hljs-attr"><span class="hljs-attr">""</span></span>: <span class="hljs-string"><span class="hljs-string">"React"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"node"</span></span>: <span class="hljs-string"><span class="hljs-string">"NodeJS"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nodejs"</span></span>: <span class="hljs-string"><span class="hljs-string">"NodeJS"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"linux"</span></span>: <span class="hljs-string"><span class="hljs-string">"Linux"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ubuntu"</span></span>: <span class="hljs-string"><span class="hljs-string">"Ubuntu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"unix"</span></span>: <span class="hljs-string"><span class="hljs-string">"UNIX"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"windows"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows"</span></span> .... }</code> </pre><br></div></div><br><h4>  Deploy and everything else </h4><br>  To publish each vacancy only once, I used the MongoDB database, reducing everything to the uniqueness of the references of the vacancies themselves.  To monitor the processes and their logs on the server, I chose the process manager <a href="https://www.npmjs.com/package/pm2">pm2</a> , where the warmup is performed by a regular bash script.  By the way, the easiest Droplet from Digital Ocean is used as a server. <br><br><div class="spoiler">  <b class="spoiler_title">Deploy script</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash # rs -       rsync ./ rs:/var/www/js_jobs_bot --delete -r --exclude=node_modules ssh rs " . ~/.nvm/nvm.sh cd /var/www/js_jobs_bot/ mv prod-config.json config.json npm i &amp;&amp; pm2 restart processes.json "</span></span></code> </pre><br></div></div><br><h4>  findings </h4><br>  It was not difficult to make simple bots, you just need a desire, knowledge of some programming language (preferably Python or JS) and a couple of days of free time.  The results of the work of my bot (as well as the thematic line of vacancies) can be found in the appropriate channel - <a href="https://t.me/javascriptjobs">@javascriptjobs</a> . <br><br>  PS The full version of the source can be found in my <a href="https://github.com/risentveber/js_jobs_bot">repository</a> </div><p>Source: <a href="https://habr.com/ru/post/337940/">https://habr.com/ru/post/337940/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337928/index.html">Overview of tools for load and performance testing</a></li>
<li><a href="../337932/index.html">VMworld 2017 Europe Conference. Day 1</a></li>
<li><a href="../337934/index.html">Amazingly useful tool: lsof</a></li>
<li><a href="../337936/index.html">Chief, I want to work from home</a></li>
<li><a href="../337938/index.html">4 reasons to become a Data Engineer</a></li>
<li><a href="../337942/index.html">Welcome to mini ai cups</a></li>
<li><a href="../337946/index.html">How to write your first Linux device driver</a></li>
<li><a href="../337950/index.html">We enter the rating of the participant Dribbble and Behance on "My Circle"</a></li>
<li><a href="../337952/index.html">Mathematics for the programmer</a></li>
<li><a href="../337958/index.html">iOS + Kotlin. What can be done now</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>