<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Amazon Redshift Parallel Scaling Guide and Test Results</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We use Amazon Redshift at Skyeng, including parallel scaling, so the article Stephen Gromoll, the founder of dotgo.com, for intermix.io, seemed intere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Amazon Redshift Parallel Scaling Guide and Test Results</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/mo/pi/gt/mopigtqlz7wpuhwhxsmrlcvgpky.png" alt="image"><br><br>  <i>We use Amazon Redshift at Skyeng, including parallel scaling, so the article Stephen Gromoll, the founder of dotgo.com, for intermix.io, seemed interesting to us.</i>  <i>After the translation - a bit of our experience from the engineer according to Daniyar Belkhodzhayev.</i> <br><br>  <a href="https://www.intermix.io/blog/a-dbas-guide-to-the-amazon-redshift-architecture-the-5-components-you-need-to-understand/">Amazon Redshift architecture</a> allows scaling by adding new nodes to the cluster.  The need to cope with the peak number of requests can lead to over-provisioning of nodes.  Parallel scaling (Concurrency Scaling), in contrast to the addition of new nodes, increases the computing power as needed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Amazon Redshift's parallel scaling gives Redshift clusters additional power to handle peak requests.  It works by transferring requests to new "parallel" clusters in the background.  Requests are routed based on configuration and WLM rules. <br><a name="habracut"></a><br>  Parallel scaling pricing is based on a free-use credit model.  In addition to the free credit rate, payment is based on the time when the parallel scaling cluster processes requests. <br><br>  The author tested parallel scaling on one of the internal clusters.  In this post, he will talk about test results and give tips on how to get started. <br><br><h3>  Cluster requirements </h3><br>  To use parallel scaling, your Amazon Redshift cluster must meet the following requirements: <br><br><ul><li>  <b>platform:</b> EC2-VPC; </li><li>  <b>node type:</b> dc2.8xlarge, ds2.8xlarge, dc2.large or ds2.xlarge; </li><li>  <b>number of nodes:</b> from 2 to 32 (single node clusters are not supported). </li></ul><br><h3>  Valid query types </h3><br>  Parallel scaling is not suitable for all types of requests.  In the first version, it processes only read requests that satisfy three conditions: <br><br><ul><li>  SELECT queries are read-only (although more types are planned); </li><li>  the query does not refer to the INTERLEAVED sorting table; </li><li>  The query does not use Amazon Redshift Spectrum to refer to external tables. </li></ul><br>  To route to a parallel scaling cluster, the request must queue up.  In addition, queries suitable for the <a href="https://www.intermix.io/blog/quick-guide-using-short-query-acceleration-wlm-amazon-redshift-faster-queries-ever/">SQA (Short Query Acceleration)</a> queue will not be executed in parallel scaling clusters. <br><br>  Queues and SQA require proper <a href="https://www.intermix.io/blog/4-simple-steps-to-set-up-your-wlm-in-amazon-redshift-the-right-way/">Redshift Workload Management (WLM)</a> configuration.  We recommend that you first optimize your WLM - this will reduce the need for parallel scaling.  And this is important, because parallel scaling is done for free only for a certain number of hours.  AWS claims that parallel scaling will be free for 97% of customers, which brings us to the issue of pricing. <br><br><h3>  The cost of parallel scaling </h3><br>  AWS offers a credit model for parallel scaling.  Every active <a href="https://www.intermix.io/blog/reducing-amazon-redshift-cost/">Amazon Redshift</a> cluster accumulates credits hourly, up to one hour of free credits parallel scaling per day. <br><br>  You pay only when using parallel scaling clusters exceeds the amount of credits you received. <br><br>  The cost is calculated on a per-second tariff on demand for a parallel cluster that is used in excess of the free rate.  Payment is made only during the execution of your requests, with a minimum payment in one minute, each time the parallel scaling cluster is activated.  Per-second on-demand tariff is calculated based on <a href="https://www.intermix.io/blog/reducing-amazon-redshift-cost/">Amazon Redshift's</a> general pricing guidelines, i.e. depends on the type of node and the number of nodes in your cluster. <br><br><h3>  Run parallel scaling </h3><br>  Parallel scaling runs for each WLM queue.  Go to the AWS Redshift console and select ‚ÄúWorkload Management‚Äù in the left navigation menu.  Select the cluster WLM options group of your cluster in the next drop-down menu. <br><br>  You will see a new column called ‚ÄúConcurrency Scaling Mode‚Äù next to each queue.  The default setting is ‚ÄúOff‚Äù.  Click "Edit", and you can change the settings for each queue. <br><br><img src="https://habrastorage.org/webt/rz/g9/mk/rzg9mkvwxcmlhry2v522jjrtcdk.png"><br><br><h3>  Configuration </h3><br>  Parallel scaling works by sending appropriate requests to new dedicated clusters.  New clusters have the same size (type and number of nodes) as the main cluster. <br><br>  The number of clusters used for parallel scaling is, by default, one (1) with the ability to configure a total of up to ten (10) clusters. <br>  The total number of clusters for parallel scaling can be set with the max_concurrency_scaling_clusters parameter.  Increasing the value of this parameter provides additional backup clusters. <br><br><img src="https://habrastorage.org/webt/p6/we/qu/p6wequjhe3-yxannbvr_zndpqdg.png"><br><br><h3>  Monitoring </h3><br>  AWS Redshift Console has a few additional graphs.  The Max Configured Concurrency Scaling Clusters chart displays the max_concurrency_scaling_clusters value over time. <br><br><img src="https://habrastorage.org/webt/ti/mw/au/timwauz4qrbalhetjn3ttccxui4.png"><br><br>  The number of clusters of active scaling is displayed in the user interface in the "Concurrency Scaling Activity" section: <br><br><img src="https://habrastorage.org/webt/zq/ai/xx/zqaixxhdn7i-pkwockkal_7ujvw.png"><br><br>  In the "Requests" tab there is a column indicating whether the query was executed in the main cluster or in a parallel scaling cluster: <br><br><img src="https://habrastorage.org/webt/p-/sw/p8/p-swp8elamy2ecxarcydioa0_ac.png"><br><br>  Regardless of whether a particular query was executed in the main cluster or through a parallel scaling cluster, it is stored in stl_query.concurrency_scaling_status. <br><br><img src="https://habrastorage.org/webt/kf/ns/_4/kfns_4r21bi4fbmqzpk2nfgv1ba.png"><br><br>  A value of 1 indicates that the query was executed in a parallel scaling cluster, and other values ‚Äã‚Äãindicate that it was executed in the main cluster. <br><br>  Example: <br><br><img src="https://habrastorage.org/webt/cn/3u/vh/cn3uvh7rn90c8bydqicyz3zlir8.png"><br><br>  Information about parallel scaling is also stored in some other tables and views (views), for example, SVCS_CONCURRENCY_SCALING_USAGE.  In addition, there are a number of catalog tables that store information about parallel scaling. <br><br><h3>  results </h3><br>  The authors launched parallel scaling for one queue in the internal cluster at approximately 18:30:00 GMT 03/29/2019. The parameter max_concurrency_scaling_clusters changed to 3 at approximately 20:30:00 03/29/2019. <br><br>  To simulate the request queue, and reduced the number of slots for this queue from 15 to 5. <br><br>  Below is the intermix.io dashboard chart showing the number of requests that are in progress and queuing after a decrease in the number of slots. <br><br><img src="https://habrastorage.org/webt/d4/0p/7q/d40p7qzi5ty79bbw_irhtk4qfzs.png"><br><br>  We see that the waiting time for requests in the queue has increased, while the maximum time was more than 5 minutes. <br><br><img src="https://habrastorage.org/webt/ov/xp/rn/ovxprnqxnz1fy9ds4xm4vmn6vte.png"><br><br>  Here is the relevant information from the AWS console about what happened during this time: <br><br><img src="https://habrastorage.org/webt/rm/f-/ip/rmf-ipbke1vkled8fyo8zch9jpu.png"><br><br>  Redshift launched three (3) concurrent scaling clusters according to the configuration.  It seems that these clusters were not fully utilized, even though many requests in our cluster were in line. <br><br>  The usage graph correlates with the scaling activity graph: <br><br><img src="https://habrastorage.org/webt/am/ho/yk/amhoykwqbkcttpfdiv5gvizkvog.png"><br><br>  After a few hours, the authors checked the queue, and it looks like 6 requests were executed with parallel scaling.  Also selectively checked two requests through the user interface.  We did not check how to use these values ‚Äã‚Äãwhen several parallel clusters are active at once. <br><br><img src="https://habrastorage.org/webt/fi/2f/rb/fi2frbpdkxqfcj1q-4rp12wrjz4.png"><br><br><h3>  findings </h3><br>  Parallel scaling can reduce the time spent in the request queue during peak loads. <br><br>  According to the results of the basic test, it turned out that the situation with the loading of requests partially improved.  However, parallel scaling itself did not solve all problems with parallelism. <br><br>  This is due to restrictions on the types of queries that parallel scaling can use.  For example, authors have many tables with alternating (interleaved) sort keys, and most of our workload is a record. <br><br>  Although parallel scaling is not a universal solution in configuring WLM, in any case, using this feature is simple and straightforward. <br><br>  Therefore, the author recommends using it for your WLM queues.  Start with a single parallel cluster and monitor the peak load through the console to determine if new clusters are fully utilized. <br><br>  As AWS adds support for additional types of queries and tables, parallel scaling should gradually become more and more efficient. <br><blockquote>  <b>Comment from Belkhodjaev Daniyar, an engineer according to Skyeng</b> <br><br>  We at Skyeng also immediately noticed the possibility of parallel scaling. <br>  The functionality is very attractive, especially since AWS estimates that most users won't even have to pay extra for it. <br><br>  It so happened that in mid-April we had an unusual flurry of requests to the Redshift cluster.  During this period, we often resorted to the help of Concurrency Scaling, sometimes an additional cluster worked 24 hours a day without stopping. <br><br>  This allowed if not to completely solve the problem with queues, then at least make the situation acceptable. <br><br>  Our observations largely coincide with the impression of the guys from intermix.io. <br><br>  We also noticed that despite the presence of requests waiting in the queue, not all requests were immediately redirected to a parallel cluster.  Apparently this is due to the fact that the parallel cluster still takes time to start.  As a result, during short-term peak loads, we still have small queues, and the corresponding alarms have time to work. <br><br>  Having got rid of abnormal loads in April, we, as AWS assumed, went into episodic use mode - as part of the free norm. <br>  You can track parallel scaling costs in AWS Cost Explorer.  You need to select Service - Redshift, Usage Type - CS, for example USW2-CS: dc2.large. <br><br>  Details about prices in Russian can be found <a href="https://aws.amazon.com/ru/redshift/pricing">here.</a> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/451538/">https://habr.com/ru/post/451538/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451522/index.html">We develop automation in a couple of hours: TypeScript, Protractor, Jasmine</a></li>
<li><a href="../451524/index.html">Tale of how the maker Autoplay Media Studio 8.5.3.0 broke</a></li>
<li><a href="../451528/index.html">‚ÄúAnd so it will come down‚Äù: that cloud providers do not agree on personal data</a></li>
<li><a href="../451532/index.html">News from the world of OpenStreetMap ‚Ññ459 (04.30.2019-06.05.2019)</a></li>
<li><a href="../451536/index.html">The future is here: AI will control melee on American fighters</a></li>
<li><a href="../451544/index.html">Gathering of the system operators of the ‚ÄúMedium‚Äù network points in Moscow, on May 18 at 14:00 at the Patriarshie Prudy</a></li>
<li><a href="../451552/index.html">We build the network channels of sales of the gadget DO-RA</a></li>
<li><a href="../451562/index.html">How to escape from the sect?</a></li>
<li><a href="../451566/index.html">Operation TaskMasters: how we exposed the cyber grouping, the attacking organizations of Russia and the CIS</a></li>
<li><a href="../45157/index.html">Is it appropriate to give a link to a competitor's website?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>