<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The implementation of e-mail alerts in ImageCMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this publication, we will describe how the average lead programmer ImageCMS Andryusha implemented a convenient e-mail notification system for users...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The implementation of e-mail alerts in ImageCMS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/378/4cd/4d0/3784cd4d037f3447f763644d366f10ed.png"><br>  In this publication, we will describe how the average lead programmer ImageCMS Andryusha implemented a convenient e-mail notification system for users of the online store.  He himself now claims that he is not a programmer, but a fairy. <br><br>  <b><u>What was the problem before the implementation of the new functionality?</u></b> <br>  It saddened a lot that sending e-mail to users did not have a centralized place of management, <b>because it created certain inconveniences for the administrator and the presence of a lot of excess code that was duplicated.</b> <br>  Look, with: <br><a name="habracut"></a><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Send email to user. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> SOrders $order * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_sendMail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SOrders $order)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//Check setting to send message if (ShopCore::app()-&gt;SSettings-&gt;ordersSendMessage == 'false') return; //Array of parameters to send $replaceData = array( '%userName%' =&gt; $order-&gt;getUserFullName(), '%userEmail%' =&gt; $order-&gt;getUserEmail(), '%userPhone%' =&gt; $order-&gt;getUserPhone(), '%userDeliver%' =&gt; $order-&gt;getUserDeliverTo(), '%orderId%' =&gt; $order-&gt;getId(), '%orderKey%' =&gt; $order-&gt;getKey(), '%orderLink%' =&gt; shop_url('cart/view/' . $order-&gt;getKey()), ); //Use function encode for every element from $replaceData $replaceData = array_map('encode', $replaceData); //Get settings for sending $fromEmail = ShopCore::app()-&gt;SSettings-&gt;ordersSenderEmail; $shopName = ShopCore::app()-&gt;SSettings-&gt;ordersSenderName; $theme = ShopCore::app()-&gt;SSettings-&gt;ordersMessageTheme; //Formating message $message = str_replace(array_keys($replaceData), $replaceData, ShopCore::app()-&gt;SSettings-&gt;ordersMessageText); //Load CodeIgniter Email library $this-&gt;load-&gt;library('email'); $config['mailtype'] = ShopCore::app()-&gt;SSettings-&gt;ordersMessageFormat; //Initialize library configurations $this-&gt;email-&gt;initialize($config); //Sending message $this-&gt;email-&gt;from($fromEmail, $shopName); $this-&gt;email-&gt;to($order-&gt;getUserEmail()); $this-&gt;email-&gt;subject($theme); $this-&gt;email-&gt;message($message); $this-&gt;email-&gt;send(); } protected function _sendNewMail(SOrders $order) { //Check setting to send message if (ShopCore::app()-&gt;SSettings-&gt;ordersSendMessage == 'false') return; //Array of parameters to send $replaceData['variables'] = array( '%userName%' =&gt; $order-&gt;getUserFullName(), '%userEmail%' =&gt; $order-&gt;getUserEmail(), '%userPhone%' =&gt; $order-&gt;getUserPhone(), '%userDeliver%' =&gt; $order-&gt;getUserDeliverTo(), '%orderId%' =&gt; $order-&gt;getId(), '%orderKey%' =&gt; $order-&gt;getKey(), '%orderLink%' =&gt; shop_url('cart/view/' . $order-&gt;getKey()), ); $replaceData['to'] = $order-&gt;getUserEmail(); //Load CodeIgniter Email library $this-&gt;load-&gt;library('email'); //Sending message $this-&gt;email-&gt;sendMail('toUserOrderNotification', $replaceData); }</span></span></code> </pre> <br><br>  <b><u>What did Andryusha do?</u></b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To centralize the entire system of creating and sending alerts, Fairy wrote a separate module.  Initially, along with the module comes 6 templates integrated into the system that are most frequently used in the work of the site: <br><ol><li>  User registration; </li><li>  password recovery; </li><li>  change Password; </li><li>  notification of the purchaser of the order; </li><li>  change order status; </li><li>  notification of the appearance. </li></ol><br><img src="https://habrastorage.org/getpro/habr/post_images/683/01e/ad1/68301ead1b945bbd93b47a012574a671.png"><br><br>  Namespaces were used, which allows calling the method from any place: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">cmsemail</span></span>\<span class="hljs-title"><span class="hljs-title">classes</span></span>;</code> </pre><br><br>  The main obstacle to achieving Andrei‚Äôs goal was far from the amount of code, namely, the need to find all the places in the code where the e-mail is being sent, and replace them with a new method.  Our hero did not despair ... The fairy put his ears to the Korn group and abstracted the processing of all the logic of sending letters to the user and the administrator in a small method that can be seen on the next canvas. <br>  Look, with: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//Creatind link to check for administrator $checkLink = site_url() . "admin/components/run/shop/orders/createPdf/" . trim($order-&gt;getId()); //Array of parameters to send $emailData = array( 'userName' =&gt; $order-&gt;user_full_name, 'userEmail' =&gt; $order-&gt;user_email, 'userPhone' =&gt; $order-&gt;user_phone, 'userDeliver' =&gt; $order-&gt;user_deliver_to, 'orderLink' =&gt; shop_url('cart/view/' . $order-&gt;key), 'products' =&gt; $productsForEmail, 'deliveryPrice' =&gt; $deliveryPrice, 'checkLink' =&gt; $checkLink, ); //Sending emeils \cmsemail\email::getInstance()-&gt;sendEmail($order-&gt;user_email, 'make_order', $emailData);</span></span></code> </pre><br><br>  So this method looks inside: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * send email * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $send_to - recepient email * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $patern_name - email patern name * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $variables - variables to raplase in message: * $variables = array('$user$' =&gt; 'UserName') * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($send_to, $patern_name, $variables)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//loading CodeIgniter Email library $this-&gt;load-&gt;library('email'); //Getting settings $patern_settings = $this-&gt;cmsemail_model-&gt;getPaternSettings($patern_name); $default_settings = $this-&gt;cmsemail_model-&gt;getSettings(); //Prepare settings into correct array for initialize library if ($patern_settings) { foreach ($patern_settings as $key =&gt; $value) { if (!$value) { if ($default_settings[$key]) { $patern_settings[$key] = $default_settings[$key]; } } } } $default_settings['type'] = strtolower($patern_settings['type']); //Initializing library settings $this-&gt;_set_config($patern_settings); //Sending user email if active in options if ($patern_settings['user_message_active']) { $this-&gt;from_email = $patern_settings['from_email']; $this-&gt;from = $patern_settings['from']; $this-&gt;send_to = $send_to; $this-&gt;theme = $patern_settings['theme']; $this-&gt;message = $this-&gt;replaceVariables($patern_settings['user_message'], $variables); if (!$this-&gt;_sendEmail()) { $this-&gt;errors[] = lang('User message doesnt send', 'cmsemail'); } else { //Registering event if success \CMSFactory\Events::create()-&gt;registerEvent( array( 'from' =&gt; $this-&gt;from, 'from_email' =&gt; $this-&gt;from_email, 'send_to' =&gt; $this-&gt;send_to, 'theme' =&gt; $this-&gt;theme, 'message' =&gt; $this-&gt;message ), 'ParentEmail:userSend'); \CMSFactory\Events::runFactory(); } } //Sending administrator email if active in options if ($patern_settings['admin_message_active']) { $this-&gt;from_email = $patern_settings['from_email']; $this-&gt;from = $patern_settings['from']; if ($patern_settings['admin_email']) { $this-&gt;send_to = $patern_settings['admin_email']; } else { $this-&gt;send_to = $default_settings['admin_email']; } $this-&gt;theme = $patern_settings['theme']; $this-&gt;message = $this-&gt;replaceVariables($patern_settings['admin_message'], $variables); if (!$this-&gt;_sendEmail()) { $this-&gt;errors[] = lang('User message doesnt send', 'cmsemail'); } else { //Registering event if success \CMSFactory\Events::create()-&gt;registerEvent( array( 'from' =&gt; $this-&gt;from, 'from_email' =&gt; $this-&gt;from_email, 'send_to' =&gt; $this-&gt;send_to, 'theme' =&gt; $this-&gt;theme, 'message' =&gt; $this-&gt;message ), 'ParentEmail:adminSend'); \CMSFactory\Events::runFactory(); } } //Returning status if ($this-&gt;errors) { return FALSE; } else { return TRUE; } }</span></span></code> </pre><br><br>  So the average lead programmer centralized the entire user alert system.  <b>The code has become smaller, it has become more elegant, managing alerts is easier.</b> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d29/090/fa6/d29090fa6fe4aa0d64dd1aa73505c2cb.png"><br><br>  <b>What problems does this functionality solve?</b> <br><br>  The updated alert system, localized in a single interface, greatly simplifies the work, especially for an inexperienced user, since all the functionality is assembled in the ImageCMS administrator panel. <br>  The following screenshot shows the dashboard settings dashboard, which is received by the user and the administrator. <br><br>  An example of setting up a letter to the user about the order made <br><img src="https://habrastorage.org/getpro/habr/post_images/15e/2a0/64d/15e2a064d663668d9fc85f9eba7cfabf.png"><br><br>  An example of setting up a letter to the store administrator about the order made. <br><img src="https://habrastorage.org/getpro/habr/post_images/ab6/64f/6cb/ab664f6cb344cf4d2f8ab82f2a580389.png"><br><br>  <b>Can I create my own notification templates?</b> <br>  More experienced users of ImageCMS Shop can create their own alert templates, as well as integrate them into the system.  A flexible system of settings allows you to vary the sending components in different combinations.  Each notification has its own individual settings for the sending address, sender data, administrator's e-mail address and subject.  There are also standard settings, and if the optional fields are not filled, then the data will be taken from there. <br>  For even more convenience, the administrator provides for checking on the server the possibility of sending an alert.  The sender will be sure that the recipient is notified of the event: <br><img src="https://habrastorage.org/getpro/habr/post_images/ed9/2b4/e3c/ed92b4e3c3090f5da5897717af8b71a3.png"></div><p>Source: <a href="https://habr.com/ru/post/203274/">https://habr.com/ru/post/203274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203258/index.html">How we organized a photo / video studio in office conditions</a></li>
<li><a href="../203260/index.html">Restriction on sending batteries by mail from China</a></li>
<li><a href="../203262/index.html">Bill Gates funds the creation of thin graphene condoms</a></li>
<li><a href="../203264/index.html">How an emotion matrix can help test software usability</a></li>
<li><a href="../203266/index.html">Development of cross-platform mobile applications in Delphi # 5</a></li>
<li><a href="../203276/index.html">Guardians of the night</a></li>
<li><a href="../203280/index.html">Twenty-first Century Belt</a></li>
<li><a href="../203282/index.html">3 modes of git reset command: --soft, --mixed (by default), --hard</a></li>
<li><a href="../203284/index.html">How did the idea of ‚Äã‚Äãthe project Carry appeared?</a></li>
<li><a href="../203292/index.html">List of free DNS services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>