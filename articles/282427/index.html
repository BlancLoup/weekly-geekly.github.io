<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Native advertising returns: Native Admob, RecyclerView and briefly about the rules</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since 2015, the situation with Admob Native ads has not changed, native advertising is still in beta release, with limited access for publishers. In t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Native advertising returns: Native Admob, RecyclerView and briefly about the rules</h1><div class="post__text post__text-html js-mediator-article">  Since 2015, the situation with <a href="https://support.google.com/admob/answer/6239795">Admob Native ads</a> has not changed, native advertising is still in beta release, with limited access for publishers.  In the official docks, there is a new edition and some explanations about how it is planned to implement these same Native ads.  We, in turn, also did not sit idly, saving up material for the next article, and, as soon as free time appeared, slightly expanded the functionality of the <a href="https://github.com/clockbyte/admobadapter">admobadapter</a> library.  Namely, it implemented support for scrollable native ads for <b>RecyclerView</b> , just as we did <a href="https://habrahabr.ru/post/269517/">in the previous article</a> for <b>ListView</b> . <a name="habracut"></a><br><br><h3>  Let's make friends RecyclerView with Native Ads </h3><br><img src="https://habrastorage.org/files/a73/08b/f98/a7308bf9807b4f2ab3e1ceaac43275b0.jpg" alt="image" align="right" width="300">  Since the previous experience proved to be quite good, in the case of <b>RecyclerView we</b> decided to implement a <i>wrapper (hereinafter the wrapper)</i> for the adapter.  This allows the developer to create his own special and unique data adapter, and we are trying not to interfere with this endeavor.  The developer then links the wrapper to the adapter using <i>dependency injection</i> , and in <b>RecyclerView</b> passes the link to the wrapper.  Thus, we do not interfere in the logic of the adapter.  When displaying a collection, the wrapper calculates where to display the ad unit, and where the source data is displayed.  Since the considered part of the library does not carry any elegant solutions and innovative constructions, I would like to elaborate more on the features and differences in the implementation of scrollable native advertising for <b>RecyclerView</b> from <b>ListView</b> .  The base adapter class for <b>RecyclerView</b> is <b>RecyclerView.Adapter &lt;~&gt;</b> , and for <b>ListView</b> , the <b>BaseAdapter</b> .  If the use of the <i>ViewHolder</i> pattern for the <b>ListView</b> is an action from the category of <i>best-practices</i> , then in the <i>RecyclerView.Adapter &lt;VH extends RecyclerView.ViewHolder&gt;</i> <b>declaration, the ViewHolder</b> type <b>parameter</b> is mandatory.  Base class requires redefinition of methods. <br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemCount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre>  returns the total number of items stored by the adapter.  In essence, it is similar to the int getCount () method; <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBindViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VH holder, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position)</span></span></span></span></code> </pre>  bindes the view stored in <i>holder</i> to the data collection item with index <i>position</i> .  This and the following methods came to "replace" the <i>View getView</i> method <i>(int position, View convertView, ViewGroup parent)</i> from <b>BaseAdapter</b> - earlier, depending on the scan results, <i>convertView</i> to <i>null</i> , or created a new <i>convertView</i> , or bind or the current to the corresponding data; <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> VH </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateViewHolder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ViewGroup parent, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> viewType)</span></span></span></span></code> </pre>  creates and returns a <i>viewholder of the</i> desired type <i>viewType</i> .  The type of the <i>viewType</i> container <i>should</i> be used in case the elements of your collection need to be displayed in different ways according to a certain attribute.  In this case, the method should also be defined. <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemViewType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position)</span></span></span></span></code> </pre>  returns the container type for the data collection item by index <i>position</i> .  The <b>BaseAdapter</b> also needed to determine the total number of container types in the <i>getViewTypeCount</i> method, in <b>RecyclerView.Adapter &lt;~&gt;,</b> this is no longer necessary.  In our example, <i>getViewTypeCount</i> returns a <i>wrapper</i> to 3: one type for elements from the original data collection (for the adapter), and two more for advertising with content and application installation advertising (see in the previous article).  At the same time, the adapter can define its own logic for displaying container types and the wrapper does not need to know anything about it.  So, the source code is better than a thousand words :) <br><div class="spoiler">  <b class="spoiler_title">Expand</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdmobRecyclerAdapterWrapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">View</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RecyclerView</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Adapter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ViewWrapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">V</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdmobFetcher</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdmobListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... @Override public void onBindViewHolder(ViewWrapper&lt;V&gt; viewHolder, int position) { if (viewHolder==null) return; switch (viewHolder.getItemViewType()) { //  -    case VIEW_TYPE_AD_INSTALL: //  viewHolder.getView()     (recycling) NativeAppInstallAdView lvi1 = (NativeAppInstallAdView) viewHolder.getView(); //   . getItem      AdmobFetcher  ,      . NativeAppInstallAd ad1 = (NativeAppInstallAd) getItem(position); //    AdViewHelper.bindInstallAdView(lvi1, ad1); break; //  -    case VIEW_TYPE_AD_CONTENT: NativeContentAdView lvi2 = (NativeContentAdView) viewHolder.getView(); NativeContentAd ad2 = (NativeContentAd) getItem(position); AdViewHelper.bindContentAdView(lvi2, ad2); break; default: //     (   ),    (  ) int origPos = getOriginalContentPosition(position); //    mAdapter.onBindViewHolder(viewHolder, origPos); } } @Override public final ViewWrapper&lt;V&gt; onCreateViewHolder(ViewGroup parent, int viewType) { switch (viewType) { case VIEW_TYPE_AD_INSTALL: case VIEW_TYPE_AD_CONTENT: //  viewholder    viewType -     return new ViewWrapper&lt;V&gt;(onCreateItemView(parent, viewType)); default: //     return mAdapter.onCreateViewHolder(parent, viewType); } } //        (.    ) private V onCreateItemView(ViewGroup parent, int viewType) { switch (viewType) { case VIEW_TYPE_AD_INSTALL: NativeAppInstallAdView lvi1 = getInstallAdView(parent); return (V)lvi1; case VIEW_TYPE_AD_CONTENT: NativeContentAdView lvi2 = getContentAdView(parent); return (V)lvi2; default: return null; } } //      ,    //... }</span></span></code> </pre><br></div></div><br><h3>  Some bureaucracy </h3><br>  At the beginning of the article we mentioned the clarifications in the official docks for Admob native advertising and one of the main changes is the <a href="https://support.google.com/admob/answer/6240618">publication rules</a> .  In general terms, the process of integrating native advertising should look like this (please correct me if you made a mistake where): <br><ol><li>  Developing and obtaining approval from your account manager to mockup your future advertising, and its presentation in your UI, even before the implementation of the test version of the application (Voluntary) </li><li>  Testing ad templates in closed mode and with <i>admob</i> test <i>publish id</i> </li><li>  Getting the official approval that you have with the template and with the rules of placement is all right.  Our assumption is that this procedure will be available directly from your developer console in alpha / beta testing mode, or from admob dashboard </li><li>  Publish an approved application </li></ol><br>  A formal check on the appearance of advertising in your UI will be performed according to the already published <a href="https://support.google.com/admob/answer/6240814">checklist</a> . <br>  A comment was also added to the <a href="https://developers.google.com/admob/android/native">developer-guide</a> , the essence of which was to prevent developers from multi-threaded loading of advertising blocks by calling the <b>loadAd</b> method in the context of a single <b>AdLoader</b> object.  That is, basically, there are a little more than two options :) <br><ul><li>  Create a separate AdLoader entity for each call to loadAd. </li><li>  Before each <b>loadAd</b> call in the context of a single AdLoader object, verify that the loading of the previous block was completed. </li></ul><br>  An example of the implementation of the second variant can be viewed, again, in our <a href="">admobadapter</a> library (without any claims to canonicity).  Since these methods have already been described in more detail in a previous <a href="https://habrahabr.ru/post/269517/">article</a> , consider the <b>AdmobFetcher</b> code <b>snippets</b> responsible for <b>loadAd</b> synchronization.  The flag is used for this purpose. <br><pre> <code class="java hljs">AtomicBoolean lockFetch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AtomicBoolean();</code> </pre>  Before calling <b>loadAd, we</b> check the value of this flag, and if it is set to true ‚Äî another block is currently being loaded, we exit.  Otherwise, set it to true and try to load a block of ads. <br><div class="spoiler">  <b class="spoiler_title">Expand</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetchAd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Context context = mContext.get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(lockFetch.getAndSet(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; adLoader.loadAd(getAdRequest()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mFetchFailCount++; } }</code> </pre><br></div></div>  To allow ad blocks to be loaded, we should set the flag to false, this can be done by subscribing to the <b>loadAd</b> completion when creating the <b>AdLoader</b> entity, as shown below <br><div class="spoiler">  <b class="spoiler_title">Expand</b> <div class="spoiler_text"><pre> <code class="java hljs"> adLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AdLoader.Builder(mContext.get(), admobUnitId) .forAppInstallAd(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NativeAppInstallAd.OnAppInstallAdLoadedListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAppInstallAdLoaded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(NativeAppInstallAd appInstallAd)</span></span></span><span class="hljs-function"> </span></span>{ lockFetch.set(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-comment"><span class="hljs-comment">//... } }) .forContentAd(new NativeContentAd.OnContentAdLoadedListener() { @Override public void onContentAdLoaded(NativeContentAd contentAd) { lockFetch.set(false); //... } }) .withAdListener(new AdListener() { @Override public void onAdFailedToLoad(int errorCode) { lockFetch.set(false); mFetchFailCount++; //... } }).build();</span></span></code> </pre><br></div></div><br><h3>  Instead of conclusions </h3><br>  So, the new wrapper for <b>RecyclerView</b> has changed: <br><ol><li>  Creating <i>views</i> to display data / advertising </li><li>  Binding <i>views</i> to data / advertising </li><li>  Redefinition of other abstract methods of the base class. </li></ol><br>  Remained as before: <br><ol><li>  Mechanism for loading ads from the AdMob server ( <b>AdmobFetcher</b> class) </li><li>  The structure of advertising <i>views</i> (xml) and its filling during the binding </li><li>  Calculation of indexes and the number of ad units / data blocks </li><li>  The essence of the <i>getItemCount ()</i> , <i>getItemId (int position)</i> and <i>getItemViewType (int position)</i> methods remain the same, but their names have changed. </li></ol><br>  The dry residue from the second part of the article - the official documentation on Admob native ads continues to evolve, as if hinting to us that the procedure for integrating native advertising into an application may be non-trivial and the amount of time spent will depend not only on our development speed, but also on moderation speed / adequacy of Admob / Google staff. <br>  We would be grateful for the statistics if you vote in the attached polls!  By good tradition, we wish you a beautiful advertising in your applications! <br><br>  PS: It turns out that some of the information in this article is ‚Äúslightly‚Äù outdated, I give a link to a new Google doc <a href="https://support.google.com/admob/answer/6270315%3Fhl%3Dru">support.google.com/admob/answer/6270315?hl=en</a> .  As time appears, I will describe the connection process on Habr√©. </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282427/">https://habr.com/ru/post/282427/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282417/index.html">1 developer. 2 applications. 3 years</a></li>
<li><a href="../282419/index.html">Restore in 60 seconds (or how to speed up data recovery using Arcserve UDP)</a></li>
<li><a href="../282421/index.html">Receiving payment from international customers with Payoneer</a></li>
<li><a href="../282423/index.html">Extending Splunk functionality is just</a></li>
<li><a href="../282425/index.html">Frontend Dev Conf 2016: the heroes, events and surprises of the conference</a></li>
<li><a href="../282429/index.html">We are looking for a replacement for Digital Ocean among domestic hosting companies</a></li>
<li><a href="../282431/index.html">Two languages, one Cup. Reflections on the RCC 2016 Rules</a></li>
<li><a href="../282433/index.html">Recognition of DGA domains. And what if neural networks?</a></li>
<li><a href="../282435/index.html">"And how well everything began ...", or the benefits of O-notation, not only for the analysis of algorithms</a></li>
<li><a href="../282441/index.html">Mill Fighting - 1: Interpolation Splines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>