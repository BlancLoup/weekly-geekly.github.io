<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Continuous integration / deployment of a symfony application using docker-compose and GitLab CI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, I will share my experience in automating the entire process of developing a symfony application from scratch, from infrastructure set...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Continuous integration / deployment of a symfony application using docker-compose and GitLab CI</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, I will share my experience in automating the entire process of developing a symfony application from scratch, from infrastructure setup to deployment in production.  From development to production, the docker-compose will be used to launch the application, and all the continuous integration / deployment procedures will be run via GitLab CI / CD Pipelines in docker containers. </p><br><p>  The implication is that you are familiar with docker and docker-compose.  If not, or you don‚Äôt know how to install it, I prepared <a href="">instructions on how to prepare the developer‚Äôs local environment</a> .  In fact, to work on the application, only Docker, VirtualBox and, optionally, Yarn will be required. </p><a name="habracut"></a><br><h2 id="zapusk-prilozheniya-lokalno">  Run application locally </h2><br><p>  I prepared the skeleton application and <a href="https://github.com/covex-nn/docker-workflow-symfony">laid it out on github</a> .  Everything written below refers to applications created on the basis of this template and to the infrastructure necessary to run such an application. </p><br><p>  To run the application locally, you need to run the following commands: </p><br><pre><code class="hljs bash">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> git@github.com:covex-nn/docker-workflow-symfony.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docker-workflow-symfony docker-compose up -d docker-compose <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> php phing</code> </pre> <br><p>  The site will be available at <a href="http://docker.local/">http: //docker.local/</a> , you do not need to add <code>app_dev.php/</code> to the address.  4 containers will be launched: <code>nginx</code> , <code>php</code> , <code>mysql</code> and <code>phpmyadmin</code> (the latter is run only in the development environment). </p><br><p>  <code>docker.local</code> needs to be registered in the <code>hosts</code> .  For Linux, the ip-address of the site will be <code>127.0.0.1</code> , and under Windows you can find it out as a result of the work of the <code>docker-machine env</code> (after all, see the <a href="">instructions</a> ). </p><br><p>  <code>composer</code> in the <code>php</code> container is <a href="https://github.com/covex-nn/docker-php7.1-fpm/blob/3.3/Dockerfile">configured</a> in such a way that the <code>vendor</code> folder is inside the container and not on the host, and does not affect the performance in the local developer's environment. </p><br><h2 id="podgotovka-i-nastroyka-infrastruktury">  Preparing and setting up the infrastructure </h2><br><p>  In combat, the system will require three servers: <code>GitLab</code> ‚Äî the server for managing the Git and Container Registry repositories, <code>Docker  production</code> ‚Äî the server for production sites, and <code>Docker  </code> ‚Äî the server for pre-production and developer test sites. </p><br><div class="spoiler">  <b class="spoiler_title">Gitlab</b> <div class="spoiler_text"><h3 id="nastroyka-servera-s-gitlab-i-container-registry">  Setting up a server with GitLab and Container Registry </h3><br><p>  <a href="https://about.gitlab.com/installation/">GitLab</a> and <a href="https://docs.gitlab.com/ce/administration/container_registry.html">Container Registry</a> installation <a href="https://about.gitlab.com/installation/">instructions</a> are available at gitlab.com. </p><br><p>  By default, the GitLab Container Registry requires setting SSL certificates.  We will use the same certificate for both the Container Registry and the GitLab web interface.  You can create an SSL certificate using the <a href="https://certbot.eff.org/docs/using.html">LetsEncrypt</a> service. </p><br><p>  You can connect an SSL certificate in the <code>/etc/gitlab/gitlab.rb</code> file.  You also need to configure the ability to automatically renew the certificate: </p><br><pre> <code class="hljs pgsql">nginx[<span class="hljs-string"><span class="hljs-string">'ssl_certificate'</span></span>] = "/etc/letsencrypt/live/gitlab.site.ru/fullchain.pem" nginx[<span class="hljs-string"><span class="hljs-string">'ssl_certificate_key'</span></span>] = "/etc/letsencrypt/live/gitlab.site.ru/privkey.pem" registry_nginx[<span class="hljs-string"><span class="hljs-string">'ssl_certificate'</span></span>] = "/etc/letsencrypt/live/gitlab.site.ru/fullchain.pem" registry_nginx[<span class="hljs-string"><span class="hljs-string">'ssl_certificate_key'</span></span>] = "/etc/letsencrypt/live/gitlab.site.ru/privkey.pem" nginx[<span class="hljs-string"><span class="hljs-string">'custom_gitlab_server_config'</span></span>] = "location ^~ /.well-known { \n allow all;\n alias /var/lib/letsencrypt/.well-known/;\n default_type \"<span class="hljs-type"><span class="hljs-type">text</span></span>/plain\";\n try_files $uri =404;\n }\n"</code> </pre> <br><p>  After the change in the <code>gitlab.rb</code> file, <code>gitlab.rb</code> need to reload GitLab via <code>gitlab-ctl restart</code> and configure <code>crontab</code> to update the certificates: </p><br><pre> <code class="hljs swift"><span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> * * * /root/certbot-auto renew --no-<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>-upgrade --webroot -w /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/letsencrypt --renew-hook <span class="hljs-string"><span class="hljs-string">"service nginx reload"</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Docker for production</b> <div class="spoiler_text"><h3 id="nastroyka-servera-s-docker-dlya-production">  Setting up a server with Docker for production </h3><br><p>  Docker installation instructions are available on <a href="https://docs.docker.com/engine/installation/">docs.docker.com</a> . </p><br><p>  Additionally, you need to create a local network to assign internal IP addresses to the containers: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">docker</span></span> network create graynetwork --gateway <span class="hljs-number"><span class="hljs-number">192.168.10.1</span></span> --subnet <span class="hljs-number"><span class="hljs-number">192.168.10.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span></code> </pre> <br><p>  In addition to the Docker server, you must install <code>nginx</code> and <code>certbot-auto</code> from <a href="https://certbot.eff.org/docs/using.html">LetsEncrypt</a> . </p><br><p>  Nginx will proxy requests to web servers in Docker containers.  Nginx installation instructions are available on the <a href="http://nginx.org/ru/docs/install.html">nginx.org</a> website. </p><br><p>  Updating future SSL certificates should be configured immediately, as with on the server with GitLab: </p><br><pre> <code class="hljs swift"><span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> * * * /root/certbot-auto renew --no-<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>-upgrade --webroot -w /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/letsencrypt --renew-hook <span class="hljs-string"><span class="hljs-string">"service nginx reload"</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Docker for development</b> <div class="spoiler_text"><h3 id="nastroyka-servera-s-docker-dlya-razrabotki">  Setting up a server with Docker for development </h3><br><p>  You need to complete all the <code>Docker  production</code> installation points <code>Docker  production</code> and additionally install <code>GitLab CI Runner</code> on the server. </p><br><p>  <code>GitLab CI Runner</code> installation <code>GitLab CI Runner</code> are available on <a href="https://docs.gitlab.com/runner/install/linux-repository.html">docs.gitlab.com</a> . </p><br><p>  Running GitLab Runner: </p><br><pre> <code class="hljs tex">gitlab-ci-multi-runner verify --delete printf "concurrent = 10<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ncheck</span></span></span></span>_interval = 0<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">n</span></span></span></span>" &gt; /etc/gitlab-runner/config.toml gitlab-ci-multi-runner register -n <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--url https://gitlab-server.ru/ <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--registration-token &lt;token&gt; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--tag-list "executor-docker,docker-in-docker" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--executor docker <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--description "docker-dev" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--docker-image "docker:latest" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--docker-volumes "/composer/home/cache" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--docker-volumes "/root/.composer/cache" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--docker-volumes "/var/run/docker.sock:/var/run/docker.sock"</code> </pre> <br><p>  The <code>&lt;token&gt;</code> must be copied from the GitLab web interface in the <code>Admin Area --&gt; Runners</code> section. </p></div></div><br><p>  Several developers will work on the project, they need to give access so that they do not break anything and do not interfere with each other. </p><br><div class="spoiler">  <b class="spoiler_title">Access setting</b> <div class="spoiler_text"><h3 id="sozdanie-master-polzovatelya">  Creating a Master User </h3><br><ul><li><p>  On the <code>Docker  production</code> server <code>Docker  production</code> you need to create a <code>master</code> user and add it to the <code>docker</code> group: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">adduser</span></span> master usermod -aG docker master</code> </pre> <br></li><li><p>  Next, you need to log in as a new user and create an <code>id_rsa</code> key without passphrase: </p><br><pre> <code class="hljs ruby">ssh-keygen -t rsa -b <span class="hljs-number"><span class="hljs-number">4096</span></span> -C <span class="hljs-string"><span class="hljs-string">"master@docker-server-prod.ru"</span></span> cat ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa.pub <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/authorized</span></span>_keys</code> </pre> <br><p>  This key will be used for SSH access to the server and for access to the git repository of developers. </p><br></li><li>  In GitLab, create a user <code>master</code> and add an SSH key to it.  This user will be purely technical.  In the future, under it will not need to go and perform any operations. </li></ul><br><h3 id="sozdanie-polzovatelya-razrabotchika">  Creating a developer user </h3><br><ul><li><p>  On the <code>Docker  </code> server <code>Docker  </code> you need to create a user <code>dev1</code> <code>Docker  </code> (the name can be any): </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">adduser</span></span> dev1 usermod -aG docker dev1</code> </pre> <br></li><li><p>  Next, you need to log in as a new user and create an id_rsa key without passphrase: </p><br><pre> <code class="hljs ruby">ssh-keygen -t rsa -b <span class="hljs-number"><span class="hljs-number">4096</span></span> -C <span class="hljs-string"><span class="hljs-string">"dev1@docker-server-dev.ru"</span></span> cat ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa.pub <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/authorized</span></span>_keys chmod <span class="hljs-number"><span class="hljs-number">400</span></span> ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/id</span></span>_rsa.pub ~<span class="hljs-regexp"><span class="hljs-regexp">/.ssh/authorized</span></span>_keys</code> </pre> <br><p>  This key will be used for SSH access to the server, it should not be known to any of the developers. </p><br></li><li><p>  In GitLab create user <code>dev1</code> , forbidding him to create their own repositories and groups.  You do not need to configure the SSH key - the developer will set it up for himself. </p><br></li><li>  In GitLab, create the <code>dev1-projects</code> group and add the <code>master</code> user with the <code>Master</code> role to the group.  This group will contain all the repositories of this developer. </li></ul></div></div><br><p>  The project will have one main repository and one repository for each developer.  The main repository will be the source for production- and staging-sites, the developer repository for the test site of this particular developer.  Deploy processes for each of the sites will be the same.  The differences will be only in the application configuration and access settings to the server with Docker.  Configuration and settings will be stored in <code>GitLab</code> , in the <code>Settings -- CI/CD Pipelines</code> section <code>Settings -- CI/CD Pipelines</code> : mainly the repositories are for production and staging sites, and in the developer repository are for the developer‚Äôs test site. </p><br><div class="spoiler">  <b class="spoiler_title">Create and configure the main repository</b> <div class="spoiler_text"><p>  The main project repository can be placed in an arbitrary group. </p><br><p>  In the <code>Settings --&gt; Pipelines</code> section, you need to select <code>git clone</code> as your <code>Git strategy for pipelines</code> and add variables: </p><br><table><thead><tr><th>  Variable </th><th>  Value </th></tr></thead><tbody><tr><td>  COMPOSER_GITHUB_TOKEN </td><td>  Create a token at <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> </td></tr><tr><td>  SSH_PRIVATE_KEY </td><td>  fill it with the contents of the master user id_rsa file </td></tr><tr><td>  NETWORK_NAME_MASTER </td><td>  graynetwork </td></tr><tr><td>  SERVER_NAME_MASTER </td><td>  site-staging.ru </td></tr><tr><td>  NETWORK_IP_MASTER </td><td>  choose free IP in the graynetwork subnet </td></tr><tr><td>  NETWORK_NAME_PRODUCTION </td><td>  graynetwork </td></tr><tr><td>  SERVER_NAME_PRODUCTION </td><td>  site-production.ru </td></tr><tr><td>  NETWORK_IP_PRODUCTION </td><td>  choose free IP in the graynetwork subnet </td></tr><tr><td>  DEPLOY_USER_MASTER </td><td>  master </td></tr><tr><td>  DEPLOY_HOST_MASTER </td><td>  docker-server-prod.ru </td></tr><tr><td>  DEPLOY_DIRECTORY_MASTER </td><td>  /home/master/site-staging.ru </td></tr><tr><td>  DEPLOY_USER_PRODUCTION </td><td>  master </td></tr><tr><td>  DEPLOY_HOST_PRODUCTION </td><td>  docker-server-prod.ru </td></tr><tr><td>  DEPLOY_DIRECTORY_PRODUCTION </td><td>  /home/master/site-production.ru </td></tr><tr><td>  PROJECT_FORKS </td><td>  &lt;leave empty&gt; </td></tr></tbody></table><br><p>  To deploy the skeleton of an application to staging, you need to upload the <code>master</code> branch to the repository via <code>git push origin master</code> . </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Creating and setting up a developer repository</b> <div class="spoiler_text"><p>  The developer repository must be in the developer‚Äôs project group  For the user, <code>dev1</code> is <code>dev1-projects</code> .  The developer repository is created by <strong>creating an</strong> <u>administrator</u> from the main repository <strong>for Fork</strong> .  It is important. </p><br><ul><li>  Together with the creation of a fork, it will be possible to create a Merge Request from the developer‚Äôs repository to the main </li><li>  And the creation of a fork by the administrator is necessary to ensure the stability of the system and to keep the key secret for the id_rsa to access the server. </li></ul><br><p>  In the <code>Settings --&gt; Pipelines</code> section, you need to select <code>git clone</code> as your <code>Git strategy for pipelines</code> , hide the <code>Public pipelines</code> and add variables: </p><br><table><thead><tr><th>  Variable </th><th>  Value </th></tr></thead><tbody><tr><td>  COMPOSER_GITHUB_TOKEN </td><td>  Create a token at <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> </td></tr><tr><td>  SSH_PRIVATE_KEY </td><td>  fill it with the contents of the dev1 user <code>dev1</code> </td></tr><tr><td>  NETWORK_NAME_MASTER </td><td>  graynetwork </td></tr><tr><td>  SERVER_NAME_MASTER </td><td>  site-dev1.ru </td></tr><tr><td>  NETWORK_IP_MASTER </td><td>  choose free IP in the graynetwork subnet </td></tr><tr><td>  DEPLOY_USER_MASTER </td><td>  dev </td></tr><tr><td>  DEPLOY_HOST_MASTER </td><td>  docker-server-dev.ru </td></tr><tr><td>  DEPLOY_DIRECTORY_MASTER </td><td>  /home/dev1/site-dev1.ru </td></tr><tr><td>  PROJECT_FORKS </td><td>  &lt;leave empty&gt; </td></tr></tbody></table><br><p>  Before deploying to the test site, you need to create a <code>stable</code> branch that points to the same commit as the <code>master</code> branch.  The <code>stable</code> branch will correspond to the state of the staging site; only verified and accepted code will be located in this branch. </p><br><p>  In the process of work, the developer should, on the one hand, be able to merge commits and rewrite history via <code>git push -f origin master</code> .  On the other hand, it should not be able to displace the <code>stable</code> branch and create tags in order not to disrupt the rest of the system. </p><br><p>  To do this, in the <code>Settings --&gt; Repository</code> section, you need to unprotect the <code>master</code> branch and secure the <code>stable</code> branch and all tags. </p><br><p>  To deploy an application to the developer‚Äôs test site, you need to run Pipeline for the <code>master</code> branch.  After that, you need to issue the <code>Developer</code> role to the user <code>dev1</code> in the <code>Settings --&gt; Members</code> section. </p><br><p>  At the end you need to tune the main repository.  You need to add a line with the address of the developer's repository to the <code>PROJECT_FORKS</code> variable to synchronize the <code>stable</code> branch in the new repository.  And to issue the role <code>Reporter</code> user <code>dev1</code> in the main repository. </p></div></div><br><p>  The last step before starting work is to configure Nginx on servers with Docker.  This Nginx will be configured manually, and all HTTP / HTTPS requests to Symfony applications will be proxied to the selected IP address in the internal, previously created, Docker subnet (see the <code>NETWORK_NAME_...</code> and <code>NETWORK_IP_...</code> variables). </p><br><div class="spoiler">  <b class="spoiler_title">Setting up an external Nginx</b> <div class="spoiler_text"><h3 id="sozdanie-konfiguracionnogo-fayla">  Creating a configuration file </h3><br><p>  Sample configuration for the <code>site-dev1.ru</code> domain.  Here <code>192.168.10.10</code> is the content of the <code>NETWORK_IP_MASTER</code> variable from the <code>dev1</code> developer repository settings. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">server</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; # <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; server_name site-dev1.ru; # ssl_certificate /etc/letsencrypt/live/site-dev1.ru/fullchain.pem; # ssl_certificate_key /etc/letsencrypt/live/site-dev1.ru/privkey.pem; # <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($ssl_protocol = "") { # rewrite ^/(.*) https://$server_name/<span class="hljs-meta"><span class="hljs-meta">$1</span></span> permanent; # } <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> / { proxy_pass http://<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> proxy_params; } <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> ~ /.well-known { allow <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> /var/lib/letsencrypt/.well-known; } }</code> </pre> <br><h3 id="sozdanie-ssl-sertifikata">  Create SSL Certificate </h3><br><pre> <code class="hljs tex">/root/certbot-auto certonly <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--no-self-upgrade <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--webroot <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-d site-dev1.ru <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-w /var/lib/letsencrypt</code> </pre> <br><p>  To switch the site from HTTP to HTTPS, uncomment the lines in the HTTP domain configuration and reboot Nginx. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nginx</span></span> -t service nginx reload</code> </pre> </div></div><br><h2 id="process-razrabotki">  Development process </h2><br><p>  At this stage, the developer has access to his own repository.  In its repository, it has the role of <code>Developer</code> and can do almost <a href="https://docs.gitlab.com/ce/user/permissions.html">anything</a> .  In the developer's repository, the <code>master</code> branch corresponds to the state of its test site.  Protected- <code>stable</code> branch - as a <code>staging</code> site. </p><br><div class="spoiler">  <b class="spoiler_title">What is the development process for a developer?</b> <div class="spoiler_text"><p>  Each new task must begin with the creation of a task branch pointing to the same commit as the <code>stable</code> branch. </p><br><pre> <code class="bash hljs">git fetch --all --prune git checkout origin/stable git checkout -b feature-qwerty git push origin feature-qwerty</code> </pre> <br><p>  Then, at some stage, when you need to put your changes in to the test site, you can upload the changes to the repository in the <code>master</code> branch - and the changes will be posted in 2-5 minutes. </p><br><p>  The merging of changes from the developer's repository to the main one should occur from the task branch, in the example, this is <code>feature-qwerty</code> , to the <code>master</code> branch of the main repository through creating the corresponding Merge Request in the GitLab web interface. </p><br><p>  Before accepting a Merge Request, the administrator must make sure that the commits in the developer branch go strictly after the current position of the <code>master</code> branch of the main repository.  This will not happen automatically in GitLab CE, the feature is available only in <a href="https://docs.gitlab.com/ee/user/project/merge_requests/fast_forward_merge.html">GitLab EE</a> . </p><br><p>  To roll out changes to the working site, you need to create a <code>release-...</code> tag in the GitLab web interface. </p></div></div><br><p>  Along with the change in the project code, the developer can add new values ‚Äã‚Äãto the application parameters.  The values ‚Äã‚Äãof these parameters may vary depending on the environment. </p><br><div class="spoiler">  <b class="spoiler_title">Configuring symfony settings</b> <div class="spoiler_text"><h3 id="lokalnoe-okruzhenie-razrabotchika">  Local Developer Environment </h3><br><p>  The default configuration is stored in the <code>.env</code> file in the project root.  This file is one for all developers and is part of the repository: </p><br><pre> <code class="hljs">ENV_hwi_facebook_client_id=1234 ENV_hwi_facebook_client_secret=4567</code> </pre> <br><p>  The file is loaded when <code>docker-compose up -d</code> started, the values ‚Äã‚Äãget into the container through the <code>environment</code> block in the <code>php</code> service description: </p><br><pre> <code class="hljs perl">services: php: environment: ENV_hwi_facebook_client_id: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ENV_hwi_facebook_client_id}</span></span></span><span class="hljs-string">"</span></span> ENV_hwi_facebook_client_secret: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ENV_hwi_facebook_client_secret}</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br><p>  Inside symfony, these values ‚Äã‚Äãget through the file <code>app/config/parameters.yml</code> (it is also part of the application): </p><br><pre> <code class="hljs mel">parameters: hwi_facebook_client_id: <span class="hljs-string"><span class="hljs-string">"%env(ENV_hwi_facebook_client_id)%"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>(ENV_hwi_facebook_client_id): ~ hwi_facebook_client_secret: <span class="hljs-string"><span class="hljs-string">"%env(ENV_hwi_facebook_client_secret)"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">env</span></span>(ENV_hwi_facebook_client_secret): ~</code> </pre> <br><p>  To implement new papameters, you need to restart <code>docker-compose</code> : </p><br><pre> <code class="hljs sql">docker-compose <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> docker-compose up -d</code> </pre> <br><h3 id="testovyy-sayt-razrabotchika">  Developer Test Site </h3><br><p>  Before rolling out the changes to the developer‚Äôs test site, the administrator must add the variable values ‚Äã‚Äãfor this site in the <code>Settings --&gt; Pipelines</code> section.  <code>_MASTER</code> suffix should be added to variable names. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">ENV_hwi_facebook_client_id_MASTER</span></span> ENV_hwi_facebook_client_secret_MASTER</code> </pre> <br><p>  If variables are not created, values ‚Äã‚Äãfor them will be taken from the <code>.env</code> file. </p><br><h3 id="staging">  Staging </h3><br><p>  Before accepting a Merge Request, in the main repository you need to add variables with the <code>_MASTER</code> suffix, as was done for the developer‚Äôs test site. </p><br><p>  After accepting the Merge Request and implementing changes to <code>staging</code> you need to add variables to all other developer repositories. </p><br><h3 id="production">  Production </h3><br><p>  In the main repository, you need to add variables with the suffix <code>_PRODUCTION</code> , as was done for staging. </p></div></div><br><p>  Also for the developer in the development environment, the <code>xdebug</code> extension is <code>xdebug</code> , and CSS and Javascript files are managed using the <a href="http://symfony.com/doc/current/frontend.html">Webpack Encore</a> . </p><br><h2 id="cicd-iznutri">  CI / CD inside </h2><br><p>  The process of continuous integration / deployment is described in the file <a href="">.gitlab-ci.yml</a> in the root of the repository, it consists of 4 stages: dependency loading, phpunit testing, building, deployment. </p><br><h3 id="zagruzka-zavisimostey">  Download dependencies </h3><br><p>  At this stage, an attempt is made to install all the dependencies of the application through the <code>composer</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Stage deps stage in .gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs perl">deps:php-composer: stage: deps image: covex/php7.<span class="hljs-number"><span class="hljs-number">1</span></span>-fpm:<span class="hljs-number"><span class="hljs-number">1.0</span></span> script: - echo <span class="hljs-string"><span class="hljs-string">'{"github-oauth":{"github.com":"'</span></span><span class="hljs-string"><span class="hljs-string">"$COMPOSER_GITHUB_TOKEN"</span></span><span class="hljs-string"><span class="hljs-string">'"}}'</span></span> &gt; ./auth.json - composer install --prefer-dist --<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-scripts --<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-autoloader --<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-interaction tags: - executor-docker</code> </pre> </div></div><br><p>  The result of this stage will be filling the folder <code>/composer/home/cache</code> .  This folder is saved in the <code>volume</code> of <code>gitlab-ci-multi-runner</code> and the composer cache will be available for all subsequent tasks (both in the current pipeline and in subsequent ones). </p><br><h3 id="phpunit-testirovanie">  PHPUnit testing </h3><br><p>  Before running <code>phpunit</code> , environment variables are created for the operation of the symfony application.  If any values ‚Äã‚Äãof variables in the testing environment should differ in values ‚Äã‚Äãin all other environments - you need to create such variables in the settings of the GitLab repository with the <code>_TEST</code> suffix (for example, <code>ENV_hwi_facebook_client_id_TEST</code> ).  Then its value will <code>.env</code> default from the <code>.env</code> file. </p><br><div class="spoiler">  <b class="spoiler_title">Test phase in .gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs bash">.template-suffix-vars: &amp;suffix-vars before_script: - cat .env | grep ENV_ &gt; .build-env - sed -i <span class="hljs-string"><span class="hljs-string">'s/^/export /'</span></span> .build-env - <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> `env | awk -F= <span class="hljs-string"><span class="hljs-string">'{if($1 ~ /'</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ENV_SUFFIX</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'$/) print $1}'</span></span>`; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'export '</span></span>`<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$name</span></span>|awk -F<span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ENV_SUFFIX</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'$'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span>`<span class="hljs-string"><span class="hljs-string">'='</span></span>`printenv <span class="hljs-variable"><span class="hljs-variable">$name</span></span>`<span class="hljs-string"><span class="hljs-string">''</span></span> &gt;&gt; .build-env; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>:phpunit: stage: <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> image: covex/php7.1-fpm:1.0 &lt;&lt;: *suffix-vars variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_TEST"</span></span> script: - <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> $(cat .build-env) - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'{"github-oauth":{"github.com":"'</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$COMPOSER_GITHUB_TOKEN</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'"}}'</span></span> &gt; ./auth.json - composer require phpunit/phpunit:* --dev - phpunit dependencies: [] tags: - executor-docker</code> </pre> </div></div><br><h3 id="sborka">  Assembly </h3><br><p>  Here the <em>build for the php project</em> is the creation of docker images for nginx and php containers, and putting the prepared images in GitLab Container Registry. </p><br><div class="spoiler">  <b class="spoiler_title">Build stage in .gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs mel">.template-docker-nginx-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: &amp;docker-nginx-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span> stage: build <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: docker:latest &lt;&lt;: *suffix-vars script: - <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span> $(cat .build-<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>) - docker build --tag $CI_NGINX_IMAGE_WITH_TAG --build-arg server_name=$SERVER_NAME --build-arg server_upstream=prod --build-arg app_php=app ./docker/nginx - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY - docker push $CI_NGINX_IMAGE_WITH_TAG - docker logout $CI_REGISTRY tags: - executor-docker - docker-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-docker .template-docker-app-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: &amp;docker-app-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span> stage: build <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: docker:latest &lt;&lt;: *suffix-vars script: - <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span> $(cat .build-<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>) - echo <span class="hljs-string"><span class="hljs-string">'{"github-oauth":{"github.com":"'</span></span><span class="hljs-string"><span class="hljs-string">"$COMPOSER_GITHUB_TOKEN"</span></span><span class="hljs-string"><span class="hljs-string">'"}}'</span></span> &gt; ./auth.json - docker build --tag $CI_APP_IMAGE_WITH_TAG . - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY - docker push $CI_APP_IMAGE_WITH_TAG - docker logout $CI_REGISTRY dependencies: - deps:php-composer tags: - executor-docker - docker-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>-docker .template-docker-compose: &amp;docker-compose stage: build <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: covex/docker-compose:<span class="hljs-number"><span class="hljs-number">1.0</span></span> &lt;&lt;: *suffix-vars script: - <span class="hljs-keyword"><span class="hljs-keyword">eval</span></span> $(cat .build-<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>) - mkdir build - docker-compose -f docker-compose-deploy.yml config &gt; build/docker-compose.yml - sed -i <span class="hljs-string"><span class="hljs-string">'s/\/builds\/'</span></span><span class="hljs-string"><span class="hljs-string">"$CI_PROJECT_NAMESPACE"</span></span><span class="hljs-string"><span class="hljs-string">'\/'</span></span><span class="hljs-string"><span class="hljs-string">"$CI_PROJECT_NAME"</span></span><span class="hljs-string"><span class="hljs-string">'/\./g'</span></span> build/docker-compose.yml artifacts: untracked: true name: <span class="hljs-string"><span class="hljs-string">"$CI_COMMIT_REF_NAME"</span></span> paths: - build/ tags: - executor-docker dependencies: [] build:docker-nginx-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>-master: &lt;&lt;: *docker-nginx-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span> variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_MASTER"</span></span> only: - master except: - tags build:docker-nginx-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>-production: &lt;&lt;: *docker-nginx-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span> variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_PRODUCTION"</span></span> only: - /^release-.*$/ except: - branches build:docker-app-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>-master: &lt;&lt;: *docker-app-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span> variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_MASTER"</span></span> only: - master except: - tags build:docker-app-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span>-production: &lt;&lt;: *docker-app-<span class="hljs-keyword"><span class="hljs-keyword">image</span></span> variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_PRODUCTION"</span></span> only: - /^release-.*$/ except: - branches build:docker-compose-master: &lt;&lt;: *docker-compose variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_MASTER"</span></span> only: - master except: - tags build:docker-compose-production: &lt;&lt;: *docker-compose variables: ENV_SUFFIX: <span class="hljs-string"><span class="hljs-string">"_PRODUCTION"</span></span> only: - /^release-.*$/ except: - branches</code> </pre> </div></div><br><p>  Here, the <code>build:docker-app-image-master</code> task <code>build:docker-app-image-master</code> creates PHP application images for the staging site (and for the developer‚Äôs test site);  and the <code>build:docker-app-image-production</code> task <code>build:docker-app-image-production</code> is for a production site.  For each task, the values ‚Äã‚Äãof variables from the pipeline settings with the suffix <code>_MASTER</code> or <code>_PRODUCTION</code> override the default values ‚Äã‚Äãfrom the <code>.env</code> file.  The tasks for building <code>nginx</code> images are described in a similar way (see the <code>build:docker-nginx-image-master</code> tasks <code>build:docker-nginx-image-master</code> and <code>build:docker-nginx-image-production</code> ). </p><br><p>  Also at this stage, the <code>docker-compose.yml</code> file is created, which in the next stage will be copied to the remote server (see <code>build:docker-compose-master</code> and <code>build:docker-compose-production</code> tasks).  The generated <code>docker-compose.yml</code> contains all the environment variables needed to run the application.  In the <code>services</code> section all containers will be created only on the basis of ready docker images. </p><br><div class="spoiler">  <b class="spoiler_title">Sample docker-compose.yml file generated</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">networks: nw_external: <span class="hljs-keyword"><span class="hljs-keyword">external</span></span>: <span class="hljs-type"><span class="hljs-type">name</span></span>: graynetwork nw_internal: {} services: mysql: environment: MYSQL_DATABASE: project MYSQL_PASSWORD: project MYSQL_ROOT_PASSWORD: root MYSQL_USER: project expose: - <span class="hljs-string"><span class="hljs-string">'3306'</span></span> image: covex/mysql:<span class="hljs-number"><span class="hljs-number">5.7</span></span> networks: nw_internal: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> volumes: - <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>:/var/lib/mysql:rw nginx: depends_on: mysql: condition: service_healthy image: gitlab.site.ru:<span class="hljs-number"><span class="hljs-number">5005</span></span>/dev1-projects/symfony-workflow2/nginx:master networks: nw_external: ipv4_address: <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> nw_internal: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ports: - <span class="hljs-number"><span class="hljs-number">80</span></span>/tcp <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> volumes: - assets:/srv/a:ro - assets:/srv/b:ro - assets:/srv/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>:ro php: environment: ENV_database_host: mysql ENV_database_mysql_version: <span class="hljs-string"><span class="hljs-string">'5.7'</span></span> ENV_database_name: project ENV_database_password: project ENV_database_port: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> ENV_database_user: project ENV_mailer_from: andrey@mindubaev.ru ENV_mailer_host: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ENV_mailer_password: <span class="hljs-string"><span class="hljs-string">'null'</span></span> ENV_mailer_transport: smtp ENV_mailer_user: <span class="hljs-string"><span class="hljs-string">'null'</span></span> ENV_secret: ThisTokenIsNotSoSecretChangeIt image: gitlab.site.ru:<span class="hljs-number"><span class="hljs-number">5005</span></span>/dev1-projects/symfony-workflow2:master networks: nw_internal: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> volumes: - assets:/srv/a:rw - assets:/srv/b:rw - assets:/srv/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>:rw spare: environment: ENV_database_host: mysql ENV_database_mysql_version: <span class="hljs-string"><span class="hljs-string">'5.7'</span></span> ENV_database_name: project ENV_database_password: project ENV_database_port: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> ENV_database_user: project ENV_mailer_from: andrey@mindubaev.ru ENV_mailer_host: <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> ENV_mailer_password: <span class="hljs-string"><span class="hljs-string">'null'</span></span> ENV_mailer_transport: smtp ENV_mailer_user: <span class="hljs-string"><span class="hljs-string">'null'</span></span> ENV_secret: ThisTokenIsNotSoSecretChangeIt image: gitlab.site.ru:<span class="hljs-number"><span class="hljs-number">5005</span></span>/dev1-projects/symfony-workflow2:master networks: nw_internal: <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> volumes: - assets:/srv/a:rw - assets:/srv/b:rw - assets:/srv/<span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>:rw <span class="hljs-keyword"><span class="hljs-keyword">version</span></span>: <span class="hljs-string"><span class="hljs-string">'2.1'</span></span> volumes: assets: {} <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: {}</code> </pre> </div></div><br><h3 id="razvyortyvanie">  Deployment </h3><br><p>  At this stage, the docker images of the application are ready and uploaded to the Container Registry.  It remains to update the application. </p><br><p>  There is no <code>phpmyadmin</code> server on remote servers;  in addition to the <code>php</code> service, absolutely the same <code>spare</code> service has been added;  and in the <code>nginx</code> configuration, instead of one server, two are <code>upstream</code> .  The use of two identical services allowed achieving <strong>almost zero deployment downtime</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Stage deploy to .gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="hljs bash">.template-secure-copy: &amp;secure-copy stage: deploy image: covex/alpine-git:1.0 before_script: - <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> $(ssh-agent -s) - ssh-add &lt;(<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$SSH_PRIVATE_KEY</span></span></span><span class="hljs-string">"</span></span>) script: - <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span> $(cat .build-env) - ssh -p 22 <span class="hljs-variable"><span class="hljs-variable">$DEPLOY_USER</span></span>@<span class="hljs-variable"><span class="hljs-variable">$DEPLOY_HOST</span></span> <span class="hljs-string"><span class="hljs-string">'set -e ; rm -rf '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'_tmp ; mkdir -p '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'_tmp'</span></span> - scp -P 22 -r build/* <span class="hljs-string"><span class="hljs-string">''</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_USER</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'@'</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_HOST</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">':'</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'_tmp'</span></span> - ssh -p 22 <span class="hljs-variable"><span class="hljs-variable">$DEPLOY_USER</span></span>@<span class="hljs-variable"><span class="hljs-variable">$DEPLOY_HOST</span></span> <span class="hljs-string"><span class="hljs-string">'set -e ; if [ -d '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">' ]; then rm -rf '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'; fi ; mv '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">'_tmp '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">' ; cd '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">' ; docker login -u gitlab-ci-token -p '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_JOB_TOKEN</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$CI_REGISTRY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">' ; docker-compose pull ; docker-compose up -d --no-recreate ; docker-compose up -d --force-recreate --no-deps spare ; docker-compose exec -T spare sh -c "cd /srv &amp;&amp; rm -rf b/* &amp;&amp; cp -a web/. b/ &amp;&amp; rm -rf a/* &amp;&amp; cp -a web/. a/" ; docker-compose exec -T spare phing storage-prepare database-deploy ; docker-compose up -d --force-recreate --no-deps php'</span></span> - ssh -p 22 <span class="hljs-variable"><span class="hljs-variable">$DEPLOY_USER</span></span>@<span class="hljs-variable"><span class="hljs-variable">$DEPLOY_HOST</span></span> <span class="hljs-string"><span class="hljs-string">'set -e ; cd '</span></span><span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$DEPLOY_DIRECTORY</span></span></span><span class="hljs-string">"</span></span><span class="hljs-string"><span class="hljs-string">' ; echo "[$(date -R)] web-server is down" ; docker-compose stop nginx ; docker-compose up -d nginx ; echo "[$(date -R)] web-server is up"'</span></span> tags: - executor-docker deploy:secure-copy-master: &lt;&lt;: *secure-copy only: - master except: - tags environment: name: staging dependencies: - build:docker-compose-master deploy:secure-copy-production: &lt;&lt;: *secure-copy only: - /^release-.*$/ except: - branches environment: name: production dependencies: - build:docker-compose-production</code> </pre> </div></div><br><p>  The deployment algorithm is as follows: </p><br><ul><li>  Copy the <code>docker-compose.yml</code> file generated during the <code>build</code> <code>docker-compose.yml</code> </li><li>  Downloading new images from the Container Registry </li><li>  Update the <code>spare</code> container </li><li>  We update static files for <code>nginx</code> , we make database migration </li><li>  We update the container <code>php</code> </li><li>  We update the containers <code>nginx</code> and <code>mysql</code> (in combat conditions - this is not necessary) </li></ul><br><p>  During the update of the <code>spare</code> or <code>php</code> , <code>nginx</code> containers after a few seconds the inaccessibility of one of them switches to the next available in <code>upstream</code> .  Those.  The application works <em>correctly for 100%</em> HTTP requests, but sometimes with a delay. </p><br><p>        HTTP-    <code>php</code> ,       ,    ‚Äî   <code>spare</code> ,        .  Those.  <em>         </em> .   ,            ,      . </p><br><p>     <code>nginx</code>  <code>mysql</code> ,   .     ,      "".         5 ,   80-90%   deployment downtime. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p> <code>GitLab Continuous Integration &amp; Deployment</code>  <code>docker-compose</code> ‚Äî  .     -     <code>vagrant</code>   .  ,  ,    ,     ,   <code>composer.json</code> . Development-     ‚Äî     ,   production,      Linux + Apache + PHP + MySQL.           ,         ,       . </p><br><p>   ‚Äî  <code>docker swarm</code> ,  <code>kubernetes</code> ,     .   ,  . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335564/">https://habr.com/ru/post/335564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335552/index.html">How does the Kubernetes scheduler actually work?</a></li>
<li><a href="../335556/index.html">15.5 SP1 and 3CX Firewall Checker release released with SIP ALG verification</a></li>
<li><a href="../335558/index.html">The market for uninterruptible power supplies has grown for the first time in four years.</a></li>
<li><a href="../335560/index.html">Dive into F #. Handbook for C # Developers</a></li>
<li><a href="../335562/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ275 (August 7 - 13, 2017)</a></li>
<li><a href="../335566/index.html">Chromebook for remote work. Configure VPN and RDP</a></li>
<li><a href="../335568/index.html">[admin outline] Less admins for everyone</a></li>
<li><a href="../335570/index.html">New Safari tools for debugging WebRTC</a></li>
<li><a href="../335572/index.html">Record of the webinar "How to securely protect the company from unknown threats and cryptographers"</a></li>
<li><a href="../335574/index.html">Do-it-yourself chat bot: the story of one bike</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>