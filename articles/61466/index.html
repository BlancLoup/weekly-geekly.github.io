<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multicast routing for IPTV</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One very close person to me, a fan of Habr, wanted to contribute to the development of the Cisco blog. Being a fierce fan of what this corporation cre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multicast routing for IPTV</h1><div class="post__text post__text-html js-mediator-article">  One very close person to me, a fan of Habr, wanted to contribute to the development of the Cisco blog.  Being a fierce fan of what this corporation creates, he wanted to share his experience.  =) Hope the stroke of the pen was a success. <br><br>  Relatively recently, I was lucky enough to introduce and even see multicast routing for IPTV.  Initially, I was completely <s>unfamiliar</s> with this topic, and it made me <s>vylakat neck from a vodka tank to</s> dig up a huge amount of documentation to get up to date. <br><br>  And that's bad luck.  Usually in the documentation they post everything at once and for the person who first encountered this topic, it is not clear where to start.  While reading pdf, I caught myself thinking that it would be nice to stumble somewhere on an article that could take a short way from theory to practice, in order to understand where to start and where to focus. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I could not find such an article.  This prompted me to write this little article for those who, like me, will face the question of what kind of an IPTV beast it is and how to fight it. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  <em>This is my very first article (but not the last! There are many more animals), I will try to present everything as accessible as possible.</em> <br><br>  First of all, we will voice a few concepts in order to exclude further misunderstandings.  There are three types of traffic: <br><ul><li>  <strong>unicast</strong> - unicast, one source of stream one receiver </li><li>  <strong>broadcast</strong> - broadcast, single source, recipients all clients on the network </li><li>  <strong>multicast</strong> - multicast, one sender, recipients, some group of clients </li></ul><br><h3>  What kind of traffic to use for IPTV? </h3><table><tbody><tr><td>  - </td><td>  <strong>unicast</strong> </td><td>  <strong>broadcast</strong> </td><td>  <strong>multicast</strong> </td></tr><tr><td>  <strong>Features applied to IPTV</strong> </td><td>  we get traffic duplication, a stream is created for each subscriber </td><td>  client equipment is forced to process the entire stream of channels, which may not be quite a few kilobits </td><td>  the subscriber receives only the stream that requests </td></tr></tbody></table><br><br><img src="https://habrastorage.org/getpro/habr/post_images/618/dc5/d4e/618dc5d4e091950cacb45cd54e7a3819.gif"><br>  Obviously, multicast is the most preferred channel for broadcasting channels. <br>  Any TV channel that we want to broadcast to the network is characterized by a group address that is selected from the range reserved for this purpose: <em>224.0.0.0 - 239.255.255.255</em> . <br><br>  IPTV requires a router that supports multicast (hereinafter MR).  He will track the membership of a client in a particular group, i.e.  constantly follow which client to send a TV-channel. <br><br>  In order for the client to register with one of these groups and watch the TV channel, the Internet Group Management Protocol ( <strong>IGMP</strong> ) is used. <br><br><h3>  A little bit about how IGMP works. </h3><br>  There is a server that is included in the MR router.  This server broadcasts several TV-cartoons, for example: <br><br><table><tbody><tr><td>  224.12.0.1 </td><td>  channel 1 </td><td>  News </td></tr><tr><td>  224.12.0.2 </td><td>  channel 2 </td><td>  History </td></tr><tr><td>  224.12.0.3 </td><td>  channel 3 </td><td>  Animals </td></tr></tbody></table><br><br>  The client turns on the News channel, thus, unwittingly, he sends a request for MR to connect to the group 224.12.0.1.  From the point of view of the IGMP protocol, this is the ‚Äú <em>JOIN 224.12.0.1</em> ‚Äù request. <br><br>  If a user switches to another channel, then he first sends an MR notice that he is shutting down the News channel or leaving this group.  For IGMP this is ‚Äú <em>LEAVE 224.12.0.1</em> ‚Äù.  And then repeats a similar JOIN query for the desired channel. <br><br>  MR sometimes asks everyone: ‚Äúand to which group who is connected?‚Äù In order to disconnect those customers with whom the connection was broken and they did not have time to send a <em>LEAVE</em> notification.  To do this, MR uses the <em>QUERY</em> query. <br><br>  The subscriber‚Äôs response to this request is the <em>MEMBERSHIP REPORT</em> , which contains a list of all the groups the client is in. <br><br><h3>  Configure multicast routing. </h3><br><br>  Suppose that clients of the same group are watching the same cartoon, but they are in different network segments (network A and network B).  In order for them to get their cartoon and invented multicast routing. <br><br>  An example of setting up the routers MR1 ‚Äã‚Äãand MR2. <br><br><table><tbody><tr><td>  Network a </td><td>  10.1.0.0/24 </td></tr><tr><td>  Network b </td><td>  10.2.0.0/24 </td></tr><tr><td>  Network C </td><td>  10.3.0.0/24 </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cc1/fac/9ab/cc1fac9ab9a0a9a3a36e18fb915ee5a5.gif"></div><br><br><table><tbody><tr><td>  <strong>MR1</strong> </td><td>  <strong>MR2</strong> </td></tr><tr><td>  MR1 # sh run <br><br>  ip multicast-routing <br>  ! <br>  interface Ethernet 0 <br>  description Multicast Source <br>  ip address 10.0.0.1 255.255.255.0 <br>  ip pim sparse-mode <br>  ! <br>  interface Ethernet 1 <br>  description Network A <br>  ip address 10.1.0.1 255.255.255.0 <br>  ip pim sparse-mode <br>  ! <br>  interface Ethernet 2 <br>  description Network B <br>  ip address 10.2.0.1 255.255.255.0 <br>  ip pim sparse-mode <br>  ! <br>  interface Ethernet 3 <br>  description Link to MR2 <br>  ip address 10.10.10.1 255.255.255.0 <br>  ip pim sparse-mode <br>  ! <br>  ip pim rp-address 10.0.0.2 IPTV override <br>  ! <br>  ip access-list standard IPTV <br>  permit 224.11.0.0 0.0.0.3 <br></td><td>  MR2 # sh run <br><br>  ip multicast-routing <br>  ! <br>  interface Ethernet 0 <br>  description Link to MR1 <br>  ip address 10.10.10.2 255.255.255.0 <br>  ip pim sparse-mode <br>  ! <br>  interface Ethernet 1 <br>  description Network C <br>  ip address 10.3.0.1 255.255.255.0 <br>  ip pim sparse-mode <br>  ! <br>  ip pim rp-address 10.0.0.2 IPTV override <br>  ! <br>  ip access-list standard IPTV <br>  permit 224.11.0.0 0.0.0.3 <br>  ! <br>  ip route 10.0.0.0 255.255.255.0 10.10.10.1 <br></td></tr></tbody></table><br>  The " <em>ip multicast-routing</em> " command includes the appropriate routing, but if it is turned off, the router does not forward multicast packets, i.e.  they will not reach the bewildered spectator cartoons. <br><br>  Let's stop a little more in detail on the command " <em>ip pim sparse-mode</em> ". <br><br><h3>  About the PIM protocol modes and the protocol itself. </h3><br>  <strong>PIM</strong> (Protocol Independent Multicast) is a multicast routing protocol.  It populates its multicast routing table based on the normal routing table.  These tables can be viewed using the ‚Äú <em>sh ip mroute</em> ‚Äù and ‚Äú <em>sh ip route</em> ‚Äù commands, respectively.  The goal of the PIM protocol is to build a route tree for sending multicast messages. <br><br><div style="text-align:center;"><img src="http://img257.imageshack.us/img257/9808/52073563.gif"></div><br>  The PIM protocol has two main modes: <strong>sparse mode</strong> and <strong>dense mode</strong> .  The multicast routing table for them looks a little different.  Sometimes these modes are considered as separate protocols - PIM-SM and PIM-DM. <br><br>  In our configuration on the interfaces, we specified the " <em>ip pim sparse-mode</em> " <em>mode</em> . <br><br><br><br>  (config-if) # ip pim? <br><br>  dense-mode Enable PIM dense-mode operation <br>  sparse-dense-mode enable PIM sparse-dense-mode operation <br>  sparse-mode Enable PIM sparse-mode operation <br>  ‚Ä¶‚Ä¶‚Ä¶ <br><br><h3>  What is the difference? </h3><br>  PIM-DM uses a flood and prune mechanism.  In other words.  The MR router sends all multicast streams registered to it.  If the client does not need any of these channels, then he refuses it.  If all clients hanging on the router refused the channel, the router sends ‚Äúthank you, don't need it‚Äù to the upstream router. <br><br>  PIM-SM does not initially broadcast TV channels registered on it.  Distribution will start only when a request comes from the client. <br><br>  Those.  in PIM-DM, MR sends to everyone, and then removes the unnecessary, and in PIM-SM, MR starts broadcasting only on request. <br><br>  If group members are scattered across multiple network segments, which is typical of IPTV, PIM-DM will use most of the bandwidth.  And this can lead to poor performance.  In this case, it is better to use PIM-SM. <br><br>  <em>There are more differences between PIM-DM and PIM-SM.</em> <br>  PIM-DM builds a tree separately for each source of a specific multicast group, i.e.  The multicast route will be characterized by the source address and the group address.  In the multicast routing table there will be records of the form (S, G), where S is the source, G is a group. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/759/903/e69/759903e69448f29f354a8ecc81eec697.gif"></div><br><br>  PIM-SM has some peculiarity.  This mode requires a rendezvous point ( <strong>RP - rendezvous point</strong> ) at which sources of multicast streams will be registered and create a route from source S (self) to group G: (S, G). <br><br>  Thus, the traffic goes from the source to the RP along the route (S, G), and then to the customers, according to the common for the sources of a specific group, the tree, which is characterized by the route (*, G) - ‚Äú*‚Äù symbolizes ‚Äúany source‚Äù.  Those.  the sources registered to the RP, and then the clients already receive the stream from the RP and for them it does not matter who the original source was.  The root of this common tree is RP. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d1/415/7b7/8d14157b746a367dd658428fb819b387.gif"></div><br><br>  The rendezvous point is one of the multicast routers, but all other routers should know ‚Äúwho is the RP point here‚Äù and be able to reach it. <br><br>  An example of a static definition of RP (MR1).  Announce to all multicast routers that the rendezvous point is 10.0.0.1 (MR1): <br><br><table><tbody><tr><td>  ip pim rp-address 10.0.0.1 IPTV override </td><td>  specify the address of the RP and the access-list IPTV access-list determines which groups </td></tr><tr><td>  ip access-list standard IPTV </td><td>  register at this rendezvous point </td></tr><tr><td>  permit 224.11.0.0 0.0.0.3 </td><td></td></tr></tbody></table><br><br>  All other routers should know the route to RP: <br>  ip route 10.0.0.0 255.255.255.0 10.10.10.1 <br><br>  There are also other ways to determine RP, this is auto-RP and bootstarp router, but this is a topic for a separate article ( <em>if anyone would be interested, please</em> )? <br><br><h3>  Let's see what will happen after setting up the routers. </h3><br>  We are still considering the scheme with the routers MR1 ‚Äã‚Äã(RP) and MR2.  As soon as we turn on the link between the routers MR1 ‚Äã‚Äãand MR2, then they should see messages in the logs <br><br>  <strong>For MR1:</strong> <br>  % PIM-5-NBRCHG: neighbor 10.10.10.2 UP on interface Ethernet3 <br><br>  <strong>For MR2:</strong> <br>  % PIM-5-NBRCHG: neighbor 10.10.10.1 UP on interface Ethernet0 <br><br>  This suggests that routers have established a PIM neighborhood relationship with each other.  You can also check this with the command: <br><br>  MR1 # <strong>sh ip pim neighbor</strong> <br><br>  PIM Neighbor Table <br>  Mode: B - Bidir Capable, DR - Designated Router, N - Default DR Priority, S - State Refresh Capable <br><br><table><tbody><tr><td>  Neighbor Address </td><td>  Interface </td><td>  Uptime / Expires </td><td>  Ver </td><td>  DR Prio / Mode </td></tr><tr><td>  10.10.10.2 </td><td>  Ethernet3 </td><td>  00: 03: 05/00: 01: 37 </td><td>  v2 </td><td>  1 / DR S </td></tr></tbody></table><br><br><h3>  Do not forget about the TTL. </h3><br>  As a test server, it was convenient for me to use the VLC player.  However, as it turned out later, even if you set up a sufficient TTL via the GUI, it still (I hope only in the version I used) persistently sent multicast packets with TTL = 1.  I had to run stubborn with the option "vlc.exe ‚Äìttl 3" because  we have two routers on our way, each of which reduces the TTL packet by one. <br><br>  How can I still find a problem with TTL?  One of the methods.  Let the server broadcast the channel 224.12.0.3 with TTL = 2, then the packets on the MR1 router pass normally, and the clients will not be able to watch their cartoon for the MR2 router. <br><br>  This is detected by the ‚Äúsh ip traffic‚Äù command on MR2.  We look at the ‚Äúbad hop count‚Äù field - this is the number of packets that ‚Äúdied‚Äù, as they measure, according to TTL = 0. <br><br>  MR2 # <strong>sh ip traffic</strong> <br><br>  IP statistics: <br>  Rcvd: 36788 total, 433 local destination <br>  0 format errors, 0 checksum errors, 2363 bad hop count <br>  ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ <br><br>  If this counter is increasing rapidly, then the problem is in TTL. <br><br><h3>  Show ip mroute </h3><br>  After switching on the broadcasting of three channels on the server in the multicast routing table, we observe the following: <br><br>  MR1 # <strong>sh ip mroute</strong> <br><br>  (*, 224.12.0.1), 00: 03: 51 / stopped, RP 10.0.0.1, flags: SP <br>  Incoming interface: Null, RPF nbr 0.0.0.0 <br>  Outgoing interface list: Null <br><br>  (10.0.0.2, 224.12.0.1), 00: 03: 52/00: 02: 50, flags: PT <br>  Incoming interface: Ethernet0, RPF nbr 0.0.0.0 <br>  Outgoing interface list: Null <br><br>  (*, 224.12.0.2), 00: 00: 45 / stopped, RP 10.0.0.1, flags: SP <br>  Incoming interface: Null, RPF nbr 0.0.0.0 <br>  Outgoing interface list: Null <br><br>  (10.0.0.2, 224.12.0.2), 00: 00: 45/00: 02: 50, flags: PT <br>  Incoming interface: Ethernet0, RPF nbr 0.0.0.0 <br>  Outgoing interface list: Null <br><br>  (*, 224.12.0.3), 00: 00: 09 / stopped, RP 10.0.0.1, flags: SP <br>  Incoming interface: Null, RPF nbr 0.0.0.0 <br>  Outgoing interface list: Null <br><br>  (10.0.0.2, 224.12.0.3), 00: 00: 09/00: 02: 59, flags: PT <br>  Incoming interface: Ethernet0, RPF nbr 0.0.0.0 <br>  Outgoing interface list: Null <br><br>  We see that routes of the form (S, G) have appeared, for example (10.0.0.2, 224.12.0.3), i.e.  registered source 10.0.0.2, which broadcasts to the group 224.12.0.3.  As well as routes from RP to the client: (*, G), for example (*, 224.12.0.3) - which they will use, the so-called common to all tree. <br><br>  As soon as the request for channel 1 arrives on the MR1 (RP) interface, the following changes occur in the multicast routing table: <br><br>  MR1 # <strong>sh ip mroute</strong> <br><br>  ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶ <br>  (*, 224.12.0.1), 00: 33: 16/00: 02: 54, RP 10.0.0.1, flags: S <br>  Incoming interface: Null, RPF nbr 0.0.0.0 <br>  Outgoing interface list: <br>  Ethernet3, Forward / Sparse, 00: 02: 37/00: 02: 53 <br><br>  (10.0.0.2, 224.12.0.1), 00: 33: 17/00: 03: 25, flags: T <br>  Incoming interface: Ethernet0, RPF nbr 0.0.0.0 <br>  Outgoing interface list: <br>  Ethernet3, Forward / Sparse, 00: 02: 37/00: 02: 53 <br><br>  It became clear that requests for this group come from the Ethernet3 port. <br><br><h3>  RPF check </h3><br>  It is possible that the router receives a multicast stream on two interfaces.  Which of these two interfaces will the router consider as the source? <br><br>  To do this, it performs an RPF (Reverse Path Forwarding) check ‚Äî checks the route to the source using the usual unicast routing table and selects the interface through which the route goes to this source.  This check is necessary in order to avoid looping. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab7/f35/fa9/ab7f35fa98730cd4acd96ac0653680cd.gif"></div><br><br>  You can track how the source passes the RPF check using the command: <br><br>  MR2 # <strong>sh ip rpf?</strong> <br>  Hostname or ABCD IP name or address of multicast source <br><br>  MR2 # <strong>sh ip rpf 10.0.0.2</strong> <br><br>  RPF information for?  (10.0.0.2) <br>  RPF interface: Ethernet0 <br>  RPF neighbor:?  (10.10.10.1) <br>  RPF route / mask: 10.0.0.0/24 <br>  RPF type: unicast (static) <br>  RPF recursion count: 0 <br>  Doing distance-preferred lookups across tables <br><br>  Well, that article appeared that I would love to find at the initial stage of studying multicast routing for IPTV.  I am not a magician, I just learn ... Therefore, I will be happy to hear all the wishes, comments and advice.  And also, I really hope that for someone it will be useful.  =) <br><br>  <strong>UPD:</strong> Allow me to submit it.  Elena Sakhno - <a href="http://habrahabr.ru/users/lena_sakhno/" class="user_link">lena_sakhno</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/61466/">https://habr.com/ru/post/61466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../61456/index.html">Microprocessor in each pool</a></li>
<li><a href="../61457/index.html">Women's flash drive with a clock</a></li>
<li><a href="../61459/index.html">IDE - USB + eSATA adapter</a></li>
<li><a href="../61462/index.html">Habrabank</a></li>
<li><a href="../61463/index.html">Digest authentication vs POST authentication</a></li>
<li><a href="../61468/index.html">I resent AT & T‚Äî kidalovo</a></li>
<li><a href="../61473/index.html">Logging changes to model objects</a></li>
<li><a href="../61474/index.html">‚ÄúIndicator-6‚Äù, lamp clock of the Cold War era</a></li>
<li><a href="../61476/index.html">Microsoft patented technology for organizing virtual conferences</a></li>
<li><a href="../61486/index.html">And again about the crisis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>