<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"... They want to know what will happen" or write a fortunetech ball in C # NanoCAD CAD software (MultiCAD .NET API)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you believe one old song from the Soviet movie , then people are always interested in the future in a difficult situation. Someone throws up a coin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"... They want to know what will happen" or write a fortunetech ball in C # NanoCAD CAD software (MultiCAD .NET API)</h1><div class="post__text post__text-html js-mediator-article">  If you believe one old <a href="https://www.youtube.com/watch%3Fv%3DQgGZwy-CLb0">song from the Soviet movie</a> , then people are always interested in the future in a difficult situation.  Someone throws up a coin, someone torments Paul octopus, and absolutely brutal-minded people pluck daisies.  We will do much more humanely and find for CAD NanoCAD a very unconventional application, namely, we will make our analogue of the fortunetelling ball (almost as in the picture below). <br><br>  In this article, we once again will practice creating NanoCAD user primitives using the MultiCAD.NET API, and also attach to the object our interaction with Windows.Forms. <br><br>  The code today will be only in C #, we will write it for the paid version (NC 8.5) and for the free version (NC 5.1), and of course Linux users will be able to build it in Mono and run it under Wine, so you are welcome to‚Ä¶ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/la/rn/9f/larn9fb4zv3qt1rtucdzvynzf0g.jpeg"><br><br><a name="habracut"></a><br><a name="I"></a><br>  If you have not encountered, with articles from this mini-cycle, you can look under the spoiler.  In previous articles, we looked at various issues ranging from what NanoCAD is to trying to run our projects under Linux. <br><br><div class="spoiler">  <b class="spoiler_title">Other articles of the cycle</b> <div class="spoiler_text"><ul><li>  <a href="https://habrahabr.ru/post/342186/">Scarless Face or First Steps in Multicad.NET API 7 (for Nanocad 8.1)</a> </li><li>  <a href="https://habrahabr.ru/post/342680/">‚ÄúLike a ram on a new gate‚Äù or custom ‚Äúpseudo-3D‚Äù objects in NanoCAD using the MultiCAD.NET API</a> </li><li>  <a href="https://habrahabr.ru/post/343772/">‚ÄúI am watching you‚Äù or how to make SCADA from CADa (MultiCAD.NET API)</a> </li><li>  <a href="https://habrahabr.ru/post/344884/">‚ÄúTruth in wine‚Äù or try programming NanoCAD under Linux (MultiCAD.NET API)</a> </li><li>  <a href="https://habrahabr.ru/post/345834/">"Hello Christmas - New Year!" Or program NanoCAD with Visual Basic .NET</a> </li></ul><br></div></div><br>  As always, let me remind you that I am not a programmer and therefore <b>not all my thoughts</b> in this article may be correct, and also that <b>I‚Äôm not engaged in any way</b> with the developers of NanoCAD.  Although I definitely consider it necessary to <b>thank the</b> entire community of NanoCAD users and developers for their help on the forum. <br><br>  Do not be surprised that we will again use CAD to create objects that are not related to design.  Simply, I had to practice ‚Äúinsert‚Äù Windows.Forms into user objects of NanoCAD, and since the training materials on the API for Nanocad - ‚Äúthe cat wept‚Äù, I decided to share with you my simple and illustrative example. <br><br>  The article will be short and could be dispensed with, but I will leave it for ease of navigation just in case. <br><br>  Content: <br>  <a href="https://habr.com/ru/post/347720/">Part I: Introduction</a> <br>  <a href="https://habr.com/ru/post/347720/">Part II: we write code on C #</a> <br>  <a href="https://habr.com/ru/post/347720/">Part III: Conclusion</a> <br><br>  I must say that in spite of the fact that there are less teaching materials than we would like, we will rely on what to write when writing code. <br><br>  In particular, about the creation of a user primitive, the developers have already written <a href="https://habrahabr.ru/company/nanosoft/blog/184482/">in their blog on Habr√©</a> , well, and the issue with intelligent pens, they <a href="https://habrahabr.ru/company/nanosoft/blog/234181/">also previously understood</a> .  In principle, today we will not go far beyond these two articles. <br><br>  Usually at the beginning of the article I am writing how to create a project for NanoCAD from scratch, but this time, because of the presence of a class with a window form, I decided to post the entire project on <a href="https://github.com/bosonbeard/Funny-models-and-scripts/tree/master/2.ForNanoCAD/2.Some_simple_scripts/4.Fortuneteller">GitHub</a> , so you can simply download it, connect the libraries and immediately start experimenting. <br><br>  But if the development for you under the Nanocad is new, look at this piece of the previous article ( <a href="https://habrahabr.ru/post/342680/">for NC 8.5</a> and <a href="https://habrahabr.ru/post/342680/">for NC 5.1</a> ). <br><br>  I decided, just in case, not to "offend" the developers of NanoCAD and did not attach the necessary libraries from the SDK package to the project.  These libraries can be found either in the ‚Äúbin‚Äù folder of the installed program, or by receiving the SDK.  For NC 8.5 and other versions, you must register <a href="http://developer.nanocad.ru/">with the developer club</a> .  Just in case, I remind you that download any available version of NC for development purposes, club members can be completely free.  Well, for free NC 5.1 - the SDK seems to come bundled with the program (if nothing has changed). <br><a name="II"></a><br>  So, let's begin to parse the code, I will not attach the automatically generated code of the form, and I will confine myself only to the class of the user primitive (the ball itself) and the logic of the form. <br><br>  To begin, hide the full code for the paid version of NanoCAD under the spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Full code for NC 8.5 C #</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Version 1.0 //Use Microsoft .NET Framework 4 and MultiCad.NET API 7.0 //Class for demonstrating the capabilities of MultiCad.NET //Assembly for the Nanocad 8.5 SDK is recommended (however, it is may be possible in the all 8. family) //Link imapimgd, mapimgd.dll and mapibasetypes.dll from SDK //Link System.Windows.Forms and System.Drawing //The commands: draws a fortune-teller ball //This code in the part of non-infringing rights Nanosoft can be used and distributed in any accessible ways. //For the consequences of the code application, the developer is not responsible. //More detailed - https://habrahabr.ru/post/347720/ using System; using System.Collections.Generic; using System.Windows.Forms; using System.Drawing; using Multicad.Runtime; using Multicad.DatabaseServices; using Multicad.Geometry; using Multicad.CustomObjectBase; using Multicad; using Multicad.AplicationServices; namespace Fortuneteller { [CustomEntity(typeof(Ball), "2e814ea6-f1f0-469d-9767-269fedb32226", "Ball", "Fortuneteller Ball for NC85 Entity")] [Serializable] public class Ball : McCustomBase { private Point3d _basePnt = new Point3d(0, 0, 0); double _radius=300; string _predText = "..."; public List&lt;String&gt; predictions = new List&lt;String&gt;() {"Act now!", "Do not do this!", "Maybe", "I dont know", "Everything is unclear", "Yes!", "No!", "Take rest" }; public override void OnDraw(GeometryBuilder dc) { dc.Clear(); dc.Color = McDbEntity.ByObject; dc.DrawCircle(_basePnt, _radius); dc.DrawCircle(_basePnt, _radius/2.0); dc.TextHeight = 31; dc.DrawMText(_basePnt, Vector3d.XAxis, _predText, HorizTextAlign.Center, VertTextAlign.Center, _radius / 2.05); } public override void OnTransform(Matrix3d tfm) { // To be able to cancel(Undo) McUndoPoint undo = new McUndoPoint(); undo.Start(); // Get the coordinates of the base point and the rotation vector this.TryModify(); this._basePnt = this._basePnt.TransformBy(tfm); undo.Stop(); } public override hresult OnEdit(Point3d pnt, EditFlags lInsertType) { CallForm(); return hresult.s_Ok; } private void CallForm() { ListEditorForm frm = new ListEditorForm(this); frm.Lpredictions.Items.AddRange(predictions.ToArray()); frm.ShowDialog(); } [CommandMethod("DFTBall", CommandFlags.NoCheck | CommandFlags.NoPrefix)] public void DrawBall () { Ball ball = new Ball(); ball.PlaceObject(); McContext.ShowNotification("Use green grip or shake (move) ball to get prediction"); } public override bool GetGripPoints(GripPointsInfo info) { //frist grip to move info.AppendGrip(new McSmartGrip&lt;Ball&gt;(_basePnt+new Vector3d(0, _radius,0), (obj, g, offset) =&gt; { obj.TryModify(); obj._basePnt += offset; obj.TryModify(); obj.ShakePredict(); })); //command grip var ctxGrip = new McSmartGrip&lt;Ball&gt;(McBaseGrip.GripType.PopupMenu, 2, _basePnt - 1.0 * new Vector3d(_radius, 0, 0), McBaseGrip.GripAppearance.PopupMenu, 0, "Select menu", Color.Lime); ctxGrip.GetContextMenu = (obj, items) =&gt; { items.Add(new ContextMenuItem("Get prediction", "none", 1)); items.Add(new ContextMenuItem("Edit predictions", "none", 2)); }; ctxGrip.OnCommand = (obj, commandId, grip) =&gt; { if (grip.Id == 2) { switch (commandId) { case 1: { ShakePredict(); break; } case 2: { CallForm(); break; } } } }; info.AppendGrip(ctxGrip); return true; } public override hresult PlaceObject(PlaceFlags lInsertType) { InputJig jig = new InputJig(); // Get the first box point from the jig InputResult res = jig.GetPoint("Select center point:"); if (res.Result != InputResult.ResultCode.Normal) return hresult.e_Fail; _basePnt = res.Point; // Add the object to the database DbEntity.AddToCurrentDocument(); return hresult.s_Ok; } private void ShakePredict() { Random rand = new Random(); int val = rand.Next(0, predictions.Count); this.TryModify(); _predText = predictions[val]; } } }</span></span></code> </pre> <br></div></div><br>  Now we will sort the key moments in parts. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Drawing; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Multicad.Runtime; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Multicad.DatabaseServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Multicad.Geometry; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Multicad.CustomObjectBase; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Multicad; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Multicad.AplicationServices; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Fortuneteller</span></span> { [CustomEntity(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Ball), <span class="hljs-string"><span class="hljs-string">"2e814ea6-f1f0-469d-9767-269fedb32226"</span></span>, <span class="hljs-string"><span class="hljs-string">"Ball"</span></span>, <span class="hljs-string"><span class="hljs-string">"Fortuneteller Ball for NC85 Entity"</span></span>)] [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Ball</span></span> : <span class="hljs-title"><span class="hljs-title">McCustomBase</span></span> {</code> </pre><br>  We connect namespaces, create a custom object class, assign some randomly generated GUID to it, inherit our class from McCustomBase. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Point3d _basePnt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point3d(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> _radius=<span class="hljs-number"><span class="hljs-number">300</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _predText = <span class="hljs-string"><span class="hljs-string">"..."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;String&gt; predictions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;String&gt;() {<span class="hljs-string"><span class="hljs-string">"Act now!"</span></span>, <span class="hljs-string"><span class="hljs-string">"Do not do this!"</span></span>, <span class="hljs-string"><span class="hljs-string">"Maybe"</span></span>, <span class="hljs-string"><span class="hljs-string">"I dont know"</span></span>, <span class="hljs-string"><span class="hljs-string">"Everything is unclear"</span></span>, <span class="hljs-string"><span class="hljs-string">"Yes!"</span></span>, <span class="hljs-string"><span class="hljs-string">"No!"</span></span>, <span class="hljs-string"><span class="hljs-string">"Take rest"</span></span> };</code> </pre><br>  We set the main variables for our fortuneteller: the point of the geometry center, the radius, the text in the prediction window and the list of prediction variants. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GeometryBuilder dc</span></span></span><span class="hljs-function">)</span></span> { dc.Clear(); dc.Color = McDbEntity.ByObject; dc.DrawCircle(_basePnt, _radius); dc.DrawCircle(_basePnt, _radius/<span class="hljs-number"><span class="hljs-number">2.0</span></span>); dc.TextHeight = <span class="hljs-number"><span class="hljs-number">31</span></span>; dc.DrawMText(_basePnt, Vector3d.XAxis, _predText, HorizTextAlign.Center, VertTextAlign.Center, _radius / <span class="hljs-number"><span class="hljs-number">2.05</span></span>); }</code> </pre><br>  The method is responsible for drawing the object.  Draw two circles and a multiline text object. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnTransform</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Matrix3d tfm</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// To be able to cancel(Undo) McUndoPoint undo = new McUndoPoint(); undo.Start(); // Get the coordinates of the base point and the rotation vector this.TryModify(); this._basePnt = this._basePnt.TransformBy(tfm); undo.Stop(); }</span></span></code> </pre><br>  The method is called when the object changes, I do not understand 100% how it works, but it will be needed in order to correctly move the object. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> hresult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnEdit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Point3d pnt, EditFlags lInsertType</span></span></span><span class="hljs-function">)</span></span> { CallForm(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hresult.s_Ok; }</code> </pre><br>  The method will call our form (see the picture at the end of the article) at the moment when we double-click the ball. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ListEditorForm frm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ListEditorForm(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); frm.Lpredictions.Items.AddRange(predictions.ToArray()); frm.ShowDialog(); }</code> </pre><br>  Directly form call.  We need the form in order to add or remove versions of the predictions that fall in the ball. <br><br>  We created the ListEditorForm form class in advance and now, if necessary, create an object, passing it a link to our ball (needed for feedback), before calling the form, fill it with a ListBox with the current list of predictions. <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">CommandMethod(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DFTBall"</span></span></span><span class="hljs-meta">, CommandFlags.NoCheck | CommandFlags.NoPrefix)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DrawBall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Ball ball = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ball(); ball.PlaceObject(); McContext.ShowNotification(<span class="hljs-string"><span class="hljs-string">"Use green grip or shake (move) ball to get prediction"</span></span>); }</code> </pre><br>  The team with the help of which we will create our fortune-telling ball. <br>  In the simplest case, you will need to enter DFTBall in the NanoCAD console and it will call our DrawBall method (do not forget to load the library with the Netload command if necessary). <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetGripPoints</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GripPointsInfo info</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//first grip to move info.AppendGrip(new McSmartGrip&lt;Ball&gt;(_basePnt+new Vector3d(0, _radius,0), (obj, g, offset) =&gt; { obj.TryModify(); obj._basePnt += offset; obj.TryModify(); obj.ShakePredict(); })); //command grip var ctxGrip = new McSmartGrip&lt;Ball&gt;(McBaseGrip.GripType.PopupMenu, 2, _basePnt - 1.0 * new Vector3d(_radius, 0, 0), McBaseGrip.GripAppearance.PopupMenu, 0, "Select menu", Color.Lime); ctxGrip.GetContextMenu = (obj, items) =&gt; { items.Add(new ContextMenuItem("Get prediction", "none", 1)); items.Add(new ContextMenuItem("Edit predictions", "none", 2)); }; ctxGrip.OnCommand = (obj, commandId, grip) =&gt; { if (grip.Id == 2) { switch (commandId) { case 1: { ShakePredict(); break; } case 2: { CallForm(); break; } } } }; info.AppendGrip(ctxGrip); return true; }</span></span></code> </pre><br>  Here we set the handles of the object - blue and green. <br><br>  The first - the blue handle is needed to move the object.  Dragging the ball by the blue handle you can shake it and you will see how the line of predictions changes. <br><br>  The second one is a green handle (// command grip section), we need to display a window with two commands.  The first generates a new prediction, the second is the editor of the list of predictions. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> hresult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlaceObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PlaceFlags lInsertType</span></span></span><span class="hljs-function">)</span></span> { InputJig jig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputJig(); <span class="hljs-comment"><span class="hljs-comment">// Get the first box point from the jig InputResult res = jig.GetPoint("Select center point:"); if (res.Result != InputResult.ResultCode.Normal) return hresult.e_Fail; _basePnt = res.Point; // Add the object to the database DbEntity.AddToCurrentDocument(); return hresult.s_Ok; }</span></span></code> </pre><br>  This code is called to place an object in the model space.  First, we create an InputJig object, request the insertion point through it, change the coordinates of our point of the geometric center of the ball, and add an object to the document. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShakePredict</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Random rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> val = rand.Next(<span class="hljs-number"><span class="hljs-number">0</span></span>, predictions.Count); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.TryModify(); _predText = predictions[val]; }</code> </pre><br>  Well, here, using the simplest random number generator, we return some prediction from the general list. <br><br>  We will not analyze in detail the logic of the form, I will hide the full code under the spoiler <br><br><div class="spoiler">  <b class="spoiler_title">class code ListEditorForm</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.ComponentModel; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Data; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Drawing; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Fortuneteller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ListEditorForm</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Ball ball; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ListEditorForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ListEditorForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Ball ball</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ball = ball; InitializeComponent(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listView1_SelectedIndexChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DelBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Lpredictions.SelectedItem !=<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Lpredictions.Items.Remove(Lpredictions.SelectedItem); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AdBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (textBox.Text!=<span class="hljs-string"><span class="hljs-string">""</span></span> | textBox.Text != <span class="hljs-string"><span class="hljs-string">" "</span></span>) { Lpredictions.Items.Add(textBox.Text); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaceBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { ball.predictions = Lpredictions.Items.OfType&lt;String&gt;().ToList(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Close(); } } }</code> </pre><br></div></div><br>  Perhaps the only thing that is somehow connected with NanoCAD is the event handler of the ‚Äúsave and close‚Äù button event. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaceBtn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { ball.predictions = Lpredictions.Items.OfType&lt;String&gt;().ToList(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Close(); }</code> </pre><br>  Remember we previously passed the form link to our ball?  Now, turning to it we write all the values ‚Äã‚Äãof our ListBox to the list of predictions and close the form, after that the ball will start issuing updated predictions.  If the form is closed by clicking on the "cross", the result will not be saved. <br><br>  The code for the old - free Nanocad, will not be very different. <br><br><div class="spoiler">  <b class="spoiler_title">code for NanoCAD 5.1</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Version 1.0 //Use Microsoft .NET Framework 3.5 and MultiCad.NET API //Class for demonstrating the capabilities of MultiCad.NET //Assembly for the Nanocad 5.1 SDK is recommended //Link mapimgd.dll and hostmgd.dll from SDK //Link System.Windows.Forms and System.Drawing //The commands: draws a fortune-teller ball //This code in the part of non-infringing rights Nanosoft can be used and distributed in any accessible ways. //For the consequences of the code application, the developer is not responsible. //More detailed - https://habrahabr.ru/post/347720/ using System; using System.Collections.Generic; using System.Windows.Forms; using System.Drawing; using Multicad.Runtime; using Multicad.DatabaseServices; using Multicad.Geometry; using Multicad.CustomObjectBase; using Multicad; using HostMgd.ApplicationServices; using HostMgd.EditorInput; namespace Fortuneteller { [CustomEntity(typeof(Ball), "2e814ea6-f1f0-469d-9767-269fedb32195", "Ball", "Fortuneteller Ball for NC51 Entity")] [Serializable] public class Ball : McCustomBase { private Point3d _basePnt = new Point3d(0, 0, 0); double _radius=300; string _predText = "..."; public List&lt;String&gt; predictions = new List&lt;String&gt;() {"Act now!", "Do not do this!", "Maybe", "I dont know", "Everything is unclear", "Yes!", "No!", "Take rest" }; public override void OnDraw(GeometryBuilder dc) { dc.Clear(); dc.Color = McDbEntity.ByObject; dc.DrawCircle(_basePnt, _radius); dc.DrawCircle(_basePnt, _radius/2.0); dc.TextHeight = 31; dc.DrawMText(_basePnt, Vector3d.XAxis, _predText, HorizTextAlign.Center, VertTextAlign.Center, _radius / 2.05); } public override void OnTransform(Matrix3d tfm) { // To be able to cancel(Undo) McUndoPoint undo = new McUndoPoint(); undo.Start(); // Get the coordinates of the base point and the rotation vector this.TryModify(); this._basePnt = this._basePnt.TransformBy(tfm); undo.Stop(); } public override hresult OnEdit(Point3d pnt, EditFlags lInsertType) { CallForm(); return hresult.s_Ok; } private void CallForm() { ListEditorForm frm = new ListEditorForm(this); frm.Lpredictions.Items.AddRange(predictions.ToArray()); frm.ShowDialog(); } [CommandMethod("DFTBall", CommandFlags.NoCheck | CommandFlags.NoPrefix)] public void DrawBall() { Ball ball = new Ball(); ball.PlaceObject(); DocumentCollection dm = HostMgd.ApplicationServices.Application.DocumentManager; Editor ed = dm.MdiActiveDocument.Editor; ed.WriteMessage("Use green grip or shake (move) ball to get prediction"); } public override bool GetGripPoints(GripPointsInfo info) { //frist grip to move info.AppendGrip(new McSmartGrip&lt;Ball&gt;(_basePnt+new Vector3d(0, _radius,0), (obj, g, offset) =&gt; { obj.TryModify(); obj._basePnt += offset; obj.TryModify(); obj.ShakePredict(); })); //command grip var ctxGrip = new McSmartGrip&lt;Ball&gt;(McBaseGrip.GripType.PopupMenu, 2, _basePnt - 1.0 * new Vector3d(_radius, 0, 0), McBaseGrip.GripAppearance.PopupMenu, 0, "Select menu", Color.Lime); ctxGrip.GetContextMenu = (obj, items) =&gt; { items.Add(new ContextMenuItem("Get prediction", "none", 1)); items.Add(new ContextMenuItem("Edit predictions", "none", 2)); }; ctxGrip.OnCommand = (obj, commandId, grip) =&gt; { if (grip.Id == 2) { switch (commandId) { case 1: { ShakePredict(); break; } case 2: { CallForm(); break; } } } }; info.AppendGrip(ctxGrip); return true; } public override hresult PlaceObject(PlaceFlags lInsertType) { InputJig jig = new InputJig(); // Get the first box point from the jig InputResult res = jig.GetPoint("Select center point:"); if (res.Result != InputResult.ResultCode.Normal) return hresult.e_Fail; _basePnt = res.Point; // Add the object to the database DbEntity.AddToCurrentDocument(); return hresult.s_Ok; } private void ShakePredict() { Random rand = new Random(); int val = rand.Next(0, predictions.Count); this.TryModify(); _predText = predictions[val]; } } }</span></span></code> </pre><br></div></div><br>  The whole difference is only in the following: due to the fact that <i>McContext.ShowNotification (‚ÄúUse green grip or shake (move) ball to get prediction‚Äù)</i> is not yet implemented in the old version of the MultiCAD.NET API, we replaced it with an analog from simple .NET API. <br><br><pre> <code class="cs hljs"> DocumentCollection dm = HostMgd.ApplicationServices.Application.DocumentManager; Editor ed = dm.MdiActiveDocument.Editor; ed.WriteMessage(<span class="hljs-string"><span class="hljs-string">"Use green grip or shake (move) ball to get prediction"</span></span>);</code> </pre><br><a name="III"></a><br>  So, in the end, we got a ball that can predict if it is dragged by the blue pen or at the command hidden in the green pen. <br><br>  We also examined the simplest example of the interaction of a graphic form and an object by implementing the editing of a variable containing a list of predictions.  Let me remind you that the form is invoked by double clicking on the object or through the green handle. <br>  That's what got in the end <br><br>  Nanocad 8.5 <br><br><img src="https://habrastorage.org/webt/a-/zr/2e/a-zr2e771ivwivoqgzorxcf1cb4.png"><br><br>  Nanocad 5.1 Free <br><br><img src="https://habrastorage.org/webt/2q/r5/ug/2qr5ugoautqcm9eyrg9mvcezj3o.png"><br><br>  It is clear that this example is comic and has no practical use, but I hope that it will still be useful to someone. <br><br>  Have a great day everyone! <br><br>  <i>PS Just in case, I‚Äôll warn you that the latest Windows 10 update breaks the x64 version of NanoCAD 8 a bit, so all the code was tested in x86 versions.</i> </div><p>Source: <a href="https://habr.com/ru/post/347720/">https://habr.com/ru/post/347720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347708/index.html">Facebook or Telegram? History of the Ukrainian .NET Core Community</a></li>
<li><a href="../347710/index.html">Design basic graphics R</a></li>
<li><a href="../347712/index.html">A little about cheating counters site visits</a></li>
<li><a href="../347716/index.html">Experience algorithmic composition in the language of ChucK</a></li>
<li><a href="../347718/index.html">Making a log system for Minecraft</a></li>
<li><a href="../347722/index.html">PHP Digest number 124 (January 14 - 28, 2018)</a></li>
<li><a href="../347726/index.html">What is Tokio and Async I / O and why is it needed?</a></li>
<li><a href="../347728/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ299 (January 22 - 28, 2018)</a></li>
<li><a href="../347730/index.html">Elm Developer Tools</a></li>
<li><a href="../347734/index.html">Automatic monitoring of newly installed software in ZABBIX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>