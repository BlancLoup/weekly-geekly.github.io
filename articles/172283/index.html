<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ejabberd Crutches protection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue. I did not dare to write this article for a long time. Because even without being a programmer, I understand that the above code can be simpl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ejabberd Crutches protection</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/eb0/9c6/d98/eb09c6d98676312c865a0f733fe4048a.jpg" alt="image"><br>  <b>Prologue.</b>  I did not dare to write this article for a long time.  Because even without being a programmer, I understand that the above code can be simpler and more elegant.  But I hope that the article will help those who are faced with the same dilemma, and maybe encourage someone to write a more decent script.  So, in one city, in some company a jabber server appeared ... <br><a name="habracut"></a><br>  The service turned out to be necessary and in demand, but the trouble is, many users work remotely and not everyone has a VPN.  Of course, opening ports out is not a problem, but since jabber is tied to the mail LDAP, the issue of protection takes on a critical degree.  Having elapsed the ejabberd config and seeing that there is no protection provided, I thought: ‚ÄúOh, what a nonsense.  Now we set up fail2ban. ‚ÄùAnd broke off.  Neither about ejabberd, nor about openfire, nor about any other xmpp, fail2ban was not up to date.  ‚ÄúGarbage question!‚Äù - I thought again.  "Now we set up."  And it is useful to watch the ejabberd log.  And then the complexity of the problem stood before me in full growth.  The impression was that the service log was specially created so that fail2ban could not be configured for it.  Roughly speaking, the message about a failed password entry consists of four lines: <br>  1. = Date, time ==== <br>  2. Connection message from ip address <br>  3. = Date, time ==== <br>  4. Error message. <br>  Moreover, comma O_o is used as a separator in the ip address. <br>  And fail2ban analyzes logs on one line.  And in the line there should be at least two values ‚Äã‚Äã- the attacker's ip address and time.  Googling for the ‚Äúejabberd protection‚Äù query has given up bits of useful information.  There are two modules that can help in this situation <a href="http://www.ejabberd.im/mod_greylist">here</a> and <a href="http://www.ejabberd.im/node/2999">here.</a> But!  I have not mastered ejabberd enough to be able to install them.  The first requires the installation of patches.  And the second is installed, but does not write anything to the log.  Apparently also need a patch.  In the end, "niasilil", forgive my French and sad. <br><br>  However, if the mountain does not go to Mohammed, then the mountain to Mohammed is carried.  Let's write a script that reads the jabber log and creates a sample with erroneous values.  What I think about my creation, I wrote at the very beginning.  And the code looks like this. <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cp /dev/null /var/log/ejabberd/tofail.log #  ,       log="/var/log/ejabberd/ejabberd.log" #  ejabberd itog="/var/log/ejabberd/tofail.log" #  ejabberd shab='I(.*) : (.*) Failed authentication for \w*@\w*.\w*.\w*' i="0" cat $log | while read line do dan[$i]="$line" if [[ ${dan[$i]} =~ $shab ]]; then #   ... i=`expr $i - 4` vrem="${dan[$i]}" # ...  i=`expr $i + 1` con="${dan[$i]}" # ... i=`expr $i + 3` fai="${dan[$i]}" # ... echo "$vrem $con $fai" &gt;&gt;$itog #    fi i=`expr $i + 1` done sed -i 's/,/./g' "$itog" #    </span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What the script does.  Looks at ejabberd.log, when finding a line with a message about entering the wrong password, enters the previous two lines with time and ip address of the connection in variables.  After that, all three values ‚Äã‚Äãare written to the log. <br><br>  After that you need to prepare fail2ban  In /etc/fail2ban/filter.d/, create an ejabberd.conf file with the following contents: <br><br><pre> <code class="xml hljs"># Fail2Ban configuration file [Definition] failregex = Accepted connection \{\{<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">HOST</span></span></span><span class="hljs-tag">&gt;</span></span>\} ignoreregex =</code> </pre><br><br>  You can check that the filter is working with the command fail2ban-regex /var/log/ejabberd/tofail.log /etc/fail2ban/filter.d/ejabberd.conf <br><br>  In jail.cfg write <br><br><pre> <code class="xml hljs">[ejabberd] enabled = true port = 5222 filter = ejabberd action = iptables-allports[name=EJABBERD, protocol=all] logpath = /var/log/ejabberd/tofail.log maxretry = 3</code> </pre><br><br>  Further.  This creation is thoughtful and works for a long time.  In order not to load the system once again, we will run the script only when the size of the ejabberd log changes.  Therefore, we hang in the crontab, say the files filesize.sh with the following contents: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash logf="/var/log/ejabberd/ejabberd.log" filesize="/etc/ejabberd/size.txt" live=`stat -c%s $logf` cat $filesize |while read line do if [ $live -ne $line ] then /etc/ejabberd/expres.sh fi done echo `stat -c%s $logf` &gt;$filesize</span></span></code> </pre><br><br>  I run once a minute.  The frequency of updates you have, choose for yourself. <br><br>  Here actually with such crutches, jabber was released outside.  There are unsuccessful trainers, but for now, the employees themselves are mistaken when entering the password.  In the near future, it will be necessary to test how much this whole system will cope with jBrute and jbbl.  Any comments about the optimization of the code I will accept with great gratitude and post it after verification. </div><p>Source: <a href="https://habr.com/ru/post/172283/">https://habr.com/ru/post/172283/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../172269/index.html">Letters in html-format with attached images</a></li>
<li><a href="../172271/index.html">ExtJS4: practical impressions</a></li>
<li><a href="../172273/index.html">Intel offers to consider the display service</a></li>
<li><a href="../172279/index.html">Non-obvious ways to protect against malware</a></li>
<li><a href="../172281/index.html">Philips opens development program for Hue bulbs</a></li>
<li><a href="../172285/index.html">Implementing long-term arithmetic in C ++</a></li>
<li><a href="../172289/index.html">Large-scale update of the mobile version of 2GIS</a></li>
<li><a href="../172293/index.html">Technology to combat MiniDuke. Simple protection against complex threats?</a></li>
<li><a href="../172295/index.html">Mysterious FrontCache</a></li>
<li><a href="../172299/index.html">Record and modify sound in the browser</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>