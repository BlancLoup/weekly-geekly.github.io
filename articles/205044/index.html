<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Directional attack research</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We recently analyzed four malicious tools that were used in targeted attacks on users in Taiwan and Vietnam. Using our telemetry system, we recorded t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Directional attack research</h1><div class="post__text post__text-html js-mediator-article">  We recently analyzed four malicious tools that were used in targeted attacks on users in Taiwan and Vietnam.  Using our telemetry system, we recorded that this malware was delivered to users through phishing email campaigns.  One of the malware files was delivered to the user‚Äôs system via a Vietnamese government agency‚Äôs webmail interface.  The attackers used special phishing email messages that contained persuasive text, as well as special fake documents to lure the user and increase the effect of the attack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a2/258/4fc/3a22584fcff525e749aae2a089010d88.jpg"><br><br>  According to the results of this study, we were able to establish the following facts: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The same component of the malicious code was used several times in these campaigns. </li><li>  Attacks required manual intervention by an attacker (operator). </li><li>  In the attacks found traces of the famous group <a href="http://habrahabr.ru/company/eset/blog/170285/">APT1</a> (aka Comment crew). </li><li>  For the initial attack vector, i.e., to install malicious code, phishing messages were used that allegedly contained important documents. </li><li>  Bad preparation of intruders: typos in the configuration, naive implementation of cryptographic algorithms, insufficient practice in writing code. </li><li>  Malicious programs with clearly defined behavior: one of the threats does not retain its presence after a reboot, and the other does not do any malicious functions until the reboot. </li></ul><br><br><a name="habracut"></a><img src="https://habrastorage.org/getpro/habr/post_images/fa8/944/45d/fa894445de8c1d684845dbd87f865fb8.png"><br>  Fig.  Analyzed threats. <br><br>  The figure above shows that the initial dropper installs two other threats to the system, called <b>Agent.NJK</b> and <b>Terminator RAT</b> . <br><br>  Further, knowing the characteristics of this dropper, it was not difficult for us to find in our collection other fragments of the malicious code associated with it.  The table below shows their characteristics.  It can be seen that the attackers specifically chose to disguise their Office files. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/321/fcd/4da/321fcd4da7e9d731e6d76b561128d2fb.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c40/3b7/52b/c403b752b5453dde2343d85766ae2a4e.png"><br>  Fig.  Disguise files disguised as MS Word documents. <br><br>  During the launch process, these droppers will decrypt their configuration parameters using a simple XOR with a single-byte key.  The pseudocode of this algorithm in python is presented below.  Configuration data is stored at the end of the last section of the executable file and occupies 32 bytes.  A checksum is stored inside this data, some offsets to important parts of the file, as well as their lengths;  All this is organized into a structure whose format is presented below.  The checksum field from the structure is used for comparison with the value that is hard-wired in the dropper code.  Thus, the malicious code checks the integrity of the decrypted data. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/771/b84/58f/771b8458f213a5264cbf84f0e2214ab7.png"><br>  Fig.  Pseudocode encryption algorithm and format of service structure. <br><br>  The first thing the dropper does is extract two files from itself, one of them represents the executable file and the other is a fake Word document that will be shown to the user.  Both files are placed in the user's temporary folder, each of them is decrypted using a simple XOR, which was given above.  After extracting files, the dropper runs the executable file, first copying its body to another directory, and then executing it from there with additional command line parameters.  The parameters are the full path to the file of the original dropper and the path to the Word document. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce8/aa1/8cf/ce8aa18cf0642e923e1a9e681130bd13.png"><br><br>  Launched from a new directory, dropper waits for the completion of its parent's process, then deletes its file, and also moves the file of the phishing document to a directory with temporary files.  In the last stage, it calls the <i>ShellExecuteW</i> function to open this office document.  The document opens with the appropriate program, which is specified in the registry to open .doc files.  This function is performed in order to simulate a call to the operation that the user expects, which launched the dropper file disguised as a document. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d6a/b25/f97/d6ab25f97e49803659c49f3646dbe198.png"><br>  Fig.  Dropper operations. <br><br>  Such, at first glance, a simple approach to deceive users is quite effective.  All processes performed by the dropper occur seamlessly for the user, after which the requested document is opened for him.  If the malicious program performs its initial actions with minimal delay, the user may not notice anything at all.  A similar tactic of compromising users was used by the APT1 group, <a href="http://intelreport.mandiant.com/Mandiant_APT1_Report.pdf">reported by</a> Mandiant.  Notice, in this case, attackers do not need to resort to the services of exploits to install malicious code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/226/63a/de5/22663ade56483569d8b246e5ff34e34a.png"><br>  Fig.  Phishing document in Vietnamese language. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d60/45c/63e/d6045c63ef4e43483ea2c1a214c9fed6.png"><br>  Fig.  A similar document for users living in Taiwan. <br><br>  Dropper uses two different methods to hide API function calls: contains its own implementation of <i>GetProcAddress</i> with open strings of function names in the code, and also uses the standard implementation of a function with encrypted names.  When analyzing the code, it is clear that it is not written in a high-level language: some objects are used with maximum access rights, copy-paste different parts of the code in its body. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/efb/fbe/067/efbfbe06755471cf4aef22ae57ecf499.png"><br>  Fig.  Metadata Vietnamese and Taiwanese documents. <br><br>  <b>Win32 / TrojanProxy.Agent.NJK</b> <br><br>  The first executable file that we analyzed is detected by our products as <b>Win32 / TrojanProxy.Agent.NJK</b> .  This malware is written in Visual C ++ and is able to interact with remote C &amp; C servers via the HTTP protocol.  In the analyzed modification, the use of three addresses of management servers was discovered, which use the same domain address vietnam.vnptnet.info, but with connection to different ports (80, 443 and 5050). <br><br>  Work with C &amp; C is organized through a cycle with a 15-minute delay, during which the malicious code tries to contact the server using the three ports mentioned above.  Interestingly, the threat does not take any action to ensure its survival after a reboot, that is, on a compromised computer, it will be active only until the end of the work or reboot.  The malicious file itself does not contain any obfuscation of the strings it uses. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/029/5ec/e91/0295ece917c5916c29b0046046c71ad3.png"><br>  Fig.  The main cycle of the malicious code. <br><br>  When interacting with the managing server, the malicious code sends some information about the system via the GET HTTP protocol request, using a special string for the User-Agent field.  User data is 105 bytes and will be sent as a hex-sequence in the GET component of the query string method.  This data contains the following information: ID of the malicious campaign;  internal IP address of the host;  computer name;  Windows Version ID;  The name of the account under which the malicious code process runs.  Strange is the fact that encryption is not applied to the transmitted data, they are transmitted in open form. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cec/4fc/eca/cec4fcecaf788bf7c8a8dbff6d4aff87.png"><br>  Fig.  The format of the data sent by the malicious code to the remote server. <br><br>  The transmitted data along with the query looks like this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ee/617/36c/3ee61736c61ddc203994ba2c969ab84b.png"><br>  Fig.  An example of a GET request with transmitted data. <br><br>  The server will respond to this request with a regular header, except for the Accept field added to it with the value ‚Äúx-wav / y-img‚Äù.  The malicious program will not accept a response from the server if the response header does not contain this field.  Note that the Accept field is usually used in the request headers from the client in regular HTTP requests, but in this case, the opposite is true; the server should respond with a header that contains this field.  We noticed that the commands sent by C &amp; C are always 796 bytes in size, with the first integer value in the command data being its identifier (command ID).  The following commands are supported by malicious code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/83a/3ae/320/83a3ae320abdfc74338a260fe14c66fd.png"><br><br>  In the Agent.NJK code, there is a funny line ‚ÄúI want to go to THE GREAT WALL, inner Mongolia very much‚Äù and credentials for accessing the proxy service somnuek.bu/044253516. At the same time, by analyzing the malicious code, it is clear that these credentials are not used anywhere.  A Google search provided us with some information that leads to a person with that name on a <a href="https://plus.google.com/116903574076359303579/posts">social network</a> .  We have no data on how it relates to this campaign. <br><br>  It should be noted that the CPT-NMC string, which identifies the campaign itself (campaign identifier), is sent to the remote server in the future again.  CPT stands for Central Post and Telecommunications Department, this institution is a <a href="http://www.cpt.gov.vn/">branch of the Vietnamese government</a> .  You can also see that the top-level domain for the C &amp; C server URL (vnptnet.info) is very similar to the Vietnamese address vnpt.nv, which belongs to the same CPT institution.  Probably this name was chosen to disguise the domain in logs of systems like Intrusion Detection System (IDS), which capture traffic passing through a computer or computers on a network.  Phishing documents, which we wrote about at the beginning and which are used to lure users, contain text that deals with telecommunication systems.  The documents themselves contain various graphs and diagrams, trying to maximize the attention of the potential victim and convince them that the document is real.  It appears that this attack was directed at the Vietnamese CPT institution and Vietnamese officials <a href="http://www.thanhniennews.com/index/pages/20130328-china-hackers-target-vietnamese-state-officials-offices.aspx">reported</a> an attack on their infrastructure this year. <br><br>  We observed how the operator interacts with the infected system.  Below are several proofs (log) of such an interaction. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/007/39f/06d/00739f06d55e4f666842dcf199ce7ada.png"><br>  Fig.  Commands sent by the operator bot Agent.NJK. <br><br>  These operations are similar to intelligence, that is, they are related to the collection of data on a compromised system: netsta (t) is used to view current network connections, then information about the logical disks in the system, viewing environment variables, receiving information about the location of some files takes place .  A typo in the word netsta, instead of netstat, in the second command indicates that these commands are not sent to the bot by an automated system, and a physical operator is behind them.  We have observed this approach before in the case of the <a href="http://www.welivesecurity.com/2013/05/23/syndicasec-in-the-sin-bin/">Syndicasec targeted attack</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/32e/5fc/014/32e5fc014f3ff3cc534a2e196cff5391.png"><br>  Fig.  Bot transmits data about current network connections in the open form. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a5/036/b16/5a5036b162186fcd6f3b2db30f9151aa.png"><br>  Fig.  Closing a C &amp; C session with a bot. <br><br>  In the last screenshot under item 2, you can see that the server disconnects by sending the RST (reset) command.  After sending the reset command, the server behavior changes and as soon as the client receives it, it will no longer be able to connect to any of the three ports. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aae/000/e56/aae000e56f7b7fa850de391ff19348b3.png"><br>  Fig.  The server refuses to connect to the client, if a TCP connection reset command was sent to them before that. <br><br>  The absence of survival mechanisms in the malicious code after a reboot strengthens our hypothesis about the direction of such a cyber attack, since attackers are interested in leaving as few traces as possible in the compromised system.  A common practice when using such malicious code would be to find out potential victims in the organization, send a phishing email, wait for a response from the bot and at the end investigate compromised computers through it.  In our case, the bot supports commands to load other executable files into the system (3004) and their subsequent installation (3011), so it can be used to perform several other actions. <br><br>  <b>Terminator RAT (aka FAKEM RAT)</b> <br><br>  It is detected by our anti-virus products like <b>Win32 / Protux.NAR</b> .  At the time of the analysis of some of this malware, which implements encryption and is responsible for working with C &amp; C, we found that this threat was analyzed earlier by <a href="http://www.malware.lu/Pro/RAP002_APT1_Technical_backstage.1.0.pdf">malware.lu</a> and <a href="http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-fakem-rat.pdf">Trend Micro</a> with the names Terminator RAT and FAKEM RAT.  At the same time, the samples we analyzed differed from those with which these companies dealt.  It should also be noted that FireEye also released its <a href="http://www.fireeye.com/blog/technical/malware-research/2013/10/evasive-tactics-terminator-rat.html">analysis of</a> one of the modifications of this malware. <br><br>  Compared to Agent.NJK, this threat is more complex.  First, the configuration data and strings are encrypted using a slightly modified version of <a href="http://ru.wikipedia.org/wiki/XTEA">the XTEA algorithm</a> .  XTEA uses a 128-bit key and works with blocks of 64 bits in length. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b4a/5b3/d23/b4a5b3d23260bd16c6dfed4c8794f9d3.png"><br>  Fig.  XTEA as it is implemented in the Terminator RAT modification under study. <br><br>  The XTEA implementation is rather naive because it uses the worst block encryption mode, as shown in the screenshot below.  64-bit blocks consisting of zeros are always encrypted into the same ciphertext. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1dd/178/cf7/1dd178cf729834548a235f11b81d9875.png"><br>  Fig.  An example of a cipher text that starts at 0x404198 and contains an obvious pattern. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d0/68d/efa/4d068defa76e4e8961aa9de40f5b407c.png"><br>  Fig.  Decrypted text at the same address. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/441/4c0/8b1/4414c08b1ab883aff58494bac51b691d.png"><br>  Fig.  Part of the configuration of malicious code in encrypted form. <br><br>  (1) XTEA key, (2) two port numbers (9000, 9090) and some other data, (3) different lines obfuscated with intermediate zeros. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/330/066/154/330066154062e6079a258cba5fdc82eb.png"><br>  Fig.  Decrypted configuration data. <br><br>  (1) the directory where the malware was installed (located in% APPDATA%), (2) the names of the files that are given to the installed components, (3) the C &amp; C domain, (4) the name of the directory in the resources section where the payload is stored, (5) the registry key that is used to run after a reboot (ensures survival). <br><br>  After starting, <b>Protux.NAR</b> dynamically fills the variable addresses of functions in the body of its file (addresses of functions that were not declared in the import table).  This is done using its own implementation of the <i>GetProcAddress</i> function, as is the case with <b>TrojanProxy.Agent.NJK</b> .  Strings that are used to obtain addresses of functions are not encrypted and are stored in the body of malicious code in the clear. <br><br>  Next, Win32 / Protux.NAR changes the value of the variable in the system registry that sets the path to the Startup Folder (‚ÄúStartup‚Äù directory, is used to organize the startup) to the new value ‚Äú% APP_DATA% \ 2019‚Äù, copies the existing files to the new location and provides moving its body to the same new location (‚Äú% APP_DATA% \ 2019) under the name‚Äú svchost .exe ‚Äùvia <i>MoveFileEx</i> with the MOVEFILE_DELAY_UNTIL_REBOOT flag.  In addition, he gets another PE file from his body and copies it to the directory under the name ‚Äúwinslogon.ini‚Äù, setting his deferred renaming via MOVEFILE_DELAY_UNTIL_REBOOT to the file ‚Äúwinslogon.exe‚Äù (used as a component to organize the proxy tunnel). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/82e/853/2dd/82e8532dd0ee95fb1a1778935b4a9faf.png"><br>  Fig.  The flow of code that demonstrates the above operations. <br><br>  As you can see, the malicious code relies heavily on the MoveFileEx function's <i>MOVEFILE_DELAY_UNTIL_REBOOT flag</i> .  This method is used as an OS mechanism for moving executable files that are running when the function is called.  Also, this method helps to prevent the activation of the heuristics of the antivirus product or other technologies for detecting malicious code. <br><br>  In order to avoid his discovery by security products on subsequent launches, he will try to copy his file into the directory with temporary files (GetTempPath () + "~ 7ti2") and write several random bytes to the end of the file.  After these operations, the file rewrites itself using the <i>MoveFileEx</i> function and the MOVEFILE_DELAY_UNTIL_REBOOT, MOVEFILE_REPLACE_EXISTING flags. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/157/829/f7a/157829f7a348880e688a5b925fe0bc62.png"><br>  Fig.  A more visual representation of the malicious code operations described above. <br><br>  After the reboot, when Windows starts each executable file from the Startup directory, two files of the malicious program ‚Äúsvchost .exe‚Äù (main component) and ‚Äúwinslogon.exe‚Äù (component of proxy tunnel) will be executed.  The main component decrypts the configuration and lines, and also starts an auxiliary stream that performs different functions depending on the directory from which the original file was launched. <br><br>  Next, the malicious code allocates a memory block, copies the resource section element with the identifier 0x8A in the directory (resources) under the name ACCELORATOR into the allocated memory block and decrypts it through the byte XOR with the 0x32 key.  Note that the name of the specified resource directory is ACCELORATOR, and not ACCELERATOR.  These decrypted data are executable code that can be executed regardless of its original location (position-independent code).  Before directly transferring control to this block of memory, the malicious code gets the current IP address of the computer, encrypts it via XOR and copies it along with the port number 8000 at a given offset in the code.  Encryption operations using XOR are performed using the same static key 0x32. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b34/669/1e5/b346691e5f58d538f007d12c8cb63f28.png"><br>  Fig.  The process of loading and executing code from the resources section. <br><br>  Malicious code that has been copied to a memory block makes a nonstandard use of registers, which probably indicates that it was written in assembler.  For example, to fill in the addresses of dynamically imported functions, use its own implementation of <i>GetProcAddress</i> with a predefined table of ROR hashes for each of the function names.  This method is rarely used for programs compiled in a higher programming language.  This <a href="http://pentest.cryptocity.net/files/exploitation/winasm-1.0.1.pdf">link</a> provides more information about using assembler. <br><br>  The next action that Protux.NAR performs is to create an event named ‚ÄúsxX5 {c4‚Äù, which allows it to fix the launch of malicious code to prevent the activity of several copies of it.  The organization of work with managers of C &amp; C servers is organized through three domains, which are polled with a 30 second timeout in a cycle.  The two domains are located in the configuration data, which is encrypted using XTEA, as shown in the screenshot above.  The third address is a pair: the IP of the compromised system and port 8000 (used for proxy tunneling operations).  Once the connection to the C &amp; C is established, the malicious code sends information about the compromised system in a 1024-byte packet.  The format of such a package is presented below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ad/28a/98b/3ad28a98bfc2fa687e08b09d8048cd21.png"><br>  Fig.  Data sent by a bot to a remote server about a compromised computer. <br><br>  The main fields in the package are Username and Computer name, the size of each of which is 128 bytes.  Another interesting field is the current codepage (Codepage) used in the system, 4 bytes in size.  The package also contains three more integer fields: two of them take the values ‚Äã‚Äã0x130, 0 (1), and the other takes the value 0x30005 (2).  These values ‚Äã‚Äãcoincide with the values ‚Äã‚Äãof similar fields from samples of malicious code that were analyzed by FireEye.  Field 3 contains a string and is probably a campaign ID. <br><br>  The interaction with C &amp; C is encrypted using a simple scheme: the XOR key bytes are applied to each byte of the stream, and then the cyclic right shift (ROR) operation is applied to three positions.  The key is static and looks like "YHCRA".  The algorithm is presented below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/934/81e/7c6/93481e7c6051c8d1a9c12cafd959ca3e.png"><br>  Fig.  Encryption with a management server used in Terminator RAT. <br><br>  The packet representing the server response contains the command identifier in the first four-byte field.  Malicious code uses the following commands. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39c/8bd/4f3/39c8bd4f34392191edc2c6e9d0d7cc80.png"><br><br>  Our colleagues from Trend Micro managed to fix the fact of the attack and what kind of auxiliary operations the control server <a href="http://www.trendmicro.com/cloud-content/us/pdfs/security-intelligence/white-papers/wp-fakem-rat.pdf">sends</a> to the bot on the command 0x211.  We are talking about performing operations using: the command line, file manager, process manager, registry editor, screenshot capture module, password theft module, and file upload module.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, the range of actions performed is very extensive. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We detected the following C &amp; C domains in this malicious code. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b30/d20/eb2/b30d20eb2b4aa1c6807cf9ec919e8e47.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As can be seen in the table above, the domain (1) contains a space at the end, which means that DNS cannot convert such a domain to its corresponding IP address. Domain (2), as we noted above, was obtained using the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gethostname</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gethostbyname</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> functions </font><font style="vertical-align: inherit;">. The domains 25u.com and 4dq.com are managed through the dynamic DNS service changeip.com located in the USA. The address 123.51.208.142 belongs to Taiwan. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The table below shows the differences between the investigated modifications of the malware, referred to by antivirus laboratories.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a5e/f77/5cd/a5ef775cd8594d09cae33a9826c2cbcd.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At the same time, between the modifications that have been analyzed by the above antivirus companies, there are similarities. </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The same traffic encryption algorithm (‚ÄúARCHY‚Äù [:: - 1] xor / ror3). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The same set of data transmitted as a payload over the network (1024-byte block). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Same C &amp; C commands (0x211, etc.). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Most C &amp; Cs rely on dynamic DNS services. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It can be stated that Terminator RAT lacks a consistent design in the implementation of malicious code. It is obvious that attackers repeatedly changed it to achieve their chosen goals or use them in corresponding attacks. The presence of several encryption mechanisms and two methods for loading the addresses of functions obviously justifies this assumption. In addition, the malicious code uses encryption for information transmitted to C &amp; C, but at the same time stores them in clear form in position-independent code. This does not indicate the correctness of the chosen approach. Finally, some functions are awkwardly fixed by adding additional features such as encryption / decryption, as shown in the screenshot below.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/82f/b22/a63/82fb22a6366c003731c802a589a40776.png"><br>  Fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Encryption function in Terminator RAT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The variable xtea_flag (1) is used to determine why the function itself is called: to perform XTEA encryption (2) or encryption via XOR with a fixed one-byte key (3). Obviously, one of the code fragments that implements this algorithm was embedded later.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, it is useful to have several analyzes of the same family of malicious code, since we can see changes in various modifications and in which campaigns they were used. In the case of the Terminator RAR, it can be seen that the components of the malicious code and the components of the infrastructure have been changed in various attacks. Components such as XTEA keys, network packet headers, the name of the executable file that is responsible for the implementation of the proxy tunnel have been changed. In terms of infrastructure, the DDNS provider and C &amp; C IP addresses have been changed.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we will focus in more detail on the proxy tunnel component, which has already been described in detail by FireEye as sss.exe. </font><font style="vertical-align: inherit;">It is used in cases where the malicious code is on a network that does not allow outgoing connections to the server directly (that is, a proxy is used on the network). </font><font style="vertical-align: inherit;">In this case, the module reserves port 8000 and will send connections through it that use a legitimate proxy configured for the computer. </font><font style="vertical-align: inherit;">To perform the task of connecting to C &amp; C through this proxy, the HTTP protocol's CONNECT method is used.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the modification we are studying, the file of this proxy tunnel module is called winslogon.exe. </font><font style="vertical-align: inherit;">We also found an encrypted log file left by this component in the hard wired path% TEMP% \ ~ DF3bbs.tmp. </font><font style="vertical-align: inherit;">The file can be decrypted using XOR with the key 0xAB as shown below.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/880/b45/f77/880b45f77caf7005bbb27aebcb35989b.png"><br>  Fig.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function of decrypting the log of the proxy tunnel component. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To prevent multiple copies of this module from running in memory, it uses an event object, whose name contains a non-printable character with code 0x13. Adding such a component to Terminator RAT expands the possibilities of this threat in the field of data theft mechanisms (exfiltration) and since it is actually independent of the RAT component, it can easily be reused in another modification of the malicious code. It can be seen that this component is not easy to detect immediately as malicious because it does not perform explicit malicious functions. In addition, the fact that the payload of malicious code is hidden in the position-independent code makes static RAT analysis quite problematic.</font></font><br><br>  <b>Conclusion</b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the process of analyzing the files of a malicious program, it became apparent that none of them was packed in order to prevent the analysis of malicious code. We also did not see a single exploit that could help attackers achieve their goals in the best possible way. In addition, the malicious code itself is not written in the best way, which indicates that the professional level of the attackers themselves is not quite professional. The list of shortcomings can be continued: poorly implemented cryptography algorithms, errors in commands when entered by the operator, errors in the configuration of C &amp; C domains. It seems that the customers of such an attack have allocated a very small budget for the organizational needs of the attack. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win32 / TrojanDropper.Small.NNK</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 58e1dfa7ace03a408d2b20c1fab6e127acbdc71f492366622cd5206484443ed7</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3f58a0ea8958c5bf88aa9cfcefe457393f0a96bba9f05f301ba6a15b65d5b64a </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win32 / TrojanProxy.Agent.NJK</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 54c5517541187165fd9720dfe8cff67498d912d189d649cc652d8b113bae8802 </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win32 / Protux.NAR (Terminator RAT)</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 425a919cb5803ce8fabb316f5e1be611f88f5c3813fffd2b40f2369eb7074da9 </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Win32 / Protux.NAR (Terminator RAT) with tunnel proxy</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a6cc9fbcb3d806fefb4d0f2f6d1c04b81316593dfe926b4477ca841ac17354e2</font></font></div><p>Source: <a href="https://habr.com/ru/post/205044/">https://habr.com/ru/post/205044/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205026/index.html">Monads and do-notation in C ++</a></li>
<li><a href="../205028/index.html">STM32 on MAC OS</a></li>
<li><a href="../205032/index.html">IOS 7 jailbreak crowdfunding campaign</a></li>
<li><a href="../205038/index.html">How I bought a 3D printer</a></li>
<li><a href="../205040/index.html">AgileKitchen Conference Report November 29, 2013</a></li>
<li><a href="../205046/index.html">TIZEN Developer Summit & Hakathon 2013: A View from New York, Seoul and Vladivostok</a></li>
<li><a href="../205048/index.html">Science Slam St. Petersburg</a></li>
<li><a href="../205052/index.html">Possible disclosure of the personality of Satoshi Nakamoto, the creator of Bitcoin</a></li>
<li><a href="../205054/index.html">IBM and Nvidia are developing new generation supercomputers</a></li>
<li><a href="../205056/index.html">AirGateway - Ubiquiti access point in a matchbox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>