<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Boot yourself, Spring is coming (Part 2)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov (NAYA Technologies) and Kirill tolkkv Tolkachev (Cyan.Finance, Twitter ) continue to talk about applying Spring Boot to s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Boot yourself, Spring is coming (Part 2)</h1><div class="post__text post__text-html js-mediator-article"><p>  Evgeny <a href="https://habr.com/users/evgenyborisov/" class="user_link">EvgenyBorisov</a> Borisov (NAYA Technologies) and Kirill <a href="https://habr.com/users/tolkkv/" class="user_link">tolkkv</a> Tolkachev (Cyan.Finance, <a href="https://twitter.com/tolkv">Twitter</a> ) continue to talk about applying Spring Boot to solving problems of an imaginary Iron Bank of Braavos.  In the second part, we will focus on the profiles and intricacies of launching the application. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  The first part of the article can be found <a href="https://habr.com/company/jugru/blog/424503/">here</a> . </p><br><p>  So, until recently, the customer came and simply demanded to send a crow.  Now the situation has changed.  Winter came, the wall fell. </p><br><p>  First, the principle of issuing loans is changing.  If earlier, with a probability of 50%, they were issued to everyone except Starks, now they are issued only to those who return debts.  Therefore, we are changing the rules for issuing loans in our business logic.  But only for the branches of the bank, which are located where the winter has already arrived, in all the others everything remains as before.  I remind you that this is a service that decides whether to issue a loan or not.  We just make another service that will work only in winter. </p><br><p>  Go to our business logic: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p>  We already have a list of those who return debts. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p>  And there is a class that is already associated with property - <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p>  As in previous times, we simply inject it here: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  We remember about constructor injection (about magical annotations): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Almost done. </p><br><p>  Now we have to issue only those who return the debts: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  But here we have a little problem.  Now we have two implementations: the old and the new services. </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend‚Ä¶ - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper‚Ä¶ - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p>  It is logical to separate these bins in different profiles.  Profile <code></code> and profile <code></code> .  Let our new service be launched only in the <code></code> profile: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  And the old service - in <code></code> . <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p>  But winter is coming slowly.  In the kingdom, located next to the broken wall, it is already winter.  But somewhere in the south - not yet.  Those.  Applications that are located in different branches and time zones should work differently.  Under the terms of our task, we cannot erase the old implementation where winter has come, and use the new class.  We want bank employees to do nothing at all: we will install an application for them that will work in summer mode until the arrival of winter.  And when winter comes, they just restart it and that's it.  They will not have to change the code, erase any classes.  Therefore, we initially have two profiles: some of the bins are created when summer is, and some of the bins are created when winter is. </p><br><p>  But there is another problem: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p>  Now we do not have a single bean, because we specified two profiles, and the application starts in the default profile. </p><br><p>  So we have a new requirement from the customer. </p><br><h2>  Iron law 2. No profile can not </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p>  We do not want to raise the context, if the profile is not activated, because winter has already arrived, everything has become very bad.  There are certain things that must occur or not, depending on whether <code></code> or <code></code> .  Also, look at the exception, the text of which is shown above.  He does not explain anything.  The profile is not set, so there is no implementation of <code>ProphetService</code> .  At the same time, no one said that it is necessary to set the profile. </p><br><p>  Therefore, we want to now tighten the additional thing in our starter, which, when building the context, will check that some profile has been set.  If it is not specified, we will not rise and throw such an exception (and not any exception about the lack of a bin). </p><br><p>  Can we do this with the help of our application listener?  Not.  And there are three reasons for this: </p><br><ul><li>  A single responsibility listener is responsible for ensuring that the crows fly.  The listener should not check if the profile has been activated, because the profile activation affects not only the listener itself, but also much more. </li><li>  When the context is built, different things happen.  And we do not want them to start happening unless a profile has been set. </li><li>  Listener works at the very end when the context is resolved.  And the fact that there is no profile, we know much earlier.  Why wait for these conditional five minutes until the service almost rises, and then everything falls. </li></ul><br><p>  In addition, I still do not know what bugs will appear due to the fact that we began to rise without a profile (suppose I do not know the business logic).  Therefore, in the absence of a profile, it is necessary to bring the context at a very early stage.  By the way, if you use any Spring Cloud, it becomes even more relevant for you, because the application at an early stage does quite a lot of things. </p><br><p>  To implement the new requirement, there is an <code>ApplicationContextInitializer</code> .  This is another interface that allows us to extend some Spring point by specifying it in spring.factories. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p>  We implement this interface, and we have a Context Initializer, in which there is a <code>ConfigurableApplicationContext</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  With it, we can get the environment - the thing that SpringApplication has prepared for us.  All property that we gave to him got there.  Among other things, it contains profiles. </p><br><p>  If there are no profiles there, then we should throw an exception that it is impossible to work like this. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p>  Now you need to register it in spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p>  From the above, it can be guessed that <code>ApplicationContextInitializer</code> is a kind of extension point.  <code>ApplicationContextInitializer</code> works when the context is just being built, there are no beans yet. </p><br><p>  The question arises: if we wrote <code>ApplicationContextInitializer</code> , why not listen as a listener in a configuration that stretches anyway?  The answer is simple: because it should work much earlier, when there is no context and no configurations.  Those.  it can not be injected yet.  Therefore, we prescribe it as a separate thing. </p><br><p>  Attempt to launch showed: everything fell quickly enough and reported that we run without a profile.  And now we will try to specify some profile, and everything works - the crow is sent. </p><br><p>  <code>ApplicationContextInitializer</code> - works when the context has already been created, but there is nothing else in it except the environment. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p>  Who creates the environment?  Carlson - <code>SpringBootApplication</code> .  He fills it with different meta-information, which then from the context can be pulled.  Most things can be injected through <code>@value</code> , something can be obtained from the environment, as we have just received profiles. </p><br><p>  For example, different properties come here: </p><br><ul><li>  who can collect Spring Boot; </li><li>  which, when launched, are transmitted via the command line; </li><li>  systemic; </li><li>  registered as environment variables; </li><li>  prescribed in the application properties; </li><li>  prescribed in some other property files. </li></ul><br><p>  All this is going to and looking into the environment object.  There also gets information about which profiles are active.  The environment object is the only thing that exists at the time when the Spring Boot starts building a context. </p><br><p>  I would like to guess automatically what the profile will be if people forgot to set it up with their hands (we do everything so that bank employees, who are helpless enough without programmers, can run the application - so that everything will work for them, no matter what).  To do this, we will add a piece to our starter that will guess the profile - <code></code> or not - depending on the temperature outside.  And with this, another new magic interface, <code>EnvironmentPostProcessor</code> , will help us all, because we need to do this before the <code>ApplicationContextInitializer</code> works.  And before <code>ApplicationContextInitializer</code> there is only <code>EnvironmentPostProcessor</code> . </p><br><p>  We are again implementing a new interface.  There‚Äôs just one method that, just like the <code>ConfigurableEnvironment</code> Environment pushes into <code>SpringApplication</code> , because we don‚Äôt have the <code>ConfigurableContext</code> yet (we already have it in <code>SpringInitializer</code> , but we don‚Äôt have it here; there is only environment). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  In this environment, we can install a profile.  But first you need to check that no one has installed it before.  Therefore, in any case, we need the <code>getActiveProfiles</code> check.  If people know what they are doing and they set up a profile, then we will not try to guess for them.  But if there is no profile, then we will try to understand the weather. </p><br><p>  And second, we must understand whether the weather is winter or summer.  We will return the temperature <code>-300</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Under this condition, we have winter, and we can set a new profile.  We remember that the profile is called <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Now you need to specify <code>EnvironmentPostProcessor</code> in spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p>  As a result, the application runs without a profile, we say that this is a production, and we check in which profile it started with us.  Magically, we realized that we have a <code></code> .  And the application did not fall, because the <code>ApplicationContextInitializer</code> , which checks if there is a profile, comes next. <br>  Total: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  We talked about <code>EnvironmentPostProcessor</code> , which works before the <code>ApplicationContextInitializer</code> .  But who runs it? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p>  It is started by such a weirdo who, apparently, is an illegitimate son of <code>ApplicationListener</code> and <code>EnvironmentPostProcessor</code> , because it is inherited from both <code>ApplicationListener</code> and <code>EnvironmentPostProcessor</code> .  It is called <code>ConfigFileApplicationListener</code> (nobody knows why the "ConfigFile"). </p><br><p>  He is our Carlson, i.e.  Spring Application, provides a prepared environment for listening to two event: <code>ApplicationPreparedEvent</code> and <code>ApplicationEnvironmentPreparedEvent</code> .  We will not disassemble now who throws these events.  There is another layer (in my opinion already completely superfluous, at least at this stage in the development of Spring), which throws an event that the environment is now being built (parted by Application.yml, properties, environment variables, etc. ). <br>  Having received <code>ApplicationEnvironmentPreparedEvent</code> , the listener understands that it is necessary to configure the environment - to find all the <code>EnvironmentPostProcessor</code> and let them work. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p>  After that, he tells <code>SpringFactoriesLoader</code> to deliver everything that you have prescribed, namely all <code>EnvironmentPostProcessor</code> , in spring.factories.  Then he stuffs all of <code>EnvironmentPostProcessor</code> into one List. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p>  and understands that he is also an <code>EnvironmentPostProcessor</code> (part-time), so he shoves himself there, <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br>  at the same time sorts them, goes along with them and calls each method <code>postProcessEnvironment</code> . </p><br><p>  Thus, all <code>postProcessEnvironment</code> are started at an early stage even before the <code>SpringApplicationInitializer</code> .  At the same time, an incomprehensible <code>EnvironmentPostProcessor</code> called <code>ConfigFileApplicationListener</code> also starts. </p><br><p>  When the environment is tuned, everything returns to Carlson again. </p><br><p>  If the environment is ready, you can build a context.  And Carlson starts building context with the <code>ApplicationInitializer</code> .  Here we have our own piece, which checks that there is an environment in the context in which there are active profiles.  If not, we fall, because otherwise we will still have problems later.  Starters continue to work, with all the usual configurations already. </p><br><p>  The picture above reflects that Spring is not doing well either.  There are such aliens from time to time, single responsibility is not respected and it is necessary to climb there carefully. </p><br><p>  Now we want to talk a little about the other side of this strange creature, which is on the one hand a listener, and on the other hand is an <code>EnvironmentPostProcessor</code> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p>  As an <code>EnvironmentPostProcessor</code> it can load application.yml, application properties, any environment variable, command arguments, etc.  And as a listener, he can listen to two events: </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p>  The question arises: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p>  All these events were in the old Spring.  And the ones we talked about above are the Spring Boot event (special events that he added for his life cycle).  And their whole pack.  These are the main ones: </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p>  This list is far from all.  But it is important that some of them belong to Spring Boot, and some - to Spring (good old <code>ContextRefreshedEvent</code> , etc.). </p><br><p>  The caveat is that not all of these events can be obtained in the application (mere mortals - different grandmothers - can‚Äôt just listen to complex events that Spring Boot throws).  But if you know about the secret mechanisms of spring.factories and define your Application Listener at the level of spring.factories, then these event-s of the earliest stage of the application start get to you. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p>  As a result, you can influence the start of your application at a rather early stage.  The joke, however, is that part of this work has been moved to other entities, such as <code>EnvironmentPostProcessor</code> and <code>ApplicationContextInitializer</code> . </p><br><p>  It was possible to do everything on the listener, but it would be inconvenient and ugly.  If you want to listen to all the events that Spring throws, not just <code>ContextRefreshedEvent</code> and <code>ContextStartedEvent</code> , then you don‚Äôt need to prescribe the listener as a bin in the usual way (otherwise it is created too late).  It should also be registered through spring.factories, then it will be created much earlier. </p><br><p>  By the way, when we looked at this list, it was not clear to us when <code>ContextStartedEvent</code> and <code>ContextStoppedEvent</code> work at all? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p>  It turned out that these events never work at all.  We have long puzzled over what kind of events we need to catch in order to understand that the application has really started.  And it turned out that the events we are talking about now appear when you forcibly pull methods from the context: </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p>  Those.  <code>SpringApplication.run</code> will come only if we run <code>SpringApplication.run</code> , get the context, drag it with <code>ctx.start();</code>  or <code>ctx.stop();</code>  .  It is not very clear why this is necessary.  But you, again, were given an extension point. </p><br><p>  Does Spring have anything to do with this?  If so, there should be an exception somewhere: </p><br><ul><li> <code>ctx.stop();</code>  (one) </li><li> <code>ctx.start();</code>  (2) </li><li> <code>ctx.close();</code>  (3) </li><li> <code>ctx.start();</code>  (four) </li></ul><br><p>  In fact, it will be on the last line, because after <code>ctx.close();</code>  with the context nothing can be done.  But call <code>ctx.stop();</code>  before <code>ctx.start();</code>  - it is possible (Spring simply ignores these event-s - they are just for you). </p><br><p>  Write your listeners, listen for yourself, think up your laws, what to do at <code>ctx.stop();</code>  , and what to do on <code>ctx.start();</code>  . </p><br><p>  Total scheme of interaction and application life cycle looks like this: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p>  The colors here show different periods of life. </p><br><ul><li>  Blue is Spring Boot, the application has already started.  This means that Tomcat service requests that come to it from clients are processed, the whole context is raised exactly, all the bins are working, databases are connected, etc. </li><li>  Green - flew event <code>ContextRefreshedEvent</code> and context is built.  From this moment, for example, application listeners start to work, which you implement either by setting the ApplicationListener annotation, or through the eponymous interface with a generic that listens to certain events.  If you want to get more events, you need to register the same ApplicationListener in spring.factories (the usual Spring works here).  The stripe marks where the <a href="https://www.youtube.com/watch%3Fv%3DhDpa6m48eC4">Spring Ripper</a> report begins. </li><li>  At an earlier stage, SpringApplication works, which prepares the context for us.  This is the application preparation work that we did when we were regular Spring developers.  For example, we configured WebXML. </li><li>  But there are even earlier stages.  It indicates who, where and for whom works. </li><li>  There is also a gray stage in which there is no way to interpose.  This is the stage at which SpringApplication runs out of the box (only in code to climb). </li></ul><br><p>  If you noticed, in the process of a two-part report we went from right to left: we started from the very end, screwed up the configuration that came from the starter, then added the following, etc.  Now let's quickly talk through this whole chain in the opposite direction. <br>  You write in your main <code>SpringApplication.run</code> .  He finds different listeners, throws an event to them that he has started to build.  After this, listeners find <code>EnvironmentPostProcessor</code> , let them set up the environment.  Once the environment is set up, we begin to build the context (Carlson enters).  Carlson builds the context and allows all the Application Initializer to do something with this context.  We have an extension point.  After that, the context is already set up and the same thing starts happening next as in the usual Spring application, when the context is built - <code>BeanFactoryPostProcessor</code> , <code>BeanPostProcessor</code> , the bins are set up.  This deals with the usual Spring. </p><br><h2>  How to run </h2><br><p>  We have finished discussing the process of writing an application. </p><br><p>  But we had one more thing developers don't like.  They do not like to think, how in the end their application will start.  Will the admin run it in Tomcat, JBoss or WebLogic?  It just has to work.  If it doesn't work, in the worst case, the developer has to set something up again. </p><br><p>  So, what are our ways to start? </p><br><ul><li>  tomcat war; </li><li>  idea; </li><li>  <code>java -jar/war</code> . </li></ul><br><p>  Tomcat is not a massive trend, we will not talk about it in detail. </p><br><p>  Idea is also, in principle, not very interesting.  There is just a little smarter than I will tell below.  But in Idea, in principle, there should be no problems.  She sees what dependences the starter will bring. <br>  If we do <code>java -jar</code> , the main problem is to build the classpath before we run the application. </p><br><p>  What did people do in 2001?  They wrote <code>java -jar</code> , which jar should be run, then a space, <code>classpath=...</code> and there they specified scripts.  In our case, there are 150 MB of different dependencies that have added starters.  And all this would have to be done manually.  Naturally, no one does.  We just write: <code>java -jar</code> , which jar should be run and that's it.  Somehow the classpath is still built.  About this we will now talk. </p><br><p>  Let's start with the preparation phase of the jar file so that it can be started without Tomcat at all.  Before you make <code>java -jar</code> , you need to build a jar.  This jar should obviously be unusual, some kind of analog of war, where everything will be inside, including the embedded Tomcat. </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>  When we downloaded the project, we have already registered a plugin in POM.  Here, by the way, you can throw in configurations, but more on that later.  As a result, in addition to the usual jar, which builds Maven or Gradle of your application, another unusual jar is built.  On the one hand, it looks fine: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p>  But if you look from the side: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p>  This is basically an analogue of war. </p><br><p> ,     . </p><br><p>     ,    jar.    <code>java -jar</code> ,   ,    , , <code>org.springframework.boot</code> .      .     org.springframework.boot package.         <code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p> Spring Boot   MANIFEST (    Maven  Gradle),     main class,    jar-. </p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , ‚Äî    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p>  Those.     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property ‚Äî <code>Start-class</code> . </p><br><p>  Those.       .     class path  jar. ,    ‚Äî <code>org.springframework.boot</code> ‚Äî   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     ‚Äî  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> ‚Äî   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> ‚Äî   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   ‚Äì  mainClass: </p><br><ul><li>     ‚Äì    .     ‚Äî     main class; </li><li>    ‚Äì ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    ‚Äî  exception   ,    main class,  ,     jar-  .  Those.    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  ‚Äî   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ?  Can.   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar ‚Äî  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     ‚Äî <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  ‚Äî      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    ‚Äî <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     ‚Äî     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   ‚Äî     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2>  findings </h2><br><p>         ,  Spring Boot ‚Äî   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring ‚Äî      Spring Boot.    ,         ,        ‚Äî , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   ‚Äî   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote>  Minute advertising. 19-20    Joker 2018,            <a href="https://jokerconf.com/2018/talks/50i8gfio9ic6u8qqskyq02/">¬´          [Joker Edition]¬ª</a> ,         <a href="https://jokerconf.com/2018/talks/1vzkputteosikmmakiqgci/">¬´Micronaut vs Spring Boot,     ?¬ª</a> .  ,  Joker       <a href="https://habr.com/company/jugru/blog/424237/"> </a> .     <a href="https://jokerconf.com/registration/"> </a> . </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/425333/">https://habr.com/ru/post/425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425323/index.html">"Rabbit Hole". UX designer in the product team</a></li>
<li><a href="../425325/index.html">DIY bytecode interpreters</a></li>
<li><a href="../425327/index.html">Functional programming: measure seven times, cut once</a></li>
<li><a href="../425329/index.html">A few tips to the millennials from the "oldies". How to succeed in our digital world</a></li>
<li><a href="../425331/index.html">Alice will help developers find objects in user requests. NER in Dialogues</a></li>
<li><a href="../425335/index.html">Invincible Garmin Armada</a></li>
<li><a href="../425337/index.html">How to scale Scrum - a couple of words about the Nexus agile development framework</a></li>
<li><a href="../425339/index.html">Information architecture on the Internet, part 2</a></li>
<li><a href="../425341/index.html">Review ‚ÄúTop 3D Expo. Digital Education 2018</a></li>
<li><a href="../425343/index.html">25 useful tools Kubernetes: deployment and management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>