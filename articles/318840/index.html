<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Continuous cross compilation for Raspberry PI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I wanted to deploy a continuous integration system, a cross-compiled CMake project written in c ++ with OpenGL on Raspberry PI. At the same time, I wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Continuous cross compilation for Raspberry PI</h1><div class="post__text post__text-html js-mediator-article"><p>  I wanted to deploy a continuous integration system, a cross-compiled CMake project written in c ++ with OpenGL on Raspberry PI.  At the same time, I wanted to see if convenient automated build servers appeared that did not contain a python and did not consume hundreds of megabytes of ram in idle time.  One of the goals of writing an article is to find out if I have passed a better or simpler solution :) </p><br><p>  TLDR: drone cool, allows you to add a simple file to the repository root on github / bitbucket - and get automatic builds / tests / deploy.  Just like Travis, but self-hosted. </p><br><a name="habracut"></a><br><p>  Going to Google, I found out that there are only two builds of servers that satisfy my simple requirements: </p><br><ul><li>  drone.io </li><li>  concourse.ci </li></ul><br><p>  I stopped at drone.io.  I chose according to the description, I can not objectively compare. </p><br><p>  Drone has two versions, 0.4 and 0.5.  0.5 is beta, it looks a little nicer, but for myself I haven‚Äôt found any fundamentally new features.  The only bug in 0.4 corrected in 0.5 which I stumbled upon - you can accidentally deny the checkbox Administrator via UI. </p><br><p>  Documentation link <a href="http://readme.drone.io/">http://readme.drone.io/</a> - version 0.4.  For 0.5 - <a href="http://readme.drone.io/0.5/">http://readme.drone.io/0.5/</a> . </p><br><p>  From the unobvious nuances - drone works with one of the suppliers of repositories, such as github, bitbucket, gogs.  And one drone instance can work with only one source.  This is corrected by launching several independent drone servers, since they don‚Äôt waste extra resources. <br>  In my case, one drone looks in bitbucket, one in gogs running on the same server. </p><br><p>  I ran drone through the docker image, it looks like this: </p><br><p>  Run: </p><br><pre><code class="hljs tex">docker run -d <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-e REMOTE_DRIVER=bitbucket <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-e "REMOTE_CONFIG=https://bitbucket.org?client_id=***&amp;client_secret=***" <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-e DRONE_DATABASE_DRIVER=sqlite3 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-e DRONE_DATABASE_CONFIG=/var/lib/drone/drone.sqlite <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-v /var/lib/drone_bitbucket:/var/lib/drone <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-v /var/run/docker.sock:/var/run/docker.sock <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>-p 81:8000 <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--restart=always <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>--name=drone_bitbucket <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>drone/drone:0.4</code> </pre> <br><p>  And that's all :) </p><br><p>  This is how drone looks after installation on the server: <br><img src="http://i.imgur.com/ztasLa6.png" alt="Login"></p><br><p>  By clicking on the drone button, go for bitbucket permissions, and if successful, show all repositories available to your account: <br><img src="http://i.imgur.com/MF3cbzX.png" alt="repos"></p><br><p>  Initially, the Active tab will be empty, all repositories will be in Available.  Here is a power button for every bitback of the repository: </p><br><p><img src="http://i.imgur.com/zDQaoWa.png" alt="activate"></p><br><p>  Now the most interesting thing is the build process itself :) </p><br><p>  The build process in drone is extremely simple.  At the root of the active repository there must be a .drone.yml file, which describes how to build and deploy the contents of the repository.  The tag is set to the docker of the image in which the assembly and build commands will occur.  The whole .drone.yml for raspberry looks like this: </p><br><pre> <code class="hljs objectivec">build: image: notfl3/cross_raspberry_pi commands: - cmake -D <span class="hljs-built_in"><span class="hljs-built_in">CMAKE_BUILD_TYPE</span></span>=Debug -D <span class="hljs-built_in"><span class="hljs-built_in">CMAKE_TOOLCHAIN_FILE</span></span>=/Toolchain-RaspberryPi.cmake . - make publish: sftp: host: port: <span class="hljs-number"><span class="hljs-number">22</span></span> username: ... password: ... destination_path: ... files: - ...</code> </pre> <br><p>  The most difficult place for me was the creation of a docker image that could cross-compile for Raspberry.  There are a lot of ready ones on the Internet, but I made my own (mostly to see what kind of docker this is).  It looks like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> debian:sid RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y git RUN apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install -y cmake ENV CROSS_TRIPLE arm-linux-gnueabihf RUN mkdir -p /rpi/tools &amp;&amp; cd /rpi/tools &amp;&amp; git init &amp;&amp; git remote <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> -f origin https://github.com/raspberrypi/tools &amp;&amp; \ git config core.sparseCheckout <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> &amp;&amp; echo "arm-bcm2708/gcc-linaro-${CROSS_TRIPLE}-raspbian-x64" &gt;&gt; .git/<span class="hljs-keyword"><span class="hljs-keyword">info</span></span>/sparse-checkout &amp;&amp; \ git pull <span class="hljs-comment"><span class="hljs-comment">--depth=1 origin master RUN mkdir -p /rpi/rootfs/opt COPY lib/ /rpi/rootfs/lib/ COPY usr/ /rpi/rootfs/usr/ COPY opt/vc/ /rpi/rootfs/opt/vc/ COPY Toolchain-RaspberryPi.cmake /Toolchain-RaspberryPi.cmake RUN mkdir -p /build WORKDIR /build</span></span></code> </pre> <br><p>  This is the contents of my Dockerfile, in order to create a full-fledged image used for the build - you need to put it in one directory to / usr, / lib, / opt taken from this Raspbian and Toolchain-RaspberryPi.cmake file after the <code>docker build . -t notfl3/cross_raspberry_pi</code>  <code>docker build . -t notfl3/cross_raspberry_pi</code> drone running on the same server will be able to use this image and build our builds. </p><br><p>  The cross- <a href="https://cmake.org/cmake/help/v3.6/manual/cmake-toolchains.7.html">compilation</a> itself takes place according to the <a href="https://cmake.org/cmake/help/v3.6/manual/cmake-toolchains.7.html">rules of CMake</a> , the only caveat - I registered my Toolchain.cmake file for gcc from raspberry-tools, it looks like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_SYSTEM_NAME Linux) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_SYSTEM_VERSION <span class="hljs-number"><span class="hljs-number">1</span></span>) # <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the target environment <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_FIND_ROOT_PATH /rpi/rootfs) # Specify the <span class="hljs-keyword"><span class="hljs-keyword">cross</span></span> compiler <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_C_COMPILER /rpi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/arm-linux-gnueabihf-gcc "--sysroot=${CMAKE_FIND_ROOT_PATH}") <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_CXX_COMPILER /rpi/tools/arm-bcm2708/gcc-linaro-arm-linux-gnueabihf-raspbian-x64/bin/arm-linux-gnueabihf-g++ "--sysroot=${CMAKE_FIND_ROOT_PATH}") # <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> programs <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the build host directories <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER) # <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> libraries <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> headers <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the target directories <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY <span class="hljs-keyword"><span class="hljs-keyword">ONLY</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE <span class="hljs-keyword"><span class="hljs-keyword">ONLY</span></span>) INCLUDE_DIRECTORIES(${CMAKE_FIND_ROOT_PATH}/usr/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/arm-linux-gnueabihf) INCLUDE_DIRECTORIES(${CMAKE_FIND_ROOT_PATH}/usr/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/)</code> </pre><br><p>  With the help of these simple manipulations, I was able to get a working build with a glfw window for raspberry, quickly gathering on an external dedicated server. </p><br><p>  Going amazing! </p><br><p><img src="http://i.imgur.com/98tmx5l.png" alt="Res"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/318840/">https://habr.com/ru/post/318840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318824/index.html">"Breaking Bad" or the harsh realities of the indie development of Dark Forester</a></li>
<li><a href="../318826/index.html">Technical support in the era of DevOps</a></li>
<li><a href="../318832/index.html">Recognition of radio signals using neural networks</a></li>
<li><a href="../318834/index.html">Introduction to Modbus</a></li>
<li><a href="../318836/index.html">Storing php sessions in Redis with locks</a></li>
<li><a href="../318842/index.html">‚ÄúI get torn when I can't write code‚Äù - an interview with Maxim Shafirov, CEO of JetBrains</a></li>
<li><a href="../318846/index.html">Installing OpenCV in Windows for Dummies and connecting the library to Code Blocks</a></li>
<li><a href="../318848/index.html">Coding with the withdrawal of information. Part 1, philosophical</a></li>
<li><a href="../318850/index.html">33C3 CTF We exploit LaTeX vulnerability in the pdfmaker task</a></li>
<li><a href="../318856/index.html">Data integrity in spite of everything. Disaster Backup in the Azure Pack Infrastructure Cloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>