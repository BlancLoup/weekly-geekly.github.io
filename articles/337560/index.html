<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Why did we do VOD on WebRTC</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VOD is about video on demand, i.e. playing conventional clips, as is done on YouTube or another streaming service. WebRTC is a low latency realtime vi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Why did we do VOD on WebRTC</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/ed1/a09/c3e/ed1a09c3e82647f8b93d69d0404c23c8.jpg"></div><br>  VOD is about video on demand, i.e.  playing conventional clips, as is done on YouTube or another streaming service.  WebRTC is a low latency realtime video.  You may ask - how can these two things be related?  Come under kat for details. <a name="habracut"></a><br><br><h2>  Support and bugfix </h2><br>  It all started, as usual, with the sapport.  A girl programmer approached us, presumably from an outsourcing company in India, which participated in the development of a mobile telemedicine application.  One of the client's desires was recording WebRTC video chat with an iOS application, followed by playback in the same iOS application.  Such a recording worked, but when played using standard iOS SDK tools, green artifacts were discovered.  More precisely, not even artifacts, but quite distinct rectangular areas of green color, occupying of the screen.  Of course, this was no good, and we began to study the problem. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/3ce/f35/7d9/3cef357d9d5d41018d2c90b6cd3a4144.jpg"></div><br>  <i>Playback of recorded video from WebRTC via AVPlayerViewController</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the mobile video playback application, we used the standard components MPMoviePlayer or AVPlayerViewController, which can play an mp4 movie if you specify its http URL, for example <a href="">http: //host/sample.mp4</a> .  These components played out the MP4 video normally, but in the case of the broadcasts recorded from the iOS application, the green area did not disappear anywhere and spoiled everything. <br><br><h2>  WebRTC dynamically changes the resolution of the stream. </h2><br>  It turned out that the green artifacts in the recording were due to the fact that for WebRTC it was normal to change the video resolution on the fly.  At the same time, in the mp4 recording file we have wonderful frames of different sizes, or rather, first a sequence of one size 640x480, then another 320x240, and so on.  Such tricks are great for playing VLC, for example, without any artifacts, and the built-in components of video playback in iOS over HTTP produce green artifacts when the video resolution changes in the bitstream. <br><br>  Let's start the broadcast from the iOS application and make sure that this is true.  For testing, you can use our iOS mobile application - <a href="">Two Way Streaming</a> based on iOS SDK and <a href="https://wcs5-eu.flashphoner.com/">WCS5-EU</a> demo server. <br><br>  This is the application that streams the stream to the server: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/fd8/3e9/cc4/fd83e9cc478f43fcb91e0611ab1434b2.png"></div><br>  And this is how the resolution change of the video sent from the mobile application in time looks like: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/f52/1eb/ba7/f521ebba7fa34bf482cae9be54f3664a.jpg"></div><br>  From the monitoring graph of the video stream, it can be seen that the resolution of the picture changes dynamically depending on the mobile device‚Äôs ability to compress video, work with the network, etc.  WebRTC changes resolution to target low latency. <br><br><h2>  WebRTC VOD as a solution </h2><br>  The way out of this situation would be rescaling with transcoding, i.e.  frame decoding, conversion to one resolution, for example 640x480 and recording in this resolution.  But if you do this with every stream published to the server, the CPU resources will quickly run out on 10-20 video streams.  Therefore, we needed a solution that did not involve transcoding. <br><br>  We thought - if WebRTC streams video with such changes in permissions, then it should be able to play the video recorded in this way.  It turns out that if we read the mp4 file and feed it via WebRTC to the browser or mobile application, then everything should be fine and the green rectangles on the iOS screen of the application should go. <br><br>  It remains to implement the recording of recorded mp4 and forwarding to the Web Call Server engine for further conversion into WebRTC.  The first tests showed good results - the green rectangles disappeared. <br><br>  So we got VOD with playback not only via WebRTC, but also on all supported protocols and technologies: RTMP, RTMFP, RTSP, HTML5 Canvas, Media Source, HLS, WebRTC. <br><br><h2>  WebRTC VOD - Live Broadcast </h2><br>  Then the question arose - ‚ÄúWhat if users want to broadcast the video as a stream, all at once and at the same time?‚Äù. <br><br>  As a result, I had to do two types of VOD. <br><br>  The first is <strong>personal VOD</strong> .  For each user who wants to play a video, a separate channel is created through which video is played from the very beginning of the video. <br><br>  The second is <strong>live VOD</strong> .  If the user started playing the video, and the second user connected later, they will watch the video as a live broadcast in real time, i.e.  the server will stream the video from exactly one stream, to which both users will be connected and can simultaneously watch, for example, a football match and comment on the players' actions. <br><br>  In our player and in the API, in order to play a stream, you need to know its name. <br><br>  For VOD, we introduced the following schemes: <br><br>  If you want to play the video personally, transfer the stream name like this: <br><br><pre><code class="php hljs">vod:<span class="hljs-comment"><span class="hljs-comment">//sample.mp4</span></span></code> </pre> <br>  If you want to make a full online broadcast of the video, the name of the stream will be as follows: <br><br><pre> <code class="php hljs">vod-live:<span class="hljs-comment"><span class="hljs-comment">//sample.mp4</span></span></code> </pre> <br>  The sample.mp4 file itself must be located in the WCS_HOME / media server folder and have the format MP4 / H.264 + AAC. <br><br>  What happened to the iOS application?  - you ask. <br><br>  All is well.  The iOS application plays a VOD movie on WebRTC without green rectangles. <br><br><h2>  WebRTC VOD in the Web Player </h2><br>  Now let's see how WebRTC VOD looks on the web.  To do this, on the server side, copy the mp4 file to the / usr / local / FlashphonerWebCallServer / media folder.  Let it be the well-known Big Buck Bunny, sample.mp4. <br><br>  Open the <a href="https://wcs5-eu.flashphoner.com/client2/examples/demo/streaming/embed_player/sample.html">page with the test player</a> , specify the name of the stream vod: //sample.mp4 and click Test Now. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/d79/016/76d/d7901676d46249f4b6a3cc52b875316e.jpg"></div><br>  The player starts playing stream through WebRTC.  In chrome: // webrtc-internals, you can see the playback graphics: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/87e/4c1/b62/87e4c1b62fe84b1787c7aaa8a27f211a.jpg"></div><br>  As a result, the story ended well.  We fixed a bug with a green screen when playing a mp4 broadcast recording in an iOS application and made the WebRTC-VOD function for web browsers and mobile devices running iOS and Android. <br><br><h2>  Links </h2><br><ol><li>  Test iOS <a href="">Two Way Streaming</a> application for broadcasts </li><li>  <a href="https://wcs5-eu.flashphoner.com/client2/examples/demo/streaming/embed_player/sample.html">Web player</a> - an example player for playing VOD - WebRTC streams </li><li>  <a href="https://flashphoner.com/">Web Call Server 5</a> distributing mp4 videos via WebRTC </li><li>  <a href="https://flashphoner.com/wcs-ios-sdk">WebRTC SDK for iOS</a> - library for developing streaming applications for iOS </li></ol></div><p>Source: <a href="https://habr.com/ru/post/337560/">https://habr.com/ru/post/337560/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337548/index.html">Kaggle: how our nets considered sea lions in the Aleutian Islands</a></li>
<li><a href="../337550/index.html">Learn OpenGL. Part 2.4. - Texture Cards</a></li>
<li><a href="../337554/index.html">The path of the Jedi. From a small user to an employee of an IT company</a></li>
<li><a href="../337556/index.html">SAMBA File Server Based on Linux CentOS 7</a></li>
<li><a href="../337558/index.html">What is LinkedList under the hood?</a></li>
<li><a href="../337564/index.html">Specific use of Redux in Polymer and Vue</a></li>
<li><a href="../337566/index.html">How to resurrect a jaguar for a thousand hours?</a></li>
<li><a href="../337568/index.html">SDAccel - check data transfer</a></li>
<li><a href="../337572/index.html">Open speech recognition problems. Lecture in Yandex</a></li>
<li><a href="../337576/index.html">Kibana Dashboards PDF Reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>