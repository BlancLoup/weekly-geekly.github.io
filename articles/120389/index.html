<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The hard life of anti-spam or as it actually happens</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The reason for this publication was the recent major changes made to the anti-spam mechanism in our mail service. We want to share the news, but not i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The hard life of anti-spam or as it actually happens</h1><div class="post__text post__text-html js-mediator-article">  The reason for this publication was the recent major changes made to the anti-spam mechanism in our mail service.  We want to share the news, but not in the form of a dry press release.  Therefore, we decided to talk about how AntiSpam works in Mail@Mail.Ru, and of course - with pleasure to answer your questions.  So‚Ä¶ <br><br><h2>  Anti-spam Mail.Ru architecture </h2><br>  Own antispam in Mail.Ru has existed for many years.  The desire to develop your own product is understandable, because  at a certain stage in the development of the project, the requirements for the quality and scalability of the anti-spam mechanism have become too great for even very highly customized ‚Äúalien‚Äù products to satisfy.  Of course, we still use some services and components of independent suppliers (for example, to check emails for a virus component), but their role is no longer decisive. <br><a name="habracut"></a><br>  The requirements for our own anti-spam were very clear and logical - maximum speed and accuracy of response.  Of course, there is no limit to perfection, the relations of spammers with their opponents represent the eternal struggle of shield and sword.  But now we can confidently say that we have seriously advanced towards our cherished goal and continue to increase the ‚Äúmomentum‚Äù. <br><br>  <b>So, how does it look and work - is the modern antispam of Mail@Mail.Ru?</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, even on the ‚Äúapproach‚Äù to mail servers, all senders are checked against the base of IP addresses seen in spam mailings.  The database is dynamically updated in real time: some IPs are ‚Äúwhitewashed‚Äù, others are on the ‚Äúblack list‚Äù.  Accordingly, letters from IP-addresses with a ‚Äútarnished‚Äù reputation are not accepted - this way we manage to cut off most of the botnets. <br><br>  If the sender's IP is not on the blacklist, the email is received by the server and tested by two anti-spam systems: Kaspersky Anti-Spam (or KAS for short) and the spam filtering system (Mail.Ru Anti-Spam) developed by Mail.Ru.  These two systems always work in parallel. <br><br>  The name MRAS appears, in particular, in the service headlines of almost every letter passing through Mail.Ru.  For example, the title ‚ÄúX-Mras: Ok‚Äù says that no spam signatures were found in this letter. <br><br>  When choosing the MRAS architecture, we used the most common approach: collecting samples of spam letters, analyzing them, and generating signatures.  To put it simply, the signature is a piece of meaningful information in the letter: a phone number, a link, a characteristic phrase or a keyword, etc.  Evaluation of a letter in the MRAS is made according to signatures according to a simple logic: if the letter contains signatures characteristic of spam mailings, then most likely this letter is spam. <br><br>  Separately, it is worth noting the system of recognition of graphic spam.  Each picture that comes in the letter is analyzed and also decomposed into signatures that participate in the decision making.  For example, antispam confidently determines the phone numbers and addresses of sites written graphically, and the algorithm even works with distorted and noisy images. <br><br>  In addition to the signatures in the MRAS, there are so-called rules that describe more complex logic.  Using the rules in MRAS, you can create filters that take into account the multiple characteristics of messages, including service headers, image parameters, format or link patterns, frequency and reputational characteristics of any entity in the message, etc. <br><br>  When we chose the engine for the implementation of the rules, various options were discussed.  The main requirements were: high performance, syntax flexibility and easy extensibility.  Found that the above conditions correspond to the embedded interpreter language Lua.  As a result, we got a powerful and flexible tool that was useful not only for creating rules.  Now with the help of Lua-scripts in MRAS a significant part of business logic is implemented, for example, mechanisms for parsing images and frequency shingles, various reputation mechanisms. <br><br><h2>  Where does MRAS find out about spam e-mails? </h2><br>  There are several sources of spam samples for MRAS.  The main source are complaints from users who click the "This is spam" button in the web-based mail interface.  They are grouped, automatically filtered and then entered into the decision-making system. <br><br>  Another of the most important sources are trap boxes - specially registered and ‚Äúlit‚Äù boxes on the Internet, where only spam gets.  Outwardly, they look like the boxes of ordinary users - these can be accounts in My World and other social networks, posts on forums and guest books, etc.  Unscrupulous mailers who compile a database of addresses on the Internet are more likely to hook several ‚Äútraps‚Äù ‚Äîand when they receive a letter, it will most certainly serve as the basis for spam signatures. <br><br>  Finally, at the third stage, there is a group of analysts from Pochty@Mail.Ru, who analyze real-time complaints received from users about emails, possibly being spam, the content of ‚Äútrap‚Äù boxes, in 24x7 mode. <br><br>  Next - what happens to the letter at the exit of the MRAS?  Having worked out significant signatures of letters, at the exit MRAS gives the letter a final assessment, which can take one of three values: <br><ol><li>  the letter is not spam </li><li>  the letter is probably spam </li><li>  the letter is exactly spam. </li></ol>  The same estimates are issued by KAS.  If both anti-spam systems consider a letter to be good - the letter is sent to the Inbox folder, if one or both systems have marked the letter as possible spam, then to the Spam folder.  If at least one of the systems is sure that the letter is spam, then such a letter does not reach the user, and the sender leaves a bounce message. <br><br>  It is important to note that the same system also processes outgoing mail from Mail.Ru servers.  So if a user tries to send a spam letter, he receives a notification that the message cannot be sent. <br><br>  It is interesting to note that MRAS checks the letter not only at the entrance, but also some time after it has entered the user box - this is due to the fact that new data on spam mailings could change the situation and, accordingly, the opinion of the system.  Therefore, if at the moment when the letter was processed by MRAS, it was not detected as spam, and after a few minutes it was already determined, MRAS shifts the letter from the Inbox to the Spam folder.  Naturally, this happens strictly before the user went to the Inbox and saw the letters. <br><br>  All that was said above is an automatic spam filtering system that works for all users.  However, different users have different preferences, so recently we introduced an individual (personal) component of spam filtering. <br><br><h2>  What's new? </h2><br>  It is no secret that with the mass distribution of social networks, online games, online stores and other services that are actively communicating with their audience via e-mail, mountains of various notifications began to accumulate in user boxes.  And our research shows that for modern users, spam is far from being just a mass mailing about ‚Äúprinting business cards‚Äù, ‚Äúgreen cards‚Äù or ‚Äúincreasing oneself.‚Äù  People consider spam to be any unwanted email, be it a boring mailing with an opaque unsubscribe or a long time uninteresting Internet service, which with enviable regularity falls into the Inbox. <br><br>  According to the internal statistics of Mail.Ru, users daily receive several dozens of various newsletters from social networks, stores and Internet services.  An advanced user easily avoids the accumulation of mailings in the "Inbox" using filters or blacklists.  In order to make life easier for all other users, we have implemented personal antispam. <br><br>  Now, any user can, in one click, once and for all get rid of the annoying Internet service, social network or store distribution ‚Äî that is,  quite legitimate services.  It is enough to select one unnecessary letter and click the ‚ÄúThis is spam‚Äù button, after which all letters from this sender will be sent to the ‚ÄúSpam‚Äù folder.  And of course, this will not affect the delivery of emails to other users, in this case, it‚Äôs all about the individual customization of the anti-spam mechanism ‚Äúfor yourself‚Äù. <br><br>  By the way, the ‚ÄúThis is spam‚Äù button has a antipode, without which the mechanism of personal anti-spam would not be complete.  The ‚ÄúThis is not spam‚Äù button, available for emails from the ‚ÄúSpam‚Äù folder, allows you to move an email to the Inbox that has entered Spam by mistake and ‚Äúwhitewash‚Äù the sender's address.  In the future, all letters from this sender will be sent to the Inbox. <br><br>  Of course, in reality everything is somewhat more complicated.  When forming individual black and white lists, we take into account not only the address of the sender, but also other parameters of the letter.  Otherwise, we would have done too nicely to spammers who fake the From header;) <br><br>  And of course, in addition to replenishing individual spam filters, pressing the ‚ÄúThis is spam‚Äù and ‚ÄúThis is not spam‚Äù buttons is also used to train general antispam.  So, by pressing these buttons, the user does better not only for himself, but for all other users. <br><br><h2>  Interesting facts and figures </h2><br>  The very first days after the launch of personal anti-spam showed that this feature greatly simplifies the lives of users.  By the end of the first week of personal anti-spam, more than 1,000,000 emails per day began to be sent to spam ‚Äî and, of course, these were mostly social network notifications. <br><br>  We were interested to analyze what other users send letters to the "Spam".  Here is the distribution: <br><br><img src="https://habrastorage.org/storage/fde9831c/3126079b/251b32a0/2d395c9e.jpg"><br><br>  By the way, as one would expect, users click the ‚ÄúThis is not spam‚Äù button 10‚Äì20 times less frequently than ‚ÄúThis is spam‚Äù. <br><br><h2>  And finally ... how to send mail;) </h2><br>  Many of you have a direct relationship to web development and, in one way or another, send emails to your users.  To ensure that your letters are delivered safely, we have formulated recommendations for senders.  Their implementation, of course, is not strictly necessary, but makes the world a better place;) General recommendations are at <a href="http://help.mail.ru/mail-help/rules/general">http://help.mail.ru/mail-help/rules/general</a> , and more specific technical requirements are located at <a href="http://help.mail.ru/mail-help/rules/technical">http: / /help.mail.ru/mail-help/rules/technical</a> . <br><br>  The main task of the mail is to deliver letters to its users.  Therefore, we diligently deal with the false positives of the anti-spam when they occur.  If your letters do not reach users, write to abuse@corp.mail.ru.  In order to understand the problem, you need to attach a full copy of the letter that you sent (with all service headers), as well as a non-delivery reply (also completely). <br><br>  I would like to pay special attention to the mechanisms that are designed to compensate for the shortcomings of the e-mail transmission protocols.  This is about specifying the correct SPF records and especially about signing each message with the help of DKIM, which was not once <a href="http://habrahabr.ru/search/%3Fq%3Ddkim">written in Habr</a> . <br><br>  In fact, if all honest senders use these approaches, the world spam situation will drastically improve.  Therefore, we urge you to introduce these technologies sooner, especially since it is quite simple to <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch54.html">configure</a> (for example, the documentation for <a href="http://www.exim.org/exim-html-current/doc/html/spec_html/ch54.html">configuring DKIM in Exim</a> or one of the <a href="http://www.opendkim.org/">DKIM</a> implementations <a href="http://www.opendkim.org/">for postfix</a> ). <br><br>  Sergey Martynov, <br>  Head of Mail@Mail.Ru </div><p>Source: <a href="https://habr.com/ru/post/120389/">https://habr.com/ru/post/120389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120383/index.html">Features of national automation MS Excel</a></li>
<li><a href="../120384/index.html">3D illusions</a></li>
<li><a href="../120386/index.html">Blackberry Playbook interaction with Blackberry phone</a></li>
<li><a href="../120387/index.html">Application of SharePoint in the Russian web development market</a></li>
<li><a href="../120388/index.html">PDF generation with Prawn</a></li>
<li><a href="../120391/index.html">iPADrom - S03E05. IPad software review</a></li>
<li><a href="../120393/index.html">10 gigabit link at home?</a></li>
<li><a href="../120394/index.html">About certification: catch up to the global price increase</a></li>
<li><a href="../120395/index.html">Yandex.Money now allows you to delete the old account and create a new</a></li>
<li><a href="../120396/index.html">C / C ++. Command line parsing method</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>