<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Color Deconvolution at Wolfram Mathematica</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I was inspired to write this note by a recent article about monkeys gut . Since the Chukchi is not a reader, the Chukchi is a writer, I decided to try...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Color Deconvolution at Wolfram Mathematica</h1><div class="post__text post__text-html js-mediator-article">  I was inspired to write this note by a recent <a href="http://habrahabr.ru/post/265961/">article about monkeys gut</a> .  Since the Chukchi is not a reader, the Chukchi is a writer, I decided to try to do this myself.  Moreover, the task does not seem complicated and a lot of code is not required. <br><br><img src="https://habrastorage.org/files/642/e9d/77b/642e9d77b0b14caaa5aaeeca2f67d3a5.jpg" alt="image"><br><br>  The simplest algorithm that comes to mind is: <br><ul><li>  We define several basic colors of the picture.  RGB components of these colors will be used as basis vectors. </li><li>  The color of each pixel is decomposed into a linear combination of basic. </li><li>  Display an image for each base color. </li><li>  Self-esteem automatically rises. </li></ul><br>  Further, in more detail on each item. <br><a name="habracut"></a><br><h4>  Base colors </h4><br>  Basic colors are simply the average colors of the image segments.  Segmentation algorithms - the sea is bottled, choose to taste, some are <a href="http://reference.wolfram.com/language/ref/ClusteringComponents.html%3Fq%3DClusteringComponents">implemented in Mathematica</a> .  At once I will say that little depends on the choice of the segmentation algorithm, the main thing is that the number of clusters coincide with the desired number of components: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs">original = Import[<span class="hljs-string"><span class="hljs-string">"https://hsto.org/files/f42/962/1c5/f429621c55cd46a1beb4d4eb5aefed53.jpg"</span></span>]; sizeX = First@ImageDimensions[original]; clusters = ClusteringComponents[ original, <span class="hljs-number"><span class="hljs-number">3</span></span>, Method -&gt; <span class="hljs-string"><span class="hljs-string">"KMeans"</span></span>, DistanceFunction -&gt; CosineDistance ];</code> </pre> <br>  Another simple function that we need, <code>minIndex</code> , returns the position of the minimum element in the list, that is, the compiled substitution <code>Composition[First, Ordering]</code> : <br><div class="spoiler">  <b class="spoiler_title">not for the sake of truth, but for the sake of truth</b> <div class="spoiler_text"><pre> <code class="cpp hljs">minIndex = Compile[ { {<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>, _Real, <span class="hljs-number"><span class="hljs-number">1</span></span>} }, Module[ { i = <span class="hljs-number"><span class="hljs-number">0</span></span>, min = <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>[[<span class="hljs-number"><span class="hljs-number">1</span></span>]], minPos = <span class="hljs-number"><span class="hljs-number">1</span></span> }, Do[ If[<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>[[i]] &lt; min, minPos = i; min = <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>[[i]]], {i, <span class="hljs-number"><span class="hljs-number">1</span></span>, Length@<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>} ]; minPos ], CompilationTarget -&gt; <span class="hljs-string"><span class="hljs-string">"C"</span></span> ];</code> </pre><br></div></div><br>  Now the function that returns the basis vectors.  <code>removeDarkest</code> removes the darkest color - this is the background, we do not need it: <br><br><pre> <code class="cpp hljs">removeDarkest[list_] := Delete[<span class="hljs-built_in"><span class="hljs-built_in">list</span></span>, minIndex[Norm /@ <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>]] getBasisColors[image_, clusters_] := Module[ { data = ImageData[image], components = Union[Flatten @ clusters] }, Table[ Median[Join @@ Pick[data, clusters, component]], {component, components} ] ]</code> </pre><br>  Running ... <br><br><pre> <code class="cpp hljs">B1 = removeDarkest@getBasisColors[ColorNegate@original, clusters]</code> </pre><br><div class="spoiler">  <b class="spoiler_title">and voila:</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/fa8/bfc/364/fa8bfc364cac40b496d7b267a56ec1ca.PNG" alt="image"><br></div></div><br>  And no, wait, not voila.  There is no point in decomposing a picture into such basic vectors: the resulting components will more or less repeat the clusters.  Here is the moment of truth, i.e.  the only inevitable heuristic step.  In order for the components of the picture to be more complete, it is necessary to push the base vectors a little bit. <br><br>  If we want to subtract vector <i>b</i> from vector a <i>and</i> want to keep the components of the vector positive, then the maximum we can do is <i>c</i> = <i>a</i> - min ( <i>a</i> <sub>i</sub> / <i>b</i> <sub>i</sub> ) <i>b</i> .  In this case, one of the components <i>c</i> will vanish.  Naturally, we do not want to push so much.  Just subtract the first from the second: <br><br><pre> <code class="cpp hljs">alpha = <span class="hljs-number"><span class="hljs-number">0.5</span></span>; basis = {B1[[<span class="hljs-number"><span class="hljs-number">1</span></span>]], B1[[<span class="hljs-number"><span class="hljs-number">2</span></span>]] - alpha Min[B1[[<span class="hljs-number"><span class="hljs-number">2</span></span>]]/B1[[<span class="hljs-number"><span class="hljs-number">1</span></span>]]] B1[[<span class="hljs-number"><span class="hljs-number">1</span></span>]]}; metric = Outer[Dot, basis, basis, <span class="hljs-number"><span class="hljs-number">1</span></span>];</code> </pre><br>  You can, for example, subtract the average vector from all, it does not matter, the main thing is to somehow increase the angle between vectors.  Freedom in this step is the inevitable payment for the uncertainty of the task.  The coefficient 0 &lt; <code>alpha</code> &lt;1 is the only fitting parameter of the algorithm.  For example, in order to get a picture at the beginning of the post, I had to put <code>alpha</code> = 0.95. <br><br>  The <code>metric</code> matrix is ‚Äã‚Äãthe metric of the linear envelope of the basis vectors, it is the Gram matrix, which we need in the next section. <br><br><h4>  Basis decomposition </h4><br>  Base decomposition is a standard procedure.  The only subtlety: from the formulation of the problem, it is clear that the coefficients of the decomposition should be positive.  The linear span of a set of vectors with positive coefficients is an infinite simplex (a pyramid whose vertex rests on the origin, and the base is carried away to infinity).  The edges of this simplex are simplices of smaller dimension.  All we need is to project the given vector onto the simplex.  If the vector falls inside the simplex (all expansion coefficients over the basis are positive), then the problem is solved, if not, then it is necessary to project on the face. <br><br>  Here is the whole function: <br><br><div class="spoiler">  <b class="spoiler_title">Smooth long only because of my style to write code.</b> <div class="spoiler_text"><pre> <code class="cpp hljs">reduceMetric = Compile[ { {metric, _Real, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {index, _Integer} }, Transpose@Delete[Transpose@Delete[metric, index], index], CompilationTarget -&gt; <span class="hljs-string"><span class="hljs-string">"C"</span></span> ]; getComponents = Compile[ { {vec, _Real, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {basis, _Real, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {metric, _Real, <span class="hljs-number"><span class="hljs-number">2</span></span>} }, Module[ { covariant, contravariant = Table[<span class="hljs-number"><span class="hljs-number">0.</span></span>, {Length[basis]}], flag = True, subspace }, covariant = basis.vec; flag = If[ Det[metric] != <span class="hljs-number"><span class="hljs-number">0</span></span>, contravariant = Inverse[metric].covariant; FreeQ[Sign[contravariant], <span class="hljs-number"><span class="hljs-number">-1</span></span>], False ]; Chop@If[ flag, contravariant, subspace = Table[ Insert[ getComponents[vec, Delete[basis, i], reduceMetric[metric, i]], <span class="hljs-number"><span class="hljs-number">0.</span></span>, i], {i, <span class="hljs-number"><span class="hljs-number">1</span></span>, Length@basis} ]; subspace[[minIndex[-(subspace.covariant)]]] ] ], { {_minIndex, _Integer}, {_reduceMetric, _Real, <span class="hljs-number"><span class="hljs-number">2</span></span>}, {_getComponents, _Real, <span class="hljs-number"><span class="hljs-number">1</span></span>} }, CompilationTarget -&gt; <span class="hljs-string"><span class="hljs-string">"C"</span></span>, RuntimeAttributes -&gt; {Listable}, Parallelization -&gt; True ]</code> </pre><br></div></div><br>  Checking what works correctly: <br><br><pre> <code class="cpp hljs">getComponents[{<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.9</span></span>}.basis, basis, metric] {<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.9</span></span>}</code> </pre><br>  Below are comments for those who want to understand the code.  The coefficients of the expansion of the vector <i><b>v</b></i> in the basis of <i><b>e</b> <sub>(i)</sub></i> are called contravariant coordinates <i><b>v</b></i> = <i>v <sup>i</sup></i> <i><b>e</b> <sub>(i)</sub></i> .  First of all, we calculate the covariant coordinates <i>v <sub>i</sub></i> = ( <i><b>e</b> <sub>(i)</sub></i> , <i><b>v</b></i> ).  If the metric <i>g <sub>ij</sub></i> = ( <i><b>e</b> <sub>(i)</sub></i> , <i><b>e</b> <sub>(j)</sub></i> ) is reversible, then the contravariant coordinates are calculated by the inverse metric <i>g <sup>ij</sup></i> = ( <i>g</i> <sup>‚àí1</sup> ) <i><sub>ij</sub></i> , i.e.  <i>v <sup>i</sup></i> = <i>g <sup>ij</sup></i> <i>v <sub>j</sub></i> .  That's all.  Flag <code>flag = False</code> generated in two cases: the metric is irreversible (simplex of a smaller dimension than we thought) or at least one of the contravariant coordinates is negative (did not fall inside the simplex).  In these cases, stupidly recursively iterate over all faces, and choose the projection on which is maximum.  The projection onto the subspace of the basis <i>e <sub>(i)</sub></i> is a convolution of covariant and contravariant coordinates <i>v <sub>i</sub> v <sup>i</sup></i> .  Now for sure. <br><br><h4>  results </h4><br>  Although all functions are compiled in C, Mathematica stubbornly does not want to run <code>getComponents</code> on several cores.  Understand laziness, let it remain on the conscience of developers.  So just grind all 2736000 pixels: <br><br><pre> <code class="cpp hljs">pixels = Join @@ ImageData[ColorNegate@original]; components = Table[ getComponents[pixel, basis, metric], {pixel, pixels} ];</code> </pre><br>  First component: <br><pre> <code class="cpp hljs">data1 = (({<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>} #).basis) &amp; /@ components; ColorNegate[Image@Partition[data1, sizeX]]</code> </pre><br><img src="https://habrastorage.org/files/68c/5a4/6c1/68c5a46c187a49f9ac4046f2e4e4e49d.jpg" alt="image"><br><br>  The second component: <br><pre> <code class="cpp hljs">data2 = (({<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>} #).basis) &amp; /@ components; ColorNegate@Image@Partition[data2, sizeX]</code> </pre><br><img src="https://habrastorage.org/files/a26/274/8c0/a262748c047a439ea47a9ae542ae942f.jpg" alt="image"><br><br><h4>  Can I have more? </h4><br>  Can.  Shove in <code>getComponents</code> any, even degenerate / redundant basis, and you will be happy: <br><pre> <code class="cpp hljs">Module[ { basis = {{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>}}, metric }, metric = Outer[Dot, basis, basis, <span class="hljs-number"><span class="hljs-number">1</span></span>]; getComponents[{<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.</span></span>, <span class="hljs-number"><span class="hljs-number">0.9</span></span>}.basis, basis, metric] ] {<span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-number"><span class="hljs-number">0.</span></span>, <span class="hljs-number"><span class="hljs-number">0.9</span></span>}</code> </pre><br>  Download the Mathematica file <a href="https://goo.gl/egkOoI">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/266101/">https://habr.com/ru/post/266101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266091/index.html">We integrate Paypal payment into web-application</a></li>
<li><a href="../266093/index.html">Healthcare IT: or how to exceed the budget by 420%</a></li>
<li><a href="../266095/index.html">How many downloads do you need for the TOP-10 free games of the App Store</a></li>
<li><a href="../266097/index.html">Script to calculate the space occupied by Hyper-V virtual machines</a></li>
<li><a href="../266099/index.html">Intel invites to Droidcon. Moscow, September 25-27</a></li>
<li><a href="../266103/index.html">Akka, actors and reactive programming</a></li>
<li><a href="../266105/index.html">Autumn Rambler.iOS Meeting</a></li>
<li><a href="../266107/index.html">3CX API - what are they and what to do with them? Third Party Plugins (Part 2)</a></li>
<li><a href="../266109/index.html">GPS service ViaLatM - scripting language</a></li>
<li><a href="../266111/index.html">Large-scale migration of records in the database: how it does Stripe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>