<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Download photos from Instagram using the Vkontakte bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this post, we‚Äôll write a Vkontakte bot that accepts a link to a photo from Instagram, and sends the photo back. 


 We create a group in Vkontakte ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Download photos from Instagram using the Vkontakte bot</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/08e/8bf/3f7/08e8bf3f7c5043a79a9e7b842461ad3a.jpg"></p><br><p>  In this post, we‚Äôll write a Vkontakte bot that accepts a link to a photo from Instagram, and sends the photo back. </p><a name="habracut"></a><br><p>  <a href="https://vk.com/groups">We create a group</a> in Vkontakte and in the community settings we include the messages: <br>  <em>"Community Management" - "Messages".</em> </p><br><h3 id="dlya-nachala-poprobuem-sozdat-eho-bota">  To begin, try to create an "echo-bot." </h3><br><p>  You will need the following libraries to work. </p><br><pre><code class="bash hljs">falcon==1.2.0 gunicorn==19.7.1 py-vkontakte==5.53.4 requests==2.18.3</code> </pre> <br><p>  We need to get TOKEN, with which we can send messages on behalf of the community: </p><br><p>  <em>"Community Management" - "Settings" - "Working with API" - "Access Keys"</em> . </p><br><p><img src="https://habrastorage.org/web/62c/1c7/dc1/62c1c7dc1de449a393bbe8b96203cc19.png"></p><br><p>  You can receive new messages in two ways: "Callback API" or "Long Poll". <br>  Will use the "Callback API". </p><br><p>  "Callback API" sends data in json-format. </p><br><pre> <code class="hljs json">{   <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"message_new"</span></span>,   <span class="hljs-attr"><span class="hljs-attr">"object"</span></span>:{      <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,      <span class="hljs-attr"><span class="hljs-attr">"date"</span></span>:<span class="hljs-number"><span class="hljs-number">1499441696</span></span>,      <span class="hljs-attr"><span class="hljs-attr">"out"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,      <span class="hljs-attr"><span class="hljs-attr">"user_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,      <span class="hljs-attr"><span class="hljs-attr">"read_state"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,      <span class="hljs-attr"><span class="hljs-attr">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">" ... "</span></span>,      <span class="hljs-attr"><span class="hljs-attr">"body"</span></span>:<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>   },   <span class="hljs-attr"><span class="hljs-attr">"group_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-attr"><span class="hljs-attr">"secret"</span></span>:<span class="hljs-string"><span class="hljs-string">"111111"</span></span> }</code> </pre> <br><p>  In the "Callback API" you must specify the server address.  We will use <a href="https://falcon.readthedocs.io/">falcon</a> as a server </p><br><p>  <em>"Community Management" - "Settings" - "Working with API" - "Callback API".</em> </p><br><p><img src="https://habrastorage.org/web/60c/eee/912/60ceee9121804260a158e7e3bc168488.png"></p><br><p><img src="https://habrastorage.org/web/e27/580/8e1/e275808e1b2a46c4b56863da83d8a02b.png"></p><br><p>  Confirm the server for the "Callback API": </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> falcon GROUP_ID = <span class="hljs-string"><span class="hljs-string">"YOUR GROUP ID"</span></span> CONFIRMATION = <span class="hljs-string"><span class="hljs-string">"YOUR CONFIRMATION CODE"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, resp)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req.content_length: data = json.loads(req.stream.read()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">"confirmation"</span></span> == data.get(<span class="hljs-string"><span class="hljs-string">"type"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> GROUP_ID == data.get(<span class="hljs-string"><span class="hljs-string">"group_id"</span></span>): resp.data = CONFIRMATION application = falcon.API() application.add_route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, Bot())</code> </pre> <br><p>  Now we will write a handler for receiving new messages and sending them.  To send a message will use the library <a href="https://github.com/sgaynetdinov/py-vkontakte">py-vkontakte</a> . </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># .... import vk api = vk.Api(TOKEN) #     group = api.get_group(GROUP_ID) class Bot(object): def on_post(self, req, resp): # .... user_id = data.get('object').get('user_id') text = data.get('object').get('body') if "message_new" == data.get("type"): group.send_message(user_id, text) resp.data = b"ok" # ....</span></span></code> </pre> <br><p>  In order to send Vkontakte that we have successfully read the message, you need to send the string "ok". </p><br><p>  "Echo-bot" is ready to run it </p><br><pre> <code class="bash hljs">gunicorn bot:application</code> </pre> <br><h3 id="pishem-bota-kotoryy-otpravlyaet-fotografii-iz-instagram">  We write a bot that sends photos from Instagram </h3><br><p>  The <a href="https://www.instagram.com/developer/embedding/">Instagram</a> documentation says that if you add <strong>/ media</strong> to <em><a href="https://instagram.com/p/fA9uwTtkSN/">https://instagram.com/p/fA9uwTtkSN/</a></em> , then the JPG file will return. </p><br><p>  To begin, we will write a function that will verify that the message sent by the user is a link to the Instagram website. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib.parse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlsplit <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_instagram_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, link)</span></span></span><span class="hljs-function">:</span></span> url = urlsplit(link) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> url.netloc <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">"www.instagram.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"instagram.com"</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p>  Let's write a function that adds to the <em>/ media</em> link and downloads this jpg </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib.parse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urljoin <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_instagram_photo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, instagram_photo_link)</span></span></span><span class="hljs-function">:</span></span> url = urljoin(instagram_photo_link, <span class="hljs-string"><span class="hljs-string">'media/?size=l'</span></span>) response = requests.get(url) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> response.ok: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> ValueError() file_like = (<span class="hljs-string"><span class="hljs-string">'photo.jpg'</span></span>, io.BytesIO(response.content)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> file_like</code> </pre> <br><p>  <em><u>? size = l</u></em> is a parameter that indicates the size of the returned jpg <br>  <em><u>if not response.ok:</u></em> - the link may not be correct, we need to check it <br>  <em><u>file_like = ('photo.jpg', io.BytesIO (response.content))</u></em> - we prepare the received JPG for sending </p><br><p>  Add <code>is_instagram_link</code> and <code>get_instagram_photo</code> to the <code>class Bot</code> and change the logic of work, when a new message arrives send JPG. </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_post</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, req, resp)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># .... if "message_new" == data.get("type"): if not self.is_instagram_link(message_text): group.send_messages(user_id, message='      instagram.com') else: try: instagram_photo = self.get_instagram_photo(instagram_photo_link=message_text) group.send_messages(user_id, image_files=[instagram_photo]) except ValueError: group.send_messages(user_id, message='   ,   ') resp.data = b'ok' # ....</span></span></code> </pre><br><p>  <a href="https://vk.com/instasave_bot">Bot work example</a> <br>  <a href="https://github.com/sgaynetdinov/instasave_bot">Source</a> </p><br><p>  Additional links: </p><br><ul><li>  <a href="https://github.com/sgaynetdinov/py-vkontakte">https://github.com/sgaynetdinov/py-vkontakte</a> </li><li>  <a href="https://vk.com/dev/bots_docs">https://vk.com/dev/bots_docs</a> </li><li>  <a href="https://www.instagram.com/developer/embedding/">https://www.instagram.com/developer/embedding/</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335828/">https://habr.com/ru/post/335828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335816/index.html">Computer networks for dummies</a></li>
<li><a href="../335818/index.html">Yamichat - customizable chat bot and online consultant in one platform</a></li>
<li><a href="../335820/index.html">Modern methods of web application security research</a></li>
<li><a href="../335824/index.html">The second edition of the book "Learning Python. Game programming, data visualization, web applications</a></li>
<li><a href="../335826/index.html">How hackers prepare attacks on banks</a></li>
<li><a href="../335830/index.html">On the quality of requirements in IT projects, to be honest (from the standpoint of the development team). Part 1</a></li>
<li><a href="../335834/index.html">DDD in practice. Design a wish list</a></li>
<li><a href="../335836/index.html">How to write normal texts in English, not being a native speaker</a></li>
<li><a href="../335838/index.html">Overview of C ++ deep learning libraries Apache.SINGA, tiny-dnn, OpenNN</a></li>
<li><a href="../335840/index.html">Random RPG damage distribution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>