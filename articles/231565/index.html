<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mikrotik: automatic channel switching to backup and back</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Write this post I was prompted by the situation with the disconnection of one of the Internet channels. 
 In the Internet itself, there are many answe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mikrotik: automatic channel switching to backup and back</h1><div class="post__text post__text-html js-mediator-article">  Write this post I was prompted by the situation with the disconnection of one of the Internet channels. <br>  In the Internet itself, there are many answers on this question, but not everyone is a worker. <br><br>  What I wanted to do if the main channel of the Internet is turned off: <br>  1. Switch to the backup channel (after the "appearance", of course, return to the main one); <br>  2. Send an email notification of the status change. <br><br>  Who cares, I ask under the cat. <br><a name="habracut"></a><br>  We are given: <br>  - Mikrotik RB450G with firmware version 5.19; <br>  - 2 Internet ports, one of which uses a PPPoE connection to connect. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First, add 2 scripts, one of which will switch to the backup channel, and the second will return the connection to the first one. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c7a/6b1/2a6/c7a6b12a60b67462b13eae1c04e5954d.jpg" alt="image"><br><br>  We create the first script that will activate the backup channel and call it " <b>change-to-reserv</b> " and contain the code: <br><pre><code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gateway=1.1.1.1 [find dst-address=0.0.0.0/0];</code> </pre> <br>  <i>(Note: IP address 1.1.1.1 is chosen as an example and symbolizes the backup channel)</i> <br>  That is, when detecting the absence of ping to the server (more on this later), we will turn off the route with the gateway pointing to " <b>pppoe-main</b> ". <br>  PS: After the comment <a href="http://habrahabr.ru/users/erazel/" class="user_link">erazel,</a> this scheme was improved, namely, the earlier script switched between two routes that failed, namely, if you run the command from the computer, for example, <b>ping google.com -t</b> , then when you change the route, the ping will go to the old interface, because the translation has not been updated.  In the proposed method of changing only the gateway, translation cleaning is not required. <br><br>  The next line in the same script will indicate: <br><br><pre> <code class="bash hljs">/tool e-mail send server=192.168.1.1 port=25 user=robot@mysite.ru password=1PaSsW0rD1 tls=no to=admin@mysite.ru from=<span class="hljs-string"><span class="hljs-string">"ROBOT&lt;robot@mysite.ru&gt;"</span></span> \ subject=<span class="hljs-string"><span class="hljs-string">"MikroTik: $[/system clock get date], $[/system clock get time]"</span></span> \ body=<span class="hljs-string"><span class="hljs-string">"   \n: $[/system clock get date]\nA: $[/system clock get time]"</span></span>;</code> </pre> <br>  Where: <br>  <b>/ tool e-mail send</b> - send a notification to the administrator‚Äôs email about the status change <br>  <b>server = 192.168.1.1</b> - SMTP server.  Since we use our own, I point it out; <br>  <b>port = 25</b> - in the version of RouterOS 5.x, the port is specified separately.  In our case, it is by default 25; <br>  <b>user=robot@mysite.ru</b> - user login for authorization on the SMTP server (if required); <br>  <b>password = 1PaSsW0rD1</b> - specify the password (if required); <br>  <b>tls = no</b> - TLS traffic encryption.  We don‚Äôt, put ‚Äúno‚Äù, and if it will be - ‚Äúyes‚Äù; <br>  <b>to=admin@mysite.ru</b> - to which email address the notification will be <b>sent</b> ; <br>  <b>from = ‚ÄúROBOT &lt;robot@mysite.ru&gt;‚Äù</b> - from whom the notification will come (in my case it is the authorization login. In brackets indicate the sender's address, and the name displayed in the incoming mail); <br>  <b>subject = "MikroTik: $ [/ system clock get date], $ [/ system clock get time]"</b> - specify the message header.  In this case, it will look like <b>‚ÄúMikroTik: jul / 30/2014, 10:52:13‚Äù</b> (date and time of sending the message); <br>  <b>body = "Switch to backup channel \ nDate: $ [/ system clock get date] \ nATime: $ [/ system clock get time]";</b>  - accordingly, the message body itself, which will look like: <br><blockquote>  Switching the line to the backup channel <br>  Date: jul / 30/2014 <br>  Time: 10:52:13 </blockquote><br>  As a result, our script will look like (RouterOS 5.19): <br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gateway=1.1.1.1 [find dst-address=0.0.0.0/0]; /tool e-mail send server=192.168.1.1 port=25 user=robot@mysite.ru password=1PaSsW0rD1 tls=no to=admin@mysite.ru from=<span class="hljs-string"><span class="hljs-string">"ROBOT&lt;robot@mysite.ru&gt;"</span></span> \ subject=<span class="hljs-string"><span class="hljs-string">"MikroTik: $[/system clock get date], $[/system clock get time]"</span></span> \ body=<span class="hljs-string"><span class="hljs-string">"   \n: $[/system clock get date]\nA: $[/system clock get time]"</span></span>;</code> </pre> <br><br>  And for RouterOS 6.17: <br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gateway=1.1.1.1 [find dst-address=0.0.0.0/0]; /tool e-mail send server=192.168.1.1 port=25 user=robot@mysite.ru password=1PaSsW0rD1 to=admin@mysite.ru from=<span class="hljs-string"><span class="hljs-string">"ROBOT&lt;robot@mysite.ru&gt;"</span></span> \ subject=<span class="hljs-string"><span class="hljs-string">"MikroTik: $[/system clock get date], $[/system clock get time]"</span></span> \ body=<span class="hljs-string"><span class="hljs-string">"   \n: $[/system clock get date]\nA: $[/system clock get time]"</span></span>;</code> </pre> <br><br>  As I wrote above, save it under the name " <b>change-to-reserv</b> " and proceed to writing the second script: <br><br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gateway=pppoe-main [find dst-address=0.0.0.0/0]; /tool e-mail send server=192.168.1.1 port=25 user=robot@mysite.ru password=1PaSsW0rD1 tls=no to=admin@mysite.ru from=<span class="hljs-string"><span class="hljs-string">"ROBOT&lt;robot@mysite.ru&gt;"</span></span> \ subject=<span class="hljs-string"><span class="hljs-string">"MikroTik: $[/system clock get date], $[/system clock get time]"</span></span> \ body=<span class="hljs-string"><span class="hljs-string">"   \n: $[/system clock get date]\nA: $[/system clock get time]"</span></span>;</code> </pre> <br>  Unlike the first script, in the body of the sent email-message, we will indicate ‚ÄúSwitching to the main channel‚Äù and enable the previously disabled route. <br>  Save our script as " <b>change-to-main</b> ". <br><br>  Since the memory of <b>Mikrotik is</b> not rubber, we optimize our script for the task at hand. <br>  To do this, we need to use the <b>Netwatch</b> utility, which works as a trigger.  That is, if the connection status changes, then the status will change with the execution of the scripts we need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/563/535/551/56353555109547e2f30cb576321441d6.jpg" alt="image"><br><br>  In <b>Netwatch</b> we will add a new rule, where we specify the <b>host 8.8.8.8</b> and the script names in the <b>‚ÄúUp‚Äù</b> tabs <b>- ‚Äúchange-to-main‚Äù</b> and <b>‚Äúchange-to-reserv‚Äù</b> in the <b>‚ÄúDown‚Äù</b> tab <b>,</b> respectively. <br>  You should also indicate the period of the status check.  We have <b>1 minute</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/787/85e/118/78785e1189d125b579734dba61ef7119.jpg" alt="image"><br><br>  This is followed by the final step - route forwarding.  If this is not done, the script will trigger to switch to the backup channel and remain in this position.  The reverse transition will be possible if the backup channel ‚Äúfalls‚Äù. <br><br>  In general, we add a route with the following data: <br>  <b>Dst.</b>  <b>Address = 8.8.8.8</b> // Specify that we will ping Google‚Äôs DNS server (for me it‚Äôs not critical, I‚Äôll point it out); <br>  <b>Gateway = pppoe-main</b> // That is the PPPoE connection to the main channel <br>  <b>Distance = 1</b> <br>  The remaining parameters are left as is. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4dd/11d/190/4dd11d190ad3553bda081afaddd56371.jpg" alt="image"><br><br>  Everything! <br><br>  From now on, the principle of operation is as follows: <br>  <b>Netwatch</b> through the main channel will check the ping to the Google DNS server.  As soon as the ping disappears, the " <b>change-to-reserv</b> " script specified on the " <b>Down</b> " tab is <b>executed</b> .  This script will disable the main route (PPPoE) and all packets will go through the backup channel.  As soon as the ping on the main channel resumes, the script re-activates the route of the main channel (the <b>Distance</b> parameter is, of course, ‚Äú <b>1</b> ‚Äù, and the backup parameter is ‚Äú <b>2</b> ‚Äù).  At the same time notifications will be sent to the email-address about the facts of the state change. <br><br>  Profit! <br><br>  ATTENTION!!!  For scripts running under RouterOS 6.17, you need to make changes to the script for sending an email address, namely, to remove the " <b>tls =</b> " parameter. <br>  That is, our code (for example, to switch to the backup channel) will look like: <br><br><pre> <code class="bash hljs">/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gateway=1.1.1.1 [find dst-address=0.0.0.0/0]; /tool e-mail send server=192.168.1.1 port=25 user=robot@mysite.ru password=1PaSsW0rD1 to=admin@mysite.ru from=<span class="hljs-string"><span class="hljs-string">"ROBOT&lt;robot@mysite.ru&gt;"</span></span> \ subject=<span class="hljs-string"><span class="hljs-string">"MikroTik: $[/system clock get date], $[/system clock get time]"</span></span> \ body=<span class="hljs-string"><span class="hljs-string">"   \n: $[/system clock get date]\nA: $[/system clock get time]"</span></span>;</code> </pre> <br><br>  <b>UPDATED: Changed routes in scripts</b> <br>  <b>UPDATED 2: To prevent the email address ‚Äúrobot@mysite.ru‚Äù as a sender from being displayed in the incoming mail, the ‚Äúfrom‚Äù parameter was changed (corrections with comments were made to the code above)</b> </div><p>Source: <a href="https://habr.com/ru/post/231565/">https://habr.com/ru/post/231565/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231555/index.html">Fastening the system unit to the tabletop</a></li>
<li><a href="../231557/index.html">A little sunday infographic # 2</a></li>
<li><a href="../23156/index.html">Temporary Password</a></li>
<li><a href="../231561/index.html">Extreme story about the lack of data synchronization of different services on Google without a happy ending</a></li>
<li><a href="../231563/index.html">Reset PHP cache via SQL query or from gun on sparrows</a></li>
<li><a href="../231567/index.html">Instagram presented Bolt: the fastest way to send a photo to a friend</a></li>
<li><a href="../231569/index.html">Google introduced a new home page for Docs, Spreadsheets and Presentations</a></li>
<li><a href="../23157/index.html">Why in offices do not like system administrators</a></li>
<li><a href="../231571/index.html">The British Parliament opposed the "right to be forgotten"</a></li>
<li><a href="../231573/index.html">Spaniards have built in sensors monitoring the health of car drivers in the seat belt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>