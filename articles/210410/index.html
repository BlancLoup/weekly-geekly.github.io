<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implement an L2TP / IPsec VPN server using standard Windows 7/8 tools for connecting Windows / iOS / Android systems to an internal network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I was puzzled by the search for the possibility of creating an encrypted connection to my office using the L2TP / IPsec protocol. The task b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implement an L2TP / IPsec VPN server using standard Windows 7/8 tools for connecting Windows / iOS / Android systems to an internal network</h1><div class="post__text post__text-html js-mediator-article">  <i>Recently, I was puzzled by the search for the possibility of creating an encrypted connection to my office using the L2TP / IPsec protocol.</i>  <i>The task became more complicated when, apart from Windows clients, there was a need to launch more iOS and Android clients into the network.</i>  <i>There are many articles on the Internet on how to do this on a Windows server with an ‚Äúexternal‚Äù IP address.</i>  <i>But I want to offer the community a standard implementation of the Windows 7/8 encrypted L2TP tunnel in the local network with a popular, in my opinion, topology.</i> <br><a name="habracut"></a><br><h5>  Network structure </h5><br>  A small network of ten Windows 7/8 clients with a dedicated server based on Windows Server 2008 Std (we don‚Äôt pay attention to it yet) and with access to the Internet using a simple router.  For the VPN server, I selected one of the machines on Windows 7 Pro.  Next will be described two ways to raise the L2TP / IPsec server on Windows 7 Pro. <br><br><h4>  Windows 7 L2TP / IPsec AES 128-bit using certificate </h4><br><ul><li>  <b>The first step is to generate a computer and user certificate on the VPN server.</b> <br>  To do this, we use the free utility <a href="http://simpleauthority.com/download.html">Simple Authority</a> . <br>  Install, run.  Immediately the program will offer to generate a computer certificate.  Fill in the fields.  We randomly click on the keyboard, thereby generating a random number.  Enter the password (preferably longer than 8 characters, otherwise there may be glitches) Computer Certificate (CA) is ready.  If the user is not added, then add.  On the right, fill in the required fields.  Click "New certificate".  After this, two certificate files with * .cer and * .p12 extensions will appear on the desktop. </li><li>  <b>Install certificates on our VPN server.</b> <br>  To do this, we do Win + R (‚ÄúRun‚Äù), enter mmc, press Enter.  The console will open. <br>  Add a snap (File-&gt; Add remove snap-in).  Choose "Certificates".  Click "Add".  Select the item "computer account" when it comes to the question of where this snap-in will manage the certificates.  Next, ‚ÄúPersonal‚Äù -&gt; Right-click-&gt; All Tasks-&gt; Import-&gt; Select the certificate file with the extension * .p12 (exactly it).  Enter the password, put a checkmark "Mark this key as exported."  Two certificates will appear in the ‚ÄúPersonal‚Äù category.  The certificate for which the ‚ÄúTo whom is issued‚Äù and ‚ÄúBy whom issued‚Äù fields are the same should be moved to the ‚ÄúTrusted Root Certification Authorities‚Äù category. </li><li>  <b>You need to make sure that the parameter ProhibitIpSec = 1 is not present</b> . <br>  Go to the registry (Win + R -&gt; regedit).  We are looking for the HKLM \ System \ CurrentControlSet \ Services \ Rasman \ Parameters branch.  If the above parameter is not there or it is 0, then all is well.  Otherwise, fix it. </li><li>  <b>Create an incoming connection</b> . <br>  Go to the "Network and Sharing Center" -&gt; "Change the parameters of adapters."  Hit the Alt key, the menu will pop up.  Next File -&gt; "New incoming connection".  We select the right users, put a checkbox "Via the Internet ... VPN".  We select the necessary protocols.  On TCP / IP v4-&gt; Put the checkbox "Allow access to the local network" and be sure to set the pool of addresses issued to the client.  After creating a connection, be sure to open its properties and in the "Users" tab, check the presence of the checkbox "Users must keep passwords secret" </li><li>  <b>Check</b> if the ports we need are open.  Open the command prompt and use the <b>netstat / a / p udp</b> command to see if UDP 1701 UDP 4500 UDP 500 has opened. </li></ul><br><h5>  Creating a client connection for this method </h5><br><ul><li>  <b>Install certificates on our VPN client.</b>  We copy the certificates that we created earlier from the VPN server.  Install them in exactly the same way as on the server. </li><li>  <b>Let's create a VPN connection.</b>  Go to the "Network and Sharing Center" -&gt; Set up a new connection or network.  Further ‚ÄúConnection to the workplace‚Äù -&gt; Use my Internet connection.  Enter the address of our VPN server.  Connection is ready. </li><li>  <b>Let's configure our VPN connection.</b>  Username and password, I think, do not cause questions.  In the "Security" tab, select the type of VPN L2TP / IPsec and in the advanced settings select "Use certificate" and uncheck the "Check certificate name attribute" checkbox.  Encryption set Mandatory and "Permit the following protocols" authentication: MS-CHAPv2.  Next, the Network tab -&gt; TCP / IPv4 properties -&gt; Advanced -&gt; Remove the checkbox ‚ÄúUse default gateway‚Äù. </li><li>  <b>If the connection does not rise.</b>  Then on Windows 8 it is worth trying this registry key HKLM \ SYSTEM \ CurrentControlSet \ Services \ IPsec create a DWORD value with the name AssumeUDPEncapsulationContextOnSendRule and value 2. For Windows 7 / Vista, this parameter must be created in HKLM \ SYSTEM \ CurrentControlSet \ Services \ PolicyAgent </li></ul><br><h5>  The results of this method </h5><br>  For Windows clients, this is a good way to implement L2TP / IPsec, but when it comes to iOS clients, the task expands.  The problem is that iOS can connect via L2TP only with encryption using a Pre-prepared Key Phrase (Preshared Key), and the certificate can connect only to Cisco VPN.  The second way will tell how to solve this problem. <br><br><h4>  Windows 7 L2TP / IPsec Preshared Key with ESP 3DES encryption and integrity control </h4><br><ul><li>  <b>Let's return to the miracle parameter ProhibitIpSec = 1</b> .  Go to the Registry, to the HKLM \ System \ CurrentControlSet \ Services \ Rasman \ Parameters branch and create a DWORD parameter with the name ProhibitIpSec and assign it a value of 1. Then you must either reboot the OS or restart the RemoteAccess and RasMan services.  By this action, we disable the default IP local security policy for IPsec. </li><li>  <b>Now let's create a new IP security policy</b> .  ‚ÄúRun‚Äù -&gt; mmc -&gt; Add snap-in -&gt; ‚ÄúManage IP Security Policy‚Äù and select Local computer.  Further "Create IP Security Policy".  ‚ÄúNext‚Äù -&gt; Enter the name -&gt; checkbox ‚ÄúUse default rule‚Äù is not set -&gt; Next -&gt; ‚ÄúEdit properties‚Äù leave the checkbox.  The properties of the new policy will open.  Here, remove the checkbox "use the master" and "Add."  Now in order of each tab: <br><ul><li>  <b>List of IP filters.</b>  Enter the name, remove the checkbox "Isp.  master "," Add. "  Source Address: "Any."  Destination: "Any."  Tab protocol.  In the drop-down list, select UDP.  Packages FROM this port: 1701. Packages ON any port.  OK, OK and return to the list of IP-filters.  Here, the newly created filter is marked with a ‚Äúdot‚Äù and go to the next tab. </li><li>  <b>Filter action</b>  Similarly.  Name, daw about the master, "Add".  Choose "Agree on security", "Add".  Choose ‚ÄúEncryption and Ensuring Integrity.  (ESP) ".  OK.  We look, so that there are no daws below the list of security methods.  OK.  Similarly, mark the point and go to the next tab. </li><li>  <b>Type of connection.</b>  All network connections. </li><li>  <b>The parameters of the tunnel.</b>  This rule does not indicate an IPsec tunnel. </li><li>  <b>Authentication methods.</b>  Do not pay attention to Kerberos, click "Add".  Select "Use this line (Pre-key)" and enter our pre-created Key.  OK.  And now you can remove Kerberos.  In the same tab, you can add certificate authentication.  The process of generating and installing a certificate is described in the first method. </li></ul></li><li>  <b>Be sure</b> to assign a new IP security policy.  Right click on it, "Assign". </li></ul><br><h5>  Creating a client connection for this method </h5><br><ul><li>  It differs from the creation of a client connection for the first method only by the Additional L2TP / IPsec properties, where instead of using the certificate, select "... use the common key". </li></ul><br><h4>  VPN server access </h4><br>  On the router, I used the service Dynamic DNS, because  external ip dynamic.  To be able to connect, it is necessary to do port forwarding (Port Forwarding) for UDP ports 1701 UDP 4500 UDP 500 to our VPN server.  We got to the finish stage, where another big problem awaits us.  The fact is that Windows 7/8 has a limit on the maximum number of connections for remote access, and it is equal to 1. There is no such restriction on Windows Server.  Here the phrase ‚Äúsuggests why did you write all this here ?!‚Äù There are two ways to solve it.  First: one good person did some big work and wrote a patch that removes the restriction for Windows 7 Pro SP1.  <a href="http://dml.compkaluga.ru/forum/index.php%3Fs%3D%26showtopic%3D6208%26view%3Dfindpost%26p%3D28634">Here</a> the process of finding a solution is described in detail and a patch is present.  Second: use Windows Server.  But to use not in the way described in most articles, where it is said about assigning the Role ‚ÄúRouting and Remote Access‚Äù to the server and using special snap-ins in which the devil breaks his leg, but use the method described above.  It works fine on Windows Server without assigning special roles and without restrictions on the number of connections. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Recycled material: </h5><ul><li>  <a href="http://rotwhiler.wordpress.com/2009/04/09/windows-xp-pro-as-a-l2tp-ipsec-vpn-server/">Windows XP Pro as a L2TP IPSec VPN Server</a> </li><li>  <a href="http://forum.windowsfaq.ru/showthread.php%3Ft%3D165527">L2TP VPN server on Windows 7</a> </li><li>  <a href="http://support.microsoft.com/kb/240262">Configure L2TP / IPSec connections using preshared key authentication</a> </li><li>  <a href="http://technet.microsoft.com/ru-ru/library/cc736357(WS.10).aspx">The role of the remote access server or VPN server: setting up a remote access server or VPN server</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/210410/">https://habr.com/ru/post/210410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210386/index.html">What is the theory and where does the scientific method</a></li>
<li><a href="../210388/index.html">Non-standard application of IT in everyday life: parsing, perceptual hash, image comparison = cost optimization</a></li>
<li><a href="../210390/index.html">7 simple optimizations that reduce the CPU load from 80% to 27%</a></li>
<li><a href="../210406/index.html">Lexand Capella: a smartphone with Full HD-screen and support for two SIM-cards for 9,600 rubles ($ 280)</a></li>
<li><a href="../210408/index.html">Forgotten zoom</a></li>
<li><a href="../210412/index.html">The legacy of Konrad Zuse: Architecture Z1 and Z3 [Translation]</a></li>
<li><a href="../210416/index.html">Clear cookies</a></li>
<li><a href="../210418/index.html">Accident Alert Info Panel Project (Part 1)</a></li>
<li><a href="../210420/index.html">We write monitoring the availability of tickets for Russian Railways</a></li>
<li><a href="../210422/index.html">We try Audio API on an example of writing a visualizer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>