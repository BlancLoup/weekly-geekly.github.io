<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>STM32 and FreeRTOS. 4. Step toward HAL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HAL 9000: I'm perfectly functioning.  or it should be the first article, but for some reason I always write like this near the end 

 It used to be ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>STM32 and FreeRTOS. 4. Step toward HAL</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  HAL 9000: I'm perfectly functioning. </blockquote>  <i>or it should be the first article, but for some reason I always write like this near the end</i> <br><br>  It used to be <a href="http://habrahabr.ru/post/249273/">about threads</a> , <a href="http://habrahabr.ru/post/249283/">semaphores</a> and <a href="http://habrahabr.ru/post/249381/">queues</a> <br><br><img src="https://habrastorage.org/files/e26/91e/d71/e2691ed716404eada56c62880aff6a86.png" align="left">  One of the main <i>obstacles</i> to the transition to the STM32 is the abundance of texts, instructions and manuals describing the work with the controller.  The culprit for this abundance was STMicroelectronics itself, which initially systematically confused its users, and then offered the wrong exit options. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The problem lies in the variety of manufactured controllers, which for some reason required different initialization procedures even for the same periphery.  And the code running on one controller refused to work on another.  As a result, collections of shamanic recipes are walking around the network, which require a lot of time to burn and datasheets to burn. <br><br>  But not so long ago, ST realized what pit she had fallen into and began to get out of her strenuously, attracting new forces.  And precisely because of this, now the start time has been reduced to awkwardly small quantities.  How does it look in practice?  Welcome under cat. <br><a name="habracut"></a><br>  To begin with, I will give advice on how to quickly determine what you should not read about STM32. <br><br>  First, the year of publication earlier than 2011-2012.  Just believe that "what then" and "what is now" are two big differences.  SPL and HAL in the world of STM are not just regular abbreviations. <br><br>  Secondly, if such a code is encountered (this is just a piece of ADC initialization, if anyone is interested). <br><br><pre><code class="cpp hljs">RCC-&gt;APB2ENR |= RCC_APB2ENR_ADC1EN; ADC1-&gt;SMPR2 |= ADC_SMPR2_SMP0 | ADC_SMPR2_SMP1 | ADC_SMPR2_SMP2 | ADC_SMPR2_SMP3 | ADC_SMPR2_SMP4 | ADC_SMPR2_SMP5 | ADC_SMPR2_SMP6 | ADC_SMPR2_SMP7; ADC1-&gt;SQR1 |= ADC_SQR1_L_2 | ADC_SQR1_L_1 | ADC_SQR1_L_0; ADC1-&gt;SQR2 |= ADC_SQR2_SQ8_2 | ADC_SQR2_SQ8_1 | ADC_SQR2_SQ8_0 | ADC_SQR2_SQ7_2 | ADC_SQR2_SQ7_1;</code> </pre> <br>  As a result, after watching this ... magnificence, most with the words ‚Äúyes, it‚Äôs nafig, I‚Äôll live with pinMode somehow, what to do with this‚Äù threw the board bought just in case into the far corner of the desk drawer.  I will not hide, I myself was the same and only a great need made me study what is hidden behind the abbreviations CMSIS and SPL.  There is absolutely no point in repeating my path now (and I tried to forget most of what I read), except if you have a very strong desire to get to the giblets.  So here I am telling for those who need to go. <br><br>  So what's the problem?  The main and only problem is the initialization of the periphery.  There those shamanic dances with bats did not appear from scratch.  And 99% of the problems ‚Äúit doesn't work for me‚Äù are precisely in the wrong initialization.  Not those frequencies, an attempt to use the allocated resources, and so on and so forth.  What particularly exacerbates the problem is that there are no error codes or there are no errors.  Everything is like a sapper: he did something wrong - everything is dead. <br><br><div class="spoiler">  <b class="spoiler_title">It seems to you that this is a fairy tale?</b>  <b class="spoiler_title">Here is a drawing of the STMF3 clocking scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a39/32a/c3b/a3932ac3b5bb4c04946e549a76275efb.jpg"><br><br>  Counting the places where you can make a mistake, I suggest to do yourself <br></div></div><br><br>  As a result, ST rolled out first SPL (Standard Peripheral Library), which at least improved the situation, but not much.  And then the next version appeared, called HAL.  And in order to make life even easier for developers, the STM32CubeMX utility was updated, which allowed just a couple of mouse clicks to generate initialization code for the whole variety of motherboards, processors and peripherals.  And next to it put the so-called firmware, which shoved a bunch of examples of work for this processor. <br><br>  And the fact that by pressing two buttons you can get 100% (I have never met the opposite), the working code absolutely presses the thought ‚Äúthere to optimize and optimize‚Äù ... <br><br><img src="https://habrastorage.org/files/6d4/b88/90a/6d4b8890a3d1458683b8c9b482e6577c.jpg" align="left">  The program itself is built on the familiar principle of all "choose the mouse what you need and press the button."  I chose one clocking scheme - the program immediately showed frequencies and highlighted in red those places that cannot work with such frequencies.  We tried to use the functionality that is impossible in these conditions (for example, the leg is already occupied by something else) - it will highlight the error again. <br><br>  Here in the picture on the left, I showed a list of functions that can be hung on a single leg.  After counting, usually AVRs (where 4 functions per leg are maximum) are long hacked and something is counted in the mind.  And when I say to them that there may be more than 160 of these legs, they generally precipitate. <br><br>  But what pleases me most is the fact that now, thanks to HAL, it is not necessary to rewrite the code for working with peripherals.  If it is written somewhere <br><br><pre> <code class="cpp hljs">AL_GPIO_WritePin(GPIOA,GPIO_PIN_2,GPIO_PIN_RESET);</code> </pre><br>  I know that on all the processors currently available to me, this code will translate the leg of PA2 to ‚Äúzero‚Äù.  And even the written function of taking the average value of the desired ADC channel will also not resist during the transition from L1 to F4 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetADCValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Channel,</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Count)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> val = <span class="hljs-number"><span class="hljs-number">0</span></span>; ADC_ChannelConfTypeDef sConfig; sConfig.Channel=Channel; sConfig.Rank=<span class="hljs-number"><span class="hljs-number">1</span></span>; sConfig.SamplingTime=<span class="hljs-number"><span class="hljs-number">10</span></span>; HAL_ADC_ConfigChannel(&amp;hadc,&amp;sConfig); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Count; i++) { HAL_ADC_Start(&amp;hadc); HAL_ADC_PollForConversion(&amp;hadc,<span class="hljs-number"><span class="hljs-number">1</span></span>); val += HAL_ADC_GetValue(&amp;hadc); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> val / Count; }</code> </pre><br>  And now a little put by the canons of magic STM32 <br><br>  What do you think, how much will I have to put in to get a com port from usb from STM32F3, which will simply return what was sent to it?  I calculated here - 12 mouse clicks (enable USB, select CDC, generate) and 6 lines of code in the function CDC_Receive_FS (file usbd_cdc_if.c) <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; *Len; i++) UserTxBufferFS[i] = UserRxBufferFS[i]; USBD_CDC_SetTxBuffer(&amp;hUsbDeviceFS, &amp;UserTxBufferFS[<span class="hljs-number"><span class="hljs-number">0</span></span>], *Len); USBD_CDC_TransmitPacket(&amp;hUsbDeviceFS); USBD_CDC_SetRxBuffer(&amp;hUsbDeviceFS, &amp;UserRxBufferFS[<span class="hljs-number"><span class="hljs-number">0</span></span>]); USBD_CDC_ReceivePacket(&amp;hUsbDeviceFS);</code> </pre><br>  And about the same complexity and with the same complexity implemented "sound card", "flash drive" or HID.  Yes, they will give only initialization code, it will be necessary to write the logic yourself, but this is an awesome help. <br><br>  I will not even lay out the project, for I‚Äôm trying to drag you to something that I hope you already have on your computer, but I‚Äôll show you the result. <br><br><img src="//habrastorage.org/files/06c/667/c8c/06c667c8c6c844f09a5489e109bd17c1.png"><br><br>  The answer to the question ‚Äúwhere can I take a sample?‚Äù Is simple: there are a lot of examples in the downloaded firmware.  And I recommend to pump up (in the menu you will find) the ‚Äúfirmware‚Äù for other processor models - very often the examples do not overlap and the same ‚ÄúADC via DMA‚Äù is only in one place, although it works fine there and there. <br><br>  In a separate paragraph, I note that although the STM32Cube helps the programmer in a quick start, it still requires an understanding of what is being configured and why it is being so configured.  For example, by default, interrupts and DMA for USART are disabled, so some functions simply will not work.  In general, carefully look for the tabs, the benefit of the program allows you to regenerate the project, keeping the already written. <br><br>  <i>Somewhere around here, programmers usually have to go into the generation of ‚Äúsomething like that‚Äù, change descriptors, buffer sizes and change the displayed name in the task manager to ‚ÄúSuper Cool Device‚Äù.</i>  <i>Well, I'll leave you with this.</i> <br><br>  <a href="http://habrahabr.ru/post/249975/">We are completing and benefiting</a> </div><p>Source: <a href="https://habr.com/ru/post/249395/">https://habr.com/ru/post/249395/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249381/index.html">STM32 and FreeRTOS. 3. We stand in line</a></li>
<li><a href="../249383/index.html">How to make QML friends with someone else's OpenGL context. Part III: Processing User Input</a></li>
<li><a href="../249389/index.html">Music as big data. Why, instead of sound quality, you need to think about convenience</a></li>
<li><a href="../249391/index.html">Mod USB-COM adapter, which will save your nerves when flashing the Arduino Pro Mini and not only</a></li>
<li><a href="../249393/index.html">React Native Announcement</a></li>
<li><a href="../249397/index.html">Shopkeeper 3.0 for MODX Revolution Review</a></li>
<li><a href="../249399/index.html">How we did the multitouch table</a></li>
<li><a href="../249401/index.html">Robotics programming with Arduino and ROS</a></li>
<li><a href="../249403/index.html">We write the load tester on Node.js</a></li>
<li><a href="../249405/index.html">Forensic system administration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>