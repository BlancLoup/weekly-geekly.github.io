<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a scalable distributed application from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How did it start 
 All my life I have been developing under Windows. First in C ++, then in C #. In between flashed VB, Java Script and other vermin. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a scalable distributed application from scratch</h1><div class="post__text post__text-html js-mediator-article"><h2>  How did it start </h2><br>  All my life I have been developing under Windows.  First in C ++, then in C #.  In between flashed VB, Java Script and other vermin.  However, some time ago, everything changed and I first encountered the world of Linux, Java and Scala.  Denis and I, my friend and colleague on numerous ideas, already had our own project - a set of utilities for Windows, which enjoyed wide demand in narrow circles.  At some point we both lost interest in this project and the question arose of what to do next.  Denis initiated the idea of ‚Äã‚Äãa new project - a service for exchanging <a href="http://hyraxhub.com/">clipboard</a> between different devices.  This project was significantly different from the previous one in addition to technology, and also the target audience.  This service was supposed to be useful to everyone.  Copy the data to the clipboard and paste from it on any other device.  It sounds easier nowhere, until you think about how many different devices are there now, and how it will work with a large number of users. <br>  The first prototype appeared a few months later.  The server was written in ASP.NET and hosted on MS IIS.  2 clients were written: in C ++ under Windows and in Java under Android. <br><br><img src="https://habrastorage.org/files/23b/454/454/23b454454bac4f568c4b661c5fb2e0a4.png"><br><br>  Testing has shown that the prototype holds about 500 compounds.  What to do if there are more of them, we are counting on hundreds of thousands of users;) How to write a server that can work with a large number of connections, which will not need to be turned off during the upgrade of hardware or software and which will easily scale (i.e. expand in case of increasing the number of users). <br><a name="habracut"></a><br><h2>  Distributed scalable system </h2><br>  For me, such complex terms as ‚Äúdistributed scalable system‚Äù (a <a href="http://habrahabr.ru/post/185636/">good article</a> ) usually remain an empty sound until I understand what it stands for in terms of technology and products.  It is not enough for me to know the characteristics of such systems and I want to try to create such a system myself in order to realize all its advantages and disadvantages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/6ea/413/82a/6ea41382a1624346a26880e6aa2e2eb1.png"><br><br>  So, a scalable system must have several nodes (nodes) so that in case of an increase in load we can add new nodes and in the event of a single node failure, the rest would continue to work.  The node is an iron or a virtual machine.  In this and other drawings, each square is a service, in accordance with the best traditions of SOA (Service-Oriented Architecture).  In the future we will talk about where and how you can locate these services. <br><br>  What modern companies write their servers.  For example, Twitter uses a functional language, Scala, and has its own Finagle library ( <a href="http://blog.oskarsson.nu/post/40196324612/the-twitter-stack">The twitter stack</a> ).  Scala allows you to write non-blocking ( <a href="http://blogs.mentor.com/colinwalls/blog/2009/11/30/blocking-and-non-blocking-apis/">non blocking</a> ), immutable code.  The first is important to save server resources, because the thread does not wait for the release of any resource, for example, during IO (input output) operations.  The second allows you to parallelize the code at any time and perform calculations in different threads without additional synchronization efforts.  We started writing a new server on Scala and first using Finagle, but later moved to the <a href="https://www.playframework.com/">Play framework</a> .  The advantage of the second is that it develops more dynamically and many plug-ins constantly appear to it. <br><br>  In order for clients to quickly receive information about adding a new clipboard to the server, we used the long poll technology.  The client accesses the service and if the service does not have new data, it does not immediately respond to the client, but keeps the connection for a given timeout, for example, 60 seconds.  If during this timeout the server receives new data, it immediately returns it for the held connections.  The client thus constantly repeats requests and waits for updated data. <br><br>  With this mechanism, the services MyService1, MyService2, etc. should be able to inform each other about the new buffer.  For example, if a client hangs and waits for a result from MyService1, however, the buffer was added by another client on MyService2, then MyService1 should immediately find out about it.  In order for services to notify each other about such changes, we used remote actors from the Akka library.  Akka is a library that allows you to use objects without having to synchronize access to them.  This is achieved by sending a message to each actor, and not making a direct call, and at a single point in time only one message is processed by actor.  In addition, Akka allows you to call actors from another service in the same way as local actors.  The mechanism of remote actors hides interworking, which greatly facilitates the development.  Thus, using Akka MyService1 (and any other service) can notify all other services if new data is supplied to it. <br><br>  Where does MyService1 find out the IP addresses of MyService2 and MyService3.  We used ZooKeeper to store the system configuration.  Thus, each service knows the IP address of ZooKeeper and can register on it, as well as get information from it about what other nodes are in the system. <br><br><img src="https://habrastorage.org/files/f19/a89/ce7/f19a89ce77cd4d6b890c36bcf77c7daa.png"><br><br>  The figure shows that although we have created a scalable system where you can add or remove nodes directly into runtime, however the database is the same and it remains a weak point of the system.  Each call to the database is quite a long operation.  In order to reduce the load on the base and increase the overall system performance, we decided to add a cache.  As a cache, it was decided to use Redis.  Redis is an in-memory data storage in key-value (NoSQL key-value data store) format.  Although it doesn't sound very clear, the idea is very simple.  Redis allows you to get values ‚Äã‚Äãby key and stores it all in memory.  Thus, the call to Redis is very fast.  In order to use Redis, our service was changed accordingly and began to apply for new data first to Redis and only then, if no data were found, to the database.  Correspondingly, when a new buffer arrived, it immediately got into the base and into the cache. <br><br><img src="https://habrastorage.org/files/30f/f02/e4b/30ff02e4b86d46dd9753adb7dc89e0a8.png"><br><br>  The number of squares in our scheme is continuously increasing, but the reliability of the system also increases.  Remove MyService2 and the requests will continue to process MyService1 and MyService3.  Remove Redis and services will directly receive data from the database.  Remove ... No, we don‚Äôt need to remove DB and ZooKeeper yet, as this will bring down our entire system :) <br><br>  In order to ensure the reliability of the database, it must support replication.  We chose the NoSQL MongoDB database. Our services have a JSON interface and it is more convenient to store the results in JSON format, which is supported by MongoDB.  In addition, MongoDB perfectly supports replication, we can run several nodes with MongoDB, link them into one replica, and in the event of a node failure, all clients can continue to work with other nodes.  Replicas in MongoDB must consist of at least 3 nodes: the main (primary) node, the secondary (secondary) and the arbiter (arbiter) that monitors the other nodes, and if the main node fails, it becomes the secondary node. <br><br><img src="https://habrastorage.org/files/f91/960/d7d/f91960d7d7ee4104ad54d557638c5a9b.png"><br><br>  Now we can safely turn off one of the nodes with MongoDB and our system will not even notice it.  I will not dwell on ZooKeeper in detail, but it will not be the Hech's heel of our system, as well as MongoDB supports replication. <br><br>  A meticulous reader will notice that I have bypassed the question of how requests are distributed between MyService1, MyService2 and MyService3 nodes.  In serious systems, a load balancer is used for this - load balancer.  However, if you are already tired of the infinite number of support services in our system, you can use DNS as a simple load balancer.  When a request to the api.myservice.com service comes to DNS, it returns several IP addresses.  The trick is that for each request, the order of these IP addresses changes.  For example, for the first request api.myservice.com returned: 132.111.21.2, 132.111.21.3, 132.111.21.4 and for the second 132.111.21.3, 132.111.21.4, 132.111.21.2, respectively, customers always try to first access the first IP from the list and only In case of error will use the 2nd or 3rd. <br><br><img src="https://habrastorage.org/files/e26/9f7/307/e269f73077884c9baab800dd24732814.png"><br><br><h2>  Deployment </h2><br>  As a result, we have built a truly scalable (you can add and remove service nodes), distributed (services can be located on different nodes and even in different data centers) system. <br><br>  Let's check whether our application meets the basic requirements for such systems. <br><br><ul><li>  Accessibility - our system is always available.  If we change the iron for any node, the other nodes continue to work.  We can also update the software one by one. </li><li>  Performance - using more complex load balancers, we can direct European users to the European node, and users from America to the American node.  In addition, the use of Redis significantly reduces access to the database. </li><li>  Reliability - when any node fails, the remaining nodes continue to work </li><li>  Scalable - you can add as many MyServiceN </li><li>  Handling - hmmm, there are still questions, aren't there? </li><li>  Cost - all technologies and libraries used in this project are free and / or open source </li></ul><br><br>  Thus, only one criterion remained under question - controllability.  What is the easiest way to deploy SOA systems consisting of dozens of services?  We decided to use a fairly new, but well-proven technology - Docker.  Docker is somewhat similar to widely used virtual machines, but it has several advantages.  Using Docker you can create a docker container for each service, and then run them all either on the same or on different machines.  The important point is that since Docker uses Linux‚Äôs built-in virtualization mechanism, it doesn‚Äôt require additional resources, unlike virtual machines.  So we created containers for all nodes of our system.  This makes it equally easy to deploy a test environment where all containers are running on one node and a working environment where each container is on its own node. <br><br>  At some point we faced the question of where to place our system.  Considered the most popular cloud provider - Amazon, however, decided to save money and place our application on a cheaper Digital Ocean. </div><p>Source: <a href="https://habr.com/ru/post/261509/">https://habr.com/ru/post/261509/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261489/index.html">New courses on Hexlet: React, Ansible and others</a></li>
<li><a href="../261491/index.html">Kingpin: schoolchildren translate a book about hackers</a></li>
<li><a href="../261493/index.html">Controversial, but relevant design principles</a></li>
<li><a href="../261497/index.html">200 million checks per month or architecture and statistics of the CloudStats.me service</a></li>
<li><a href="../261507/index.html">"Pumping" notepad.exe</a></li>
<li><a href="../261511/index.html">PSD parser or how to parse a Photoshop file in Java</a></li>
<li><a href="../261515/index.html">AllJoyn and Windows 10 - we make our devices speak the same language</a></li>
<li><a href="../261517/index.html">Does XMPP suck?</a></li>
<li><a href="../261519/index.html">Acronis Backup Russia - First Look</a></li>
<li><a href="../261521/index.html">Setting tasks and calculating labor costs for the development of documentation in an IT company</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>