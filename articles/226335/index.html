<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How did SQL Server switch every two to three hours to using a non-optimal query execution plan?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I've been working on an interesting task for the last couple of days and would like to share an interesting experience with the community. 

 What is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How did SQL Server switch every two to three hours to using a non-optimal query execution plan?</h1><div class="post__text post__text-html js-mediator-article">  I've been working on an interesting task for the last couple of days and would like to share an interesting experience with the community. <br><br>  <b>What is the problem:</b> <br>  I run the stored procedure (stored) on a sample of data for a report - it takes three seconds, I look at the battle profiler - the users have the same results.  But it takes three hours and the same store, with the same parameters, it has already been running for 2 minutes, and similarly with users.  Moreover, the data in the used tables were not inserted / deleted, the environment was not changed, and the admins did not make the settings. <br><a name="habracut"></a><br>  Localized before request: <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> @table_variable1 <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.view_with_unions v1 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (READUNCOMMITTED) <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> @table_variable2 <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t1 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t1.Code = v1.DirectionDimensionCode <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> other_table v2 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (READUNCOMMITTED) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> v2.Code = v1.SaleType <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ...</code> </pre> <br>  He set the profiler on execution plans and noticed that with an increase in the execution time, the execution plan of the problem query also changes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Already something! <br><br>  Then I began to look more attentively at what is changing in terms of implementation.  It turned out that in the long run plan, NestedLoop unions are used, and in the fast plan, HashMatch are used. <br><br>  <i>Quick Plan:</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c11/4e5/1a4/c114e51a498dcbc2b6a5300560417929.png"><br><br>  <i>Slow (to which SQL Server switches in 2 hours):</i> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/210/9b7/19a/2109b719ac61f82b9c7e29017d3892ee.png"><br><br>  I just did not want to prescribe HINTs for using HASH JOINs, since  you need to understand why SQL Server still chooses the wrong plan. <br><br>  The first thought was that something was wrong with the statistics, but on the execution plan from the profiler Actual Number Of Rows was 0, and the Estimated Number Of Rows is 1. Thus.  Thus, the difference is not so great as to investigate problems with statistics and Cardinality. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ebb/937/ba4/ebb937ba4833b1746b44c08a56975f46.png"><br><br>  However, looking at Actual Number Of Rows = 0 from once to once, I had doubts - really, not a single row is always returned.  It turned out that this is not the case; just the profiler intercepts the execution plan before the request is executed and the Actual data is known.  And accordingly, it can not display anything except as a zero in Actual Number Of Rows. <br><br>  Ok, now look at the actual values ‚Äã‚Äãof Actual Number Of Rows! <br><br>  Then the question arose - why is Estimated Number Of Rows always equal to one?  After all, the index is used, it has current statistics.  And the value of Estimated Number Of Rows is every time 1. But here without surprises - SQL Server does not use statistics if it starts from a low selective column (i.e., if the number of different values ‚Äã‚Äãis small, for example: 0, 1, NULL).  Therefore, I moved the first column in the index key to the last place.  After making sure that all the conditions on these columns are superimposed in WHERE and listed through AND, it means that the index with its statistics is still suitable for use. <br><br>  <b>Diagnosis:</b> <br><ol><li>  The profiler does not display Actual Number Of Rows on the execution plans, and does not write n / a, but zero.  We must remember this! </li><li>  SQL Server does not use statistics to determine the Estimated Number Of Rows, in our case. </li><li>  And even if he starts using statistics, he is very mistaken. </li></ol><br><br>  <b>Decision:</b> <br><ol><li>  We manually launch many requests from the profiler and look at the real Actual Number Of Rows </li><li>  It is necessary to give SQL Server the opportunity to use statistics on the index, for this the first column in the key should have many different values ‚Äã‚Äã(for example, not three 0, 1, NULL).  Since  if the first column has few different values ‚Äã‚Äã(low selective), then SQL Server does not have the ability to adequately predict the number of rows and therefore does not use such statistics. </li><li>  After rebuilding the index, you need to update the statistics with the WITH FULLSCAN option to improve the quality of Estimated Number Of Rows forecasts: <br><br>  UPDATE STATISTICS [dbo]. [ <i>Table_from_union_for_view</i> ] WITH FULLSCAN; <br>  GO </li></ol><br><br>  And now all the requests are executed in no more than 2 seconds, the execution plan is used as a mix from the previous ones, and the Actual Number Of Rows is viewed in Management Studio: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c8/068/86d/7c806886d9f69e9f59aa8cb9f01e2486.png"><br><br>  But that's not all! <br><br>  Such a work strategy will still cache execution plans, which has both a positive side and a negative one. <br><br>  Positive: <br>  execution speed is really 1-2 seconds <br><br>  Negative: <br>  Periodically, the request is executed for about 20-40 seconds, and then it continues to be executed again for 1-2 seconds.  This happens when there is a jump in the change in the number of rows in the problem query (either from large to small, or from small to large). <br><br>  But SQL Server gives us the opportunity to overcome it! <br><br>  To do this, you can use the OPTION (RECOMPILE) option, which will rebuild the execution plan with each execution.  This will lead to an increase in the execution time of each request up to 3-4 seconds, but there will be no executions of 20-40 seconds during the day.  By the way, OPTION (RECOMPILE) also helps to get the most accurate Cardinality score when using temporary objects and table variables, which is used when determining the Estimated Number of Rows and then when choosing a query execution plan.  (More details about temporary objects and the essence of the RECOMPILE option in them are described in an extremely good post - <a href="http://sqlblog.com/blogs/paul_white/archive/2012/08/15/temporary-tables-in-stored-procedures.aspx">sqlblog.com/blogs/paul_white/archive/2012/08/15/temporary-tables-in-stored-procedures.aspx</a> ) <br><br>  Here we ourselves need to decide what is more important - that the majority of requests be executed for 1-2 seconds or that no request is executed for more than 20 seconds during the day. </div><p>Source: <a href="https://habr.com/ru/post/226335/">https://habr.com/ru/post/226335/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226325/index.html">An interesting task for the interview, currying and partial application of the function</a></li>
<li><a href="../226327/index.html">What should "PHP Junior Developer without experience" know?</a></li>
<li><a href="../226329/index.html">Apple Metal API: what's the trick?</a></li>
<li><a href="../226331/index.html">Setting up a remote interpreter on Pycharm for Django</a></li>
<li><a href="../226333/index.html">Reduced component connectivity of C ++ code</a></li>
<li><a href="../226337/index.html">Let's play evolution? Genetic Algorithms in a Screensaver</a></li>
<li><a href="../226339/index.html">How to assemble an electric bike in seven days</a></li>
<li><a href="../226341/index.html">We sit, do not touch anyone, we repair old headphones</a></li>
<li><a href="../226343/index.html">Gamification or gamification</a></li>
<li><a href="../226345/index.html">Recover Apple Key Aluminum after Fluid</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>