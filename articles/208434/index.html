<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Background update data in iOS7</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the end of September, APPLE released iOS 7, one of the features of this version was improved multitasking and the ability to update data when the a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Background update data in iOS7</h1><div class="post__text post__text-html js-mediator-article">  At the end of September, APPLE released iOS 7, one of the features of this version was improved multitasking and the ability to update data when the application is not active. <br>  There are two options for launching the application for updating data - periodic updates and starting when you receive a special push-notification.  In each of the options, the application will be launched in the background (background mode), and will be forcibly closed after 30 seconds, so there will be very little time to update. <br><a name="habracut"></a><br><h4>  Periodic data update (Background fetch) </h4><br>  To allow the application to run in the background, you need to add the Required background modes key with the App downloads content from the network value to the application plist.  This can also be done by checking the Capabilities tab. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b7a/e91/f43/b7ae91f436edc34778bc1b223a2b8927.png"><br><br>  In addition, in the method application: didFinishLaunchingWithOptions: set the minimum interval to run. <br><pre><code class="objectivec hljs">If([[[<span class="hljs-built_in"><span class="hljs-built_in">UIDevice</span></span> currentDevice] systemVersion] floatValue] &gt;=<span class="hljs-number"><span class="hljs-number">7.0</span></span>){ [[<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> sharedApplication] setMinimumBackgroundFetchInterval:<span class="hljs-number"><span class="hljs-number">600</span></span>]; }</code> </pre> <br>  (check for version is important - in iOS 6, the application falls on this function). <br>  Instead of a numeric value, you can use the UIApplicationBackgroundFetchIntervalMinimum variable to set the minimum possible interval, but this does not play a special role, because the minimum interval is set, not the guaranteed interval.  When exactly the application will start - is unknown.  It will be launched based on the statistics of the work: at what time the application usually starts, how long it usually takes in the background.  The less time it takes to run the program, the more often it will run.  Setting the interval is required, since by default, this value is equal to UIApplicationBackgroundFetchIntervalNever and the launch will not occur. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When launched, the application starts its work in the background by running the application: performFetchWithCompletionHandler method: <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> *)application performFetchWithCompletionHandler:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^)(<span class="hljs-built_in"><span class="hljs-built_in">UIBackgroundFetchResult</span></span>))completionHandler{ <span class="hljs-comment"><span class="hljs-comment">//DO SOMETHING completionHandler(UIBackgroundFetchResultNewData); }</span></span></code> </pre><br>  At the end of the method, you must call received completionHandler with the UIBackgroundFetchResultNewData parameter (variants - UIBackgroundFetchResultNoData, UIBackgroundFetchResultFailed).  But in any case, after 30 seconds the application will be forcibly closed. <br>  In addition, as with the standard launch, application: didFinishLaunchingWithOptions is called: <br>  and if there is code in it that should not be launched in this situation (for example, UI update), in order to save processor time, it is better to disable it.  When launched in this mode, I did not find additional keys in launchOptions, so I need to check the application.applicationState parameter, which will be equal to the UIApplicationStateBackground. <br>  NB If within 30 seconds while the application is running in the background, the user starts the application via the UI, then this method will not be restarted.  If necessary, the missing code can be run in the applicationWillEnterForeground method: (UIApplication *) application <br><br>  To debug the launch of the application in the background update mode in XCode, you can simulate this mode - it is enabled by ticking the scheme settings. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/04b/ede/f10/04bedef102423b16fcba7b4402ceb7f9.png"><br><br><h4>  Run from push message. </h4><br>  The second opportunity to receive content updates is to launch when receiving push notification with the content-available flag set. <br><br>  I will not paint the application settings for push.  I can only say that the Required background modes key with the App value is added to the plist of the application (well, or the corresponding check mark in the project settings), and the new value is added to the types of messages that the application will receive <br>  UIRemoteNotificationTypeNewsstandContentAvailability; <br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">UIRemoteNotificationType</span></span> myTypes = <span class="hljs-built_in"><span class="hljs-built_in">UIRemoteNotificationTypeBadge</span></span> | <span class="hljs-built_in"><span class="hljs-built_in">UIRemoteNotificationTypeAlert</span></span>|<span class="hljs-built_in"><span class="hljs-built_in">UIRemoteNotificationTypeSound</span></span>|<span class="hljs-built_in"><span class="hljs-built_in">UIRemoteNotificationTypeNewsstandContentAvailability</span></span>; [application registerForRemoteNotificationTypes:myTypes];</code> </pre><br><br>  When a message is received, the method runs. <br><br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> *)application performFetchWithCompletionHandler:(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (^)(<span class="hljs-built_in"><span class="hljs-built_in">UIBackgroundFetchResult</span></span>))completionHandler{ <span class="hljs-comment"><span class="hljs-comment">//DO SOMETHING completionHandler(UIBackgroundFetchResultNewData); }</span></span></code> </pre><br>  to whom too <br>  It will be given only 30 seconds and at the end of which you must call completionHandler with a parameter. <br><br>  This function will be launched regardless of the state in which the application is now, even if it is in active mode. <br>  If the application is launched in the background, then the application: didFinishLaunchingWithOptions: method will also be called, but in this case, the launchOptions will have an entry with the UIApplicationLaunchOptionsRemoteNotificationKey key. <br><br>  The first pitfall - push does not come if there is nothing besides the content-available flag.  If you add text or sound, then everything is fine.  Since no one wants to spam the user with messages, we send an empty sound: <br><pre> <code class="javascript hljs">aps = { <span class="hljs-string"><span class="hljs-string">"content-available"</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; sound = <span class="hljs-string"><span class="hljs-string">""</span></span>; };</code> </pre><br><br><h4>  What can be done in 30 seconds? </h4><br>  In principle, Apple does not limit us in choosing the method by which the update will be carried out.  However, in iOS 7, a new NSURLSession class has emerged, which the company recommends using.  Without delving into its description, we can say that one of its merits is the ability to download data in the background using iOS itself, even after the application is terminated. <br><br><h4>  A spoon of tar </h4><br>  And now a little personal experience or why all of the above didn‚Äôt work for our application (electronic newspaper on iPad).  It was planned that in the morning the user will wake up, get an iPad, and the newspaper is already ready for him and is waiting to be read.  But‚Ä¶ <br>  First, the background update does not work when the device is in sleep mode (the screen is turned off).  The update will take place as soon as the screen is unlocked, which is good for the messenger, but for us it is too late. <br>  Secondly, despite the fact that the documentation says ‚ÄúIf your app is suspended or not running, push will not launch the app, if it is in the ‚Äúnot running‚Äù state.  This means that if the user himself deleted the application from the task list or the system unloaded it, then push comes, but the application does not start.  It is not clear whether this is a bug or not, but what it is, that is.  Alas. <br><br>  PS In order for the application to start, you must also allow the ability to run in the device settings (or rather, do not deny it, because by default it is enabled for new programs).  You can check this from the application by checking the [[UIApplication sharedApplication] backgroundRefreshStatus] value. </div><p>Source: <a href="https://habr.com/ru/post/208434/">https://habr.com/ru/post/208434/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208422/index.html">Michael Bay left the stage during the presentation of the curved Samsung TV</a></li>
<li><a href="../208424/index.html">Peer Broadcast Features</a></li>
<li><a href="../208428/index.html">Apple's patent policy in recent years. View from the outside</a></li>
<li><a href="../208430/index.html">Home CNC router as an alternative to a 3D printer, part two</a></li>
<li><a href="../208432/index.html">We collect the project on a RAM disk by means of Maven</a></li>
<li><a href="../208436/index.html">Sound output to Arduino Due</a></li>
<li><a href="../208442/index.html">Cheat Sheet on SOLID Principles with PHP Examples</a></li>
<li><a href="../208444/index.html">We help the robot sorter in the mail</a></li>
<li><a href="../208446/index.html">Improved UPX compression ratio</a></li>
<li><a href="../208448/index.html">Agency DARPA launched a project to create biodegradable electronics, self-destructing on command</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>