<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Android development application for working with OBDII protocol</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why is it necessary for your car? 
 Have you ever thought about displaying the parameters of your car in your own Android application? If yes, then we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Android development application for working with OBDII protocol</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/7ed/3df/866/7ed3df866289ed36a2ce933a2f0457e9.jpg" alt="image"><br><h4>  Why is it necessary for your car? </h4><br>  Have you ever thought about displaying the parameters of your car in your own Android application?  If yes, then welcome under cat.  We will discuss the development of such an application. <br><a name="habracut"></a><br>  First, let's take a look at the protocols used to diagnose vehicles. <br>  OBD is an abbreviation for on-board diagnostics and refers to self-diagnostics and vehicle reporting tools.  The original protocol is intended to speed up the process of diagnostics by service personnel.  The first versions allowed to diagnose some problems in the engine.  Now, in addition to the diagnostic capabilities, other features are added, such as obtaining different information, such as current fuel consumption, controlling various components, such as automatic transmission, transmission mode, obtaining GPS coordinates, and more.  Learn in more detail how this works and the story you can in <a href="http://en.wikipedia.org/wiki/On-board_diagnostics">Wikipedia</a> . <br><h4>  Necessary materials </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/d4f/63f/78c/d4f63f78ceb40b8077c7c8237392af26.jpg" alt="image"><br>  First of all, we need an OBDII adapter capable of working with your car.  There are many such adapters.  Some of them have a COM interface, some have a USB interface, and some have a Bluetooth interface.  Theoretically, anyone can be used for our application, but in practice, the best option is still Bluetooth.  Also, adapters may be different supported OBDII protocols (ie, actually supported cars).  So if you have a car and a suitable OBDII adapter at hand, we can start developing our application. <br><br>  Wait - do you really have a car close enough to the development environment?  In fact, we could use the simulator at first.  One of the options that works for me is the OBDSim application.  This is an open source project available for many platforms.  But since Bluetooth is not supported in Windows, the application will need to be assembled from source codes in Linux.  Also note that most likely you will need to make changes to the source code in order to change the RFCOMM channel to the first available instead of the proposed channel 1. <br><br>  The second option is a hardware simulator that can be used instead of a car.  I used the <a href="http://www.scantool.net/dev-tools/ecusim-family/ecusim-2000.html">ECUsim 2000</a> standard with the ISO 15765 (CAN) protocol enabled.  And I used the OBDII adapter ELM327 v.1.5 <br><img src="https://habrastorage.org/getpro/habr/post_images/079/b11/0a8/079b110a8c46c5f4165bed20e760145b.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Application development </h4><br><br>  Let's begin by describing the protocol used for communication between an Android device and an OBDII adapter / car.  This is a text polling protocol.  This means that all you need is to send a command in order to get an answer.  And knowing which commands you can send is key. <br><br>  We will connect to the adapter via Bluetooth.  It seems that the <a href="http://blog.lemberg.co.uk/getting-bottom-android-bluetooth-low-energy-api">Bluetooth Low Energy API</a> would be a good option.  But since it is supported by just a few devices, it is now too early to use it. <br><br>  The protocol supports some <a href="http://elmelectronics.com/ELM327/AT_Commands.pdf">AT commands</a> such as echo off and carriage return control.  The second part of the protocol is the OBDII control protocol itself. <br><br>  The general scheme of the application is as follows: <br><ul><li>  connect to OBDII adapter via Bluetooth </li><li>  initialize OBDII adapter using AT commands </li><li>  continuously receive the required data from the vehicle by sending the appropriate PID codes </li></ul><br><br>  Connection to OBDII adapter is fairly standard.  But one thing that needs to be done before connecting is choosing a Bluetooth device.  Displaying the alert dialog with a list of devices is fine: <br><br><pre><code class="java hljs">ArrayList&lt;String&gt; deviceStrs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;String&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ArrayList&lt;String&gt; devices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;String&gt;(); BluetoothAdapter btAdapter = BluetoothAdapter.getDefaultAdapter(); Set&lt;BluetoothDevice&gt; pairedDevices = btAdapter.getBondedDevices(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pairedDevices.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (BluetoothDevice device : pairedDevices) { deviceStrs.add(device.getName() + <span class="hljs-string"><span class="hljs-string">"\n"</span></span> + device.getAddress()); devices.add(device.getAddress()); } } <span class="hljs-comment"><span class="hljs-comment">// show list final AlertDialog.Builder alertDialog = new AlertDialog.Builder(this); ArrayAdapter&lt;String&gt; adapter = new ArrayAdapter&lt;String&gt;(this, android.R.layout.select_dialog_singlechoice, deviceStrs.toArray(new String[deviceStrs.size()])); alertDialog.setSingleChoiceItems(adapter, -1, new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { dialog.dismiss(); int position = ((AlertDialog) dialog).getListView().getCheckedItemPosition(); String deviceAddress = devices.get(position); // TODO save deviceAddress } }); alertDialog.setTitle("Choose Bluetooth device"); alertDialog.show();</span></span></code> </pre> <br><br>  Do not forget to save somewhere the address of the selected device.  Now we can connect to the selected device: <br><br><pre> <code class="java hljs">BluetoothAdapter btAdapter = BluetoothAdapter.getDefaultAdapter(); BluetoothDevice device = btAdapter.getRemoteDevice(deviceAddress); UUID uuid = UUID.fromString(<span class="hljs-string"><span class="hljs-string">"00001101-0000-1000-8000-00805F9B34FB"</span></span>); BluetoothSocket socket = device.createInsecureRfcommSocketToServiceRecord(uuid); socket.connect();</code> </pre><br><br>  The UUID in the code above represents a ‚Äúserial‚Äù interface via Bluetooth.  Of course, this code must be executed in a non-UI stream.  I would also recommend to look <a href="http://stackoverflow.com/questions/18657427/ioexception-read-failed-socket-might-closed-bluetooth-on-android-4-3/18786701">here</a> for details and the solution to the error in Android which can lead to the impossibility of connecting in some cases. <br><br>  Now we can exchange data.  For this we will use the <a href="https://github.com/pires/obd-java-api">OBD-Java-API</a> library.  The library is quite simple.  It has several classes that correspond to different OBD commands.  Remember to initialize the OBDII adapter by sending configuration commands: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EchoOffObdCommand().run(socket.getInputStream(), socket.getOutputStream()); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LineFeedOffObdCommand().run(socket.getInputStream(), socket.getOutputStream()); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeoutObdCommand().run(socket.getInputStream(), socket.getOutputStream()); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SelectProtocolObdCommand(ObdProtocols.AUTO).run(socket.getInputStream(), socket.getOutputStream());</code> </pre><br><br>  Now we are ready to send other commands: <br><pre> <code class="java hljs">EngineRPMObdCommand engineRpmCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EngineRPMObdCommand(); SpeedObdCommand speedCommand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpeedObdCommand(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Thread.currentThread().isInterrupted()) { engineRpmCommand.run(sock.getInputStream(), sock.getOutputStream()); speedCommand.run(sock.getInputStream(), sock.getOutputStream()); <span class="hljs-comment"><span class="hljs-comment">// TODO handle commands result Log.d(TAG, "RPM: " + engineRpmCommand.getFormattedResult()); Log.d(TAG, "Speed: " + speedCommand.getFormattedResult()); }</span></span></code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a40/083/2de/a400832de3dffcf008304bc95d93068d.jpg" alt="image"><br><br>  Here I want to note that the library has some problems with parsing and often falls due to insufficiently good error handling.  The first problem is the performCalculations method, which is present in all command classes.  It would be good to check the buffer size before accessing it, because in some cases the answer may be shorter than necessary.  Of course, the short answer problem lies with the OBDII adapter / car, but the library should be ready for such problems. <br><br>  Among other things, there are still some problems there, so this library still needs improvements or can simply be used as a source of information. <br><br>  The received data can be saved somewhere for further analysis, for example in <a href="http://www.elasticsearch.org/">ElasticSearch</a> . <br><br>  And now we are working on the Hours of Service app for truck drivers and continue to share experiences in our <a href="http://blog.lemberg.co.uk/">blog</a> .  Stay tuned! <br><br>  PS In fact, I am also the author of the original English version of the article, which was published on <a href="http://blog.lemberg.co.uk/how-guide-obdii-reader-app-development">blog.lemberg.co.uk</a> , so I can answer technical questions. </div><p>Source: <a href="https://habr.com/ru/post/223949/">https://habr.com/ru/post/223949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223937/index.html">4 Apple Design Myths from Former Apple Designer</a></li>
<li><a href="../223939/index.html">The penetration testing lab ‚ÄúOne Step Ahead‚Äù is open</a></li>
<li><a href="../223941/index.html">4Blend HDR, the path to success: from winning the Nokia Developer competition to popularity in the Windows Store</a></li>
<li><a href="../223945/index.html">LinkMeUp. Issue number 15. Guest from Canada</a></li>
<li><a href="../223947/index.html">STM32 and LCD via I2C</a></li>
<li><a href="../223953/index.html">Ancient philosophers and modern scientists</a></li>
<li><a href="../223955/index.html">Li-Ion Battery Operation</a></li>
<li><a href="../223957/index.html">What language can you learn by asking questions to the search engine? Yandex Workshop</a></li>
<li><a href="../223961/index.html">Steam Protocol 2 and Steam Files - Introduction</a></li>
<li><a href="../223965/index.html">Windows 8.1 with Bing challenges Android: one gig of RAM is again enough</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>