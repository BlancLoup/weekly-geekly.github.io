<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up the proftpd + {mysql / postgresql} bundle with storing passwords in md5 + salt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It has long been haunted by the fact that user passwords are stored in the database in the open form. It was also very inconvenient to manually add / ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up the proftpd + {mysql / postgresql} bundle with storing passwords in md5 + salt</h1><div class="post__text post__text-html js-mediator-article">  It has long been haunted by the fact that user passwords are stored in the database in the open form.  It was also very inconvenient to manually add / delete users and change their passwords. <br><br>  As a result, I configured a bunch of proftpd + mod_sql + mod_sql_passwd c storing passwords in the form of md5 + salt, and also wrote three scripts to add, delete and change the password of users. <br><br>  Since I use PostgreSQL somewhere on different servers and MySQL somewhere, I post a description of the settings for both DBMSs. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Servers are running ALT Linux Sisyphus. <br><a name="habracut"></a><br><h3>  Step 1. Install all the necessary </h3><br>  To work, we need the proftpd package itself, the modules for it proftpd-mod_sql, proftpd-mod_sql_passwd and proftpd-mod_sql_mysql / postgres and Perl modules. <br><br><div class="spoiler">  <b class="spoiler_title">Installing the necessary packages</b> <div class="spoiler_text"><pre><code class="hljs pgsql"># apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> # apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install proftpd proftpd_mod_sql proftpd-mod_sql_passwd proftpd-mod_sql_mysql proftpd-mod_sql_postgres # apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install perl-Crypt-PasswdMD5 perl-Config-Simple perl-DBI perl-DBD-Pg perl-DBD-mysql</code> </pre> <br></div></div><br><h3>  Step 2. Database preparation </h3><br>  In this article we will connect to the database on the DBHOST host with the user DBUSER, the password DBPASSWD and the database DBNAME. <br><br><div class="spoiler">  <b class="spoiler_title">Database structure for MySQL</b> <div class="spoiler_text"><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`log_failed_logins`</span></span> ( <span class="hljs-string"><span class="hljs-string">`unic_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_IP`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`unic_id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`users`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`username`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`password`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`salt`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`groupname`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`uid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`gid`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`homedir`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">70</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`shell`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`last_login`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`login_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`last_error_login`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`login_error_count`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`xfer_errors`</span></span> ( <span class="hljs-string"><span class="hljs-string">`unic_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`file_and_path`</span></span> tinytext <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_IP`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_command`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`unic_id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`xfer_table`</span></span> ( <span class="hljs-string"><span class="hljs-string">`unic_id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`datetime`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`user_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`file_and_path`</span></span> tinytext <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`bytes`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-string"><span class="hljs-string">`client_name`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_IP`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`client_command`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`send_time`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`unic_id`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">DB structure for PostgreSQL</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> users ( id <span class="hljs-type"><span class="hljs-type">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, username <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), salt <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>), groupname <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>), uid <span class="hljs-type"><span class="hljs-type">integer</span></span>, gid <span class="hljs-type"><span class="hljs-type">integer</span></span>, homedir <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">70</span></span>), shell <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>), last_login <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), login_count <span class="hljs-type"><span class="hljs-type">integer</span></span>, last_error_login <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), login_error_count <span class="hljs-type"><span class="hljs-type">integer</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> users <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> users_id_seq <span class="hljs-keyword"><span class="hljs-keyword">START</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MINVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MAXVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CACHE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> users_id_seq <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_failed_logins ( id <span class="hljs-type"><span class="hljs-type">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> nextval(<span class="hljs-string"><span class="hljs-string">'log_failed_logins_id_seq'</span></span>::<span class="hljs-type"><span class="hljs-type">regclass</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, datetime <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), user_name <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>), client_name <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>), client_ip <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_failed_logins <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> log_failed_logins_id_seq <span class="hljs-keyword"><span class="hljs-keyword">START</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MINVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MAXVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CACHE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_failed_logins_id_seq <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> xfer_errors ( id <span class="hljs-type"><span class="hljs-type">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> nextval(<span class="hljs-string"><span class="hljs-string">'xfer_errors_id_seq'</span></span>::<span class="hljs-type"><span class="hljs-type">regclass</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, datetime <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), user_name <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>), file_and_path <span class="hljs-type"><span class="hljs-type">text</span></span>, client_name <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>), client_ip <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>), client_command <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> xfer_errors <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> xfer_errors_id_seq <span class="hljs-keyword"><span class="hljs-keyword">START</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MINVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MAXVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CACHE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> xfer_errors_id_seq <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> xfer_table ( id <span class="hljs-type"><span class="hljs-type">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> nextval(<span class="hljs-string"><span class="hljs-string">'xfer_table_id_seq'</span></span>::<span class="hljs-type"><span class="hljs-type">regclass</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, datetime <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>), user_name <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>), file_and_path <span class="hljs-type"><span class="hljs-type">text</span></span>, bytes <span class="hljs-type"><span class="hljs-type">integer</span></span>, client_name <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>), client_ip <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>), client_command <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>), send_time <span class="hljs-type"><span class="hljs-type">character</span></span> <span class="hljs-type"><span class="hljs-type">varying</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> xfer_table <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> xfer_table_id_seq <span class="hljs-keyword"><span class="hljs-keyword">START</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INCREMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MINVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NO MAXVALUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CACHE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> xfer_table_id_seq <span class="hljs-keyword"><span class="hljs-keyword">OWNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> &lt;b&gt;DBUSER&lt;/b&gt;; &lt;/spoiler&gt; &lt;spoiler title="   MySQL"&gt; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> `log_failed_logins`; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> `log_failed_logins` ( `unic_id` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> AUTO_INCREMENT, `datetime` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `user_name` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_name` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_IP` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (`unic_id`) ) ENGINE=MyISAM AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> CHARSET=utf8; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> `users`; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> `users` ( `id` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) unsigned <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> AUTO_INCREMENT, `username` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `salt` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">50</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `groupname` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">24</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `uid` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) unsigned <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `gid` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) unsigned <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `homedir` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">70</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `shell` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `last_login` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `login_count` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `last_error_login` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `login_error_count` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (`id`) ) ENGINE=MyISAM AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> CHARSET=utf8; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> `xfer_errors`; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> `xfer_errors` ( `unic_id` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> AUTO_INCREMENT, `datetime` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `user_name` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `file_and_path` tinytext <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_name` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_IP` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_command` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (`unic_id`) ) ENGINE=MyISAM AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> CHARSET=utf8; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> `xfer_table`; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> `xfer_table` ( `unic_id` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> AUTO_INCREMENT, `datetime` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `user_name` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `file_and_path` tinytext <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `bytes` <span class="hljs-type"><span class="hljs-type">int</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, `client_name` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">127</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_IP` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `client_command` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, `send_time` <span class="hljs-type"><span class="hljs-type">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">9</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span> (`unic_id`) ) ENGINE=InnoDB AUTO_INCREMENT=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> CHARSET=utf8;</code> </pre> <br></div></div><br><h3>  Step 3. Configure proftpd </h3><br><div class="spoiler">  <b class="spoiler_title">Add to /etc/proftpd.conf</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">UseReverseDNS <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> AuthOrder mod_sql.c AuthPAM <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> #    PAM &lt;IfModule mod_dso.c&gt; LoadModule mod_sql.c LoadModule mod_sql_mysql.c (  mysql) LoadModule mod_sql_postgres.c (  postgres) LoadModule mod_sql_passwd.c &lt;/IfModule&gt; SQLPasswordEngine <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> SQLPasswordEncoding hex SQLPasswordOptions HashEncodeSalt SQLAuthTypes Crypt SQLAuthenticate users SQLConnectInfo DBUSER@DBHOST:DBPORT DBNAME DBPASSWD SQLUserInfo users username <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> uid gid homedir shell SQLMinUserUID <span class="hljs-number"><span class="hljs-number">50</span></span> SQLMinUserGID <span class="hljs-number"><span class="hljs-number">50</span></span> RequireValidShell <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> SQLNamedQuery <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-salt <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> "salt FROM users WHERE username = '%U'" SQLPasswordUserSalt <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>:/<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-salt Append</code> </pre> <br></div></div><br>  Further, the configuration for postgres and mysql differs in the syntax of SQL queries: <br><br><div class="spoiler">  <b class="spoiler_title">PostgreSQL</b> <div class="spoiler_text"><pre> <code class="hljs perl">SQLLog PASS counter_login SQLNamedQuery counter_login UPDATE <span class="hljs-string"><span class="hljs-string">"\ last_login=date_trunc ( 'seconds' ,\ timestamp without time zone 'now' ),\ login_count=login_count+1 WHERE \ username='%u'"</span></span> users SQLLog ERR_PASS counter_err SQLNamedQuery counter_err UPDATE <span class="hljs-string"><span class="hljs-string">"\ last_error_login=date_trunc ( 'seconds' ,\ timestamp without time zone\'now' ), \ login_error_count=login_error_count+1 WHERE \ username='%U'"</span></span> users SQLLog ERR_PASS log_fails SQLNamedQuery log_fails INSERT <span class="hljs-string"><span class="hljs-string">"nextval('log_failed_logins_id_seq'::regclass), date_trunc ('seconds',timestamp without time zone 'now'),'%U','%h','%a'"</span></span> log_failed_logins SQLLog DELE,RETR,STOR log_story_transfer SQLNamedQuery log_story_transfer INSERT <span class="hljs-string"><span class="hljs-string">"nextval('xfer_table_id_seq'::regclass), date_trunc ('seconds',timestamp without time zone 'now'),'%u', \ '%f','%b','%h','%a','%m', '%T'"</span></span> xfer_table SQLLOG ERR_RETR,ERR_STOR,ERR_DELE,ERR_RMD,ERR_RNTO \ log_err_modify SQLNamedQuery log_err_modify INSERT <span class="hljs-string"><span class="hljs-string">"nextval('xfer_errors_id_seq'::regclass), date_trunc ('seconds',timestamp without time zone 'now'),'%u', \ '%f','%h','%a','%m'"</span></span> xfer_errors</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Mysql</b> <div class="spoiler_text"><pre> <code class="hljs sql">SQLNamedQuery get-user-salt <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"salt FROM users WHERE username = '%U'"</span></span> SQLPasswordUserSalt <span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>:/<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">salt</span></span> Append SQLLog PASS counter_login SQLNamedQuery counter_login <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">"\ last_login=now(),\ login_count=login_count+1 WHERE \ username='%u'"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> SQLLog ERR_PASS counter_err SQLNamedQuery counter_err <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-string"><span class="hljs-string">"\ last_error_login=now(), \ login_error_count=login_error_count+1 WHERE \ username='%U'"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> SQLLog ERR_PASS log_fails SQLNamedQuery log_fails <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-string"><span class="hljs-string">"'', now(),'%U','%h','%a'"</span></span> log_failed_logins SQLLog DELE,RETR,STOR log_story_transfer SQLNamedQuery log_story_transfer <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-string"><span class="hljs-string">"'', now(),'%u', \ '%f', '%b', '%h', '%a', '%m', '%T'"</span></span> xfer_table SQLLOG ERR_RETR,ERR_STOR,ERR_DELE,ERR_RMD,ERR_RNTO log_err_modify SQLNamedQuery log_err_modify <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-string"><span class="hljs-string">"'', now(), '%u', '%f', '%h', '%a', '%m'"</span></span> xfer_errors</code> </pre> <br></div></div><br><h3>  Step 4. Scripts for management </h3><br>  To manage users in the database, I wrote 3 simple perl scripts: ftpadduser, ftpdeluser and ftppasswd + a single config to them, so as not to prescribe the same variables in each of them: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/proftpd_sql.conf</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"># <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Configuration</span></span> # sql_type can be "mysql" <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> "postgres" <span class="hljs-keyword"><span class="hljs-keyword">ONLY</span></span>! sql_type mysql sql_host DBHOST sql_user DBUSER sql_passwd DBPASSWD sql_db DBNAME # FTP Settings # <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> FTP directory ftp_dir /home/ftp #     ,       ftp_groupname ftpadm ftp_uid <span class="hljs-number"><span class="hljs-number">507</span></span> ftp_gid <span class="hljs-number"><span class="hljs-number">507</span></span> ftp_shell /dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ftpadduser</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">#!/usr/bin/perl -wl use strict; use <span class="hljs-type"><span class="hljs-type">Crypt</span></span>::<span class="hljs-type"><span class="hljs-type">PasswdMD5</span></span> qw(unix_md5_crypt); use <span class="hljs-type"><span class="hljs-type">DBI</span></span>; use <span class="hljs-type"><span class="hljs-type">DBD</span></span>::mysql; use <span class="hljs-type"><span class="hljs-type">Config</span></span>::<span class="hljs-type"><span class="hljs-type">Simple</span></span>; my <span class="hljs-string"><span class="hljs-string">$c</span></span>fg = new <span class="hljs-type"><span class="hljs-type">Config</span></span>::<span class="hljs-type"><span class="hljs-type">Simple</span></span>(<span class="hljs-string"><span class="hljs-string">'/etc/proftpd_sql.conf'</span></span>); my %<span class="hljs-type"><span class="hljs-type">Config</span></span> = <span class="hljs-string"><span class="hljs-string">$c</span></span>fg-&gt;vars(); my <span class="hljs-string"><span class="hljs-string">$d</span></span>sn; if (<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_type} eq <span class="hljs-comment"><span class="hljs-comment">"mysql"</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>sn = <span class="hljs-comment"><span class="hljs-comment">"dbi:mysql:dbname=$Config{sql_db};host=$Config{sql_host};"</span></span>; } elsif (<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_type} eq <span class="hljs-comment"><span class="hljs-comment">"postgres"</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>sn = <span class="hljs-comment"><span class="hljs-comment">"dbi:Pg:dbname=$Config{sql_db};host=$Config{sql_host};"</span></span>; } else { die(<span class="hljs-comment"><span class="hljs-comment">"Incorrect \$sql_type in config"</span></span>); } if (@<span class="hljs-type"><span class="hljs-type">ARGV</span></span> &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { print <span class="hljs-comment"><span class="hljs-comment">"Usage: $0 ftpuser password."</span></span>; exit; } my <span class="hljs-string"><span class="hljs-string">$f</span></span>tpuser = <span class="hljs-string"><span class="hljs-string">$A</span></span>RGV[<span class="hljs-number"><span class="hljs-number">0</span></span>]; my <span class="hljs-string"><span class="hljs-string">$d</span></span>bh = <span class="hljs-type"><span class="hljs-type">DBI</span></span>-&gt;connect(<span class="hljs-string"><span class="hljs-string">$d</span></span>sn, <span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_user},<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_passwd}, {<span class="hljs-type"><span class="hljs-type">AutoCommit</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>}); my <span class="hljs-string"><span class="hljs-string">$f</span></span>tp_user_exists = usercheck(<span class="hljs-string"><span class="hljs-string">$A</span></span>RGV[<span class="hljs-number"><span class="hljs-number">0</span></span>]); if (<span class="hljs-string"><span class="hljs-string">$f</span></span>tp_user_exists!=<span class="hljs-number"><span class="hljs-number">0</span></span>) { print <span class="hljs-comment"><span class="hljs-comment">"$0: user $ARGV[0] already exits."</span></span>; exit; } elsif (-e <span class="hljs-comment"><span class="hljs-comment">"$Config{ftp_dir}/$ftpuser"</span></span> and -d <span class="hljs-comment"><span class="hljs-comment">"$Config{ftp_dir}/$ftpuser"</span></span>) { print <span class="hljs-comment"><span class="hljs-comment">"$0: directory $Config{ftp_dir}/$ftpuser/ exists, check the path."</span></span>; exit; } else { mkdir(<span class="hljs-comment"><span class="hljs-comment">"$Config{ftp_dir}/$ftpuser"</span></span>); chown <span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{ftp_uid},<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{ftp_gid}, <span class="hljs-comment"><span class="hljs-comment">"$Config{ftp_dir}/$ftpuser"</span></span>; chmod <span class="hljs-number"><span class="hljs-number">0700</span></span>, <span class="hljs-comment"><span class="hljs-comment">"$Config{ftp_dir}/$ftpuser"</span></span>; my <span class="hljs-string"><span class="hljs-string">$f</span></span>tppass = <span class="hljs-string"><span class="hljs-string">$A</span></span>RGV[<span class="hljs-number"><span class="hljs-number">1</span></span>]; my <span class="hljs-string"><span class="hljs-string">$s</span></span>alt = gensalt(<span class="hljs-number"><span class="hljs-number">8</span></span>); my <span class="hljs-string"><span class="hljs-string">$e</span></span>ncrypted = unix_md5_crypt(<span class="hljs-string"><span class="hljs-string">$f</span></span>tppass, <span class="hljs-string"><span class="hljs-string">$s</span></span>alt); my <span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql; if (<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_type} eq <span class="hljs-comment"><span class="hljs-comment">"mysql"</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql = <span class="hljs-comment"><span class="hljs-comment">"INSERT INTO users SET username='$ftpuser', password='$encrypted', salt='$salt', groupname='$Config{ftp_groupname}', uid='$Config{ftp_uid}', gid='$Config{ftp_gid}', homedir='$Config{ftp_dir}/$ftpuser', shell='$Config{ftp_shell}', login_count=0, login_error_count=0"</span></span>; } elsif (<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_type} eq <span class="hljs-comment"><span class="hljs-comment">"postgres"</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql = <span class="hljs-comment"><span class="hljs-comment">"INSERT INTO users "</span></span>; <span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql .= <span class="hljs-comment"><span class="hljs-comment">"(id, username, password, salt, groupname, uid, gid, homedir, shell, last_login, login_count, last_error_login, login_error_count) "</span></span>; <span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql .= <span class="hljs-comment"><span class="hljs-comment">"VALUES (nextval('users_id_seq'::regclass), '$ftpuser', '$encrypted', '$salt', '$Config{ftp_groupname}', '$Config{ftp_uid}', '$Config{ftp_gid}', "</span></span>; <span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql .= <span class="hljs-comment"><span class="hljs-comment">" '$Config{ftp_dir}/$ftpuser', '$Config{ftp_shell}', NULL, 0, NULL, 0);"</span></span>; } <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;do(<span class="hljs-string"><span class="hljs-string">$d</span></span>bh_sql); print <span class="hljs-comment"><span class="hljs-comment">"FTP user $ARGV[0] added."</span></span>; } <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;disconnect; sub usercheck { my <span class="hljs-string"><span class="hljs-string">$s</span></span>th; my <span class="hljs-string"><span class="hljs-string">$f</span></span>tpuser = shift; my <span class="hljs-string"><span class="hljs-string">$r</span></span>eq = <span class="hljs-comment"><span class="hljs-comment">"select id from users where username='$ftpuser'"</span></span>; <span class="hljs-string"><span class="hljs-string">$s</span></span>th = <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;prepare(<span class="hljs-string"><span class="hljs-string">$r</span></span>eq); if (!<span class="hljs-string"><span class="hljs-string">$s</span></span>th) { my <span class="hljs-string"><span class="hljs-string">$t</span></span>mp=<span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;errstr; print <span class="hljs-comment"><span class="hljs-comment">"$tmp.\n$req failed."</span></span>; } elsif (!<span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;execute) { my <span class="hljs-string"><span class="hljs-string">$t</span></span>mp=<span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;errstr; print <span class="hljs-comment"><span class="hljs-comment">"$tmp.\n$req failed."</span></span>; } elsif (<span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;rows()!=<span class="hljs-number"><span class="hljs-number">1</span></span>) { return <span class="hljs-number"><span class="hljs-number">0</span></span>; } else { my <span class="hljs-string"><span class="hljs-string">$r</span></span>ef = <span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;fetchrow_arrayref; return <span class="hljs-string"><span class="hljs-string">$$</span></span>ref[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;finish; } sub gensalt { my <span class="hljs-string"><span class="hljs-string">$c</span></span>ount = shift; my @salt = ( <span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> .. <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> .. <span class="hljs-string"><span class="hljs-string">'Z'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span> .. <span class="hljs-string"><span class="hljs-string">'z'</span></span> ); my <span class="hljs-string"><span class="hljs-string">$s</span></span>alt; for (<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-string"><span class="hljs-string">$c</span></span>ount) { <span class="hljs-string"><span class="hljs-string">$s</span></span>alt .= (@salt)[rand @salt]; } return <span class="hljs-string"><span class="hljs-string">$s</span></span>alt; } &lt;/spoiler&gt; &lt;spoiler title=<span class="hljs-comment"><span class="hljs-comment">"ftpdeluser"</span></span>&gt; #!/usr/bin/perl -w use strict; use <span class="hljs-type"><span class="hljs-type">Crypt</span></span>::<span class="hljs-type"><span class="hljs-type">PasswdMD5</span></span> qw(unix_md5_crypt); use <span class="hljs-type"><span class="hljs-type">DBI</span></span>; use <span class="hljs-type"><span class="hljs-type">DBD</span></span>::mysql; use <span class="hljs-type"><span class="hljs-type">Config</span></span>::<span class="hljs-type"><span class="hljs-type">Simple</span></span>; my <span class="hljs-string"><span class="hljs-string">$c</span></span>fg = new <span class="hljs-type"><span class="hljs-type">Config</span></span>::<span class="hljs-type"><span class="hljs-type">Simple</span></span>(<span class="hljs-string"><span class="hljs-string">'/etc/proftpd_sql.conf'</span></span>); my %<span class="hljs-type"><span class="hljs-type">Config</span></span> = <span class="hljs-string"><span class="hljs-string">$c</span></span>fg-&gt;vars(); my <span class="hljs-string"><span class="hljs-string">$d</span></span>sn; if (<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_type} eq <span class="hljs-comment"><span class="hljs-comment">"mysql"</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>sn = <span class="hljs-comment"><span class="hljs-comment">"dbi:mysql:dbname=$Config{sql_db};host=$Config{sql_host};"</span></span>; } elsif (<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_type} eq <span class="hljs-comment"><span class="hljs-comment">"postgres"</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>sn = <span class="hljs-comment"><span class="hljs-comment">"dbi:Pg:dbname=$Config{sql_db};host=$Config{sql_host};"</span></span>; } else { die(<span class="hljs-comment"><span class="hljs-comment">"Incorrect \$sql_type in config"</span></span>); } my <span class="hljs-string"><span class="hljs-string">$r</span></span>ec = <span class="hljs-number"><span class="hljs-number">0</span></span>; my <span class="hljs-string"><span class="hljs-string">$c</span></span>leanlogs = <span class="hljs-number"><span class="hljs-number">0</span></span>; my <span class="hljs-string"><span class="hljs-string">$f</span></span>tpuser = <span class="hljs-string"><span class="hljs-string">$A</span></span>RGV[<span class="hljs-number"><span class="hljs-number">0</span></span>]; if (@<span class="hljs-type"><span class="hljs-type">ARGV</span></span> &lt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { print <span class="hljs-comment"><span class="hljs-comment">"Usage: $0 ftpuser\n"</span></span>; exit; } my <span class="hljs-string"><span class="hljs-string">$d</span></span>bh = <span class="hljs-type"><span class="hljs-type">DBI</span></span>-&gt;connect(<span class="hljs-string"><span class="hljs-string">$d</span></span>sn, <span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_user},<span class="hljs-string"><span class="hljs-string">$C</span></span>onfig{sql_passwd}, {<span class="hljs-type"><span class="hljs-type">AutoCommit</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>}); my <span class="hljs-string"><span class="hljs-string">$f</span></span>tp_user_exists = usercheck(<span class="hljs-string"><span class="hljs-string">$A</span></span>RGV[<span class="hljs-number"><span class="hljs-number">0</span></span>]); if (<span class="hljs-string"><span class="hljs-string">$f</span></span>tp_user_exists==<span class="hljs-number"><span class="hljs-number">0</span></span>) { print <span class="hljs-comment"><span class="hljs-comment">"$0: user $ARGV[0] not found."</span></span>; exit; } if (-d <span class="hljs-comment"><span class="hljs-comment">"$Config{ftp_dir}/$ftpuser"</span></span>) { print <span class="hljs-comment"><span class="hljs-comment">"Do you want to remove user's home directory recursively? (Yes/No): "</span></span>; my <span class="hljs-string"><span class="hljs-string">$a</span></span>ns1 = &lt;<span class="hljs-type"><span class="hljs-type">STDIN</span></span>&gt;; if (<span class="hljs-string"><span class="hljs-string">$a</span></span>ns1 eq <span class="hljs-comment"><span class="hljs-comment">"Yes\n"</span></span> or <span class="hljs-string"><span class="hljs-string">$a</span></span>ns1 eq <span class="hljs-comment"><span class="hljs-comment">"Y\n"</span></span>) { <span class="hljs-string"><span class="hljs-string">$r</span></span>ec = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } print <span class="hljs-comment"><span class="hljs-comment">"Do you want to cleanup database user activity logs? (Yes/No): "</span></span>; my <span class="hljs-string"><span class="hljs-string">$a</span></span>ns2 = &lt;<span class="hljs-type"><span class="hljs-type">STDIN</span></span>&gt;; if (<span class="hljs-string"><span class="hljs-string">$a</span></span>ns2 eq <span class="hljs-comment"><span class="hljs-comment">"Yes\n"</span></span> or <span class="hljs-string"><span class="hljs-string">$a</span></span>ns2 eq <span class="hljs-comment"><span class="hljs-comment">"Y\n"</span></span>) { <span class="hljs-string"><span class="hljs-string">$c</span></span>leanlogs = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;do(<span class="hljs-comment"><span class="hljs-comment">"DELETE FROM users WHERE id=$ftp_user_exists"</span></span>); if (<span class="hljs-string"><span class="hljs-string">$c</span></span>leanlogs == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;do(<span class="hljs-comment"><span class="hljs-comment">"DELETE FROM log_failed_logins WHERE user_name='$ftpuser'"</span></span>); <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;do(<span class="hljs-comment"><span class="hljs-comment">"DELETE FROM xfer_errors WHERE user_name='$ftpuser'"</span></span>); <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;do(<span class="hljs-comment"><span class="hljs-comment">"DELETE FROM xfer_table WHERE user_name='$ftpuser'"</span></span>); } print <span class="hljs-comment"><span class="hljs-comment">"FTP user $ARGV[0] deleted, "</span></span>; if (<span class="hljs-string"><span class="hljs-string">$r</span></span>ec == <span class="hljs-number"><span class="hljs-number">1</span></span>) { system(<span class="hljs-comment"><span class="hljs-comment">"rm -rf $Config{ftp_dir}/$ftpuser"</span></span>); print <span class="hljs-comment"><span class="hljs-comment">"with homedir.\n"</span></span>; } else { print <span class="hljs-comment"><span class="hljs-comment">"homedir kept.\n"</span></span>; } <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;disconnect; sub usercheck { my <span class="hljs-string"><span class="hljs-string">$s</span></span>th; my <span class="hljs-string"><span class="hljs-string">$f</span></span>tpuser = shift; my <span class="hljs-string"><span class="hljs-string">$r</span></span>eq = <span class="hljs-comment"><span class="hljs-comment">"select id from users where username='$ftpuser'"</span></span>; <span class="hljs-string"><span class="hljs-string">$s</span></span>th = <span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;prepare(<span class="hljs-string"><span class="hljs-string">$r</span></span>eq); if (!<span class="hljs-string"><span class="hljs-string">$s</span></span>th) { my <span class="hljs-string"><span class="hljs-string">$t</span></span>mp=<span class="hljs-string"><span class="hljs-string">$d</span></span>bh-&gt;errstr; print <span class="hljs-comment"><span class="hljs-comment">"$tmp.\n$req failed."</span></span>; } elsif (!<span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;execute) { my <span class="hljs-string"><span class="hljs-string">$t</span></span>mp=<span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;errstr; print <span class="hljs-comment"><span class="hljs-comment">"$tmp.\n$req failed."</span></span>; } elsif (<span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;rows()!=<span class="hljs-number"><span class="hljs-number">1</span></span>) { return <span class="hljs-number"><span class="hljs-number">0</span></span>; } else { my <span class="hljs-string"><span class="hljs-string">$r</span></span>ef = <span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;fetchrow_arrayref; return <span class="hljs-string"><span class="hljs-string">$$</span></span>ref[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-string"><span class="hljs-string">$s</span></span>th-&gt;finish; }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">ftppasswd</b> <div class="spoiler_text"><pre> <code class="hljs mel">#!/usr/bin/perl -wl use strict; use Crypt::PasswdMD5 qw(unix_md5_crypt); use DBI; use DBD::mysql; use Config::Simple; my $cfg = new Config::Simple(<span class="hljs-string"><span class="hljs-string">'/etc/proftpd_sql.conf'</span></span>); my %Config = $cfg-&gt;vars(); my $dsn; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Config{sql_type} eq <span class="hljs-string"><span class="hljs-string">"mysql"</span></span>) { $dsn = <span class="hljs-string"><span class="hljs-string">"dbi:mysql:dbname=$Config{sql_db};host=$Config{sql_host};"</span></span>; } elsif ($Config{sql_type} eq <span class="hljs-string"><span class="hljs-string">"postgres"</span></span>) { $dsn = <span class="hljs-string"><span class="hljs-string">"dbi:Pg:dbname=$Config{sql_db};host=$Config{sql_host};"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { die(<span class="hljs-string"><span class="hljs-string">"Incorrect \$sql_type in config"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (@ARGV &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Usage: $0 ftpuser password."</span></span>; exit; } my $ftppass = $ARGV[<span class="hljs-number"><span class="hljs-number">1</span></span>]; my $dbh = DBI-&gt;connect($dsn, $Config{sql_user},$Config{sql_passwd}, {AutoCommit =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>}); my $ftp_uid = usercheck($ARGV[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($ftp_uid==<span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$0: user $ARGV[0] not found."</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { my $salt = gensalt(<span class="hljs-number"><span class="hljs-number">8</span></span>); my $encrypted = unix_md5_crypt($ftppass, $salt); $dbh-&gt;<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>(<span class="hljs-string"><span class="hljs-string">"UPDATE users SET password='$encrypted',salt='$salt' where id=$ftp_uid"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"FTP password for user $ARGV[0] changed."</span></span>; } $dbh-&gt;disconnect; sub usercheck { my $sth; my $ftpuser = shift; my $req = <span class="hljs-string"><span class="hljs-string">"select id from users where username='$ftpuser'"</span></span>; $sth = $dbh-&gt;prepare($req); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$sth) { my $tmp=$dbh-&gt;errstr; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$tmp.\n$req failed."</span></span>; } elsif (!$sth-&gt;execute) { my $tmp=$sth-&gt;errstr; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$tmp.\n$req failed."</span></span>; } elsif ($sth-&gt;rows()!=<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { my $ref = $sth-&gt;fetchrow_arrayref; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $$ref[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } $sth-&gt;finish; } sub gensalt { my $count = shift; my @salt = ( <span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> .. <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> .. <span class="hljs-string"><span class="hljs-string">'Z'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span> .. <span class="hljs-string"><span class="hljs-string">'z'</span></span> ); my $salt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-number"><span class="hljs-number">1.</span></span>.$count) { $salt .= (@salt)[<span class="hljs-keyword"><span class="hljs-keyword">rand</span></span> @salt]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $salt; }</code> </pre> <br></div></div><br>  As a result, I received an FTP server with the storage of database users' passwords in encrypted form, user management and logging to the database. </div><p>Source: <a href="https://habr.com/ru/post/350338/">https://habr.com/ru/post/350338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350326/index.html">Cheat Sheet for Technical Interview</a></li>
<li><a href="../350328/index.html">Reinforcement training never worked</a></li>
<li><a href="../350332/index.html">Vue.js + Asp.Net Core MVC + TypeScript and more Bootstrap4</a></li>
<li><a href="../350334/index.html">One day at Alfa-Bank: mobile development</a></li>
<li><a href="../350336/index.html">System crafting in the Cursed Lands</a></li>
<li><a href="../350340/index.html">The history of one automation project, or how to implement a mixed accounting of fixed assets with a single tool</a></li>
<li><a href="../350342/index.html">Restart designer. How to say goodbye to the routine and reach a new level</a></li>
<li><a href="../350346/index.html">Introduction to recommender systems</a></li>
<li><a href="../350350/index.html">Useful to the designer / developer. Fresh utilities and tools to speed up work. Issue number 9</a></li>
<li><a href="../350354/index.html">Country as a data center specialist: what is Norway going to do</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>