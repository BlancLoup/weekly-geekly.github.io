<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimization of image processing using GPU on the example of Median filtering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 Long since graphic accelerators (GPU) were created for image processing and video. At some point, the GPU began to be used for genera...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimization of image processing using GPU on the example of Median filtering</h1><div class="post__text post__text-html js-mediator-article"><h1>  Introduction </h1><br><p>  Long since graphic accelerators (GPU) were created for image processing and video.  At some point, the GPU began to be used for general purpose calculations.  But the development of central processors did not stand still either: Intel was actively developing the development of vector extensions (AVX256, AVX512, AVX1024).  As a result, different processors appear - Core, Xeon, Xeon Phi.  Image processing can be attributed to this class of algorithms that are easily vectorized. <br>  But as practice shows, despite the rather high level of compilers and manufacturability of Xeon Phi central processors and co-processors, it is not so easy to make image processing using vector instructions, as modern compilers do not cope with automatic vectorization, and using vector intrinsic functions is rather laborious.  It also raises the question of combining vectorized code and scalar sections. </p><a name="habracut"></a><br><p>  This <a href="https://habrahabr.ru/post/204682/">article</a> has discussed how to use vector extensions to optimize median filtering for CPUs.  For the purity of the experiment, I took all the same conditions as the author: I used the median filtering algorithm using a 3x3 square, these images take 8 bits per pixel, the processing of the frame (depending on the size of the filtering square) is not done;  and tried to optimize this core on the GPU.  The algorithm of the median filtering of squares 5x5 was also considered.  The essence of the algorithm is as follows: </p><br><ul><li>  For each point of the original image, a certain neighborhood is taken (in our case, 3x3 / 5x5). </li><li>  The points of this neighborhood are sorted by increasing brightness. </li><li>  The average point of the sorted neighborhood is written to the final image. </li></ul><br><h1>  The first implementation of the kernel on the GPU </h1><br><p>  In order not to engage in "extra" optimization, we will use some calculations of the author of the article mentioned.  And in the end you get simple code computational core </p><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-function">__device__ __inline__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> d = a - b; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> m = ~(d &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>); b += d &amp; m; a -= d &amp; m; } <span class="hljs-function"><span class="hljs-function">__global__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> H, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> W, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *in, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *out)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = threadIdx.x + blockIdx.x * blockDim.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idy = threadIdx.y + blockIdx.y * blockDim.y + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a[<span class="hljs-number"><span class="hljs-number">9</span></span>] = {}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idy &lt; H - <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; idx &lt; W - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; z2 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++z2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; z1 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++z1) a[<span class="hljs-number"><span class="hljs-number">3</span></span> * z2 + z1] = in[(idy - <span class="hljs-number"><span class="hljs-number">1</span></span> + z2) * W + idx - <span class="hljs-number"><span class="hljs-number">1</span></span> + z1]; Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">8</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">1</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">8</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">3</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">8</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); out[idy * W + idx] = (unsigned <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)a[<span class="hljs-number"><span class="hljs-number">4</span></span>]; } }</code> </pre> <br><p>  For each point, the neighborhood is loaded according to the given picture (the pixel of the image for which you want to calculate the result is highlighted in yellow): </p><br><img src="https://habrastorage.org/files/aa6/4f2/2e0/aa64f22e06634a50b2408cf7d1c1a053.png"><br><p>  In this implementation, there is one drawback - the image is stored in an 8-bit format, and calculations take place in a 32-bit one.  If you look into the combat code of the vector implementation on the CPU, you can see that there have been many optimizations, including eliminating unnecessary operations during sorting, since depending on the compiler, optimization may not work.  The Nvidia compiler lacks such flaws - it can easily deploy two cycles on z2 and z1 even if no #pragma unroll is specified (in this case, the compiler will decide whether to roll the loop itself, and if there are not enough registers, then the cycles will not be deployed) as well as unnecessary operations of the Sort functions after their substitution will be excluded (the <strong>inline</strong> directive is advisory, if you need to substitute the function, regardless of how the compiler decides, you must use <strong>forceinline</strong> ). <br>  I will test on the Nvidia GTX 780 Ti GPU of approximately the same year of production as the central processor in the article above (Intel Core-i7 4770 3.4 GHz).  Image size is 1920 x 1080 black and white.  If we run the compiled first version on the GPU, we get the following times: </p><br><table><tbody><tr><th colspan="3">  Runtime, ms </th><th colspan="3">  Relative acceleration </th></tr><tr><td>  Scalar CPU </td><td>  AVX2 CPU </td><td>  Version1 GPU </td><td>  Scalar / AVX2 </td><td>  Scalar / Version1 </td><td>  AVX2 / Version1 </td></tr><tr><td align="center">  24.814 </td><td align="center">  0.424 </td><td align="center">  0.372 </td><td align="center">  58.5 </td><td align="center">  66.7 </td><td align="center">  1.13 </td></tr></tbody></table><br><p>  As can be seen from the above times, simply rewriting the code "natively" and running it on the GPU, we get quite a good acceleration, and there are no problems with aligning the image size - the code on the GPU will work equally well on any image size (respectively, starting from some size when the GPU is fully loaded).  You also don‚Äôt have to think about memory alignment - the compiler will do everything for us; it‚Äôs enough to allocate memory using special CUDA RunTime functions. <br>  Many who are faced with graphics accelerators, will immediately say that you need to download data and unload it back.  With a PCIe 3.0 speed of 15 GB / s, for a 2 MB image, about 130 microseconds are obtained for one-way transfer.  Thus, if stream processing of images takes place, the download + upload will take about 260 microseconds, while the counting takes about 372 microseconds, which means that even in the most "native" implementation, transmissions to the GPU are covered.  You can also conclude that faster than 260 microseconds per image, you cannot handle the stream of images.  But if this filter is used together with another dozen of filters during the processing of one image, then further optimization of this kernel becomes useful. </p><br><h1>  The second implementation of the kernel on the GPU </h1><br><p>  In order to increase the efficiency of sorting operations, you can use newly added SIMD instructions.  These instructions are intrinsics functions that allow you to compute a certain mathematical function for two unsigned / signed short or for 4 unsigned / signed char in one operation.  A list of available functions can be found in the Cuda ToolKit <a href="http://docs.nvidia.com/cuda/cuda-math-api/group__CUDA__MATH__INTRINSIC__SIMD.html">documentation</a> .  We need two functions: vminu4 (unsigned a, usnigned b) and vmaxu4 (unsigned a, unsigned b);  calculating the minimum and maximum for 4 without the sign 8-bit values.  To load four values, we divide the entire image into 4 parts horizontally and each block will load data from 4 bands, combining 4 loaded points using a bit-wise shift into an unsigned int: </p><br><img src="https://habrastorage.org/files/5f5/6af/ce3/5f56afce3151472396e0e7f2d296caab.png"><br><p>  The active processing area is the uppermost square with a size of 1920 x 270. Accordingly, a block of 128 x 1 threads is shown in orange, which will load 128 * 4 elements.  As is known, the size of the warp on the GPU consists of 32x threads.  All threads of one warp perform one instruction per clock at a time.  Since each thread will load to itself 4 unsigned char elements, one warp in total will process 128 elements per instruction, that is, some 1024 bit processing is obtained.  For the CPU, 256 bit AVX2 registers are currently available (which will turn into 512 and 1024 bit in the future).  With these optimizations, the computational kernel code is converted to the following form: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">__device__ __inline__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;a, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;b)</span></span></span><span class="hljs-function"> </span></span>{ unsigned t = a; a = __vminu4(t, b); b = __vmaxu4(t, b); } <span class="hljs-function"><span class="hljs-function">__global__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__launch_bounds__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mFilter_3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> H, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> W, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * __restrict in, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unsigned stride_Y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = threadIdx.x + blockIdx.x * blockDim.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idy = threadIdx.y + blockIdx.y * blockDim.y + <span class="hljs-number"><span class="hljs-number">1</span></span>; unsigned a[<span class="hljs-number"><span class="hljs-number">9</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &lt; W - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; z3 &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++z3) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idy &lt; H - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> shift = <span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">3</span></span> - z3); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; z2 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++z2) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; z1 &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>; ++z1) a[<span class="hljs-number"><span class="hljs-number">3</span></span> * z2 + z1] |= in[(idy - <span class="hljs-number"><span class="hljs-number">1</span></span> + z2) * W + idx - <span class="hljs-number"><span class="hljs-number">1</span></span> + z1] &lt;&lt; shift; } idy += stride_Y; } Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">8</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">1</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">8</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">3</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">8</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">2</span></span>]); idy = threadIdx.y + blockIdx.y * blockDim.y + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z = <span class="hljs-number"><span class="hljs-number">0</span></span>; z &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++z) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idy &lt; H - <span class="hljs-number"><span class="hljs-number">1</span></span>) out[idy * W + idx] = (unsigned <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)((a[<span class="hljs-number"><span class="hljs-number">4</span></span>] &gt;&gt; (<span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">3</span></span> - z))) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>); idy += stride_Y; } } }</code> </pre> <br><p>  As a result of small changes, we increased the number of processed elements to 4x (or 128 elements per instruction).  The complexity of the code has increased and the compiler generates too many registers, which makes it impossible to load the hcp by 100%.  Since we still have simple calculations, we will tell the compiler that we want to run the maximum possible number of threads on each stream processor (maximum for a given GPU is 2048 threads) using __launch_bounds (128, 16), which means that A configuration of 16 blocks of 128 threads each was launched.  And one more innovation - we will add the restrict keyword to use the texture cache to load duplicate data (if analyzed, there are quite a few of them, most of the points are read 3 times).  In order for the texture cache to be enabled, you also need to specify const.  All together, the instruction will look like this: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> unsigned <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * __restrict in.</code> </pre> <br><p>  Corresponding times of the second version: </p><br><table><tbody><tr><th colspan="4">  Runtime, ms </th><th colspan="4">  Relative acceleration </th></tr><tr><td>  Scalar CPU </td><td>  AVX2 CPU </td><td>  Version1 GPU </td><td>  Version2 GPU </td><td>  Scalar / AVX2 </td><td>  Scalar / Version2 </td><td>  AVX2 / Version2 </td><td>  Version1 / Version2 </td></tr><tr><td align="center">  24.814 </td><td align="center">  0.424 </td><td align="center">  0.372 </td><td align="center">  0.207 </td><td align="center">  58.5 </td><td align="center">  119.8 </td><td align="center">  2.04 </td><td align="center">  1.79 </td></tr></tbody></table><br><h1>  Third kernel implementation on the GPU </h1><br><p>  Already received not a bad acceleration.  But you can see that loading 4 elements with such a distance causes too many repeated downloads.  This significantly reduces speed.  Is it possible to somehow use what we have already loaded directly on the registers and improve the locality of the data?  Yes you can!  Let these 4 lines are now located close to each other, and the beginning of the blocks will be "smeared" along the entire height with a distance of 4. Thus, taking into account the block size of the threads in Y, we arrive at the following code: </p><br><pre> <code class="java hljs">#define BL_X <span class="hljs-number"><span class="hljs-number">128</span></span> #define BL_Y <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-function"><span class="hljs-function">__device__ __inline__ </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;a, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;b)</span></span></span><span class="hljs-function"> </span></span>{ unsigned t = a; a = __vminu4(t, b); b = __vmaxu4(t, b); } <span class="hljs-function"><span class="hljs-function">__global__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__launch_bounds__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mFilter_3a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> H, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> W, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * __restrict in, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *out)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = threadIdx.x + blockIdx.x * blockDim.x + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idy = threadIdx.y + blockIdx.y * blockDim.y * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>; unsigned a[<span class="hljs-number"><span class="hljs-number">9</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &lt; W - <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; z3 &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++z3) { <span class="hljs-comment"><span class="hljs-comment">//if (idy &lt; H - 1) &lt;---- this is barrier for compiler optimization { const int shift = 8 * (3 - z3); for (int z2 = 0; z2 &lt; 3; ++z2) for (int z1 = 0; z1 &lt; 3; ++z1) a[3 * z2 + z1] |= in[(idy - 1 + z2) * W + idx - 1 + z1] &lt;&lt; shift; } idy += BL_Y; } Sort(a[1], a[2]); Sort(a[4], a[5]); Sort(a[7], a[8]); Sort(a[0], a[1]); Sort(a[3], a[4]); Sort(a[6], a[7]); Sort(a[1], a[2]); Sort(a[4], a[5]); Sort(a[7], a[8]); Sort(a[0], a[3]); Sort(a[5], a[8]); Sort(a[4], a[7]); Sort(a[3], a[6]); Sort(a[1], a[4]); Sort(a[2], a[5]); Sort(a[4], a[7]); Sort(a[4], a[2]); Sort(a[6], a[4]); Sort(a[4], a[2]); idy = threadIdx.y + blockIdx.y * blockDim.y * 4 + 1; for (int z = 0; z &lt; 4; ++z) { if (idy &lt; H - 1) out[idy * W + idx] = (unsigned char)((a[4] &gt;&gt; (8 * (3 - z))) &amp; 255); idy += BL_Y; } } }</span></span></code> </pre> <br><p>  Optimized code in this way allows the compiler to use already loaded data.  The only problem is the condition check (idy &lt;H - 1).  In order to remove this check, you need to add the required number of lines, that is, align the image vertically by 4, and fill in all the additional elements with the maximum number (255).  After converting the code to the third option, the times will be as follows: </p><br><table><tbody><tr><th colspan="5">  Runtime, ms </th><th colspan="3">  Relative acceleration </th></tr><tr><td>  Scalar CPU </td><td>  AVX2 CPU </td><td>  Version1 GPU </td><td>  Version2 GPU </td><td>  Version2 GPU </td><td>  Scalar / AVX2 </td><td>  Scalar / Version3 </td><td>  AVX2 / Version3 </td></tr><tr><td align="center">  24.814 </td><td align="center">  0.424 </td><td align="center">  0.372 </td><td align="center">  0.207 </td><td align="center">  0.130 </td><td align="center">  58.5 </td><td align="center">  190.8 </td><td align="center">  3.26 </td></tr></tbody></table><br><p>  Further, it is already quite difficult to optimize, since there are not so many calculations here.  The issue of shared memory has not been raised here.  There were some attempts to use shared memory, but the best time I could not get.  If you link the processing speed of the image with its size, then regardless of whether the picture is aligned in size or not, you can get about 15 GigaPixels / second. </p><br><h1>  The core of the median filter 5x5 on the GPU </h1><br><p>  By applying all the optimizations, you can implement a 5x5 square filter with minor changes.  The complexity of this code is the correct implementation of partial bitonic sorting for 25 elements.  By analogy, you can implement filters of any size (starting with some filter size, there will surely be a quick general sorting algorithm). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">__global__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__launch_bounds__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">256</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">8</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mFilter5a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> H, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> W, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * in, unsigned </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> unsigned stride_Y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = threadIdx.x + blockIdx.x * blockDim.x + <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idy = <span class="hljs-number"><span class="hljs-number">4</span></span> * threadIdx.y + blockIdx.y * blockDim.y * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idx &lt; W - <span class="hljs-number"><span class="hljs-number">2</span></span>) { unsigned a[<span class="hljs-number"><span class="hljs-number">25</span></span>] = { <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t = <span class="hljs-number"><span class="hljs-number">0</span></span>; t &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++t) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> shift = <span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">3</span></span> - t); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> q = <span class="hljs-number"><span class="hljs-number">0</span></span>; q &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; ++q) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z = <span class="hljs-number"><span class="hljs-number">0</span></span>; z &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>; ++z) a[q * <span class="hljs-number"><span class="hljs-number">5</span></span> + z] |= (in[(idy - <span class="hljs-number"><span class="hljs-number">2</span></span> + q) * W + idx - <span class="hljs-number"><span class="hljs-number">2</span></span> + z] &lt;&lt; shift); idy++; } Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">1</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">3</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">9</span></span>], a[<span class="hljs-number"><span class="hljs-number">10</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">8</span></span>], a[<span class="hljs-number"><span class="hljs-number">10</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">8</span></span>], a[<span class="hljs-number"><span class="hljs-number">9</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">13</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">11</span></span>], a[<span class="hljs-number"><span class="hljs-number">13</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">11</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">15</span></span>], a[<span class="hljs-number"><span class="hljs-number">16</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">14</span></span>], a[<span class="hljs-number"><span class="hljs-number">16</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">14</span></span>], a[<span class="hljs-number"><span class="hljs-number">15</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">18</span></span>], a[<span class="hljs-number"><span class="hljs-number">19</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">17</span></span>], a[<span class="hljs-number"><span class="hljs-number">19</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">17</span></span>], a[<span class="hljs-number"><span class="hljs-number">18</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">21</span></span>], a[<span class="hljs-number"><span class="hljs-number">22</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">20</span></span>], a[<span class="hljs-number"><span class="hljs-number">22</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">20</span></span>], a[<span class="hljs-number"><span class="hljs-number">21</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">23</span></span>], a[<span class="hljs-number"><span class="hljs-number">24</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">5</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">3</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">4</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">11</span></span>], a[<span class="hljs-number"><span class="hljs-number">14</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">8</span></span>], a[<span class="hljs-number"><span class="hljs-number">14</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">8</span></span>], a[<span class="hljs-number"><span class="hljs-number">11</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">15</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">9</span></span>], a[<span class="hljs-number"><span class="hljs-number">15</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">9</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">13</span></span>], a[<span class="hljs-number"><span class="hljs-number">16</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">16</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">13</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">20</span></span>], a[<span class="hljs-number"><span class="hljs-number">23</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">17</span></span>], a[<span class="hljs-number"><span class="hljs-number">23</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">17</span></span>], a[<span class="hljs-number"><span class="hljs-number">20</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">21</span></span>], a[<span class="hljs-number"><span class="hljs-number">24</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">18</span></span>], a[<span class="hljs-number"><span class="hljs-number">24</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">18</span></span>], a[<span class="hljs-number"><span class="hljs-number">21</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">19</span></span>], a[<span class="hljs-number"><span class="hljs-number">22</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">9</span></span>], a[<span class="hljs-number"><span class="hljs-number">18</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">18</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">8</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">0</span></span>], a[<span class="hljs-number"><span class="hljs-number">9</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">19</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">19</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">10</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">11</span></span>], a[<span class="hljs-number"><span class="hljs-number">20</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">20</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">21</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">2</span></span>], a[<span class="hljs-number"><span class="hljs-number">11</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">21</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">13</span></span>], a[<span class="hljs-number"><span class="hljs-number">22</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">22</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">13</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">14</span></span>], a[<span class="hljs-number"><span class="hljs-number">23</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">23</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">14</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">15</span></span>], a[<span class="hljs-number"><span class="hljs-number">24</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">24</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">15</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">16</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">19</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">13</span></span>], a[<span class="hljs-number"><span class="hljs-number">21</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">15</span></span>], a[<span class="hljs-number"><span class="hljs-number">23</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">13</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">15</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">1</span></span>], a[<span class="hljs-number"><span class="hljs-number">9</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">3</span></span>], a[<span class="hljs-number"><span class="hljs-number">11</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">5</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">11</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">9</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">10</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">14</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">6</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">4</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">14</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">14</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">7</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">10</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">6</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">17</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">10</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">18</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">7</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">18</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">12</span></span>], a[<span class="hljs-number"><span class="hljs-number">20</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">20</span></span>]); Sort(a[<span class="hljs-number"><span class="hljs-number">10</span></span>], a[<span class="hljs-number"><span class="hljs-number">12</span></span>]); idy = <span class="hljs-number"><span class="hljs-number">4</span></span> * threadIdx.y + blockIdx.y * blockDim.y * <span class="hljs-number"><span class="hljs-number">4</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> z = <span class="hljs-number"><span class="hljs-number">0</span></span>; z &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>; ++z) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (idy &lt; H - <span class="hljs-number"><span class="hljs-number">2</span></span>) out[idy * W + idx] = (unsigned <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)((a[<span class="hljs-number"><span class="hljs-number">12</span></span>] &gt;&gt; (<span class="hljs-number"><span class="hljs-number">8</span></span> * (<span class="hljs-number"><span class="hljs-number">3</span></span> - z))) &amp; <span class="hljs-number"><span class="hljs-number">255</span></span>); idy++; } } }</code> </pre> <br><p>  The processing speed of the filter of this size will be about 5.7 times faster when using the AVX2, while the GPU version will slow down just 3.8 times (about 0.5 ms).  The final acceleration on the GPU with a median filtering square 5x5 can reach 5 times compared with the AVX2 version. </p><br><h1>  Conclusion </h1><br><p>  In conclusion, you can sum up some of the results.  By optimizing a sequential scalar program, you can get great accelerations using a graphics processor.  For median filters, depending on the filtering radius, the acceleration values ‚Äã‚Äãcan reach 1000 times!  Of course, a very optimal version using AVX2 instructions dramatically reduces the gap between the GPU and the CPU.  But personally, from my own experience, I can conclude that vectorizing code manually is not as easy as it actually seems.  On the contrary, even the most "native" implementation on the GPU gives quite high accelerations.  And in most cases it is enough.  And if we consider that the number of graphics cards in one motherboard may be more than one, the overall acceleration of processing images or video may increase linearly. <br>  The question of whether to use the GPU or not, is rhetorical.  Of course, in tasks of image processing and video, the GPU will show better performance and with increasing computational load, the difference between the processing speed of the CPU and the GPU will increase in favor of the latter. </p><br><p>  Combat optimizations are available in the second article: <a href="https://habrahabr.ru/post/308214/">Faster, faster or in-depth optimization of Median filtering for Nvidia GPUs.</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305964/">https://habr.com/ru/post/305964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305950/index.html">The use of cloud technologies in stock trading - features and prospects</a></li>
<li><a href="../305952/index.html">Usability Testing: Do you want to know the truth about your users?</a></li>
<li><a href="../305954/index.html">How do FortiASIC ‚Äã‚Äãprocessors work?</a></li>
<li><a href="../305956/index.html">Yandex.Toloka. How people help teach machine intelligence</a></li>
<li><a href="../305960/index.html">Control Flow Guard. The principle of work and workarounds on the example of Adobe Flash Player</a></li>
<li><a href="../305966/index.html">Teach practical security: Summer internship at Positive Technologies</a></li>
<li><a href="../305968/index.html">.NET conference DotNext 2016 Moscow, December 9</a></li>
<li><a href="../305970/index.html">From England to the Mysterious Island, along with the heroes of the novels of Jules Verne</a></li>
<li><a href="../305972/index.html">Artyom Geller will be mentor of the final hackathon ‚ÄúBudgetApps‚Äù</a></li>
<li><a href="../305974/index.html">How to start using Swing GUI-wizard IntelliJ IDEA. detailed instructions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>