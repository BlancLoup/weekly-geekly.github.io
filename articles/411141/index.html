<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart Home on Arduino for dog house</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nothing unusual, just another controller on the Arduino. With sensors, relays and a web page. But with its features and quite specific practical appli...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart Home on Arduino for dog house</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/7o/3k/or/7o3kora9koagtgemf_xxr71mlkk.jpeg"><br><br>  Nothing unusual, just another controller on the Arduino.  With sensors, relays and a web page.  But with its features and quite specific practical application, albeit rather banal - the remote inclusion of electric heating in the country.  Quotation marks in the header are not random, the controller is not a smart home in the current version, but serves as a good basic blank for it.  <i>(note - this phrase was added on April 12, 18 based on the results of comments).</i> <br><br>  Key features: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  The gauge of the electrical network parameters is the Neva electric power meter via RS-485; </li><li>  Remote modification of the management web page lying on the SD card; </li><li>  Reliable inclusion of a group of Dallas temperature sensors on long lines; </li><li>  Graphs of changes in parameters without the involvement of cloud services; </li><li>  Fault-tolerant solutions (external watchdog, UPS, automatic restart of the router); </li><li>  Protection of izernet-schild from freezes in case of interference from power relays; </li><li>  Finished design in DIN rail housing. </li></ul><a name="habracut"></a><br>  I did this system slowly, as entertainment, from time to time throwing the project for months ... Some one and a half years passed from idea to implementation :) <br><br>  Since I hadn‚Äôt dealt with microcontrollers at all, I started with a starter set with aliexpress, played with LEDs, buttons and sensors, understood something like that, and started building a controller for remote control and monitoring.  Well, not straight "smart home" of course, but something about that. <br><br>  The practical goal was first set one - remotely turn on the heating in the country.  I did not have time to build a house (my hands did not reach, yeah), but then I have a wonderful, comfortable cottage with full stuffing, heated with electric convectors.  In advance to warm the sheds that have cooled down in a week by Friday evening - a very tempting opportunity during the cold season. <br><br>  However, the task of remote load control turned out to be quite trivial.  Arduino plus izernet-shild, ready-made sketch from the Internet, and relyushki already clicked from the checkmarks on the web page.  The practical goal was achieved somehow very quickly and simply.  And it was boring.  I wanted something more interesting. <br><br>  He set himself a second practical goal - to monitor the current consumption in the dacha power grid.  Acquired simple current sensors for tests, played.  Everything worked well, but this option was not suitable for combat work.  Sensors more powerful than 5A, I could not find, but I had to at least 25A. <br><br>  And I had the idea to use an electricity meter as an electrical sensor.  And it was a beautiful thought!  And I created a device such, and saw that it was good!  Not without difficulties, but I completed this task excellently in the end, and I‚Äôll tell you about it with a feeling of deep satisfaction :). <br><br>  <b>Functional</b> <br><br>  The first (and so far the last) combat version of the controller "smart dog" has the following functionality: <br><br><ul><li>  Remote manual control of switching on the power relays through the browser and control of their current state; </li><li>  Remote monitoring of the parameters of the three-phase power supply network (voltage, current, frequency and many more unnecessary garbage, which I then turned off); </li><li>  Remote monitoring of readings of a two-tariff electricity meter; </li><li>  Remote monitoring of a group of temperature sensors; </li><li>  Logging data and registering events on a memory card; </li><li>  Display in the browser data from all sensors for the selected day in the form of graphs. </li></ul><br>  <b>Ideology</b> <br><br>  The principle of building the entire system - without the use of third-party cloud services and data collection and display servers.  This is neither good nor bad.  At the initial stage of "smart home building" such a scheme is sufficient and simple.  Although it imposes certain restrictions on use. <br><br>  Arduino with izernet-shield is the only web server in the system.  The web page with the management interface is stored on the memory card of the Izernet-Shield and is transmitted to the browser when accessing it to the specified IP address.  Further interaction of the user interface with Arduino is carried out through java-scripts, whose bodies are not embedded in the web page, but are stored in my home file storage with Internet access.  This approach reduces the weight of the web page, which speeds up its reading from the SD card, and allows you to more quickly and simply modify the script code. <br><br>  Reading the log data for displaying graphs is made from a memory card on request (pressing a button in the browser).  The data is displayed only in the current session, the browser pages are not saved anywhere, and when the page is reloaded, it is necessary to read them again.  This is a minus of ideology, since reading from a memory card is rather slow, and getting a daily amount of data can take a minute or two (it was thought to rework the data storage format to reduce their size and speed up reading). <br><br>  The current values ‚Äã‚Äãof the sensors are displayed on the page and are updated in real time with the frequency of the loop cycle, which is about 1 Hz. <br><br>  There is no ‚Äúintelligence‚Äù in the algorithm now.  I will not know whether the algorithm will be instructed in the future, so far the current version suits me completely. <br><br>  <b>Network topology</b> <br><br>  At the dacha mobile Internet Yota (usb-modem + wifi-router).  There is no fixed IP address, and there is no opportunity to receive it either, even for money.  Yes, and even a dynamic white IP-address is not, therefore DynDNS does not apply.  Only gray IP address of the internal Yota network.  IPota Yota does not support (at least for 2017 it is).  Therefore, I found only one way to reach the country router from the outside - VPN. <br><br>  At home (in the city) wired internet with a white fixed IP address.  Router, followed by network storage.  A VPN server is raised on this home router.  The country router is configured to raise the VPN VPN tunnel via PPTP to the home router. <br><br>  The controller on Arduino is connected to the LAN port of the country router and sits behind NAT, the 80th port is forwarded to it.  Thus, I can get access to Arduino only from my VPN.  Accordingly, my local network and VPN are two segments of the same subnet, access is direct there.  I set up a VPN connection on my working office computer and on my smartphone and also got access to Arduino.  Not very convenient to use, but it works.  Yes, and relative security is provided - without authorization in my VPN, no one else can get to the controller's management page. <br><br>  The bottleneck is the VPN tunnel to the country router.  Periodically falls.  Moreover, it is the PPTP connection that is being broken, access to the Internet remains.  And the worst thing is that when a PPTP connection is broken, it no longer rises.  It does not help even rebooting the router.  Only a full restart on power along with a USB modem, and then not immediately.  It is necessary to turn it off, wait 10 minutes, turn it on again.  Lucky - well, no - next iteration.  The reason, according to Zyxel technical support, is to block PPTP packets by the cellular operator, since one side correctly sends, the second listens correctly, but the data does not reach (at both ends of the VPN tunnel I have Zyxel routers).  Yota is to blame, but it is impossible to get anything intelligible from them.  And maybe not Yota. <br><br>  <b>Watchdog</b> <br><br>  To ensure a relatively uninterrupted VPN operation, I use a software log <strike>crutch</strike> - the country router is powered through a power relay controlled by Arduina, and as soon as the VPN server stops pinging (Arduin pings too), then after 10 minutes the router is removed from the router for 10 minutes, then the router again The PPTP connection is turned on and expected to be established within 5 minutes.  If there is no connection, the next iteration.  Sometimes this compound works steadily for weeks and even months, and sometimes it begins to break almost daily.  There is no other way to solve the problem at all.  As I have already said, Yota does not support IPv6, white IP does not give and does not sell to physicists, there is no other provider with normal tariffs and certainly no limit.  However, this solution, although a crutch, but performs its task very well.  Now I always have a connection, with very few exceptions, when I get at the time of the reboot. <br><br>  In addition to software, I also implemented a hardware watchdog.  Just in case.  The controller should work for weeks and even sometimes for months in the absence of me, and not hang.  How all this economy will behave in big minuses was unknown to me, therefore I was insured.  The watchdog built into Atmega did not suit me by not working at all for Arduino Mega out of the box, and in order to make it work, it was necessary to have a thorough sex.  This problem is well described <a href="https://geektimes.ru/post/255800/">here</a> .  In addition, he had a maximum interval of 8 seconds, which seemed to me insufficient.  Therefore, I applied the TPL5000DGST watchdog timer microcircuit, the interval of which is set by a combination of three pins and can reach 64 seconds, which suits me perfectly.  For this microcircuit, I purchased a small prototype, soldered it and fixed it on the connector with the IO-ports of Arduina (the photo will be lower in the section about the assembly).  The tests showed the reliable operation of this watchdog, and I was wondering how often it will work in reality.  To do this, I added a variable to the program code, where the time and date of the program launch are stored, and this information is displayed on the management web page.  Practice has shown that, unlike VPN, the controller runs uninterruptedly for a long time, and the watchdog timer has so far never come in handy (while writing the article, the watchdog did work for the first time, but it was not for nothing).  The time of continuous work reached more than 3 months and there could be more if I didn‚Äôt need to add something to the code from time to time and reflash the controller. <br><br>  <b>Sensor of electrical network parameters - Neva electric meter</b> <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/geektimes/post_images/845/f35/bd5/845f35bd5d12bc60384f1aa0bb1506aa.jpg" width="200"></a> <br><br>  As I mentioned above, in my opinion, it is impossible to find anything better and more accurate as a sensor for the parameters of the electrical network than a modern digital electricity meter with an external data access interface.  I chose the Neva counter of the St. Petersburg company Taypit with RS-485 interface. <br><br>  I emphasize that an electric meter with wires of the 485th interface which are constantly connected to it is not officially allowed to be used as a metering device ( <b>update</b> : in the <a href="https://geektimes.ru/post/299483/">comments it was</a> suggested that it was allowed).  Therefore, in the dacha power grid, I put two counters in series.  The first one is the official electricity metering device, sealed up and registered, located in the street opening shield.  The second one is my sensor of the electric network parameters, unsealed and unaccounted for, on which the power supply company already doesn‚Äôt give a damn, since it doesn‚Äôt care about everything that is installed after the metering device.  This electric meter is already located in the panel inside the dog house, and in the same panel there is also a controller on Arduino, but, about this a bit later. <br><br>  At the cottage I have a three-phase power grid.  In the city, I have the opportunity to debug only on a single phase.  Therefore, I purchased two meters, the three-phase Neva MT-324 and the single-phase Neva MT-124.  The initial debugging of the controller was done on the table on a three-phase counter with one phase connected, then it was installed in the dacha panel in the combat mode of operation.  Debugging of the following software modifications was done on a cheaper single-phase counter on the table: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/a5a/5cb/6fb/a5a5cb6fb932dea11badc7f06376e22d.jpg" width="640"></a> <br><br>  To connect the meter to Arduino, an RS-485 to TTL level converter is required: <br> <a href=""><img height="200" src="https://habrastorage.org/getpro/geektimes/post_images/258/07f/e5a/25807fe5acb55ec27d079d024a24b1f0.jpg" width="200"></a> <br><br>  Also, to work with the meter you need a free serial port on the Arduino.  Unfortunately, the Arduino Uno has only one serial port, taking which under the counter would have lost the debug output of textual information (the port monitor), and without this it is impossible to write a sketch.  Therefore, I use Arduino Mega, which has several serial ports.  It would be possible to implement the second serial port soft through the Arduino digital ports, but I could not find the appropriate library with the ability to change other port settings besides speed.  And the counter port settings are different from the default ones: 9600 bitrate, 7 data bits, 1 stop bit, even parity control.  The standard Serdu object in Arduino, fortunately, allows you to make these settings. <br><br>  The exchange protocol with the counter was relatively easy to obtain - the counter manufacturer <a href="https://www.meters.taipit.ru/catalog/neva/trehfaznyie-schetchiki/171/">in the public domain</a> has a parameter reading program for Windows, which also has a port monitor.  To connect the meter to a computer, I used the interface converter MOXA 232/432 / 485USB.  Some time for a visual analysis of the packages - and I selected the main commands. <br><br>  However, this did not seem enough to me, and I turned to the manufacturer by e-mail.  After a month of correspondence with the company Taypit, I finally managed to get a full list of commands with interpretation: <br><br>  <a href="https://goo.gl/AjsiHp">Character encoding MT3XX E4S</a> <br>  <a href="https://goo.gl/X4ELRg">Coding parameters NEVA MT124 AS OP (E4P)</a> <br><br>  Next is the case of technology - to write a parameter polling cycle under Arduino and, for starters, bring them to the port monitor.  The time of one cycle was about a second.  However, in the final version of the project with logging data to a flash drive and polling temperature sensors, this time increased to 4-x seconds.  This did not suit me at all and had to plunge into optimization.  As a result, I again achieved a second interval without loss of functionality.  By the way, I rewritten the sketch from scratch two or three times until I found the right architecture and cost-effective algorithms. <br><br>  <b>Software implementation of the exchange with the counter</b> <br><br>  The code is torn from the context of my big working sketch.  Compiled, but in this form, I never ran it.  I cite for example only, and not as a finished work program.  Although in theory everything should work in this form. <br><br>  The code is written for two types of meters simultaneously, single-phase MT-124 and three-phase MT-324.  The choice of the type of counter occurs in the program automatically by the response word of the initiating command. <br><br>  I bring the code as it is, without beautiful and additional comments except for those that I wrote for myself.  And yes, I'm not a programmer, and I don‚Äôt even learn from it, so I shouldn‚Äôt kick me for the quality of the code, but I can teach how to code: <a href="https://goo.gl/awf6EP">EnergyMeterNeva.ino</a> <br><br>  A huge additional plus of the electricity meter is a reliable and accurate real-time clock.  I did not have to provide the system with an additional module, which still needs to be found not just anyhow, but a quality one.  The current time, up to a second, I get from the counter, among other data.  Yes, relative to atomic time, the time of the counter is slightly shifted (a few seconds), I don‚Äôt know what it is connected with, with a poor-quality factory setting or something else, but the accuracy is excellent, just with a slight offset. <br><br>  In rare moments, when the power supply in the country is turned off and the meter becomes unavailable, I get the current time from Arduina's internal timer.  When the electric meter is working and its data is available, I re-write the Arduine internal timer with the value from the counter on each loop loop.  When the counter falls off - the current time continues to tick on the Arduina timer. <br><br>  In addition to reading the parameters of the counter, of course, you can and program.  That is, the interface works on both reading and writing.  However, I with such difficulties sought the protocol of reading commands, that I didn‚Äôt even give a hint about the request of the record protocol to the manufacturer.  Firstly, it was no good for me, except maybe just a little time to move.  Secondly, I suspect that this data is no longer open, since it can be used for fraudulent purposes. <br><br>  <b>Temperature sensors</b> <br><br>  I have already <a href="https://kirillov-sv.blogspot.ru/2016/01/ds18b20.html">conducted a</a> test of temperature sensors using a sketch example separately earlier.  Now it was necessary only to build in their poll into the main project.  It was no difficulty.  All nine sensors I had worked without problems when connected in parallel via 1-Wire.  The scatter of readings between them was about 0.5 degrees, which indicates the senselessness of using them at maximum accuracy of 0.0625 degrees.  Sensors for the test assembled in a pack and wrapped in several layers of polyethylene foam.  For greater accuracy, I placed the pack vertically and waited 24 hours for the full equalization of temperature.  The readings of all the sensors were not the same. <br><br>  However, I didn‚Äôt bother to deactivate the accuracy of temperature conversion of the sensors either.  It would be simpler to round the readings programmatically, but I would not get the benefits of the survey time, because I came up with an algorithm where the conversion waiting time is not an empty useless delay (750).  The usual logic of working with sensors is as follows: first, issuing a command to start temperature conversion, then waiting for the conversion to finish (those are at least 750 ms), and then read the data.  I did the opposite, which allowed me to eliminate the empty waiting interval - first I read the data from the sensors, and then immediately start the conversion.  And while the rest of the code in the LOOP loop runs, the data just have time to prepare for reading in the next round.  By the time I get the data from the sensors in this case a little later - the LOOP cycle takes about 1-1.5 seconds, but this is absolutely not critical. <br><br>  Sometimes from all sensors I received data "85" or "0".  I didn‚Äôt understand what a jamb is, so I did a check in the code and excluded such data from getting into the result.  I also found a joint in one of the sensors - it did not hold the settings when the power was turned off.  Either its internal flash drive is dead, or something else.  Therefore, in the setup I have registered the sensor settings, and now on power-up (if it still disappears), all the sensors are set to be guaranteed. <br><br>  I obtained the addresses of specific sensors using a sketch example, somewhere dug up and slightly modified by me: <a href="https://goo.gl/cky22m">DS18x20_Temperature.ino</a> <br><br>  After that I scored the addresses with constants in the array and in the main program I turned to the sensors right away at their addresses: <a href="https://goo.gl/UeZwTQ">TempSensors_DS18B20.ino</a> <br><br>  For proper operation of the sensors on the 1-Wire bus, a 4.7 kŒ© pull-up resistor is required between the data line and the power supply.  It was convenient for me to solder an SMD resistor between the pins of the terminal block, but I found only 5.1 kOhm in my suitable case and put it up (it is visible on the photo in the section on the assembly on the bottom side of the board).  Everything works well. <br><br>  My temperature sensors are connected electrically in parallel on one long line (+5, gnd and data), all 9 pieces, but tricky.  Physically, twisted-pair cables are connected by a star for easy wiring sensors across the object.  In each cable arm, I use two pairs.  One pair is powering the sensor.  The second pair is a data line that goes along one wire to the sensor and returns from it back along the second wire.  Thus, it is possible to separate cables from the shield with a star, but electrically it is a star only in terms of power, and according to data it is one line.  This connection option turned out to be more reliable in working on long lines; with a simple parallel connection, there were many failures when reading data.  Here is a sketch of such a scheme: <br><br> <a href=""><img height="300" src="https://habrastorage.org/getpro/geektimes/post_images/84e/1a3/b3d/84e1a3b3d64983af4236a6dad5458a52.jpg" width="640"></a> <br><br>  I did not shorten the half-meter tails of the three-wire cables of the sensors themselves, connected them as they were, turned out to be not critical. <br><br>  In total, there are three cables divorced, two for external sensors, one for each, and one for all seven remaining internal ones.  These seven internal sensors are connected in the same way, but within the same long cable and with short branches from it (see the lower T-shaped configuration in the sketch).  Somewhere the standard half-meter tail of the sensor was enough for a branch, somewhere it was branched using the same twisted pair. <br><br>  Two-wire connection of sensors, with the so-called.  I didn‚Äôt use parasitic power (when the sensors are powered by the data line) because ... why?  I would take four-pair cables anyway, just because I had them.  There are no problems with cable laying.  And the scheme with parasitic power is critical to the amount of current consumption in some modes of operation, unnecessary problems could arise. <br><br>  The total length of the twisted pair cable trailer was approximately 25 meters.  Pieces for external sensors are 5 and 10 meters, and a ten-meter internal piece with branches to seven sensors.  Everything works almost perfectly.  Only occasionally skips dashes instead of temperature values.  This means that the data from a particular sensor was read incorrectly.  But it happens so rarely (I notice once a month it can) that it does not cause any problems. <br><br>  <b>Remote access</b> <br><br>  For remote access to Arduino, an Ethernet shield was purchased.  With the built-in library, working with it, as with everything else in Arduino, turned out to be quite simple. <br><br>  Functionally, I have such a work scheme.  A web server is raised on Arduino, which, when a client (browser) accesses it, generates a web page with various information.  Auto-update of data on the page is implemented via javascript, polling the server by timer. <br><br>  The page also has a set of controls for controlling the actuators connected to the Arduino - power relays that commute the load - electric heaters and lighting. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the design of the web page, I was not steamed, especially since the minimum amount of text data was needed to load it faster, so the most primitive html is all: </font><font style="vertical-align: inherit;">In the html code, I have embedded tags instead of data, which are replaced on the fly with real data when generating the page server. When auto-updating data on request javascript, they are transferred to the browser directly from the microcontroller in JSON format.</font></font><br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/geektimes/post_images/1e0/2fa/c9e/1e02fac9e6e1e8c5a16d0a7c07667f94.png" width="475"></a> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code of the pages lies in a file on the memory card and is loaded from it when accessing the server. </font><font style="vertical-align: inherit;">For a quicker and more convenient modification of the page code, I built in the mechanism of its updating into it myself. </font><font style="vertical-align: inherit;">Below, under the main control block there is a text field and the Submit button. </font><font style="vertical-align: inherit;">I copy the new html-code into the text field, press the button, after which the java-script sends the data to the controller's web server, which saves it first to a spooled file. </font><font style="vertical-align: inherit;">If the transfer was successful, the main file is replaced by the buffer, the page is automatically updated.</font></font> Everything.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Changes accepted. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I give code snippets of my implementation of this mechanism. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the html-page we embed the form:</font></font><br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://domain/send_HTM.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"font-size: 14px;"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> CONTROL.HTM:<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cols</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rows</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">wrap</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"off"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"htm"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textarea</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"send_HTM();"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"progress"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"display:none"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"label"</span></span></span><span class="hljs-tag">&gt;</span></span>  :<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:800px;border:1px solid #000"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bar"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"background:#00f;height:10px;width:0px"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The ‚ÄúSend‚Äù button launches the following java script: <a href="https://goo.gl/opmDrB">send_HTM.js</a> <br><br>  In the sketch in the function of processing web server requests, the following actions are defined by the prefixes in the query 'CONTROL.HTM' (start sending the file), 'htmlineN' (sending row No.) and 'END_CONTROL.HTM' (end of sending the file): <br><br><pre> <code class="hljs lua">File acceptHtmFile; ................ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fl_accept_htm) //  <span class="hljs-string"><span class="hljs-string">'CONTROL.HTM'</span></span> { SD.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(CTRL_HTM); acceptHtmFile = SD.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(CTRL_HTM, FILE_WRITE); //     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!acceptHtmFile) //      -    { #ifdef DEBUG_SD Serial.println(<span class="hljs-string"><span class="hljs-string">"SD-card not found"</span></span>); #endif client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"FAIL"</span></span>); client.stop(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"OK_OPEN_FILE"</span></span>); acceptHtmMode = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fl_htmline) //  <span class="hljs-string"><span class="hljs-string">'htmlineN'</span></span> { int b = acceptHtmFile.println(tag); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (b == <span class="hljs-number"><span class="hljs-number">0</span></span>) { client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"FAIL"</span></span>); acceptHtmMode = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; cntHtmModeIteration = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"OK"</span></span>); } cntHtmModeIteration = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fl_endhtm) //  <span class="hljs-string"><span class="hljs-string">'END_CONTROL.HTM'</span></span> { SD.<span class="hljs-built_in"><span class="hljs-built_in">remove</span></span>(CONTROL_HTM); acceptHtmFile.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); File htmlFile = SD.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(CONTROL_HTM, FILE_WRITE); //    acceptHtmFile = SD.<span class="hljs-built_in"><span class="hljs-built_in">open</span></span>(CTRL_HTM); //    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; acceptHtmFile.size(); i++) { digitalWrite(PIN_WATCHDOG_DONE, <span class="hljs-number"><span class="hljs-number">1</span></span>); htmlFile.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(acceptHtmFile.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>()); digitalWrite(PIN_WATCHDOG_DONE, <span class="hljs-number"><span class="hljs-number">0</span></span>); } acceptHtmFile.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); htmlFile.<span class="hljs-built_in"><span class="hljs-built_in">close</span></span>(); client.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"OK_CLOSE_FILE"</span></span>); acceptHtmMode = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; cntHtmModeIteration = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br>  The defaults CONTROL_HTM and CTRL_HTM here are the names of the html files.  The first is the main file, the second is the spooled file.  In the array of char tags is the text of the received string, selected from the request.  The logic is as follows: when receiving data, they are written into a spooled file, after receiving the spooled file is overwritten into the main one.  How easy it is to rename the files, I could not understand, in the standard SD library there is no such function, therefore, stupid character-by-character copying takes a lot of time. <br><br>  It would be convenient to store the code of the web page of the control not on the controller's memory card, but on the client machine, or load it from some external resource.  But the ban on cross-domain queries does not allow this.  Javascripts can send their requests only to the north from which they downloaded themselves.  The bodies of javascripts can be loaded from anywhere, it is only important where the page with their call was loaded from. <br><br>  <b>Data logging</b> <br><br>  The Ethernet shield has an onboard micro SD card slot.  It is because of its presence that I decided to write data to the log files.  There is also a built-in library for working with a memory card, and managing the writing and reading of files with it is generally elementary. <br><br>  To save data, I built the logging algorithm so that the recording occurs only when the data changes by more than a predetermined threshold.  For temperature it is 0.1 ¬∞, for voltage it is 0.2V.  Data is written to one file in one day.  At zero hours a new file is created.  The storage format I chose plain text, delimited, so that you can quickly monitor the contents of files when debugging, and it would be easy to load into Excel. <br><br>  Design constraints do not allow conveniently insert-remove a memory card, so I used a large-capacity card.  According to my calculations, it will be filled for several years, after which it will be necessary to subdivide the case, remove the memory card and clean it. <br><br>  I don‚Äôt see the meaning of the logging code, everything is completely trivial - a banal text entry to the file.  Yes, and this code is spread over the whole sketch (not only the parameters of the sensors are logged, but also various one-time events), it is difficult to isolate. <br><br>  <b>Charts</b> <br><br>  As a graphing engine, I use a very flexible javascript library for data visualization <a href="https://www.amcharts.com/products/">amchart</a> .  The library is free and available for download and offline use.  I also located this library on my online storage with constant access to the Internet.  Connect and use it with the default settings is not difficult, but in order to get the result that I needed, I had to tinker a lot.  It helped a huge number of examples on the site and the availability of detailed documentation. <br><br>  For example, give your javascript drawing graphs.  It is useless by itself, as it works only in aggregate with the web server, and with the html page, and, possibly, is tied to other scripts (it was a long time ago, I don‚Äôt remember all the details).  But the appearance settings of my graphs can be contained in it and you can draw them from there: <a href="https://goo.gl/kLf8ha">get_log.js</a> <br><br>  The big advantage of the amchart library is that it can draw the correct graphs from ‚Äúragged‚Äù data.  As I mentioned above, I save the data in the log only when it is changed.  That is, it happens asynchronously and chaotically.  New data may not be a few minutes, and then in a few seconds they will change several times.  Accordingly, entries in the log go with arbitrary time intervals.  Amchart when drawing takes this into account on its own, I do not need to interpolate the data before drawing.  I just send the dataset as it is, and I see a nice time-uniform timeline. <br><br>  I found only one drawback of this library - it does not know how (or I did not understand how) to update graphics in real time in a human way.  You can add new data to the existing ones, but the redrawing is performed every time completely the entire data array, and this greatly slows down the browser.  However, the very ideology of reading data from Arduin for drawing at the request from the browser is flawed by its non-optimality, therefore there was no point in fighting for a quick update in real time. <br><br>  The correct solution would be to organize a separate server for storing and visualizing data, where real-time data would drop from the Arduina bit and stored in the database, and from where they could quickly be sent to the user in the browser for visualization. <br><br>  Now the graphics look like this (on the example of the day when there is no one in the bungalow and, accordingly, there is no energy consumption).  When current data appears, the scale is automatically set so that everything fits nicely, and the values ‚Äã‚Äãof current levels appear on the vertical axis: <br><br> <a href=""><img height="246" src="https://habrastorage.org/getpro/geektimes/post_images/12e/6d5/7e5/12e6d57e563012ba95a5407a1f96a88e.png" width="640"></a> <br><br>  The graphs are displayed on the same page where the control takes place, right below the main control unit. <br><br>  I do not intentionally cite a complete set of project source codes for several reasons: <br><br><ol><li>  It cannot be run as it is on any other network except mine, since I did not try to make the project portable, and it is tightly tied to my addresses and my network topology. </li><li>  I am sure that the overall ideology of the project suffers from a variety of problems, since this is my first attempt in the field in which I understand poorly.  Therefore, I do not offer anyone the whole project to be repeated in this form.  I shared only those moments in which I was less sure. </li><li>  The project was done long and long, and I will never remember all the details and can not explain a number of solutions.  The size of the sketch is very large (by my standards, about 2 thousand lines), there are more than a dozen different serving Java scripts, I didn‚Äôt do the iron schematic.  That is, I can not help advisory on most issues. </li></ol><br>  <b>Assembly</b> <br><br>  From the very beginning I set myself a goal - to make a complete device, and not just a mockup with a pile of wires on the table: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/721/a45/ba3/721a45ba3d536cfbf0d3b302c32cdd3b.jpg" width="640"></a> <br><br>  And immediately decided that the device is what I want to place inside the switchboard.  There and food, and the counter, and in general, it is convenient. <br><br>  This required dinreech body.  At first I thought about developing it and printing it on a 3D printer.  But I don‚Äôt have my own 3D printer, but what my colleagues at work on their self-assembled printers print doesn‚Äôt suit me the quality of appearance.  Found on the market <a href="https://www.chipdip.ru/catalog-show/plastic-cases%3Fx.1206%3DvJt">ready-made housing</a> for a DIN-rail (of different sizes), look good, it is convenient to use (collapsible), and even a <a href="https://www.chipdip.ru/product/d9mg-pcb-a">mole-fee</a> for them is specially ready-made. <br><br>  I bought the largest case so that not only Arduino with the izernet-shield would be housed in it, but also a relay for switching the load: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/674/493/325/6744933251f7abeed45267d51d2c2e59.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/aed/1dc/c27/aed1dcc279af58de00af5e68f30b8aac.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/fe1/cbb/ab7/fe1cbbab760347fda7df0edf2b0a9c09.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/0f9/13b/250/0f913b2504dcef41d4156e23015f5fef.jpg" width="640"></a> <br><br>  Next was a long and fascinating process of mounting all the tripe into the hull.  Under this case, I even bought myself a wonderful soldering iron with a sleep function (my soldering irons were all still from Soviet times): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/8f7/cff/613/8f7cff613a071eb2ee93cd09c3286622.jpg" width="640"></a> <br><br>  For installation, I bought a bunch of various small stands, screws, washers and gadgets.  First approximate assembly: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/c28/ff1/ac7/c28ff1ac7b46d25bf58714949091c7d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/fd9/c60/001/fd9c6000193beeb0a82cf14d7ca56cda.jpg" width="640"></a> <br><br>  To connect the wires to the top pins, we had to use bent pins, otherwise it would not fit into the case: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/47a/8eb/107/47a8eb107e5b12253386f61745103774.jpg" width="640"></a> <br><br>  Insulating washers in some places had to cut: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/4da/e6f/55f/4dae6f55f161153a1d544c8aae3c883e.jpg" width="640"></a> <br><br>  And in some places, izgalyatsya more izvratno, lift the screw on the sleeve, and pretentiously trim the sleeve: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/6ec/226/736/6ec226736d2576706170487958208959.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/f98/c43/fb9/f98c43fb9ddb0da9149193dd92ef465d.jpg" width="640"></a> <br><br>  For a single relyushki there were not enough points of support, so it hung only on two points: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/398/f46/4b6/398f464b6f08b4372bf8792edb0018b9.jpg" width="640"></a> <br><br>  Estimated assembly with terminal blocks: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/bd8/17d/1cb/bd817d1cbc854ac47c7427c26dc0f0c8.jpg" width="640"></a> <br><br>  Then the odd job became gradually overgrown with wires.  The board was used only for power distribution and for connections to terminal blocks.  For signal connections, I used the MS-16 wire (I like it more), for power it did not pass through voltage (up to 100 V), therefore MGTF: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/cc3/5ae/01d/cc35ae01d9728523e1edbe1e3d0ae79d.jpg" width="640"></a> <br><br>  On the front panel I fixed the LEDs, the current-limiting resistors were soldered directly to the legs of the LEDs and closed with heat shrink: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/4a3/299/840/4a3299840a442a416396a30c81a25e2e.jpg" width="640"></a> <br><br>  The result was such a bearded stuffing: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/5c7/042/3e7/5c70423e7c3acdbe8f892054ffe010c5.jpg" width="640"></a> <br><br>  And here is a handkerchief with a microcircuit watchdog timer, nestled in the depths of my creation, right above the RS-485 level converter - TTL: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/73d/e5b/318/73de5b318ba3e6299168d634cdbaefe2.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/798/c40/61f/798c4061fa2167591312ff1d40adf5a4.jpg" width="640"></a> <br><br>  The whole structure is collapsible, everything can be removed, disconnected and replaced without soldering, except for the scarves with watchdog, it is soldered to the connector pins, clad on a number of IO-ports of Arduina. <br><br>  In the box: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/c0b/918/cd8/c0b918cd83cbf30b11bc6b47e150b60f.jpg" width="640"></a> <br><br>  Holes for connectors Arduina cut in the plastic wall of the case.  At first, I made the holes exactly according to the size of the connectors, but the assembly into the case needs to be started diagonally (otherwise there is simply no way) and the connectors did not go through, I had to squander some: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/7a1/5bd/21c/7a15bd21c6767e24b78a867b95952606.jpg" width="640"></a> <br><br>  The inclusion of the finished product on the table, everything worked right away: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/262/a25/4f6/262a254f611519e81f429b00b2440758.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/4ff/cb6/10c/4ffcb610c648d20fe7c386f821178ad9.jpg" width="640"></a> <br><br>  On the front panel brought: <br><br><ul><li>  Four red LEDs - load indication; </li><li>  Two green - the connection with the meter and the VPN-server; </li><li>  Two yellow - spare; </li><li>  One yellow - indication of the router reboot; </li><li>  One red - food; </li><li>  And a reset button. </li></ul><br>  To get 5 volts from 220, I used a dinrayic power supply unit with output level adjustment, power was supplied directly to the microcontroller, bypassing the input converter from 7-12 to 5 volts.  It was convenient for several reasons.  First, the power of the built-in converter at some point was not enough, the current is limited there.  Secondly, it was still necessary to power the relay with 5 volts.  Thirdly, in the shield it is convenient to have a dinreech form factor in terms of installation.  Therefore, here: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/801/0f7/aad/8010f7aad941e5f4619553fe7433c58e.jpg" width="640"></a> <br><br><br>  <b>Tests</b> <b><br></b> <br>  On the table everything was preverno, everything worked as it should, it was time to install the controller in the shield and check it in combat mode. <br><br>  But first, I connected everything ‚Äúon snot‚Äù, literally shoving all the noise into another shield, low-current, in order to test the operation of thermal sensors in real conditions on long lines laid in one cable channel with ~ 220V power cables: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/d3c/3a8/b45/d3c3a8b45a90075449e23e24f4ae37e7.jpg" width="640"></a> <br><br>  As you can see in the photo above, until now I tried to control the reboot of the router by power using the Senseit smart socket.  However, this device is insanely worth 5 thousand (in 2016) turned out to be extremely buggy and capricious.  For a year of use, I have repeatedly forced me to arrive at the dacha at an inappropriate time unplanned, in order to manually take this miracle of engineering and marketing thought from deep down into GSM communications.  With the transition to my Arduino controller, which turned out to be unlike more reliably, I was relieved to throw this ‚Äúprofessional‚Äù junk in a beautiful box into a box, and forgot about it. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/efa/f91/91b/efaf9191b1dffa362e86e302d4858d34.jpg" width="640"></a> <br><br>  The test was successful, there were no failures, and it was possible to proceed with the final installation in a regular place: <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/geektimes/post_images/887/ac8/320/887ac8320dca67597c4f979806e22b93.jpg" width="472"></a> <br><br>  Yes, yes, this is a ABB TwinLine 800x300x225 IP55 shield, worth 25 thousand rubles.  without filling (and filling for another 15 thousand approximately).  And yes, it is installed in the change house 6x2.  Everyone has their own cockroaches.  Yes, I <a href="https://kirillov-sv.blogspot.ru/2016/07/blog-post.html">collected all the electrics myself</a> .  And built a shed too, yes.  No, I'm not an electrician.  And not a builder. <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/4d4/c1b/3e5/4d4c1b3e5710dfb4a87299bb1f55fbfd.jpg" width="640"></a> <br><br>  In the back of the dashboard, I positioned a small <a href="https://www.onlinetrade.ru/catalogue/istochniki_bespereboynogo_pitaniya-c153/powercom/istochnik_bespereboynogo_pitaniya_powercom_wow_300-389774.html">Powercom WOW 300</a> uninterruptible power supply, its green LED lights up there, and to the left and above it has its input power plug: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/b6a/991/299/b6a991299668084c3ae8265d064e1910.jpg" width="640"></a> <br><br>  It lasts for ~ 40 minutes of autonomous operation of the Arduino device, a router with a USB modem and Wi-Fi, and Full HD IP cameras for outdoor surveillance. <br><br>  And here you can see the white power plugs for two uninterrupted consumers - the Arduino power supply and the low-current dashboard, where the router and the power supply of the surveillance camera are located.  This line goes with a break through the contactor, which is controlled by Arduino, just for the software program that reboots the power router in case of a VPN crash (the camera restarts at the same time, although it doesn‚Äôt need it).  Twisted pair lines from temperature sensors are connected to the controller from above: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/0b8/fd7/50b/0b8fd750b2a17afd69eb55b6d56bf709.jpg" width="640"></a> <br><br>  It should be noted that I would never trust the switching of a powerful load to small blue Chinese relyushechkas, despite the parameters of these relyushek that allow me to do this.  Therefore, the use of the normal <a href="http://e-catalogue.legrand.ru/catalog/maloshumnye-s-katushkoy-230-v-dlya-grazhdanskogo-primeneniya/412501/%3Fsphrase_id%3D1668739">Legrand</a> modular contactors <a href="http://e-catalogue.legrand.ru/catalog/maloshumnye-s-katushkoy-230-v-dlya-grazhdanskogo-primeneniya/412501/%3Fsphrase_id%3D1668739">cat. No. 4 125 01</a> with manual control was immediately <a href="http://e-catalogue.legrand.ru/catalog/maloshumnye-s-katushkoy-230-v-dlya-grazhdanskogo-primeneniya/412501/%3Fsphrase_id%3D1668739">put in place</a> .  That is, the relays inside the controller case control the contactors, and the contactors already control the load.  It is reliable.  But the power of the router and the camera is carried out only through this small blue Chinese relyushku, the current there is small, so you can. <br><br>  At the first combat launch, I was in for a big disappointment.  On the table, I experienced everything except the load.  What for?  Contactors click, and so it is clear that they will commute the load.  But no, it was necessary to experience.  Powerful electric convectors introduced noise into the system at the time of contact opening, which led to guaranteed freezing of the shielder.  Moreover, it was only possible to remove it from the downstairs by removing the power, a simple reset did not help.  Googled - yes, there is such a problem with this Chinese.  And the library does not handle this situation.  That is, the shitty piece of iron, and the software is not very. <br><br>  I thought that everything was gone.  I even ordered solid-state relays, but they, bastards, are bigger in height, and would not fit in my design.  But then I thought that there might still be a hindrance.  Googling again, found special anti-interference capacitors (so-called type X capacitors).  Just connected them in parallel with the control winding of the contactors, and lo and behold!  Hanging disappeared completely.  For the past year of operation, not a single case has been registered: <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/7ae/198/80c/7ae19880c09be755c8421266a4ba29df.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/c25/e89/cb2/c25e89cb2e1f8ed607f736bfdfc0cd20.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/geektimes/post_images/6b8/a25/f65/6b8a25f65c6f9de23a3b1ad57a91f97d.jpg" width="472"></a> <br><br>  But in this way you can look inside the box: <br><br> <a href=""><img height="480" src="https://habrastorage.org/getpro/geektimes/post_images/776/7c3/7c9/7767c37c908537a36b5bd763a39fc7bc.jpg" width="640"></a> <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/geektimes/post_images/827/6fa/818/8276fa8186818314c5b4ce8516ef6f04.jpg" width="480"></a> <br><br>  Well, the finished look of the shield with the plastron (the plugs were not given here): <br><br> <a href=""><img height="640" src="https://habrastorage.org/getpro/geektimes/post_images/e4c/231/5ac/e4c2315ac67af993ed83151f58896e85.jpg" width="472"></a> <br><br>  For debugging and flashing, the USB cable is connected to the controller and is stored inside the shield behind the closed door (it will be temporarily disconnected from this photo): <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/e51/1ce/92d/e511ce92de3e8e090aa842ff540034d6.jpg" width="640"></a> <br><br> <a href=""><img height="472" src="https://habrastorage.org/getpro/geektimes/post_images/8fa/202/f5a/8fa202f5abf1eeb6bbca9192dc82c719.jpg" width="640"></a> <br><br>  The system has been operating for almost a year, it survived frosts up to 20 degrees without problems. <br><br>  In general, I am pleased with the result.  However, for more or less functional tasks, Arduino is clearly weak.  I have repeatedly faced with running out of memory and had to cut and optimize.  And the speed of work, especially with a memory card, does not suit me at all.  Therefore, the future implementation of such handicrafts, if any, I would like to base on something more powerful.  Colleagues PR me Raspberry Pi, a good option, I think. <br><br>  Some may say ‚ÄúHow many difficulties for such a primitive task,‚Äù and will probably be right.  For me, this whole undertaking is a hobby, with a little excuse for meaning.  Therefore, I was looking for entertainment wherever I could :) </div><p>Source: <a href="https://habr.com/ru/post/411141/">https://habr.com/ru/post/411141/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../411131/index.html">The first competition in underwater robotics for students of grades 1-4</a></li>
<li><a href="../411133/index.html">Toys-robots for children: for learning and entertainment</a></li>
<li><a href="../411135/index.html">Options</a></li>
<li><a href="../411137/index.html">VTC - Satellite Communications Center (Vladivostok)</a></li>
<li><a href="../411139/index.html">The riddle with the neutron lifetime becomes more complicated, but dark matter is still not visible.</a></li>
<li><a href="../411143/index.html">Programming modern microcontrollers: lecture 1</a></li>
<li><a href="../411145/index.html">My little relays: Brainfuck computer is reality</a></li>
<li><a href="../411147/index.html">Huge spots of giant planets</a></li>
<li><a href="../411149/index.html">TRIZ-forecasting of decentralized systems and cyber-physical society in 2035</a></li>
<li><a href="../411151/index.html">iMX6ULL. Transition to processor modules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>