<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Generate tile levels and hide squares from the player.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Level generation in Unexplored 2 
 We are very proud of the game level generator Unexplored 2, it is a program that meets all modern requirements. In ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Generate tile levels and hide squares from the player.</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/y7/gx/lz/y7gxlziwifqpjitd5m4rqtp-x8a.gif"></div><br><h1>  Level generation in Unexplored 2 </h1><br>  We are very proud of the game level generator Unexplored 2, it is a program that meets all modern requirements.  In the post I will talk about how the levels of the game are created. <br><br>  We did not have to reinvent the wheel.  In Unexplored 1, we have already created techniques that greatly influenced the success of the first game.  Unexplored 2 just continued the job.  The foundation of our technology consists of two parts: we apply multi-stage generation, which almost imitates a process very similar to the work of a living level designer.  On top of this, we use a technique called ‚Äú <a href="https://ctrl500.com/tech/handcrafted-feel-dungeon-generation-unexplored-explores-cyclic-dungeon-generation/">looping dungeon generation</a> ‚Äù, which is much better at generating natural looking levels than most standard generative content creation applications.  In this post I will talk about the first aspect.  Adaptation of the cyclic generation of dungeons to Unexplored 2 will be the topic of a future post. <br><br><h2>  Imitation of "human" level design </h2><br>  The level generator breaks up the process of generating a level into a whole multitude of controlled stages.  It goes from high-level planning to a low-level detailed level map.  In essence, he first creates a level sketch, and then starts adding details until the level is complete and complete. <br><a name="habracut"></a><br>  At each separate stage of this process we use generative grammars to transform the level generated in the previous stages.  In particular, we use tile grammars and graph grammars, which are varieties of more general string grammars that simply search for and replace parts of strings with other strings, much like regular expressions do.  If you are not familiar with the concepts of generative grammars and regular expressions, then I recommend you look for examples on the Internet (or just continue reading - you will not need in-depth knowledge to understand the meaning of this post). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first stage of the level is relatively simple.  We use a low resolution bitmap to locate the very basics of the level.  In the example below, the level is initially very simple: it consists only of the entrance (e) on the left, the entrance on the right, and the direct path connecting them.  Most other tiles are either undefined (u) or blocked (B) because they are at the edges of the level. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a03/aa5/2fa/a03aa52fae0cb45e82425c4c95e38214.png"></div><br>  <i>Figure 1: Simple level outline</i> <br><br>  At the next stage, the details are added: a group of rooms connected by gates appears, which are designed to pass in a certain direction: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2b9/7cd/1e4/2b97cd1e4732bab984f5181a37ba71f7.png"></div><br>  <i>Figure 2: Added structure</i> <br><br>  Tile maps are great for creating level geometry, but it is more practical to work with graphs to generate structures and logic of gameplay.  This is exactly what the generator does next: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2b3/da0/5c5/2b3da05c5967229d8d14816df5bf80ce.png"></div><br>  <i>Figure 3: Basic Graph</i> <br><br>  In the column, some nodes contain sub-nodes, in our case most of the gates are marked as dangerous (H), and some are marked as open (O). <br><br>  Based on a fairly simple analysis and generative rules, new elements are added to the graph.  For example, end point (G) is located in a place that is quite far from the inputs.  In addition, small dangers are added to the graph to make the level more threatening. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/784/3a5/6e0/7843a56e0fb89b3a1350076657c212c5.png"></div><br>  Figure 4: New items added to the graph. <br><br>  In the meantime, a low-resolution tile map is converted using several noise functions to a high-resolution tile map to make it more natural: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/465/e65/18e/465e6518e606b4eb70e4d04b2b3ca8c1.png"></div><br>  Figure 5: High Resolution Tile Map <br><br>  Then the information from the graph is used to decorate the tile map and add new elements: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/722/9b7/140/7229b7140304bb1f8302586b2dfb6c16.png"></div><br>  <i>Figure 6: Decorated tile card.</i> <br><br>  The map as it is is generated solely for the gameplay view.  White tiles designate open spaces, and almost all other tiles designate very specific gameplay elements, for example, a secret passage through bushes (green circles), ‚Äúthickets in thickets‚Äù (green squares and lilac stripes) or spawn sites for snapping trees (red circles with the letter s).  The main part of the level is still undefined, and at this stage the generator assumes that these areas must be filled so as to block the player‚Äôs movement. <br><br>  It performs this task on several layers: the bottom layer indicates the level of height and type of surface, the second adds water in certain locations, and the third layer adds vegetation and other decorations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e37/6b6/f11/e376b6f11b4e4e526986238c4d0c50cc.png"></div><br>  <i>Figure 7: Types of ground surface (grass, dirt, and stones)</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d7/898/9ac/2d78989ac691225d306a3319c2f7e111.png"></div><br>  <i>Figure 8: Water</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/021/ade/799/021ade7992212c857d6e4101e31273e0.png"></div><br>  <i>Figure 9: Vegetation and other decorations</i> <br><br>  These layers are then added to the final level data file, to which some more details are added.  This data is used by the game for placing assets and building a level the way you see it.  At this stage there are many tricks.  For example, you may have noticed that the tiles of the land in the figure above have strange shapes.  These forms are used to create land ‚Äútiles‚Äù in such a way that the player does not notice that the source data was a tile map.  I will tell about it in the second part of the article. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc9/b89/75c/bc9b8975c9b0704266c5786af53834eb.png"></div><br>  <i>Figure 10: Ready Level</i> <br><br><h2>  Adding Gameplay </h2><br>  There are many advantages to this level generation method.  The stage of converting a level into a graph is especially important in order to simplify the ‚Äúreasoning‚Äù of the gameplay to the generator.  In the example shown above, we did not do anything with it, except to check that the level targets are created at some distance from the entrances.  But for other levels, more tasks are performed at these stages. <br><br>  Take for example the cave map in a more classical dungeon style (compared to the forest level from the example above).  The base graph of this level has only one entrance and a couple of new types of gates.  A pair of them is closed (L): one gate catches the player on one side into the trap (T), and I call the dark green one ‚Äúvalve‚Äù: this type of gate allows the player to pass only in one direction. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45d/72c/52a/45d72c52a99a84d42541b602c84b7806.png"></div><br>  <i>Figure 11: Base Cave Count</i> <br><br>  The structure of this level allows the generator to create a much more complex mission.  For example, the only way to get to this level is through the ‚Äúvalve‚Äù, forcing the player to look for another way out.  The key to open the way out (lower left) is located behind the danger at the upper left, and the target is located behind the gate that traps the player.  An example of such a goal might be a pass that collapses after the player.  In general, it creates a cave that is interesting to explore on its own, but Unexplored 2 also has the ability to add creatures and events that are mixed in during the run. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45d/72c/52a/45d72c52a99a84d42541b602c84b7806.png"></div><br>  <i>Figure 12: Locks and keys added to the cave</i> <br><br>  Using the process described above, the graph is used to generate and populate a fully detailed tile map.  The use of various parameters reflecting the cave nature of this level results in highly varying results with destroyed underground structures (blue squares marked with the letter c) and wide thorns with abyss (purple circles): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fca/65c/c79/fca65cc79406fa4ba471d763f8ab6539.png"></div><br>  <i>Figure 13: Cave level in full detail</i> <br><br><h2>  Summarize </h2><br>  I hope you got a general idea of ‚Äã‚Äãhow we approach the generation of levels in Unexplored 2. This is a complex multi-step process, which I plan to write more about in the near future.  At least, I have already promised you to write about the use of cyclic dungeon generation.  But you can tell a lot more, from the generative storytelling techniques, line rendering and shading methods to the lengthy design process that we used to create a good luck system, as well as other aspects. <br><br><h1>  Part 2. From tiles to curves, or fun with Voronoi graphs </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a15/895/3a8/a158953a829bff67da8a242686b2675b.png"></div><br>  The content generator Unexplored 2 generates tile maps.  A typical result looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e2/f20/fff/0e2f20fff2077a7259c639e8aa5bdda8.png"></div><br>  These tile maps are layered on top of each other and use different tiles to designate types of ground (in this example grass or mud), as well as various decorations.  In this case, there are several bushes (large green circles), stones (black circles), plants (small green circles), flowers (white circles) and decorative textures (gray squares).  There are also special tiles that indicate gameplay data, for example, spawn points marked with the letter ‚Äús‚Äù.  In addition, tiles can be marked with additional information, such as height level or special subtypes. <br><br>  Tile maps are a convenient data structure for generators.  But at the same time, it is quite straightforward, and the grid is often noticeable in the game.  However, after loading data into the game and the location of assets, the result looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/760/51a/40f/76051a40f79ffbbb15a3054536893003.png"></div><br>  I think that we hid the tiles pretty well, and that's how we achieved it. <br><br><h2>  Voronoi magic </h2><br>  The trick is that the individual tiles correspond to the cells in the Voronoi diagram.  This chart can be used to generate much more natural-looking shapes.  A Voronoi diagram is created by sowing a plane with random points and dividing it into cells in such a way that each point on the plane belongs to the cell corresponding to the nearest starting point.  In the procedural generation of content, the Voronoi diagrams can be used in several interesting ways. <br><br>  A typical Voronoi diagram is created from a random, but fairly uniform distribution of the generating points, which looks something like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fd/15a/338/5fd15a3382b48d74706d5f5458c4f7cb.png"></div><br>  In Unexplored 2, we use a different kind of distribution of generating points.  First, we generate at one point for each tile.  So we can be sure that each tile on the tile map will correspond to one cell in the Voronoi diagram. <br><br>  If we place generating points in the middle of each cell, we end up with a straight grid that looks exactly like a tile map (for this and other images below, I made a chess version, in which half of the tiles are rendered yellow, so that you can see patterns): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0dd/a26/a2f/0dda26a2fa9d01ea045c1219d0a3c999.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8eb/451/15b/8eb45115b429cbb8b612f46ce3fad524.png"></div><br>  The easiest way to improve the diagram is to simply randomize the position of each generating point.  When moving points, it is worth checking that the point does not go beyond the limits of the original tile. <br><br>  The result looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4a3/33a/043/4a333a043cf9caadc0a09ff606c046ca.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ab6/c25/031/ab6c250312ab2f4e4efec42788c129d5.png"></div><br>  Already better, but very noisy, and thus not get beautiful winding lines.  The picture can be improved by doing ‚Äúrelaxation‚Äù of the Voronoi diagrams (this is a standard technique for them, which I will not discuss here).  But it will always remain a bit noisy anyway, and it is difficult to effectively predict figures on a scale that exceeds the scale of individual tiles. <br><br>  To solve this problem, we need not just to move it at random, but to approach it more intelligently.  Different types of movement can have a very different effect.  For example, when using Perlin noise, interesting twisting tile cards are obtained.  Or you can turn the entire grid into hexagonal tiles by simply moving every other row of generating points to the left: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b1/ccb/69e/6b1ccb69e7e6ca475e6c62c56f52b56c.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b06/787/b2f/b06787b2f08c28d84f009caffd76ff14.png"></div><br>  We made a real breakthrough when we started moving the generating points in certain patterns to create rounded corners.  The first stage of this process is already performed inside the level generator.  Angles between different types of ground are recognized, and corner tiles are marked with different shapes denoting the way they are deformed to generate a more beautiful environment: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/21a/822/1fb/21a8221fb1d87fec480db9cc2c95425e.png"></div><br>  In this case, the difference in height levels also causes the corners to appear on the tile map.  That is why you see additional rounded corners in the grass at the top right and bottom left where the slopes were generated. <br><br>  The game uses this information to offset the generating points of the Voronoi graph.  Each corner angle shifts the location of the originating point (see image below).  In addition, it also shifts the generating points of its four orthogonal neighbors.  This process is cumulative;  generating points can move several times if they are near several angles.  However, after processing all offsets, the generating points are slightly randomized (approximately 10% of the tile width in each direction), and the final offset is limited to a maximum of 40% of the tile width. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a94/9b9/3f5/a949b93f5e2e724a95658f75af6a50c4.png"></div><br>  The result is already pretty good quality: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccc/830/f24/ccc830f24c201bd4e519ca0407f77c18.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b8b/d27/edb/b8bd27edb8a753ee92e9d2d5551e6a05.png"></div><br>  But we have not finished ... <br><br><h2>  Decorate with the mind </h2><br>  The overall shape is better, but the edges are still very straight and look jagged.  We will hide this by placing curved assets on the edges where the colors are different.  However, the real trick is that one curve is often placed on two edges, and to determine the direction of the curve, use their angles relative to each other. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d27/4ef/fc6/d274effc6224874373a8c8c355dcb209.png"></div><br>  The result looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e97/591/baa/e97591baad40e954f3c4b164f2b91739.png"></div><br>  Next, we used 3D assets to add texture breaks: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/711/70a/6b0/71170a6b0ea154c6974e8787be8c0680.png"></div><br>  Finally, we add one more asset to fill the level.  The location of these assets is determined by the previously generated level data, and generally follows simple principles.  We use small assets surrounding larger ones to create natural and beautiful transitions.  In particular, it is worth noting that stones are added at the foot of the cliffs, creating variability and visually softening the vertical slopes that are necessary for the gameplay: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/760/51a/40f/76051a40f79ffbbb15a3054536893003.png"></div><br><h2>  Local variability </h2><br>  Angles are not the only offset type we use.  In particular, we want the edges to be straighter next to artificial structures (for example, destroyed walls shown below): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/839/9f5/127/8399f5127ae11017b243716b075c3324.png"></div><br>  In our system, this effect is easy to achieve.  We simply add another displacement rule prohibiting displacing tiles with man-made structures.  The generator uses small squares to mark such tiles, and the game makes sure that all offsets are simply ignored: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b84/5b1/372/b845b1372a6623d931eb30ed29fe5bcc.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09e/2c4/f64/09e2c4f64fad5ee474fcbfa21e607c73.png"></div><br>  If you look at the ground, you can clearly see that the individual areas are made straight, while others bend more naturally: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c60/5e3/635/c605e363554553121d8c70c61ebaa5b2.png"></div><br>  Isn't it beautiful? <br><br>  There are other rules that can be easily added using this technique.  For example, sometimes we force tiles to create a hexagonal pattern so that narrow paths remain wide enough to move along them.  I am sure that we will find other uses for other patterns. <br><br>  This is one of many reasons why I like Voronoi diagrams.  Another time I will write about how we use them to generate and decorate Unexplored world maps 2. </div><p>Source: <a href="https://habr.com/ru/post/457766/">https://habr.com/ru/post/457766/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457752/index.html">Not moon rovers and no jokers. What do we know about robots in Fukushima</a></li>
<li><a href="../457756/index.html">The book "Kafka Streams in action. Real-time applications and microservices</a></li>
<li><a href="../45776/index.html">What do independent experts think about the USE?</a></li>
<li><a href="../457760/index.html">How to make containers even more isolated: an overview of container sandbox technologies</a></li>
<li><a href="../457764/index.html">10 mistakes of the young PO (part II)</a></li>
<li><a href="../457768/index.html">How I became vulnerable: we scan IT infrastructure with Qualys</a></li>
<li><a href="../457770/index.html">Writing custom transformer AST on TypeScript</a></li>
<li><a href="../457774/index.html">Studying a private pilot in Middle-earth: moving and living in a New Zealand village</a></li>
<li><a href="../45778/index.html">The new version of Ruby is faster up to 5 times</a></li>
<li><a href="../457784/index.html">Custom'a Eye-tracker calibration</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>