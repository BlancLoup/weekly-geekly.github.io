<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another breakpad server. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last quarter, they did MVP of the kresh service. An analogue of Socorro from Mozilla, but taking into account their requirements. The service c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another breakpad server. Part 1</h1><div class="post__text post__text-html js-mediator-article"><p>  In the last quarter, they did MVP of the kresh service.  An analogue of <a href="https://github.com/mozilla-services/socorro">Socorro</a> from Mozilla, but taking into account their requirements.  The service code will be uploaded to <a href="https://github.com/iqoption/yabs">GitHub</a> as refactoring occurs.  The utilities discussed in this article are available <a href="https://github.com/iqoption/yabs/tree/master/tools">here</a> . </p><br><p>  We had the following requirements: </p><br><ul><li>  getting report from Windows, Mac OS X, GNU / Linux; </li><li>  receiving a crash report from the web (collected via emscripten); </li><li>  collection of equipment data (CPU, GPU, Memory); </li><li>  grouping crashes by version, platform, <strong>user</strong> , reason; </li><li>  the application keeps logs, you need to store and log along with the report. </li></ul><br><p>  Content: </p><br><ul><li>  Breakpad: symbol files and crash reports; </li><li>  Emscripten: compilation options, symbol files, error handling; </li><li>  Ui. </li></ul><a name="habracut"></a><br><h2 id="breakpad">  Breakpad </h2><br><p> Breakpad has a utility that extracts character files from elf / pdb.  <a href="">Here is</a> the file format description.  This is a text file, but we are interested in the first line has the format <code>MODULE operatingsystem architecture id name</code> , here it looks like this: </p><br><pre> <code class="hljs pgsql">MODULE windows x86 <span class="hljs-number"><span class="hljs-number">9E8</span></span>FC13F1B3F448B89FF7C940AC054A21 IQ <span class="hljs-keyword"><span class="hljs-keyword">Option</span></span>.pdb MODULE Linux x86_64 <span class="hljs-number"><span class="hljs-number">4</span></span>FC3EB040E16C7C75481BC5AA03EC8F50 IQOption MODULE mac x86_64 B25BF49C9270383E8DE34560730689030 IQOption</code> </pre> <br><p>  Further, these files should be placed in a special order: <code>base_dir/name/id/name.sym</code> , it looks like this: </p><br><pre> <code class="hljs pgsql">base_dir/IQ <span class="hljs-keyword"><span class="hljs-keyword">Option</span></span>/<span class="hljs-number"><span class="hljs-number">9E8</span></span>FC13F1B3F448B89FF7C940AC054A21/IQ <span class="hljs-keyword"><span class="hljs-keyword">Option</span></span>.sym base_dir/IQOption/<span class="hljs-number"><span class="hljs-number">4</span></span>FC3EB040E16C7C75481BC5AA03EC8F50/IQOption.sym base_dir/IQOption/B25BF49C9270383E8DE34560730689030/IQOption.sym</code> </pre> <br><p>  To get a crash report, you can use the minidump_stackwalk utility from the breakpad distribution: </p><br><pre> <code class="hljs ruby">$ minidump_stackwalk path_to_crash base_dir</code> </pre> <br><p>  This utility can output both in human readable form and in machine-readable format. </p><br><p>  But this is not very convenient.  The Mozilla Socorro includes a <strong>stackwalker</strong> utility that issues json (example on <a href="https://crash-stats.mozilla.com/report/index/3781acf6-2cfc-44f5-ade0-90cc40170716">crash-stats.mozilla.com</a> ) </p><br><h2 id="emscripten">  Emscripten </h2><br><p>  Catching falls is possible through the global <a href="https://developer.mozilla.org/ru/docs/Web/API/GlobalEventHandlers/onerror">window.onerror</a> handler.  Depending on the browser, the messages will differ: </p><br><pre> <code class="hljs dos">Uncaught abort() <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Error <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> jsStackTrace (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Object.abort (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> _abort (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> _free (...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> __ZN2F28ViewMain13setFullscreenEb (...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Array.__ZNSt3__210__function6__funcIZN2F28ViewMainC1EvE4__13NS_9allocatorIS4_EEFbPNS2_9UIElementEEEclEOS8_ (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> __ZNKSt3__28functionIFllEEclEl (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> __ZNK2F26detail23multicast_function_baseIFbPNS_9UIElementEENS_24multicast_result_reducerIFbRKNSt3__26vectorIbNS6_9allocatorIbEEEEEXadL_ZNS_10atLeastOneESC_EEEEiLin1EEclERKS3_ (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> __ZN2F29UIElement14processTouchUpERKNS_6vec2_tIfEE (http://...) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> this abort() is unexpected, build with -s ASSERTIONS=<span class="hljs-number"><span class="hljs-number">1</span></span> which can give <span class="hljs-built_in"><span class="hljs-built_in">more</span></span> information.</code> </pre> <br><pre> <code class="hljs ruby">uncaught <span class="hljs-symbol"><span class="hljs-symbol">exception:</span></span> abort() at jsStackTrace@http<span class="hljs-symbol"><span class="hljs-symbol">://localhost/traderoom/glengine</span></span>.js?v=<span class="hljs-number"><span class="hljs-number">1485951440.84</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">1258</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">13</span></span> stackTrace@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... abort@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... _abort@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... _free@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZN2F28ViewMain13setFullscreenEb@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZNSt3__210__function6__funcIZN2F28ViewMainC1EvE4__13NS_9allocatorIS4_EEFbPNS2_9UIElementEEEclEOS8<span class="hljs-number"><span class="hljs-number">_</span></span>@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZNKSt3__28functionIFllEEclEl@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZNK2F26detail23multicast_function_baseIFbPNS_9UIElementEENS_24multicast_result_reducerIFbRKNSt3__26vectorIbNS6_9allocatorIbEEEEEXadL_ZNS_10atLeastOneESC_EEEEiLin1EEclERKS3<span class="hljs-number"><span class="hljs-number">_</span></span>@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZN2F29UIElement14processTouchUpERKNS_6vec2_tIfEE@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZN2F29UIElement17processTouchEventERNSt3__26vectorINS1_4pairIPS0_NS_6vec2_tIfEEEENS1_9allocatorIS7_EEEEjNS_15UI_TOUCH_ACTIONE@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZN2F29UIElement5touchEffNS_15UI_TOUCH_ACTIONEj@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... __ZN2F213MVApplication5touchEffNS_15UI_TOUCH_ACTIONEj@http<span class="hljs-symbol"><span class="hljs-symbol">://</span></span>... at stackTrace (<span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/... glengine.js?v=1485951440.84:360629:11 __ZN2F27UIInput7processEj@http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... __Z14on_mouse_eventiPK20EmscriptenMouseEventPv@http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... dynCall_iiii@http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... dynCall@http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... handlerFunc@http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... jsEventHandler@http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/... If this abort() is unexpected, build with -s ASSERTIONS=1 which can give more information.</span></span></code> </pre> <br><p>  Such a message is created if you use the <strong>-g</strong> switch when compiling.  On our project, the size of the output code <strong>asm.js</strong> is 3 times larger.  Therefore, we use - <strong>emit-symbol-map</strong> . <br>  At the output, we get a file with characters in a simple key: value format: </p><br><pre> <code class="hljs markdown">$cc:<span class="hljs-strong"><span class="hljs-strong">__ZNSt3__</span></span>210<span class="hljs-strong"><span class="hljs-strong">__function6__</span></span>funcIZN2F28ViewMain17animateLeftPannelEbE4<span class="hljs-strong"><span class="hljs-strong">__36NS_9allocatorIS4_EEFvvEEclEv f8d:__</span></span>ZNKSt3<span class="hljs-strong"><span class="hljs-strong">__210__</span></span>function6<span class="hljs-strong"><span class="hljs-strong">__funcIZN2F218MVMessageQueueImpl4sendINS2_26EventSocialProfileReceivedEJiEEEvDpRKT0_EUlvE_NS_9allocatorISA_EEFvvEE7__</span></span>cloneEPNS0<span class="hljs-emphasis"><span class="hljs-emphasis">_6_</span></span><span class="hljs-emphasis"><span class="hljs-emphasis">_baseISD_</span></span>EE Z1:<span class="hljs-emphasis"><span class="hljs-emphasis">__ZN2F211recognizers24UIPinchGestureRecognizer6updateEPNS_</span></span>9UIElementERKNS<span class="hljs-emphasis"><span class="hljs-emphasis">_6vec2_</span></span>tIfEEj</code> </pre> <br><p>  and the messages now look like: </p><br><pre> <code class="hljs dos">Uncaught abort() <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Error <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> jsStackTrace (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> stackTrace (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Object.abort (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> _abort (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Eb (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Xc (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> rc (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Array.$c (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Pc (http://...) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> Array.Wb (http://...) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> this abort() is unexpected, build with -s ASSERTIONS=<span class="hljs-number"><span class="hljs-number">1</span></span> which can give <span class="hljs-built_in"><span class="hljs-built_in">more</span></span> information.</code> </pre> <br><p>  To get a call stack, an auxiliary utility was written: </p><br><div class="spoiler">  <b class="spoiler_title">webstackwalker</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;map&gt; #include &lt;set&gt; #include &lt;list&gt; #include &lt;regex&gt; #include &lt;fstream&gt; #include &lt;iostream&gt; #include &lt;cxxabi.h&gt; #include &lt;rapidjson/writer.h&gt; #include &lt;rapidjson/stringbuffer.h&gt; namespace { struct Deleter { void operator()(char *data) const { free((void *) data); } }; using CharPtr = std::unique_ptr&lt;char, Deleter&gt;; } std::string demangle(const std::string &amp;mangledName) { int status = 0; int shift = 0; if (mangledName[1] == '_') { shift = 1; } CharPtr realname(abi::__cxa_demangle(mangledName.data() + shift, 0, 0, &amp;status)); if (status == 0) { return std::string(realname.get()); } else { if (mangledName[0] == '_') { const auto str = mangledName.substr(1, mangledName.size() - 1); int status = 0; CharPtr realname(abi::__cxa_demangle(str.data(), 0, 0, &amp;status)); if (status == 0) { return std::string(realname.get()); } return mangledName; } return mangledName; } } void printUsage() { std::cout &lt;&lt; "webstackwalker crash_dump symbol_file" &lt;&lt; std::endl; } std::map&lt;std::string, std::string&gt; SYMBOL_MAP; void readSymbols(const std::string &amp;path); void flushUnParseLine(const std::string &amp;line); int main(int argc, char **argv) { if (argc &lt; 2) { printUsage(); return 1; } readSymbols(std::string(argv[2])); const std::string inputFile(argv[1]); std::ifstream input(inputFile); const std::regex re("^(?:\\s{4}at\\s){0,1}(?:Array\\.){0,1}([\\w\\d\\$]+)(?: \\(|@).+\\){0,1}"); rapidjson::StringBuffer buffer; rapidjson::Writer&lt;rapidjson::StringBuffer&gt; writer(buffer); writer.StartArray(); const std::set&lt;std::string&gt; skip = {"jsStackTrace", "stackTrace", "abort"}; while (!input.eof()) { std::smatch match; std::string line; std::getline(input, line); if (std::regex_search(line, match, re)) { if (skip.count(match[1])) { continue; } auto iter = SYMBOL_MAP.find(match[1]); std::string function; if (iter != SYMBOL_MAP.cend()) { function = demangle(iter-&gt;second); } else { function = demangle(match[1]); } writer.String(function.c_str()); } } writer.EndArray(); std::cout &lt;&lt; buffer.GetString() &lt;&lt; std::endl; return 0; } void readSymbols(const std::string &amp;path) { std::ifstream input(path); if (!input.is_open()) { std::cerr &lt;&lt; "Can't open symbols file: " &lt;&lt; path &lt;&lt; std::endl; exit(2); } const std::regex re("^([\\d\\w$]+):([\\d\\w]+)$"); while (!input.eof()) { std::smatch match; std::string line; std::getline(input, line); if (std::regex_search(line, match, re)) { SYMBOL_MAP[match[1]] = match[2]; } } }</span></span></span></span></code> </pre> </div></div><br><p>  The utility uses demangle to convert: </p><br><pre> <code class="cpp hljs">_ZN2F211recognizers24UIPinchGestureRecognizer6updateEPNS_9UIElementERKNS_6vec2_tIfEEj</code> </pre> <br><p>  at </p><br><pre> <code class="cpp hljs">F2::recognizers::UIPinchGestureRecognizer::update(F2::UIElement*, F2::<span class="hljs-keyword"><span class="hljs-keyword">vec2_t</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)</code> </pre> <br><h2 id="ui">  Ui </h2><br><p>  We add drop reports in Elasticsearch, so for the first time we use <a href="https://www.elastic.co/products/kibana">Kibana</a> as a means of visualizing and analyzing the contents of the elastic. </p><br><p>  When using kibana we get out of the box: </p><br><ul><li>  dashboards with automatic updates; </li><li>  visualization: <br><ul><li>  grigs and charts; </li><li>  tables. </li></ul></li></ul><br><p>  Dashboards group crashes by platform, build, signature.  The filter system allows you to find out: </p><br><ul><li>  in which builds this bug occurs; </li><li>  on which platforms is played. </li></ul><br><p>  Applied filters can be transferred to the discover tab, where you can see the details of the fall.  As it turned out the kibana has a modular structure that allows you to expand its capabilities.  A simple plugin was written to add a report render, which is much more convenient than the standard Table and JSon. </p><br><p><img src="https://habrastorage.org/web/272/b25/8f3/272b258f3ba14aa683b89726a1b59c0e.jpg"></p><br><p><img src="https://habrastorage.org/web/4f8/fa1/0d0/4f8fa10d058d43c19d73a08bcbb6e330.jpg"></p><br><p><img src="https://habrastorage.org/web/7d0/b06/999/7d0b0699995946ccaaebdfa6ae807fb4.jpg"></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/333448/">https://habr.com/ru/post/333448/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333436/index.html">The digest of interesting materials for the mobile developer # 212 (July 10 - July 16)</a></li>
<li><a href="../333440/index.html">The recommendation of the first track for streaming. Lecture in Yandex</a></li>
<li><a href="../333442/index.html">How we searched and found a bug in Visual Studio C ++</a></li>
<li><a href="../333444/index.html">Pygest # 13. Releases, articles, interesting projects from the world of Python [July 4, 2017 - July 17, 2017]</a></li>
<li><a href="../333446/index.html">‚ÄúYour next step to the blockchain‚Äù: release of the Exonum platform from Bitfury Group</a></li>
<li><a href="../333454/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ271 (July 10 - 16, 2017)</a></li>
<li><a href="../333456/index.html">The last mile or how to pass the finished site to the client</a></li>
<li><a href="../333458/index.html">PHP Digest number 112 - the latest news, materials and tools (June 26 - July 16, 2017)</a></li>
<li><a href="../333460/index.html">Quality, what a beast and how to detect it</a></li>
<li><a href="../333462/index.html">About the value of goodwill in the team</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>