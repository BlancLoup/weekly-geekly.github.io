<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick selection of random values ‚Äã‚Äãfrom large MySQL tables by condition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The task of choosing random lines from a table quite often arises before developers. 
 If MySQL is used, it is usually solved in the following way: 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick selection of random values ‚Äã‚Äãfrom large MySQL tables by condition</h1><div class="post__text post__text-html js-mediator-article"> The task of choosing random lines from a table quite often arises before developers. <br>  If MySQL is used, it is usually solved in the following way: <br><br> <code>SELECT * <br> FROM users <br> WHERE role_id=5 <br> ORDER BY rand() <br> LIMIT 10</code> <br> <br>  Such code works extremely slowly for large tables. <br>  If the query does not need to use WHERE or the table is small, there are effective solutions, for example <a href="http://habrahabr.ru/post/54176/">habrahabr.ru/post/54176</a> or <a href="http://habrahabr.ru/post/55864/">habrahabr.ru/post/55864</a> . <br>  But I did not find any ready-made solutions for a large table and the need to filter by condition, getting new values ‚Äã‚Äãfor each request, so my method description is under the cut. <br><a name="habracut"></a><br><br>  As it turned out, MySQL does not know how to efficiently select random rows using ORDER BY rand () LIMIT N, where you need to filter rows by condition (although the same MSSQL copes with the selection of random rows from a table with a large number of records). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, solving the problem "in the forehead," the query (in the table of 5 million records): <br><br> <code>SELECT * <br> FROM users <br> WHERE role_id=5 <br> ORDER BY rand() <br> LIMIT 10 <br></code> <br><br>  The request took 41.3544 seconds, which is unacceptable for a long time.  It is impossible to find the maximum and minimum id, and then select random id from the gap in this case: because of the WHERE condition, id is no longer in order and discharged. <br><br>  My solution is as follows: the random_seed table is added, containing the id and random_seed fields, filled with random numbers, an index is added to this column, and the index is also added to the column that will be sampled. <br>  Now, in order to select random lines by condition, the query needs to be changed as follows (in table 5 million records): <br><br> <code>SELECT <br> u1.* <br> FROM <br> users u1, <br> random_seed rs <br> WHERE <br> u1.role_id=5 AND u1.id=(rs.id+random_from_php) <br> ORDER BY <br> rs.random_seed <br> LIMIT 10</code> <br> <br>  The request took 0.0460 seconds, which is already more than an acceptable result.  The variable random_from_php is generated by the code calling the request, which provides a random set of values ‚Äã‚Äãfor each request, this number will provide a sample of new random numbers.  In the table, random_seed should be as many values ‚Äã‚Äãas in the table, from which you need to take random rows + N records, where N is the maximum possible value of random_from_php. <br><br>  A real example from my work is the selection of random categories of products from different combinations (total 4,000,000 entries): <br><br><table><tbody><tr><td>  ‚ÄúNormal‚Äù: request </td><td>  "Accelerated" request: </td></tr><tr><td>  SELECT <br>  oc1. * <br>  FROM <br>  object_category oc1 <br>  WHERE oc1.region_id = 6 <br>  ORDER BY RAND () <br>  LIMIT 10 <br></td><td>  SELECT <br>  oc1. * <br>  FROM <br>  object_category oc1, random_seed rs <br>  WHERE <br>  oc1.id = (rs.id + 564756) AND oc1.region_id = 6 <br>  ORDER BY <br>  rs.random_seed <br>  LIMIT 10 <br></td></tr><tr><td>  Lead time: </td><td></td></tr><tr><td>  1.726 </td><td>  0.007s </td></tr><tr><td>  1.851s </td><td>  0.010s </td></tr><tr><td>  1.803s </td><td>  0.006s </td></tr><tr><td>  1.784 </td><td>  0.008s </td></tr></tbody></table><br><br>  The advantages of the method described above: <br>  + The fastest possible way to select random rows from a table by condition <br>  + No need to re-generate random numbers for each of the rows in the table. <br>  + The request of all necessary values ‚Äã‚Äãdoes not occur iteratively, in one request <br><br>  Minuses: <br>  - The need to enter an additional table <br>  - The need to change the usual requests </div><p>Source: <a href="https://habr.com/ru/post/207096/">https://habr.com/ru/post/207096/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207082/index.html">Spanner NewSQL storage from Google</a></li>
<li><a href="../207084/index.html">Socialization TV</a></li>
<li><a href="../207086/index.html">How-to: Transparent NTLM authorization on the corporate portal</a></li>
<li><a href="../207088/index.html">Windows runtime. CLR type system and interaction</a></li>
<li><a href="../207094/index.html">The 3D printer should stand next to the ‚ÄúWhite Swan‚Äù, or about the national characteristics of trademarks.</a></li>
<li><a href="../207098/index.html">A passion for programming. Chapter 15. Practice, practice, practice</a></li>
<li><a href="../207100/index.html">We put Ubuntu on MacBook pro 11.3 (2013) or vice versa</a></li>
<li><a href="../207102/index.html">Object naming in Oracle. View from the outside"</a></li>
<li><a href="../207106/index.html">When to register a startup?</a></li>
<li><a href="../207108/index.html">Fukami, part 1.1: We bring the scene to the theme of the project</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>