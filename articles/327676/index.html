<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We raise our VPN server on Amazon EC2 under Windows Server 2008 r2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are many manuals on the network how to raise your VPN server on the Amazon AWS cloud, but under unix-like systems, but how to raise it on Window...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We raise our VPN server on Amazon EC2 under Windows Server 2008 r2</h1><div class="post__text post__text-html js-mediator-article">  There are many manuals on the network how to raise your VPN server on the Amazon AWS cloud, but under unix-like systems, but how to raise it on Windows is not considered at all. <br><br>  Since I did not find any manuals, I wanted to sort it out myself and make a bundle of Amazon EC2 based on Windows Server + OpenVPN + Android OpenVPN Client. <br><br>  Go! <br><a name="habracut"></a><br>  The article is not designed for beginners, so some general questions have been omitted. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I‚Äôm not going to describe the registration process on Amazon AWS ‚Äî it's simple.  I have not registered before, so I was surprised that the confirmation comes to the phone number.  Write a work number.  After registration, go to the <b>Dashboard</b> <a href="https://console.aws.amazon.com/console/home">https://console.aws.amazon.com/console/home</a> <br><br>  We stamp in the menu <b>Services</b> ‚Üí <b>Compute</b> ‚Üí <b>EC2</b> ‚Üí <b>Instances</b> .  Click <b>Launch Instance</b> to open the <b>Wizard</b> .  In the list of available AMI choose <b>Microsoft Windows Server 2008 R2 Base - ami-59fc7439</b> <br><br>  In the second step, we select the available version <b>t2.micro (Free tier)</b> - we have enough of its capabilities with interest.  Do not rush to click <i>Launch</i> - click <b>Next: Configure Instance Details</b> (I assume that you have VPC configured by default, have default subnets and KeyPairs are created. If the keys are not created, then go first to <b>Dashboard</b> ‚Üí <b>Key Pairs</b> ‚Üí <b>Create</b> . By the way, I rebuilt VPC from scratch, leaving only one network in it (10.100.11.0/24). <br><br>  We leave the default settings, but set <b>Auto-assign Public IP to</b> <b>Enable</b> .  Then click on <i>Preview and Launch.</i>  We are waiting for a few minutes until the instance is created. <br><br>  In the left <b>Dashboard</b> select the section <b>Network &amp; Security</b> ‚Üí <b>Security Groups</b> .  Choose a group that is associated with our instance.  From the bottom, on the tabs <i>Inbound, Outbound</i> , we temporarily add permissions to allow all traffic to pass (alltraff). <br><br>  Currently, only RDP is allowed there.  Those in a hurry can enable port 1194 for OpenVPN and ICMP on both tabs.  Now that the instance is up and running, we need to connect to it.  Choose our instance, click <b>Connect</b> . <br><br>  A window appears asking you to download the RDP file and get the password.  Download  Click <b>Get Password</b> , specify our key file, decrypt, get the password.  The first half of the case is complete.  Open the RDP, connect to the host. <br><br>  Before us is a clean OS.  What do we need next? <br><br>  1. Download Google Chrome to make it easier to check. <br>  2. Download OpenVPN. <br>  3. Raise the server with the default configuration. <br>  4. Raise NAT. <br><br>  There should be no problems with the first two points, unless you have to download via IE.  OpenVPN we swing from an official site (MSI), we put with default settings, we change nothing. <br><br>  Through Chrome, go to <a href="http://ipleak.net/">ipleak.net</a> and check your IP.  It will be somewhere in the US / Oregon region.  How to make server and client certificates for OpenVPN I will not paint, there are enough materials on this topic.  Be sure to create a PAM file (Diffie-Hellman), without it the server will not start. <br><br>  Ok, everything downloaded, installed.  On our server, open the <b>Server Manager</b> , go to the <b>Services</b> section.  We find the <b>OpenVPN Legacy Service</b> , open its properties - specify Startup type: <b>Automatic</b> and start the service.  This is necessary so that after restarting our instance, the OpenVPN server starts up on its own. <br><br>  Now open <i>C: \ Program Files \ OpenVPN \ config</i> - there we drop the CA.key, server.key, ta.key and dh2048.pem keys and CA and server certificates.  Open <i>C: \ Program Files \ OpenVPN \ sample-config</i> and from there copy the file server.ovpn to <i>C: \ Program Files \ OpenVPN \ config</i> . <br><br>  Overwrite content like this: <br><blockquote>  port <b>1194</b> <br>  proto <b>udp</b> <br>  dev <b>tun</b> <br><br>  ca ca.crt <br>  cert server.crt <br>  key server.key <br>  <b>dh dh2048.pem</b> <br>  # virtual network of our VPN <br>  <b>server 172.10.10.0 255.255.255.0</b> <br><br>  ifconfig-pool-persist ipp.txt <br>  keepalive 10 120 <br><br>  tls-auth ta.key 0 # This file is secret <br>  cipher AES-256-CBC <br><br>  <b>max-clients 100</b> <br><br>  persist-key <br>  persist tun <br><br>  <b>dev-node "HomeVPN"</b> <br><br>  #HomeVPN is the TAP created when installing OpenVPN.  I renamed it for convenience <br><br>  # it is necessary that all clients can be routed without straining <br>  push "route 0.0.0.0 0.0.0.0" <br><br>  # specify our DNS, but it is not necessary <br>  push "dhcp-option DNS 8.8.8.8" <br>  push "dhcp-option DNS 8.8.4.4" <br><br>  verb 3 <br>  explicit-exit-notify 1 </blockquote><br>  We save. <br><br>  Server setup is complete.  Select <b>server.ovpn</b> , open the context menu, select <i>Start OpenVPN on this config file</i> . <br><br>  After that, the terminal opens and the download process goes.  If everything is done correctly, you will see <b>Initialization Sequence Complete</b> at the end. <br><br>  Now, in order to avoid problems with client connections, you need to do one thing (to choose from), either write the rules for passing OpenVPN traffic in Windows Firewall and enable port 1194, or simply turn off the Firewall.  I chose the <u>second item</u> . <br><br>  Now you need to create a client configuration.  It is assumed that the OpenVPN Client is installed on your client (Android) and all the necessary certificates and keys are available, including the client one. <br><br>  The client configuration is as follows: <br><blockquote>  client <br>  dev <b>tun</b> <br>  proto <b>udp</b> <br>  remote xxx-xx-xxx-xxx-xxx.us-west-2.compute.amazonaws.com 1194 <br>  resolv-retry infinite <br>  route-method exe <br>  nobind <br>  persist-key <br>  persist tun <br>  ca ca.crt <br>  cert client.crt <br>  key client.key <br>  remote-cert-tls server <br>  tls-auth ta.key 1 <br>  cipher AES-256-CBC <br>  auth SHA1 <br>  verb 3 <br>  <b>route 0.0.0.0 0.0.0.0 vpn_gateway</b> </blockquote><br>  In android OpenVPN import configuration.  On the <b>Basic</b> tab, we set the authentication type <b>Certificates</b> , since  we basically have no password.  Checking the <b>Server List</b> tab, your Amazon server, port 1194, and UDP type must be specified.  On the <b>IP address and DNS</b> tab, the <b>Request parameters</b> option should be set. <br><br>  On the <b>Routing for IPv4</b> tab, the <b>Use default route</b> option should be set. <br><br>  Save the configuration. <br><br>  Trying to connect to your server.  If the connection is not established, check the <b>Network &amp; Security</b> ‚Üí <b>Security Groups</b> and firewall.  If everything is OK, then <b>SUCCESS</b> will appear and you will receive any of the IP VPN network.  In my case, this is 172.10.10.6/30. <br><br>  On the client, we try to open any site ... There is a connection, but the sites do not open. <br><br>  What is the matter?  The point is NAT. <br><br>  The network has manuals on how to configure NAT on Amazon, with the creation of additional AMI, Internet Gate, IP Elastic and other bullshit.  None of this is necessary. <br><br>  Everything is much simpler. <br><br>  We return to our server, create the role of <b>Network Police and Access Services</b> .  It includes the role of <b>Routing and Remote Access</b> .  Open the context menu, select <b>Configure and Enable</b> . <br><br>  Select the last item to create your configuration.  In the next step, we choose the last two points, <b>NAT</b> and <b>LAN routing</b> . <br><br>  After reveal the role of <b>Routing and Remote Access</b> ‚Üí <b>IPv4</b> ‚Üí <b>NAT</b> .  Create an interface: <b>LAN1</b> - the one that looks on the Internet.  In the properties we set the <i>Public interface</i> and <i>Enable NAT on this interface</i> .  Open the <b>Address Pool</b> tab.  Click <b>Add</b> . <br><br>  Here we need to add the IP address of our machine, not our network, namely the machine (ipconfig / all) <br>  I remind you that my network is <i>10.100.11.0/24</i> , VPN network is <i>172.10.10.0/24</i> , the address of the machine is <i>10.100.11.20</i> .  <i>Start address we</i> specify 10.100.11.20 and <i>End address we</i> specify it.  Mask 255.255.255.0 <br><br>  We save. <br><br>  Now in the same mode, click the <b>Reserve Addresses</b> button.  We need to ‚Äúconnect‚Äù the VPN client's address (it was 172.10.10.6/30 when connected) with the address of the machine. <br>  Click <b>Add</b> <br><br>  <b>Reserve this public IP</b> set <i>10.100.11.20</i> , and below we write <i>172.10.10.6</i> <br>  We <u>do not set the</u> Allow incoming option. <br><br>  We save. <br><br>  Now there is the last step - we add another interface to NAT - TAP.  I called him HomeVPN.  There are no settings for it, it is Private Interface.  NAT is not set for him. <br><br>  This is <b>how the</b> ‚Äúredirection‚Äù <b>from VPN to LAN turned out: 172.10.10.6 ‚Üí 10.100.11.20</b> . <br><br>  We make a reconnect on the client, wait for the VPN to rise, open ipleak.net and watch. <br><br>  The client's IP address will be in the <i>USA / Oregon region,</i> and the WebRTC IP address will have to show the IP address of our VPN server, i.e.  <i>172.10.10.6</i> . <br><br>  If everything is so, then you have succeeded.  If not, then at some step you made a mistake, or hurried. <br><br>  In conclusion, go to the <b>Dashboard</b> ‚Üí section <b>Network &amp; Security</b> ‚Üí Security Groups.  Choose a group that is associated with our instance.  On the tabs <i>Inbound, Outbound,</i> remove permissions to skip all traffic.  We leave RDP, and who have not done it before, add rules for port 1194 and allow ICMP. <br><br>  For the sim - everything.  Thank you. <br><br>  PS I did not test it on Windows clients, but I think everything should be the same as on android. </div><p>Source: <a href="https://habr.com/ru/post/327676/">https://habr.com/ru/post/327676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../327662/index.html">Swift Generics: Styles for UIView and more. # 1</a></li>
<li><a href="../327666/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ260 (April 24 - 30, 2017)</a></li>
<li><a href="../327668/index.html">Quick start on React Native</a></li>
<li><a href="../327670/index.html">Monitoring Docker Swarm with cAdvisor, InfluxDB and Grafana</a></li>
<li><a href="../327674/index.html">Bucardo: Multimaster replication</a></li>
<li><a href="../327678/index.html">Linus Torvalds introduced the Linux kernel 4.11</a></li>
<li><a href="../327680/index.html">Crowd Marketing: Top 10 Popular Questions</a></li>
<li><a href="../327682/index.html">Encryption in EXT4. How it works?</a></li>
<li><a href="../327684/index.html">How to raise your i2p-site (eepsite) on VDS (VPS) under Ubuntu (LAMP). Briefing for beginners</a></li>
<li><a href="../327686/index.html">Structure and execution model of .NET Core applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>