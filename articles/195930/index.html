<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Battle for Klozhuru or operation "Battle Magnet"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Participated in the Clojure Cup 2013 along with Sanya ingspree , Sergey Joes and Roma rofh . Probably, you have seen the cutting , and maybe the full ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Battle for Klozhuru or operation "Battle Magnet"</h1><div class="post__text post__text-html js-mediator-article">  Participated in the Clojure Cup 2013 along with Sanya <a href="https://habrahabr.ru/users/ingspree/" class="user_link">ingspree</a> , Sergey <a href="https://habrahabr.ru/users/joes/" class="user_link">Joes</a> and Roma <a href="https://twitter.com/rofh">rofh</a> .  Probably, you have seen the <a href="http://habrahabr.ru/post/193950/">cutting</a> , and maybe the <a href="http://www.youtube.com/watch%3Fv%3DR4sTvHXkToQ">full presentation of</a> Sanya on the Klozhurskripte and reactive programming.  That turned up the opportunity to try these technologies in battle. <br><br>  Subject of the competition - in 48 hours to file something using Clojure or ClojureScript.  It was decided to cut browser <a href="http://en.wikipedia.org/wiki/Risk_%2528game%2529">Risk</a> from various options, in particular, because all existing applications are poor in interface, either written in Flash, or even worse - Silverlight, or in some way spoil the pastime.  Collectively came up with a good name - <a href="http://clojurecup.com/app.html%3Fapp%3Dwarmagnet">War Magnet</a> . <br><br>  Without thinking twice, we decided to write both the Clojure server and the ClojureScript client using common code.  Of the four participants, only Sani had at least some experience of writing on a slope, while the rest had only the experience of solving dozens of tasks for <a href="http://www.4clojure.com/">4clojure</a> . <br><a name="habracut"></a><h4>  Server </h4><br>  I will not tell a lot about the server part - for the entire time of the competition I have never touched the server part.  As a database, we chose from two options: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first thing that comes to mind when combining the words Clojure and "database" - <a href="http://datomic.com/">Datomic</a> .  It is very interesting to try, but none of us had absolutely no experience with a datomic, even a couple of hours, and we were afraid that another completely new concept in the project could ruin the initiative and we will not have time. <br><br>  Therefore, the choice fell on the most fashionable database in recent years - PostgreSQL. <br><br>  We tried to use <a href="https://github.com/si14/clony/">clony</a> from <a href="https://habrahabr.ru/users/si14/" class="user_link">si14</a> as a blank, but it turned out to be too difficult for us, it was very incomprehensible how to expand with our own things.  Half a day after the start, they made a new repository without clony, and quickly transferred all the developments there. <br><br>  I will list the libraries that we used on the server - compojure, ring, korma, friend, cheshire, http-kit.  By the edge of my ear I heard unfriendly comments about the feed, and Sergey promised to describe all the other details about this in his <a href="http://mrjoes.github.io/">blog</a> . <br><br><h4>  Customer </h4><br>  We chose which technologies to use on the client.  There is a new-fashioned <a href="https://github.com/clojure/core.async">core.async</a> , but it was dropped due to the fact that all the <a href="http://rigsomelight.com/2013/07/18/clojurescript-core-async-todos.html">tutorials</a> and manuals write about how to manage the data nicely, and then nailed to DOM with <a href="http://rigsomelight.com/2013/08/12/clojurescript-core-async-dots-game.html">selectors</a> .  There is an opinion that this is a flawed concept, and you just need to accept that HTML is how we build interfaces.  And if the selectors join - then we sort of work on the side of it, and because of any change in the interface structure, we have to very carefully and tediously saw through these damn selectors. <br><br>  There are good looking reactive libraries for ClojureScript - a bunch of <a href="https://github.com/tailrecursion/javelin">javelin</a> and <a href="https://github.com/tailrecursion/hoplon/">hoplon</a> .  Though they are good from a conceptual point of view, no one has yet done optimizations there, and therefore they are very slow - the simplest <a href="http://micha.github.io/todofrp/">Todo example</a> noticeably slows down even on the desktop firefox.  Development of a more complex application would turn into pain due to constant interface brakes, they decided to refuse. <br><br>  In the last project for the work, Sanya and Roma are using Facebook <a href="http://facebook.github.io/react/">React</a> in conjunction with the censcript, and they like it very much.  So they took him.  On Friday, before the start of the competition, I began to sort out React a bit and began to write a binding <a href="https://github.com/piranha/pump">library</a> for him.  We finished the first version on Saturday at one o'clock. <br><br>  This is what React looks like: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> HelloMessage = React.createClass({ <span class="hljs-attr"><span class="hljs-attr">displayName</span></span>: <span class="hljs-string"><span class="hljs-string">'HelloMessage'</span></span>, <span class="hljs-attr"><span class="hljs-attr">componentWillMount</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ ... }, <span class="hljs-attr"><span class="hljs-attr">render</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"smth"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{'Hello ' + this.props.name}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } });</code> </pre> <br><br>  This XML-like syntax is convenient and clear in javascript.  But to integrate it into Clojure, even the thought did not arise: inspired by the syntax <a href="https://github.com/weavejester/hiccup">hiccup</a> , we made this option: <br><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">defr</span></span> HelloMessage <span class="hljs-symbol"><span class="hljs-symbol">:component-will-mount</span></span> (<span class="hljs-name"><span class="hljs-name">fn</span></span> [] ...) [this props state] [<span class="hljs-symbol"><span class="hljs-symbol">:div</span></span>.smth (<span class="hljs-name"><span class="hljs-name">str</span></span> <span class="hljs-string"><span class="hljs-string">"Hello "</span></span> (<span class="hljs-symbol"><span class="hljs-symbol">:name</span></span> props))])</code> </pre> <br>  Some problems have arisen at the junction of the cladorcript and the reactor.  For example, we first tried to directly use ClojureScript data structures as a state, but the reactor inside it makes a shallow copy without transferring the prototype, and everything broke.  As a crutch, they began to put our state in the field <code>state.state</code> , and get it out. <br><br>  Of course, it is hidden in the library, but because of this, we had to do <code>assoc-state</code> and <code>assoc-in-state</code> helpers, which must be used to change the state.  One of the developers of the React - Pete Hunt - in irc offered the same workaround.  Maybe somehow it will be possible to make friends with them in a more adequate way. <br><br>  In general, at the client, we store all the state in one atom, in one data structure, which we transfer to the controllers deeper and deeper by the necessary parts.  We would have a local apocalypse with javascript, but the data structures in the clit are unmucable, so there were no problems. <br><br>  To communicate between the server and the client, we used json, because the cool edn format on the client is deserialized slower by about an order of magnitude, and <a href="https://github.com/tailrecursion/cljson">cljson</a> , which maintains the structure of the templates, seemed ridiculous and incomprehensible.  And this turned out to be a mistake! <br><br>  Then there were problems with the fact that <code>:keyword</code> serialized as a ‚Äúkeyword‚Äù.  Klodure can be said <code>:keywordize-keys</code> - make keywords in dictionaries from keys.  But this does not solve all the problems - not all keywords were keys in dictionaries, and it creates others - not all keys in dictionaries were keywords.  It turned out to be especially unpleasant with numbers ‚Äî the server-side Clojure cannot do at all <code>(keyword 1)</code> and returns <code>nil</code> , and ClojureScript will do <code>:1</code> , but then it turns out that json's keys deserialized with special options contain a string inside, not a number, ie <code>(keyword "1")</code> . <br><br>  From the second half of Sunday we lost at least an hour and a half on this problem, and now the crutches are set up along the code here and there.  It was necessary to initially use cljson, and, probably, we will remake it to use. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e8/2bb/267/1e82bb267f64b67b96cc8ee373f75fbb.png"><br><br>  Here is the code for this window: <br><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">defr</span></span> Attack [C {<span class="hljs-symbol"><span class="hljs-symbol">:keys</span></span> [attacker attacking defender defending attack!]} S] (<span class="hljs-name"><span class="hljs-name">let</span></span> [[aname {<span class="hljs-symbol"><span class="hljs-symbol">:keys</span></span> [coordinates]}] attacker [dname dmap] defender [xy] (<span class="hljs-name"><span class="hljs-name">xy-for-popover</span></span> coordinates)] [<span class="hljs-symbol"><span class="hljs-symbol">:div</span></span>.popover {<span class="hljs-symbol"><span class="hljs-symbol">:style</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:display</span></span> <span class="hljs-string"><span class="hljs-string">"block"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:left</span></span> x <span class="hljs-symbol"><span class="hljs-symbol">:top</span></span> y}} [<span class="hljs-symbol"><span class="hljs-symbol">:div</span></span>.popover-content [<span class="hljs-symbol"><span class="hljs-symbol">:table</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:thead</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:tr</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:th</span></span> (<span class="hljs-name"><span class="hljs-name">name</span></span> aname)] [<span class="hljs-symbol"><span class="hljs-symbol">:th</span></span> (<span class="hljs-name"><span class="hljs-name">name</span></span> dname)]]] [<span class="hljs-symbol"><span class="hljs-symbol">:tbody</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:tr</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:td</span></span> attacking] [<span class="hljs-symbol"><span class="hljs-symbol">:td</span></span> defending]]]] [<span class="hljs-symbol"><span class="hljs-symbol">:div</span></span>.btn-group [<span class="hljs-symbol"><span class="hljs-symbol">:button</span></span>.btn.btn-warning {<span class="hljs-symbol"><span class="hljs-symbol">:on-click</span></span> #(<span class="hljs-name"><span class="hljs-name">attack!</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> aname dname)} <span class="hljs-string"><span class="hljs-string">"Attack"</span></span>] [<span class="hljs-symbol"><span class="hljs-symbol">:button</span></span>.btn.btn-danger {<span class="hljs-symbol"><span class="hljs-symbol">:on-click</span></span> #(<span class="hljs-name"><span class="hljs-name">attack!</span></span> (<span class="hljs-name"><span class="hljs-name">dec</span></span> attacking) aname dname)} <span class="hljs-string"><span class="hljs-string">"Blitz"</span></span>]]]]))</code> </pre> <br>  In my opinion, everything that happens here is pretty understandable.  And if someone is straining the number of brackets here, so remember that in real HTML there are two more of them: <code>&lt;div&gt;&lt;/div&gt;</code> - four, <code>[:div]</code> - two.  Plus, when editing, paredit helps a lot - with it in brackets you don‚Äôt get confused at all. <br><br>  In general, the impression was that ClojureScript and React are a pair of bundles, you can and should use it! <br><br><h4>  Competition </h4><br>  Sanya threw a cry about participation in the Clojure Cup two weeks before, at the same time we agreed on what to do and approximately what technologies to use.  But, as usual, almost no one prepares for such competitions, despite any promises to himself and his comrades, and we are no exception.  Although we started the library on Friday night (this is allowed by the rules)! <br><br>  Clojurecup itself lasted exactly 48 hours of the weekend, from 00:00 UTC on Saturday until 00:00 UTC on Monday.  In our time it is three in the morning. <br><br>  Having gathered in the office since Saturday morning, we spent about half a day on completing the library, all sorts of setups and other buildup to working condition. <br><br>  For Saturday, we got authorization via Mozilla's <a href="https://login.persona.org/about">Persona</a> (cool thing!), Sending messages between the client and the server via web sockets, a little bit of the common code between the client and the server, and in the database - tablets with users, games and the event log.  The classic Risk-card with the territories started to be drawn on the client and somehow highlighted on hover.  Last commit at 22:30. <br><br>  In the morning of Sunday I drew us a nice logo, and then I had all Sunday blurred into one continuous pedal of the code.  The binding of the game card and the server, moves, attacks, replenishment, etc. actually remained at the end. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6ef/b39/e39/6efb39e393dcafc74e3f0c707dc9e80b.png"><br><br>  By evening, it was still in a disassembled state, by eight o'clock we had slightly altered the map description format and loaded it on the server for the first time.  Since it was still completely incomprehensible whether we are in time to finish the game to the minimum working condition, we decided to continue until we see a chance and a desire / opportunity to do something. <br><br>  Somewhere around eight or nine hours, we moved to another room, where there was much better lighting, cool and closer to the corner with tea and coffee :) It turned out that all the time there was a chance to make a working version, there was enough energy and enthusiasm, and we sawed, sawed it right up to the deadline. <br><br>  A commit with a working game and a button "end the move": <br><br><pre>  Mon Sep 30 2013 02:59:54 GMT + 0300 (EEST) </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/5a6/39c/530/5a639c53055779dbafe4098eb8809ebb.png"><br><br>  Unfortunately, in our production version, a bug has crept in with loading map data from a file.  Locally it works, but when packed in a uberjar it does not, it needs to be loaded from resources.  A commit with fixing this was 5 minutes before the finish, but it turned out to be unsuccessful, and we have a version that we can‚Äôt play.  Lacked literally fifteen minutes. <br><br>  According to the rules, we do not have the right to fix anything or post another version somewhere.  Now there is a vote, it will end on Thursday and on Friday it will be possible to update and show fully working. <br><br>  There were more than 90 teams registered.  We got 6.5% commits of the total number of commits of all teams, and there is at least one team that has turned out even more, it seems 9.15%.  <a href="http://clojurecup.com/apps.html">42 teams</a> selected for voting.  For some reason, their website doesn‚Äôt really work for me in firefox.  In chrome works. <br><br>  I promise that on Friday we will post the working version anyway, but for now on the page of our team you can <a href="http://clojurecup.com/app.html%3Fapp%3Dwarmagnet">vote</a> for us! </div><p>Source: <a href="https://habr.com/ru/post/195930/">https://habr.com/ru/post/195930/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../195918/index.html">The implementation of the condition "OR" in SphinxQL</a></li>
<li><a href="../195920/index.html">iCub is a robole who can see, feel, learn and learn</a></li>
<li><a href="../195922/index.html">New courses virtual academy Microsoft Virtual Academy</a></li>
<li><a href="../195924/index.html">Used batteries can charge 140 smartphones</a></li>
<li><a href="../195928/index.html">WTF?</a></li>
<li><a href="../195932/index.html">How to arrange a festival?</a></li>
<li><a href="../195934/index.html">Migrating to Chef Server 11</a></li>
<li><a href="../195938/index.html">KINS client part leaked</a></li>
<li><a href="../195942/index.html">Impressions of forty days of open source daily work on GitHub.</a></li>
<li><a href="../195944/index.html">We do not need your coffee</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>