<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to build WhatsApp for the day. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear readers of Habrahabr! 

 In this series of articles, I'll tell you how to quickly and almost painlessly raise your own WhatsApp for iOS. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to build WhatsApp for the day. Part 1</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/d59/e3c/cb8/d59e3ccb8b7fac27d79ae2d9e644848e.jpg"><br><br>  Hello, dear readers of Habrahabr! <br><br>  In this series of articles, I'll tell you how to quickly and almost painlessly raise your own WhatsApp for iOS.  I divide the article into two parts for your convenience: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Creating a project, a simple UI, linking to an instant messaging service </li><li>  Make a beautiful UI, add video and audio calls, transfer photos and documents </li></ol><br>  Unfortunately, the manual on how to dial 400 million users and sell the service for 19 Instagram cards was lost somewhere on the bookshelf.  I will try to find it if anyone is interested. <br><br>  Interested please under the cat. <br><a name="habracut"></a><br><h4>  Project creation </h4><br>  Open Xcode and create a new project. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/189/7f8/a11/1897f8a1179aee4748e3d3887b6e95f6.png"><br><br>  We take Single View Application for a basis. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/009/9bc/293/0099bc293e6d875c16239b37288a6938.png"><br><br>  Enter all the data for the application and click "Next".  I chose the least pretentious regalia. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/33d/27a/231/33d27a23123a12346fcf504b2cc5fe8d.png"><br><br>  And the project is ready. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/612/48d/949/61248d94982893db73b1f320565c294e.png"><br><br>  But what is it?  What a terrible sorting of files into groups!  Let's fix it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/93e/fa9/bd5/93efa9bd53ae5e638ce6ebd504e06802.png"><br><br>  That's better!  You can use your way of sorting files, but in this guide I will stick to the model above.  By the way, the key combination for creating a new group is Command + Alt + N. <br><br><h4>  Simple UI </h4><br>  In the meantime, I allowed myself to create a new NKLoginViewController class and bind it to a UIViewController object in Interface Builder.  This View Controller will be the first thing the user sees.  This is logical - no chat without registration! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/758/b50/efe/758b50efe71b047fa72ce11a3477df7a.png"><br><br>  Continuing to have fun, I screwed the text fields, like Outlet, and the Action of the "Login" button to our NKLoginViewController.  I think this is a good way to screw IB objects in .m files so that they are inaccessible from the outside.  Moreover, I like when the code is divided into "Pragmas". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d8b/eb3/0dc/d8beb30dc5c49d3dc239b37929224eeb.png"><br><br>  We create one more controller (both representation in IB, and a new class) - the list of chats.  We use the standard code UITableViewController - we don‚Äôt need any supernatural functionality here, for now. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fff/003/47a/fff00347aaf45f9ed9583bd16e6cfe78.png"><br><br>  Slightly change the NKChatListTableViewController.m code so that at least something is displayed in the table: <br><br><div class="spoiler">  <b class="spoiler_title">Push me!</b> <div class="spoiler_text"><pre><code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span>)tableView:(<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *)tableView numberOfRowsInSection:(<span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span>)section { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>; } - (<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> *)tableView:(<span class="hljs-built_in"><span class="hljs-built_in">UITableView</span></span> *)tableView cellForRowAtIndexPath:(<span class="hljs-built_in"><span class="hljs-built_in">NSIndexPath</span></span> *)indexPath { <span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> *cell = [tableView dequeueReusableCellWithIdentifier:<span class="hljs-string"><span class="hljs-string">@"cell"</span></span> forIndexPath:indexPath]; cell.textLabel.text = <span class="hljs-string"><span class="hljs-string">@"Vasiliy Pupkin"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell; }</code> </pre> </div></div><br>  Now we will think over navigation.  The whole application will be built into one UINavigationController and the controllers will be ‚Äúpush‚Äù and ‚Äúhit‚Äù depending on the situation.  Let's build the same application in UINavigationController!  Let the magic time begin! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ff/68a/b8e/4ff68ab8e34749689f717da3f6f28e8b.png"><br><br>  Add controller names and Segue from Login View Controller to Chat List Table View Controller.  Let's call it "SegueToChatList".  This is what our application looks like now. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e2/119/7d7/1e21197d7e245d4aafbfca842e5b8301.png"><br><br>  Slightly work on the Login View Controller code.  We give the user the opportunity to remove the keyboard.  To do this, we will make the controller a delegate of text fields. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f4c/621/e3e/f4c621e3e2d3f08193c0ff620903bcb3.gif"><br><br>  And we correct the controller code as follows: <br><br><div class="spoiler">  <b class="spoiler_title">NKLoginViewController.h</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> //      @interface NKLoginViewController : UIViewController </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UITextFieldDelegate&gt;</span></span></span><span class="hljs-meta"> @end</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">NKLoginViewController.m</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKLoginViewController.h"</span></span></span><span class="hljs-meta"> @interface NKLoginViewController () @property (weak, nonatomic) IBOutlet UITextField *emailTextField; @property (weak, nonatomic) IBOutlet UITextField *passwordTextField; - (IBAction)loginTouched:(UIButton *)sender; @end @implementation NKLoginViewController #pragma mark - UITextFieldDelegate - //  ,    </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Done"</span></span></span><span class="hljs-meta">   - (BOOL)textFieldShouldReturn:(UITextField *)textField { [textField resignFirstResponder]; return YES; } #pragma mark - Button methods - //           </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">. - (IBAction)loginTouched:(UIButton *)sender { [self performSegueWithIdentifier:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SegueToChatList"</span></span></span><span class="hljs-meta"> sender:self]; }</span></span></code> </pre></div></div><br>  For the time being, we will move all elements on the login controller up - this is a simple UI.  How interactively to move elements of the interface up at emergence of the keyboard, I will tell in the following part. <br><br>  Our application can already poke! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/652/ac4/926/652ac4926c15d08286ff39f3dc41de07.gif"><br><br>  Create a third - and last - controller.  We will get into it by clicking on the cell of the previous controller.  The controller itself consists of a UITableView, the data source of which is assigned to the controller, the text field and the "Send" button.  I guess this screen is intuitive. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ef1/6ad/9eb/ef16ad9eb6fb8e752f7c96baa37792a8.png"><br><br>  The NKChatViewController.m code is below: <br><br><div class="spoiler">  <b class="spoiler_title">Push me!</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKChatViewController.h"</span></span></span><span class="hljs-meta"> @interface NKChatViewController () @property (weak, nonatomic) IBOutlet UITableView *tableView; @property (weak, nonatomic) IBOutlet UITextField *messageTextField; - (IBAction)sendTouched:(UIButton *)sender; @end @implementation NKChatViewController #pragma mark - View Controller life cycle - - (void)viewDidAppear:(BOOL)animated { [super viewDidAppear:animated]; //  ,      [_messageTextField becomeFirstResponder]; } #pragma mark - UITableViewDataSource - - (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { return 20; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cell"</span></span></span><span class="hljs-meta">]; cell.textLabel.text = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" "</span></span></span><span class="hljs-meta">; cell.detailTextLabel.text = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">",  ?"</span></span></span><span class="hljs-meta">; return cell; } #pragma mark - Button methods - - (IBAction)sendTouched:(UIButton *)sender { } @end</span></span></code> </pre></div></div><br>  A simple UI for our messenger is ready.  Getting to the most interesting - filling the application! <br><br><h4>  Binding to an instant messaging service </h4><br>  C2Call will be our instant messaging service.  Of course, no one bothers you to write your server part, but it may take a little more than 24 hours. <br><br>  All you need to do is register on c2call.com and buy a account for $ 100.  Unfortunately, in the free version, registration via the low-language API does not work.  Perhaps something will change at the time you read this article.  However, instead of a monthly payment, C2Call charged me $ 100 and seemed to have forgotten about me.  More money is not written off.  I do not urge you to either buy a product or try your luck with a monthly subscription.  I guess I was just lucky. <br><br>  After registering, purchasing the account and registering the application on the service, this is a rather trivial task - download the SDK.  The archive has a couple of examples of how to build applications.  We will need the following two objects: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e1f/d83/131/e1fd83131825f1b219da2fcab51113d9.png"><br><br>  We transfer them to our project. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f64/8d3/808/f648d380862b800c85f2786a044cff20.png"><br><br>  Add the following frameworks and libraries to the project: <br><br><div class="spoiler">  <b class="spoiler_title">Horrific list of frameworks and libraries</b> <div class="spoiler_text">  AVFoundation.framework <br>  Accounts.framework <br>  AdSupport.framework <br>  AddressBook.framework <br>  AddressBookUI.framework <br>  AssetsLibrary.framework <br>  AudioToolbox.framework <br>  CFNetwork.framework <br>  CoreAudio.framework <br>  CoreData.framework <br>  CoreFoundation.framework <br>  CoreLocation.framework <br>  CoreMedia.framework <br>  CoreTelephony.framework <br>  CoreText.framework <br>  CoreVideo.framework <br>  MapKit.framework <br>  MediaPlayer.framework <br>  MessageUI.framework <br>  MobileCoreServices.framework <br>  OpenGLES.framework <br>  QuartzCore.framework <br>  QuickLook.framework <br>  Security.framework <br>  StoreKit.framework <br>  SystemConfiguration.framework <br>  iAd.framework <br>  libsqlite3.dylib <br>  libz.dylib <br></div></div><br>  And write the following in Build Settings: <br><br>  HEADER_SEARCH_PATHS = / usr / include / libxml2 <br>  OTHER_LDFLAGS = -lxml2 -lstdc ++ <br>  ARCHS = armv7 <br>  VALID_ARCHS = armv7 <br><br>  Now let's change the App Delegate a bit: <br><br><div class="spoiler">  <b class="spoiler_title">NKAppDelegate.h</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SocialCommunication/SocialCommunication.h&gt;</span></span></span><span class="hljs-meta"> @interface NKAppDelegate : C2CallAppDelegate </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIApplicationDelegate&gt;</span></span></span><span class="hljs-meta"> @property (strong, nonatomic) UIWindow *window; @end</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">NKAppDelegate.m</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NKAppDelegate</span></span></span><span class="hljs-class"> - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BOOL</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIApplication</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">application</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">didFinishLaunchingWithOptions</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSDictionary</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">launchOptions</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.affiliateid = <span class="hljs-string"><span class="hljs-string">@"6B9DF5671444320162B"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.secret = <span class="hljs-string"><span class="hljs-string">@"2fd9cd18aa4d957a4030c0455101646d"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> application:application didFinishLaunchingWithOptions:launchOptions]; } <span class="hljs-keyword"><span class="hljs-keyword">@end</span></span></code> </pre></div></div><br>  We added the element from C2Call and told him about our data.  You can view your Affiliate ID and Secret in the admin panel of the service. <br><br>  Finished with setting up the framework, it's time to use it. <br><br>  Create a subclass of NSObject called NKChat, in which we encapsulate all the chat logic.  I think it would be right to give you a rough listing of the NKChat.m code, and then explain it. <br><br><div class="spoiler">  <b class="spoiler_title">NKChat.m</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKChat.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SocialCommunication/SocialCommunication.h&gt;</span></span></span><span class="hljs-meta"> @implementation NKChat #pragma mark - Singleton pattern - // 1 + (instancetype)sharedManager { static NKChat *sharedChat = nil; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ sharedChat = [self new]; }); return sharedChat; } #pragma mark - Accessors - // 2 - (NSArray *)chatHistory { return [self fetchChatHistory]; } #pragma mark - General methods - // 3 - (void)login:(NSString *)email password:(NSString *)password success:(void(^)())successBlock failure:(void(^)())failureBlock { NSDictionary *dictionary = @{@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EMail"</span></span></span><span class="hljs-meta">:email, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Password"</span></span></span><span class="hljs-meta">:password}; [[C2CallPhone currentPhone] registerUser:dictionary withCompletionHandler:^(BOOL success, NSString *result) { if (success) { [[C2CallPhone currentPhone] startC2CallPhone]; successBlock(); } else { failureBlock(); } }]; } // 4 - (void)logout { [(C2CallAppDelegate *)[UIApplication sharedApplication].delegate logoutUser]; } // 5 - (void)sendMessage:(NSString *)message toUser:(NSString *)userId { [[C2CallPhone currentPhone] submitMessage:message toUser:userId]; } // 6 - (NSArray *)fetchChatHistory { //   Managed Object   NSFetchRequest *request = [[SCDataManager instance] fetchRequestForChatHistory:YES]; NSFetchedResultsController *controller = [[SCDataManager instance] fetchedResultsControllerWithFetchRequest:request sectionNameKeyPath:nil cacheName:nil]; NSError *error; [controller performFetch:&amp;error]; //    NSMutableArray *result = [NSMutableArray array]; for (NSManagedObject *chat in controller.fetchedObjects) { //    NSArray *chatKeys = @[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"contact"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"lastTimestamp"</span></span></span><span class="hljs-meta">, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"missedEvents"</span></span></span><span class="hljs-meta">]; NSMutableDictionary *inChat = [[chat dictionaryWithValuesForKeys:chatKeys] mutableCopy]; //    NSMutableDictionary *dublicate = nil; for (NSMutableDictionary *dict in result) { if ([dict[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"contact"</span></span></span><span class="hljs-meta">] isEqualToString:inChat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"contact"</span></span></span><span class="hljs-meta">]]) { dublicate = dict; break; } } //    NSMutableArray *messages = (dublicate) ? dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"messages"</span></span></span><span class="hljs-meta">] : [NSMutableArray array]; for (NSManagedObject *chatEvent in [chat valueForKey:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"chatHistory"</span></span></span><span class="hljs-meta">]) { NSArray *chatEventKeys = [[[chatEvent entity] attributesByName] allKeys]; NSMutableDictionary *inChatEvent = [[chatEvent dictionaryWithValuesForKeys:chatEventKeys] mutableCopy]; // NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%@"</span></span></span><span class="hljs-meta">,inChatEvent); inChatEvent[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ManagedObject"</span></span></span><span class="hljs-meta">] = chatEvent; [messages addObject:inChatEvent]; } [messages sortUsingDescriptors:@[[NSSortDescriptor sortDescriptorWithKey:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"timevalue"</span></span></span><span class="hljs-meta"> ascending:YES]]]; if (dublicate) { dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"messages"</span></span></span><span class="hljs-meta">] = messages; [dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ManagedObjects"</span></span></span><span class="hljs-meta">] addObject:chat]; dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"missedEvents"</span></span></span><span class="hljs-meta">] = @([dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"missedEvents"</span></span></span><span class="hljs-meta">] intValue] + [inChat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"missedEvents"</span></span></span><span class="hljs-meta">] intValue]); if (!dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">]) dublicate[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">] = inChat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"name"</span></span></span><span class="hljs-meta">]; } else { inChat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"messages"</span></span></span><span class="hljs-meta">] = messages; inChat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ManagedObjects"</span></span></span><span class="hljs-meta">] = [NSMutableArray arrayWithObject:chat]; } //     if (!dublicate) [result addObject:inChat]; } //   [result sortUsingDescriptors:@[[NSSortDescriptor sortDescriptorWithKey:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"lastTimestamp"</span></span></span><span class="hljs-meta"> ascending:NO]]]; //    return [result copy]; } @end</span></span></code> </pre></div></div><br>  Let's go in order: <br><br><ol><li>  Standard template - Singleton.  Nothing unusual for you should be here.  We have one object that is responsible for the chat - no longer needed. </li><li>  An accessor method that returns an array of chat history in the form we need. </li><li>  Method for registration and login.  The C2Call feature is that when you log in with the same data for the first time, you register.  When you log in with the same data a second time, you simply log in.  This method is once again unavailable for free subscribers, unfortunately.  You can bypass this method by adding a native registration window from C2Call, in order to save. </li><li>  Method for logout.  Cheap and angry. </li><li>  The method for sending a message is also quite simple. </li><li>  Terrible and monstrous method-tablecloth, which returns the chat history in the right format.  Here are all the stones that can be encountered using C2Call.  First, data is stored in Core Data.  Secondly, the names of contacts are always different - then the id will come, then the name and surname.  Thirdly, forget about this method for now.  It works for this tutorial too :) </li></ol><br>  Well, when everything is ready for work, it's time to use the magic of the code! <br><br>  Add to NKAppDelegate.m the initialization of NKChat, if you have not already done so. <br><br><div class="spoiler">  <b class="spoiler_title">NKAppDelegate.m</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKAppDelegate.h"</span></span></span><span class="hljs-meta"> @implementation NKAppDelegate - (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions { self.affiliateid = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"6B9DF5671444320162B"</span></span></span><span class="hljs-meta">; self.secret = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"2fd9cd18aa4d957a4030c0455101646d"</span></span></span><span class="hljs-meta">; [NKChat sharedManager]; return [super application:application didFinishLaunchingWithOptions:launchOptions]; } @end</span></span></code> </pre></div></div><br>  Now let's slightly change the loginTouched method of the NKLoginViewController class.  Do not forget to import NKChat! <br><br><div class="spoiler">  <b class="spoiler_title">Push me!</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)loginTouched:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { sender.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; [[NKChat sharedManager] login:_emailTextField.text password:_passwordTextField.text success:^{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> performSegueWithIdentifier:<span class="hljs-string"><span class="hljs-string">@"SegueToChatList"</span></span> sender:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; sender.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } failure:^{ sender.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; }]; }</code> </pre></div></div><br>  Here we turned off the button until the response from the server is loaded, sent a request to the server, go to the new controller if successful, turn on the button, regardless of the result. <br><br>  In this part of the tutorial, we will work with two accounts: nikita@borodutch.com and luke@borodutch.com.  We will simply be able to send messages to these two contacts, temporarily. <br><br>  Slightly modify NKChatListTableViewController.m so that you can only send messages to these two contacts. <br><br><div class="spoiler">  <b class="spoiler_title">Push me!</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKChatListTableViewController.h"</span></span></span><span class="hljs-meta"> @interface NKChatListTableViewController () @end @implementation NKChatListTableViewController #pragma mark - UITableViewDataSource - - (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { return 2; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cell"</span></span></span><span class="hljs-meta"> forIndexPath:indexPath]; cell.textLabel.text = (indexPath.row) ? @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"nikita@borodutch.com"</span></span></span><span class="hljs-meta"> : @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"luke@borodutch.com"</span></span></span><span class="hljs-meta">; return cell; } @end</span></span></code> </pre></div></div><br>  The result of the manipulation: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7af/2d5/14c/7af2d514c11e1633da7ce7c8df3ac9e7.png"><br><br>  Add a method to send information to the next controller in NKChatListTableViewController.m. <br><br><div class="spoiler">  <b class="spoiler_title">Push me!</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)prepareForSegue:(<span class="hljs-built_in"><span class="hljs-built_in">UIStoryboardSegue</span></span> *)segue sender:(<span class="hljs-built_in"><span class="hljs-built_in">UITableViewCell</span></span> *)sender { <span class="hljs-built_in"><span class="hljs-built_in">UIViewController</span></span> *dest = segue.destinationViewController; dest.title = sender.textLabel.text; }</code> </pre></div></div><br>  It remains for us to only receive the desired chat history and send messages to the right contacts!  Case in the hat, sir. <br><br>  As in the good old days, I will give the listing of NKChatViewController.m along with explanations a little below. <br><br><div class="spoiler">  <b class="spoiler_title">Push me!</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKChatViewController.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SocialCommunication/SocialCommunication.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"NKChat.h"</span></span></span><span class="hljs-meta"> @interface NKChatViewController () @property (weak, nonatomic) IBOutlet UITableView *tableView; @property (weak, nonatomic) IBOutlet UITextField *messageTextField; - (IBAction)sendTouched:(UIButton *)sender; @end @implementation NKChatViewController { NSArray *tableData; } #pragma mark - View Controller life cycle - - (void)viewDidLoad { [super viewDidLoad]; // 1 tableData = [self getTableData]; } - (void)viewDidAppear:(BOOL)animated { [super viewDidAppear:animated]; //  ,      [_messageTextField becomeFirstResponder]; // 2 [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(receivedMessage) name:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"kC2CallPhoneReceivedMessage"</span></span></span><span class="hljs-meta"> object:nil]; } #pragma mark - UITableViewDataSource - - (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section { // 3 return tableData.count; } - (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath { // 4 UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cell"</span></span></span><span class="hljs-meta">]; cell.textLabel.text = ([tableData[indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"eventType"</span></span></span><span class="hljs-meta">] isEqualToString:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MessageIn"</span></span></span><span class="hljs-meta">]) ? self.title : @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">; cell.detailTextLabel.text = tableData[indexPath.row][@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"text"</span></span></span><span class="hljs-meta">]; return cell; } #pragma mark - Button methods - - (IBAction)sendTouched:(UIButton *)sender { // 5 [[NKChat sharedManager] sendMessage:_messageTextField.text toUser:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"c45645f71465dcff18e"</span></span></span><span class="hljs-meta">]; [self addMessage:_messageTextField.text]; _messageTextField.text = @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">""</span></span></span><span class="hljs-meta">; } #pragma mark - General Methods - - (void)addMessage:(NSString *)message { // 6 NSMutableArray *mTableData = [tableData mutableCopy]; [mTableData addObject:@{@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"text"</span></span></span><span class="hljs-meta">:message, @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"eventType"</span></span></span><span class="hljs-meta">:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MessageOut"</span></span></span><span class="hljs-meta">}]; tableData = mTableData; [_tableView reloadData]; } - (void)receivedMessage { // 7 tableData = [self getTableData]; [_tableView reloadData]; } - (NSArray *)getTableData { // 8 for (NSDictionary *chat in [NKChat sharedManager].chatHistory) if ([chat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"contact"</span></span></span><span class="hljs-meta">] isEqualToString:self.title]) return chat[@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"messages"</span></span></span><span class="hljs-meta">]; return nil; } @end</span></span></code> </pre></div></div><br>  In order: <br><br><ol><li>  As soon as the controller is loaded, we fill it with the necessary data. </li><li>  kC2CallPhoneReceivedMessage is the definition of the name of the notification that a new message has arrived;  subscribe to this event </li><li>  We need as many cells as there are total messages in the history of this chat. </li><li>  Each cell is given the desired contact name and message </li><li>  Send a message using the method from NKChat;  add a message to the controller's local data, because the message takes time to add to the C2Call history;  clear the send field </li><li>  The method of adding a message to the controller's local data.  I guess it is intuitive </li><li>  When you receive a message, you need to reload the history in the controller and force the table to update its data </li><li>  Just go through the entire history and return the history of the contact we need. </li></ol><br>  Here's what we got (big gif): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f65/248/fa6/f65248fa6a92e8e4092f6cfe730afab7.gif"><br><br><h4>  Conclusion </h4><br>  Thank you so much for reaching the end of the first part of this guide.  Soon, as a couple of free days will appear, I will write the second part.  The source code of the first part is <a href="https://github.com/backmeupplz/C2Call-Tutorial-Part-1">here</a> . <br><br>  In the second part, we will solve some scrupulous questions on the UI, we will go around a couple of C2Call bugs (for example, the one that is visible on the last gif with receiving messages), add functionality to the application and add a couple of seals. <br><br>  If you have any questions on the tutorial, feel free to ask them in the comments - I will answer all. <br><br>  If you find any typos or inaccuracies in the article, please contact my haborcenter. <br><br>  See you soon. </div><p>Source: <a href="https://habr.com/ru/post/225079/">https://habr.com/ru/post/225079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225063/index.html">New functionality nanoCAD 6.0: regulatory audit</a></li>
<li><a href="../225065/index.html">The DataBanding Revolution with Object.Observe ()</a></li>
<li><a href="../225067/index.html">Need more Landing Page</a></li>
<li><a href="../225069/index.html">The first Tizen smartphone Samsung Z will appear in Russia in the autumn</a></li>
<li><a href="../225077/index.html">The author of the banker Trojan Zeus is wanted</a></li>
<li><a href="../225083/index.html">June 5, 2014 - World Day Against Internet Surveillance</a></li>
<li><a href="../225089/index.html">Swift - innovations</a></li>
<li><a href="../225091/index.html">Back / Forward Cache - browser caching mechanism</a></li>
<li><a href="../225093/index.html">About common sense and company management</a></li>
<li><a href="../225095/index.html">What do neural networks hide?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>