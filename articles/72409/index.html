<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modifying bytecode java virtual machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post is a continuation of the article about the byte-code of the Java virtual machine, and we believe that the reader has an idea of ‚Äã‚Äãits struct...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modifying bytecode java virtual machine</h1><div class="post__text post__text-html js-mediator-article"> This post is a continuation of the <a href="http://habrahabr.ru/blogs/java/69797/">article</a> about the byte-code of the Java virtual machine, and we believe that the reader has an idea of ‚Äã‚Äãits structure.  The most common library for modifying bytecode is <a href="http://asm.ow2.org/">ASM</a> from object web.  Most high-level libraries are built on it, in particular cglib. <br><br>  The ASM library has two APIs.  To better imagine the difference between them, we will draw the following analogy.  Class is a kind of tree.  The root of it is the class itself.  Variables, methods, subclasses are its leaves.  Instructions - leaves the methods.  This way you can draw a parallel with XML and its two types of parsers.  The first version of Core API is similar to SAX parser.  When you need to read, create, or make changes, a class tree is traversed.  The second option (Tree API) works on the trailer DOM parser.  First, a representation tree is built, and then the necessary manipulations are performed with it.  Obviously, the first API is less resource intensive, more suitable for making small changes.  The second requires more resources, but also gives more flexibility.  We will consider only the first version of the API. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To create a class using the Core API, you need to bypass its view tree.  Consider a more specific example.  We want to profile the next class. <br><br> <code><font color="red"><b>public</b></font> <font color="red"><b>class</b></font> Example <font color="blue"><b>{</b></font> <br> <br> <font color="red"><b>public</b></font> <font color="red"><b>void</b></font> run <font color="blue"><b>(</b></font> String name <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>try</b></font> <font color="blue"><b>{</b></font> <br> Thread <font color="blue"><b>.</b></font> sleep <font color="blue"><b>(</b></font> <font color="brown">5</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> System <font color="blue"><b>.</b></font> out <font color="blue"><b>.</b></font> println <font color="blue"><b>(</b></font> <font color="PURPLE">"Currennt time is "</font> <font color="blue">+</font> <font color="red"><b>new</b></font> Date <font color="blue"><b>(</b></font> System <font color="blue"><b>.</b></font> currentTimeMillis <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <font color="red"><b>catch</b></font> <font color="blue"><b>(</b></font> InterruptedException e <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> e <font color="blue"><b>.</b></font> printStackTrace <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> System <font color="blue"><b>.</b></font> out <font color="blue"><b>.</b></font> println <font color="blue"><b>(</b></font> name <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> <br> <font color="blue"><b>}</b></font></code> <br> <br>  For example, get the runtime method runtime information.  To do this, create a successor. <br><br> <code><font color="red"><b>public</b></font> <font color="red"><b>class</b></font> Test <font color="red"><b>extends</b></font> Example <font color="blue"><b>{</b></font> <br> <br> @Override <br> <font color="red"><b>public</b></font> <font color="red"><b>void</b></font> run <font color="blue"><b>(</b></font> String name <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>long</b></font> l <font color="blue">=</font> System <font color="blue"><b>.</b></font> currentTimeMillis <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="red"><b>super</b></font> <font color="blue"><b>.</b></font> run <font color="blue"><b>(</b></font> name <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> System <font color="blue"><b>.</b></font> out <font color="blue"><b>.</b></font> println <font color="blue"><b>(</b></font> <font color="blue"><b>(</b></font> System <font color="blue"><b>.</b></font> currentTimeMillis <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue">-</font> l <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue+1"><b>}</b></font> <br> <font color="blue"><b>}</b></font></code> <br> <br>  But how can you create it using ASM. <br><br> <code>ClassWriter cw <font color="blue">=</font> <font color="red"><b>new</b></font> ClassWriter <font color="blue"><b>(</b></font> ClassWriter <font color="blue"><b>.</b></font> COMPUTE_MAXS <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> cw <font color="blue"><b>.</b></font> visit <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> V1_5 <font color="blue"><b>,</b></font> Opcodes <font color="blue"><b>.</b></font> ACC_PUBLIC <font color="blue"><b>,</b></font> <font color="purple">"org/Test"</font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>,</b></font> <font color="purple">"org/example/Example"</font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> cw <font color="blue"><b>.</b></font> visitField <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> ACC_PRIVATE <font color="blue"><b>,</b></font> <font color="purple">"name"</font> <font color="blue"><b>,</b></font> <font color="purple">"Ljava/lang/String;"</font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>.</b></font> visitEnd <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> MethodVisitor methodVisitor <font color="blue">=</font> cw <font color="blue"><b>.</b></font> visitMethod <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> ACC_PUBLIC <font color="blue"><b>,</b></font> <font color="purple">"&lt;init&gt;"</font> <font color="blue"><b>,</b></font> <font color="purple">"()V"</font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitCode <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitVarInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> ALOAD <font color="blue"><b>,</b></font> <font color="BROWN">0</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> INVOKESPECIAL <font color="blue"><b>,</b></font> <font color="purple">"org/example/Example"</font> <font color="blue"><b>,</b></font> <font color="purple">"&lt;init&gt;"</font> <font color="blue"><b>,</b></font> <font color="purple">"()V"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> RETURN <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMaxs <font color="blue"><b>(</b></font> <font color="BROWN">1</font> <font color="blue"><b>,</b></font> <font color="BROWN">1</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitEnd <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> methodVisitor <font color="blue">=</font> cw <font color="blue"><b>.</b></font> visitMethod <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> ACC_PUBLIC <font color="blue"><b>,</b></font> <font color="purple">"run"</font> <font color="blue"><b>,</b></font> <font color="purple">"(Ljava/lang/String;)V"</font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>,</b></font> <font color="red"><b>null</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitCode <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> INVOKESTATIC <font color="blue"><b>,</b></font> <font color="purple">"java/lang/System"</font> <font color="blue"><b>,</b></font> <font color="purple">"currentTimeMillis"</font> <font color="blue"><b>,</b></font> <font color="purple">"()J"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitVarInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> LSTORE <font color="blue"><b>,</b></font> <font color="BROWN">2</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitVarInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> ALOAD <font color="blue"><b>,</b></font> <font color="BROWN">0</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitVarInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> ALOAD <font color="blue"><b>,</b></font> <font color="BROWN">1</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> INVOKESPECIAL <font color="blue"><b>,</b></font> <font color="purple">"org/example/Example"</font> <font color="blue"><b>,</b></font> <font color="purple">"run"</font> <font color="blue"><b>,</b></font> <font color="purple">"(Ljava/lang/String;)V"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitFieldInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> GETSTATIC <font color="blue"><b>,</b></font> <font color="purple">"java/lang/System"</font> <font color="blue"><b>,</b></font> <font color="purple">"out"</font> <font color="blue"><b>,</b></font> <font color="purple">"Ljava/io/PrintStream;"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> INVOKESTATIC <font color="blue"><b>,</b></font> <font color="purple">"java/lang/System"</font> <font color="blue"><b>,</b></font> <font color="purple">"currentTimeMillis"</font> <font color="blue"><b>,</b></font> <font color="purple">"()J"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitVarInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> LLOAD <font color="blue"><b>,</b></font> <font color="BROWN">2</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> LSUB <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> INVOKEVIRTUAL <font color="blue"><b>,</b></font> <font color="purple">"java/io/PrintStream"</font> <font color="blue"><b>,</b></font> <font color="purple">"println"</font> <font color="blue"><b>,</b></font> <font color="purple">"(J)V"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> RETURN <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitMaxs <font color="blue"><b>(</b></font> <font color="BROWN">5</font> <font color="blue"><b>,</b></font> <font color="BROWN">4</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> methodVisitor <font color="blue"><b>.</b></font> visitEnd <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> cw <font color="blue"><b>.</b></font> visitEnd <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="red"><b>return</b></font> cw <font color="blue"><b>.</b></font> toByteArray <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font></code> <br> <br>  So we got an array of bytes in which the structure of the new class is stored.  Now we need this new class to load.  To do this, you need your own ClassLoader, since the standard class loading method has a protected modifier. <br><br> <code><font color="red"><b>class</b></font> MyClassLoader <font color="red"><b>extends</b></font> ClassLoader <font color="blue"><b>{</b></font> <br> <br> <font color="red"><b>public</b></font> Class defineClass <font color="blue"><b>(</b></font> String name <font color="blue"><b>,</b></font> <font color="red"><b>byte</b></font> <font color="blue"><b>[</b></font> <font color="blue"><b>]</b></font> b <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>return</b></font> defineClass <font color="blue"><b>(</b></font> name <font color="blue"><b>,</b></font> b <font color="blue"><b>,</b></font> <font color="BROWN">0</font> <font color="blue"><b>,</b></font> b <font color="blue"><b>.</b></font> length <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> <font color="blue"><b>}</b></font></code> <br> <br>  And how can this be done? <br><br> <code>MyClassLoader myClassLoader <font color="blue">=</font> <font color="red"><b>new</b></font> MyClassLoader <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> Class bClass <font color="blue">=</font> myClassLoader <font color="blue"><b>.</b></font> defineClass <font color="blue"><b>(</b></font> <font color="PURPLE">"org.Test"</font> <font color="blue"><b>,</b></font> Generator <font color="blue"><b>.</b></font> getBytecodeForClass <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> Constructor constructor <font color="blue">=</font> bClass <font color="blue"><b>.</b></font> getConstructor <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> Object o <font color="blue">=</font> constructor <font color="blue"><b>.</b></font> newInstance <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> Example e <font color="blue">=</font> <font color="blue"><b>(</b></font> Example <font color="blue"><b>)</b></font> o <font color="blue"><b>;</b></font> <br> e <font color="blue"><b>.</b></font> run <font color="blue"><b>(</b></font> <font color="PURPLE">"test"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font></code> <br> <br>  Thus, we can create a quick profiling utility that, using reflection, receives information and uses it to create the desired class.  For a similar trailer built libraries that implement AOP. <br><br>  Consider another example.  Suppose we need to test the class that calls System.currentTimeMillis ().  To do this, we just need to learn how to replace the currentTimeMillis () call with a call to another static method.  We act like this: we read a class, bypassing its tree and, where necessary, changing the method call. <br><br><br> <code>ClassReader cr <font color="blue">=</font> <font color="red"><b>new</b></font> ClassReader <font color="blue"><b>(</b></font> <font color="PURPLE">"org.example.Example"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> ClassWriter cw <font color="blue">=</font> <font color="red"><b>new</b></font> ClassWriter <font color="blue"><b>(</b></font> cr <font color="blue"><b>,</b></font> ClassWriter <font color="blue"><b>.</b></font> COMPUTE_MAXS <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> ClassVisitor cv <font color="blue">=</font> <font color="red"><b>new</b></font> ReplaceStaticMethodClassAdapter <font color="blue"><b>(</b></font> cw <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> cr <font color="blue"><b>.</b></font> accept <font color="blue"><b>(</b></font> cv <font color="blue"><b>,</b></font> ClassReader <font color="blue"><b>.</b></font> SKIP_DEBUG <font color="blue">|</font> ClassReader <font color="blue"><b>.</b></font> SKIP_FRAMES <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> <font color="red"><b>return</b></font> cw <font color="blue"><b>.</b></font> toByteArray <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <br> <font color="green"><i>//---------------------------------------------------------------------------- <br></i></font> <br> <br> <font color="red"><b>private</b></font> <font color="red"><b>static</b></font> <font color="red"><b>class</b></font> ReplaceStaticMethodClassAdapter <font color="red"><b>extends</b></font> ClassAdapter <font color="blue"><b>{</b></font> <br> <br> <font color="red"><b>public</b></font> RepaleStaticMethodClassAdapter <font color="blue"><b>(</b></font> ClassVisitor classVisitor <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>super</b></font> <font color="blue"><b>(</b></font> classVisitor <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> <br> @Override <br> <font color="red"><b>public</b></font> MethodVisitor visitMethod <font color="blue"><b>(</b></font> <font color="red"><b>int</b></font> i <font color="blue"><b>,</b></font> String s <font color="blue"><b>,</b></font> String s1 <font color="blue"><b>,</b></font> String s2 <font color="blue"><b>,</b></font> String <font color="blue"><b>[</b></font> <font color="blue"><b>]</b></font> strings <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>return</b></font> <font color="red"><b>new</b></font> RepalceStaticMethodAdapter <font color="blue"><b>(</b></font> <font color="red"><b>super</b></font> <font color="blue"><b>.</b></font> visitMethod <font color="blue"><b>(</b></font> i <font color="blue"><b>,</b></font> s <font color="blue"><b>,</b></font> s1 <font color="blue"><b>,</b></font> s2 <font color="blue"><b>,</b></font> strings <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> <br> <font color="red"><b>private</b></font> <font color="red"><b>class</b></font> RepalceStaticMethodAdapter <font color="red"><b>extends</b></font> MethodAdapter <font color="blue"><b>{</b></font> <br> <font color="red"><b>public</b></font> RepalceStaticMethodAdapter <font color="blue"><b>(</b></font> MethodVisitor methodVisitor <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>super</b></font> <font color="blue"><b>(</b></font> methodVisitor <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> <br> @Override <br> <font color="red"><b>public</b></font> <font color="red"><b>void</b></font> visitMethodInsn <font color="blue"><b>(</b></font> <font color="red"><b>int</b></font> i <font color="blue"><b>,</b></font> String s <font color="blue"><b>,</b></font> String s1 <font color="blue"><b>,</b></font> String s2 <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>if</b></font> <font color="blue"><b>(</b></font> i <font color="blue">=</font> <font color="blue">=</font> Opcodes <font color="blue"><b>.</b></font> INVOKESTATIC <font color="blue"><font color="blue">&amp;</font> <font color="blue">&amp;</font></font> <font color="PURPLE">"java/lang/System"</font> .equals <font color="blue"><b>(</b></font> s <font color="blue"><b>)</b></font> <font color="blue"><font color="blue">&amp;</font> <font color="blue">&amp;</font></font> <font color="PURPLE">"currentTimeMillis"</font> .equals <font color="blue"><b>(</b></font> s1 <font color="blue"><b>)</b></font> <font color="blue"><font color="blue">&amp;</font> <font color="blue">&amp;</font></font> <font color="PURPLE">"()J"</font> .equals <font color="blue"><b>(</b></font> s2 <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>super</b></font> <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> Opcodes <font color="blue"><b>.</b></font> INVOKESTATIC <font color="blue"><b>,</b></font> <font color="PURPLE">"org/example/Generator"</font> <font color="blue"><b>,</b></font> <font color="PURPLE">"myTime"</font> <font color="blue"><b>,</b></font> <font color="PURPLE">"()J"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <font color="red"><b>else</b></font> <font color="blue"><b>{</b></font> <br> <font color="red"><b>super</b></font> <font color="blue"><b>.</b></font> visitMethodInsn <font color="blue"><b>(</b></font> i <font color="blue"><b>,</b></font> s <font color="blue"><b>,</b></font> s1 <font color="blue"><b>,</b></font> s2 <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> <font color="blue"><b>}</b></font> <br> <font color="blue"><b>}</b></font> <br> <font color="blue"><b>}</b></font> <br> <font color="blue"><b>}</b></font></code> <br> <br>  Loading a modified class has some special features.  In jvm, classes are defined not only by their name, but also by the ClassLoader that was used when loading it.  A class loaded using MyClassLoader will be of a different type than the class loaded by default ClassLoder.  So call the method, we will need to use reflection. <br><br> <code>MyClassLoader myClassLoader <font color="blue">=</font> <font color="red"><b>new</b></font> MyClassLoader <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> Class aClass <font color="blue">=</font> myClassLoader <font color="blue"><b>.</b></font> defineClass <font color="blue"><b>(</b></font> <font color="purple">"org.example.Example"</font> <font color="blue"><b>,</b></font> Generator <font color="blue"><b>.</b></font> getModifedClass <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> Constructor constructor <font color="blue">=</font> aClass <font color="blue"><b>.</b></font> getConstructor <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> Object o <font color="blue">=</font> constructor <font color="blue"><b>.</b></font> newInstance <font color="blue"><b>(</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> Method method <font color="blue">=</font> aClass <font color="blue"><b>.</b></font> getMethod <font color="blue"><b>(</b></font> <font color="purple">"run"</font> <font color="blue"><b>,</b></font> String <font color="blue"><b>.</b></font> <font color="red"><b>class</b></font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font> <br> method <font color="blue"><b>.</b></font> invoke <font color="blue"><b>(</b></font> o <font color="blue"><b>,</b></font> <font color="purple">"test"</font> <font color="blue"><b>)</b></font> <font color="blue"><b>;</b></font></code> <br> <br>  You can also load both the Test and Example classes using MyClassLoader, and if the Test class calls the run method, the Example class will call the modified method. <br><br>  A working example can be taken <a href="http://code.google.com/p/java-byte-code-example/">from here</a> . <br><br>  <a href="http://math-and-prog.blogspot.com/2009/10/java.html">Modifying bytecode java virtual machine</a> </div><p>Source: <a href="https://habr.com/ru/post/72409/">https://habr.com/ru/post/72409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72395/index.html">Wrong script has disconnected the .SE domain from the Internet</a></li>
<li><a href="../72399/index.html">How to use Zend_Paginator correctly</a></li>
<li><a href="../72400/index.html">Ukraine has moved to a new format for dialing phone numbers</a></li>
<li><a href="../72401/index.html">If I designed the phone</a></li>
<li><a href="../72404/index.html">Acer introduced its first Android-smartphone</a></li>
<li><a href="../72411/index.html">Internet commerce in Russia is illegal!</a></li>
<li><a href="../72412/index.html">View high quality images</a></li>
<li><a href="../72413/index.html">Superconductivity at -19 ¬∞ C</a></li>
<li><a href="../72414/index.html">New stones in propel'e, we are waiting for the other day news</a></li>
<li><a href="../72415/index.html">12 Things You Didn't Know About Venture Investors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>