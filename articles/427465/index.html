<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What happens behind the scenes C #: the basics of working with the stack</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I propose to look at all that is behind the simple lines of initializing objects, calling methods, and passing parameters. Well and, of course, the us...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What happens behind the scenes C #: the basics of working with the stack</h1><div class="post__text post__text-html js-mediator-article">  I propose to look at all that is behind the simple lines of initializing objects, calling methods, and passing parameters.  Well and, of course, the use of this information in practice is the subtraction of the stack of the calling method. <br><br><h3>  Disclaimer </h3><br>  Before proceeding with the story, I strongly recommend that you read the first post about <a href="https://habr.com/post/423657/">StructLayout</a> , because  there is an example that will be used in this article. <br><br>  All the code behind the high-level one is presented for the <b>debug</b> mode, it is he who shows the conceptual basis.  JIT optimization is a separate and big topic that will not be covered here. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I would also like to warn that this article does not contain material that should be used in real projects. <br><br><h3>  We start with the theory </h3><br>  Any code eventually becomes a set of machine commands.  Most understandable is their representation in the form of Assembly language instructions that directly correspond to one (or several) machine instructions. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ya/yv/k7/yayvk7f2o3tfr5flwaybim4u1m8.jpeg"></div><a name="habracut"></a><br>  Before turning to a simple example, I propose to get acquainted with what a software stack is.  <b>A software stack</b> is primarily a section of memory that is used, as a rule, for storing all sorts of data (as a rule, they can be called <i>temporary data</i> ).  It is also worth remembering that the stack grows towards smaller addresses.  That is, the later an object is placed on the stack, the less will be its address. <br><br>  Now let's look at what the next piece of code in Assembly language looks like (I‚Äôve omitted some of the calls that are inherent in the debug mode). <br><br>  C #: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StubClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StubMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fromEcx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fromEdx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fromStack</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> local = <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> local + fromEcx + fromEdx + fromStack; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallingMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> local1 = <span class="hljs-number"><span class="hljs-number">7</span></span>, local2 = <span class="hljs-number"><span class="hljs-number">8</span></span>, local3 = <span class="hljs-number"><span class="hljs-number">9</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = StubMethod(local1, local2, local3); } }</code> </pre> <br>  Asm: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">StubClass</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.StubMethod</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x10</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x4]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0xc]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x10]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0xc]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x5</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0xc]</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x4]</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x8]</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">add</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp+0x8]</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x10]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x10]</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x4</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">StubClass</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.CallingMethod</span></span>() 1: <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> 2: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span> 3: <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x14</span></span> 4: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 5: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x14]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 6: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 7: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0xc]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 8: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 9: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x8]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 10: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 11: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x4]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 12: <span class="hljs-selector-tag"><span class="hljs-selector-tag">xor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 13: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x10]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span> 14: <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> 15: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x4]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x7</span></span> 16: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x8]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8</span></span> 17: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0xc]</span></span>, 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x9</span></span> 18: <span class="hljs-selector-tag"><span class="hljs-selector-tag">push</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">dword</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0xc]</span></span> 19: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ecx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x4]</span></span> 20: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edx</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x8]</span></span> 21: <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">StubClass</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.StubMethod</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">Int32</span></span>) 22: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x14]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 23: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span>, <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x14]</span></span> 24: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[ebp-0x10]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">eax</span></span> 25: <span class="hljs-selector-tag"><span class="hljs-selector-tag">nop</span></span> 26: <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">esp</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> 27: <span class="hljs-selector-tag"><span class="hljs-selector-tag">pop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ebp</span></span> 28: <span class="hljs-selector-tag"><span class="hljs-selector-tag">ret</span></span></code> </pre><br>  The first thing you should pay attention to is the <b>EBP</b> and <b>ESP</b> registers and operations with them. <br><br>  It is a common misconception among my friends that the <b>EBP</b> register is somehow related to the pointer to the top of the stack.  I must say that it is not. <br><br>  The pointer to the top of the stack is the <b>ESP</b> register.  Correspondingly, with each <b>PUSH command</b> (putting a value at the top of the stack), the value of this register is decremented (the stack grows towards smaller addresses), and with each <b>POP</b> operation it is incremented.  Also, the <b>CALL</b> command enters the return address on the stack, thereby decrementing the value of the <b>ESP</b> register.  In fact, the change of the <b>ESP</b> register is performed not only when these instructions are executed (for example, even when interrupt calls are made, the same happens with the <b>CALL</b> instructions). <br><br>  Consider StubMethod. <br><br>  In the first line, the contents of the <b>EBP</b> register are saved (put on the stack).  Before returning from a function, this value will be restored. <br><br>  The second line stores the current value of the address of the top of the stack (the value of the <b>ESP</b> register is entered into <b>EBP</b> ).  In this case, the <b>EBP</b> register is a peculiar zero in the context of the current call.  Addressing is done relative to it.  Next, we move the top of the stack to as many positions as we need to store local variables and parameters (third row).  Something like memory allocation for all local needs. <br><br>  All of the above is called the function prologue. <br><br>  After that, access to variables on the stack occurs through the stored <b>EBP</b> , which indicates the place where the variables of this method begin. <br>  Next comes the initialization of local variables. <br><br>  <i>Fastcall</i> reminder: in the native .net, the <i>fastcall</i> calling <i>convention is used</i> . <br>  The agreement governs the location and order of the parameters passed to the function. <br>  With <i>fastcall, the</i> first and second parameters are transmitted via the <b>ECX</b> and <b>EDX</b> registers, respectively, the subsequent parameters are transmitted via the stack. <br><br>  For non-static methods, the first parameter is implicit and contains the address of the object on which the method is called (this address). <br><br>  In lines 4 and 5, the parameters that were passed through the registers (the first 2) are stored on the stack. <br><br>  Next is cleaning the space on the stack for local variables and initializing local variables. <br><br>  It is worth recalling that the result of the function is in the <b>EAX</b> register. <br><br>  In lines 12-16, the addition of the desired variables occurs.  I draw your attention to line 15. There is a call to an address greater than the beginning of the stack, that is, to the stack of the previous method.  Before calling, the caller pushes a parameter to the top of the stack.  Here we read it.  The result of the addition is obtained from the <b>EAX</b> register and placed on the stack.  Since this is the return value of the StubMethod, it is placed again in <b>EAX</b> .  Of course, such absurd instruction sets are inherent only in the debug mode, but they show exactly how our code looks like without a smart optimizer that does the lion‚Äôs share of the work. <br><br>  In lines 18 and 19, the previous <b>EBP</b> (the calling method) and the pointer to the stack top (at the time the method is called) are restored. <br><br>  The last line returns.  About the value 0x4 I will tell a little lower. <br>  Such a sequence of commands is called a function epilogue. <br><br>  Now let's take a look at CallingMethod.  Let's go straight to line 18. Here we put the third parameter on the top of the stack.  Please note that we do this using the <b>PUSH</b> instruction, that is, the <b>ESP</b> value is decremented.  The other 2 parameters are placed in registers ( <i>fastcall</i> ).  Next comes the StubMethod method call.  And now let's remember the instruction <b>RET 0x4</b> .  Here the following question is possible: what is 0x4?  As I mentioned above, we pushed the parameters of the called function onto the stack.  But now we do not need them.  0x4 indicates how many bytes need to be cleared from the stack after the function call.  Since the parameter was one, you need to clear 4 bytes. <br><br>  Here is a rough image of the stack: <br><br><img src="https://habrastorage.org/webt/vz/eo/vz/vzeovzr2rvkuetuzi4xyp4iuxye.png"><br><br>  Thus, if we turn around and see what lies on the stack right after the method call, the first thing we will see is an <b>EBP</b> stack <b>pushed</b> (in fact, this happened in the first line of the current method).  Next will be the return address where the result of the function will fall.  And through these fields we will see the parameters of the current function themselves (Starting from the 3rd, the parameters are passed through registers before).  And behind them is the stack of the calling method itself! <br>  The first and second fields mentioned explain the offset in + 0x8 when referring to the parameters. <br>  Correspondingly, the parameters must lie at the top of the stack in a strictly defined order when calling a function.  Therefore, before calling the method, each parameter is pushed onto the stack. <br>  But what if they do not push, and the function will still take them? <br><br><h3>  Small example </h3><br>  So, all the above facts have caused me an overwhelming desire to read the stack of the method that will call my function.  The idea that literally in one position from the third argument (it will be closest to the stack of the calling method) is the cherished data that I so want to receive, did not let me sleep. <br><br>  Thus, to read the stack of the calling method, I need to climb a little further than the parameters. <br><br>  When referring to parameters, the calculation of the address of a particular parameter is based only on the fact that the caller has pushed all of them onto the stack. <br><br>  But the implicit transfer via the <b>EDX</b> parameter (who cares is the <a href="https://habr.com/post/424011/">previous article</a> ) suggests that we can outwit the compiler in some cases. <br><br>  The tool with which I did this is called the StructLayoutAttribute (features in the <a href="https://habr.com/post/423657/">first article</a> ).  // Someday I‚Äôll learn something other than this attribute, I promise. <br><br>  We use the same favorite method with reference types. <br><br>  At the same time, if overlapping methods have a different number of parameters, we get that the compiler does not push the required ones onto the stack (at least, because it does not know which ones). <br>  However, the method that is actually called (with the same offset from a different type), turns into positive addresses relative to its stack, that is, those where it plans to find the parameters. <br><br>  But there he does not find them and begins to read the stack of the calling method. <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler code</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Magic</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StubClass</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StubClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { Id = id; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id; } [StructLayout(LayoutKind.Explicit)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomStructWithLayout</span></span> { [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Test1 Test1; [FieldOffset(<span class="hljs-number"><span class="hljs-number">0</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Test2 Test2; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Test1</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Useless</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> skipFastcall1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> skipFastcall2, StubClass adressOnStack</span></span></span><span class="hljs-function">)</span></span> { adressOnStack.Id = <span class="hljs-number"><span class="hljs-number">189</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Test2</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Useless</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">888</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Test2 objectWithLayout = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomStructWithLayout { Test2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Test2(), Test1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Test1() }.Test2; StubClass adressOnStack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubClass(<span class="hljs-number"><span class="hljs-number">3</span></span>); objectWithLayout.Useless(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"MAGIC - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{adressOnStack.Id}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// MAGIC - 189 } } }</span></span></code> </pre><br></div></div><br>  I will not give the assembly language code, everything is pretty clear there, but if I have any questions, I will try to answer them in the comments <br><br>  I understand perfectly well that this example cannot be used in practice, but in my opinion, it can be very useful for understanding the general scheme of work. </div><p>Source: <a href="https://habr.com/ru/post/427465/">https://habr.com/ru/post/427465/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../427453/index.html">How I did the transfer of sound on the Raspberry Pi</a></li>
<li><a href="../427455/index.html">Satellite provider OneWeb will try to get frequencies in Russia</a></li>
<li><a href="../427457/index.html">"The third wave" of AI and systems for state security</a></li>
<li><a href="../427459/index.html">LED lamps Diall from the store Castorama</a></li>
<li><a href="../427461/index.html">The beauty of non-unnamed JavaScript functions</a></li>
<li><a href="../427467/index.html">The quickest introduction to Reactive Programming</a></li>
<li><a href="../427469/index.html">Revenue and profits of electronics manufacturers, or who has more margin</a></li>
<li><a href="../427471/index.html">Developing unmanned vehicles in high school with LEGO EV3</a></li>
<li><a href="../427473/index.html">What problems Temlida can solve with the game</a></li>
<li><a href="../427475/index.html">Android LiveData at Kotlin using Retrofit and coroutines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>