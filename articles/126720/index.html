<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking Dendy Games. On the example of Road Fighter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to talk about the principle of hacking toys for the game console Dendy (it‚Äôs also the Nintendo Entertainment System, it‚Äôs also Famicom, it‚Äôs 10...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking Dendy Games. On the example of Road Fighter</h1><div class="post__text post__text-html js-mediator-article">  I want to talk about the principle of hacking toys for the game console Dendy (it‚Äôs also the Nintendo Entertainment System, it‚Äôs also Famicom, it‚Äôs 100,500 Chinese clones, hereafter just NES). <br>  Hacking (or rather modding, but the term ‚ÄúROMhacking‚Äù is more common in the emuscene) of the game will consist in partially disassembling the game code and writing your own small code.  In principle, ROMhacking hardly differs from the usual ‚Äúcracking‚Äù of programs or writing trainers for games. <br>  The victim will be a small toy, a frequenter of the Chinese cartridges of the multiplayer 9999999 in 1, the game Road Fighter. <br><a name="habracut"></a><br>  This is a fairly simple race, takes up little space and is ideal for experiments.  In this game it is possible to move the car only left or right across the screen.  Gameplayno is justified, but I want something more.  To begin, I will introduce the ability to move our race car back and forth. <br>  So, for this we need: <br><ul><li>  NES emulator with built-in debugger (or heavy artillery in the form of IDA to taste).  As an emulator, I recommend the latest version of FCEUX-2 ( <a href="http://fceux.com/">http://fceux.com</a> ) </li><li>  ROM file itself </li><li>  Favorite Hex Editor </li><li>  Compiler for MSC6502 processor (optional, but desirable) </li></ul> Rum file and compiler can be taken at the link at the end of the article. <br><br>  When we stocked up the tools and the prepared ones themselves, it would not hurt to understand some of the intricacies of the architecture of the NES console.  There is enough documentation both on the processor and on the device, so I‚Äôll briefly touch on the main points.  The next paragraph of the text can be skipped. <br>  The processor 6502 is 8-bit, but has a 16-bit address bus and can work with the address range 0h-FFFFh.  In this case, the first 7FFh bytes (2KB) are allocated to RAM, then some specific things follow, and the code itself is assigned a range of 8000h-FFFFh (32KB).  If the code of the game does not fit into the indicated volume, a special mechanism is used - ‚Äúmappers‚Äù.  Mappers have the ability to switch sections of code in the address space of the processor.  That is, temporarily replacing one section of code with another, thereby loading the necessary data ... Mappers operate with memory blocks ("banks") of 16 KB each.  Technically, mappers are chips on a cartridge board, and do not have reflections in the ROM file itself. <br><br>  <b>Step number one.</b>  <b>Expanding the ROM file.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we start the FCEUX emulator, load our patient and go to the Help-&gt; Message Log menu. <br>  We see about the following: <br><br> <code>PRG ROM: 1 x 16KiB <br> CHR ROM: 1 x 8KiB <br> .. <br> Mapper #: 0 <br> ..</code> <br> <br>  Road Fighter rum has a volume of 24KB, of which 16KB is allocated to PRG-ROM (code and data) and 8KB to CHR-ROM (graphics), and also uses a zero mapper (i.e., no mapper).  As you can see, ROM can be easily expanded by adding another memory bank to 16KB.  This is necessary for what would be where to add our code. <br>  First, open the built-in Hex Editor from the Debug menu.  Go to the address of $ 8000, and then to the address of $ C000 and see that they contain the same data.  Moreover, the data is mirrored in the range of $ 8000- $ C000 (you can easily make sure of it if you put the breakpoint on this range, it will never work).  Now open ROM in any hex editor and edit the title, it has the following format: <br><br> <code>0-3  "NES^Z" "^Z" = 0x1A <br> 4  16  PRG. <br> 5  8  CHR. <br> 6  7-4  4  -      ROM. <br> -  3 1  4-  VRAM. <br> -  2 1  512-     $7000-$71FF. <br> -  1 1   SRAM   $6000-$7FFF. <br> -  0 1   , 0   . <br> 7  7-4  4     ROM. <br> -  3-1 ,   0! <br> -  0 1    VS. <br> 8  8  RAM.     <br> -   .NES,    1x8 RAM  <br> -    0. <br> 9  7-1 ,   0. <br> -  0 1   PAL,   NTSC. <br> 10-15 ,   0!</code> <br> <br>  We set the number of PRG banks equal to two.  Next we paste (but do not overwrite!) Into the file an empty block of 16KB (4000h) in size immediately after the header.  Now the file should weigh 40KB. <br><br>  <b>Step number two.</b>  <b>We are looking for data.</b> <br><br>  Now we need to find the cell in the RAM responsible for the Y coordinate of the car and the cell with the key pressed code.  This can be done using the RAM Search tool built into the emulator (Tools menu).  In our case, it will be enough to run the emulator HEX Editor, and view the first 100h bytes with your eyes.  The processor has special ‚Äúshort instructions‚Äù for quick access to this range, so frequently used data is located here.  If you simultaneously open the main emulator window and the Hex Editor window, and click ‚Äúleft / right‚Äù (just do not forget to set up the control), then you can see that several cells change accordingly.  We need 07h - the key code and 65h - the X coordinate. It is logical to assume that the Y coordinate is near the X coordinate, change cell 66h to an arbitrary number and voila - the car has moved along the Y axis. You can also freeze the cell editor for the duration of tests C8h, it stores the amount of fuel. <br><br>  <b>Step number three.</b>  <b>We do a sidebar of the code and put a stub.</b> <br><br>  Knowing the addresses of the desired variables, you can already write your code, but for now we don‚Äôt know where to call it.  We put the bricpoint on the record, on cell 65h (through the context menu in hex or through the debugger), move the game to the left / right and the debugger window should open with the following code: <br><br> <code>01:D52B:E6 65 INC $0065 = #$64 <br> 01:D52D:60 RTS <br> 01:D52E:C6 65 DEC $0065 = #$64 <br> 01:D530:60 RTS</code> <br> <br>  The debugger may occasionally distort commands, so if you scroll up the debugger window, some commands will not be displayed correctly.  Having scrolled the code up a bit, or having reached the RTS step by step, we will reach the address from where the call key code check procedure and the subsequent movement of the car are called: <br><br> <code>01:D4D0:20 D9 D4 JSR $D4D9 <br> 01:D4D3:20 E1 D4 JSR $D4E1 <br> 01:D4D6:4C E9 D4 JMP $D4E9</code> <br> <br>  Replace JSR $ D4D9 with your own procedure call ‚Äî JSR $ 8000.  To do this, simply click on the strip to the left of the command address, and drive the desired command into the inline assembler.  Using step-by-step debugging, let's move on to the address of $ 8000, and put a stub in the form of a cut-out JSR and the subsequent RTS from our procedure: <br><br> <code>00:8000:20 D9 D4 JSR $D4D9 <br> 00:8003:60 RTS</code> <br> <br>  <b>Step number four.</b>  <b>We write the code and insert it into the ROM.</b> <br><br>  Create a text file RoadFighter.asm and enter into it such a simple code: <br><br> <code>$=$8000 <br> <br> LDA $07 <br> AND #$04 <br> BEQ checkUp <br> BNE backward: <br> <br> checkUp: <br> LDA $0007 <br> AND #$08 <br> BEQ exitInject <br> <br> forward: <br> LDA $66 <br> CMP #$50 ;      <br> BMI exitInject <br> DEC $0066 <br> JMP exitInject <br> <br> backward: <br> LDA $66 <br> CMP #$B0 <br> BPL exitInject <br> INC $0066 <br> <br> exitInject: <br> JSR $D4D9 <br> RTS</code> <br> <br>  Now run the compiler with the parameters ‚Äú-l roadFighter‚Äù.  The output will be a listing file and a binary.  Open the binary and copy its contents to ROM Road Fighter at offset 10h. <br><br>  <b>Step number five.</b>  <b>Fini-ta-la.</b> <br><br>  If everything is done correctly, then by running the modified ROM in the emulator, we will be able to move our race car forward and backward, thereby making it easier to push innocuous and not very typewriters on the track (and for their destruction points are given!). <br>  Archive with compiler, source, original rum and modified rum - <a href="http://narod.ru/disk/22324767001/RoadFighterModSource.zip.html">RoadFighterModSource.zip</a> (people) <br>  <a href="http://www.megaupload.com/%3Fd%3DVS8W0DX7">RoadFighterModSource.zip</a> (megaupload) <br></div><p>Source: <a href="https://habr.com/ru/post/126720/">https://habr.com/ru/post/126720/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../126714/index.html">Bootstrap toolkit for creating web applications</a></li>
<li><a href="../126715/index.html">Visa. Insurance case of the return of stolen money</a></li>
<li><a href="../126716/index.html">VKontakte page deletion became available</a></li>
<li><a href="../126717/index.html">Authorization through VKontakte, Mail.ru and others for the most beginners - 1</a></li>
<li><a href="../126718/index.html">Websites face a fine of 50 thousand euros for installing the Facebook Like button</a></li>
<li><a href="../126722/index.html">ReactOS Digest # 2</a></li>
<li><a href="../126723/index.html">Two contests from ASUS</a></li>
<li><a href="../126725/index.html">Wikimedia Referendum 2011</a></li>
<li><a href="../126726/index.html">Why rounded corners are easier to read</a></li>
<li><a href="../126729/index.html">What to do if lightning strikes your Amazon EC2 Instance?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>