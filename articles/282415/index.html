<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Device Attributes, or ioctl must die</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of working on Phantom OS, which is not a place for Unix at all, I nevertheless wanted to make a Unix-compatible subsystem in it. Not ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Device Attributes, or ioctl must die</h1><div class="post__text post__text-html js-mediator-article">  In the process of working on Phantom OS, which is not a place for Unix at all, I nevertheless wanted to make a Unix-compatible subsystem in it.  Not exactly POSIX, but something close enough.  Partly out of curiosity, partly for convenience, partly as another migration path.  (Well, in general, it was interesting how difficult it was to write a simple Unix "out of my head.") As goal number 1, the task was to launch quake 1 for Unix, which was achieved. <br><br>  In the process, of course, open / close / r / w / ioctl appeared, and it appeared that the latter was indecent, shamefully outdated.  As an exercise for brain drowning, I implemented (in addition to the usual ioctl) some alternative API that would allow managing the properties of devices in a more flexible and user-friendly way.  This API, of course, has its obvious disadvantages, and, in general, this article is RFC, aka request For Comments. <br><br>  So, user-level API: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// returns name of property with sequential number nProperty, or error errno_t listproperties( int fd, int nProperty, char *buf, int buflen ); errno_t getproperty( int fd, const char *pName, char *buf, int buflen ); errno_t setproperty( int fd, const char *pName, const char *pValue );</span></span></code> </pre> <br><br>  Rules: <br><br><ol><li>  No defaine with numbers, only names. </li><li>  No binary data, only strings </li></ol><br><a name="habracut"></a><br>  This is not very efficient, but I would like to assume that setting / reading properties is a rare process, and therefore it makes little sense to rest on its speed, and the context switching itself when calling is a lot. <br><br>  You can somewhat optimize the interface, for example, like this: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// returns name of property with sequential number nProperty, or error errno_t listproperties( int fd, int nProperty, char *buf, int buflen ); // returns property id by name errno_t property_by_name( int fd, int *nProperty, const char *name ); errno_t getproperty( int fd, int nProperty, char *buf, int buflen ); errno_t setproperty( int fd, int nProperty, const char *pValue ); // fast lane errno_t getproperty_i32( int fd, int nProperty, int32_t *data ); errno_t setproperty_i32( int fd, int nProperty, int32_t data );</span></span></code> </pre><br><br>  This schema for a single property is no slower than an ioctl. <br><br>  How good it is: you can make a common command (eg mode) that controls the parameters of any driver without knowing anything about it - mode / dev / myCrazyDriver will display a list of properties, and mode / dev / myCrazyDriver name val will set the name property to val. <br><br>  The implementation inside the driver (for which, of course, there is a corresponding uncomplicated infrastructure in the kernel) is also simple: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property_t</span></span> proplist[] = { { pt_int32, <span class="hljs-string"><span class="hljs-string">"leds"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, &amp;leds, <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)set_leds, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }, };</code> </pre><br><br>  This line describes a property that is of type int32, lies in the variable leds, and if it has changed, then it is necessary to call the function set_leds. <br><br>  In reality, apart from pt_int32, only pt_mstring was born - malloced strings, which is also quite convenient. <br><br>  In general, it must be said, the pace of development of the classic Unix API is somewhat surprising to me - there is a feeling that no one is seriously concerned with it, although it seems that certain systematization will not harm him. <br><br>  I have a few more additions to the traditional POSIX, which, to me, a Unixoid with 30 years of experience, seems simply obvious.  There will be time - I will publish. <br><br>  Links to the implementation (skin and bones, but still): <br><br><ul><li>  <a href="">Kernel data structures</a> </li><li>  <a href="">Command mode</a> </li><li>  <a href="">Example of sticking to a simple driver</a> </li><li>  <a href="">Nuclear subsystem</a> </li></ul><br><br>  It seems obvious, but I will mention that the mechanism, in principle, can be used for any entities, not only for devices. </div><p>Source: <a href="https://habr.com/ru/post/282415/">https://habr.com/ru/post/282415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282403/index.html">Is it possible to create an algorithm for trading on the exchange by analyzing the tonality of messages on the Internet</a></li>
<li><a href="../282405/index.html">Game development digest</a></li>
<li><a href="../282407/index.html">Yii: best practices</a></li>
<li><a href="../282411/index.html">Intel security hardware technology: a new word in the protection of biometric applications. Part 2</a></li>
<li><a href="../282413/index.html">YConfs - Conference Information Support System</a></li>
<li><a href="../282417/index.html">1 developer. 2 applications. 3 years</a></li>
<li><a href="../282419/index.html">Restore in 60 seconds (or how to speed up data recovery using Arcserve UDP)</a></li>
<li><a href="../282421/index.html">Receiving payment from international customers with Payoneer</a></li>
<li><a href="../282423/index.html">Extending Splunk functionality is just</a></li>
<li><a href="../282425/index.html">Frontend Dev Conf 2016: the heroes, events and surprises of the conference</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>