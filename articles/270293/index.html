<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We create an interactive vector scheme of the Moscow metro</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Moscow Metro is changing. Those who wish to imagine a scheme, say, of 1945, will easily collect data from open sources; the question remains with the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We create an interactive vector scheme of the Moscow metro</h1><div class="post__text post__text-html js-mediator-article">  Moscow Metro is changing.  Those who wish to imagine a scheme, say, of 1945, will easily collect data from open sources;  the question remains with the presentation of the result, - not to show it on a pie chart.  In the article I will talk about the main steps in creating a <i>proof-of-concept</i> <a href="http://metrostat.ru/">service</a> that allows you to show the metro scheme, for example, on May 1, 74 years <i>(left)</i> or stations with a depth of more than 30 meters <i>(right)</i> . <br><br><img src="https://habrastorage.org/files/7fb/5be/731/7fb5be73168f4557aa4d316a7a54770a.png"><br><a name="habracut"></a><br><h2>  We form requirements </h2><br><ol><li>  Show stations and lines for the selected date range <br></li><li>  Beauty - ‚ÄúLebedev Studio‚Äù has developed a wonderful <a href="http://img.artlebedev.ru/everything/metro/map2/vector/moscow-metro-map-ru-2.1.2.pdf">scheme</a> ;  and take it as a basis. </li><li>  The convenience of use. <br><ul><li>  To enter values ‚Äã‚ÄãI decided to use <i>range</i> sliders.  With them, we will achieve interactivity and change on the fly. </li><li>  I'm used to the functionality of map services that allow you to zoom and move the map - we implement it;  Especially since our scheme, in fact, is the map. </li><li>  Add the ability to share a link to the sample. </li></ul><br></li></ol><br>  It is assumed that the reader is at least superficially familiar with javascript, has an idea of ‚Äã‚Äãvector graphics and is generally well done <i>(will notice an error or a non-optimal solution and is not too lazy to suggest the best option for comments)</i> . <br><br><h2>  We display the scheme </h2><br>  To make the scheme interactive, we first need the scheme itself.  Let's look at what we want to get and analyze the image into simple elements. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Stations </h4><br>  The most important thing on the diagram is the stations, so let's start with them.  Only 3 types: final, transfer and normal.  2 rectangles and a circle.  What could be easier?  Painstakingly arrange them on the canvas, and some more and turn. <br><br><div class="spoiler">  <b class="spoiler_title">1 tip</b> <div class="spoiler_text">  Save the scheme as a picture, set a low transparency and place it under our svg-canvas, which set the same size.  This will simplify the placement of stations. </div></div><br><div class="spoiler">  <b class="spoiler_title">We get something like this</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/ff4/7fc/5c2/ff47fc5c23a545979cf1aac2e6ef23f7.png"><br></div></div><br>  In order to move forward comfortably, I also added their index (numeric) and line to the properties of the stations - just below you will understand what this is done for. <br><br><div class="spoiler">  <b class="spoiler_title">2 advice</b> <div class="spoiler_text">  If you are doing something more than proof of concept, take a few hours to write an editor with the ability to drag and drop stations and specify their properties.  To service your card will be much easier.  Expediency is directly proportional to the number of stations and their properties. <br></div></div><br><h4>  Lines </h4><br>  What is the line?  This is a set of segments between stations.  We have coordinates, indices and station lines - which means we can easily draw segments.  Let's go through the stations and we will be guided by the following logic for each of them: if there is a station of the same line, but with an index higher by one, then draw a segment between them. <br><br>  Take a look at the <a href="http://img.artlebedev.ru/everything/metro/map2/vector/moscow-metro-map-ru-2.1.2.pdf">diagram</a> and try to answer, what 2 segments will not be drawn? <br><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text">  1. segment on the annular, connecting the "junior" and "senior" on the station index <br>  2. The segment between the "Exhibition" and "Kiev" <br></div></div><br>  As we shall see, the beginning and end of the segment do not go exactly as we need.  For each of the 3 types of stations, we add an offset calculated experimentally.  Also, our segments are set straight, but the lines themselves are many where fancifully curved.  Perhaps this is the most painstaking part of the work on the project, for a number of segments we will add an exception in behavior.  Fortunately, the syntax is <a href="https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths">simple</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Here is our intermediate option.</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e5f/3b4/e7d/e5f3b4e7d80f4c688729bdf986d1c97f.png"><br></div></div><br><h4>  Transitions </h4><br>  Svg graphics use the layer model, which means that in order to get the desired result, we will make each transition using two curves: a colored one with a thick lower stroke and a white one with a thin one.  The total arrangement of the elements is the following, from the lower to the upper: lines, segments of transitions with a color thick outline, stations, segments of transitions with a thin white outline, the substrate of the names of stations, the names of stations. <br><br><h4>  Station names and substrate </h4><br>  Display the names and align the text using the <i>text-anchor</i> property.  Unfortunately, there is no way to carry out a line break, except by creating an additional element. <br><br>  Substrate text will make the usual translucent rectangle.  We will get the sizes and coordinates of the text using <a href="https://msdn.microsoft.com/en-us/library/ff972173%2528v%3Dvs.85%2529.aspx">getBBox</a> . <br><br><div class="spoiler">  <b class="spoiler_title">3 advice</b> <div class="spoiler_text">  After spending some time looking for a more elegant solution to the underlay of text, on stackoverflow, you will find the suggestion to use a filter.  I advise you to use this solution only in the case of a single display of graphics.  If further manipulations with graphics are assumed, the filter will behave incorrectly. <br></div></div><br><h2>  Repaint </h2><br>  I chose the default colors for stations as their line colors.  But what if we want to repaint everything on an arbitrary gradient?  It is not as difficult as it may seem. <br><br>  We have an arbitrary gradient from one color to another, which for convenience we take in the channels, the station value (for example, a depth of 23 meters) and the maximum and minimum possible values ‚Äã‚Äã(0 for ground stations and 80 for the deepest Victory Park).  Calculate the percentage of the station value to the difference of extreme values ‚Äã‚Äãand the resulting ratio is applicable to the difference of values ‚Äã‚Äãfor each channel.  Here it is our color. <br><br>  The rest of the elements on the page will be painted with a gradient, we have the coordinates and colors of the stations - and that‚Äôs all you need. <br><br><h2>  We filter </h2><br>  Here, too, scary.  Check if the station value is in the selected range and hide the station if not.  When we examine the stations, we will understand what to do with the other elements: if the station is hidden, neither the name, nor the transition to it, nor the segment of the branch should be displayed. <br><br><div class="spoiler">  <b class="spoiler_title">4 advice</b> <div class="spoiler_text">  Use the visibility property, since the opacity, although hiding elements, will leave them selectable and clickable. </div></div><br>  We also see that some stations have the same name.  Accordingly, you only need to hide the name when the last of the stations associated with this name is hidden. <br><br>  It remains to configure the range slider you like.  For some reason, I wrote mine.  <s>Lazy</s> adequate people advise, for example, <a href="http://refreshless.com/nouislider/">this</a> . <br><br><h2>  Scale and move </h2><br>  The <i>viewBox</i> property will take responsibility for this.  The guys from Microsoft wrote an <a href="https://msdn.microsoft.com/ru-ru/library/gg589508%2528v%3Dvs.85%2529.aspx">excellent article</a> with examples.  To intercept scrolling, I used <i>jQuery Mousewheel</i> .  Admittedly, this is not the most trivial task, since when changing the scale, it is necessary to take into account a shift relative to the initial position with a coefficient corresponding to the zoom. <br><br><h2>  Almost all </h2><br>  I used a <a href="http://largescalejs.ru/">modular architecture</a> <i>(about a dozen or so modules came out)</i> , took <a href="http://snapsvg.io/">Snap.svg</a> to help.  The data was loaded dynamically, miscalculated and, since some of the things were done using <a href="http://habrahabr.ru/post/209662/">promises</a> <i>(I used jquery, so I took them from there)</i> , I was even able to add some simple progress to the bar while everything is <a href="http://metrostat.ru/old">loading</a> . <br><br>  The joy lasted until I decided to log in from the phone ... On a very intelligent lumia 1020, the service loaded longer than half a minute.  I absolutely forgot about the price of manipulations with dom.  We have, for a second, more than a thousand items!  Yes, and the manipulations with the viewBox on the mobile device did not work normally. <br><br><h2>  Fix bugs </h2><br><h4>  From client to server </h4><br>  By a willful decision, we transfer the logic to the server and cache the issue so as not to count each time.  Now you can abandon Snap.svg on the client! <br><br><div class="spoiler">  <b class="spoiler_title">Oh no</b> <div class="spoiler_text">  The self-written gradient generator for svg weighed nothing at all and was elegant, but sometimes it did not work: none of the gradients were applied to some elements, only the color.  At the same time, gradients worked with other elements absolutely normal.  Tired of the "black magic" I returned the library to the ranks.  Still, I'm writing a proof of performance, not a ‚Äúproduct.‚Äù <br></div></div><br>  It is necessary to close the issue with scaling and the ability to move on mobile.  Think about how you would handle it. <br><br><div class="spoiler">  <b class="spoiler_title">I did so</b> <div class="spoiler_text">  I started by searching for libraries (I stopped at <a href="http://hammerjs.github.io/">hammer.js</a> ) and even got acquainted with the documentation, but I remembered about TRIZ.  Heinrich Altshuller defines an ideal object as an object that does not exist, and its function is performed. <br><br>  We already have great support for scaling and panning on wearable devices.  So ... Yes, I just cut down for phones and tablets manipulation with the viewBox-property. <br></div></div><br>  What brought the transfer in numbers? <br><br><div class="spoiler">  <b class="spoiler_title">Before</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/b04/a83/326/b04a833263fd4ae7b936ab4e4f6a1688.jpg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">After</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/174/6b6/f17/1746b6f17dd1480f8c8b2a6c7f18238d.jpg"><br></div></div><br><h2>  findings </h2><br><h4>  Problems with ‚ÄúMozilla Firefox‚Äù </h4><br>  In the process, it turned out that Mozilla Firefox was re-optimized.  While other guys regularly display all the graphics, ‚ÄúMozilla‚Äù allows you to skip the render of elements, if the element is not visible to the user - it is closed by a div from the top or just outside the view area of ‚Äã‚Äãthe monitor.  As a conscious citizen, I added a bug, which is still unconfirmed, because I cannot satisfy the request to provide <i>the simplest possible testcase</i> , everything works fine on a small number of elements, and the link to the project is probably not enough. <br><br>  If a representative of ‚ÄúMozilla‚Äù reads this: Guys, it works crookedly regardless of the platform <i>(windows / mac)</i> and version <i>(it is also observed in older versions)</i> , as a matter of fact. <br><br><h4>  As a conclusion </h4><br>  Despite the fact that some dampness has remained in html5, it's time to use it.  No need to load the processors of users, adding to every second site "fashionable" effects, which yesterday were in the mailing list for frontend-developers. <br><br>  But it's time to make convenient transportation schemes and interactive products accessible from any device. <br><br>  I do not understand why the same Yandex will not transfer J. Metro to a new official scheme that will work everywhere;  Mobile users prefer to show links to applications.  Stores <i>(applications)</i> are full of customers for social networks and large sites and, in my opinion, there is something wrong in this. <br><br><h3>  UPD </h3><br>  Work on each project involves somewhat idealized expectations, the reality is sobering. <br>  I thought it necessary to bring here a few points: <br>  1. Thanks for the feedback and the first donation on my practice.  For the authors <i>(me in particular),</i> this is really important. <br>  2. In the existing independent form the project will not be updated. <br>  <i>I made many mistakes and agree with a number of improvements that can be made.</i>  <i>Their implementation would force to abandon what I'm working on now, and the ongoing development of the metro would make the process endless.</i> <br>  3. I will try to answer implementation questions or provide existing information, if needed.  Ask in the comments. </div><p>Source: <a href="https://habr.com/ru/post/270293/">https://habr.com/ru/post/270293/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270281/index.html">Captain Awesome is broadcasting: BrowserSync Angular Template</a></li>
<li><a href="../270283/index.html">Internal Adobe Flash Player Update Server</a></li>
<li><a href="../270287/index.html">GDG DevFest Nizhny Novgorod 2015</a></li>
<li><a href="../270289/index.html">Java Gauss Method</a></li>
<li><a href="../270291/index.html">About Swift, and why my big projects will be on Objective-C for some (maybe long) time</a></li>
<li><a href="../270295/index.html">Security Week 45: escape from the sandbox, bypassing EMET through WOW64, breaking into 000webhost</a></li>
<li><a href="../270297/index.html">DDoS from an unexpected direction or ‚Äúare PS bots afraid?‚Äù</a></li>
<li><a href="../270299/index.html">Workflow automation for a small development team (Part 1)</a></li>
<li><a href="../270301/index.html">Grow Big: Simple Tips for New Business Application Makers</a></li>
<li><a href="../270307/index.html">A cryptographic program encrypts user files offline.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>