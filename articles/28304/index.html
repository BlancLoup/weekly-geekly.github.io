<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Viral steganography</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For a start - a couple of introductory remarks. First note: in connection with the darned right hand, it is inconvenient for me to type, therefore typ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Viral steganography</h1><div class="post__text post__text-html js-mediator-article">  For a start - a couple of introductory remarks.  First note: in connection with the darned right hand, it is inconvenient for me to type, therefore typos can be.  Second note: for someone, everything that is written below may not be new, but what can we do about it!  But the rest, I hope, will be interesting.  Go! <br><br>  Many users consider firewalls and traffic filters as reliable protection against viruses.  In general, these tools can be configured to significantly complicate the life of viruses, but this will be a rather difficult problem.  About a couple of moments that I have to face and tell you.  Under the cut, as always, a lot of technical details, code and sometimes disjointed thoughts. <br><a name="habracut"></a><br>  At the showdown - Trojan.DownLoad.921 in our DrWeb terminology. <br><br>  The file is 20992 bytes in size, packed with UPX.  It is a DLL with two exported functions: ClearAV and DoWork.  Written, according to information from PEiD, on VC version 6. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Foot print</b> <br>  An interesting feature of the Trojan in the code located at the beginning of some functions: <br>  .text: 10004490 <br>  .text: 10004490;  BOOL __stdcall DllMain (HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) <br>  .text: 10004490 _DllMain @ 12:;  CODE XREF: DllEntryPoint + 4Bp <br>  .text: 10004490 push ebp <br>  .text: 10004491 mov ebp, esp <br>  .text: 10004493 sub esp, 108h <br>  .text: 10004499 push esi <br>  .text: 1000449A push edi <br>  .text: 1000449B nop <br>  .text: 1000449C nop <br>  .text: 1000449D clc <br>  .text: 1000449E jnb short near ptr loc_100044A0 + 1 <br>  .text: 100044A0 <br>  .text: 100044A0 loc_100044A0:;  CODE XREF: .text: 1000449Ej <br>  .text: 100044A0 call near ptr loc_1000468C + 1 <br>  .text: 100044A5 add cl, ch <br>  .text: 100044A7 pop edx <br><br><br>  Or in a more understandable way: <br>  .text: 10004490 <br>  .text: 10004490;  BOOL __stdcall DllMain (HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) <br>  .text: 10004490 _DllMain @ 12:;  CODE XREF: DllEntryPoint + 4Bp <br>  .text: 10004490 push ebp <br>  .text: 10004491 mov ebp, esp <br>  .text: 10004493 sub esp, 108h <br>  .text: 10004499 push esi <br>  .text: 1000449A push edi <br>  .text: 1000449B nop <br>  .text: 1000449C nop <br>  .text: 1000449D clc <br>  .text: 1000449E jnb short loc_100044A1 <br>  .text: 1000449E;  - .text: 100044A0 db 0E8h;  sh <br>  .text: 100044A1;  - .text: 100044A1 <br>  .text: 100044A1 loc_100044A1:;  CODE XREF: .text: 1000449Ej <br>  .text: 100044A1 call loc_100044A7 <br>  .text: 100044A1;  - .text: 100044A6 db 0E9h;  u <br>  .text: 100044A7;  - .text: 100044A7 <br>  .text: 100044A7 loc_100044A7:;  CODE XREF: .text: loc_100044A1j <br>  .text: 100044A7 pop edx <br><br><br>  The conditional transition (in this case to the address 1000449E) is always performed, that is, instead of call we have jnb + call.  Quite a characteristic "fingerprint", which, I think, serves to complicate the analysis.  But IDA makes it easy to work with such code. <br><br>  <b>The victims</b> <br>  After executing the startup code, the trojan checks which process has loaded it.  Only processes with the names flashget.exe, Thunder.exe, QQMusic.exe, QQLive.exe, QQDownload.exe, svchost.exe, explorer.exe will satisfy the Trojan.  By program names, it is clear that the Trojan is aimed primarily at Chinese users.  If the loaded DLL application satisfies the Trojan, then a new application thread containing the payload is created.  Further actions are performed in the new thread. <br><br>  <b>Payload</b> <br>  The Trojan's active activity begins with the decryption of the URL (it did not understand the decryption algorithm) and the download of the file from the <a href="">server.com/logo1.gif</a> address to the file named package.tmp in the current user's temporary directory.  The download file is indeed a gif image, but when you view it in Hiew, you can see the EXE file inside!  There is steganography - the concealment of the fact of the transfer of something extra.  An attempt to download a file (like all other downloadable files) is made 5 times with a pause of 20 seconds.  In the downloaded file, the last 4 bytes is the offset of the "Trojan" information from the beginning of the file, which includes the length of the EXE file.  Extracts the embedded file to the current user's temporary directory.  After successfully extracting the file, DeleteUrlCacheEntry is called, I think, to hide the fact that the file was being loaded.  The <a href="">server.com/logo2.gif</a> , <a href="">server.com/logo3.gif</a> and <a href="">server.com/logo4.gif</a> files are downloaded in the same way.  The total volume is about 860 KB! <br>  After the files are downloaded, a completely incomprehensible operation is performed: the MAC address of the network card is obtained and compared with 2 hard-wired addresses.  And the whole address is compared, not just the manufacturer.  And the addresses of non-VMWare cards are sewn.  The only logical thought is to protect the authors from their brainchild.  Obtaining the MAC address is done in a brutal way - through a call to ipconfig / all with parsing the answer!  Be that as it may, even if the MAC addresses match, the trojan will not complete the work, it will just skip a piece of code. <br>  If the MAC addresses do not match, a window search is performed.  Apparently, the QQ2006 window is being searched for - the Chinese equivalent of ICQ.  True, the search is conducted on the full title (including the build number), which is probably the authors' mistake.  If a window is found, control is transferred to the same code as when MAC addresses are matched.  Otherwise, it downloads and saves the file <a href="">server2.cn/logo.gif</a> (the process is similar to the one described above). <br>  After that, an attempt is made to launch the fragments extracted from the GIF-files, the file extracted from the <a href="">server2.cn/logo.gif</a> does not start.  The success of the launch is not checked, but if it fails there will be quite a lot of attempts. <br><br>  <b>Virus upgrade</b> <br>  Then the <a href="">server.com/xin/version.gif</a> file is loaded, which is an ini-file.  It contains the version number that is read and compared with the version of the Trojan that is hard-wired in its body.  If the INI file is successfully loaded and the version is larger than that of the Trojan, the <a href="">server.com/xin/update.gif</a> file will be loaded (and this is already a normal EXE file). <br>  At the end of the work, a call is made to the MAYASYS device.  Presumably, the file downloaded in the update procedure is directly related to this device. <br><br>  <b>Other functions</b> <br>  ClearAV supposedly hides some processes, while simultaneously interacting with the MAYASYS device (which I, of course, haven‚Äôt had in the system).  Which processes should be hidden is not clear, because the Trojan was not launched in the conditions for which it was designed. <br>  Further actions of the function are clear from its name: it kills working antiviruses: Casper, Rising Personal FireWall, Symantec (it seems) and still completely incomprehensible antivirus (and maybe a virus :-). <br>  The DoWork function calls ClearAV, and then produces an Inject into the explorer.exe process. <br><br>  <b>Confronting firewalls</b> <br>  The most obvious way to protect against Trojans - a ban on the transfer of data to all applications, except for the clearly specified.  But here it does not work: the Trojan is a DLL and is designed to be loaded from svchost and explorer.  And if the ban on network activity for explorer is still possible to understand, then svchost to prohibit is a bad thing.  It is the turn of filtering by ports: the trojan wants the 80th, and svchost can usually do without it.  There is still QQ, which can also load the trojan into memory.  I don‚Äôt know the features of network operation of this software, but I‚Äôm boldly suppose that it uses port 80.  Oppa, arrived: a ban on the port and the application is no longer put.  And if you look at the requested files, everything will be pretty harmless - gif-pictures.  You need content filtering, and even that is not easy.  In a simple way, the filter is bypassed, as required.  More serious ways to circumvent the filters are described in one of the articles by Chris Kaspersky.  Strongly, by the way, I recommend reading all the articles of his authorship ;-) <br><br>  <b>Conclusion</b> <br>  The Trojan, which is part of a malware complex, got into the analysis.  In my opinion, it should include at least the device driver MAYASYS and the dropper, which dumps the analyzed DLL onto the disk and writes it into the system.  In the future, it was the driver and dropper were found.  In a rather simple and unsophisticated way, the Trojan bypasses firewalls that can protect it from far from any infection. <br>  Unclear points: is the ClearAV function really a rootkit?  Why are MAC addresses checked?  What window is looking for a trojan?  Why download files that never run? </div><p>Source: <a href="https://habr.com/ru/post/28304/">https://habr.com/ru/post/28304/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283028/index.html">Squid's serious proxy vulnerability can ‚Äúpoison cache‚Äù</a></li>
<li><a href="../28303/index.html">CodeIgniter 1.6.3</a></li>
<li><a href="../283030/index.html">Once again on minimizing boolean functions</a></li>
<li><a href="../283036/index.html">Means of data collection in computer technical expertise</a></li>
<li><a href="../283038/index.html">Performance without event loop</a></li>
<li><a href="../283042/index.html">Towards Full Typing with TypeScript, Swashbuckle, and AutoRest</a></li>
<li><a href="../283044/index.html">How data centers are changing right now: Energy efficiency, data storage and the "clouds"</a></li>
<li><a href="../283046/index.html">Explanation of limitations of the demo version of PVS-Studio</a></li>
<li><a href="../28305/index.html">Received a letter from Bill today - asking to open access to the search bot</a></li>
<li><a href="../283050/index.html">Creating RESTful services on Meteor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>