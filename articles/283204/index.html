<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We build a pre-built dylib into the application.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before the beginning of the May holidays, I spent 5 hard days writing an application for iOS and Mac for the contest. The development went smoothly, b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We build a pre-built dylib into the application.</h1><div class="post__text post__text-html js-mediator-article"><p>  Before the beginning of the May holidays, I spent 5 hard days writing an application for iOS and Mac for the contest.  The development went smoothly, by the last day the work of the application began to satisfy me more or less.  I decided to postpone the departure on the morning of the very last day in order to do this with a fresh head (there still had to be attached a text description).  In the morning, a few hours before the train was on vacation, I sat down and with a calm soul made the final run-in of the main functionality.  And then it seemed to me a good idea to potest how the application will behave on a completely different machine, on which the development was not conducted.  I archive my application, transfer it to another Mac and ... it does not start.  With the super-informative error "Image not found" and by clearly indicating a dylib problem.  So: 3 hours before the train and the application not starting for no apparent reason.  Why it happened, how it could have been avoided and how I dealt with this problem - about all this under the cut. <a name="habracut"></a></p><br><p> I quickly figured out the essence of the problem, but its solution took some time.  Let's still make out what happened.  OpenCV was used in my application.  I collected it from the original sources with the default configuration straight from the official site using CMake.  After that, I pointed out the Search Path couple in Xcode and the development advanced, as they say, seamless.  As you probably already understood, the problem was that on the working machine, my application used libraries that were located at <code>/usr/local/lib/</code> . </p><br><p>  This path was specified for search in Xcode, and since  I linked them with the application, I mistakenly thought that all the necessary libraries to pull up during archiving, now I know that this is not so.  The first thought that came to me then: make the installer.  In principle, this is a working solution, and many people do just that.  However, this was not the time, because  in addition to the time spent on developing the installer itself, it took more testing, etc., and the train drove off in a couple of hours. </p><br><p>  I started to google this problem and realized that I need to throw dylib into the application itself.  Without thinking twice, I threw them into the XCode project, added linkage, archived ... on the working machine everything is OK, on ‚Äã‚Äãthe third-party - the same mistake.  The problem was in dylib installing and searching for dependencies.  In my case it was monstrous </p><br><pre> <code class="hljs">/Users/s1ddok/Downloads/opencv-3.1.0/build/lib/libopencv_core.3.1.dylib</code> </pre> <br><p>  This is because I added dylib intermediate from the build folder to the project, these are the ones that are later installed with the command <code>make install</code> , but even if I took them from <code>/usr/local/lib/</code> , this did not solve the problem. </p><br><p>  How could this problem be avoided?  Specify the required installation paths at once during dylib compilation.  If you are compiling your libraries, most likely you have already installed everything correctly, but if not, this is easy to do in XCode.  Specifically, in the case of OpenCV, it was necessary only to change the default configuration of CMake and add the installation dir prefix there, but I did not have the opportunity to do this at that time. </p><br><p>  So, I needed to somehow change the install path in the ready-made dylib so that they run.  I will omit the detailed descriptions of how I came to the result, just tell you what worked in the end. </p><br><p>  First of all, we need our dylibs, which we added to the project, to be copied to the bundle with our application.  In principle, no matter where, you can even shove them in the main bundle, but copying to the Frameworks folder seems logical.  To do this, go to Xcode -&gt; Target Settings -&gt; Build Phases and add a new phase of Copy Files.  My application uses only 2 libraries from the OpenCV set, so for me it looks like this: </p><br><p><img src="https://i.gyazo.com/ef20b886a5e5b5bbe321426e370171ca.png" alt="image"></p><br><p>  Ok, now inside our application all necessary dylib are stored, however it falls out with the same error, because the paths in them are still old.  We come to the aid of utilities such as <code>otool</code> and <code>install_name_tool</code> .  The first was needed in order to find out which install path is ‚Äúprotected‚Äù in existing libraries, and the second in order to change them.  Add a new build phase to Xcode, this time <code>Run Script</code> .  The script itself turned out like this: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#         install_name_tool -change lib/libopencv_core.3.1.dylib @executable_path/../Frameworks/libopencv_core.3.1.0.dylib $BUILT_PRODUCTS_DIR/$EXECUTABLE_PATH install_name_tool -change lib/libopencv_imgproc.3.1.dylib @executable_path/../Frameworks/libopencv_imgproc.3.1.0.dylib $BUILT_PRODUCTS_DIR/$EXECUTABLE_PATH #    Frameworks    cd $BUILT_PRODUCTS_DIR cd MyApp.app cd Contents cd Frameworks #        install_name_tool -id @executable_path/../Frameworks/libopencv_core.3.1.0.dylib libopencv_core.3.1.0.dylib install_name_tool -id @executable_path/../Frameworks/libopencv_imgproc.3.1.0.dylib libopencv_imgproc.3.1.0.dylib #    ,  ,     . # otool -L libopencv_imgproc.3.1.0.dylib #       opencv-core     ,    install_name_tool -change /Users/s1ddok/Downloads/opencv-3.1.0/build/lib/libopencv_core.3.1.dylib @executable_path/../Frameworks/libopencv_core.3.1.0.dylib libopencv_imgproc.3.1.0.dylib</span></span></code> </pre> <br><p>  This, of course, is a terrible decision and the script will have to be redone for each library, it is not universal.  At that time, I did not have time to develop a generic solution. </p><br><p>  I hope my experience will be useful to someone, I dealt with all of this in a very nervous and tense environment, so I am doubly pleased that the application did start up and I was able to successfully send it, although I had to write an essay in 20 minutes without checking, but this little things. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/283204/">https://habr.com/ru/post/283204/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283192/index.html">IT in modern architectural and interior lighting: different engineering buns</a></li>
<li><a href="../283194/index.html">Azure-IaaS-Digest number 6 (April-May)</a></li>
<li><a href="../283196/index.html">We present data and code in order: data and markup, part 2</a></li>
<li><a href="../283198/index.html">About the 1C: Enterprise Mobile Platform</a></li>
<li><a href="../283202/index.html">Laboratory: Rust - let's talk about Rust in Kaspersky Lab on May 17</a></li>
<li><a href="../283208/index.html">Using Matalysis in computer games (part 3)</a></li>
<li><a href="../283210/index.html">We are looking for vulnerabilities using google</a></li>
<li><a href="../283212/index.html">Big Data from A to Z. Part 5.1: Hive - SQL engine over MapReduce</a></li>
<li><a href="../283214/index.html">AngularJS and Ruby on Rails Single Page Application Building Architecture</a></li>
<li><a href="../283216/index.html">The law ‚ÄúOn Personal Data‚Äù and the practice of its application in Russian reality. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>