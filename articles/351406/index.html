<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arrays, pointers and other quantum phenomena around us</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I do not want to say that we all live in a matrix, but to imitate neighbors the same sound of a rolling ball is suspiciously used. 


 This post is fu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arrays, pointers and other quantum phenomena around us</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>I do not want to say that we all live in a matrix, but to imitate neighbors the same sound of a rolling ball is suspiciously used.</i> </blockquote><br><img src="https://habrastorage.org/webt/ug/vu/f6/ugvuf6wyxqtledryrp6xwmaudso.jpeg"><br><br>  This post is fully consistent with its name.  For a start, it will show that, contrary to the statement of the standard, as well as the classics of the Kernighan C language, the use of array indices is absolutely not equivalent to the use of corresponding pointers, and the choice of an epigraph will be clear at the very end.  And yes - the middle of the post is also not empty. <br><a name="habracut"></a><br>  It all started <s>with the refutation of Fermat's theorem and finding a number with a cosine exceeding one</s> from a highly thoughtful post about the indefinite behavior of the compiler (undefined behavior or UB).  That is, there were several such posts, but in <a href="https://blogs.msdn.microsoft.com/oldnewthing/20140627-00/%3Fp%3D633/">this</a> ( <a href="https://habrahabr.ru/post/229963/">translation to habrahabr</a> ) the following simplest code was cited and the far from obvious result of his work: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> table[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists_in_table</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= <span class="hljs-number"><span class="hljs-number">4</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (table[i] == v) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  There is an error in the loop condition: "&lt;= 4" instead of "&lt;4". <br>  Now, if we fill the <i>table with</i> zeros, and even make sure that the illegal fifth element of this array is 0, and then look at the table for a good number of 42, that is,  call <i>exists_in_table (42)</i> , then it will definitely be there - in the case of a well-optimized C compiler, this function will return true in full accordance with the language standard! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The explanation is simple: <i>exists_in_table ()</i> must either return <i>true</i> on one of the first four iterations, or it will read the <i>table [4]</i> , which is UB, and in this case, <i>exists_in_table ()</i> can do anything, according to the C standard. and return <i>true</i> .  That is, the compiler can optimize the whole <i>exists_in_table ()</i> code to <i>return true;</i> <br><br>  And this is not an abstract theory, but a concrete practice.  This is how code optimizes, i.e.  <i>exists_in_table (42)</i> returns <i>true</i> when compiling, for example, gcc 6.3 (via MinGW) using the -O2 or -O3 options.  All results below are specific to this configuration. <br><br>  And now let's <s>at least once in life</s> once again read the standard C. <br>  Yes, in the section on arrays, he honestly warns that access to elements outside the array is UB.  But, as everyone who has ever studied C knows, access to array elements is possible through pointers, or, in the language of ISO / IEC 9899, ‚Äã‚Äãthe definition of the index operator [] is as follows: E1 [E2] is equivalent to (* ((E1) + (E2))). ‚Äù(‚Äú The definition of the subscript operator [] is that E1 [E2] is identical to (* ((E1) + (E2)) ‚Äù). <br><br>  And here something interesting is revealed.  ‚ÄúIdentical‚Äù - that is, identically, interchangeably under any circumstances.  And even with UB?  Let's see what happens if in the example above, use pointers to access array elements. <br>  But first, we will make the code really safe, for which we wrap the table array into a structure so that the space allocated by us is guaranteed next to it, and going beyond the border of the array did not interfere with anyone, but on the contrary, it helped - for example, at the same time checking the contents of the neighboring array in one cycle . <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">taddummy</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> table[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dummy[<span class="hljs-number"><span class="hljs-number">4</span></span>]; } tadam; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists_in_table</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tadam.table[i] == v) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { tadam.table[i] =<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d\n"</span></span>,exists_in_table(<span class="hljs-number"><span class="hljs-number">42</span></span>)); }</code> </pre><br>  You can believe or check that this code also returns <i>true</i> - from the point of view of UB, nothing has changed in it. <br><br>  And now, in accordance with the standard, replace <i>tadam.table [i]</i> with <i>* (tadam.table + i)</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists_in_table</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*(tadam.table+i) == v) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { *(tadam.table+i)=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d\n"</span></span>,exists_in_table(<span class="hljs-number"><span class="hljs-number">42</span></span>)); }</code> </pre><br>  Run the program and make sure that the <i>exists_in_table</i> now returns 0, that is, the number 42 in our arrays and the truth is not.  In fact, everything is not as it actually is. <br><br>  And this is simply explained - according to the C standard, the use and dereference of pointers also has its own UB cases - reference to reallocated memory, dereferencing of the null pointer, etc. and etc. ... but there is no such thing as an "out of array" and there can be no - pointers they know nothing about arrays, so they behave in quite the expected way. <br><br>  That is, contrary to a common misconception, the array index and the corresponding pointer for the compiler are not the same thing, it is more like an electron, which sometimes displays the properties of a particle (within the array boundaries), and sometimes - waves (in the UB region). ). <br><br>  Moreover, this analogy can be further developed: if we are surprised at the presence of 42 in the array, we ask the <i>exists_in_table</i> to indicate a specific element number with a value of 42, changing its code to <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (table[i] == v) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i;</code> </pre> <br>  or, leaving this line unchanged, simply insert the output of the corresponding <i>table [i]</i> element in front of it, then, with the array remaining outside the array, the UB effect completely disappears - the function returns false, which is absolutely equivalent to having an observer in the experiment with electrons - there are no waves in his presence, only hardcore, only particles. <br><br>  Now, if we move to a higher <s>energy</s> level - to distract from arrays and pointers and even UB, and look at the behavior of the compiler as a whole, then this effect will continue. <br><br>  For example, part of my work at Intel is to optimize the performance of critical components in third-party code.  Since this code is a commercial secret, usually <s>after the completion of the project</s> I get <s>killed,</s> I get only a function from several dozens of lines from them, which is proposed to be accelerated.  And, since usually the function itself works for such an insignificant length of time that no profiler will show it with sufficient accuracy, and it is simply a ‚Äúbottleneck‚Äù in the code because of millions of its calls, to evaluate the optimization result I have to use something like <br><br><pre> <code class="cpp hljs"> i1 = __rdtsc(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">100000</span></span>;i++) { performance_test(); } i2 = __rdtsc();</code> </pre> <br>  But it is ‚Äúsomething like‚Äù, and not this particular code.  If we use an optimizing compiler for the code fragment above, then it will simply reduce the entire cycle to a single iteration, throwing out all the others, and the execution time will be far from what was expected.  To honestly complete the whole cycle, we have to bring something out, or just refer to the volatile variable, which is also a form of interaction with the outside world: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> res = performance_test();<span class="hljs-comment"><span class="hljs-comment">//  .</span></span></code> </pre> <br>  That is, in the person of the optimizing compiler, we have a system that behaves according to strange, counterintuitive laws (but laws!), For which only external manifestations are important, and the internal state can be considered anything, even indefinite, and most importantly - for any attempt to observe internal state, the magic disappears and the system begins to behave dull and predictable, as in the textbook. <br><br><img src="https://habrastorage.org/webt/hh/fo/sb/hhfosbjfpwwgpozoejtqh6olmzc.jpeg"><br><br>  But this is the quantum mechanics from the word "absolutely" - from Schr√∂dinger's cat (number 42), which we are looking for going beyond the array, and have not yet looked inwards, then we can assume that everything is there, to any tangled particles and quantum teleportation (for example, <a href="https://habrahabr.ru/company/infopulse/blog/338812/">invoking a callback function</a> ).  And finally, the emergence of a quantum mechanical ‚Äúobserver,‚Äù that is, situations when code interacts with something (external), the behavior of which is unknown to the optimizer, decoherence occurs, and the system collapses into classical - deep optimization of this place, which means ‚Äú magic "becomes impossible. <br><br>  It was this couple of previous paragraphs that he began to tell me at the meeting. <img src="https://habrastorage.org/webt/tx/ze/nt/txzentb_lrbp3x_difj_q_yvn8q.png">  <a href="http://dibr.livejournal.com/"><b>dibr</b></a> .  Dima connects us with a <a href="http://www.vshopf.unn.ru/">stormy youth</a> , so I immediately tried to interrupt him, saying that I knew - also completely independently and repeatedly thought about it.  But stopping Dima is not so easy, and sometimes it's very cool. <br><br>  So, continued <img src="https://habrastorage.org/webt/tx/ze/nt/txzentb_lrbp3x_difj_q_yvn8q.png">  <a href="http://dibr.livejournal.com/"><b>dibr</b></a> , - ‚Äúthis means that quantum mechanics in our universe was possible only because of our world‚Äù ....  And then I came to the end of the phrase, which I repeated with him in chorus - ‚Äúit was assembled with deep optimization.  That is, we live in the final release, not in the debug version! ‚Äù <br><br>  Which, on the one hand, of course, pleases - although the behavior of the debug version is completely predictable, but in it, in the process of work, usually there are an order of magnitude more bugs.  But, on the other hand, it is puzzling: firstly, optimization is needed where iron resources are sufficiently abutting without a reserve, and our future, given the possible development of civilization, is very vague.  And secondly, it turns out that according to the documentation of the development of the Universe it was assumed that only classical mechanics would be available to us - that is, nothing more than arithmometers, and the current rapid development of electronics in general and computers in particular is due to the fact that we discovered internal features Universe ‚Äùassociated with deep optimization, were able to understand their system, and create, in fact, exploits that use them to our advantage. <br><br>  In this concept, it becomes clear why quantum mechanics is so unobvious and "inhuman" - it should not be like that, because it is a "hack" of the insides of the universe not intended for our eyes, and the standard interface to the world is classical mechanics, in which everything is simple and is logical. <br><br>  And, in conclusion, I will quote Dmitry again: ‚ÄúAnd now the Developer of the Universe, probably, is sitting at the terminal, in a stupor from what is happening (he was expecting a sluggishly developing civilization with classical physics, and not this explosive development and‚Äú hacking of the universe ‚Äù) , but the process does not interrupt: first, a lot of counting resources have already been invested, it‚Äôs a pity to throw out, and secondly, the development branch is interesting, you can watch, you see, a nontrivial result for an article on universe science will turn out, again - when you compile the next universe it will be clear what  to avoid." </div><p>Source: <a href="https://habr.com/ru/post/351406/">https://habr.com/ru/post/351406/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351396/index.html">Online flower shop, or how we screwed up on Valentine's Day</a></li>
<li><a href="../351398/index.html">Rewrite the application under Blockchain</a></li>
<li><a href="../351400/index.html">About probabilities</a></li>
<li><a href="../351402/index.html">Installing the Linux + server (Nginx + Apache) + PostgreSQL + PHP on VirtualBox (Ubuntu Server 16.04.3 LTS)</a></li>
<li><a href="../351404/index.html">Richard Hamming: Chapter 6. Artificial Intelligence - 1</a></li>
<li><a href="../351408/index.html">FastTrack Training. "Network Basics". "Collaboration Software from Cisco." Eddie Martin December 2012</a></li>
<li><a href="../351410/index.html">A small library for the use of AI in Telegram chat bots</a></li>
<li><a href="../351412/index.html">Logging in Adaptivist ScriptRunner</a></li>
<li><a href="../351414/index.html">Corporate IaaS digest: 25 materials on virtualization, infrastructure and information security</a></li>
<li><a href="../351416/index.html">TECO Editor: EMACS, I am your father</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>