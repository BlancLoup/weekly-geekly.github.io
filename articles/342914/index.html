<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using buildSrc to implement additional logic in Gradle</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An interesting note from Madis Pink in the ZeroTurnaround RebelLabs blog. If someone wakes you up in the middle of the night and asks: ‚Äúwhat feature i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using buildSrc to implement additional logic in Gradle</h1><div class="post__text post__text-html js-mediator-article"><p> An interesting note from Madis Pink in the <a href="https://zeroturnaround.com/rebellabs/using-buildsrc-for-custom-logic-in-gradle-builds/">ZeroTurnaround RebelLabs</a> blog.  If someone wakes you up in the middle of the night and asks: ‚Äúwhat feature in Gradle should everyone know?‚Äù - with confidence answer that it is <code>buildSrc</code> .  This is a special magic Gradle project inside your repository, available to all <code>build.gradle</code> files as a library. </p><br><p>  The approach described below allows you to write code in the JVM language that is convenient for you, and use the result directly in your build scripts.  As a bonus, you can cover unit tests with particularly tricky moments in these scripts.  Welcome under the cut! </p><a name="habracut"></a><br><h1 id="privet-mir--buildsrc">  Hello, <del>  world </del>  buildSrc! </h1><br><p>  Connect this feature is simple.  Create a directory called <code>buildSrc</code> in the project root (in the same directory where <code>settings.gradle</code> ): </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> buildSrc</code> </pre> <br><p>  Both the <code>java</code> plugin and the <code>groovy</code> plugin will be applied to this project at the same time.  Therefore, further we simply make the standard directory <code>src/main/java</code> and begin to add code there. </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> -p buildSrc/src/main/java</code> </pre> <br><p>  Now you can synchronize the project with the IDE and create a new Java class in the newly- <code>buildSrc</code> project: </p><br><pre> <code class="hljs cs">package myapp.gradle; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Fun</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sayHello</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(<span class="hljs-string"><span class="hljs-string">"Hello from buildSrc!"</span></span>); } }</code> </pre> <br><p>  The last step is left: call the <code>Fun.sayHello</code> method from some <code>build.gradle</code> file.  Let's do a simple <code>hello</code> task in the root project and look at the exhaust: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> myapp.gradle.Fun task hello { doLast { Fun.sayHello() } } $ ./gradlew hello &gt; Task :hello Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> buildSrc! BUILD SUCCESSFUL <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>s <span class="hljs-number"><span class="hljs-number">1</span></span> actionable task: <span class="hljs-number"><span class="hljs-number">1</span></span> executed</code> </pre> <br><p>  That's all.  The <code>sayHello</code> method is a regular Java method.  Because <code>build.gradle</code> works like a JVM application, you can call it from Groovy like any other Java method. </p><br><h1 id="pishem-svoi-sobstvennye-taski">  We write our own task </h1><br><p>  Reuse of the code is good, but all this garbage from <code>doLast {}</code> when creating a new task looks disgusting.  With the help of <code>buildSrc</code> we will be able to throw garbage away, creating a special task class instead.  Your Gradle Task is just a Java class that: </p><br><ul><li>  Inherited from <code>org.gradle.api.DefaultTask</code> </li><li>  It has a public method with the <code>@TaskAction</code> annotation.  This code is executed immediately after the launch of our task. </li></ul><br><p>  Let's refactor the <code>Fun.sayHello</code> method to a separate task: </p><br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> myapp.gradle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.gradle.api.<span class="hljs-type"><span class="hljs-type">DefaultTask</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.gradle.api.tasks.<span class="hljs-type"><span class="hljs-type">TaskAction</span></span>; public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultTask</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@TaskAction</span></span> public void run() { <span class="hljs-type"><span class="hljs-type">System</span></span>.out.println(<span class="hljs-string"><span class="hljs-string">"Hello from task "</span></span> + getPath() + <span class="hljs-string"><span class="hljs-string">"!"</span></span>); } }</code> </pre> <br><p>  It is easier to use this task from the Gradle scripts: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> myapp.gradle.HelloTask task hello(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: HelloTask) $ ./gradlew hello &gt; Task :hello Hello <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> task :hello! BUILD SUCCESSFUL <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>s <span class="hljs-number"><span class="hljs-number">1</span></span> actionable task: <span class="hljs-number"><span class="hljs-number">1</span></span> executed</code> </pre> <br><h1 id="prevraschaem-svoi-taski-v-polnocennye-plaginy">  We turn our task into full-fledged plugins </h1><br><p>  In a large project, you have to define dozens of tasks that are embedded in an intricate link graph.  In this case, it makes sense to create your own plugin.  This plugin should create all the necessary tasks and link them together. </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> myapp.gradle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.gradle.api.Plugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.gradle.api.Project; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyPlugin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plugin</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Project</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Project project)</span></span></span><span class="hljs-function"> </span></span>{ project.getTasks().create(<span class="hljs-string"><span class="hljs-string">"hello"</span></span>, HelloTask.class); } }</code> </pre> <br><p>  Now we can not use the task directly, but connect this special plugin directly to the build file: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">apply</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">plugin</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">myapp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gradle</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MyPlugin</span></span></code> </pre> <br><p>  And yes, it works! </p><br><pre> <code class="hljs ruby">$ ./gradlew hello &gt; Task <span class="hljs-symbol"><span class="hljs-symbol">:hello</span></span> Hello from task <span class="hljs-symbol"><span class="hljs-symbol">:hello!</span></span> BUILD SUCCESSFUL <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>s <span class="hljs-number"><span class="hljs-number">1</span></span> actionable <span class="hljs-symbol"><span class="hljs-symbol">task:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> executed</code> </pre> <br><p>  We now have a hand-written plugin that can be used in any of the subprojects.  Of course, the above example of printing text on the screen is an unimaginably small part of what can be arranged in your project with the help of handwritten plug-ins.  If you want to understand the plugins deeper, I highly recommend these reports with the <em>Gradle Summit 2017</em> : </p><br><ul><li>  <a href="https://www.youtube.com/watch%3Fv%3DwLHqAC0Ag4M">Designing and writing Gradle plugins by Benjamin Muschko</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DhxMhnOMbkbQ">Extending the Gradle Android Plugin by Eyal Lezmy</a> </li></ul><br><h1 id="bonus-dlya-dochitavshih-do-konca-upravlenie-zavisimostyami-s-pomoschyu-buildsrc">  Bonus for those who read to the end: dependency management with <code>buildSrc</code> </h1><br><p>  In the afternoon, the author of this note is a developer in the <a href="https://zeroturnaround.com/software/jrebel-for-android/">JRebel for Android</a> project.  This is a developer tool that consists of an IDE plugin, a Gradle plugin, an Android application, and a regular Java SE application.  To collect all these artifacts, there is a huge Gradle project consisting of 90+ subprojects.  All these subprojects have in many ways similar dependencies, for example, <code>commons-io</code> and <code>slf4j-api</code> .  If you have to collect <code>org.slf4j:slf4j-api:1.7.25</code> time after time, again and again, it quickly turns into a nudyatinu, according to the type of regular ordering at home.  The same is about the game of guessing the correct version of these dependencies. </p><br><p>  Usually, it is suggested to use the <code>ext {}</code> block directly in the project root to manage them.  An example is <a href="https://stackoverflow.com/questions/9547170/in-gradle-how-do-i-declare-common-dependencies-in-a-single-place">in this response to StackOverflow</a> .  The flip side of this approach is that the IDE will fall off auto-completion and code navigation. </p><br><p>  We went another way - we defined dependencies as string constants in the <code>Deps.java</code> file inside <code>buildSrc</code> .  Auto-completion and navigation work with this approach in IDE!  Let's see how it looks on the example of a small Android project: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> myapp.gradle; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Deps</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String androidPlugin = <span class="hljs-string"><span class="hljs-string">"com.android.tools.build:gradle:3.0.0-beta6"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String kotlinVersion = <span class="hljs-string"><span class="hljs-string">"1.1.50"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String kotlinPlugin = <span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-gradle-plugin:"</span></span> + kotlinVersion; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String kotlinRuntime = <span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jre7:"</span></span> + kotlinVersion; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String appCompat = <span class="hljs-string"><span class="hljs-string">"com.android.support:appcompat-v7:26.1.0"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String constraintLayout = <span class="hljs-string"><span class="hljs-string">"com.android.support.constraint:constraint-layout:1.0.2"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String junit = <span class="hljs-string"><span class="hljs-string">"junit:junit:4.12"</span></span>; }</code> </pre> <br><p>  Now you can refer to them inside any <code>build.gradle</code> files like this: </p><br><p><img src="https://habrastorage.org/webt/4q/ti/5e/4qti5e2rfpommenkyyg4waw3dss.gif"></p><br><p>  When you put the build configuration in <code>buildSrc</code> , it feels ... a bit wrong or something.  But the benefits of this approach far outweigh. </p><br><p>  Will you use trick with <code>buildSrc</code> ?  <strong>Write in the comments!</strong>  In addition, the author can be obtained via Twitter <a href="https://twitter.com/madisp">@madisp</a> and ask all the sore uncomfortable questions.  All examples from this post <a href="https://github.com/madisp/gradle-buildsrc">are available on GitHub</a> . </p><br><p>  The post is published with the permission of the company ZeroTurnaround and the author - Madis Pink.  ZeroTurnaround employees are often present in <a href="http://2017.jpoint.ru/">the</a> conference <a href="http://2017.jpoint.ru/">program committee of</a> the JUG.ru Group, <a href="http://2015.jpoint.ru/talks/arkhipov/">act as speakers at conferences</a> and often come just as guests.  We also invite Habr's readers to participate in the JPoint, which <a href="https://jpoint.ru/">will be held on April 6-7, 2018</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/342914/">https://habr.com/ru/post/342914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342896/index.html">Vote for schooling computer science</a></li>
<li><a href="../342900/index.html">Open web interface for .NET (OWIN)</a></li>
<li><a href="../342902/index.html">New Juniper MX Series Routers</a></li>
<li><a href="../342904/index.html">What is the difference between JavaScript and ECMAScript?</a></li>
<li><a href="../342906/index.html">Perlin's noise</a></li>
<li><a href="../342916/index.html">Biorobots of our time - we get rid of the routine with Telegram. Real case without fantasies</a></li>
<li><a href="../342918/index.html">Three, seven, joker - analysis of the solution of problems from the GridGain booklet at the Joker 2017 conference</a></li>
<li><a href="../342922/index.html">Stupid js. Make filters "beauty"</a></li>
<li><a href="../342924/index.html">Programming under ARM TrustZone. Secure monitor</a></li>
<li><a href="../342928/index.html">Vivaldi 1.13 - everything is at hand</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>