<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>There we add const, from here we delete const ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I just finished a series of changes in the code of the Chrome browser, which reduced the size of its Windows binaries by about 1 megabyte, transferred...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>There we add const, from here we delete const ...</h1><div class="post__text post__text-html js-mediator-article">  I just finished a series of changes in the code of the Chrome browser, which reduced the size of its Windows binaries by about 1 megabyte, transferred about 500 KB from the read / write segment to read-only, and also reduced the memory consumption in general by about 200 KB per every chrome process.  The amazing thing is that this particular series of changes consisted solely of deleting and adding the keyword const in some places in the code.  Yes, compilers are weird. <br><br>  This problem arose when I <a href="https://www.chromium.org/developers/windows-binary-sizes">wrote documentation</a> for some utilities that I use to study code regressions related to increasing the size of compiled binaries for Windows.  I ran the utility, copied its output into the documentation, and started describing it when I noticed something strange: several large global objects that, according to the architecture, were supposed to be constant, were for some reason in the read / write segment of the data.  The abbreviated version of that utility output is shown below: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c31/102/31d/c3110231d94697123c450dc75ca294be.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Most executable formats have at least two data segments - one for read / write objects and one for read-only.  If you have constant data, such as, for example, <a href="">kBrotliDictionary</a> , then it will be logical to put them in the read-only segment, which is the ‚Äú2‚Äù segment in the Chrome binary under Windows.  However, some constant data, such as <i>unigram_table</i> , <i>device :: UsbIds :: vendors_</i> and <i>blink :: serializedCharacterData,</i> were in section ‚Äú3‚Äù, that is, in the read / write segment. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/328/7b8/487/3287b8487113922293e84bad5ae49711.png" alt="image"><br><a name="habracut"></a><br>  The location of the data in the read-only segment provides several advantages.  This protects data from accidental damage, and also allows you to use it more efficiently.  read-only pages are guaranteed to be shared by all processes that load this DLL (and in the case of Chrome, we always have several processes).  In addition, in some cases (although probably not in these), the compiler can use constants directly in the code. <br><br>  Pages in the read / write segment can also be shared, but this is not guaranteed.  They are all created by default with the flag " <a href="https://en.wikipedia.org/wiki/Copy-on-write">make a copy if necessary changes</a> ", which means their general use only until the first write operation, which will lead to copying the page into the personal memory of the process.  Thus, if the global variable is initialized at runtime, this will automatically make it inaccessible for general use by all processes.  In addition, even if the global variable is only on the same memory page as the other copied during the recording - this also makes it inaccessible for general use - everything, you know, happens with the page size granularity (4 KiB). <br><br>  Private data uses more memory, because they require a separate copy in each process.  In addition, they are more expensive because they require space for a swap (which is not necessary for constant data, because you can read them if necessary from the image of the process binary).  This leads to expensive write / read operations on the HDD, which, moreover, will generally be at random addresses (even slower). <br><br>  For all these reasons, read-only pages are much more preferable in all cases where this is possible. <br><br><h3>  <b>Add const is good</b> </h3><br>  Thus, when my <a href="https://cs.chromium.org/chromium/src/tools/win/ShowGlobals/">ShowGlobals</a> utility showed that blink :: serializedCharacterData was in the read / write data segment, and further research confirmed that this array never changes, I <a href="https://codereview.chromium.org/2608823002">added a</a> const modifier to its declaration, which logically transferred it to the read segment -only data.  Very simple.  Such changes are always a good idea, but it is not always easy to understand exactly how much.  Since we never change this array, it is quite possible that it will be created in memory only in one instance and used by all Chrome processes.  But it is more likely that its end will fall on one page with another object, which, possibly, will change and thus lead to the creation of a copy of the memory page (together with a copy of the tail of our array).  Thus, we will lose 7748 or 3652 bytes (the size of the array minus one or two pages of memory in the middle, which are guaranteed to be common).  Such changes will help (well, or at least do not interfere) on all platforms, with all compilers. <br><br>  Explicit declaration of your constant array with the const modifier is a good idea; you should do this.  But the information above alone will not be enough to understand the whole picture.  And here we are entering uncharted territory ... <br><br><h3>  <b>Sometimes removing const is even better.</b> </h3><br>  The next array I investigated was <i>unigram_table</i> .  This was a strange case, since it was initialized exclusively by constant data using the structure / array initialization syntax and was marked with the const modifier - but for some reason it was in the read / write data segment.  It looked like a fad of the VC ++ compiler from all sides, so I used <a href="https://randomascii.wordpress.com/2013/10/14/how-to-report-a-vc-code-gen-bug/">my own instructions</a> on minimizing the code necessary for reproducing a bug and sent the bug report to Microsoft.  I copied the types and array declaration into a separate project and continued to reduce it, checking the location of the array in the read / write data segment at every step.  In the end, I reached a minimalistic code that would fit in a <a href="https://twitter.com/BruceDawson0xB/status/814251241417031680">tweet</a> : <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> {</span></span><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b[<span class="hljs-number"><span class="hljs-number">999</span></span>]; } a[] = {{{}}}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)a;}</code> </pre> <br>  If you compile this code and run <a href="https://cs.chromium.org/chromium/src/tools/win/ShowGlobals/">ShowGlobals</a> on the received PDB, the utility will show that ‚Äúa‚Äù is in section ‚Äú3‚Äù, despite the announcement with the const modifier.  Here are the specific steps for building and testing code: <br><br><pre> <code class="bash hljs">&gt; ‚Äú%VS140COMNTOOLS%..\..\VC\vcvarsall.bat‚Äù &gt; cl /Zi constbug.cpp /out:constbug.exe &gt; ShowGlobals.exe constbug.pdb Size Section Symbol name 3996 3 a</code> </pre> <br>  After reducing my example to less than 140 characters, it became very easy to find the cause.  With VC ++ compilers (2010, 2015, 2017 RC), it turns out that if you have a class / structure with a constant data member, then any global object of this type will end up in the read / write data segment.  Jonathan Caves explained in his comments to my <a href="https%253A%252F%252Frandomascii.wordpress.com%252F2017%252F01%252F08%252Fadd-a-const-here-delete-a-const-there%252F%26xtz%3D-120">bug report</a> that this is because the type is received by the compiler-generated remote default constructor (it makes sense), which confuses the VC ++ compiler, which mistakenly defines this class as requiring dynamic initialization. <br><br>  Thus, the problem in this case is in the const modifier, which stands next to the data member "b".  As soon as I deleted this const, the entire array got into the read-only memory (quite ironic, right?).  Since the whole object is somehow constant, deleting the const modifier from one of its data members does not reduce security at all, and in fact for the VC ++ compiler it increases it. <br><br>  I expect that the VC ++ development team will fix this bug for VS 2017 - in this case, the code could not be fixed - but I don‚Äôt want to wait that long.  And I began to remove const modifiers in the places where it caused similar problems.  The process was rather trivial - I just continued to browse the list of global variables in the read / write data segment and assign them to one of the following categories: <br><br><ul><li>  Those whose values ‚Äã‚Äãchange - leave as is </li><li>  Do not change and have no const modifier - add it </li><li>  Do not change and have a problematic data member with a const modifier - remove it </li></ul><br><h3>  <b>It was really funny.</b> </h3><br>  So I walked along the Chrome code, adding and removing const in the appropriate places.  In most cases, my changes, as planned, led to the movement of data from the read / write segment to the read-only segment.  But in two cases, these changes also did something else - reduced the size of the .text and .reloc sections.  It was just fine, too good to be true.  I assume that VC ++ generated code to initialize some of these arrays ‚Äî and quite a lot of code. <br><br>  The most interesting change was the removal of the three const from the definition of the UnigramEntry structure.  This transferred a segment of 53064 bytes to read-only, and also reduced the size of chrome.dll and chrome_child.dll by 364500 bytes.  From this it follows that the VC ++ compiler silently created initialization code, which occupied 7 bytes to initialize each byte of unigram_table.  This simply could not be.  It was too far beyond my expectations, so I ran Chrome under the Visual Studio debugger and set a breakpoint to change the data in at the end of the unigram_table array.  Visual Studio predictably stopped program execution in the initializer.  Below I will give (a little cleaned up) assembly initializer code (I replaced ‚Äúunigram_table‚Äù with ‚Äúu‚Äù to increase readability): <br><br><pre> <code class="hljs lua"><span class="hljs-number"><span class="hljs-number">55</span></span> push ebp <span class="hljs-number"><span class="hljs-number">8</span></span>B EC mov ebp,esp <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">78</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dword [u],<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>C <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dword [u+<span class="hljs-number"><span class="hljs-number">4</span></span>],<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dword [u+<span class="hljs-number"><span class="hljs-number">8</span></span>],<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dword [u+<span class="hljs-number"><span class="hljs-number">0</span></span>Ch],<span class="hljs-number"><span class="hljs-number">0</span></span> C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>D mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">10</span></span>h],<span class="hljs-number"><span class="hljs-number">4</span></span>Dh C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> CF mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">11</span></span>h],<span class="hljs-number"><span class="hljs-number">0</span></span>CFh C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>A <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>D mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">12</span></span>h],<span class="hljs-number"><span class="hljs-number">1</span></span>Dh C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>B <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>B mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">13</span></span>h],<span class="hljs-number"><span class="hljs-number">1</span></span>Bh C7 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>C <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> FF <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov dword [u+<span class="hljs-number"><span class="hljs-number">14</span></span>h],<span class="hljs-number"><span class="hljs-number">0</span></span>FFh C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">18</span></span>h],<span class="hljs-number"><span class="hljs-number">0</span></span> C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">19</span></span>h],<span class="hljs-number"><span class="hljs-number">0</span></span> C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">92</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">1</span></span>Ah],<span class="hljs-number"><span class="hljs-number">0</span></span> C6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">93</span></span> <span class="hljs-number"><span class="hljs-number">91</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+<span class="hljs-number"><span class="hljs-number">1</span></span>Bh],<span class="hljs-number"><span class="hljs-number">0</span></span> ‚Ä¶ <span class="hljs-number"><span class="hljs-number">52</span></span>,<span class="hljs-number"><span class="hljs-number">040</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lines</span></span> deleted‚Ä¶ c6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>c mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+cf42h],<span class="hljs-number"><span class="hljs-number">6</span></span>Ch c6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+cf43h],<span class="hljs-number"><span class="hljs-number">6</span></span>Eh c6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">12</span></span> a2 mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+cf44h],<span class="hljs-number"><span class="hljs-number">0</span></span>A2h c6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">12</span></span> c2 mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+cf45h],<span class="hljs-number"><span class="hljs-number">0</span></span>C2h c6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+cf46h],<span class="hljs-number"><span class="hljs-number">80</span></span>h c6 <span class="hljs-number"><span class="hljs-number">05</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">0</span></span>b <span class="hljs-number"><span class="hljs-number">12</span></span> c4 mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> [u+cf47h],<span class="hljs-number"><span class="hljs-number">0</span></span>C4h <span class="hljs-number"><span class="hljs-number">5</span></span>d pop ebp c3 ret</code> </pre> <br>  The numbers in the hexadecimal number system on the left are machine instruction codes, and the text on the right is their assembler representation.  After some prologue, we see the code filling the array ... one byte ... using 7 instructions.  Well, that explains it. <br><br>  It is well known that modern optimizing compilers can generate code that is as good as written by man (and more often even better).  And yet - sometimes they do not write such code.  There are many things in this particular function that could be made better: <br><br><ul><li>  She could not exist at all.  The array is initialized with simple syntax for initializing arrays in C, and if it were not for the above-described bug in the VC ++ compiler, the initializer code would not need to be generated at all (as happens on other platforms). </li><li>  Write zeros could be skipped.  This array is a global variable that is initialized only once when the program is started, and at this moment all memory is guaranteed to be filled with zeros, so writing zeroes on top of zeros is pointless work. </li><li>  Data could be written 4 bytes at a time, rather than one by one. </li><li>  The address of the array could be loaded into the register and used from there, instead of specifying it in each instruction.  This would make the instructions smaller, and also save 2 bytes on the relocation instruction of the data found in the .reloc segment. </li></ul><br>  Well, in general, you understand the point.  This function could be 4 times less, and also completely absent.  It disappeared after removing the three const modifiers (changes are already available in <a href="https://www.google.com/chrome/browser/canary.html">Chrome Canary</a> ), and along with it, the extra ~ 364500 bytes of code and ~ 105000 bytes in the .reloc section disappeared, and this happened in both chrome.dll and chrome_child. dll.  The array used to be in <a href="https://en.wikipedia.org/wiki/.bss">.BSS</a> (part of the read / write segment initialized with zeros), where it did not occupy any disk space, but moved to the read-only segment, where it began to occupy 53064 bytes, therefore the total saving of disk space was 416000 bytes Dll. <br><br>  And, more importantly, most of the global variables affected by <a href="https://chromium.googlesource.com/external/github.com/google/compact_enc_det.git/%2B/9a5abb86e339beca2ad7f375934a38727e810f45">these</a> <a href="https://codereview.chromium.org/2607893002/">changes</a> passed from the private memory of each process to shared shared memory, which resulted in savings of about 200 KB of RAM per process. <br><br><h3>  <b>Examples of changes</b> </h3><br>  I started with the largest and most frequently used objects and types in order to get a good and immediately visible result.  I quickly reduced the size of the read / write segment by about 250 KB, moving about 1500 global variables to the read-only segment.  You know, this is a matter of delay (what? Who has obsessive-compulsive disorder here? I have? I have no idea what you are talking about).  But I managed to stop at some stage, although I know for sure that there are still hundreds of smaller global variables in the code that could be corrected in a similar way.  At some point, it seemed to me that the efforts I wasted no longer cost the gains achieved in several bytes of memory and it‚Äôs time to move somewhere further.  But, if you have always dreamed of something to commit to Chrome code, feel free to go the above way.  For the sake of example, you can look at a few changes I have made: <br><br>  Changes removing const: <br><br><ul><li>  <a href="https://chromium.googlesource.com/external/github.com/google/compact_enc_det.git/%2B/9a5abb86e339beca2ad7f375934a38727e810f45">Three const deletes to move 53064 bytes into the read-only segment and save 729168 bytes of code</a> (the initializer recorded this one byte!) </li><li>  <a href="https://codereview.chromium.org/2607893002/">Three const deletes to move 166 KB in the read-only segment and save 224 KB of code</a> (1500 separate global variables!) </li><li>  <a href="https://codereview.chromium.org/2608763002/">Five const deletes to move 12,500 bytes in the read-only segment</a> </li><li>  <a href="https://codereview.chromium.org/2607183002">Remove const to move 6800 bytes in the read-only segment</a> </li><li>  <a href="https://codereview.chromium.org/2607993002/">Four const deletes to move 2500 bytes in the read-only segment</a> </li><li>  <a href="https://codereview.chromium.org/2605393002/">Six const deletes to move 960 bytes in the read-only segment</a> </li><li>  <a href="https://codereview.chromium.org/2613723005">Five const deletes to move 250 bytes into the read-only segment</a> </li></ul><br>  Changes adding const: <br><br><ul><li>  <a href="https://codereview.chromium.org/2608643002/">Add const to move 12864 bytes to read-only data segment</a> </li><li>  <a href="https://codereview.chromium.org/2608823002">Add three const to move 11844 bytes in the read-only data segment</a> </li><li>  <a href="https://skia-review.googlesource.com/c/6424/">Add two const to move 3000 bytes in the read-only data segment</a> </li><li>  <a href="https://github.com/xiph/flac/issues/26">Add const to move 396 bytes in the read-only data segment</a> </li></ul><br><h3>  <b>Try it yourself</b> </h3><br>  If you want to upgrade Chrome and look at the unigram_table initializer code before it disappears with the next release of Chrome, you don‚Äôt have to be a cool Chrome developer.  Start by doing these two commands: <br><br><pre> <code class="bash hljs">&gt; ‚Äú%VS140COMNTOOLS%..\..\VC\vcvarsall.bat‚Äù &gt; devenv /debugexe chrome.exe</code> </pre> <br>  Make sure that you add the path to the Chrome symbolic server to the debugger settings (by following <a href="https://www.chromium.org/developers/how-tos/debugging-on-windows">this instruction</a> ) and set a breakpoint to this symbol: <br><br>  <i>`dynamic initializer for 'unigram_table' '</i> <br><br>  Make sure that you do not have currently running Chrome and run it from under Visual Studio.  Visual Studio will load Chrome characters ( <a href="https://randomascii.wordpress.com/2013/03/09/symbols-the-microsoft-way/">magic of symbol servers!</a> ) And set breakpoint on the initializer (if it still exists).  Nothing complicated.  You can switch to the assembler code mode (Ctrl + F11).  If you want to see the source code - just enable the use of <a href="https://randomascii.wordpress.com/2011/11/11/source-indexing-is-underused-awesomeness/">the source code server</a> in the settings of the Visual Studio debugger. </div><p>Source: <a href="https://habr.com/ru/post/322320/">https://habr.com/ru/post/322320/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322304/index.html">SAP has prepared a major update for its product S / 4Hana Cloud</a></li>
<li><a href="../322306/index.html">‚ÄúCloud for beginners‚Äù: How to protect IaaS infrastructure</a></li>
<li><a href="../322308/index.html">‚ÄúOne pair at a time‚Äù: release of XenServer 7.1 and ESXi 6.0 Update 3 hypervisors</a></li>
<li><a href="../322312/index.html">Routine work with the database of the 24x7 information system in MS SQL Server</a></li>
<li><a href="../322316/index.html">What is SAML authentication and who needs it?</a></li>
<li><a href="../322322/index.html">Working with printing devices in C # on the example of implementing a virtual printer</a></li>
<li><a href="../322324/index.html">Aytreking in UX research</a></li>
<li><a href="../322326/index.html">Take it down immediately</a></li>
<li><a href="../322328/index.html">Report with Game Design meetup February 4</a></li>
<li><a href="../322332/index.html">Why it is not necessary to learn python in the first language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>