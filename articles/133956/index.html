<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a proxy dll to run DirectDraw games in the window</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In continuation of the topic of extending the functionality of ready-made programs, I would like to talk about another way of changing the logic of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a proxy dll to run DirectDraw games in the window</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/275/ffd/263/275ffd26327dcd81b9f20c1417d34d01.png" align="left">  In continuation of the topic of <a href="http://habrahabr.ru/blogs/asm/51857/">extending the functionality of ready-made programs,</a> I would like to talk about another way of changing the logic of the already compiled program, which does not require making changes in the executable file itself.  This can come in handy when distributing your modification in the United States, where direct interference with the executable file is strongly condemned.  It will be about creating a tiny proxy dll (just ‚âà4 kilobytes) to replace the library used by the application using the example ddraw.dll. <br><a name="habracut"></a><br><h4>  Let's get started </h4><br>  All work will be done in Visual Studio 2010. To begin, examine the target library for exported functions.  To do this, we use the dumpbin utility (in the VS2010 \ VC \ bin directory): <br><pre><code class="bash hljs">vcvars32 dumpbin /EXPORTS c:\windows\system32\ddraw.dll</code> </pre>  As a result, we get: <br><pre> <code class="html hljs xml"> ordinal hint RVA name 1 0 00002E69 AcquireDDThreadLock 2 1 000327FA CompleteCreateSysmemSurface 3 2 00032FAE D3DParseUnknownCommand 4 3 00033EEF DDGetAttachedSurfaceLcl 5 4 000325D7 DDInternalLock 6 5 0003258C DDInternalUnlock 7 6 000363FC DSoundHelp 8 7 0000859D DirectDrawCreate 9 8 00037851 DirectDrawCreateClipper 10 9 0000EBC6 DirectDrawCreateEx 11 A 000338C9 DirectDrawEnumerateA 12 B 00033368 DirectDrawEnumerateExA 13 C 00032CB2 DirectDrawEnumerateExW 14 D 0003333B DirectDrawEnumerateW 15 E 000387C1 DllCanUnloadNow 16 F 00038607 DllGetClassObject 17 10 00032675 GetDDSurfaceLocal 18 11 0003A5F9 GetOLEThunkData 19 12 0000E927 GetSurfaceFromDC 20 13 00027CC4 RegisterSpecialCase 21 14 00002EA8 ReleaseDDThreadLock 22 15 000421A6 SetAppCompatData</code> </pre> <br>  Based on this, we can already create our own proxy dll.  Since we do not need anything other than WinAPI, therefore, in the fresh project of the win32 library, first of all, disable RTL by turning on the <a href="http://msdn.microsoft.com/en-us/library/3tz4da4a%2528v%3Dvs.100%2529.aspx"><code>/NODEFAULTLIB</code></a> parameter and specifying the <code>DllMain</code> entry <code>DllMain</code> .  This will greatly benefit in volume.  Further in the DEF file we indicate the exported functions in the following form: <br><pre> <code class="html hljs xml">LIBRARY "ddraw" EXPORTS AcquireDDThreadLock = FakeAcquireDDThreadLock @1 CheckFullscreen = FakeCheckFullscreen @2 CompleteCreateSysmemSurface = FakeCompleteCreateSysmemSurface @3 D3DParseUnknownCommand = FakeD3DParseUnknownCommand @4 ...</code> </pre><br>  Since we need to ensure that our ‚Äúfake‚Äù functions simply transfer control to their originals, in C ++, each of them will look like this: <br><pre> <code class="cpp hljs">__declspec(naked) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FakeAcquireDDThreadLock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ _asm { jmp [ddraw.AcquireDDThreadLock] } }</code> </pre>  Using <code>__declspec(naked)</code> we force the compiler to not generate the standard prologue and epilogue code that insert data onto the stack.  As a result, the data in the stack is already stored in a suitable form, and we can simply transfer control of the original function with one <code>jmp</code> command without <code>jmp</code> parameters to the stack. <br><br>  The transition address is taken from the ddraw structure, which looks like this: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ddraw_dll</span></span></span><span class="hljs-class"> {</span></span> HMODULE dll; FARPROC AcquireDDThreadLock; FARPROC CheckFullscreen; FARPROC CompleteCreateSysmemSurface; FARPROC D3DParseUnknownCommand; <span class="hljs-comment"><span class="hljs-comment">// ...     ... } ddraw;</span></span></code> </pre>  This structure is filled in DllMain at the time of loading our proxy dll.  First we load the original library, then in turn we get the addresses of all the exported functions.  The code will look something like this: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> path[MAX_PATH]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ul_reason_for_call) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: CopyMemory(path+GetSystemDirectory(path,MAX_PATH<span class="hljs-number"><span class="hljs-number">-10</span></span>), <span class="hljs-string"><span class="hljs-string">"\\ddraw.dll"</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>); ddraw.dll = LoadLibrary(path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ddraw.dll == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { MessageBox(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Cannot load original ddraw.dll library"</span></span>, APP_NAME, MB_ICONERROR); ExitProcess(<span class="hljs-number"><span class="hljs-number">0</span></span>); } ddraw.AcquireDDThreadLock = GetProcAddress(ddraw.dll, <span class="hljs-string"><span class="hljs-string">"AcquireDDThreadLock"</span></span>); ddraw.CheckFullscreen = GetProcAddress(ddraw.dll, <span class="hljs-string"><span class="hljs-string">"CheckFullscreen"</span></span>); ddraw.CompleteCreateSysmemSurface = GetProcAddress(ddraw.dll, <span class="hljs-string"><span class="hljs-string">"CompleteCreateSysmemSurface"</span></span>); ddraw.D3DParseUnknownCommand = GetProcAddress(ddraw.dll, <span class="hljs-string"><span class="hljs-string">"D3DParseUnknownCommand"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ...       ... break; case DLL_PROCESS_DETACH: FreeLibrary(ddraw.dll); break; } return TRUE; }</span></span></code> </pre><br>  As a result, we received a compact dll, which simply passes all calls through, without interfering in the process at all.  A similar result could have been achieved using an <a href="http://www.codeproject.com/Articles/16541/Create-your-Proxy-DLLs-automatically">automatic solution</a> , but the code would not have been so beautiful. <br><br><h4>  Window mode for DirectDraw games </h4><br>  Once we have a clean proxy dll that works successfully with the target application, we can proceed to the necessary modifications.  At the time of loading our library, we can patch the necessary parts of the code already in memory, install hooks on calls from other libraries, and also change the logic of the functions that we proxied in our dll.  In our case, the most logical would be to change the <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/gg426116%2528v%3Dvs.85%2529.aspx"><code>DirectDrawCreate</code></a> function so that it returns the IDirectDraw structure with the replaced addresses of methods whose behavior we would like to change to achieve the final goal. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, this is too much work for the demonstration work, and therefore we will simply use the services of the wndmode.dll library from the previous article, which already implements everything you need, you just need to load it into the address space of the process. <br><br>  We do this right in <code>DllMain</code> by adding one line to the <code>case DLL_PROCESS_ATTACH</code> : <br><pre> <code class="cpp hljs">LoadLibrary(<span class="hljs-string"><span class="hljs-string">"wndmode.dll"</span></span>);</code> </pre>  The rest of the changes to your taste :) <br><br><h4>  Wndmode.dll library </h4><br>  This library is engaged in intercepting all calls to DirectDraw, modifying the parameters so that the program works in the window, and only after that transfers control to the original DirectDraw functions. <br><br>  By itself, wndmode.dll is a strongly modified version of the d3dhook.dll library, where it is implemented: <br><ul><li>  Full independence from the program D3D Windower </li><li>  Settings are loaded from the [WINDOWMODE] section of the wndmode.ini file </li><li>  Default settings are overwritten for Genie compatibility. </li><li>  Added Border parameter that turns on / off the frame around the window </li><li>  If the game resolution is equal to the system resolution, the frame is automatically removed. </li></ul>  That is, with the help of wndmode.dll, we can try to make almost any DirectDraw game windowed. <br><br>  The wndmode.ini can contain the following settings: <br><pre> <code class="cpp hljs">[WINDOWMODE] UseWindowMode=<span class="hljs-number"><span class="hljs-number">1</span></span> UseGDI=<span class="hljs-number"><span class="hljs-number">0</span></span> UseDirect3D=<span class="hljs-number"><span class="hljs-number">0</span></span> UseDirectInput=<span class="hljs-number"><span class="hljs-number">0</span></span> UseDirectDraw=<span class="hljs-number"><span class="hljs-number">1</span></span> UseDDrawColorEmulate=<span class="hljs-number"><span class="hljs-number">1</span></span> UseDDrawFlipBlt=<span class="hljs-number"><span class="hljs-number">0</span></span> UseDDrawColorConvert=<span class="hljs-number"><span class="hljs-number">1</span></span> UseDDrawPrimaryBlt=<span class="hljs-number"><span class="hljs-number">1</span></span> UseDDrawAutoBlt=<span class="hljs-number"><span class="hljs-number">0</span></span> UseDDrawEmulate=<span class="hljs-number"><span class="hljs-number">0</span></span> UseDDrawPrimaryLost=<span class="hljs-number"><span class="hljs-number">0</span></span> UseCursorMsg=<span class="hljs-number"><span class="hljs-number">0</span></span> UseCursorSet=<span class="hljs-number"><span class="hljs-number">0</span></span> UseCursorGet=<span class="hljs-number"><span class="hljs-number">0</span></span> UseSpeedHack=<span class="hljs-number"><span class="hljs-number">0</span></span> SpeedHackMultiple=<span class="hljs-number"><span class="hljs-number">10</span></span> UseBackgroundResize=<span class="hljs-number"><span class="hljs-number">0</span></span> UseForegroundControl=<span class="hljs-number"><span class="hljs-number">0</span></span> UseFGCGetActiveWindow=<span class="hljs-number"><span class="hljs-number">0</span></span> UseFGCGetForegroundWindow=<span class="hljs-number"><span class="hljs-number">0</span></span> UseFGCFixedWindowPosition=<span class="hljs-number"><span class="hljs-number">0</span></span> EnableExtraKey=<span class="hljs-number"><span class="hljs-number">0</span></span> ShowFps=<span class="hljs-number"><span class="hljs-number">0</span></span> UseCursorClip=<span class="hljs-number"><span class="hljs-number">0</span></span> UseBackgroundPriority=<span class="hljs-number"><span class="hljs-number">0</span></span> DDrawBltWait=<span class="hljs-number"><span class="hljs-number">-1</span></span> Border=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Most options are the same as <a href="http://www.geocities.jp/menopem/">D3D Windower</a> .  The Height and Width parameters, which fixed the window size, were removed, but instead the Border parameter was added (to show the window frame or not) and automatic frame concealment was implemented if the game resolution matches the system resolution.  The appropriate settings for each game will be different, they will have to pick up manually. <br><br><h4>  Download </h4><br>  <b>Source code:</b> <a href="https://bitbucket.org/veg/tinyddraw/src">on bitbucket.org</a> <br>  <b>Binary:</b> <a href="">wndmode.zip</a> (340 kb) <br><br><h4>  Demo: Age of Empires: The Rise of Rome </h4><br>  Copy our ddraw.dll, wndmode.dll and wndmode.ini into the directory with the game, run the game.  Drumroll‚Ä¶ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4b9/e33/7aa/4b9e337aa908968a8ca0012e5ed0916a.png" alt="image"></div><p>Source: <a href="https://habr.com/ru/post/133956/">https://habr.com/ru/post/133956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133942/index.html">How am I looking for a programmer</a></li>
<li><a href="../133946/index.html">As the customer remained the performer. Part II</a></li>
<li><a href="../133947/index.html">Letters and scribbles</a></li>
<li><a href="../133953/index.html">FiveGUI - beautiful buttons for canvas'a</a></li>
<li><a href="../133954/index.html">Review of the book ‚ÄúProgramming the Arduino / Freeduino microcontroller cards‚Äù</a></li>
<li><a href="../133957/index.html">Dense code and testing</a></li>
<li><a href="../133960/index.html">US Antimonopoly Committee authorized Google to buy Admeld</a></li>
<li><a href="../133961/index.html">Microdata & the microdata DOM API</a></li>
<li><a href="../133962/index.html">About the history of memcpy implementations and their performance</a></li>
<li><a href="../133963/index.html">Skype vulnerability allows you to determine the IP address of a particular user.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>