<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>IdBasedLocking</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Java has excellent concurrency and locking support - perhaps the best that modern languages ‚Äã‚Äãoffer. Besides the fact that the language itself has bui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>IdBasedLocking</h1><div class="post__text post__text-html js-mediator-article">  Java has excellent concurrency and locking support - perhaps the best that modern languages ‚Äã‚Äãoffer.  Besides the fact that the language itself has built-in support for synchronization, there are a number of useful utilities based on the AQS framework.  These include CountDownLatches, Barriers, Semaphores and others.  However, there is often a situation that is not directly supported: when it is necessary to block access not to a <b>specific object</b> , but to the <b>idea of ‚Äã‚Äãthis object</b> . <br><br><a name="habracut"></a><br><br>  Consider the following example: we have a service that is responsible for mailboxes (mailbox).  It has a method for adding a new message and a method for reading the message.  Of course, we run our service in a multi-threaded environment - after all, we have thousands of users who send a huge bunch of messages to each other.  To protect the mailbox from data corruption, we should not allow the modification of one box by several threads at the same time: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserId from, UserId to, Message message)</span></span></span><span class="hljs-function"> </span></span>{ Mailbox sendersBox = getMailbox(from); Mailbox recipientsBox = getMailbox(to); min(sendersBox,recipientsBox).lock(); max(sendersBox, recipientsBox).lock(); sendersBox.addIncomingMessage(message); recipientsBox.addSentMessage(message); max(sendersBox, recipientsBox).lock(); min(sendersBox,recipientsBox).lock(); }</code> </pre> <br><br>  The code assumes that for the mailbox we have the min / max function, which always gives an unambiguous result: for example, it compares the hash code, or the host id, or something else.  This is necessary in order to always put the lock in the same order (smaller one first) and avoid deadlock when modifying two boxes.  Taking this into account, the code looks relatively safe, doesn't it? <br><br>  In fact, the security of this code depends on how, in fact, the <i>getMailbox ()</i> method is implemented.  If he can guarantee the return of the same object (and exactly ‚Äúthe same‚Äù, and not ‚Äúthe same‚Äù), then we are safe.  Unfortunately, such a guarantee is practically impossible to implement.  On the other hand, we could, of course, put <i>synchronized</i> on the entire <i>sendMessage ()</i> method, but this would kill our performance on the root, since we could send only one message at a time, regardless of the number of threads and processors at our disposal. <br><br>  Here is an example of how you can incorrectly implement <i>getMailbox ()</i> : <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Mailbox </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMailbox</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserId id)</span></span></span><span class="hljs-function"> </span></span>{ Mailbox mailbox = cache.get(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mailbox == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mailbox = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mailbox(); cache.put(id, mailbox); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mailbox; }</code> </pre><br><br>  Obviously, this implementation is insecure: it allows the creation of the same mailbox as a matter of fact (that is, belonging to the same user) from different streams at the same time.  This means that at some point two different boxes of the same user may appear in the system, and only Cthulhu will know which of them will survive.  You can solve this problem by blocking the creation of a new mailbox globally, but this is again a rake with performance.  You can start having fun with <i>ConcurrentMap</i> and all kinds of <i>putIfAbsent</i> .  But imagine that we are not only creating new mailboxes, but also loading existing ones from the database.  Then it will be much more difficult to synchronize correctly (and it would be nice to prevent unnecessary requests to the database). <br><br>  Fortunately, IdBasedLocking solves this particular problem.  Instead of <b>blocking a specific</b> mailbox <b>object</b> , we <b>block the concept of the mailbox</b> , based on the fact that we have one mailbox per user: <br><br><pre> <code class="java hljs"> IdBasedLockManager&lt;UserId&gt; manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SafeIdBasedLockManager&lt;UserId&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMessageSafe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UserId from, UserId to, Message message)</span></span></span><span class="hljs-function"> </span></span>{ IdBasedLock&lt;UserId&gt; minLock = manager.obtainLock(min(from, to)); IdBasedLock&lt;UserId&gt; maxLock = manager.obtainLock(max(from, to)); minLock.lock(); maxLock.lock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Mailbox sendersBox = getMailbox(from); Mailbox recipientsBox = getMailbox(to); sendersBox.addIncomingMessage(message); recipientsBox.addSentMessage(message); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { maxLock.unlock(); minLock.unlock(); } }</code> </pre><br><br>  An example may seem artificially complicated due to the simultaneous modification of two objects.  IdBasedLocking works fine with a single object, as the following counter example demonstrates. <br><br>  First - a broken version: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounterUnsafe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ Counter c = counterCache.get(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter(); counterCache.put(id, c); } c.increase(); }</code> </pre><br><br>  And now the safe version: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseCounterSafely</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String id)</span></span></span><span class="hljs-function"> </span></span>{ IdBasedLock&lt;String&gt; lock = lockManager.obtainLock(id); lock.lock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{ Counter c = counterCache.get(id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Counter(); counterCache.put(id, c); } c.increase(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { lock.unlock(); } }</code> </pre><br><br>  IdBasedLocking project on <a href="https://github.com/anotheria/idbasedlock">githaba</a> . <br><br>  You can borrow it using maven, gradle or ivy, or simply from <a href="http://search.maven.org/">central</a> .  Or try it out on a <a href="https://github.com/anotheria/idbasedlock">githaba</a> yourself. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/210728/">https://habr.com/ru/post/210728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210718/index.html">How PayPal and GoDaddy made me give away a $ 50,000 Twitter account</a></li>
<li><a href="../210720/index.html">We explain to business why we have such ‚Äúfig‚Äù assessments</a></li>
<li><a href="../210722/index.html">VPS Search - Updated Version</a></li>
<li><a href="../210724/index.html">Backup as a Service (BaaS) for vCloud with Acronis</a></li>
<li><a href="../210726/index.html">Beta testing "Freelance 2.0"</a></li>
<li><a href="../210730/index.html">Skype 4.2.0.13 - minor release with long-awaited fix</a></li>
<li><a href="../210732/index.html">Dedicated SaaS or how to start ‚Äúselling soup‚Äù</a></li>
<li><a href="../210734/index.html">A plugin for Bootstrap 3 that enhances the accessibility of interfaces</a></li>
<li><a href="../210736/index.html">HID USB Device Management on Windows 7</a></li>
<li><a href="../210738/index.html">Facebook will create an energy-efficient data storage of 10,000 Blu-ray discs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>