<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>All-In-One: Proxmox + OpenMediaVault or another idea for a home NAS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Astrologers have announced a month of articles about home NAS on Habr√©, so I will share my success story ... 


 Not so long ago, I tried the new Free...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>All-In-One: Proxmox + OpenMediaVault or another idea for a home NAS</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/f0a/592/3de/f0a5923dec20422e952394a6d0473355.png"></p><br><p>  Astrologers have announced a month of articles about home NAS on Habr√©, so I will share my success story ... </p><br><p>  Not so long ago, I tried the new FreeNAS Coral.  I liked it in it, if not all, then very much: this is the new bhyve hypervisor, and the widespread use of 9P for forwarding the file system to the guest, as well as the idea with docker and much more. </p><br><p>  In addition, I fell in love even more with ZFS with all its buns, such as deduplication and compression on the fly. </p><br><p>  But unfortunately, not everything was as smooth as we would like, and, besides, the flash drive with the installed system ordered to live long, so the time has come for new experiments!  This time I decided to implement something similar, but only better and entirely on Linux. </p><br><p>  The article will also be a little talked about Docker and automatic proxy with automatic receipt of Letsencrypt certificates. </p><br><a name="habracut"></a><br><p>  To begin with, I‚Äôll tell you what I didn‚Äôt like about FreeNAS Corral: </p><br><ul><li>  Not ready for production.  (recently this release was <a href="https://www.opennet.ru/opennews/art.shtml%3Fnum%3D46377">withdrawn</a> altogether) </li><li>  Working with docker is convenient only in the case of single containers, in the case of a lot of containers, management via the web-face becomes extremely inefficient. </li><li>  Containers run inside Linux virtual machines, and the ports are proxied through the host, which in principle is not bad, but implies some kind of overhead in comparison if they run directly on the host. </li><li>  The bhyve hypervisor does not yet support live-snapshots. </li><li>  There is no possibility to create virtual machines not from templates.  (at least in GUI) </li><li>  The system installed on the USB flash drive was terribly slow. </li></ul><br><p>  In principle, one could live with all this, but as I said, the flash drive with the system died and now I have new ideas: </p><br><ul><li><p>  The system must be installed on a hard disk, even if it is the simplest, but on a disk, and not on a USB flash drive. <br>  The idea of ‚Äã‚Äãinstalling a separate system from the data is good, but how many flash drives I have tried (including USB 3.0) still works very poorly and shamelessly slows down.  So we will put on a separate HDD. </p><br></li><li><p>  ZFS as a file system based.  ZFS makes it possible for me not to think about how I can allocate storage resources between file systems and virtual machines, it supports snapshots, deduplication and compression on the fly, as well as the well-known RAIDZ. </p><br></li><li>  Proxmox as a virtualization management system.  It has everything you need: it supports both full and container virtualization, snapshots, automatic backups and much more, and most importantly, ZFS is offered here by default and works right out of the box. <br>  Proxmox is entirely controlled through a modern web interface on ExtJS: </li></ul><br><p><img src="https://habrastorage.org/web/cc7/720/e70/cc7720e700dd45cbbd25bd0e538f99a1.png"></p><br><div class="spoiler">  <b class="spoiler_title">Proxmox also allows you to connect to the virtual machine console via a web interface:</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/web/cd9/863/611/cd98636117db4dc9b718f29f581f958e.png"></p><br><p>  HTML5 client noVNC is used for this. </p></div></div><br><ul><li>  OpenMediaVault as a storage management system. </li></ul><br><p>  When choosing storage, the main criterion was ZFS support and work on linux, and not on FreeBSD.  I wanted to install it on the host system along with Proxmox and not on a separate virtual machine. </p><br><p>  I considered several softin for this role, I even tried <a href="https://www.openattic.org/">openATTIC</a> - unfortunately ZFS support turned out to be rather weak there and at the moment many options are simply not there, although I am sure that it will be a little different with CEPH. </p><br><p>  While searching, I came across a great plugin that adds zfs support for OpenMediaVault - it gives you complete control over ZFS.  Together with OpenMediaVault itself, it fully implements all the functions that I have wanted for a long time to get from the repository. <br>  OpenMediaVault, like Proxmox, is entirely controlled through a modern web interface on ExtJS: </p><br><p><img src="https://habrastorage.org/web/c88/c8d/a8e/c88c8da8e8104aa68866c5f654b70b82.png"></p><br><p>  Proxmox and OpenMediaVault will be the core of our system, with the result that we get a multifunctional combine advanced storage system and advanced virtualization in one box, all data, as well as virtual machine disks will be stored on ZFS. <br>  In case you need to deploy a new service, you can always create a separate <br>  virtual machine or container for this.  I will tell you about this a little later. </p><br><p>  Both systems are delivered and run on Debian, which on the one hand should significantly simplify the task, but on the other hand both systems carry a huge number of packages and dependencies that can periodically overlap and conflict between themselves. <br>  And especially for you, I wrote a small instruction on how to do this. </p><br><h2 id="kak-ustanovit-openmediavault-na-proxmox">  How to install OpenMediaVault on Proxmox </h2><br><h3 id="ustanovka-proxmox">  Install Proxmox </h3><br><p>  You will need an installation CD, you can take it on the official website: </p><br><ul><li>  <a href="https://www.proxmox.com/en/downloads/category/iso-images-pve">https://www.proxmox.com/en/downloads/category/iso-images-pve</a> <br>  <em>(we need version 4, since it is based on Debian 8 Jessie)</em> </li></ul><br><p>  Installation is simple and intuitive, so I think it will not cause you too many questions. <br>  I can only say that it is desirable to have a separate physical disk under the system, so that in case of anything, it could always be safely reinstalled without affecting the data disks. </p><br><p>  When installing Proxmox, you can also select a ZFS file system or even configure software RAID. </p><br><p> After installation, do not forget to register <code>pve-no-subscription</code> for the Proxmox repository in order to be able to install packages from it. </p><br><pre> <code class="bash hljs">cat /etc/apt/sources.list.d/pve-enterprise.list deb http://download.proxmox.com/debian jessie pve-no-subscription</code> </pre> <br><h3 id="ustanovka-openmediavault">  Installing OpenMediaVault </h3><br><p>  Install the OpenMediaVault 3.0 Erasmus repository: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://packages.openmediavault.org/public erasmus main"</span></span> &gt; /etc/apt/sources.list.d/openmediavault.list</code> </pre> <br><p>  As I said earlier, the <code>openmediavault</code> package has some insoluble dependencies with Proxmox components, in particular, the <code>watchdog</code> package, which since the release of version 4.0 is a default fencing daemon, is swinging this package.  In our case, it is installed by default as a dependency on <code>proxmox-ve</code> , but we do not use it because  do not use clustering. </p><br><p>  In any case, we need to somehow resolve these dependencies, and therefore we will rebuild the deb-package for <code>openmediavault</code> . </p><br><p>  Prepare the environment for the assembly: </p><br><pre> <code class="bash hljs">apt install build-essential</code> </pre> <br><p>  Download the sources of OpenMediaVault 3.0 Erasmus, and go to the build directory: </p><br><pre> <code class="bash hljs">wget https://github.com/openmediavault/openmediavault/archive/3.x.tar.gz -O - | tar xzvf - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> openmediavault-3.x/deb/openmediavault</code> </pre> <br><p>  This command will show us the necessary dependencies that we need to install on the system before building the package: </p><br><pre> <code class="bash hljs">dpkg-checkbuilddeps</code> </pre> <br><p>  Based on the output of the previous command, install the necessary packages: </p><br><pre> <code class="bash hljs">apt install debhelper fakeroot gettext dh-systemd doxygen</code> </pre> <br><p>  Now we need to remove the <code>watchdog</code> from the dependencies, to do this, edit <code>debian/control</code> and remove the <code>watchdog</code> from there. <br>  You also need to remove the <code>doxygen</code> version requirement: </p><br><pre> <code class="bash hljs">vim debian/control <span class="hljs-comment"><span class="hljs-comment"># remove: watchdog # remove version: doxygen (&gt;= 1.8.9.1)</span></span></code> </pre> <br><p>  Check the dependencies for the build again: </p><br><pre> <code class="bash hljs">dpkg-checkbuilddeps</code> </pre> <br><p>  And run the assembly itself: </p><br><pre> <code class="bash hljs">dpkg-buildpackage -us -uc</code> </pre> <br><p>  After the build, you will receive a ready-made deb-package, which we will install in the system: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. dpkg -i openmediavault_*.deb</code> </pre> <br><p>  Now we will install the rest of the dependencies, for this we run: </p><br><pre> <code class="bash hljs">aptitude -f install</code> </pre> <br><p>  Now you can run the script for the initial configuration, change the administrator password / port of the web server and something else: </p><br><pre> <code class="bash hljs">omv-firstaid</code> </pre> <br><h3 id="ustanovka-plagina-zfs">  Installing the ZFS plugin: </h3><br><p>  The <code>openmediavault-zfs</code> plugin is installed separately from OpenMediaVault and since it also has unsolvable dependencies, we will also compile it manually: </p><br><p>  Download the source code and go to the build directory: </p><br><pre> <code class="bash hljs">wget https://github.com/OpenMediaVault-Plugin-Developers/openmediavault-zfs/archive/master.tar.gz -O - | tar xzvf - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> openmediavault-zfs-master</code> </pre> <br><p>  We'll fix the dependencies, remove the <code>zfs-dkms</code> as well as in Proxmox since version 4.0, ZFS is already bundled with the kernel, we will also remove <code>linux-headers-*</code> / <code>pve-headers</code> to the heap as unnecessary: </p><br><pre> <code class="bash hljs">vim debian/control <span class="hljs-comment"><span class="hljs-comment"># remove: zfs-dkms # remove: linux-headers-amd64 | pve-headers | linux-headers-3.16.0-4-all</span></span></code> </pre> <br><p>  Check the build dependencies: </p><br><pre> <code class="bash hljs">dpkg-checkbuilddeps</code> </pre> <br><p>  Run the build: </p><br><pre> <code class="bash hljs">dpkg-buildpackage -us -uc</code> </pre> <br><p>  After assembly, install the resulting package and dependencies for it: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. dpkg -i openmediavault-zfs_*.deb aptitude -f install</code> </pre> <br><p>  <em>If there are difficulties with packing packages, there is a good article in Russian in the Debian documentation:</em> </p><br><ul><li>  [ <a href="https://www.debian.org/doc/manuals/maint-guide/build.ru.html%5D(%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25B0">https://www.debian.org/doc/manuals/maint-guide/build.ru.html</a> [) ( <a href="https://www.debian.org/doc/manuals/maint-guide/build.ru.html%5D(%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25B0">Chapter</a> 6. Build Package) </li></ul><br><p>  That's probably all, now you have Proxmox and OpenMediaVault installed on the same system, it's time to go to the GUI to create and configure ZFS pools and connect them to Proxmox. <br>  How to do this, I will not describe, this is so full of information on the Internet. </p><br><h2 id="chto-dalshe">  What's next? </h2><br><p>  Then the most interesting, now you can begin to configure additional services. <br>  Of these, I want to show how to configure: </p><br><ul><li>  <a href="https://wordpress.org/">Wordpress</a> is one of the easiest and most common engines for building websites. </li><li>  <a href="https://nextcloud.com/">Nextcloud</a> - your personal cloud and interface for accessing files. </li><li>  <a href="http://deluge-torrent.org/">Deluge</a> - in my opinion the best torrenkachalkal. </li><li>  <a href="https://emby.media/">Emby</a> is a free media server that allows you to stream media directly in a browser or via DLNA. </li><li>  <a href="https://hub.docker.com/r/jwilder/nginx-proxy/">nginx-proxy</a> - which will automatically generate a config and proxy all these services. </li><li>  <a href="https://hub.docker.com/r/jrcs/letsencrypt-nginx-proxy-companion/">nginx-proxy-companion</a> - will receive and update certificates in automatic order. </li></ul><br><p>  Each of these services will be available on a subdomain and protected by SSL, with a valid certificate from Letsencrypt.  Docker will come to the rescue of us, I think that it is much easier than you could imagine. </p><br><p>  I assume you have already configured the ZFS repository and connected it to the Proxmox interface. </p><br><p>  In my particular case, there are two pools: </p><br><ul><li>  <code>rpool</code> is the one that proxmox created when installing </li><li>  <code>tank</code> is a RAIDZ pool of three data disks </li></ul><br><p>  I also created four main datastores: </p><br><ul><li>  <code>tank/pve</code> - for Proxmox virtual machines </li><li>  <code>tank/docker</code> - data of services running in docker will be stored here </li><li>  <code>tank/cloud</code> - for nextcloud data </li><li>  <code>tank/data</code> is the main file setting, there are several other datastores inside, such as <code>Music</code> , <code>Photos</code> , <code>Movies</code> , each with its own settings, for example, <code>Music</code> and <code>Photos</code> deduplication is enabled, since I have a large number of duplicate files that I have unsubscribed .. . </li></ul><br><p>  Now I want to create a separate virtual machine in Proxmox, or rather the container and run everything in it, so that I no longer scoff at the main system and, if possible, isolate these services from it. <br>  I added the following lines to the container configuration: </p><br><pre> <code class="bash hljs">lxc.aa_profile: unconfined lxc.cap.drop: mp0: /tank/data,mp=/data mp1: /tank/cloud,mp=/cloud mp2: /tank/docker,mp=/docker</code> </pre> <br><p>  The first two give out more rights to the container, so it becomes possible to launch other containers inside it, this is necessary for the docker to function. <br>  The remaining lines connect the necessary directories to the guest's file system. </p><br><p>  It is worth paying attention to the fact that if you have others inside the zfs-datastores connected to the container, then you also need to add them to the container configuration, otherwise you risk getting some unpleasant bugs.  I will give an example: </p><br><pre> <code class="bash hljs">mp0: /tank/data,mp=/data mp3: /tank/data/Music,mp=/data/Music mp4: /tank/data/Pictures,mp=/data/Pictures</code> </pre> <br><p>  Inside the container we need to install <code>docker</code> and <code>docker-compose</code> , and after that I will show how everything is organized. </p><br><h3 id="docker">  Docker </h3><br><p>  In the <code>/docker</code> directory, I have created directories for each individual service: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ls /docker/ deluge emby nextcloud nginx-proxy wordpress</span></span></code> </pre> <br><p>  Each directory contains a separate <code>docker-compose.yml</code> file and data for each individual container. </p><br><p>  For example, <code>docker-compose.yml</code> looks like <code>docker-compose.yml</code> : </p><br><div class="spoiler">  <b class="spoiler_title">for nginx-proxy and nginx-proxy-companion</b> <div class="spoiler_text"><pre> <code class="hljs javascript">nginx-proxy: restart: on-failure:<span class="hljs-number"><span class="hljs-number">5</span></span> image: jwilder/nginx-proxy:alpine ports: - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> volumes: - ./certs:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/certs:ro - ./vhost.d:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/vhost.d - ./html:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>share/nginx/html - <span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:<span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>docker.sock:ro labels: - <span class="hljs-string"><span class="hljs-string">"com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true"</span></span> nginx-proxy-companion: restart: on-failure:<span class="hljs-number"><span class="hljs-number">5</span></span> image: jrcs/letsencrypt-nginx-proxy-companion volumes: - ./certs:<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>nginx/certs:rw - <span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>run/docker.sock:ro volumes_from: - nginx-proxy</code> </pre> </div></div><br><p>  You can go to the directory with nginx-proxy and run <code>docker-compose up</code> you will teach the finished running service, it is very convenient! </p><br><ul><li>  The <code>nginx-proxy</code> container in two words works as follows, it starts listening to <code>docker.sock</code> and if it loads the running container with the variable <code>VIRTUAL_HOST</code> , it will generate a config for this virtual host, with proxying to the virtual ip container. </li><li>  The <code>nginx-proxy-companion</code> container works in a similar way, if it detects a running container with the variable <code>LETSENCRYPT_HOST</code> it automatically receives a certificate for it. </li></ul><br><p>  For more detailed information refer to the official projects page: </p><br><ul><li>  <a href="https://github.com/jwilder/nginx-proxy">nginx-proxy</a> - which will automatically generate a config and proxy all these services. </li><li>  <a href="https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion">nginx-proxy-companion</a> - will receive and update certificates in automatic order. </li></ul><br><p>  Immediately I must warn you, <code>nginx-proxy</code> does not work with <a href="https://docs.docker.com/compose/compose-file/compose-file-v2/">Compose file version 2</a> , because  requires that there is one common network between containers. <br>  So you need to use only <a href="https://docs.docker.com/compose/compose-file/compose-file-v1/">Compose file version 1</a> , or keep all services in one config. </p><br><p>  Now the configs themselves: </p><br><div class="spoiler">  <b class="spoiler_title">for wordpress:</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">mysql:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mariadb:</span></span><span class="hljs-number"><span class="hljs-number">10.0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">hostname:</span></span> mysql <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> - ./<span class="hljs-symbol"><span class="hljs-symbol">mysql:</span></span>/var/lib/mysql <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> - MYSQL_ROOT_PASSWORD=seekac7aexoh2eithut6sie1eYaeNgei - MYSQL_DATABASE=example_org - MYSQL_USER=example_org - MYSQL_PASSWORD=imieth7iev4dah6eeraik6Ohz6oiVup7 <span class="hljs-symbol"><span class="hljs-symbol">wordpress:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> wordpress <span class="hljs-symbol"><span class="hljs-symbol">hostname:</span></span> example.org <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> - ./<span class="hljs-symbol"><span class="hljs-symbol">wordpress:</span></span>/var/www/html <span class="hljs-symbol"><span class="hljs-symbol">links:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">mysql:</span></span>mysql <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=example.org,www.example.org"</span></span> - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_HOST=example.org,www.example.org"</span></span> - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_EMAIL=admin@example.org"</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">for Nextcloud:</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">nextcloud:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> nextcloud <span class="hljs-symbol"><span class="hljs-symbol">hostname:</span></span> cloud <span class="hljs-symbol"><span class="hljs-symbol">domainname:</span></span> example.org <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> - ./<span class="hljs-symbol"><span class="hljs-symbol">nextcloud:</span></span>/var/www/html - <span class="hljs-regexp"><span class="hljs-regexp">/cloud:/cloud</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/data:/data</span></span> <span class="hljs-symbol"><span class="hljs-symbol">links:</span></span> - <span class="hljs-symbol"><span class="hljs-symbol">mysql:</span></span>mysql - <span class="hljs-symbol"><span class="hljs-symbol">redis:</span></span>redis <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=cloud.example.org"</span></span> - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_HOST=cloud.example.org"</span></span> - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_EMAIL=admin@example.org"</span></span> <span class="hljs-symbol"><span class="hljs-symbol">redis:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> redis <span class="hljs-symbol"><span class="hljs-symbol">hostname:</span></span> redis <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mysql:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">mariadb:</span></span><span class="hljs-number"><span class="hljs-number">10.0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">hostname:</span></span> mysql <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> - ./<span class="hljs-symbol"><span class="hljs-symbol">mysql:</span></span>/var/lib/mysql <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> - MYSQL_ROOT_PASSWORD=ei8aiWaeDaeDoo8aida0woaNaiy8deer - MYSQL_DATABASE=nextcloud - MYSQL_USER=nextcloud - MYSQL_PASSWORD=rahGhied8lei6ogh2keitie1chaiheex</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">for Deluge:</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">deluge:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> linuxserver/deluge <span class="hljs-symbol"><span class="hljs-symbol">hostname:</span></span> torrent <span class="hljs-symbol"><span class="hljs-symbol">domainname:</span></span> example.org <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> - ./<span class="hljs-symbol"><span class="hljs-symbol">config:</span></span>/config - <span class="hljs-regexp"><span class="hljs-regexp">/data:/data</span></span> <span class="hljs-symbol"><span class="hljs-symbol">ports:</span></span> - <span class="hljs-number"><span class="hljs-number">53160</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">53160</span></span> - <span class="hljs-number"><span class="hljs-number">53160</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">53160</span></span>/udp - <span class="hljs-number"><span class="hljs-number">8112</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">8112</span></span> - <span class="hljs-number"><span class="hljs-number">58846</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">58846</span></span> - <span class="hljs-number"><span class="hljs-number">6881</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">6881</span></span> <span class="hljs-symbol"><span class="hljs-symbol">expose:</span></span> - <span class="hljs-number"><span class="hljs-number">8112</span></span> <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> - PUID=<span class="hljs-number"><span class="hljs-number">33</span></span> - PGID=<span class="hljs-number"><span class="hljs-number">33</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_HOST=torrent.example.org"</span></span> - <span class="hljs-string"><span class="hljs-string">"VIRTUAL_PORT=8112"</span></span> - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_HOST=torrent.example.org"</span></span> - <span class="hljs-string"><span class="hljs-string">"LETSENCRYPT_EMAIL=admin@example.org"</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">for Emby:</b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">emby:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">restart:</span></span> on-<span class="hljs-symbol"><span class="hljs-symbol">failure:</span></span><span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">image:</span></span> emby/embyserver <span class="hljs-symbol"><span class="hljs-symbol">volumes:</span></span> - <span class="hljs-regexp"><span class="hljs-regexp">/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/etc/localtime</span></span><span class="hljs-symbol"><span class="hljs-symbol">:ro</span></span> - ./<span class="hljs-symbol"><span class="hljs-symbol">config:</span></span>/config - <span class="hljs-regexp"><span class="hljs-regexp">/data:/data</span></span> <span class="hljs-symbol"><span class="hljs-symbol">environment:</span></span> - APP_UID=<span class="hljs-number"><span class="hljs-number">33</span></span> - APP_GID=<span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-symbol"><span class="hljs-symbol">net:</span></span> host</code> </pre> </div></div><br><p>  For emby, I used <code>net: host</code> - this means that the container will use the host network instead of the virtual network for docker.  This step is required for the DLNA server to work.  For the same reason, the <code>VIRTUAL_HOST</code> and <code>LETSENCRYPT_HOST</code> variables are not specified. </p><br><p>  But stand, how to be?  - how to add such a container to <code>nginx-proxy</code> ? <br>  And what if I want to have access to the Proxmox and OpenMediaVault web interfaces?  - and they are started not at all in docker or even on this host. </p><br><p>  The solution didn‚Äôt take a long time to look for itself; for these types of connections, you can create another separate proxy container: </p><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">nginx-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-failure:<span class="hljs-number"><span class="hljs-number">5</span></span> image: nginx expose: - <span class="hljs-number"><span class="hljs-number">80</span></span> environment: - "VIRTUAL_HOST=media.example.org,pve.example.org,nas.example.org" - "LETSENCRYPT_HOST=media.example.org,pve.example.org,nas.example.org" - "LETSENCRYPT_EMAIL=admin@example.org" volumes: - ./<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-config:/etc/nginx/conf.d</code> </pre> </div></div><br><p>  With this config: </p><br><div class="spoiler">  <b class="spoiler_title">local-config / default.conf</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment"># If we receive X-Forwarded-Proto, pass it through; otherwise, pass along the # scheme used to connect to this server map $http_x_forwarded_proto $proxy_x_forwarded_proto { default $http_x_forwarded_proto; '' $scheme; } # If we receive X-Forwarded-Port, pass it through; otherwise, pass along the # server port the client connected to map $http_x_forwarded_port $proxy_x_forwarded_port { default $http_x_forwarded_port; '' $server_port; } # Set appropriate X-Forwarded-Ssl header map $scheme $proxy_x_forwarded_ssl { default off; https on; } access_log off; # HTTP 1.1 support proxy_http_version 1.1; proxy_buffering off; proxy_set_header Host $http_host; proxy_set_header Upgrade $http_upgrade; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $proxy_x_forwarded_proto; proxy_set_header X-Forwarded-Ssl $proxy_x_forwarded_ssl; proxy_set_header X-Forwarded-Port $proxy_x_forwarded_port; # Mitigate httpoxy attack (see README for details) proxy_set_header Proxy ""; server { server_name _; # This is just an invalid value which will never trigger on a real hostname. listen 80; return 503; } # media.example.org server { server_name media.example.org; listen 80 ; location / { proxy_pass http://192.168.100.20:8096/; } } # pve.example.org server { server_name pve.example.org; listen 80 ; location / { proxy_pass https://192.168.100.10:8006/; } } # nas.example.org server { server_name nas.example.org; listen 80 ; location / { proxy_pass http://192.168.100.10:8080/; } }</span></span></code> </pre> </div></div><br><p>  That's all, now you have a NAS with virtualization and several excellent services protected by SSL according to the latest fashion: </p><br><ul><li> <code>https://example.org</code> </li> <li> <code>https://cloud.example.org</code> </li> <li> <code>https://torrent.example.org</code> </li> <li> <code>https://media.example.org</code> </li> <li> <code>https://nas.example.org</code> </li> <li> <code>https://pve.example.org</code> </li> </ul><br><p>  Thank you for your attention and good luck in experiments :) </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328048/">https://habr.com/ru/post/328048/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328036/index.html">How to use push notifications?</a></li>
<li><a href="../328038/index.html">English for interviews in an IT company: what do you need to start a career?</a></li>
<li><a href="../328042/index.html">Functional programming: there are too many ceremonies in Java and C #</a></li>
<li><a href="../328044/index.html">Why we chose the new Angular</a></li>
<li><a href="../328046/index.html">Changes in the rules for advertising newsletters in France: the consent to the distribution by e-mail must be received annually</a></li>
<li><a href="../328050/index.html">There is no</a></li>
<li><a href="../328052/index.html">Boxing and unboxing - which is faster?</a></li>
<li><a href="../328054/index.html">2038: only 21 years left</a></li>
<li><a href="../328056/index.html">Accelerating the restoration of backups in PostgreSQL</a></li>
<li><a href="../328058/index.html">We speed up the restoration of backups in Postgres. Part Two (because shortening the time is not enough)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>