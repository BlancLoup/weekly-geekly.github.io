<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Particle system in Core Animation. Christmas story</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Christmas is long past, but after it we still have an interesting story about how using the infrequently used Core Animation feature, you ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Particle system in Core Animation. Christmas story</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/9s/eo/zq/9seozqwk1lhhha-t9kjesviqs14.jpeg"><br><br>  Hello! <br><br>  Christmas is long past, but after it we still have an interesting story about how using the infrequently used Core Animation feature, you can create a festive mood for users.  I share the translation of the article by my London colleague Alexis. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Christmas has always been one of my favorite days of the year.  It brings into our lives a lot of love, laughter, happiness and magic. <br><br>  I was born and raised in Spain, in Tenerife, a sunny island in the middle of the Atlantic Ocean off the coast of Africa.  And believe me, Christmas in Tenerife is very different from Christmas in London, where I have met him for the past two years (since I started working at Badoo). <br><br>  One of the advantages of living in London for me was the contemplation of snowflakes.  Here I saw them for the first time in my life, it was just incredible! <br><br>  Remembering this, I decided to share with you one interesting story that happened to me in the office shortly before Christmas, before I went to Tenerife to meet the holiday with my family. <br><br>  It so happened that I was assigned one unusual task with the following description: <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/lt/df/wd/ltdfwdnu7xreylndpr6of3vkbt8.png"><br><br>  Hmm, quite entertaining.  We wanted to add a Christmas animation with snowflakes to our iOS application, and I became the lucky one who had to create it.  But I did not know where to start. <br><br>  As usual, a sketch file with the necessary design was linked to the task, which looked like this: <br><br><img src="https://habrastorage.org/webt/_d/q9/tl/_dq9tlxzvrca0jhk0lxjx3rnmhu.png"><br><br>  At a minimum, I saw what we needed, but was not completely sure how these snowflakes should behave.  To clarify all the details, I went to communicate with the designers. <br><br>  As I suspected, they already had a great animation drawn in <a href="https://www.adobe.com/uk/products/aftereffects.html">After Effects</a> . <br><br>  The designers explained to me that they want to add snowflakes falling from above into the already existing animation of the launch of the application (as well as the Santa hat on our logo, but it was a simple substitution of the picture, unworthy of the mention in this article). <br><br>  I knew that the animation of launching an application on iOS was made using <a href="https://github.com/airbnb/lottie-ios">Lottie</a> , since it was added after I joined the company (details can be found in the article <a href="https://badoo.com/techblog/blog/2017/07/12/behind-the-scenes-with-importing-adobe-after-effects-animation-into-badoo-ios-app/">Radek Cieciwa</a> ).  However, I told the designers that I would try to find simpler solutions for displaying snowflakes (without the need to use Lottie) - and began to explore different approaches. <br><br>  This is the animation that my colleague Radek did for Badoo.  Impeccable! <br><br><img src="https://habrastorage.org/webt/8e/cg/jj/8ecgjj7a9ywk34vr-_idw4ckb-a.gif"><br><br>  And this is how I added falling snowflakes.  Want to know how I did it?  You will find the answer below. <br><br><img src="https://habrastorage.org/webt/rq/yd/gh/rqydgh5ar15k2f42kwxusdr3iq4.gif"><br><br><h1>  Particle Systems </h1><br>  While reading various documentation about animations, I remembered that particle systems are often used in games and movies to solve such problems. <br><br>  <a href="https://en.wikipedia.org/wiki/Particle_system">Wikipedia</a> describes this concept fairly accurately: <br><br><blockquote>  ‚ÄúThe particle system is a method used in computer graphics for representing objects that do not have clear geometric boundaries (various clouds, nebulae, explosions, steam jets, rocket plumes, smoke, snow, rain, etc.).  Particle systems can be implemented in both 2D and 3D graphics. ‚Äù </blockquote><br><div class="spoiler">  <b class="spoiler_title">This technique was first used in 1982 in Star Trek 2: Khan's Wrath to create a ‚Äúgenesis effect‚Äù.</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/zXFNypyMJCc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  A particle system consists of one or more graphic primitives, such as points, lines, or images, called particles.  These particles are created and emitted by the emitter, which is part of the particle system. <br><br>  Each particle has a set of parameters that directly or indirectly affect its behavior and determine how it will be drawn.  Particles can move simultaneously in large numbers and in different directions, for example, to create a fluid effect. <br><br>  The animation takes effect when particles are emitted by the system.  The system emits particles in random places within a given particle system area.  It can take various forms: circle, rectangle, sphere, parallelepiped, line, point, etc. <br><br>  The system also determines the properties of particles that affect their geometry, speed, and other parameters.  Different emitter APIs have different names of similar properties. <br><br>  When particles are emitted by the system simultaneously, they create stunning animations that can look like rain, fire or snow. <br><br><img src="https://habrastorage.org/webt/m1/rj/jo/m1rjjoaqdn9cnn5gqkzjnu1o2iw.gif"><img src="https://habrastorage.org/webt/ti/zj/yi/tizjyikmqt6nvvztyycatujepgs.gif"><img src="https://habrastorage.org/webt/3e/vq/4d/3evq4dymfm0o-qaoy8qqs0jhkti.gif"><br><br><h1>  From theory to practice </h1><br>  I thought that Apple most likely has built-in support for a particle system in one of its frameworks.  And the results of my searches have shown that I am right. <br><br>  The particle system is part of the Core Animation framework and is well described in the <a href="https://developer.apple.com/documentation/quartzcore/caemitterlayer">CAEmitterLayer</a> and <a href="https://developer.apple.com/documentation/quartzcore/caemittercell">CAEmitterCell classes</a> . <br><br>  After studying all the necessary information about the particle system and the supported APIs on iOS, I proceeded to my favorite part - the realization of our idea. <br><br>  Unfortunately, Christmas is not forever, so we needed the ability to turn off snowflakes remotely after December 25th. <br><br>  As I mentioned above, the app's launch animation was implemented using Lottie.  That is, I had to find a way to add snowflakes in such a way that it did not affect the existing animation and its code, because my decision had to be removed immediately after the release. <br><br>  I found a very simple way to do this - I added a new transparent UIView to show the snowflakes in front of the existing animation and background and then controlled its appearance remotely using a flag. <br><br><img src="https://habrastorage.org/webt/rm/_l/zk/rm_lzk5j94unwv3h5lqj9mqv65a.png"><br><br>  The image above shows the UIView that was used in the final solution: <br><br><ol><li>  <b>UIView</b> with a particle system that emitted snowflakes. <br></li><li>  <b>UIViews</b> used in the Lottie-run application animation. <br></li></ol><br><br>  After this problem was solved, I had to create a component that contains the logic of particle emission for generating animated snowflakes. <br><br>  For a start, I needed images of snowflakes that I could use as content for the emitter.  They should be pretty simple, right? <br><br>  Each snowflake was either a regular or blurred white circle.  I created them myself in Sketch. <br><br><img src="https://habrastorage.org/webt/9p/va/zd/9pvazdqkilhjtvjtidqvl1nwsh4.png" width="500"><br><br><h1>  Some implementation details </h1><br>  CAEmitterLayer is a special CALayer that creates, animates and draws a particle system.  It allows you to control your geometry, position, drawing mode, and more. <br><br>  I started developing animation with layer creation: <br><br><pre><code class="swift hljs">snowEmitterLayer.emitterShape = <span class="hljs-type"><span class="hljs-type">CAEmitterLayerEmitterShape</span></span>.line snowEmitterLayer.beginTime = <span class="hljs-type"><span class="hljs-type">CACurrentMediaTime</span></span>() snowEmitterLayer.timeOffset = <span class="hljs-number"><span class="hljs-number">10.0</span></span></code> </pre> <br>  I needed to change only three properties: <br><br><ul><li>  <b>emitterShape</b> : defines the shape of the layer.  I used a line that allowed snowflakes to appear along the entire screen; <br></li><li>  <b>beginTime</b> : is part of the CAMediaTiming protocol and represents the time when the animation of the layer begins relative to the animations of the parent layer; <br></li><li>  <b>timeOffset</b> : is also part of the CAMediaTiming protocol and, in fact, is a rewind of the animation forward for a specified time relative to its beginning.  I indicated a value of 10 seconds, which led to the fact that when the animation started, the snowflakes already covered the screen entirely, and this is exactly what we wanted (if I indicated a value of 0 seconds, then the snowflakes would start to appear on top and cover the screen entirely only after some time). <br></li></ul><br>  Having a ready layer, I created two different emitters: for snowflakes heavier and for snowflakes easier. <br><br>  For heavy snowflakes, I configured the emitter as follows: <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> flakeEmitterCell = <span class="hljs-type"><span class="hljs-type">CAEmitterCell</span></span>() flakeEmitterCell.contents = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>(named: <span class="hljs-string"><span class="hljs-string">"snowflake_dot"</span></span>)!.cgImage flakeEmitterCell.emissionRange = .pi flakeEmitterCell.lifetime = <span class="hljs-number"><span class="hljs-number">20.0</span></span> flakeEmitterCell.birthRate = <span class="hljs-number"><span class="hljs-number">30</span></span> flakeEmitterCell.scale = <span class="hljs-number"><span class="hljs-number">0.15</span></span> flakeEmitterCell.scaleRange = <span class="hljs-number"><span class="hljs-number">0.6</span></span> flakeEmitterCell.velocity = <span class="hljs-number"><span class="hljs-number">30.0</span></span> flakeEmitterCell.velocityRange = <span class="hljs-number"><span class="hljs-number">20</span></span> flakeEmitterCell.spin = -<span class="hljs-number"><span class="hljs-number">0.5</span></span> flakeEmitterCell.spinRange = <span class="hljs-number"><span class="hljs-number">1.0</span></span> flakeEmitterCell.yAcceleration = <span class="hljs-number"><span class="hljs-number">30.0</span></span> flakeEmitterCell.xAcceleration = <span class="hljs-number"><span class="hljs-number">5.0</span></span></code> </pre> <br>  As you can see, I had to change a significant amount of properties, each of which is very important to achieve the desired effect: <br><br><ul><li>  <b>contents</b> : CGImage, used to display one snowflake (as you remember, this is one of those images that I created on my own); <br></li><li>  <b>emissionRange</b> : angle in radians defining a cone within which particles will appear (I chose the angle PI so that the particles are visible on the whole screen); <br></li><li>  <b>lifetime</b> : determines the lifetime of a single particle; <br></li><li>  <b>birthRate</b> : determines the number of particles emitted every second; <br></li><li>  <b>scale</b> and <b>scaleRange</b> : affects the size of the particles, where the value 1.0 is the maximum size;  the interval determines the deviations in size between the created particles, which allows to emit particles of random sizes; <br></li><li>  <b>velocity</b> and <b>velocityRange</b> : affects the rate of appearance of particles;  deviates randomly within the value specified in the velocityRange; <br></li><li>  <b>spin</b> and <b>spinRange</b> : affect the speed of rotation, measured in radians per second, and the random deviation within the limits of the value specified in spinRange; <br></li><li>  <b>yAcceleration</b> and <b>xAcceleration</b> : these are the two components of the acceleration vector applied to the emitter. <br></li></ul><br>  I also needed a second emitter to create light snowflakes.  All properties remained unchanged, except for two: <br><br><ul><li>  <b>contents</b> : here I used images with a blurred circle; <br></li><li>  <b>velocity</b> : and here I had to reduce the speed of falling to give lightness to the snowflakes. <br></li></ul><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> blurryFlakeEmitterCell = <span class="hljs-type"><span class="hljs-type">CAEmitterCell</span></span>() blurryFlakeEmitterCell.contents = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>(named: <span class="hljs-string"><span class="hljs-string">"snowflake_blurry_dot"</span></span>)?.cgImage blurryFlakeEmitterCell.velocity = <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-comment"><span class="hljs-comment">//     </span></span></code> </pre> <br>  It only remained for me to connect the layer and the emitters, which turned out to be very easy: <br><br><pre> <code class="swift hljs">snowEmitterLayer.emitterCells = [flakeEmitterCell, blurryFlakeEmitterCell] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.layer.addSublayer(snowEmitterLayer)</code> </pre><br><h1>  Conclusion </h1><br>  I quickly created a working version with falling snowflakes, which looked very good.  It was quite simple to implement and did not change the existing code.  I showed it to the designers, and they really liked it. <br><br>  Animations created with a particle system can be quite impressive and relatively easy to implement if you own the right tools. <br><br>  More information about particle systems can be found in the following sources: <br><br><ul><li>  <a href="https://en.wikipedia.org/wiki/Particle_system">Wikipedia</a> </li><li>  <a href="https://www.raywenderlich.com/1255-scene-kit-tutorial-with-swift-part-5-particle-systems">Ray wenderlich</a> </li><li>  <a href="https://docs.unity3d.com/Manual/PartSysWhatIs.html">Unity</a> </li><li>  <a href="https://web.cs.wpi.edu/~matt/courses/cs563/talks/psys.html">Allen Martin on particle systems</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/446938/">https://habr.com/ru/post/446938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446920/index.html">Reverse Development of April Fools' Snake by Google</a></li>
<li><a href="../446922/index.html">Cat under the hood. Part 2</a></li>
<li><a href="../446924/index.html">Representation of arbitrary polynomials in the form of finite differences with an arbitrary step</a></li>
<li><a href="../446926/index.html">‚ÄúSo I realized that I am now a data engineer, and in a different way I can position myself on the market‚Äù</a></li>
<li><a href="../446932/index.html">TDMS Fairway and BIM</a></li>
<li><a href="../446940/index.html">QA for sale. Why is it cool</a></li>
<li><a href="../446944/index.html">Why invest in loss-making companies?</a></li>
<li><a href="../446948/index.html">How Android Trojan Gustuff removes cream (fiat and crypt) from your accounts</a></li>
<li><a href="../446950/index.html">76% of manufacturers do not have experience in adding additive - why it‚Äôs good</a></li>
<li><a href="../446952/index.html">Create animated histograms with R</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>