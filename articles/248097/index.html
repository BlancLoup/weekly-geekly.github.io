<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ethernet over USB to STM32F4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, the idea arose of making the board based on the MK STM32F4 work on a network. Since there was no Ethernet PHY controller onboard, the only o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ethernet over USB to STM32F4</h1><div class="post__text post__text-html js-mediator-article"><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/W_o0lPivqsA%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700190,15700253,15700259&amp;usg=ALkJrhhgEV3zpGej4prclOmvSyeH-CHaAQ" frameborder="0" allowfullscreen=""></iframe><br><br>  Recently, the idea arose of making the board based on the MK STM32F4 work on a network.  Since there was no Ethernet PHY controller onboard, the only option was to use the USB FullSpeed ‚Äã‚Äãinterface to emulate an Ethernet device.  A common USB class standard that implements this function is called RNDIS. <br>  To his chagrin, the search for RNDIS driver for the STM32 was not successful.  However, this was not surprising, since  Open examples of using the USB port of the STM32 are limited only to those provided by the manufacturer. <br>  I wanted to correct this injustice.  And at the same time to fuck the necessary source, good in the future they will be useful. <br>  Now, when the demo version of the library is ready, I post it to the public as a MIT license.  Therefore, all who are interested in the library - use the "health."  <a href="https://github.com/fetisov/lrndis">The library</a> has the name LRNDIS, the first letter of which means using the network stack for embedded systems "LwIP". <br>  To demonstrate the capabilities of the library, an example was created on the stm32f4discovery board.  His job is to support basic services (DHCP and DNS servers) and transfer usb host to the requested WEB pages.  Thus, our discovery has turned into an almost full-fledged WEB-server that works on the USB port! <br>  A few words on where applicable. <br>  In everyday life, RNDIS devices are usually USB modems for Internet access.  Perhaps such an application would indeed be useful if the developer chooses the STM32 as a connecting chain between the PC and the radio frequency (or other) transceiver.  Or, maybe, it will want to expand own network on an Ethernet segment? <br>  Another application in which I find the main benefit for myself is the interface for managing complex devices.  A typical solution in this area is the creation of terminal software.  In this case, you have to deal with its support along with the support of the device, which can be inconvenient.  Actually, in the rejection of such a scheme in favor of the managing Web-interface is the meaning of the possible use of the library.  Recall the web interfaces for setting up routers.  Conveniently.  Handsomely.  Without too much software. <br><br>  So, if you are interested, read on ... <br><a name="habracut"></a><br><h4>  1. RNDIS driver </h4><br>  At the writing stage, two tasks were solved: sign our device and maintain the RNDIS standard. <br>  Signature of the device is reduced to the compilation of correct USB descriptors.  VID value is 0x0483 (STMicroelectronics), PID value is 0x0123 (arbitrary).  Needless to say, in a commercial application should not do so. <br><div class="spoiler">  <b class="spoiler_title">View Handles</b> <div class="spoiler_text"><table><tbody><tr><td colspan="5">  <b>Device descriptor</b> </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  12h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  01h </td><td>  Device </td></tr><tr><td>  2 </td><td>  bcdUSB </td><td>  2 </td><td>  0200h </td><td>  USB Spec 2.0 </td></tr><tr><td>  four </td><td>  bDeviceClass </td><td>  one </td><td>  02h </td><td>  CDC Control </td></tr><tr><td>  five </td><td>  bDeviceSubClass </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  6 </td><td>  bDeviceProtocol </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  7 </td><td>  bMaxPacketSize0 </td><td>  one </td><td>  40h </td><td>  64 bytes </td></tr><tr><td>  eight </td><td>  idVendor </td><td>  2 </td><td>  0483h </td><td>  SGS Thomson Microelectronics </td></tr><tr><td>  ten </td><td>  idProduct </td><td>  2 </td><td>  0123h </td><td></td></tr><tr><td>  12 </td><td>  bcdDevice </td><td>  2 </td><td>  0001h </td><td>  0.01 </td></tr><tr><td>  14 </td><td>  iManufacturer </td><td>  one </td><td>  01h </td><td>  "Fetisov Sergey" </td></tr><tr><td>  15 </td><td>  iProduct </td><td>  one </td><td>  02h </td><td>  "STM32F4 RNDIS" </td></tr><tr><td>  sixteen </td><td>  iSerialNumber </td><td>  one </td><td>  03h </td><td>  "00000000123C" </td></tr><tr><td>  17 </td><td>  bNumConfigurations </td><td>  one </td><td>  01h </td><td></td></tr><tr><td colspan="5">  <b>Configuration Descriptor 1</b> </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  09h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  02h </td><td>  Configuration </td></tr><tr><td>  2 </td><td>  wTotalLength </td><td>  2 </td><td>  0043h </td><td></td></tr><tr><td>  four </td><td>  bNumInterfaces </td><td>  one </td><td>  02h </td><td></td></tr><tr><td>  five </td><td>  bConfigurationValue </td><td>  one </td><td>  01h </td><td></td></tr><tr><td>  6 </td><td>  iConfiguration </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  7 </td><td>  bmAttributes </td><td>  one </td><td>  40h </td><td>  Self powered </td></tr><tr><td>  eight </td><td>  bMaxPower </td><td>  one </td><td>  01h </td><td>  2 mA </td></tr><tr><td colspan="5">  <b>Interface Descriptor 0/0</b> CDC Control, 1 Endpoint </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  09h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  04h </td><td>  Interface </td></tr><tr><td>  2 </td><td>  bInterfaceNumber </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  3 </td><td>  bAlternateSetting </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  four </td><td>  bNumEndpoints </td><td>  one </td><td>  01h </td><td></td></tr><tr><td>  five </td><td>  bInterfaceClass </td><td>  one </td><td>  02h </td><td>  CDC Control </td></tr><tr><td>  6 </td><td>  bInterfaceSubClass </td><td>  one </td><td>  02h </td><td>  Abstract Control Model </td></tr><tr><td>  7 </td><td>  bInterfaceProtocol </td><td>  one </td><td>  FFh </td><td>  Vendor-specific </td></tr><tr><td>  eight </td><td>  iInterface </td><td>  one </td><td>  00h </td><td></td></tr><tr><td colspan="5">  <b>Header Functional Descriptor</b> </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bFunctionLength </td><td>  one </td><td>  05h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  24h </td><td>  CS Interface </td></tr><tr><td>  2 </td><td>  bDescriptorSubtype </td><td>  one </td><td>  00h </td><td>  Header </td></tr><tr><td>  3 </td><td>  bcdCDC </td><td>  2 </td><td>  0110h </td><td>  1.10 </td></tr><tr><td colspan="5">  <b>Call Management Functional Descriptor</b> </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bFunctionLength </td><td>  one </td><td>  05h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  24h </td><td>  CS Interface </td></tr><tr><td>  2 </td><td>  bDescriptorSubtype </td><td>  one </td><td>  01h </td><td>  Call management </td></tr><tr><td>  3 </td><td>  bmCapabilities </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  four </td><td>  bDataInterface </td><td>  one </td><td>  01h </td><td></td></tr><tr><td colspan="5">  <b>Abstract Control Management Functional Descriptor</b> </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bFunctionLength </td><td>  one </td><td>  04h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  24h </td><td>  CS Interface </td></tr><tr><td>  2 </td><td>  bDescriptorSubtype </td><td>  one </td><td>  02h </td><td>  Abstract Control Management </td></tr><tr><td>  3 </td><td>  bmCapabilities </td><td>  one </td><td>  00h </td><td>  Requests / notifications not supported </td></tr><tr><td colspan="5">  <b>Union Functional Descriptor</b> </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bFunctionLength </td><td>  one </td><td>  05h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  24h </td><td>  CS Interface </td></tr><tr><td>  2 </td><td>  bDescriptorSubtype </td><td>  one </td><td>  06h </td><td>  Union </td></tr><tr><td>  3 </td><td>  bControlInterface </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  four </td><td>  bSubordinateInterface0 </td><td>  one </td><td>  01h </td><td>  CDC Data </td></tr><tr><td colspan="5">  <b>Endpoint Descriptor 81</b> 1 In, Interrupt, 80 ms </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  07h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  05h </td><td>  Endpoint </td></tr><tr><td>  2 </td><td>  bEndpointAddress </td><td>  one </td><td>  81h </td><td>  1 In </td></tr><tr><td>  3 </td><td>  bmAttributes </td><td>  one </td><td>  03h </td><td>  Interrupt </td></tr><tr><td>  four </td><td>  wMaxPacketSize </td><td>  2 </td><td>  0008h </td><td>  8 bytes </td></tr><tr><td>  6 </td><td>  bInterval </td><td>  one </td><td>  50h </td><td>  80 ms </td></tr><tr><td colspan="5">  <b>Interface Descriptor 1/0</b> CDC Data, 2 Endpoints </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  09h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  04h </td><td>  Interface </td></tr><tr><td>  2 </td><td>  bInterfaceNumber </td><td>  one </td><td>  01h </td><td></td></tr><tr><td>  3 </td><td>  bAlternateSetting </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  four </td><td>  bNumEndpoints </td><td>  one </td><td>  02h </td><td></td></tr><tr><td>  five </td><td>  bInterfaceClass </td><td>  one </td><td>  0Ah </td><td>  CDC Data </td></tr><tr><td>  6 </td><td>  bInterfaceSubClass </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  7 </td><td>  bInterfaceProtocol </td><td>  one </td><td>  00h </td><td></td></tr><tr><td>  eight </td><td>  iInterface </td><td>  one </td><td>  00h </td><td></td></tr><tr><td colspan="5">  <b>Endpoint Descriptor 82</b> 2 In, Bulk, 64 bytes </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  07h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  05h </td><td>  Endpoint </td></tr><tr><td>  2 </td><td>  bEndpointAddress </td><td>  one </td><td>  82h </td><td>  2 In </td></tr><tr><td>  3 </td><td>  bmAttributes </td><td>  one </td><td>  02h </td><td>  Bulk </td></tr><tr><td>  four </td><td>  wMaxPacketSize </td><td>  2 </td><td>  0040h </td><td>  64 bytes </td></tr><tr><td>  6 </td><td>  bInterval </td><td>  one </td><td>  00h </td><td></td></tr><tr><td colspan="5">  <b>Endpoint Descriptor 03</b> 3 Out, Bulk, 64 bytes </td></tr><tr><th>  Offset </th><th>  Field </th><th>  Size </th><th>  Value </th><th>  Description </th></tr><tr><td>  0 </td><td>  bLength </td><td>  one </td><td>  07h </td><td></td></tr><tr><td>  one </td><td>  bDescriptorType </td><td>  one </td><td>  05h </td><td>  Endpoint </td></tr><tr><td>  2 </td><td>  bEndpointAddress </td><td>  one </td><td>  03h </td><td>  3 out </td></tr><tr><td>  3 </td><td>  bmAttributes </td><td>  one </td><td>  02h </td><td>  Bulk </td></tr><tr><td>  four </td><td>  wMaxPacketSize </td><td>  2 </td><td>  0040h </td><td>  64 bytes </td></tr><tr><td>  6 </td><td>  bInterval </td><td>  one </td><td>  00h </td><td></td></tr></tbody></table><br></div></div><br>  Support standard implemented in accordance with the <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff570659%2528v%3Dvs.85%2529.aspx">documentation</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also on the network there are many RNDIS-drivers for other platforms ( <a href="">1</a> , <a href="">2</a> , <a href="">3</a> ), which greatly simplified development. <br>  In the exchange part, the driver repeats the feature of the CDC class with the exception that the transmitted packets are wrapped with service information.  There is also a special interface for sending requests from a usb host in order to configure the device or obtain its status.  Detailed driver code can be studied in the usbd_rndis_core.c module. <br>  The minimum driver setting for embedding is to change the definitions in the usbd_rndis_core.h file. <br>  - MAC address of the device (PERMANENT_HWADDR, STATION_HWADDR) <br>  - Manufacturer ID (RNDIS_VENDOR) <br>  - MTU value (ETH_MTU): <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_MTU 1500 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// MTU value #define ETH_LINK_SPEED 250000 // bits per sec #define RNDIS_VENDOR "fetisov" // NIC vendor name #define STATION_HWADDR 0x20,0x89,0x84,0x6A,0x96,0xAA // station MAC #define PERMANENT_HWADDR 0x20,0x89,0x84,0x6A,0x96,0xAA // permanent MAC</span></span></span></span></code> </pre> <br>  Also in the usbd_desc.h file you should change the product name (USBD_PRODUCT_STRING) and manufacturer (USBD_MANUFACTURER_STRING). <br><br>  The process of installing the driver in Windows: <br><br><img src="https://habrastorage.org/files/5dc/bc1/49d/5dcbc149db9342afb344db2a801a0251.png"><br><br>  1. The menu item "update driver"; <br>  2. Run a driver search; <br>  3. Select a driver from the list; <br>  4. In the list of device classes, select "Network adapters"; <br>  5. In the list of manufacturers, select "Microsoft Corporation"; <br>  6. And the product "Remote NDIS based Internet Sharing Device". <br><br>  In more detail the process of installing a standard RNDIS device is described <a href="http://developer.toradex.com/knowledge-base/how-to-install-microsoft-rndis-driver-for-windows-7">here</a> . <br><br><h4>  2. We fasten LwIP </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/2c2/9d6/4bc/2c29d64bc93af68e723341f5e4eade50.jpg"><br><br>  The RNDIS driver provides only the transport function for 802.3 (Ethernet) frames.  Obviously, support for the full diversity of packages and standards is required to be placed on the network stack.  In his role, it was decided to use the popular stack for embedded systems <a href="http://savannah.nongnu.org/projects/lwip/">lwip</a> latest (currently) version 1.4.1.  We must pay tribute to the authors of the stack, which turned out to be very easy to integrate.  With all this, the stack code is rich in useful comments and instructions. <br><br><blockquote>  The TCP / IP protocol suite has been continued developed. <br>  While IP TCP TCP TCP TCP / IP  It also makes it possible to use it. <br>  Main features include: <br>  - Protocols: IP, ICMP, UDP, TCP, IGMP, ARP, PPPoS, PPPoE <br>  - DHCP client, DNS client, AutoIP / APIPA (Zeroconf), SNMP agent (private MIB support) <br>  - APIs: specialized APIs for enhanced performance, optional Berkeley-alike socket API <br>  - Extended features: IP forwarding and recovery / retransmit <br>  - Addon applications: HTTP server, SNTP client, SMTP client, ping, NetBIOS nameserver </blockquote><br>  Running the stack under stm32 limited itself to including a specific set of source files in the build process and entering definitions in the lwipopts.h file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NO_SYS 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_RAW 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_NETCONN 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_SOCKET 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_DHCP 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_ICMP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_UDP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_TCP 1 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETH_PAD_SIZE 0 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LWIP_IP_ACCEPT_UDP_PORT(p) ((p) == PP_NTOHS(67)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MEM_SIZE 10000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> TCP_MSS (1500 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*mtu*/</span></span></span><span class="hljs-meta"> - 14 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*ethhdr*/</span></span></span><span class="hljs-meta"> - 20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*iphdr*/</span></span></span><span class="hljs-meta"> - 20 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/*tcphhr*/</span></span></span><span class="hljs-meta">) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ETHARP_SUPPORT_STATIC_ENTRIES 1</span></span></code> </pre><br>  It should be noted that the work on porting the stack to the STM32F4 was done <a href="http://www.st.com/web/en/catalog/tools/PF257906">before</a> by STMicroelectronics (application STSW-STM32070). <br><br><h4>  We start the DHCP server </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/bba/fc1/27c/bbafc127c9d800eda02f8c5ced0030d2.png"><br><br>  Adding a DHCP server to the library is associated with the need to initialize the network interface on the host side.  By default, the interface created when the device is connected is configured to automatically receive an ip-address.  The library also works successfully with static addressing, but this is not very convenient. <br><br>  Unfortunately, among the tools supplied by lwip, there is no DHCP server. <br><br>  However, this is not a significant problem, because  In its minimal implementation, the DHCP server is very minimalistic. <br><br>  The network is, perhaps, the only <a href="https://lists.gnu.org/archive/html/lwip-users/2012-12/msg00016.html">example of a</a> DHCP server that works with the lwip stack.  This source turned out to be very useful for studying, although not suitable for embedding on the ‚Äúas-is‚Äù principle due to the lack of configuration and use of socket-api. <br><br>  Therefore, it was decided to write a DHCP server. <br><br>  And here are his modest features: <br>  - issuing addresses at any time <br>  - reservation of addresses by MAC address <br>  - DNS server setup <br><br>  Server connection in the test project: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NUM_DHCP_ENTRY 3 static dhcp_entry_t entries[NUM_DHCP_ENTRY] = { </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// mac ip address subnet mask lease time { {0}, {192, 168, 7, 2}, {255, 255, 255, 0}, 24 * 60 * 60 }, { {0}, {192, 168, 7, 3}, {255, 255, 255, 0}, 24 * 60 * 60 }, { {0}, {192, 168, 7, 4}, {255, 255, 255, 0}, 24 * 60 * 60 } }; static dhcp_config_t dhcp_config = { {192, 168, 7, 1}, 67, // server address, port {192, 168, 7, 1}, // dns server "stm", // dns suffix NUM_DHCP_ENTRY, // num entry entries // entries }; int main(void) { ... while (dhserv_init(&amp;dhcp_config) != ERR_OK) ; ... }</span></span></span></span></code> </pre><br><br><h4>  We start the DNS server </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/9f2/047/d0e/9f2047d0ea975f81c0992747c3155a89.png"><br><br>  The desired result of our work is the display of a web page when you enter some resource name in the browser.  However, this is only possible if there is a DNS server that will ‚Äúknow‚Äù about our host.  Of course, this result is available if you directly enter the ip-address in the address bar: <a href="http://192.168.7.1/">192.168.7.1</a> .  This address is the default of our device.  However, we will be more adept and run the DNS server. <br><br>  Unlike DHCP, the current implementation of the DNS server is even "thinner."  At the moment, it allows you to process only standard DNS requests for one record. <br><br>  Running the server in the project: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dns_query_proc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ip_addr_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(name, <span class="hljs-string"><span class="hljs-string">"run.stm"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span> || <span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(name, <span class="hljs-string"><span class="hljs-string">"www.run.stm"</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { addr-&gt;addr = *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> *)ipaddr; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (dnserv_init(PADDR(ipaddr), <span class="hljs-number"><span class="hljs-number">53</span></span>, dns_query_proc) != ERR_OK) ; ... }</code> </pre><br><br><h4>  We start the HTTP server </h4><br>  I had to struggle for a long time and to no avail with the launch of the famous server from the lwip package ‚Äúcontrib-1.4.1‚Äù.  Until now, the mysterious HardFault that appears on a seemingly level spot remains a mystery to me.  All settings, addresses of reading and writing, stack depth were checked ... But, alas. <br><br>  Later, I started writing a working http server and HardFault repeated when I was accessing the memory area allocated by the mem_malloc function.  In this case, the addresses were valid and belonged to the internal RAM.  In general, I happily said goodbye to dynamic allocation and began to use static in the server.  However, the question of the reason for HardFault remains open, and therefore it must be borne in mind that using the lwip functions of mem_ * in the current version of the library is not safe. <br><br>  So, the result was still obtained. <br><br>  HTTP server enable code: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my_page_t</span></span> my_pages[] = { { <span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, MIME_TEXT_HTML, page1_html, page1_html_size }, { <span class="hljs-string"><span class="hljs-string">"/page2.htm"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, MIME_TEXT_HTML, page2_html, page2_html_size }, { <span class="hljs-string"><span class="hljs-string">"/page3.htm"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, MIME_TEXT_HTML, page3_html, page3_html_size }, { <span class="hljs-string"><span class="hljs-string">"/check.gif"</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, MIME_IMAGE_GIF, check_png, check_png_size }, { <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-number"><span class="hljs-number">404</span></span>, MIME_TEXT_HTML, page_not_found, page_not_found_size } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_http_req</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">http_req_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">http_resp_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *resp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **arg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">my_page_t</span></span> *page; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (page = my_pages; page-&gt;uri != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; page++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">strcmp</span></span>(page-&gt;uri, req-&gt;uri) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; resp-&gt;code = page-&gt;code; resp-&gt;cont_len = page-&gt;size; resp-&gt;mime = page-&gt;mime; resp-&gt;conn_type = CT_CLOSE; *arg = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)page; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http_write_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; HTTP_SERVER_MAX_CON; i++) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">htcon_t</span></span> *con; <span class="hljs-keyword"><span class="hljs-keyword">my_page_t</span></span> *page; con = htcon(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (con == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; page = (<span class="hljs-keyword"><span class="hljs-keyword">my_page_t</span></span> *)con-&gt;arg; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (con-&gt;state == CON_CLOSED) { htcon_free(i); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (con-&gt;state != CON_ACTIVE) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; n = page-&gt;size - con-&gt;writed; htcon_write(i, (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)page-&gt;data + con-&gt;writed, n); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ... htserv_on_req = on_http_req; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (htserv_init(<span class="hljs-number"><span class="hljs-number">80</span></span>) != ERR_OK) ; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) { stmr(); <span class="hljs-comment"><span class="hljs-comment">// call software timers usb_polling(); // usb device polling http_write_data(); // writes http response } }</span></span></code> </pre><br><br><h4>  Unsolved Issues </h4><br>  1. Newns relicensing stack lwip, which may have its own conditions for inclusion in the other software; <br>  2. The problem with working under Linux; <br>  3. Adding POST request processing; <br>  4. Revision of the DNS server to handle "multi-query" packets; <br>  5. The problem with mem_malloc. </div><p>Source: <a href="https://habr.com/ru/post/248097/">https://habr.com/ru/post/248097/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248087/index.html">10 important lessons that I learned during my project A Year of Productivity (year of productivity)</a></li>
<li><a href="../248089/index.html">Vulnerability MS14-063 in the FastFat driver in Windows OS. Debriefing</a></li>
<li><a href="../248091/index.html">02 Links for UX-specialists</a></li>
<li><a href="../248093/index.html">How we build a message handling system</a></li>
<li><a href="../248095/index.html">Update Windows 8.1 Evaluation and Windows Server 2012 R2 Evaluation to full versions</a></li>
<li><a href="../248099/index.html">Pointer Checker: check our pointers</a></li>
<li><a href="../248101/index.html">Simple bot for Skype on C ++ Qt (ActiveX)</a></li>
<li><a href="../248103/index.html">How to make QML friends with someone else's OpenGL context. Part II: Loading QML</a></li>
<li><a href="../248105/index.html">Internet test drive "Mechatronics and Robotics". Need help from the Community</a></li>
<li><a href="../248111/index.html">We write fast and economical JavaScript code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>