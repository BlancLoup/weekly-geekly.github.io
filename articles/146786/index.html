<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>True TrueType font names and export to PDF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the book of Ursula Le Guin “The Wizard of Earthsea” magic required knowledge of the “true name” of what the magician works with. I think any progra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>True TrueType font names and export to PDF</h1><div class="post__text post__text-html js-mediator-article">  In the book of Ursula Le Guin “The Wizard of Earthsea” magic required knowledge of the “true name” of what the magician works with.  I think any programmer will agree that the idea is sound.  URLs, UUIDs, and other unique object identifiers are what we deal with all the time.  And, just like in the wizarding world, these true names are not so easy to learn.  At least for font names it is. <br><a name="habracut"></a><br>  I needed to implement in our software product the export of text blocks to PDF.  For export, proprietary libraries of the Adobe PDF Library (http://datalogics.com/products/pdfl/) and the DLI (Datalogics Library Interface) add-on are used.  I will not delve into these libraries, I think they are of little interest to anyone.  But I suppose that the problem I encountered is common for any implementation of PDF export. <br><br>  Each font (take, for example, Arial) has 4 different styles - regular, bold, oblique and bold oblique.  Those.  Arial, Arial Bold, Arial Italic and Arial Bold Italic.  Each style is stored in a separate TTF file or in a separate section of the TTC file.  And if we want to output an oblique or bold font to a PDF file, we must explicitly specify “Arial Italic” or “Arial Bold” in the call to the corresponding function.  But in the text block that we export, it is indicated that its font is “Arial” and the attributes Bold and Italic are set separately.  And EnumFontsFamiliesEx returns only the name “Arial” to us and that's it!  How to get the string “Arial Italic” we need? <br><br>  The obvious solution — simply assigning the “Italic” line to the font name — does not always work.  For example, it does not work with the “Lucida Sans Typewriter” font.  The PDF library gives an error if we transfer “Lucida Sans Typewriter Italic”. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The key to the solution (pun) is HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Fonts.  It is enough to look at the contents of this key and it becomes clear that it was necessary to transmit “Lucida Sans Typewriter Oblique”.  Then everything works. <br>  The format of records in this key is not documented anywhere, but, it seems, is obvious: <br><br>  "Arial (TrueType)" = "arial.ttf" <br>  "Arial Italic (TrueType)" = "ariali.ttf" <br>  "Arial Bold (TrueType)" = "arialbd.ttf" <br>  "Arial Bold Italic (TrueType)" = "arialbi.ttf" <br>  "Batang &amp; BatangChe &amp; Gungsuh &amp; GungsuhChe (TrueType)" = "batang.ttc" <br>  ... <br>  "Mangal (TrueType)" = "mangal.ttf" <br>  "Mangal Bold (TrueType)" = "mangalb.ttf" <br>  "Meiryo &amp; Meiryo Italic &amp; Meiryo UI &amp; Meiryo UI Italic (TrueType)" = "meiryo.ttc" <br>  "Meiryo Bold &amp; Meiryo Bold Italic &amp; Meiryo UI Bold &amp; Meiryo UI Bold Italic (TrueType)" = "meiryob.ttc" <br>  "MS Gothic &amp; MS PGothic &amp; MS UI Gothic (TrueType)" = "msgothic.ttc" <br>  ... <br>  "Lucida Sans Typewriter Regular (TrueType)" = "LTYPE.TTF" <br>  "Lucida Sans Typewriter Bold (TrueType)" = "LTYPEB.TTF" <br>  "Lucida Sans Typewriter Bold Oblique (TrueType)" = "LTYPEBO.TTF" <br>  "Lucida Sans Typewriter Oblique (TrueType)" = "LTYPEO.TTF" <br><br>  It can be seen that for TTC collections the fonts contained in them are indicated by “&amp;“. <br><br>  The algorithm for establishing the correspondence between the common font name and the names of the faces is as follows: for each name of the font, we cut one word at a time from the end, until the remainder matches any name obtained from EnumFontsFamiliesEx.  In addition, we check the cut off words for coincidence with the words “Bold”, “Ilalic”, “Semibold”, “Oblique” and remember the corresponding attribute for this shape.  For example, for the “Lucida Sans Typewriter” family: <br><br>  Lucida Sans Typewriter Regular -&gt; Lucida Sans Typewriter <br>  Lucida Sans Typewriter Bold -&gt; <b>Lucida Sans Typewriter</b> <br>  Lucida Sans Typewriter Oblique -&gt; <i>Lucida Sans Typewriter</i> <br>  Lucida Sans Typewriter Bold Oblique -&gt; <i>Lucida Sans Typewriter Bold</i> -&gt; <b><i>Lucida Sans Typewriter</i></b> <br><br>  Now, if you want to print the font “Lucida Sans Typewriter” bold and oblique, then we know that the name “Lucida Sans Typewriter Bold Oblique” corresponds to this style and transfer this name to the PDF library. <br><br>  Here, however, waiting for another trouble.  For example, the font “Mangal” has only a bold outline (“Mangal Bold”), but it does not have an inclined one.  Although we can put the attribute “oblique” to this font and Windows GDI in this case will independently distort the existing face when displayed on the screen.  When exporting to PDF, you have to do it yourself.  The PDF library may allow you to specify a transformation matrix for text output.  For example, in my case, it looked like this: <br><br>  ASFixedMatrix fontSkew; <br>  if (bSimulateItalic) <br>  { <br>  double angle = 15; <br>  fontSkew.a = fixedOne;  // x scale <br>  fontSkew.b = fixedZero;  // rotate &amp; skew <br>  fontSkew.c = FloatToASFixed (tan (_PI * angle / 180));  // rotate &amp; skew <br>  fontSkew.d = fixedOne;  // y scale <br>  fontSkew.h = 0;  // x translation <br>  fontSkew.v = 0;  // y translation <br>  dlpdfcontentfontskew (..., &amp; fontSkew); <br>  } <br><br>  To imitate the bold font I did not find a beautiful solution.  I just type the line to be displayed in bold, several times with a slight shift.  Visually, everything looks fine, but it is frustrating that the text in the PDF file is duplicated. <br><br>  But this is not the end.  The product we are developing has the Japanese version.  Therefore, special attention is paid to the correct work with Asian fonts.  And here two more problems come out: <br><ul><li>  The font named “ＭＳ Ｐ ゴ シ ッ ク” is not present in HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Fonts and it turns out that we cannot find out the names of the faces for this font. </li><li>  The PDF library does not understand the font names in Unicode at all. </li></ul><br>  Let's start with the first problem (although historically everything started with the second, but for the coherence of the story it’s easier)  Google tells us that the font “Ｐ ゴ シ ッ ク” is in fact MS Gothic.  It turns out that he acquires the Japanese name if the Japanese locale is set in the system.  At the same time in the registry, of course, it still remains under the name MS Gothic.  This, it turns out, is the regular behavior of EnumFontsFamiliesEx.  Here is a quote from the documentation on it: “The fonts for many languages.  EnumFonts, EnumFontFamilies, and EnumFontFamiliesEx return the English textface. <br><br>  By the way, if we already know that “ＭＳ Ｐ ゴ シ ッ ク” is “MS Gothic”, then this solves the second problem, at least for the case when the English name is stored in the registry.  We will simply transfer the name “MS Gothic” to the PDF library and it will work.  It remains to establish this correspondence. <br>  For most of the faces from HKEY_LOCAL_MACHINE \ SOFTWARE \ Microsoft \ Windows NT \ CurrentVersion \ Fonts, we have assigned the font names from EnumFontsFamiliesEx.  But for some tracings the pair was not found.  Of course, we have “MS Gothic” in the registry, and EnumFontsFamiliesEx returned “ＭＳ Ｐ ゴ シ ッ ク”. <br>  In this case, it remains only to independently parse the TTF / TTC file and find the corresponding Japanese name there. <br><br>  Parsing a TTC / TTF file is a simple task.  For a working sample, you can take the source of the project “ttf2eot” <a href="http://code.google.com/p/ttf2eot/">code.google.com/p/ttf2eot</a> .  The TTF / TTC format itself is well documented on the Microsoft website: <a href="http://www.microsoft.com/typography/otspec/">www.microsoft.com/typography/otspec</a> .  You need to pay attention to the fact that all data in TTF is stored in big endian format, so that all numbers and Unicode strings must be converted before use. <br><br>  Unfortunately, I don’t have the right to lay out my code, so I’ll just write here what to look for. <br><br>  We are interested in the “name” table <a href="http://www.microsoft.com/typography/otspec/name.htm">www.microsoft.com/typography/otspec/name.htm</a> .  Select records with: <br><br><ul><li>  nPlatformId = 3: Windows.  I assume that if the font is installed under Windows, then these records should be there.  Maybe I'm wrong, but let such a font meet first, then we will understand. </li><li>  nNameId = 1: Font Family name.  Font Family name, italics, bold, bold italic - as defined by OS / 2.fsSelection bit settings.  Those.  this is exactly the name returned by EnumFontFamiliesEx. </li><li>  nEncodingId = 0 is a one-byte ASCII string or 1 is a two-byte USC2 string.  The rest of the encodings can be ignored: the specification clearly requires that at least one of these two encodings is present: “When you’re building a symbol for Windows, the platform ID should be 3 and the encoding ID should be 0. ” </li></ul><br><br>  One of the found names will match some name from EnumFontFamiliesEx. <br><br>  For example, for the “Meiryo Bold Italic” trait, by examining meiryob.ttc we find out that this trait corresponds to the name “メ イ リ オ” from EnumFontFamiliesEx. <br><br>  It remains to be seen whether this typeface is bold and oblique.  The idea suggests itself to also take this information from the font, but, as it turned out experimentally, these attributes in the font file may be incorrect.  Therefore, we take them from the name of the outline (“Meiryo Bold Italic”), as already done above.  Only we will cut off the words until the remainder matches any name extracted from the TTF file, and not from the output of EnumFontFamiliesEx. <br><br>  Thus, if you need to export a text block in oblique and bold type with the name “イ リ オ”, we transfer the name “Meiryo Bold Italic” to the PDF library.  Profit! </div><p>Source: <a href="https://habr.com/ru/post/146786/">https://habr.com/ru/post/146786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../146780/index.html">Prototyping game projects on Unity3d</a></li>
<li><a href="../146781/index.html">The practice of prototyping in a software company</a></li>
<li><a href="../146782/index.html">Coworking Incubator in Samara: opening July 13. Habr chooses a name</a></li>
<li><a href="../146784/index.html">Memory leaks in javascript closures</a></li>
<li><a href="../146785/index.html">IT student's view on ways to improve the quality of higher education</a></li>
<li><a href="../146787/index.html">Results of the week. Farewell to the hero</a></li>
<li><a href="../146788/index.html">Writing a plugin for Netbeans. Part one</a></li>
<li><a href="../146789/index.html">Google considers Chrome to be the most popular browser in the world.</a></li>
<li><a href="../146790/index.html">Bankrupt Elpida Memory bought for 2.5 billion dollars</a></li>
<li><a href="../146791/index.html">We write cheat for GTA San Andreas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>