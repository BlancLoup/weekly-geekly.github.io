<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>My latest file uploader</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am a web developer with non-core education and ~ 10 years of experience. I did everything for the web that could only come to my customers and, some...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>My latest file uploader</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/c48/8fe/47a/c488fe47a8c5b6c9165572d912257e5b.png" alt="image" align="left" width="200"><br>  I am a web developer with non-core education and ~ 10 years of experience.  I did everything for the web that could only come to my customers and, sometimes, to their superiors.  I love this job.  But still there are a few things that I do not smile at all.  One of them is file uploader.  From the very beginning - when it never occurred to anyone to make him an AJAX - and to this day - when he resizes images, loads files into several streams and much, much more - he remains for me one of the most disliked tasks.  It seems like I managed to handle it.  If interested - welcome under cat. <br>  A little bit of coffeescript awaits you, quite a bit of complaints about jQuery, a brief description of $ .Deferred, one to the place and an inadvertently applied pattern not to the place and a reference to one funny and interesting book. <br><a name="habracut"></a><br><br>  So, the task before us is to stick a file uploader on the site.  Of course, AJAX, of course, with progress and of course into an already finished design.  For starters, why is this a problem?  Cross-browser.  Good old techniques (a-la submit forms in the iframe) will not give us progress, and the new ones (xhr.send) will not work in older browsers.  Appeared was the <a href="http://habrahabr.ru/company/opera/blog/169239/">hope of standardizing</a> browsers <a href="http://habrahabr.ru/post/175377/">died suddenly</a> , so the problem of cross-browser will not die.  Additional task - Drag'n'Drop.  There is still trouble with the appearance of input'a. <br>  What options do we have? <br><h6>  Path number 1, Google-driven development </h6><br>  Shustrenko google a fairly popular jQuery library that implements all the required functions.  The approach is correct with a lack of time.  Extremely quickly embedded in the project, she is worried about the compatibility with browsers and even displays some kind of formatted DOM.  After all, there are no problems with DOM reworking styles (or even using jQuery, this is his main specialization, right?), Quietly convincing designers to move a little (‚ÄúI can't do that to you, go to hell!‚Äù), Even agree with interested persons about the functionality ("Well, yes, we did not do it. But then look what kind of thing happened to you from the side. After all, is it really super?").  And everything seems to be super, and everything seems to be great.  During the day you can cope and give in testing.  But then ... The first swallow will fly in from the designers - some diva came out (someone interrupted the download, or created another, more exotic situation).  And you have not seen this div, and therefore the styles on it, to put it mildly, are not exactly those.  We digest the deserved reproaches of designers, we observe the arrival of a delegation of testers.  It turns out that in some wonderful browser, in which, because of corporate standards, as many as XX percent of our users (and the most valuable ones!) Do not see any progress!  Horror.  You boldly send testers to hell (‚ÄúWell, how can I do this if the browser does not support ???‚Äù) and with a triumphant view you miss the hook to the jaw: ‚ÄúSo, VKontakte upload with progress works with this browser!‚Äù.  And at this very moment you are committing one of the most terrible crimes against the project - you climb into the source code of this wonderful plugin.  (As an option, find the last year's message about this error in the plugin's tracker and, if you're lucky, any crutch plugging this particular problem).  In fact, this is not so scary for you as for a programmer.  You will learn to read someone else's code - sometimes good, sometimes ... different.  Debugger once again popolzuytes.  I in no case want to say anything bad about jQuery plugin developers.  Just in most cases I have encountered, their code is not designed for the support of a stranger.  But the timing of the project can begin to burn.  Remember, we chose this option precisely because of lack of time? <br>  And also - if you plug in the plugin, be sure to leave only the minified version of the plugin in the project repository.  And in no case do not leave links to the site of the plugin anywhere. <br>  Summary: unfamiliar plug-ins are used only if the design and functionality can be forgotten.  Well, or for revenge / training of designers and other testers.  Or as a practice of reverse engineering skills. <br><br><h6>  Path number 2, historical </h6><br>  Ha!  Half a year ago we wrote something like that.  For the Dutch (Greeks, Australians, Persians ...).  There was still a green oval progress bar.  We open the old project (another computer, a burned-down repository, and another 100,500 reasons why it is not so easy).  Saw uploader, smoke sorts.  And there ... First of all - support only the latest browsers.  Secondly, flash-resize on the client side.  Thirdly, this is the most memorable oval (designers - bastards!) Progress is hard-coded into the uploader code itself.  Fourth, fifth, etc.  Plus a lot of specifics of that project.  From the point of view of pleasure - also not ice.  Instead of flying thoughts to the highlands of modern technology - roll back six months ago. <br>  Summary: not interesting.  Even if you were a guru six months ago and gave out only a high-quality code, now you are better off anyway. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Path number 3, self-confident </h6><br>  So let's try to dream a little.  What do we want?  (besides beer, neighbor and cat).  At a minimum, we want to do an uploader.  As a maximum, we want to do it once and for a long time.  To make it easy to take from the current project and stick in the next with minimal modification.  The desire, by the way, is inspired by one most amusing little book - Design Patterns by Eric and Elizabeth Freeman.  No, this is not the one, the Original Book of the Gang of Four, Which Everyone Should Read.  This other one is much easier.  Not so strong, but also easier to read.  One of the first principles that its authors are trying to drive into the reader's head is to encapsulate what changes.  In our case, the most variable aspect of the architecture should be the method of sending data to the server (not only, but more on that later).  If you remember, we discussed this problem before the jQuery plugin.  So, if we make any pool of mechanisms for sending data to the server (if you prefer more OOP wording - let there be a set of classes with a common interface) and define the interface of interaction with the uploader - one big problem is divided into several smaller ones.  And to solve them is more pleasant.  What does this look like?  Very simple: <br><br><pre><code class="javascript hljs">Uploader = senders: [xhrFile, formDataFile, formDataForm, iframe] send: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each</span></span></span><span class="hljs-function"> @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">senders</span></span></span><span class="hljs-function">, (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, func</span></span></span><span class="hljs-function">)=&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> stream = func(options) <span class="hljs-literal"><span class="hljs-literal">false</span></span> stream</code> </pre> <br><br>  In 2 words - we iterate over the array of functions (javascript is the same!), We slip each options (mostly because we don‚Äôt know what we‚Äôll actually slip) options and, the first one that returned a non-empty result is used for sending.  (As an option, the first one did not generate an exception, it would be more correct but lazy for the time being.) At the same time, the most ‚Äúvaluable‚Äù functions are first in the array, and the last one is faultless (the same submit-form-to-iframe method).  Yes, we already guess that the functions will be returned to us by deferred - then in the interface part of the uploader we will hang all the interested listeners (and we will not pass them to options).  A little messy described $ .Deferred under the spoiler after examples of functions. <br>  Now a couple of lines about the quality of the code in this article: <br>  - the code is tied to jQuery not because the author believes that any project will use it anyway, sooner or later, but because of a certain amount of ‚Äúamenities‚Äù, including Deferred, which we will use very tightly <br>  - Partially code taken from one <a href="https://github.com/blueimp/jQuery-File-Upload/">great plugin</a> .  If to be honest, the idea was born from reading this plug-in and sobs: ‚ÄúWell, why, why logic is not separated from the implementation?‚Äù <br>  - at the moment the code is rather poorly tested, it is just an illustration of the architecture. <br><br>  Now examples of functions: <br><br><pre> <code class="javascript hljs"> iframe = (options)-&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> unless options.input &amp;&amp; options.input.value id = <span class="hljs-string"><span class="hljs-string">'frame'</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() $form = $ <span class="hljs-string"><span class="hljs-string">'&lt;form&gt;'</span></span>, <span class="hljs-attr"><span class="hljs-attr">method</span></span>: options.method, <span class="hljs-attr"><span class="hljs-attr">enctype</span></span>:<span class="hljs-string"><span class="hljs-string">'multipart/form-data'</span></span>, <span class="hljs-attr"><span class="hljs-attr">target</span></span>: id, <span class="hljs-attr"><span class="hljs-attr">action</span></span>: options.url $(<span class="hljs-string"><span class="hljs-string">'&lt;iframe&gt;'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: id ).appendTo($form).on <span class="hljs-string"><span class="hljs-string">'load'</span></span>, -&gt; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> response = @contents() <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span> unless response.length &amp;&amp; response[<span class="hljs-number"><span class="hljs-number">0</span></span>].firstChild dfd.resolve response, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: options.input.value <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> e dfd.reject response, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: options.input.value $form.hide().appendTo(<span class="hljs-string"><span class="hljs-string">'body'</span></span>).submit() (dfd = $.Deferred()).promise()</code> </pre><br><br>  This is our very reliable function for older browsers.  In short - we create the form, we aim at the iframe, submit it.  We return deferred, which is cut off or edited by loading the target iframe.  The arguments passed to the deferred will be received by the listeners hung outside.  If my description of deferred is not completely clear - welcome under the spoiler after the next function, although it is better, of course, to read something, for example, <a href="http://habrahabr.ru/post/113073/">post on habr</a> and <a href="http://api.jquery.com/category/deferred-object/">documentation</a> . <br><br><pre> <code class="javascript hljs"> formDataFile = (options)-&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> unless options.files &amp;&amp; options.files.length &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.FormData $.when.apply $, options.files.map (f)-&gt; formData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData() formData.append options.name, f xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest() dfd = $.Deferred() xhr.onload = xhr.onerror = -&gt;dfd[@status == <span class="hljs-number"><span class="hljs-number">200</span></span> &amp;&amp; <span class="hljs-string"><span class="hljs-string">'resolve'</span></span> || <span class="hljs-string"><span class="hljs-string">'reject'</span></span>] @response, file <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> xhr.upload xhr.upload.onprogress = (e)-&gt;dfd.notify e, file xhr.open options.method, options.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span> xhr.responseType = <span class="hljs-string"><span class="hljs-string">'text'</span></span> xhr.send formData dfd.promise()</code> </pre><br><br>  There will be more interesting.  For each of the specified files (where options.files came from and what‚Äôs in it - just below) we create a separate XMLHttpRequest and deferred.  Deferred we, as in the first example, reject or rezolvim for downloading data from the server.  Unlike the fail-safe method, besides resolve / reject, we will use deferred to transfer data about the upload progress (xhr.upload.onprogress = (e) -&gt; dfd.notify e, file) if the browser deigns.  The resulting deferred we use to group $ .when into one and return.  In this case, the use of when is not quite justified, I‚Äôm happy to read why in the comments. <br><br><div class="spoiler">  <b class="spoiler_title">Deferred for the smallest</b> <div class="spoiler_text">  Roughly speaking, deferred is a mechanism for separating the addition of event handlers from calling these handlers.  Very cool to use for asynchronous calls.  For example, I‚Äôll give an ajax request, as it is most often used and closely familiar to most web programmers.  It used to be like this: <br><br><pre> <code class="javascript hljs"> $.get(<span class="hljs-string"><span class="hljs-string">'/some/url/for/ajax'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">'got response'</span></span>); }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">'got error'</span></span>); })</code> </pre><br><br>  Now so: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = $.get(<span class="hljs-string"><span class="hljs-string">'/some/url/for/ajax'</span></span>); request.done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">'got response'</span></span>); }); request.fail(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ alert(<span class="hljs-string"><span class="hljs-string">'got error'</span></span>); })</code> </pre><br><br>  what changed?  The most important thing for us is that before, at the time of the request, you needed to know what you would do with the answer (the handler functions needed to be passed at the time of $ .get call).  Now it is not necessary.  You can even hang on the request variable (it will store the deferred object) handlers <br>  after the completion of the request.  True, then you need to be ready to immediately trigger the handler.  This is the client (‚Äúconsumer‚Äù) side of Deferred - we get deferred from the $ .get method and just wait for it to change state.  Now the ‚Äúdark‚Äù side, feel jQuery: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> def = $.Deferred(); def.done(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ""  ("")   ""  deferred- console.log('done1', arguments) }); //     def.resolve('param12');//   ""  deferred     done-,      'param12' //   -  ['done1', Arguments['param12']] def.done(function(){ // ""  ("")   ""  deferred- console.log('done2', arguments) }); //    //   -  ['done2', Arguments['param12']]</span></span></code> </pre><br><br>  We get a couple of <b>done</b> - <b>resolve</b> methods.  The first one adds a handler to the transition to the 'resolved' state, the second one transfers the object to this state and, thus, calls all the handlers already added. <br>  The second pair of <b>fail</b> - <b>reject</b> methods work in the same way with the 'rejected' state <br>  The third pair of methods of <b>progress</b> - <b>notify</b> works without a change of state.  Just when calling notify, all progress-handlers are triggered. <br><br>  There is also such a protective thing as promise ().  Will return to you the "cut off" deferred.  You can hang handlers for it (done, fail, progress), and the state cannot be changed.  That is what $ .get returns to you.  And correctly - why do you need to manually change the state of the ajax request? <br><br>  To understand the code, it would also be nice to deal with $ .when.  This is the "union" of deferred objects.  It works like this: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> def = $.when(a, b, c ....); <span class="hljs-comment"><span class="hljs-comment">//  "" deferred def.done(function(){ alert('resolved'); //   1 , ,     deferred  resolve }); def.fail(function(){ alert('got error'); //   1 ,        deferred  reject }) def.progress(function(){ alert('some error'); //  ,        deferred  notify })</span></span></code> </pre><br><br>  If you use $ .when - pay attention to the arguments passed to the handlers by the composite object.  He accumulates them.  Those.  if the functions a.resolve (1) and b.resolve (2) were called, then the composite list-listeners will get 1, 2 as arguments.  You can play on <a href="http://jsfiddle.net/phgrey/Z8n98/2/">fiddle</a> . <br><br>  But it is better to read about Deferred - <a href="http://api.jquery.com/category/deferred-object/">here</a> or at least <a href="http://habrahabr.ru/post/113073/">here</a> . <br><br></div></div><br><br>  Quite conditionally, the situation can be described as follows: we launch the function of sending data to the server several times (once for each file), leave the sensor (deferred) in each one and collect indicators (promise) from these sensors.  Our sensors and indicators are three-channel. <br><br>  An experienced attentive reader should already exclaim ‚ÄúBah!  So this is a chain of responsibilities! ‚ÄùAnd yes, it will be 100% right (taking into account the peculiarities of JS and the desire to make it easier).  Skeptics tighten their lips in disgust, patterns in js.  But we will not listen to them, something else is important for us: dancing from the conditions of the task and guided by common sense, we almost got to the realization of the pattern ourselves, which means, if we wish, we can read a little about it, and be ready for characteristic surprises . <br><br>  If they did not solve one problem, they found an acceptable way to a solution.  What we have left?  There is also the task of reading files.  Depending on the capabilities of the browser, we can either get the object selected in the input file, or even be able to read the contents of the folder (recursively if necessary).  Or we will not be able to (guess what browser) - just get input.  Immediately, there is a desire to act in a similar way - to form an array of readers (chain of duties) and iterate over it, selecting the appropriate function.  Put it all there, in our Uploads object.  Now it will look like this: <br><br><pre> <code class="javascript hljs">Uploader = _responsibilityChain: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, chain, name = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chain</span></span></span><span class="hljs-function">, (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, func</span></span></span><span class="hljs-function">)=&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> stream = func(options) #        Uploader #          @[name] = func <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name <span class="hljs-literal"><span class="hljs-literal">false</span></span> stream readers: [entry, file, input] read: (options)-&gt;@_responsibilityChain options, @readers, <span class="hljs-string"><span class="hljs-string">'read'</span></span> senders: [xhrFile, formDataFile, formDataForm, iframe] send: (options)-&gt;@_responsibilityChain options, @senders, <span class="hljs-string"><span class="hljs-string">'send'</span></span></code> </pre><br><br>  The implementation of the mechanism was carried out in a separate Uploader function.  And right inside the search, we set the appropriate function as the required method (read or send) to the Uploader object.  Now let's take a look at the functions themselves for reading (mostly taken from the plugin code, along with comments). <br><br><pre> <code class="javascript hljs">#     input = (options)-&gt; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> unless options.input.value $.Deferred().resolve([]).promise() #    -      input #         , Deferred      <span class="hljs-number"><span class="hljs-number">3</span></span>-  file = (options)-&gt; files = $.makeArray $(options.input).prop <span class="hljs-string"><span class="hljs-string">'files'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> unless files.length <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (files[<span class="hljs-number"><span class="hljs-number">0</span></span>].name == <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &amp;&amp; files[<span class="hljs-number"><span class="hljs-number">0</span></span>].fileName) # File normalization <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Safari <span class="hljs-number"><span class="hljs-number">4</span></span> and Firefox <span class="hljs-number"><span class="hljs-number">3</span></span>: $.each files, (index, file)-&gt; file.name = file.fileName; file.size = file.fileSize; $.Deferred().resolve(files).promise() #   -reader.    . , ..  #  Deferred.    ,    entry = (options)-&gt; roots = $(options.input).prop(<span class="hljs-string"><span class="hljs-string">'webkitEntries'</span></span>) || $(options.input).prop(<span class="hljs-string"><span class="hljs-string">'entries'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> unless roots &amp;&amp; roots.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> readEntries = (entries, path=<span class="hljs-string"><span class="hljs-string">''</span></span>)-&gt; $.when.apply($, $.map entries, (entry)-&gt; dfd = $.Deferred() errorHandler = (e)-&gt; e.entry = entry <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e &amp;&amp; !e.entry # Since $.when returns immediately <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> one # Deferred is rejected, we use resolve instead. # This allows valid files and invalid items # to be returned together <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> one set: dfd.resolve [e] resolveHandler = (file)-&gt; # Workaround <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Chrome bug #<span class="hljs-number"><span class="hljs-number">149735</span></span> file.relativePath = path dfd.resolve file <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> entry.isFile entry._file &amp;&amp; resolveHandler(entry._file) || entry.file resolveHandler, errorHandler <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> entry.isDirectory entry.createReader().readEntries((entries)-&gt; readEntries(entries, path + entry.name + <span class="hljs-string"><span class="hljs-string">'/'</span></span> ).done((files)-&gt;dfd.resolve files ).fail(errorHandler) , errorHandler) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> # Return an empy list <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> file system items other than files or directories: dfd.resolve([]); dfd.promise() #we <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> need <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> pipe here bc we <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> resolve some files scoped ).pipe -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.prototype.concat.apply [],<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span> readEntries(roots).promise()</code> </pre><br><br>  In short, each of the functions tries in its own way to rape input from options and return deferred, which will be resolved with a list of read files. <br><br>  An attentive and experienced reader should cry out somewhere here: ‚ÄúNot that pattern!‚Äù.  And again, it will be 100% right.  The internal programmer chuik says something is wrong here.  The result of the work of some readers can be given to send not to all senders (for example, after the reader input, the xderFile cannot send).  Well, hell with them.  We will handle this situation return false unsuitable sender.  But reading the data from the input right inside the sender is not ice - do not forget, will we still have Drag'n'Drop?  For the time being, let's leave it as it is, what if a miracle happens and a good advice appears in the comments? <br><br>  One more note - the input reader does nothing - returns a Ô¨Å nished, empty array deferred.  This is just the default value; you can transfer this functionality inside Uploader.read.  Left for beauty - ugly, but uniform. <br><br>  Next - we need to link read and send and add some default values ‚Äã‚Äãfor options.  The function is again thrust into our object Uploader: <br><pre> <code class="javascript hljs">Uploader: #...  ,      upload: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">extend</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method</span></span></span><span class="hljs-function">: '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">POST</span></span></span><span class="hljs-function">' </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function"> , </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function"> @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">then</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">)=&gt;</span></span>$.when.apply $, @send $.extend options, <span class="hljs-attr"><span class="hljs-attr">files</span></span>:files</code> </pre><br><br>  Everything is simple here - we read the files from the input, add the resulting values ‚Äã‚Äãto the options and give the resulting object to be sent to Uploader.send.  Again, we get grouped from send deferreds with when and give the grouped deferred to the client. <br><br>  How to use it all: <br><pre> <code class="javascript hljs"> $(<span class="hljs-string"><span class="hljs-string">'#some-file-input'</span></span>).change -&gt; Uploader.upload(input: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'/files/upload'</span></span> ) .done -&gt; #         alert <span class="hljs-string"><span class="hljs-string">"#{arguments.length} files uploaded"</span></span> .fail -&gt; #          alert <span class="hljs-string"><span class="hljs-string">"Some files were not uploaded"</span></span> .progress -&gt; #      (~ <span class="hljs-number"><span class="hljs-number">50</span></span> ),    <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span></code> </pre><br><br><h6>  Summary </h6><br><br><div class="spoiler">  <b class="spoiler_title">Whole uploader</b> <div class="spoiler_text"><pre> <code class="javascript hljs">Senders = _makeForm: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'&lt;form&gt;'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, method: options.method, enctype:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'multipart/form-data'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options.input.clone(</span></span></span><span class="hljs-function">)) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_sendData</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, data, file</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XMLHttpRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Deferred</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onload</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onerror</span></span></span><span class="hljs-function"> = -&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">[@</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status</span></span></span><span class="hljs-function"> == 200 &amp;&amp; '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function">' || '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reject</span></span></span><span class="hljs-function">'] @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">upload</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">upload</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onprogress</span></span></span><span class="hljs-function"> = (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)-&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">notify</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">else</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">no_progress</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">open</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function"> + '?</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">=' + (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options.file_name || file.name</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">responseType</span></span></span><span class="hljs-function"> = '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function">' </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhr</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">send</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">iframe</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">no_progress</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">true</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function"> = '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">frame</span></span></span><span class="hljs-function">' + </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Math</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$form</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Senders</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_makeForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">attr</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">action</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'&lt;iframe&gt;'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, name: id </span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">appendTo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$form</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">on</span></span></span><span class="hljs-function"> '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">load</span></span></span><span class="hljs-function">', -&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">try</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> = @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">contents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">throw</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Error</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">length</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">[0].</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">firstChild</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">catch</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reject</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$form</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">submit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd = $.Deferred(</span></span></span><span class="hljs-function">)).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formDataForm</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) -&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">window</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FormData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form</span></span></span><span class="hljs-function"> || </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Senders</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_makeForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">get</span></span></span><span class="hljs-function"> 0 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Senders</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_sendData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FormData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formDataFile</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">length</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">window</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FormData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formData</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">new</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FormData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formData</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">append</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Senders</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_sendData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">extend</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, file_name:f.name</span></span></span><span class="hljs-function">), </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formData</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">f</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhrFile</span></span></span><span class="hljs-function"> : (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">length</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">window</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ProgressEvent</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">window</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FileReader</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">map</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">, (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Senders</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_sendData</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Readers</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Deferred</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">makeArray</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options.input</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prop</span></span></span><span class="hljs-function"> '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">' </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">length</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">].name == </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">undefined</span></span></span></span><span class="hljs-function"><span class="hljs-params"> &amp;&amp; files[</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">].fileName</span></span></span><span class="hljs-function">) # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">File</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">normalization</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Safari</span></span></span><span class="hljs-function"> 4 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">and</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Firefox</span></span></span><span class="hljs-function"> 3: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">, (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">index, file</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileName</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">size</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileSize</span></span></span><span class="hljs-function">; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Deferred</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">roots</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options.input</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'webkitEntries'</span></span></span></span></span><span class="hljs-function">) || </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options.input</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'entries'</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">unless</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">roots</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">roots</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">length</span></span></span><span class="hljs-function"> &gt; 0 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readEntries</span></span></span><span class="hljs-function"> = (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entries, path=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">when</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$, $.map entries, (entry</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Deferred</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">errorHandler</span></span></span><span class="hljs-function"> = (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> &amp;&amp; !</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function"> # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Since</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">when</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">immediately</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">one</span></span></span><span class="hljs-function"> # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Deferred</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">is</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rejected</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">we</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">instead</span></span></span><span class="hljs-function">. # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">This</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">allows</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">valid</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">and</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">invalid</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items</span></span></span><span class="hljs-function"> # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">to</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">be</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">returned</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">together</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">in</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">one</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">set</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> [</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">] </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolveHandler</span></span></span><span class="hljs-function"> = (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">)-&gt; # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Workaround</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Chrome</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bug</span></span></span><span class="hljs-function"> #149735 </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">relativePath</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">path</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">isFile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_file</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolveHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry._file</span></span></span><span class="hljs-function">) || </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolveHandler</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">errorHandler</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">else</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">isDirectory</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entry</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">createReader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readEntries</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entries</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readEntries</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">entries, path + entry.name + </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'/'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">done</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(files</span></span></span><span class="hljs-function">)-&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> ).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">errorHandler</span></span></span><span class="hljs-function">) , </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">errorHandler</span></span></span><span class="hljs-function">) </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">else</span></span></span><span class="hljs-function"> # </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Return</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">an</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">empy</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">list</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">for</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">file</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">system</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">items</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">other</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">than</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">or</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">directories</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function">); </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dfd</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> #</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">we</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">do</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">need</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">this</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pipe</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">here</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">we</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">do</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">some</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scoped</span></span></span><span class="hljs-function"> ).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pipe</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Array</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">prototype</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">concat</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">apply</span></span></span><span class="hljs-function"> [],</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arguments</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readEntries</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">roots</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">promise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Uploader</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_responsibilityChain</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options, chain, name = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stream</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">false</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">each</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">chain</span></span></span><span class="hljs-function">, (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, func</span></span></span><span class="hljs-function">)=&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> stream = func(options) #        Uploader #          @[name] = func <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name <span class="hljs-literal"><span class="hljs-literal">false</span></span> stream readers: [entry, file, input] read: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt;@</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_responsibilityChain</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">, @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">readers</span></span></span><span class="hljs-function">, '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">read</span></span></span><span class="hljs-function">' </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">senders</span></span></span><span class="hljs-function">: [</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">xhrFile</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formDataFile</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">formDataForm</span></span></span><span class="hljs-function">, </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">iframe</span></span></span><span class="hljs-function">] </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">send</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt;@</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_responsibilityChain</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">, @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">senders</span></span></span><span class="hljs-function">, '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">send</span></span></span><span class="hljs-function">' </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">upload</span></span></span><span class="hljs-function">: (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)-&gt; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">extend</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">method</span></span></span><span class="hljs-function">: '</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">POST</span></span></span><span class="hljs-function">' </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">: </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function"> &amp;&amp; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">input</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function"> , </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function"> @</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">read</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">).</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">then</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">files</span></span></span><span class="hljs-function">)=&gt;</span></span>$.when.apply $, @send $.extend options, <span class="hljs-attr"><span class="hljs-attr">files</span></span>:files</code> </pre><br></div></div><br><br>       input[type=file]    ‚Äî      position:absolute    ,    label. <br><br>   ,   file-uploader.      upload ‚Äî        senders  .  ,    , $.Deferred.  But: <br> ‚Äî       <br> ‚Äî     <br> ‚Äî      ‚Äî     ¬´ ¬ª, ¬´ ¬ª.   progress    ,    <br><br>    ‚Äî      (  ).    , , , . <br><br>   : <br> 1.   jQuery-File-Upload ‚Äî <a href="">github.com/blueimp/jQuery-File-Upload/blob/master/js/jquery.fileupload.js</a> <br> 2.   jQuery.Deferred ‚Äî <a href="http://api.jquery.com/category/deferred-object/">api.jquery.com/category/deferred-object</a> <br> 3.  ¬´ ¬ª  ‚Äî <a href="http://www.ozon.ru/context/detail/id/20216992/">www.ozon.ru/context/detail/id/20216992</a> </div><p>Source: <a href="https://habr.com/ru/post/225289/">https://habr.com/ru/post/225289/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225277/index.html">Scientific, medical illustration and animation: how doctors and scientists communicate with each other, students and the rest of humanity</a></li>
<li><a href="../225281/index.html">How to study inside "Beeline": internal university</a></li>
<li><a href="../225283/index.html">What mistakes do hardcore engineers do when training other people?</a></li>
<li><a href="../225285/index.html">The first Omsk Geo-Hakaton completed</a></li>
<li><a href="../225287/index.html">Product design digest, April-May 2014</a></li>
<li><a href="../225291/index.html">Encoding x264 + Vorbis</a></li>
<li><a href="../225293/index.html">Trisection angle and other tasks on the construction</a></li>
<li><a href="../225297/index.html">Meet Swift!</a></li>
<li><a href="../225301/index.html">Russian Robotics Olympiad - hurry to take part!</a></li>
<li><a href="../225303/index.html">DevConf :: Ruby - June 14 - the program is generated</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>