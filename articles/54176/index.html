<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selection of arbitrary records in MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There seem to be ordinary tasks that can be solved immediately and without thinking, but with intensive use of such solutions, problems arise, and not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selection of arbitrary records in MySQL</h1><div class="post__text post__text-html js-mediator-article">  There seem to be ordinary tasks that can be solved immediately and without thinking, but with intensive use of such solutions, problems arise, and not small ones.  I want to tell you about one of these tasks. <br><a name="habracut"></a><br><br><h1>  Problem </h1>  They took the outsourcer here to write a small and simple code in PHP and MySQL.  There was one of the tasks - to select several arbitrary records from a table in the MySQL database.  And what did this lazy and stupid outsourcer do?  Of course I wrote a nonsense like this: <blockquote><code><font color="black"><font color="#990099">SELECT</font> <font color="#CC0099">*</font> <font color="#990099">FROM</font> tTable <font color="#990099">ORDER BY</font> <font color="#000099">RAND</font> <font>(</font> <font>)</font> <font color="#990099">LIMIT</font> <font>10</font> <font color="#000033">;</font></font></code> <br> </blockquote>  At first glance, everything is logical and works correctly.  10 random entries are selected.  But if you look at the execution plan for this query, it will become clear why I folded a dozen of raw curses against a stupid outsourcer. <br>  During the execution of this query, MySQL writes to the temporary table all (!!!) rows of the original table, with one new field in which the results of the RAND () function are written - i.e.  set of arbitrary values.  Then this temporary table is sorted by filesort according to the added field with arbitrary values ‚Äã‚Äãand then the first 10 records are selected.  Full gut.  And now what will happen if there are 10,000 entries in the source table.  And what if 1,000,000?  And what if this sample needs to be done ten times per second.  Yes, here any super-duper server will go into meditation for a long time. <br><br>  But if you show a little sharpness (and the outsourcers do not want to think, they give up the work and go to drink money), then you can come up with an elegant and fast option, the speed of which does not depend on the number of rows in the table. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Idea </h1>  So let's start on the sly.  First, simplify the task, suppose that we need to choose not 10, but only one record. <br>  Everything is pretty simple here.  We need to operate only with the number of records in the table, since  the key can be any (composite, not numeric), as well as it can be ‚Äúdischarged‚Äù as a result of deleting records.  First of all, let's find out the total number of records in the table: <blockquote> <code><font color="black"><font color="#990099">SELECT</font> <font color="#000099">COUNT</font> <font>(</font> <font color="#CC0099">*</font> <font>)</font> <font color="#990099">FROM</font> tTable <font color="#000033">;</font></font></code> <br> </blockquote>  Then simply calculate an arbitrary number from 0 to the number of records in this table. <blockquote> <code><font color="black">rand_row = round(rand() * row_count);</font></code> <br> </blockquote>  Now, without problems, you can make a sample of an arbitrary record: <blockquote> <code><font color="black">SELECT * FROM tTable LIMIT rand_row, 1;</font></code> <br> </blockquote><br><h1>  PHP solution </h1>  So, they coped with the simplified task.  Now you need to overcome the originally set, i.e.  select 10 entries.  The logic here is simple: you need to count 10 arbitrary numbers from 0 to the number of records in the table, and then make 10 queries like the previous one and combine them with UNION. <br>  There are two options for how to do this: you can arrange it in the form of a piece of PHP code, or you can in the form of a MySQL stored procedure. <br>  Everything is very simple in PHP: <blockquote> <code><font color="black"><font color="#000088">$row_count</font> <font color="#339933">=</font> <font color="#990000">mysql_result</font> <font>(</font> <font color="#990000">mysql_query</font> <font>(</font> <font color="#0000ff">'SELECT COUNT(*) FROM tTable;'</font> <font>)</font> <font color="#339933">,</font> 0 <font>)</font> <font color="#339933">;</font> <br> <font color="#000088">$query</font> <font color="#339933">=</font> <font color="#990000">array</font> <font>(</font> <font>)</font> <font color="#339933">;</font> <br> <font color="#b1b100">while</font> <font>(</font> <font color="#990000">count</font> <font>(</font> <font color="#000088">$query</font> <font>)</font> <font color="#339933">&lt;</font> <font>10</font> <font>)</font> <font>{</font> <br> <font color="#000088">$query</font> <font>[</font> <font>]</font> <font color="#339933">=</font> <font color="#0000ff">'(SELECT * FROM tTable LIMIT '</font> <font color="#339933">.</font> <font color="#990000">rand</font> <font>(</font> <font>0</font> <font color="#339933">,</font> <font color="#000088">$row_count</font> <font>)</font> <font color="#339933">.</font> <font color="#0000ff">', 1)'</font> <font color="#339933">;</font> <br> <font>}</font> <br> <font color="#000088">$query</font> <font color="#339933">=</font> <font color="#990000">implode</font> <font>(</font> <font color="#0000ff">' UNION '</font> <font color="#339933">,</font> <font color="#000088">$query</font> <font>)</font> <font color="#339933">;</font> <br> <font color="#000088">$res</font> <font color="#339933">=</font> <font color="#990000">mysql_query</font> <font>(</font> <font color="#000088">$query</font> <font>)</font> <font color="#339933">;</font></font></code> <br> </blockquote>  Everything is simple and fast.  On the source table with ten thousand records, the performance increase is more than 12 times over the original ‚Äúlazy‚Äù variant. <br>  If there are not so many records in the source table and the appearance of duplicate rows in the sample is unacceptable - then you can preliminarily form a list of non-repeating arbitrary values, and then make a query on them. <br><br><h1>  MySQL solution </h1>  Alternatively, you can still do this in the form of a stored procedure: <blockquote> <code><font color="black"><font color="#990099">CREATE</font> <font color="#990099">PROCEDURE</font> <font color="#008000">`spRandomSelect`</font> <font>(</font> <font color="#990099">IN</font> aSchema <font color="#999900">VARCHAR</font> <font>(</font> <font>50</font> <font>)</font> <font color="#000033">,</font> <font color="#990099">IN</font> aTable <font color="#999900">VARCHAR</font> <font>(</font> <font>50</font> <font>)</font> <font color="#000033">,</font> <font color="#990099">IN</font> aNumRows <font color="#999900">INTEGER</font> <font>(</font> <font>11</font> <font>)</font> <font>)</font> <br> <font color="#CC0099">NOT</font> <font color="#990099">DETERMINISTIC</font> <br> READS SQL D <br> <font color="#990099">BEGIN</font> <br> <font color="#990099">DECLARE</font> iQuery <font color="#999900">VARCHAR</font> <font>(</font> <font>10000</font> <font>)</font> <font color="#000033">;</font> <br> <font color="#990099">DECLARE</font> iNumRows <font color="#999900">INTEGER</font> <font>(</font> <font>11</font> <font>)</font> <font color="#000033">;</font> <br> <br> <font color="#990099">SET</font> iNumRows <font color="#CC0099">=</font> <font>(</font> <font color="#990099">SELECT</font> <font color="#008000">`TABLE <font color="#008080">_</font> ROWS`</font> <font color="#990099">FROM</font> <font color="#008000">`information <font color="#008080">_</font> schema`</font> . <font color="#008000">`TABLES`</font> t <br> <font color="#990099">WHERE</font> t. <font color="#008000">`TABLE <font color="#008080">_</font> SCHEMA`</font> <font color="#CC0099">=</font> aSchema <font color="#CC0099">AND</font> t. <font color="#008000">`TABLE <font color="#008080">_</font> NAME`</font> <font color="#CC0099">=</font> aTable <font>)</font> <font color="#000033">;</font> <br> <font color="#990099">SET</font> iQuery <font color="#CC0099">=</font> <font color="#008000">''</font> <font color="#000033">;</font> <br> loop1: LOOP <br> <font color="#990099">SET</font> iQuery <font color="#CC0099">=</font> <font color="#000099">CONCAT</font> <font>(</font> iQuery <font color="#000033">,</font> <font color="#008000">'(SELECT * FROM `'</font> <font color="#000033">,</font> aSchema <font color="#000033">,</font> <font color="#008000">'`.`'</font> <font color="#000033">,</font> aTable <font color="#000033">,</font> <br> <font color="#008000">'` LIMIT '</font> <font color="#000033">,</font> <font color="#000099">ROUND</font> <font>(</font> <font color="#000099">RAND</font> <font>(</font> <font color="#000099">UNIX_TIMESTAMP</font> <font>(</font> <font>)</font> <font color="#CC0099">+</font> aNumRows <font>)</font> <font color="#CC0099">*</font> iNumRows <font>)</font> <font color="#000033">,</font> <font color="#008000">', 1)'</font> <font>)</font> <font color="#000033">;</font> <br> <font color="#009900">IF</font> aNumRows <font color="#CC0099">&gt;</font> <font>1</font> <font color="#009900">THEN</font> <br> <font color="#990099">SET</font> iQuery <font color="#CC0099">=</font> <font color="#000099">CONCAT</font> <font>(</font> iQuery <font color="#000033">,</font> <font color="#008000">' UNION '</font> <font>)</font> <font color="#000033">;</font> <br> <font color="#009900">END</font> <font color="#009900">IF</font> <font color="#000033">;</font> <br> <font color="#990099">SET</font> aNumRows <font color="#CC0099">=</font> aNumRows <font color="#CC0099">-</font> <font>1</font> <font color="#000033">;</font> <br> <font color="#009900">IF</font> aNumRows <font color="#CC0099">&gt;</font> <font>0</font> <font color="#009900">THEN</font> <br> ITERATE loop1 <font color="#000033">;</font> <br> <font color="#009900">END</font> <font color="#009900">IF</font> <font color="#000033">;</font> <br> LEAVE loop1 <font color="#000033">;</font> <br> <font color="#009900">END</font> LOOP loop1 <font color="#000033">;</font> <br> <font color="#990099">SET</font> @iQuery <font color="#CC0099">=</font> iQuery <font color="#000033">;</font> <br> PREPARE iExecStmt <font color="#990099">FROM</font> @iQuery <font color="#000033">;</font> <br> EXECUTE iExecStmt <font color="#000033">;</font> <br> DRP PREPARE iExecStmt <font color="#000033">;</font> <br> <font color="#009900">END</font> <font color="#000033">;</font></font></code> <br> </blockquote>  The performance of this solution is smaller than when preparing a compound query in PHP, but the point is to show the possibility of implementation on "pure" SQL. </div><p>Source: <a href="https://habr.com/ru/post/54176/">https://habr.com/ru/post/54176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../54160/index.html">Today on Nigma noticed the news:</a></li>
<li><a href="../54167/index.html">Five ways of self-motivation to achieve goals</a></li>
<li><a href="../54170/index.html">Who will take on KXneur?</a></li>
<li><a href="../54174/index.html">How to make Firefox open ‚Äúnews:‚Äù URLs in Google Groups</a></li>
<li><a href="../54175/index.html">Vkontakte deletes users</a></li>
<li><a href="../54178/index.html">Do you find what you need with the built-in search on Habr√©?</a></li>
<li><a href="../54179/index.html">Go to Open Source and save 50 million euros. Experience the French gendarmerie.</a></li>
<li><a href="../54180/index.html">But who wanted to productively run over the OS Phantom?</a></li>
<li><a href="../54183/index.html">About resource development pipeline</a></li>
<li><a href="../54186/index.html">Karmagram or diagrammatic ranking method in social networks</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>