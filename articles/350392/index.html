<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cuckoo 2.0. We collect the best open source platform for analyzing malicious files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings Habr! 


 4 years ago I published the assembly instructions for the dynamic analysis of malicious files Cuckoo Sandbox 1.2. During this time...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cuckoo 2.0. We collect the best open source platform for analyzing malicious files</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/kc/za/pp/kczapp9sifxd-1pw8epm58zlowy.png" alt="Cuckoo Sandbox logo"><br>  Greetings Habr! </p><br><p>  4 years ago I <a href="https://habrahabr.ru/post/234467/">published the</a> assembly <a href="https://habrahabr.ru/post/234467/">instructions</a> for the dynamic analysis of malicious files Cuckoo Sandbox 1.2.  During this time, the project managed to acquire impressive functionality and a huge community, having recently updated to version 2.0, which for more than a year and a half hung in the Release Candidate stage. </p><br><p>  I finally prepared for you a complete manual for assembling Cuckoo Sandbox 2.0.5 with all the pluses that are in the project at the moment, with Cuckoo packaging in the venv and <a href="https://cuckoo.sh/docs/usage/rooter.html">without using root</a> , adding more than 12 security tools in the sandbox!  From the totality of the collected material, I will not be afraid to say: "This is the most complete and verified step in a step of a guide from all published on the Internet at the moment."  For those who master the article to the end - I will give a little advice on what to do when the sandbox is assembled and how to get the maximum profit from automating the information security processes with your fuzz using the open source.  All geeks, virus analysts, security guards, guys from SOC, CERT, CSIRT and just lovers poke buttons in the terminal - welcome under the cat! </p><a name="habracut"></a><br><p>  Over the past few years, a lot has happened in the Cuckoo project, new tools have been added, additional software support has appeared, the number of signatures has increased several times, the malware rating system has appeared, the entire UI has been rewritten and now you can set up a nice dark theme. </p><br><p><img src="https://habrastorage.org/webt/u7/2x/_y/u72x_ywh_achlidlpw_qcp1jzvu.png" alt="black UI"></p><br><p>  The positive changes in the project are obvious - the sandbox began to be updated with micro releases, which promptly close the identified and confirmed bugs.  Developers began <a href="https://cuckoosandbox.org/blog">to write</a> about all small changes <a href="https://cuckoosandbox.org/blog">to the blog</a> , there you can find the roadmap of the project.  Unfortunately, there have been so many changes that it‚Äôs difficult to compile the ‚Äúbefore‚Äù and ‚Äúafter‚Äù tables, now these are 2 platforms from different eras, better see the <a href="https://cuckoosandbox.org/blog">blog</a> yourself, you will like it! </p><br><p><img src="https://habrastorage.org/webt/b_/kx/la/b_kxlayzlhg5chyncg8h7spbzxc.png" alt="Release cycle"></p><br><p>  <em>I advise you to look into the blog more often, the developers have already promised that the zer0mon VM antidetek driver will be included in the master branch, but now the deadlines have been shifted to release 2.1.0, stay tuned, the thing is really necessary!</em> <em><br></em> <br>  The very same code Cuckoo moved to the <a href="https://pypi.python.org/pypi/Cuckoo">PIP</a> package manager and the cuckoo is updated literally into one command. </p><br><p>  The news about the launch of commercial support has also become positive for customers who need stability in their work, since stability has been Cuckoo‚Äôs main drawback since the first releases.  I really hope that the money raised in the project will help developers to achieve high-quality application work. </p><br><p><img src="https://habrastorage.org/webt/sn/jy/xu/snjyxuzigjk-kl1-4-hfskee58k.png" alt="Cuckoo enterpise"></p><br><p>  However, the problem with the installation is unchanged from the beginning of the project - the Cuckoo Sandbox is well documented, and with modules in which bugs always occur - trouble.  Some applications are not documented at all and to understand how and what works - you need to look at the code, some are almost not updated and not supported, like HoneyD.  Having spent a considerable amount of time, I was able to collect the cuckoo with all the recommendations of the developers - to wrap the cuckoo in Venv and configure everything from scratch without using root privileges for Cuckoo!  Each stage is verified step into step by multiple back-ups of backups in the test environment, until the instruction has become fully operational. </p><br><h2 id="osobennosti-sborki">  Assembly features </h2><br><p>  According to the recommendations of the developers, Cuckoo Sandbox 2.0.5 is built on the Ubuntu OS 04/04/03 installed in the ESXi cluster.  As a hypervisor, Cuckoo will use VirtualBox 5.2.  VM installation will be done via VMcloak <a href="http://vmcloak.org/">auto</a> installation <a href="http://vmcloak.org/">script</a> .  With VMcloak, you no longer need to search for vulnerable old software for the guest OS, you do not need to configure the network and Python, VMcloak installs everything you need into one terminal command, including Cuckoo Agent and configures it.  With VMcloak, it is now a pleasure to clone, administer and tune VMs.  I use Windows 7 SP1 X64 as the OS of the virtual environment, although the Cuckoo Sandbox supports all versions of Windows, starting with XP. <br>  Half a year ago, the developers of Cuckoo turned on the ability to proxy traffic from VM through VPN or Tor.  In this setting, I stopped at a simple method - to give access to the Internet directly or through Tor. </p><br><p>  In addition to the Cuckoo Sandbox, the following software will be installed: </p><br><ol><li>  <a href="https://suricata-ids.org/">Suricata</a> - IDS. </li><li>  <a href="https://www.snort.org/">Snort</a> - IDS. </li><li>  <a href="http://www.honeyd.org/">HoneyD</a> - Honeypot. </li><li>  <a href="http://www.inetsim.org/">InetSim</a> - Network Emulator. </li><li>  <a href="https://www.torproject.org/">Tor</a> - onion routing guest VM traffic. </li><li>  <a href="https://github.com/tesseract-ocr/">Teserract</a> - Recognize text on screenshots. </li><li>  <a href="https://mitmproxy.org/">MitMproxy</a> - Analysis of SSL traffic through "man-in-the-middle". </li><li>  <a href="https://molo.ch/">Moloch</a> - IDS (very convenient and cool utility for analyzing traffic). </li><li>  <a href="https://ssdeep-project.github.io/ssdeep/index.html">SSDeep</a> - Fuzzy-Hashing. </li><li>  <a href="http://www.volatilityfoundation.org/">Volatility</a> - RAM research framework. </li><li>  <a href="https://github.com/gdabah/distorm">Distorm3</a> - Disassembler. </li><li>  <a href="https://virustotal.github.io/yara/">Yara</a> - A utility for recognizing and classifying malware. </li></ol><br><p> The thirteenth item should have been the program for streaming antivirus analysis of <a href="http://irma.quarkslab.com/">IRMA</a> files, but when IRMA was turned on in Cuckoo, uploading the report to Elastic broke, the developers did not give an answer for this bug, and there was no time to analyze the elastic Index.  Therefore, in this manual there will be an item about assembling IRMA, but integration with Cuckoo will not be included.  Perhaps there is an ELK stack guru, ready to valiantly overcome the bug and supplement my article.  Find IRMA and use it will be possible on port 8080. </p><br><p>  As a drawback, I can point out incorrect links to Moloch in the web interface of the sandbox, you can probably fix it, but for me this is not critical, the Moloch service itself will hang on port 8005 and this is enough. </p><br><p><img src="https://habrastorage.org/webt/0r/do/iw/0rdoiwgrlb_2yi1u90okdy8eiq8.png" alt="moloch bug"></p><br><p>  Cuckoo will store the data of skinings in MongoDB database, system data in Postgresql and indexes in Elasticsearch for quick search and retrieval, export to Json, HTML and PDF, work through the Nginx web server with SSL configured across all canons (not counting self-signed cert) and in conjunction with UWSGI. </p><br><p>  This assembly is configured only for analysis in the Windows sandbox.  Android, OS X and Linux are not configured.  If there are questions on this part - write to the LAN, theoretically I know how to do it, but this functionality is beyond the scope of my interests and my work at the moment. </p><br><h2 id="osobennosti-manuala">  Manual features </h2><br><p>  In the current article, the auto-install script will not be provided.  Of course, I am not too lazy to write it, but there is no point in it so that the sandbox works correctly - it is better to collect manually and <strong>carefully</strong> look at what is going to, analyze <strong>each</strong> error.  You still build an application that interacts with a dozen external programs that are constantly updated.  Bugs are inevitable, so it‚Äôs better to find them yourself than to figure out what went wrong in the script. </p><br><p>  In this article, I did not make all the dependencies of installed programs to the very beginning in one line, as in the previous article.  For each specific software connected to Cuckoo dependencies are listed in the installation section of this software. </p><br><p>  4 years of malware analysis using Cuckoo showed me a very obvious linear relationship - the more you connect to the services sandbox, the worse it works.  Therefore, it makes no sense to put all the dependencies at once, because older and more experienced IT professionals may give up on those components that are unstable, and the information from them will be redundant.  The best is the enemy of the good, as they say. </p><br><p>  This article does not involve the <a href="https://docs.cuckoosandbox.org/en/latest/usage/api/">REST API</a> , it is quite simple to do this, but I don‚Äôt need it at the current stage. </p><br><p>  I will not describe each utility in detail, I‚Äôll only mark the important, especially the essential part of the utilities described in my <a href="https://habrahabr.ru/post/234467/">last article</a> , and there is also info on how to enable REST API. </p><br><p>  And most importantly - the article is published for several months after the assembly instructions, something can already change, something does not work.  If you met a bug - write in the LAN. </p><br><p>  And now we will answer the most popular question and proceed with the installation! </p><br><h2 id="a-chto-esli-ya-ne-silyon-v-etih-vashih-linux-a-pesochnica-ochen-nuzhna">  And what if I'm not strong in these of your Linux, and the sandbox is very necessary </h2><br><p>  The answer to this question is simple - use online sandboxes or mess with <a href="https://technet.microsoft.com/ru-ru/library/bb545021.aspx">Windows Sysinternals</a> . </p><br><ul><li>  <a href="http://cuckoo.cert.ee/">Service number 1, <strong>"Estonian Cuckoo"</strong></a> .  Very competently assembled Cuckoo Sandbox latest version from the Estonian Computer Emergency Response Team CERT.  The best sandbox implementation I've found on the net.  Using the service, we remember that the downloaded data can be parsed into <a href="https://en.wikipedia.org/wiki/Indicator_of_compromise">competence indicators (IoC)</a> and transferred to other national CERTs using <a href="http://www.misp-project.org/">MISP</a> software in accordance with the established <a href="https://www.us-cert.gov/tlp">TLP</a> transfer rules.  Therefore, carefully consider whether or not you should upload confidential software there. </li><li>  <a href="https://www.hybrid-analysis.com/">Service number 2, <strong>"Hybrid Analysis"</strong></a> .  A sandbox popular in narrow circles (or not in narrow ones) online, the stability and quality of which is at its best, from the minuses - the functionality is a bit limited, the malware samples cannot be unloaded. </li><li>  <a href="https://malwr.com/">Service number 3, <strong>"Ever-dead Malwr"</strong></a> - the most popular sandbox, supported by the authors of the Cuckoo Sandbox, has fallen again under load and does not rise for half a year.  The only site from which it was possible to load samples of viral software for analysis for free, not counting <a href="https://github.com/ytisf/theZoo">this collection</a> .  I hope for a revival, but the forecast is not comforting. </li><li>  <a href="https://yandex.ru/support/search/query-language/qlanguage.html">Option 4, <strong>"I will search for myself"</strong></a> - for those who are familiar with the principles of OSINT and the language of search queries.  We take a piece of static text from the platform: <br><img src="https://habrastorage.org/webt/5w/-p/fq/5w-pfqvwtdenid7vh70ows-jdbm.png" alt="osint"><br>  And we google in quotes, finding all sandboxes in the index excluding github: <br><img src="https://habrastorage.org/webt/2r/vt/q4/2rvtq4jlvdjwwsfcdjsrgcadezg.png" alt="google osint"></li></ul><br><h2 id="sborka">  Assembly </h2><br><p>  So, the theoretical part behind, we start practice! </p><br><h3 id="obnovlenie-os">  OS update </h3><br><p>  We update system packages. </p><br><pre><code class="bash hljs">sudo apt update sudo apt upgrade -y</code> </pre> <br><h3 id="zavisimosti-cuckoo">  Cuckoo Dependencies </h3><br><p>  Install the Cuckoo dependencies. </p><br><pre> <code class="bash hljs">sudo apt install python python-pip python-dev libffi-dev libssl-dev libfuzzy-dev -y sudo apt install python-virtualenv python-setuptools -y sudo apt install libjpeg-dev zlib1g-dev swig -y sudo -H pip install -U pip</code> </pre> <br><h3 id="virtualbox">  Virtualbox </h3><br><p>  Install Virtualbox with extpack. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo sh -c <span class="hljs-string"><span class="hljs-string">'echo "deb http://download.virtualbox.org/virtualbox/debian xenial contrib" &gt;&gt; /etc/apt/sources.list.d/virtualbox.list'</span></span> sudo wget -q https://www.virtualbox.org/download/oracle_vbox_2016.asc -O- | sudo apt-key add - sudo apt update &amp;&amp; sudo apt install virtualbox-5.2 -y VBOX_LATEST_VERSION=$(curl http://download.virtualbox.org/virtualbox/LATEST.TXT) sudo wget http://download.virtualbox.org/virtualbox/<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>/Oracle_VM_VirtualBox_Extension_Pack-<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>.vbox-extpack sudo vboxmanage extpack install Oracle_VM_VirtualBox_Extension_Pack-<span class="hljs-variable"><span class="hljs-variable">${VBOX_LATEST_VERSION}</span></span>.vbox-extpack</code> </pre> <br><h3 id="cuckoo-sandbox">  Cuckoo sandbox </h3><br><p>  Install Venv, activate and install Cuckoo via PIP. </p><br><pre> <code class="bash hljs">sudo adduser cuckoo sudo usermod -a -G vboxusers cuckoo <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/cuckoo su cuckoo virtualenv cuckoo . /home/cuckoo/cuckoo/bin/activate pip install -U pip setuptools psycopg2 yara-python weasyprint pycrypto pydeep easy_install distribute pip install -U cuckoo pip install weasyprint==0.36 pip install m2crypto==0.24.0 cuckoo cuckoo community deactivate sudo apt install python-m2crypto <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br><h3 id="java-dlya-elasticsearch">  Java for Elasticsearch </h3><br><p>  Elastic is written in Java, so we need to install Java. </p><br><pre> <code class="bash hljs">sudo add-apt-repository ppa:webupd8team/java sudo apt update &amp;&amp; sudo apt install oracle-java8-installer -y sudo bash -c <span class="hljs-string"><span class="hljs-string">"echo 'JAVA_HOME=\"/usr/lib/jvm/java-8-openjdk-amd64\"' &gt;&gt; /etc/environment"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> /etc/environment</code> </pre> <br><h3 id="bd">  DB </h3><br><p>  Here we install and configure all databases, note that the variable "db_passwd" generates a random password to the Postgres database, if you want to set your own - do not forget to set it. <br>  Cuckoo uses the outdated Elastic version 2, pay attention to this and do not accidentally install the 5.x + version. </p><br><pre> <code class="bash hljs">sudo apt install mongodb -y sudo apt install postgresql libpq-dev -y sudo pip install psycopg2 db_passwd=$(date +%s | sha256sum | base64 | head -c 32 ; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"CREATE USER cuckoo WITH PASSWORD '</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$db_passwd</span></span></span><span class="hljs-string">';"</span></span> | sudo -u postgres psql <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"CREATE DATABASE cuckoo;"</span></span> | sudo -u postgres psql <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"GRANT ALL PRIVILEGES ON DATABASE cuckoo to cuckoo;"</span></span> | sudo -u postgres psql wget -qO - https://packages.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add - <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://packages.elastic.co/elasticsearch/2.x/debian stable main"</span></span> | sudo tee -a /etc/apt/sources.list.d/elasticsearch-2.x.list sudo apt update &amp;&amp; sudo apt install elasticsearch -y sudo systemctl daemon-reload sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> elasticsearch.service sudo service elasticsearch stop <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/cuckoo/ sudo mkdir /home/cuckoo/ESData sudo chown root:elasticsearch ESData sudo chmod 777 /home/cuckoo/ESData sudo usermod -a -G elasticsearch cuckoo sudo bash -c <span class="hljs-string"><span class="hljs-string">"cat &gt;&gt; /etc/elasticsearch/elasticsearch.yml &lt;&lt;DELIM cluster.name: es-cuckoo node.name: es-node-n1 node.master: true node.data: true bootstrap.mlockall: true path.data: /home/cuckoo/ESData network.bind_host: 0.0.0.0 DELIM"</span></span> sudo service elasticsearch start sudo curl -X PUT -d @<span class="hljs-string"><span class="hljs-string">'/home/cuckoo/.cuckoo/elasticsearch/template.json'</span></span> <span class="hljs-string"><span class="hljs-string">'http://localhost:9200/_template/cuckoo'</span></span></code> </pre> <br><h3 id="yara--rules">  Yara + rules </h3><br><p>  Install the latest version of Yara and add the rules of Yara to Cuckoo. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo apt install dh-autoreconf flex bison libjansson-dev libmagic-dev -y sudo wget https://github.com/VirusTotal/yara/archive/v3.7.1.tar.gz sudo tar -zxf v3.7.1.tar.gz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> yara-3.6.3/ sudo ./bootstrap.sh sudo ./configure --with-crypto --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-cuckoo --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-magic sudo make sudo make install sudo -H pip install -U yara-python <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/cuckoo/.cuckoo/yara/ su cuckoo sudo git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/lehuff/cuckoo-yara-rules.git sudo cp cuckoo-yara-rules/cuckoo-yara-rules.py . sudo rm -rf cuckoo-yara-rules sudo python cuckoo-yara-rules.py sudo chown -R cuckoo:cuckoo /home/cuckoo/.cuckoo/</code> </pre> <br><h3 id="ssdeep">  SSDeep </h3><br><p>  Install SSDeep. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo -H pip install -U ssdeep sudo git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/bunzen/pySSDeep.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> pySSDeep sudo python setup.py build sudo python setup.py install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> -</code> </pre> <br><h3 id="volatility">  Volatility </h3><br><p>  Installing Volatility is simple, but forcing Cuckoo from venv to see it ‚Äî not really, to put it in the venv along with Cuckoo is also not an option, it changes the versions of Cuckoo libraries with dependencies.  From the third line of a crutch that solves this problem, if anyone has an idea how to make friends with it in the right way - write. </p><br><pre> <code class="bash hljs">sudo apt install pcregrep libpcre++-dev -y sudo -H pip install -U git+https://github.com/kbandla/pydeep.git sudo apt install volatility -y cp -r /usr/lib/python2.7/dist-packages/volatility* /home/cuckoo/cuckoo/lib/python2.7/site-packages sudo chown cuckoo:cuckoo /home/cuckoo/cuckoo/lib/python2.7/site-packages/* mv /home/cuckoo/.cuckoo/signatures/windows/volatility_sig.py /home/cuckoo/.cuckoo/signatures/windows/volatility_sig.py.deactivate</code> </pre> <br><h3 id="tcpdump">  TCPDump </h3><br><p>  Reached TCP dump. </p><br><pre> <code class="bash hljs">sudo apt install tcpdump apparmor-utils -y sudo aa-disable /usr/sbin/tcpdump sudo <span class="hljs-built_in"><span class="hljs-built_in">setcap</span></span> cap_net_raw,cap_net_admin=eip /usr/sbin/tcpdump sudo chmod +s /usr/sbin/tcpdump</code> </pre> <br><h3 id="teserract">  Teserract </h3><br><p>  It is put simply, it is connected too, however I have not noticed delights in work of OCR. </p><br><pre> <code class="bash hljs">sudo apt install tesseract-ocr -y</code> </pre> <br><h3 id="fonts-for-pdf">  Fonts for PDF </h3><br><p>  Without this magic, PDF reports will not be generated. </p><br><pre> <code class="bash hljs">sudo -H pip install -U cairocffi sudo apt install wkhtmltopdf xvfb xfonts-100dpi -y</code> </pre> <br><h3 id="mitmproxy">  MitMproxy </h3><br><p>  A very useful library that allows you to pry SSL traffic.  Note that Cuckoo only understands version 0.18.2 of the package. </p><br><pre> <code class="bash hljs">sudo apt install libarchive13 libxml2-dev libxslt1-dev -y sudo -H pip install -U mitmproxy==0.18.2 su cuckoo <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ mitmproxy + ctrl-c sudo cp ~/.mitmproxy/mitmproxy-ca-cert.p12 /home/cuckoo/.cuckoo/analyzer/windows/bin/cert.p12 sudo chown cuckoo:cuckoo /home/cuckoo/.cuckoo/analyzer/windows/bin/cert.p12 <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br><h3 id="tor">  Tor </h3><br><p>  It's all quite simple. </p><br><pre> <code class="bash hljs">sudo apt install tor -y sudo sh -c <span class="hljs-string"><span class="hljs-string">'echo TransPort 192.168.56.1:9040 &gt;&gt; /etc/tor/torrc'</span></span> sudo sh -c <span class="hljs-string"><span class="hljs-string">'echo DNSPort 192.168.56.1:5353 &gt;&gt; /etc/tor/torrc'</span></span></code> </pre> <br><h3 id="suricata">  Suricata </h3><br><p>  Initially, I wanted to write what and where in the config it is necessary to edit, but by the time I was able to overcome Suricata and remove all the flaws of work, there were a lot of edits to the config, and 0 was documented, so I publish the config entirely.  Moreover, the original rules file will remain intact. </p><br><pre> <code class="bash hljs">sudo add-apt-repository ppa:oisf/suricata-stable sudo apt update &amp;&amp; sudo apt install suricata -y <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alert http any any -&gt; any any (msg:\"FILE store all\"; filestore; noalert; sid:15; rev:1;)"</span></span> | sudo tee /etc/suricata/rules/cuckoo.rules sudo touch /etc/suricata/suricata-cuckoo.yaml</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">/etc/suricata/suricata-cuckoo.yaml</b> <div class="spoiler_text"><pre> <code class="bash hljs">%YAML 1.1 --- vars: address-groups: HOME_NET: <span class="hljs-string"><span class="hljs-string">"[192.168.0.0/16,10.0.0.0/8,172.16.0.0/12]"</span></span> EXTERNAL_NET: <span class="hljs-string"><span class="hljs-string">"any"</span></span> HTTP_SERVERS: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> SMTP_SERVERS: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> SQL_SERVERS: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> DNS_SERVERS: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> TELNET_SERVERS: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> AIM_SERVERS: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$EXTERNAL_NET</span></span></span><span class="hljs-string">"</span></span> DNP3_SERVER: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> DNP3_CLIENT: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> MODBUS_CLIENT: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> MODBUS_SERVER: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> ENIP_CLIENT: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> ENIP_SERVER: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HOME_NET</span></span></span><span class="hljs-string">"</span></span> port-groups: HTTP_PORTS: <span class="hljs-string"><span class="hljs-string">"80"</span></span> SHELLCODE_PORTS: <span class="hljs-string"><span class="hljs-string">"!80"</span></span> ORACLE_PORTS: 1521 SSH_PORTS: 22 DNP3_PORTS: 20000 MODBUS_PORTS: 502 FILE_DATA_PORTS: <span class="hljs-string"><span class="hljs-string">"[</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$HTTP_PORTS</span></span></span><span class="hljs-string">,110,143]"</span></span> FTP_PORTS: 21 default-rule-path: /etc/suricata/rules rule-files: - botcc.rules - ciarmy.rules - compromised.rules - drop.rules - dshield.rules - emerging-attack_response.rules - emerging-chat.rules - emerging-current_events.rules - emerging-dns.rules - emerging-dos.rules - emerging-exploit.rules - emerging-ftp.rules - emerging-imap.rules - emerging-malware.rules - emerging-misc.rules - emerging-mobile_malware.rules - emerging-netbios.rules - emerging-p2p.rules - emerging-policy.rules - emerging-pop3.rules - emerging-rpc.rules - emerging-scan.rules - emerging-smtp.rules - emerging-snmp.rules - emerging-sql.rules - emerging-telnet.rules - emerging-tftp.rules - emerging-trojan.rules - emerging-user_agents.rules - emerging-voip.rules - emerging-web_client.rules - emerging-web_server.rules - emerging-worm.rules - tor.rules - http-events.rules - smtp-events.rules - dns-events.rules - tls-events.rules classification-file: /etc/suricata/classification.config reference-config-file: /etc/suricata/reference.config default-log-dir: /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/suricata/ stats: enabled: yes interval: 8 outputs: - fast: enabled: no filename: fast.log append: yes - eve-log: enabled: yes filetype: regular filename: eve.json types: - alert: metadata: yes tagged-packets: yes xff: enabled: no mode: extra-data deployment: reverse header: X-Forwarded-For - http: extended: yes - dns: query: yes answer: yes - tls: extended: yes - files: force-magic: no - smtp: - ssh - stats: totals: yes threads: no deltas: no= - flow - unified2-alert: enabled: no filename: unified2.alert xff: enabled: no mode: extra-data deployment: reverse header: X-Forwarded-For - http-log: enabled: no filename: http.log append: yes - tls-log: enabled: no filename: tls.log append: yes - tls-store: enabled: no - dns-log: enabled: no filename: dns.log append: yes - pcap-log: enabled: no filename: log.pcap <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>: 1000mb max-files: 2000 mode: normal use-stream-depth: no honor-pass-rules: no - alert-debug: enabled: no filename: alert-debug.log append: yes - alert-prelude: enabled: no profile: suricata <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-packet-content: no <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-packet-header: yes - stats: enabled: yes filename: stats.log totals: yes threads: no - syslog: enabled: no facility: local5 - drop: enabled: yes filename: drop.log append: yes - file-store: enabled: yes <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>-dir: files force-magic: no force-filestore: no - file-log: enabled: yes filename: files-json.log append: yes force-magic: no - tcp-data: enabled: no <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: file filename: tcp-data.log - http-body-data: enabled: no <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: file filename: http-data.log - lua: enabled: no scripts: logging: default-log-level: notice default-output-filter: outputs: - console: enabled: yes - file: enabled: yes level: info filename: /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/suricata/suricata.log - syslog: enabled: no facility: local5 format: <span class="hljs-string"><span class="hljs-string">"[%i] &lt;%d&gt; -- "</span></span> af-packet: - interface: eth0 cluster-id: 99 cluster-type: cluster_flow defrag: yes - interface: default pcap: - interface: eth0 - interface: default pcap-file: checksum-checks: auto app-layer: protocols: tls: enabled: yes detection-ports: dp: 443 dcerpc: enabled: yes ftp: enabled: yes ssh: enabled: yes smtp: enabled: yes mime: decode-mime: yes decode-base64: yes decode-quoted-printable: yes header-value-depth: 2000 extract-urls: yes body-md5: no inspected-tracker: content-limit: 100000 content-inspect-min-size: 32768 content-inspect-window: 4096 imap: enabled: detection-only msn: enabled: detection-only smb: enabled: yes detection-ports: dp: 139, 445 nfs: enabled: no dns: tcp: enabled: yes detection-ports: dp: 53 udp: enabled: yes detection-ports: dp: 53 http: enabled: yes request-body-limit: 0 response-body-limit: 0 libhtp: default-config: personality: IDS request-body-limit: 100kb response-body-limit: 100kb request-body-minimal-inspect-size: 32kb request-body-inspect-window: 4kb response-body-minimal-inspect-size: 40kb response-body-inspect-window: 16kb response-body-decompress-layer-limit: 2 http-body-inline: auto double-decode-path: no double-decode-query: no server-config: modbus: enabled: no detection-ports: dp: 502 stream-depth: 0 dnp3: enabled: no detection-ports: dp: 20000 enip: enabled: no detection-ports: dp: 44818 sp: 44818 ntp: enabled: no asn1-max-frames: 256 coredump: max-dump: unlimited host-mode: auto unix-command: enabled: yes filename: custom.socket legacy: uricontent: enabled engine-analysis: rules-fast-pattern: yes rules: yes pcre: match-limit: 3500 match-limit-recursion: 1500 host-os-policy: windows: [0.0.0.0/0] bsd: [] bsd-right: [] old-linux: [] linux: [] old-solaris: [] solaris: [] hpux10: [] hpux11: [] irix: [] macos: [] vista: [] windows2k3: [] defrag: memcap: 32mb <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>-size: 65536 trackers: 65535 max-frags: 65535 prealloc: yes timeout: 60 flow: memcap: 128mb <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>-size: 65536 prealloc: 10000 emergency-recovery: 30 vlan: use-for-tracking: <span class="hljs-literal"><span class="hljs-literal">true</span></span> flow-timeouts: default: new: 30 established: 300 closed: 0 bypassed: 100 emergency-new: 10 emergency-established: 100 emergency-closed: 0 emergency-bypassed: 50 tcp: new: 60 established: 600 closed: 60 bypassed: 100 emergency-new: 5 emergency-established: 100 emergency-closed: 10 emergency-bypassed: 50 udp: new: 30 established: 300 bypassed: 100 emergency-new: 10 emergency-established: 100 emergency-bypassed: 50 icmp: new: 30 established: 300 bypassed: 100 emergency-new: 10 emergency-established: 100 emergency-bypassed: 50 stream: memcap: 64mb checksum-validation: yes inline: auto reassembly: memcap: 256mb depth: 0 toserver-chunk-size: 2560 toclient-chunk-size: 2560 randomize-chunk-size: yes host: <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>-size: 4096 prealloc: 1000 memcap: 32mb decoder: teredo: enabled: <span class="hljs-literal"><span class="hljs-literal">true</span></span> detect: profile: medium custom-values: toclient-groups: 3 toserver-groups: 25 sgh-mpm-context: auto inspection-recursion-limit: 3000 prefilter: default: mpm grouping: profiling: grouping: dump-to-disk: <span class="hljs-literal"><span class="hljs-literal">false</span></span> include-rules: <span class="hljs-literal"><span class="hljs-literal">false</span></span> include-mpm-stats: <span class="hljs-literal"><span class="hljs-literal">false</span></span> mpm-algo: auto spm-algo: auto threading: <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>-cpu-affinity: no cpu-affinity: - management-cpu-set: cpu: [ 0 ] - receive-cpu-set: cpu: [ 0 ] - worker-cpu-set: cpu: [ <span class="hljs-string"><span class="hljs-string">"all"</span></span> ] mode: <span class="hljs-string"><span class="hljs-string">"exclusive"</span></span> prio: low: [ 0 ] medium: [ <span class="hljs-string"><span class="hljs-string">"1-2"</span></span> ] high: [ 3 ] default: <span class="hljs-string"><span class="hljs-string">"medium"</span></span> detect-thread-ratio: 1.0 luajit: states: 128 profiling: rules: enabled: yes filename: rule_perf.log append: yes <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>: 10 json: yes keywords: enabled: yes filename: keyword_perf.log append: yes rulegroups: enabled: yes filename: rule_group_perf.log append: yes packets: enabled: yes filename: packet_stats.log append: yes csv: enabled: no filename: packet_stats.csv locks: enabled: no filename: lock_stats.log append: yes pcap-log: enabled: no filename: pcaplog_stats.log append: yes nfq: nflog: - group: 2 buffer-size: 18432 - group: default qthreshold: 1 qtimeout: 100 max-size: 20000 capture: netmap: - interface: eth2 - interface: default pfring: - interface: eth0 threads: 1 cluster-id: 99 cluster-type: cluster_flow - interface: default ipfw: napatech: hba: -1 use-all-streams: yes streams: [<span class="hljs-string"><span class="hljs-string">"0-3"</span></span>] mpipe: load-balance: dynamic iqueue-packets: 2048 inputs: - interface: xgbe2 - interface: xgbe3 - interface: xgbe4 stack: size128: 0 size256: 9 size512: 0 size1024: 0 size1664: 7 size4096: 0 size10386: 0 size16384: 0 cuda: mpm: data-buffer-size-min-limit: 0 data-buffer-size-max-limit: 1500 cudabuffer-buffer-size: 500mb gpu-transfer-size: 50mb batching-timeout: 2000 device-id: 0 cuda-streams: 2</code> </pre> </div></div><br><p>  And finally, correct rights. </p><br><pre> <code class="bash hljs">sudo mkdir /var/run/suricata sudo chown cuckoo:cuckoo /var/run/suricata sudo chown -R cuckoo:cuckoo /etc/suricata sudo chown -R cuckoo:cuckoo /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/suricata sudo touch /etc/suricata/threshold.config</code> </pre> <br><h3 id="etupdate">  ETupdate </h3><br><p>  Customize auto-update Community Suricata signatures. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/seanthegeek/etupdate.git sudo cp etupdate/etupdate /usr/sbin sudo /usr/sbin/etupdate -V sudo crontab -e 0 0 * * * /usr/sbin/etupdate -V</code> </pre> <br><h3 id="snort">  Snort </h3><br><p>  I didn‚Äôt add rules to it, because I trust Suricata more. </p><br><pre> <code class="bash hljs">sudo apt install snort -y</code> </pre> <br><p>  When configuring, we specify the default interface and subnet 192.168.0.0/16. </p><br><pre> <code class="bash hljs">sudo chown -R cuckoo:cuckoo /etc/snort/ sudo chown -R cuckoo:cuckoo /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/snort/</code> </pre> <br><h3 id="vmcloak-i-windows-7-sp1-x64">  VMcloak and Windows 7 SP1 X64 </h3><br><p>  The most convenient program for automatic deployment of VM Cuckoo.  Significantly shortens the time, but the author rewrote its logic of work and, of course, did not update the documentation.  I advise you to look at either the utility code on <a href="https://github.com/jbremer/vmcloak">GitHub</a> , or <a href="http://vmcloak.readthedocs.io/en/latest/">read the old documentation</a> in order to understand all the pleasures of working with VMcloak and deal with what we will do next. <br>  The most attentive browser will notice that the official repository of the project <a href="https://github.com/jbremer/vmcloak">https://github.com/jbremer/vmcloak</a> differs from that used in the <a href="https://github.com/tweemeterjop/vmcloak">https://github.com/tweemeterjop/vmcloak</a> script below.  In relation to the fork, the original did not know how to enable vRDE - an implementation of the RDP protocol in a custom guest VM. <br>  Probably the correct option would be to take the original code and finish the vRDE into it, however if the fork is not so far from the original, you can use the fork, as I do below.  At the time of setup, the repository and its fork practically had no differences. <br>  From my own experience I will say - vRDE is needed, there are use cases when the target attack document is protected by a Word password and the password must be entered in order for the virus to work in the sandbox, or the virus is glued to the installer, which must be installed.  Without vRDE, this is problematic.  Yes, and to further configure the OS vRDE, we also need. </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo apt install libyaml-dev libpython2.7-dev genisoimage -y sudo git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b vrde https://github.com/tweemeterjop/vmcloak.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> vmcloak/ sudo cp /home/cuckoo/.cuckoo/agent/agent.py vmcloak/data/bootstrap/ sudo -H pip install -r requirements.txt sudo python setup.py install <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. sudo mkdir -p /mnt/win7 sudo mount -o loop,ro ~/en_windows_7_enterprise_with_sp1_x64_dvd_u_677651.iso /mnt/win7/ sudo vmcloak-vboxnet0 sudo vmcloak-iptables 192.168.56.0/24 ens160 <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/cuckoo su cuckoo vmcloak init --vrde --resolution 1280x1024 --ramsize 4096 --win7_x64 --product professional --cpus 2 win7x64 vmcloak install --vrde win7_x64 python27 pillow adobepdf chrome cuteftp dotnet40 flash java silverlight vcredist wic vmcloak modify --vrde win7_x64</code> </pre> <br><h3 id="nastroyka-windows-7">  Windows 7 Setup </h3><br><p>  After </p><br><pre> <code class="bash hljs">vmcloak modify --vrde win7_x64</code> </pre> <br><p>  VM will start, you can connect to it via RDP.  If you work with Win10 - do not use the tile application of the remote desktop, it falls into a stupor and trance, when the connection goes to the VM without a login and password, use the classic application, everything is OK. </p><br><p>  The following items on my list are optional, however, in order to reduce the number of false positives and simplify the operation of malware, it is recommended to disable (or enable) all of the following.  Not superfluous and installation in the guest VM software, which is used at work by all employees. </p><br><p>  An example of unnecessary data in the report: </p><br><p><img src="https://habrastorage.org/webt/70/iq/nc/70iqnc7fup4ufjr3wejkocqy3jq.png" alt="False Positive"></p><br><p>  <strong>I will notice!</strong>  All of the following should be done only for Windows 7 SP1 x64, on other operating systems actions may be different. </p><br><p>  After some time working with the new sandbox, my list began to include the following items: </p><br><ul><li><p>  Disable Windows Messenger broadcasts on UDP port 1900 </p><br><p>  HKEY_LOCAL_MACHINE \ Software \ Microsoft \ DirectPlayNATHelp \ DPNHUPnP key Name: UPnPMode Type: REG_DWORD Value: 2 </p><br></li><li><p>  Turn off x64 driver checking so that Cuckoo works fine with x64 </p><br><p>  cmd - bcdedit.exe / set nointegritychecks ON </p><br></li><li><p>  disable NCSI </p><br><p>  HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ NlaSvc \ Parameters \ Internet EnableActiveProbing Type Key: REG_DWORD Value: 0 </p><br></li><li><p>  disable teredo.ipv6.microsoft.com </p><br><p>  cmd - netsh interface teredo set state disabled </p><br></li><li><p>  disable IPv6 </p><br><p>  HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Services \ Tcpip6 \ Parameters \ add the DWORDDisabled key DisabledComponents 8 </p><br></li><li>  Disable Tredo Network Adapters </li><li>  Disable autorun Adobe Reader, Flash player, MS Office </li><li>  Disable Chrome Update </li><li>  In chrome: // plugins allow the launch of the vulnerable flash </li><li>  In the settings of Chrome to allow everything in content settings </li><li>  In the HKEY_LOCAL_MACHINE \ SOFTWARE \ Policies \ Google branch, delete Update </li><li>  Disable services FP, UPnP, SSDP </li><li>  Set the default chrome browser </li><li>  Set an empty chrome start page </li><li>  Disable Chrome privacy settings </li><li>  Install FileZilla </li><li>  Disable synchronization with NTP </li><li>  Disable secure viewing office (Data execution prevention mode) </li><li>  Allow autorun macros in all applications in the office </li></ul><br><p>  The sequence of compiling your own instructions under your own OS: </p><br><ol><li>  We check the legitimate executable file in the sandbox; </li><li>  We look, where and in what tabs superfluous info appeared, for example, the appeal to time.microsoft.com; </li><li>  Open Google and see how we disable it; </li><li>  We write down, we disconnect. </li></ol><br><h3 id="dobavlenie-vm-v-cuckoo">  Adding VM to Cuckoo </h3><br><p>  Create a snapshot of a newly configured guest OS and add to Cuckoo at the same time removing the pre-installed VM cuckoo1 from the config. </p><br><pre> <code class="bash hljs">vmcloak snapshot win7_x64 win7_x64node1 192.168.56.101 . /home/cuckoo/cuckoo/bin/activate cuckoo machine --add win7x64node1 192.168.56.101 --platform windows --snapshot vmcloak cuckoo machine --delete cuckoo1 deactivate</code> </pre> <br><h3 id="moloch">  Moloch </h3><br><p>  The coolest tool for working with network traffic.  Unlike other network analyzers, Moloch stakes on an analytics toolkit with tons of features, timelines, graphs, and more.  I am very sorry that I learned about it so recently and used to this less convenient <a href="https://github.com/tomchop/malcom">MalCom</a> .  One of the key advantages of Moloch is the ability to combine and analyze all the network packets of all scans from Cuckoo at one time.  Well, working in conjunction with Elasticsearch allows Moloch to process a huge amount of data. </p><br><p>  This is what this beauty looks like (screen from the official repository): </p><br><p><img src="https://habrastorage.org/webt/d4/o_/ec/d4o_ec5pgsr8evpp5adgwbkhkio.png" alt="Moloch GSh"></p><br><p>  Well, also install it. </p><br><pre> <code class="bash hljs">sudo apt install libjson-perl -y <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo wget https://files.molo.ch/builds/ubuntu-16.04/moloch_0.20.2-2_amd64.deb sudo dpkg -i moloch_0.20.2-2_amd64.deb sudo /data/moloch/bin/Configure</code> </pre> <br><p>  Next, you must specify the interface vboxnet0, the login and password Moloch, the Elasticsearch IP address. </p><br><pre> <code class="bash hljs">sudo /data/moloch/db/db.pl http://localhost:9200 init sudo /data/moloch/bin/moloch_add_user.sh cuckoo cuckoo cuckoosandbox --admin</code> </pre> <br><h3 id="inetsim">  InetSim </h3><br><p>  We establish a virtual local area network that the virus was not lonely in a sandbox.  Settings emulated services left default, 18 emulated services turned out, not counting the web. </p><br><pre> <code class="bash hljs">sudo su <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"deb http://www.inetsim.org/debian/ binary/"</span></span> &gt; /etc/apt/sources.list.d/inetsim.list wget -O - http://www.inetsim.org/inetsim-archive-signing-key.asc | apt-key add - apt update apt install inetsim <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br><p>  In the /etc/internet / windowsim.conf config, you need to comment out the HTTP and HHTPS web services so that they do not conflict with Cuckoo: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#start_service http #start_service https</span></span></code> </pre> <br><h3 id="irma">  IRMA </h3><br><p><img src="https://habrastorage.org/webt/l3/nu/3r/l3nu3relhlvbpxr6ltgzx9r3soc.jpeg" alt="IRMA"></p><br><p>  The IRMA sandbox is not integrated due to the problem of uploading reports to Elasticsearch.  But this does not prevent us from deploying and testing the utility.  IRMA is compiled into <a href="https://www.vagrantup.com/">Vagrant</a> and deployed automatically via <a href="https://www.ansible.com/">Ansible</a> strictly version 2.2.1.0. </p><br><pre> <code class="bash hljs">sudo apt install vagrant -y <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo wget https://releases.hashicorp.com/vagrant/2.0.2/vagrant_2.0.2_x86_64.deb sudo dpkg -i vagrant_2.0.2_x86_64.deb sudo -H pip install -U ansible==2.2.1.0</code> </pre> <br><p>  Download IRMA: </p><br><pre> <code class="bash hljs">sudo git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/quarkslab/irma <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> irma/ansible</code> </pre> <br><p>  Let's add forwarding from VM to port 8080 by adding to the / opt / irma / ansible / Vagrantfile file <br>  line 19: </p><br><pre> <code class="bash hljs">config.vm.network <span class="hljs-string"><span class="hljs-string">"forwarded_port"</span></span>, guest: 80, host: 8080</code> </pre> <br><p>  And install IRMA: </p><br><pre> <code class="bash hljs">sudo vagrant up</code> </pre> <br><h3 id="honeyd">  HoneyD </h3><br><p>  HoneyD is the oldest and extremely functional hanipot.  There is only one minus in it - it ceased to be updated several years ago.  Skills to search for suitable forks were successfully applied, after which a relatively fresh version of the HoneyD installation via <a href="https://www.ansible.com/">Ansible</a> was found, which I hurried to use.  In Hanipot, I have nastril only one host, you can configure at least a whole subnet using the <a href="http://www.honeyd.org/configuration.php">official manual</a> . </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/ sudo git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/Bifrozt/honeyd-ansible.git <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> honeyd-ansible/ sudo ansible-playbook honeyd.yml sudo touch /usr/share/honeyd/config.conf</code> </pre> <br><p>  Save the config. </p><br><div class="spoiler">  <b class="spoiler_title">/usr/share/honeyd/config.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">create default <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> default default tcp action filtered <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> default default udp action filtered <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> default default icmp action filtered create windows <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> windows personality <span class="hljs-string"><span class="hljs-string">"Microsoft Windows XP Professional SP3"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> windows uptime 1728650 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> windows maxfds 35 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> windows default tcp action reset add windows tcp port 135 open add windows tcp port 139 open add windows tcp port 445 open <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> windows ethernet <span class="hljs-string"><span class="hljs-string">"08:00:27:81:1d:0c"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bind</span></span> 192.168.56.103 windows</code> </pre> </div></div><br><h3 id="veb-server">  Web server </h3><br><p>  Install Nginx, generate a certificate and even enable http2 support. </p><br><pre> <code class="bash hljs">sudo add-apt-repository ppa:nginx/development sudo apt update sudo apt install nginx -y sudo openssl dhparam -out /etc/ssl/certs/dhparam.pem 2048 sudo mkdir /etc/nginx/ssl sudo openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/ssl/nginx.key -out /etc/nginx/ssl/nginx.crt sudo -H pip install -U uwsgi <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /home/cuckoo/ sudo mkdir /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/uwsgi/ sudo mkdir /etc/uwsgi sudo chown cuckoo:cuckoo /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/uwsgi/ sudo chown cuckoo:cuckoo /etc/uwsgi/ su cuckoo</code> </pre> <br><p>  Next, add the UWSGI config. </p><br><div class="spoiler">  <b class="spoiler_title">/etc/uwsgi/cuckoo.ini</b> <div class="spoiler_text"><pre> <code class="bash hljs">[uwsgi] plugins = python socket = /tmp/uwsgi.sock chmod-socket = 664 master = <span class="hljs-literal"><span class="hljs-literal">true</span></span> processes = 4 virtualenv = /home/cuckoo/cuckoo module = cuckoo.web.web.wsgi uid = cuckoo gid = cuckoo static-map = /static=/home/cuckoo/cuckoo/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib/python2.7/site-packages/cuckoo/web/static env = CUCKOO_APP=web env = CUCKOO_CWD=/home/cuckoo/.cuckoo</code> </pre> </div></div><br><p>  And the nginx config, changing the IP and site name: </p><br><div class="spoiler">  <b class="spoiler_title">/ etc / nginx / sites-available / cuckoo-web</b> <div class="spoiler_text"><pre> <code class="bash hljs">upstream _uwsgi_cuckoo_web { server unix:/tmp/uwsgi.sock; } server { listen 80; listen [::]:80; server_name cuckoo.test.ru; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> 301 https://10.0.0.3<span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>; server_tokens off; } server { listen 443 ssl http2; listen [::]:443 ssl http2; server_name cuckoo.test.ru; ssl_certificate /etc/nginx/ssl/nginx.crt; ssl_certificate_key /etc/nginx/ssl/nginx.key; ssl_dhparam /etc/ssl/certs/dhparam.pem; ssl_session_timeout 1d; ssl_session_cache shared:SSL:50m; ssl_session_tickets off; ssl_protocols TLSv1.2; ssl_ciphers <span class="hljs-string"><span class="hljs-string">'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256'</span></span>; ssl_prefer_server_ciphers on; add_header Strict-Transport-Security <span class="hljs-string"><span class="hljs-string">"max-age=15768000"</span></span>; ssl_stapling on; ssl_stapling_verify on; server_tokens off; location / { client_max_body_size 1G; proxy_redirect off; proxy_set_header X-Forwarded-Proto <span class="hljs-variable"><span class="hljs-variable">$scheme</span></span>; uwsgi_pass _uwsgi_cuckoo_web; include uwsgi_params; } }</code> </pre> </div></div><br><p>  Now add the user www-data to the cuckoo group and use the symlink to enable our config. </p><br><pre> <code class="bash hljs">sudo adduser www-data cuckoo sudo ln -s /etc/nginx/sites-available/cuckoo-web /etc/nginx/sites-enabled/ sudo systemctl reload nginx</code> </pre> <br><h3 id="konfigi-cuckoo">  Cuckoo configs </h3><br><p>  And finally, the most important thing - we combine everything collected in the sandbox.  To explain what is there to what is long, meaningless and 85% of the parameters are intuitive, I suggest using the <a href="https://media.readthedocs.org/pdf/cuckoo/latest/cuckoo.pdf">official documentation</a> starting from page 96, if there are difficulties in understanding some of the parameters.  Either the main peep in my last article.  Not the worst will be the option to copy and use my files below, but at your own peril and risk. </p><br><div class="spoiler">  <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/auxiliary.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[sniffer] enabled = yes tcpdump = /usr/sbin/tcpdump bpf = [mitm] enabled = yes mitmdump = /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/mitmdump port_base = 50000 script = mitm.py certificate = bin/cert.p12 [services] enabled = yes services = honeyd timeout = 0 [reboot] enabled = yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/cuckoo.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[cuckoo] version_check = yes delete_original = no delete_bin_copy = no machinery = virtualbox memory_dump = yes terminate_processes = no reschedule = no process_results = yes max_analysis_count = 0 max_machines_count = 0 max_vmstartup_count = 10 freespace = 1024 tmppath = rooter = /tmp/cuckoo-rooter [feedback] enabled = no name = company = email = [resultserver] ip = 192.168.56.1 port = 2042 force_port = no upload_max_size = 134217728 [processing] analysis_size_limit = 134217728 resolve_dns = yes sort_pcap = yes [database] connection = postgresql://cuckoo:Supersecretpassword4habr@localhost:5432/cuckoo timeout = 60 [timeouts] default = 120 critical = 60 vm_state = 60</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/memory.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[basic] guest_profile = Win7SP1x64 delete_memdump = yes [malfind] enabled = yes filter = yes [apihooks] enabled = no filter = yes [pslist] enabled = yes filter = no [psxview] enabled = yes filter = no [callbacks] enabled = yes filter = no [idt] enabled = yes filter = no [timers] enabled = yes filter = no [messagehooks] enabled = no filter = no [getsids] enabled = yes filter = no [privs] enabled = yes filter = no [dlllist] enabled = yes filter = yes [handles] enabled = yes filter = yes [ldrmodules] enabled = yes filter = yes [mutantscan] enabled = yes filter = yes [devicetree] enabled = yes filter = yes [svcscan] enabled = yes filter = yes [modscan] enabled = yes filter = yes [yarascan] enabled = yes filter = yes [ssdt] enabled = yes filter = yes [gdt] enabled = yes filter = yes [sockscan] enabled = yes filter = no [netscan] enabled = no filter = no [mask] enabled = no pid_generic =</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/processing.conf</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">[analysisinfo] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [apkinfo] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> decompilation_threshold = <span class="hljs-number"><span class="hljs-number">5000000</span></span> [baseline] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> [behavior] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [buffer] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [debug] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [droidmon] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> [dropped] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [dumptls] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [extracted] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [googleplay] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> android_id = google_login = google_password = [memory] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [misp] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> url = apikey = maxioc = <span class="hljs-number"><span class="hljs-number">100</span></span> [network] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> whitelist_dns = <span class="hljs-literal"><span class="hljs-literal">no</span></span> allowed_dns = [procmemory] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> idapro = <span class="hljs-literal"><span class="hljs-literal">no</span></span> extract_img = <span class="hljs-literal"><span class="hljs-literal">no</span></span> extract_dll = <span class="hljs-literal"><span class="hljs-literal">no</span></span> dump_delete = <span class="hljs-literal"><span class="hljs-literal">no</span></span> [procmon] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [screenshots] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> tesseract = <span class="hljs-regexp"><span class="hljs-regexp">/usr/bin/tesseract [snort] enabled = yes snort = /usr/sbin/snort conf = /etc/snort/snort.conf [static] enabled = yes pdf_timeout = 60 [strings] enabled = yes [suricata] enabled = yes suricata = /usr/bin/suricata conf = /etc/suricata/suricata-cuckoo.yaml eve_log = eve.json files_log = files-json.log files_dir = files socket = [targetinfo] enabled = yes [virustotal] enabled = yes timeout = 60 scan = yes key =   virustotal [irma] enabled = no timeout = 300 scan = yes force = yes url = http:/</span></span>/<span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.30</span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/reporting.conf</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">[feedback] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> [jsondump] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> indent = <span class="hljs-number"><span class="hljs-number">4</span></span> calls = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [singlefile] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> html = <span class="hljs-literal"><span class="hljs-literal">no</span></span> pdf = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> [misp] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> url = apikey = mode = maldoc ipaddr hashes url [mongodb] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> host = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> port = <span class="hljs-number"><span class="hljs-number">27017</span></span> db = cuckoo store_memdump = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> paginate = <span class="hljs-number"><span class="hljs-number">100</span></span> username = password = [elasticsearch] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> hosts = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> timeout = <span class="hljs-number"><span class="hljs-number">300</span></span> calls = <span class="hljs-literal"><span class="hljs-literal">no</span></span> index = cuckoo index_time_pattern = yearly cuckoo_node = [moloch] enabled = <span class="hljs-literal"><span class="hljs-literal">yes</span></span> host = <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">8005</span></span> insecure = <span class="hljs-literal"><span class="hljs-literal">no</span></span> moloch_capture = /data/moloch/bin/moloch-capture conf = /data/moloch/etc/config.ini instance = cuckoo [notification] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> url = identifier = [mattermost] enabled = <span class="hljs-literal"><span class="hljs-literal">no</span></span> url = myurl = username = cuckoo show_virustotal = <span class="hljs-literal"><span class="hljs-literal">no</span></span> show_signatures = <span class="hljs-literal"><span class="hljs-literal">no</span></span> show_urls = <span class="hljs-literal"><span class="hljs-literal">no</span></span> hash_filename = <span class="hljs-literal"><span class="hljs-literal">no</span></span> hash_url = <span class="hljs-literal"><span class="hljs-literal">no</span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/routing.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[routing] route = none internet = ens160 rt_table = main auto_rt = yes drop = no [inetsim] enabled = yes server = 192.168.56.1 [tor] enabled = yes dnsport = 5353 proxyport = 9040 [vpn] enabled = no vpns = vpn0 [vpn0] name = vpn0 description = Spain, Europe interface = tun0 rt_table = tun0</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/home/cuckoo/.cuckoo/conf/virtualbox.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[virtualbox] mode = headless path = /usr/bin/VBoxManage interface = vboxnet0 machines = win7_x64node1 [win7_x64node1] label = win7_x64node1 platform = windows ip = 192.168.56.101 snapshot = vmcloak interface = resultserver_ip = 192.168.56.1 resultserver_port = 2042 tags = options = osprofile = Win7SP1x64 [honeyd] label = honeyd platform = linux ip = 192.168.56.103 tags = service, honeyd options = nictrace noagent</code> </pre> </div></div><br><h3 id="avtozagruzka-cuckoo-i-servisov">  Cuckoo   </h3><br><p>   ,              . </p><br><p>  supervisor       Cuckoo. </p><br><pre> <code class="bash hljs">sudo apt install supervisor -y sudo systemctl stop supervisor</code> </pre> <br><p> C  supervisor: </p><br><div class="spoiler"> <b class="spoiler_title">/etc/supervisor/conf.d/vmcloak-internet.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[program:vmcloak-vboxnet0] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=vmcloak-vboxnet0 directory=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ [program:vmcloak-ifconfig] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>=vmcloak-iptables 192.168.56.0/24 ens160 directory=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ [group:vmcloak-internet] programs = vmcloak-vboxnet0, vmcloak-ifconfig</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/etc/supervisor/conf.d/cuckoo.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[program:cuckoo-rooter] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = /home/cuckoo/cuckoo/bin/cuckoo rooter --sudo autorestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span> [program:cuckoo-daemon] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = /home/cuckoo/cuckoo/bin/cuckoo -d -m 10000 user = cuckoo startsecs = 30 autorestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span> [program:cuckoo-process] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = /home/cuckoo/cuckoo/bin/cuckoo process p%(process_num)d process_name = cuckoo-process_%(process_num)d numprocs = 4 user = cuckoo autorestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span> [group:cuckoo] programs = cuckoo-rooter, cuckoo-daemon, cuckoo-process [program:distributed] <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = /home/cuckoo/cuckoo/bin/python -m cuckoo.distributed.worker user = cuckoo autostart = <span class="hljs-literal"><span class="hljs-literal">false</span></span> autorestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span> environment = CUCKOO_APP=<span class="hljs-string"><span class="hljs-string">"worker"</span></span>,CUCKOO_CWD=<span class="hljs-string"><span class="hljs-string">"/home/cuckoo/.cuckoo"</span></span></code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">/etc/supervisor/conf.d/uwsgi.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[program:uwsgi] user = cuckoo directory = /usr/bin <span class="hljs-built_in"><span class="hljs-built_in">command</span></span> = bash -c <span class="hljs-string"><span class="hljs-string">'sleep 5 &amp;&amp; uwsgi --ini /etc/uwsgi/cuckoo.ini'</span></span> autorestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span> stderr_logfile = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/uwsgi/uwsgi-err.log stdout_logfile = /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/uwsgi/uwsgi-out.log stopsignal = QUIT</code> </pre> </div></div><br><p>  : </p><br><pre> <code class="bash hljs">sudo systemctl restart supervisor sudo supervisorctl -c /etc/supervisor/supervisord.conf reload</code> </pre> <br><p>       (    supervisor ,   - ,       ): </p><br><div class="spoiler"> <b class="spoiler_title">/opt/serv.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs">sleep 30 sudo systemctl start molochcapture.service sudo systemctl start molochviewer.service sudo inetsim <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/irma/ansible/ sudo vagrant up sudo honeyd -f /usr/share/honeyd/config.conf -i vboxnet0</code> </pre> </div></div><br><p>    : </p><br><pre> <code class="bash hljs">sudo chmod +x serv.sh sudo crontab -e @reboot /bin/sh /opt/serv.sh</code> </pre> <br><h2 id="est-li-zhizn-posle-kukushki-ili-sobral-kukushku-a-dalshe-chto-delat">     ?  " !    ?" </h2><br><p>             ? <br>   ,    ‚Äî         . <br>       ,     ‚Äî  .     , , .          . <br>    ‚Äî      -             .               ,     ,  . </p><br><p>      ‚Äî  3          : </p><br><ol><li>  . ,     , , Cuckoo Sandbox, IDS, UEBA, USM, SIEM   ; </li><li>     (Incident Response Platform, IRP); </li><li>  . (Threat intelligense Platform, TIP). </li></ol><br><p>        ,     ,     ‚Äî IRP  <a href="https://thehive-project.org/">TheHive Project</a> .      ,   2. </p><br><ol><li> TheHive ‚Äî    . </li><li> Cortex ‚Äî     . </li></ol><br><p> <strong>TheHive Project stack.</strong> <br><img src="https://habrastorage.org/webt/ut/8p/hn/ut8phn6yg3qsgkmkqkpkpelvaak.png" alt="TheHive"></p><br><p> <strong>TheHive</strong> ‚Äî    ,        ,           -  . TheHive        .   (case)   , ,  "DDoS "   : </p><br><ul><li> " , L7   ?" </li><li> " IP " </li><li> "  blackhole" </li></ul><br><p>     ,      ,     ‚Äî    ,          ,   TLP    . </p><br><p> <strong>TheHive UI.</strong> <br><img src="https://habrastorage.org/webt/et/v2/kd/etv2kdnqudejpjt-rao5pr9og7o.png" alt="TheHive UI"></p><br><p>  TheHive  ,   ,  API <strong>TheHive4Py</strong> , ,  SIEM,    .       ‚Äî  .  , IP, ,   , ,     .   ,    .        ‚Äî <strong>Cortex</strong> . ,  API   (   )   . <br>    ‚Äî       ,     TheHive    (Case).     (Tasks), , "   ", "   "   .        ,     <strong>Cortex</strong>       VirusTotal,  ,         <a href="https://www.alienvault.com/open-threat-exchange">AlienVault OTX</a> ,    ,  ,    Cuckoo Sandbox    8-10 .     . -,   .  Cortex         TheHive. </p><br><p> <strong>MISP</strong> <br><img src="https://habrastorage.org/webt/kz/fb/xy/kzfbxyjidzct6xhqofawsiofdfq.png" alt="MISP"></p><br><p>       TheHive  Cuckoo   <a href="http://www.misp-project.org/">MISP</a>        ,          :  Firewall IP    ,    ‚Äî     . <br>  ,       ,    ,        ,  .    TheHive                 KPI. </p><br><p> MISP,   ,  47  ,         CERT,            .   MISP  ,  ,     ‚Äî      Proxy  MISP,     ‚Äî             . <br>    :     ‚Äî open source,     ,       Cuckoo Sandbox. ,  -? </p><br><p>  Thanks for attention! </p><br><h2 id="poleznye-ssylki">  useful links </h2><br><p>        ,     ,    ,         ,      ‚Äî   . </p><br><ul><li><a href="https://bdavis-cybersecurity.blogspot.ru/2016/11/cuckoo-sandbox-installation-part-2-of-4.html%3Fm%3D1"></a> <a href="https://bdavis-cybersecurity.blogspot.ru/2016/11/cuckoo-sandbox-installation-part-2-of-4.html%3Fm%3D1">https://bdavis-cybersecurity.blogspot.ru/2016/11/cuckoo-sandbox-installation-part-2-of-4.html?m=1</a> </li><li><a href="https://hub.docker.com/r/abzcoding/cuckoo-base/~/dockerfile/"></a> <a href="https://hub.docker.com/r/abzcoding/cuckoo-base/~/dockerfile/">https://hub.docker.com/r/abzcoding/cuckoo-base/~/dockerfile/</a> </li><li><a href="https://media.readthedocs.org/pdf/cuckoo/latest/cuckoo.pdf"></a> <a href="https://media.readthedocs.org/pdf/cuckoo/latest/cuckoo.pdf">https://media.readthedocs.org/pdf/cuckoo/latest/cuckoo.pdf</a> </li><li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup.html"></a> <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/setup.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/setup.html</a> </li><li><a href="http://www.jjzhentan.com/ropgadget_com/posts/cuckoo_install.html"></a> <a href="http://www.jjzhentan.com/ropgadget_com/posts/cuckoo_install.html">http://www.jjzhentan.com/ropgadget_com/posts/cuckoo_install.html</a> </li><li><a href="http://ropgadget.com/posts/cuckoo_install.html"></a> <a href="http://ropgadget.com/posts/cuckoo_install.html">http://ropgadget.com/posts/cuckoo_install.html</a> </li><li><a href="http://www.rffuste.com/2016/09/18/cuckoo-sandbox-install-notes-part-2-installation-and-configuration/"></a> <a href="http://www.rffuste.com/2016/09/18/cuckoo-sandbox-install-notes-part-2-installation-and-configuration/">http://www.rffuste.com/2016/09/18/cuckoo-sandbox-install-notes-part-2-installation-and-configuration/</a> </li><li><a href="https://cuckoo.sh/docs/"></a> <a href="https://cuckoo.sh/docs/">https://cuckoo.sh/docs/</a> </li><li><a href="http://vmcloak.readthedocs.io/en/latest/config.html"></a> <a href="http://vmcloak.readthedocs.io/en/latest/config.html">http://vmcloak.readthedocs.io/en/latest/config.html</a> </li><li><a href="http://www.trishtech.com/2015/07/disable-active-internet-probing-ncsi-in-windows/"></a> <a href="http://www.trishtech.com/2015/07/disable-active-internet-probing-ncsi-in-windows/">http://www.trishtech.com/2015/07/disable-active-internet-probing-ncsi-in-windows/</a> </li></ul><br></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350392/">https://habr.com/ru/post/350392/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350382/index.html">Testing Services API and RSpec</a></li>
<li><a href="../350384/index.html">Selection: 12 services to protect against DDoS-attacks</a></li>
<li><a href="../350386/index.html">Java 8 and Strategy pattern</a></li>
<li><a href="../350388/index.html">Examining DB and DBMS with T-SQL</a></li>
<li><a href="../350390/index.html">Proper bookmarking: how to work more efficiently and memorize more</a></li>
<li><a href="../350394/index.html">Network Device Detection</a></li>
<li><a href="../350396/index.html">Implement fast 2D shadows in Unity using 1D shadow mapping</a></li>
<li><a href="../350398/index.html">Native dependency inversion in TypeScript and React</a></li>
<li><a href="../350402/index.html">The most appropriate ways to learn new software</a></li>
<li><a href="../350406/index.html">Own data in the system crash dump of Windows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>