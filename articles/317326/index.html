<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby code coverage analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="First, I will give a small test project of three classes, analyze its coverage using the SimpleCov gem , and finally, I will think a little about how ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby code coverage analysis</h1><div class="post__text post__text-html js-mediator-article"><p>  First, I will give a small test project of three classes, analyze its coverage using the <a href="https://github.com/colszowka/simplecov">SimpleCov gem</a> , and finally, I will think a little about how coverage analysis can benefit the project, and what are the disadvantages of Coverage in Ruby. </p><br><p> <a href="https://habrahabr.ru/post/317326/"><img src="https://habrastorage.org/files/756/b2f/98b/756b2f98bdcd47eaaaf88d1f66d24659.png"></a> </p><br><h2 id="podopytnyy-proekt">  Experimental project </h2><br><p>  As a project for testing, a small story about a boy was taken, who may ask permission to walk with his mother and father. </p><br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#      ,     , #     .       ,   #     ,      . class Mother def permit_walk?(child) child.scarf_put_on &amp;&amp; child.homework_done end end</span></span></code> </pre> <a name="habracut"></a><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#     ,    ,       . class Father def permit_walk?(child) child.scarf_put_on end end</span></span></code> </pre> <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#     ,     , #   .      ,   . #  , ,      . class Child attr_reader :homework_done, :scarf_put_on def initialize(mother, father) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mother</span></span></span><span class="hljs-comment"> = mother </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@father</span></span></span><span class="hljs-comment"> = father </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@homework</span></span></span><span class="hljs-comment">_done = false </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@scarf</span></span></span><span class="hljs-comment">_put_on = false end def do_homework! </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@homework</span></span></span><span class="hljs-comment">_done = true end def put_on_scarf! </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@scarf</span></span></span><span class="hljs-comment">_put_on = true end def walk_permitted?(whom_to_ask) parent = if whom_to_ask == :mother </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@mother</span></span></span><span class="hljs-comment"> else </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@father</span></span></span><span class="hljs-comment"> end parent.permit_walk?(self) end end</span></span></code> </pre> <br><h2 id="pokryvaem-testami-i-smotrim-pokrytie">  We cover with tests and see coverage </h2><br><p>  The tests intentionally cover not all scenarios: </p><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"simplecov"</span></span> SimpleCov.start <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"rspec"</span></span> require_relative <span class="hljs-string"><span class="hljs-string">"../lib/mother"</span></span> require_relative <span class="hljs-string"><span class="hljs-string">"../lib/father"</span></span> require_relative <span class="hljs-string"><span class="hljs-string">"../lib/child"</span></span> RSpec.describe Child <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> let(<span class="hljs-symbol"><span class="hljs-symbol">:child</span></span>) { Child.new(Mother.new, Father.new) } context <span class="hljs-string"><span class="hljs-string">"when asking mother without scarf and without homework"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"isn't permitted to walk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect( child.walk_permitted?(<span class="hljs-symbol"><span class="hljs-symbol">:mother</span></span>) ).to be <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> context <span class="hljs-string"><span class="hljs-string">"when asking mother with scarf and with homework"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"is permitted to walk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> child.put_on_scarf! child.do_homework! expect( child.walk_permitted?(<span class="hljs-symbol"><span class="hljs-symbol">:mother</span></span>) ).to be <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  SimpleCov is actually a monopolist in coverage analysis in the world of Ruby 1.9.3+.  It is a handy wrapper over the <a href="https://ruby-doc.org/stdlib-2.2.3/libdoc/coverage/rdoc/Coverage.html">Coverage module</a> from the standard library. </p><br><p>  The connection is reduced to two lines at the beginning of the test file, and it is important that the initialization of SimpleCov be carried out before connecting the project files.  Run the tests: </p><br><pre> <code class="bash hljs">rspec</code> </pre> <br><p>  Voil√†!  The report / report.html report file was generated.  You can view it <a href="https://hedgesky.github.io/coverage_demo/coverage/index.html">at the link</a> , and here I will leave a couple of screenshots so as not to go far (the general report is used as the title picture). </p><br><p><img src="https://habrastorage.org/files/c20/815/6af/c208156af95d45a6992c1713fd977b70.png"><br>  <i>father.rb</i> </p><br><p><img src="https://habrastorage.org/files/603/310/c94/603310c94c27478686e4f1681bee578f.png"><br>  <i>Excerpt from child.rb</i> </p><br><h2 id="bonusy-ot-analiza-coverage">  Bonuses from analysis coverage </h2><br><p>  It is immediately clear from the report that the way in which permission is asked from the father is not tested.  From here obvious advantage from the analysis of a covering: in the conditions of non-application <abbr title="Test Driven Development">TDD the</abbr> report can show that we forgot to test something.  If the project is inherited and the difficult way of testing is just beginning, the report will help decide where to most effectively direct the force. </p><br><p>  The second possible use is the automatic provision of "quality" commits.  The CI server can reject commits that lead to a decrease in total coverage, drastically reducing the likelihood of untested code appearing in the repository. </p><br><h2 id="chto-analiz-pokrytiya-ne-dayot">  What does not cover analysis </h2><br><p>  First, one hundred percent coverage does not provide the absence of bugs.  A simple example: if you change the Mother class like this: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mother</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">permit_walk?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">child</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># child.scarf_put_on &amp;&amp; child.homework_done child.homework_done end end</span></span></span></span></code> </pre> <br><p>  class coverage will remain 100%, the tests will still be green, but the logic will obviously be wrong.  You can use the <a href="https://github.com/mbj/mutant">mutant gem</a> to automatically detect "missing but needed" tests.  I haven‚Äôt tried it yet, but judging by the Readme and the number of stars on the github, the library is really useful.  However, this is a topic for a separate post, to which I somehow get. </p><br><p>  Secondly, in Ruby at the moment it is possible to analyze the coverage only by rows, branch- and condition-coverage is not supported.  It is meant that in one-line view </p><br><pre> <code class="ruby hljs">some_condition ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span> some_condition <span class="hljs-params"><span class="hljs-params">||</span></span> another_condition <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> some_condition</code> </pre> <br><p>  there are branch points, but even if tests pass through only one possible branch of execution, coverage will show 100%.  There was a <a href="https://github.com/ruby/ruby/pull/511">pull request to Ruby</a> on this topic, but for two years <a href="https://bugs.ruby-lang.org/issues/9508">nothing has been heard</a> from the maintainers.  It's a pity. </p><br><h2 id="posleslovie">  Afterword </h2><br><p>  I prefer to write tests immediately after writing the code, and coverage serves me as a reminder of methods that have not yet been tested (I often forget to test exception handlers).  In general, coverage analysis may well be of some benefit, but a 100% coverage does not necessarily mean that there are enough tests. </p><br><p>  Materials used in the article: </p><br><ul><li>  <a href="https://github.com/hedgesky/coverage_demo">Test project on githaba</a> </li><li>  <a href="https://hedgesky.github.io/coverage_demo/coverage/index.html">SimpleCov Analysis Report</a> </li><li>  <a href="https://github.com/colszowka/simplecov">Simplecov</a> </li><li>  <a href="https://github.com/mbj/mutant">mutant</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317326/">https://habr.com/ru/post/317326/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317312/index.html">The perfect programmer. Part 1</a></li>
<li><a href="../317314/index.html">Progress Tracking in R</a></li>
<li><a href="../317318/index.html">Creating a website as a product or "why is it so expensive?"</a></li>
<li><a href="../317320/index.html">The study of connectivity in the brain based on electrophysiological data. Lecture in Yandex</a></li>
<li><a href="../317322/index.html">Pentest at Global Data Security - passing the 10th Pentestit Lab</a></li>
<li><a href="../317328/index.html">Performance comparison of GPU calculations in Python and C</a></li>
<li><a href="../317332/index.html">Communication strategy as a tool for building a career and personal brand</a></li>
<li><a href="../317334/index.html">The digest of interesting materials for the mobile # 183 developer (December 5-11)</a></li>
<li><a href="../317336/index.html">Scrapbook with M * CTF</a></li>
<li><a href="../317338/index.html">Set up Swashbuckle (Swagger) for WebAPI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>