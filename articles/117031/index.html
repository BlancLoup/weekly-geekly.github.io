<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous Monad Example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose two programs communicate with each other over the network, but do not deign to wait for an answer, so the answers come in a random order. To f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous Monad Example</h1><div class="post__text post__text-html js-mediator-article"> Suppose two programs communicate with each other over the network, but do not deign to wait for an answer, so the answers come in a random order.  To find out what's what, a number is sent with the message, and the answer is the number of the original (to which we reply) message and the number of the answer for subsequent communication. <br><br>  Our goal is to describe the sequence of receiving and sending messages when communicating with a certain interlocutor, and also to be able to use I / O (for example, contacting the database) between receptions and sending messages. <br><br>  As if in a code in your preferred language, for example, such a dialogue looked, given that at any moment (between any of these points) some other requests may come that also need to be processed, but not accidentally entangled in this dialogue : <br>  1. Send the number <br>  2. A number comes in response <br>  3. We send number from item 2 in a square <br>  4. In response, the number again <br>  5. Display to the console the sum of the numbers of p.2 and p.4 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Here is how it will look like on Haskell (the <code>example</code> function is, of course, non-blocking): <br> <code><nobr>example</nobr> <font color="#80c000">::</font> <font color="#ff8000">Int</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">AIO</font> <font color="#ff8000">()</font> &lt;br&gt; <br> example v <font color="#80c000">=</font> <font color="#0080ff">do</font> &lt;br&gt; <br> x <font color="#80c000">&lt;-</font> request v&lt;br&gt; <br> y <font color="#80c000">&lt;-</font> request <font color="#80c000">(</font> x <font color="#80c000">*</font> x <font color="#80c000">)</font> &lt;br&gt; <br> io <font color="#80c000">$</font> print <font color="#80c000">(</font> x <font color="#80c000">+</font> y <font color="#80c000">)</font> &lt;br&gt; <br></code> <br>  Compare this with a similar blocking function, which, for example, requests a response from the user: <br> <code><nobr>example</nobr> <font color="#80c000">::</font> <font color="#ff8000">Int</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> &lt;br&gt; <br> example v <font color="#80c000">=</font> <font color="#0080ff">do</font> &lt;br&gt; <br> x <font color="#80c000">&lt;-</font> request v&lt;br&gt; <br> y <font color="#80c000">&lt;-</font> request <font color="#80c000">(</font> x <font color="#80c000">*</font> x <font color="#80c000">)</font> &lt;br&gt; <br> print <font color="#80c000">(</font> x <font color="#80c000">+</font> y <font color="#80c000">)</font> &lt;br&gt; <br></code> <br><a name="habracut"></a><br>  In order not to be distracted by unnecessary details and not need to run several programs, I will simplify the task for the article.  We will read-write to the channel ( <code>Chan a</code> ), and the message will be of type <code><nobr>(Int, String)</nobr></code> , i.e.  message number and serialized value. <br><br>  We connect all the necessary modules: <br><br> <code><font color="#80c000">&gt;</font> <font color="#0080ff">module</font> <font color="#ff8000">Test</font> <font color="#80c000">(</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#80c000">)</font> <font color="#0080ff">where</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Control</font> <font color="#80c000">.</font> <font color="#ff8000">Arrow</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Control</font> <font color="#80c000">.</font> <font color="#ff8000">Monad</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Control</font> <font color="#80c000">.</font> <font color="#ff8000">Concurrent</font> <font color="#80c000">.</font> <font color="#ff8000">MVar</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Control</font> <font color="#80c000">.</font> <font color="#ff8000">Concurrent</font> <font color="#80c000">.</font> <font color="#ff8000">Chan</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Control</font> <font color="#80c000">.</font> <font color="#ff8000">Concurrent</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Data</font> <font color="#80c000">.</font> <font color="#ff8000">List</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">import</font> <font color="#ff8000">Data</font> <font color="#80c000">.</font> <font color="#ff8000">Maybe</font> &lt;br&gt; <br></code> <br>  Before writing a monad, try first to do everything on callbacks. <br>  When sending a message, we need to generate some number, as well as add a callback to the list.  Those.  we will need a variable number and a list of pairs <i>number</i> -&gt; <i>callback</i> .  We also need, in fact, the channels themselves.  Unlike sockets, they need two, since we will write to one and read from the other.  All this will be issued as a separate type: <br><br> <code><font color="#80c000">&gt;</font> <font color="#0080ff">data</font> <font color="#ff8000">AState</font> <font color="#80c000">=</font> <font color="#ff8000">AState</font> <font color="#80c000">{</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> aCurrent <font color="#80c000">::</font> <font color="#ff8000">MVar</font> <font color="#ff8000">Int</font> <font color="#80c000">,</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> aWait <font color="#80c000">::</font> <font color="#ff8000">MVar</font> <font color="#80c000">[</font> <font color="#80c000">(</font> <font color="#ff8000">Int</font> <font color="#80c000">,</font> <font color="#ff8000">String</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> <font color="#80c000">)</font> <font color="#80c000">]</font> <font color="#80c000">,</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> aChanOut <font color="#80c000">::</font> <font color="#ff8000">Chan</font> <font color="#80c000">(</font> <font color="#ff8000">Int</font> <font color="#80c000">,</font> <font color="#ff8000">String</font> <font color="#80c000">)</font> <font color="#80c000">,</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> aChanIn <font color="#80c000">::</font> <font color="#ff8000">Chan</font> <font color="#80c000">(</font> <font color="#ff8000">Int</font> <font color="#80c000">,</font> <font color="#ff8000">String</font> <font color="#80c000">)</font> <font color="#80c000">}</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> newA <font color="#80c000">=</font> liftM4 <font color="#ff8000">AState</font> <font color="#80c000">(</font> newMVar <font color="#0080ff">0</font> <font color="#80c000">)</font> <font color="#80c000">(</font> newMVar <font color="#ff8000">[]</font> <font color="#80c000">)</font> newChan newChan&lt;br&gt; <br></code> <br>  The message handler from the client side must read from the channel and call a callback in accordance with the message number. <br>  We will read from the channel, then look for a suitable callback (at the same time removing it from the list) and call.  It's simple: <br><br> <code><font color="#80c000">&gt;</font> listener <font color="#80c000">(</font> <font color="#ff8000">AState</font> <font color="#0080ff">_</font> w <font color="#0080ff">_</font> chIn <font color="#80c000">)</font> <font color="#80c000">=</font> forever <font color="#80c000">$</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#80c000">(</font> i <font color="#80c000">,</font> s <font color="#80c000">)</font> <font color="#80c000">&lt;-</font> readChan chIn&lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">-- modifyMVar   a -&gt; IO (a, b)</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">-- ..      ,         .</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">--          callback.</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> callback <font color="#80c000">&lt;-</font> modifyMVar w <font color="#80c000">$</font> <font color="#80c000">\</font> callbacks <font color="#80c000">-&gt;</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">--  callback'          .</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">let</font> <font color="#80c000">(</font> past <font color="#80c000">,</font> ok <font color="#80c000">)</font> <font color="#80c000">=</font> partition <font color="#80c000">(</font> <font color="#80c000">(</font> <font color="#80c000">/=</font> i <font color="#80c000">)</font> <font color="#80c000">.</font> fst <font color="#80c000">)</font> callbacks&lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">--     ( ).</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">case</font> ok <font color="#0080ff">of</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#80c000">(</font> <font color="#80c000">(</font> <font color="#0080ff">_</font> <font color="#80c000">,</font> f <font color="#80c000">)</font> <font color="#80c000">:</font> <font color="#0080ff">_</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> return <font color="#80c000">(</font> past <font color="#80c000">,</font> f <font color="#80c000">)</font> <font color="#808080">--   callback (  ).</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">_</font> <font color="#80c000">-&gt;</font> return <font color="#80c000">(</font> past <font color="#80c000">,</font> <font color="#80c000">\</font> s <font color="#80c000">-&gt;</font> return <font color="#ff8000">()</font> <font color="#80c000">)</font> <font color="#808080">--  ,    </font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> callback s <font color="#808080">--  callback.</font> &lt;br&gt; <br></code> <br>  So that the messages that came to the ‚Äúserver‚Äù could be observed firsthand, we will write a handler that will output all incoming messages to our interlocutor (on the <code>aChanOut</code> channel). <br>  We read from the channel <code>aChanOut</code> and display on the screen: <br><br> <code><font color="#80c000">&gt;</font> tracer <font color="#80c000">(</font> <font color="#ff8000">AState</font> <font color="#0080ff">_</font> <font color="#0080ff">_</font> chOut <font color="#0080ff">_</font> <font color="#80c000">)</font> <font color="#80c000">=</font> forever <font color="#80c000">$</font> readChan chOut <font color="#80c000">&gt;&gt;=</font> print&lt;br&gt; <br></code> <br><h5>  Promonadic method </h5><br>  For starters, we do without monads.  Let's try to just write a function to send a message. <br>  It should generate a message number, serialize the message to a string, and register a callback. <br> <code><nobr>sendAndReceive1</nobr> <font color="#80c000">::</font> <font color="#ff8000">AState</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">String</font> <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> <font color="#ff8000">String</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> &lt;br&gt; <br> sendAndReceive1 <font color="#80c000">(</font> <font color="#ff8000">AState</font> cur w chOut <font color="#0080ff">_</font> <font color="#80c000">)</font> msg onMsg <font color="#80c000">=</font> <font color="#0080ff">do</font> &lt;br&gt; <br> i <font color="#80c000">&lt;-</font> modifyMVar cur <font color="#80c000">(</font> return <font color="#80c000">.</font> <font color="#80c000">(</font> succ <font color="#80c000">&amp;&amp;&amp;</font> id <font color="#80c000">)</font> <font color="#80c000">)</font> <font color="#808080">--   1    .</font> &lt;br&gt; <br> modifyMVar_ w <font color="#80c000">(</font> return <font color="#80c000">.</font> <font color="#80c000">(</font> <font color="#80c000">(</font> i <font color="#80c000">,</font> onMsg <font color="#80c000">)</font> <font color="#80c000">:</font> <font color="#80c000">)</font> <font color="#80c000">)</font> <font color="#808080">--  callback.</font> &lt;br&gt; <br> writeChan chOut <font color="#80c000">(</font> i <font color="#80c000">,</font> msg <font color="#80c000">)</font> <font color="#808080">--  .</font> &lt;br&gt; <br></code> <br>  Use in principle is acceptable, but there are shortcomings: <br> <code><nobr>sendAndReceive1 a</nobr> <font color="#80c000">(</font> show <font color="#0080ff">123</font> <font color="#80c000">)</font> <font color="#80c000">$</font> <font color="#80c000">\</font> ans <font color="#80c000">-&gt;</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#0080ff">let</font> x <font color="#80c000">=</font> read ans <font color="#808080">--  .</font> &lt;br&gt; <br> print x&lt;br&gt; <br> sendAndReceive1 a <font color="#80c000">(</font> show x <font color="#80c000">)</font> <font color="#80c000">$</font> <font color="#80c000">\</font> ans2 <font color="#80c000">-&gt;</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#808080">-- ...</font> &lt;br&gt; <br></code> <br>  First, you can pass the serialization and deserialization function to not write them in a callback and write <code>sendAndReceive2</code> , using, for example, the standard <code>read</code> and <code>show</code> defaults. <br> <code><nobr>sendAndReceive1</nobr> <font color="#80c000">::</font> <font color="#ff8000">AState</font> <font color="#80c000">-&gt;</font> a <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> a <font color="#80c000">-&gt;</font> <font color="#ff8000">String</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> <font color="#ff8000">String</font> <font color="#80c000">-&gt;</font> b <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> b <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> &lt;br&gt; <br> sendAndReceive1 <font color="#80c000">(</font> <font color="#ff8000">AState</font> cur w chOut <font color="#0080ff">_</font> <font color="#80c000">)</font> msg show_ read_ onMsg <font color="#80c000">=</font> <font color="#0080ff">do</font> &lt;br&gt; <br> i <font color="#80c000">&lt;-</font> modifyMVar cur <font color="#80c000">(</font> return <font color="#80c000">.</font> <font color="#80c000">(</font> succ <font color="#80c000">&amp;&amp;&amp;</font> id <font color="#80c000">)</font> <font color="#80c000">)</font> &lt;br&gt; <br> modifyMVar_ w <font color="#80c000">(</font> return <font color="#80c000">.</font> <font color="#80c000">(</font> <font color="#80c000">(</font> i <font color="#80c000">,</font> onMsg <font color="#80c000">.</font> read_ <font color="#80c000">)</font> <font color="#80c000">:</font> <font color="#80c000">)</font> <font color="#80c000">)</font> &lt;br&gt; <br> writeChan chOut <font color="#80c000">(</font> i <font color="#80c000">,</font> show_ msg <font color="#80c000">)</font> &lt;br&gt; <br> &lt;br&gt; <br> sendAndReceive2 <font color="#80c000">::</font> <font color="#80c000">(</font> <font color="#ff8000">Show</font> a <font color="#80c000">,</font> <font color="#ff8000">Read</font> b <font color="#80c000">)</font> <font color="#80c000">=&gt;</font> <font color="#ff8000">AState</font> <font color="#80c000">-&gt;</font> a <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> b <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> &lt;br&gt; <br> sendAndReceive2 a msg onMsg <font color="#80c000">=</font> sendAndReceive1 a msg show read onMsg&lt;br&gt; <br> &lt;br&gt; <br> <font color="#808080">--   .</font> &lt;br&gt; <br> sendAndReceive2 a <font color="#0080ff">23</font> <font color="#80c000">$</font> <font color="#80c000">\</font> x <font color="#80c000">-&gt;</font> <font color="#0080ff">do</font> &lt;br&gt; <br> print x&lt;br&gt; <br> sendAndReceive2 a <font color="#80c000">(</font> x <font color="#80c000">+</font> <font color="#0080ff">10</font> <font color="#80c000">)</font> <font color="#80c000">$</font> <font color="#80c000">\</font> z <font color="#80c000">-&gt;</font> <font color="#80c000">...</font> &lt;br&gt; <br></code> <br>  It would be possible to dwell on this, but <s>then it was possible to take an assembler at all, so</s> why not take advantage of a more powerful abstraction? <br><br><h5>  Eumonadic method </h5><br>  If we recall that the main function of the monad (not in TC, but in Haskell) is of type <code>ma -&gt; (a -&gt; mb) -&gt; mb</code> , then our callback is suggested as the second argument.  But also there one must be able to transfer the usual calculation of the type <code>print</code> . <br>  To somehow distinguish them, create a new type with two options: <br>  1. Message + callback <br>  2. Net value <br><br> <code><font color="#80c000">&gt;</font> <font color="#0080ff">data</font> <font color="#ff8000">AS</font> a <font color="#80c000">=</font> <font color="#ff8000">Send</font> <font color="#ff8000">String</font> <font color="#80c000">(</font> <font color="#ff8000">String</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">AIO</font> a <font color="#80c000">)</font> <font color="#80c000">|</font> <font color="#ff8000">Pure</font> a&lt;br&gt; <br></code> <br>  And we wrap it in the <code>IO</code> monad. <br><br> <code><font color="#80c000">&gt;</font> <font color="#0080ff">data</font> <font color="#ff8000">AIO</font> a <font color="#80c000">=</font> <font color="#ff8000">AIO</font> <font color="#80c000">{</font> aio <font color="#80c000">::</font> <font color="#ff8000">IO</font> <font color="#80c000">(</font> <font color="#ff8000">AS</font> a <font color="#80c000">)</font> <font color="#80c000">}</font> &lt;br&gt; <br></code> <br>  Thus, the calculations will be divided into two camps: sending the message and all the rest. <br><br>  We write a function that ‚Äúraises‚Äù the usual <code>IO</code> into our monad.  It should just return the same as <code>IO</code> , but wrapping it in the <code>Pure</code> constructor <code>Pure</code> <br><br> <code><font color="#80c000">&gt;</font> io <font color="#80c000">::</font> <font color="#ff8000">IO</font> a <font color="#80c000">-&gt;</font> <font color="#ff8000">AIO</font> a&lt;br&gt; <br> &lt;br&gt; <br> io act <font color="#80c000">=</font> <font color="#ff8000">AIO</font> <font color="#80c000">$</font> <font color="#0080ff">do</font> &lt;br&gt; <br> v <font color="#80c000">&lt;-</font> act&lt;br&gt; <br> return <font color="#80c000">(</font> <font color="#ff8000">Pure</font> v <font color="#80c000">)</font> &lt;br&gt; <br></code> <br>  Or easier: <br><br> <code><font color="#80c000">&gt;</font> io <font color="#80c000">=</font> <font color="#ff8000">AIO</font> <font color="#80c000">.</font> liftM <font color="#ff8000">Pure</font> &lt;br&gt; <br></code> <br>  The function for sending a message will be used by the second constructor, <code>Send</code> , in essence, simply wrapping the arguments into the constructor: <br><br> <code><font color="#80c000">&gt;</font> sendAndReceive <font color="#80c000">::</font> a <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> a <font color="#80c000">-&gt;</font> <font color="#ff8000">String</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#80c000">(</font> <font color="#ff8000">String</font> <font color="#80c000">-&gt;</font> b <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">AIO</font> b&lt;br&gt; <br> <font color="#80c000">&gt;</font> sendAndReceive msg to from <font color="#80c000">=</font> <font color="#ff8000">AIO</font> <font color="#80c000">$</font> return <font color="#80c000">$</font> <font color="#ff8000">Send</font> <font color="#80c000">(</font> to msg <font color="#80c000">)</font> <font color="#80c000">(</font> return <font color="#80c000">.</font> from <font color="#80c000">)</font> &lt;br&gt; <br></code> <br>  And similar to her <code>request</code> , using <code>show</code> , <code>read</code> for serialization: <br><br> <code><font color="#80c000">&gt;</font> request <font color="#80c000">::</font> <font color="#80c000">(</font> <font color="#ff8000">Show</font> a <font color="#80c000">,</font> <font color="#ff8000">Read</font> b <font color="#80c000">)</font> <font color="#80c000">=&gt;</font> a <font color="#80c000">-&gt;</font> <font color="#ff8000">AIO</font> b&lt;br&gt; <br> <font color="#80c000">&gt;</font> request msg <font color="#80c000">=</font> sendAndReceive msg show read&lt;br&gt; <br></code> <br>  Some trick is that we do not calculate anything in our monad, but only construct something like a tree of calculations.  By themselves, these functions only create the <code>AIO</code> type. <br>  It's time to take on a function that will be able to calculate all this garbage.  Those.  to execute the dialogue described by us (for example, <code>example</code> ).  The created dialogue is reduced to two options: <br>  1. <code>Pure</code> - you just need to remove the value and return it. <br>  2. <code>Send</code> - the main work takes place here - we generate a number, register a callback and send a message. <br><br> <code><font color="#80c000">&gt;</font> run <font color="#80c000">::</font> <font color="#ff8000">AState</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">AIO</font> <font color="#ff8000">()</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> run a <font color="#80c000">@</font> <font color="#80c000">(</font> <font color="#ff8000">AState</font> cur w chOut chIn <font color="#80c000">)</font> act <font color="#80c000">=</font> run' act <font color="#0080ff">where</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> run' <font color="#80c000">(</font> <font color="#ff8000">AIO</font> actIO <font color="#80c000">)</font> <font color="#80c000">=</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">as</font> <font color="#80c000">&lt;-</font> actIO&lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">case</font> <font color="#0080ff">as</font> <font color="#0080ff">of</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#ff8000">Pure</font> value <font color="#80c000">-&gt;</font> return value&lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#ff8000">Send</font> msg onMsg <font color="#80c000">-&gt;</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> i <font color="#80c000">&lt;-</font> modifyMVar cur <font color="#80c000">(</font> return <font color="#80c000">.</font> <font color="#80c000">(</font> succ <font color="#80c000">&amp;&amp;&amp;</font> id <font color="#80c000">)</font> <font color="#80c000">)</font> <font color="#808080">--      </font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> modifyMVar_ w <font color="#80c000">(</font> return <font color="#80c000">.</font> <font color="#80c000">(</font> <font color="#80c000">(</font> i <font color="#80c000">,</font> run' <font color="#80c000">.</font> onMsg <font color="#80c000">)</font> <font color="#80c000">:</font> <font color="#80c000">)</font> <font color="#80c000">)</font> <font color="#808080">--  callback.</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> writeChan chOut <font color="#80c000">(</font> i <font color="#80c000">,</font> msg <font color="#80c000">)</font> <font color="#808080">--  .</font> &lt;br&gt; <br></code> <br>  Now everything is ready to write the <code>instance</code> monads: <br><br> <code><font color="#80c000">&gt;</font> <font color="#0080ff">instance</font> <font color="#ff8000">Monad</font> <font color="#ff8000">AIO</font> <font color="#0080ff">where</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> return <font color="#80c000">=</font> <font color="#ff8000">AIO</font> <font color="#80c000">.</font> return <font color="#80c000">.</font> <font color="#ff8000">Pure</font> <font color="#808080">--   </font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#ff8000">AIO</font> v <font color="#80c000">&gt;&gt;=</font> f <font color="#80c000">=</font> <font color="#ff8000">AIO</font> <font color="#80c000">$</font> <font color="#0080ff">do</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> x <font color="#80c000">&lt;-</font> v <font color="#808080">--  AS, Send   Pure?</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#0080ff">case</font> x <font color="#0080ff">of</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">--  Pure,       callback .</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#ff8000">Pure</font> value <font color="#80c000">-&gt;</font> aio <font color="#80c000">$</font> f value&lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#808080">--   ""  callback  .</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> <font color="#ff8000">Send</font> msg onMsg <font color="#80c000">-&gt;</font> return <font color="#80c000">$</font> <font color="#ff8000">Send</font> msg <font color="#80c000">(</font> <font color="#80c000">\</font> s <font color="#80c000">-&gt;</font> onMsg s <font color="#80c000">&gt;&gt;=</font> f <font color="#80c000">)</font> &lt;br&gt; <br></code> <br>  The last thing we need is a function for checking the operability, which will start the <code>listener</code> threads to process incoming messages to the client and the <code>tracer</code> to output incoming messages to the server, and return the function to us to send messages from the server back to our client.  Those.  in this case, we will act as an interlocutor, typing what we want to send to our client: <br><br> <code><font color="#80c000">&gt;</font> start <font color="#80c000">::</font> <font color="#ff8000">IO</font> <font color="#80c000">(</font> <font color="#ff8000">AState</font> <font color="#80c000">,</font> <font color="#80c000">(</font> <font color="#ff8000">Int</font> <font color="#80c000">,</font> <font color="#ff8000">String</font> <font color="#80c000">)</font> <font color="#80c000">-&gt;</font> <font color="#ff8000">IO</font> <font color="#ff8000">()</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> start <font color="#80c000">=</font> newA <font color="#80c000">&gt;&gt;=</font> forks <font color="#0080ff">where</font> &lt;br&gt; <br> <font color="#80c000">&gt;</font> forks a <font color="#80c000">=</font> mapM_ forkIO <font color="#80c000">[</font> listener a <font color="#80c000">,</font> tracer a <font color="#80c000">]</font> <font color="#80c000">&gt;&gt;</font> return <font color="#80c000">(</font> a <font color="#80c000">,</font> writeChan <font color="#80c000">(</font> aChanIn a <font color="#80c000">)</font> <font color="#80c000">)</font> &lt;br&gt; <br></code> <br><h5>  Tydyshch! </h5><br>  Now you can check it in the interpreter using the original example. <br> <code><font color="#808080">--     ,   -   </font> &lt;br&gt; <br> <font color="#808080">--  ,       </font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> <font color="#80c000">(</font> a <font color="#80c000">,</font> f <font color="#80c000">)</font> <font color="#80c000">&lt;-</font> start&lt;br&gt; <br> <font color="#808080">--   </font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> run a <font color="#80c000">(</font> example <font color="#0080ff">10</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--     </font> &lt;br&gt; <br> <font color="#80c000">(</font> <font color="#0080ff">0</font> <font color="#80c000">,</font> <font color="#fc0080">"10"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--   </font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> run a <font color="#80c000">(</font> example <font color="#0080ff">20</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--     ,    </font> &lt;br&gt; <br> <font color="#80c000">(</font> <font color="#0080ff">1</font> <font color="#80c000">,</font> <font color="#fc0080">"20"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--   ""</font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> f <font color="#80c000">(</font> <font color="#0080ff">0</font> <font color="#80c000">,</font> <font color="#fc0080">"11"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--        </font> &lt;br&gt; <br> <font color="#80c000">(</font> <font color="#0080ff">2</font> <font color="#80c000">,</font> <font color="#fc0080">"121"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--    ""</font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> f <font color="#80c000">(</font> <font color="#0080ff">1</font> <font color="#80c000">,</font> <font color="#fc0080">"21"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--   </font> &lt;br&gt; <br> <font color="#80c000">(</font> <font color="#0080ff">3</font> <font color="#80c000">,</font> <font color="#fc0080">"441"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--       "",  ,   ""    </font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> f <font color="#80c000">(</font> <font color="#0080ff">3</font> <font color="#80c000">,</font> <font color="#fc0080">"444"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#808080">--   </font> &lt;br&gt; <br> <font color="#0080ff">465</font> &lt;br&gt; <br> <font color="#808080">--     ""</font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> f <font color="#80c000">(</font> <font color="#0080ff">2</font> <font color="#80c000">,</font> <font color="#fc0080">"122"</font> <font color="#80c000">)</font> &lt;br&gt; <br> <font color="#0080ff">133</font> &lt;br&gt; <br> ghci <font color="#80c000">&gt;</font> &lt;br&gt; <br></code> <br>  As you can see, despite the launch of two <code>example</code> once, the dialogs with them do not overlap. <br><br>  By the way, this whole message is a Literate Haskell program, you can copy it into <code>test.lhs</code> and test it yourself. <br><br>  PS Many thanks to <a href="https://habrahabr.ru/users/pechlambda/" class="user_link">pechlambda</a> for helping to improve the article. </div><p>Source: <a href="https://habr.com/ru/post/117031/">https://habr.com/ru/post/117031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../117025/index.html">WordPress search plugin. More than search with Sphinx Search</a></li>
<li><a href="../117027/index.html">ADCSpb # 4. Memory management</a></li>
<li><a href="../117028/index.html">Update BIOS on Eee PC</a></li>
<li><a href="../117029/index.html">Twitter has greatly improved its search.</a></li>
<li><a href="../117030/index.html">Toyota cars go to Windows Azure</a></li>
<li><a href="../117033/index.html">IE9 - another web developer headache</a></li>
<li><a href="../117035/index.html">Digest of the best vacancies of Runet startups (April 4-8)</a></li>
<li><a href="../117037/index.html">The unofficial "release" of CentOS 5.6</a></li>
<li><a href="../117039/index.html">[Translation] Amazon is working on bugs</a></li>
<li><a href="../117041/index.html">ABBYY Department at MIPT - 5 years of investment in Russian education</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>