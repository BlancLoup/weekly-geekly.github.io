<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>[NES] Writing level editor for Prince of Persia. Chapter Four He himself runs! Or a skeleton in the closet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Chapter One , Chapter Two , Chapter Three , Chapter Four , Chapter Five , Epilogue 

 Disclaimer 
 If we are editing a game, we must align all its det...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>[NES] Writing level editor for Prince of Persia. Chapter Four He himself runs! Or a skeleton in the closet</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/187876/">Chapter One</a> , <a href="http://habrahabr.ru/post/191880/">Chapter Two</a> , <a href="http://habrahabr.ru/post/192028/">Chapter Three</a> , <b>Chapter Four</b> , <a href="http://habrahabr.ru/post/192832/">Chapter Five</a> , <a href="http://habrahabr.ru/post/193406/">Epilogue</a> <br><br><h5>  Disclaimer </h5><br>  If we are editing a game, we must align all its details.  It would be foolish to show your version of the game to the world if fragments of the original version come out of it, conflicting with the new meaning we have invested in it.  Editing the levels of the game does not allow you to change some of the plot twists that the developers initially invested. <br><br>  With a slight delay, we will correct the plot. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  What are we going to edit? </h5><br>  Before moving on, I would like to limit myself in the redrawing of the game.  Indeed, if we want to change everything and everything, then it will be easier to just write our game from the very beginning.  But as originally planned, I still want to do something new, retaining, however, the old base.  We will be defined with what we will edit. <br><ul><li>  Colors.  The NES version differs from the others in that all levels in it have dull colors of the same type.  Only the colors of the law enforcement officers change; </li><li>  Demo play.  As soon as we change at least the brick in the first room, our hero in demo play will be like a blind rabbit to hammer into walls or try to climb onto the missing ledges; </li><li>  "Mirror reflection".  It appears only when certain conditions are fulfilled and in strictly defined rooms of strictly defined levels.  If we rearrange something, it will either appear out of place, or not at all, distorting the plot of the game; </li><li>  ... Mouse in the eighth level :-).  She runs at the request of the princess to save us, when we find ourselves in custody, revealing the lattice to us. </li><li>  Types of adversaries.  In the third and twelfth (‚Äúreflection‚Äù in the original in the twelfth level, but the NES developers saved a little) the skeleton meets us; </li><li>  Transitions. <br><ul><li>  First level.  In the story, the hero is thrown into the dungeon and the lattice is closed behind him.  Thus, in the first level it appears and after this the retreat is immediately closed; </li><li>  Sixth level.  The hero jumps over the abyss, but the insidious "reflection" closes the grid and he falls into the abyss - in the dungeon.  There is a non-standard transition to the next level; </li><li>  Seventh level.  Once he falls down in the sixth level, he should appear on top in the seventh level.  Custom entry level; </li><li>  Twelfth and thirteenth levels.  Here, the developers decided to divide one long into two shorter levels.  We move from room to room, and get to the next level; </li><li>  The fourteenth level simply does not have the transition to the next level </li></ul></li></ul><br>  I decided to leave the text, music, views and configuration of the blocks in their original form in order to preserve the spirit of the game.  This can be changed as easily as everything else, since all objects are tied to arrays of pointers to fairly simple data. <br><br>  Mouse, by the way, I left in its place. <br><br><h5>  Code </h5><br>  Dynamic elements of the game is not so easy to change simply by enumeration, as we did earlier.  Accordingly, it is time to actively study the code.  With some of its elements, we met.  Now, let's see what happens during the game. <br><br>  By pressing the ‚ÄúStep over‚Äù button in the debugger, we will inevitably move on to the main loop, where its main component looks like this: <br><pre><code class="hljs perl">label_CC1A: $CC1A:<span class="hljs-number"><span class="hljs-number">20</span></span> F7 F2 JSR $F2F7 $CC1D:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> D<span class="hljs-number"><span class="hljs-number">0</span></span> JSR $D010 $CC20:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>E <span class="hljs-number"><span class="hljs-number">86</span></span> JSR $861E $CC23:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> CB JSR $CB00 $CC26:<span class="hljs-number"><span class="hljs-number">20</span></span> E8 A4 JSR $A4E8 $CC29:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> D<span class="hljs-number"><span class="hljs-number">0</span></span> JSR $D010 $CC2C:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>B JSR $8B04 $CC2F:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> D<span class="hljs-number"><span class="hljs-number">0</span></span> JSR $D010 $CC32:<span class="hljs-number"><span class="hljs-number">20</span></span> F9 <span class="hljs-number"><span class="hljs-number">80</span></span> JSR $80F9 $CC35:<span class="hljs-number"><span class="hljs-number">20</span></span> FC D8 JSR $D8FC $CC38:<span class="hljs-number"><span class="hljs-number">20</span></span> DF BA JSR $BADF $CC3B:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> CB JSR $CB00 $CC3E:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>F JSR $9F12 $CC41:<span class="hljs-number"><span class="hljs-number">20</span></span> DD A3 JSR $A3DD $CC44:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">1</span></span>A CC JMP $CC1A</code> </pre> <br>  Above this cycle there is also a call to a multitude of procedures that are called when moving between rooms or levels.  The procedures listed in the above code change the state of the game, as well as perform various kinds of checks.  Of these, the following are not of interest: <br>  - $ F2F7 - waiting for a change in a certain state in the interruption of VBlank; <br>  - $ D010, $ CB00 - switching banks before calling procedures that are located in the corresponding bank. <br><br>  I will not give the code of all the remaining procedures, since their consideration with all the branches will result in another ten posts.  I will cite only that which is of interest now.  I will not translate into pseudocode, but I will give comments. <br><br><h6>  A4E8.  He himself runs! </h6><br>  Before calling this procedure, the procedure for switching on the bank # 02 - $ D010 is called.  We turn on this bank by writing the number # 02 to the cell $ FFF2 and proceed to this procedure: <br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$A</span></span>4E8:<span class="hljs-type"><span class="hljs-type">AD</span></span> <span class="hljs-type"><span class="hljs-type">E4</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">LDA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E4 = #<span class="hljs-string"><span class="hljs-string">$0</span></span>1 <span class="hljs-string"><span class="hljs-string">$A</span></span>4EB:<span class="hljs-type"><span class="hljs-type">D0</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-type"><span class="hljs-type">BNE</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>500 ;;    <span class="hljs-string"><span class="hljs-string">$0</span></span>4E4. ;;   <span class="hljs-number"><span class="hljs-number">0</span></span>,      <span class="hljs-string"><span class="hljs-string">$A</span></span>4ED:<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-type"><span class="hljs-type">RTS</span></span> ;; ...  <span class="hljs-string"><span class="hljs-string">$A</span></span>4EE:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-type"><span class="hljs-type">FF</span></span> <span class="hljs-type"><span class="hljs-type">A4</span></span> <span class="hljs-type"><span class="hljs-type">JMP</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>4FF <span class="hljs-string"><span class="hljs-string">$A</span></span>4F1:<span class="hljs-type"><span class="hljs-type">A9</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-type"><span class="hljs-type">LDA</span></span> #<span class="hljs-string"><span class="hljs-string">$0</span></span>0 <span class="hljs-string"><span class="hljs-string">$A</span></span>4F3:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-type"><span class="hljs-type">E3</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">STA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E3 = #<span class="hljs-string"><span class="hljs-string">$4</span></span>4 <span class="hljs-string"><span class="hljs-string">$A</span></span>4F6:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-type"><span class="hljs-type">E0</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">STA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E0 = #<span class="hljs-string"><span class="hljs-string">$7</span></span>6 <span class="hljs-string"><span class="hljs-string">$A</span></span>4F9:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-type"><span class="hljs-type">E4</span></span> <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-type"><span class="hljs-type">STA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>6E4 = #<span class="hljs-string"><span class="hljs-string">$0</span></span>A <span class="hljs-string"><span class="hljs-string">$A</span></span>4FC:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-type"><span class="hljs-type">DC</span></span> <span class="hljs-type"><span class="hljs-type">JMP</span></span> <span class="hljs-string"><span class="hljs-string">$D</span></span>C14 ;;         ;; ,       -  . <span class="hljs-string"><span class="hljs-string">$A</span></span>4FF:<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-type"><span class="hljs-type">RTS</span></span> ;;      <span class="hljs-string"><span class="hljs-string">$D</span></span>C14. ;;             label_A500: <span class="hljs-string"><span class="hljs-string">$A</span></span>500:<span class="hljs-type"><span class="hljs-type">AD</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>A <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">LDA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>40A = #<span class="hljs-string"><span class="hljs-string">$0</span></span>1 <span class="hljs-string"><span class="hljs-string">$A</span></span>503:<span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-type"><span class="hljs-type">AND</span></span> #<span class="hljs-string"><span class="hljs-string">$3</span></span>0 <span class="hljs-string"><span class="hljs-string">$A</span></span>505:<span class="hljs-type"><span class="hljs-type">D0</span></span> <span class="hljs-type"><span class="hljs-type">EA</span></span> <span class="hljs-type"><span class="hljs-type">BNE</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>4F1 ;;       , ;;        <span class="hljs-string"><span class="hljs-string">$A</span></span>507:<span class="hljs-type"><span class="hljs-type">AE</span></span> <span class="hljs-type"><span class="hljs-type">E3</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">LDX</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E3 = #<span class="hljs-string"><span class="hljs-string">$4</span></span>4 ;;        <span class="hljs-string"><span class="hljs-string">$0</span></span>4E3 <span class="hljs-string"><span class="hljs-string">$A</span></span>50A:<span class="hljs-type"><span class="hljs-type">BD</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>F <span class="hljs-type"><span class="hljs-type">A7</span></span> <span class="hljs-type"><span class="hljs-type">LDA</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>70F,<span class="hljs-type"><span class="hljs-type">X</span></span> @ <span class="hljs-string"><span class="hljs-string">$A</span></span>763 = #<span class="hljs-string"><span class="hljs-string">$A</span></span>A ;;    <span class="hljs-type"><span class="hljs-type">ROM</span></span>- ,     <span class="hljs-string"><span class="hljs-string">$0</span></span>4E3 <span class="hljs-string"><span class="hljs-string">$A</span></span>50D:<span class="hljs-type"><span class="hljs-type">C9</span></span> <span class="hljs-type"><span class="hljs-type">FF</span></span> <span class="hljs-type"><span class="hljs-type">CMP</span></span> #<span class="hljs-string"><span class="hljs-string">$F</span></span>F <span class="hljs-string"><span class="hljs-string">$A</span></span>50F:<span class="hljs-type"><span class="hljs-type">F0</span></span> <span class="hljs-type"><span class="hljs-type">E0</span></span> <span class="hljs-type"><span class="hljs-type">BEQ</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>4F1 ;;      <span class="hljs-symbol"><span class="hljs-symbol">#FF</span></span>, ;;        <span class="hljs-string"><span class="hljs-string">$A</span></span>511:<span class="hljs-type"><span class="hljs-type">CD</span></span> <span class="hljs-type"><span class="hljs-type">E0</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">CMP</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E0 = #<span class="hljs-string"><span class="hljs-string">$7</span></span>6 ;;        <span class="hljs-string"><span class="hljs-string">$0</span></span>4E0 <span class="hljs-string"><span class="hljs-string">$A</span></span>514:<span class="hljs-type"><span class="hljs-type">D0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>E <span class="hljs-type"><span class="hljs-type">BNE</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>524 ;;   , ... (. ) <span class="hljs-string"><span class="hljs-string">$A</span></span>516:<span class="hljs-type"><span class="hljs-type">A9</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-type"><span class="hljs-type">LDA</span></span> #<span class="hljs-string"><span class="hljs-string">$0</span></span>0 ;;    ... <span class="hljs-string"><span class="hljs-string">$A</span></span>518:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-type"><span class="hljs-type">F4</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">STA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4F4 = #<span class="hljs-string"><span class="hljs-string">$0</span></span>0 <span class="hljs-string"><span class="hljs-string">$A</span></span>51B:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-type"><span class="hljs-type">E0</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">STA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E0 = #<span class="hljs-string"><span class="hljs-string">$7</span></span>6 <span class="hljs-string"><span class="hljs-string">$A</span></span>51E:<span class="hljs-type"><span class="hljs-type">EE</span></span> <span class="hljs-type"><span class="hljs-type">E3</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">INC</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E3 = #<span class="hljs-string"><span class="hljs-string">$4</span></span>4 ;;      <span class="hljs-number"><span class="hljs-number">2</span></span> ( ) <span class="hljs-string"><span class="hljs-string">$A</span></span>521:<span class="hljs-type"><span class="hljs-type">EE</span></span> <span class="hljs-type"><span class="hljs-type">E3</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">INC</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E3 = #<span class="hljs-string"><span class="hljs-string">$4</span></span>4 label_A524: <span class="hljs-string"><span class="hljs-string">$A</span></span>524:<span class="hljs-type"><span class="hljs-type">BD</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-type"><span class="hljs-type">A7</span></span> <span class="hljs-type"><span class="hljs-type">LDA</span></span> <span class="hljs-string"><span class="hljs-string">$A</span></span>710,<span class="hljs-type"><span class="hljs-type">X</span></span> @ <span class="hljs-string"><span class="hljs-string">$A</span></span>764 = #<span class="hljs-string"><span class="hljs-string">$0</span></span>1 <span class="hljs-string"><span class="hljs-string">$A</span></span>527:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-number"><span class="hljs-number">0</span></span>A <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">STA</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>40A = #<span class="hljs-string"><span class="hljs-string">$0</span></span>1 ;;      <span class="hljs-type"><span class="hljs-type">ROM</span></span>-  <span class="hljs-string"><span class="hljs-string">$0</span></span>40A <span class="hljs-string"><span class="hljs-string">$A</span></span>52A:<span class="hljs-type"><span class="hljs-type">EE</span></span> <span class="hljs-type"><span class="hljs-type">E0</span></span> <span class="hljs-number"><span class="hljs-number">04</span></span> <span class="hljs-type"><span class="hljs-type">INC</span></span> <span class="hljs-string"><span class="hljs-string">$0</span></span>4E0 = #<span class="hljs-string"><span class="hljs-string">$7</span></span>6 ;;    <span class="hljs-string"><span class="hljs-string">$A</span></span>52D:<span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-type"><span class="hljs-type">RTS</span></span> ;; </code> </pre><br><br>  So, here we have a couple of cells with some states, another cell with an index, and a certain array in the ROM file.  From the code it can be seen that it is executed only if the flag is set in the $ 04E4 cell.  Let's try to put it. <br><br>  We start the game again, enter the first level and set it to $ 04E4 unit. <br><img src="https://habrastorage.org/storage3/bb3/fe4/52b/bb3fe452b7ad80fb0f45025c3887bacf.png"><br><br>  A second passes and ... he runs himself!  Even the buttons do not need to press. <br>  If we wait for Demo play, we will find that there is already a unit in the $ 04E4 cell, and if we reset this cell during the demo, the demo play will disappear and control will pass into our hands.  Very convenient: the demo passes the main part for us, then we can reset $ 04E4 and continue the game on our own. <br><br>  Now we can, relying on the game, parse the code.  Obviously, the $ DC14 procedure sends us to the game menu.  The $ A70F array stores some structures two bytes each, and ends with the #FF marker.  Moreover, the first byte is a certain time interval, at the completion of which the index increases, and the second byte from the following structure is transferred to the $ 040A cell.  What does he mean? <br>  Take a look at the array: <br> <code>64 00 . A0 01 . 28 00 . E6 84 . E6 02 ... FF</code> <br>  At first we expect # 64 u.e.  (conditional time units), then # A0 Iu, then # 28 and so on until the #FF marker.  Let's change the time in the first pair of bytes to #FE and in demo play we will find that the character stands like a graven image after the start for a long time.  If we put # 02 there, then it will turn to the left and it will be a bit to hammer into the wall for some time.  Therefore, the second byte describes the action that it will perform during the specified time interval.  Since the game is deterministic, we only need to rigidly define a sequence of certain actions, and it will be ‚Äúplayed‚Äù by itself. <br>  In fact, the second byte is an imitation of pressing the buttons on the gamepad, where the first bit encodes the button to the right, the second bit to the left, and so on.  The combination of these bits determines the pseudo-state of the gamepad during demo-play.  By editing this array, we can adjust the demo play to our new level. <br>  If we monitor what happens then with the value in the $ 040A cell, then we will come to the data structure, which is located at the address $ 060E.  It is described as follows: <br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CHARACTER</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bCharType; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> X; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> Y; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> ptrAction; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bDirection; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bActionIndex; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bPoseIndex; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> bReserved[<span class="hljs-number"><span class="hljs-number">4</span></span>]; };</code> </pre><br>  Having reached this structure, we learn that there is an array of ‚Äúactions‚Äù consisting of pointers to certain structures, which then unfold into a sequence of sprite displays on the screen.  The ‚Äúaction‚Äù means what the character performs on the screen: running, jumping, crouching, and other actions.  Similarly, everything with the index of ‚Äúposture‚Äù: whether it stands or sits, is determined by this member of the structure.  We will need this structure in the future, but for now we need to figure out how we get from level to level. <br><br><h6>  Running through the maze </h6><br>  Here, as before, we will have a starting point - a cell of $ 70.  When moving from level to level, we will see the code (as before, we catch at the breakpoint by the condition of writing to the $ 70 cell): <br><pre> <code class="hljs mel">$86F3:AD <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span> LDA $0735 = #$00 $86F6:D0 <span class="hljs-number"><span class="hljs-number">0</span></span>D BNE $8705 $86F8:A5 <span class="hljs-number"><span class="hljs-number">70</span></span> LDA $0070 = #$00 $86FA:<span class="hljs-number"><span class="hljs-number">18</span></span> CLC $86FB:<span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> ADC #$01 $86FD:C9 <span class="hljs-number"><span class="hljs-number">0</span></span>E CMP #$0E $86FF:<span class="hljs-number"><span class="hljs-number">90</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> BCC $8703 $8701:A9 <span class="hljs-number"><span class="hljs-number">00</span></span> LDA #$00 $8703:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">70</span></span> STA $0070 = #$00 ;; &lt;&lt;&lt;  $8705:A9 <span class="hljs-number"><span class="hljs-number">00</span></span> LDA #$00 $8707:<span class="hljs-number"><span class="hljs-number">8</span></span>D <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> STA $2001 = #$18 $870A:<span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> STA $0015 = #$18 $870C:<span class="hljs-number"><span class="hljs-number">4</span></span>C <span class="hljs-number"><span class="hljs-number">1</span></span>D CB JMP $CB1D</code> </pre><br>  Here we see that a unit is added to the $ 70 cell, and then we move somewhere to the last bank.  Moreover, there is a check: if the number is greater than 13, then reset this value.  This means that if we set the output at level 14, we will move back to the first one.  This is the initiating procedure to proceed to the next level.  Then we will show the password and we will find ourselves in the next level.  Let's see where it comes from. <br><br><h6>  Hardcode </h6><br>  As in the x86 architecture, so here, the procedure call occurs by entering the argument JSR instruction into the Instruction Pointer register and placing the return address on the stack.  In the stack we have the following: <br><img src="http://habrastorage.org/storage3/cee/4f8/618/cee4f86186d703bdf6f7e0c32774f56b.png"><br> <code>22, CC, ...</code> <br>  Consequently, the instruction in front of the instruction at $ CC22 caused us: <br><pre> <code class="hljs perl">$CC20:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>E <span class="hljs-number"><span class="hljs-number">86</span></span> JSR $861E</code> </pre><br>  It is cumbersome and uninteresting to trace all of it.  Switch the breakpoint from writing to $ 70 to read and start debugging.  First, we will stop at the familiar $ C0D5 procedure - it is not interesting for us, but the next stop will lead us here: <br><pre> <code class="hljs mel">$D0B8:A5 <span class="hljs-number"><span class="hljs-number">70</span></span> LDA $0070 = #$0B $D0BA:C9 <span class="hljs-number"><span class="hljs-number">0</span></span>B CMP #$0B $D0BC:D0 <span class="hljs-number"><span class="hljs-number">0</span></span>C BNE $D0CA $D0BE:A5 <span class="hljs-number"><span class="hljs-number">51</span></span> LDA $0051 = #$16 $D0C0:C9 <span class="hljs-number"><span class="hljs-number">16</span></span> CMP #$16 $D0C2:D0 <span class="hljs-number"><span class="hljs-number">06</span></span> BNE $D0CA $D0C4:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> D0 JSR $D010 $D0C7:<span class="hljs-number"><span class="hljs-number">4</span></span>C F3 <span class="hljs-number"><span class="hljs-number">86</span></span> JMP $86F3</code> </pre><br>  The value in our cell is compared with the number # 0B == 11 (recall that the levels are numbered from zero), and then comes reading from cell $ 51, where we have # 16 = 22. Based on the fact that we are in room 22 ( if you look at the level map), then at $ 51 we have the room number we did not look for last time.  If these checks are performed, then we go to the address $ 86F3 - that is, the procedure that initiates the transition.  Developers tritely stitched into the code to go to another level from this room, if the character leaves the room to the left. <br>  We can find a similar test if we look for a transition from the sixth level to the seventh, when a character falls into the abyss.  That is, it is enough for us to edit the instructions of the CMP, and these properties will have a different room.  This is the only condition that must be met: the transition to the next level will take place if we go left (for this check) or fall down (for the second). <br><br>  After studying the launch code of the new level, we will also see that for the first level, the coordinates of the character are also overwritten with the values ‚Äã‚Äãstrictly specified in the code, so we could not move it when we changed the level header at the beginning of our research.  Similar checks are performed after the defeat of the guard at level 13, opening the way for us.  All of them are quite simply in a similar way. <br><br><h5>  We take out the skeleton from the cabinet and paint the walls </h5><br>  The editor is almost finished.  Studying the transitional moments from level to level or from room to room, we will find the remaining parameters that can be edited.  Since the approaches to the search for such data have already been considered, I will not dwell here in detail.  I will give only a general description, and at the end of the last chapter I will give a list of shifts in ROM to the structures of the game and their description. <br><br>  <code>0x13BEB: 00 00 24 00 00 00 00 00 00 00 00 24 00 00</code> - an array containing the code for the set of tiles with which we will draw the guard (the guard or the skeleton itself).  This structure is similar to the one that describes the kind of level, and it is similar to the one that determines the amount of health in the level. <br><br>  The palette is built from two arrays of pointers and the actual array of the palettes themselves.  The palette itself is stored exactly in the form in which it is sent to the PPU as a sequence of 32 bytes.  The second array contains only 7 pointers, which lead us to the palettes that are acceptable for the level, and the first pointer is equal to the sixth one.  And the first array consists of 14 pointers (according to the number of levels), each of which leads us to one or another element of the second array. <br><br><h5>  Almost ready </h5><br><img src="http://habrastorage.org/storage3/814/763/624/814763624ec7be79e1c3564218b5e028.png"><br>  At this stage, I have already sketched an approximate shell for the editor, only one minor detail remained.  Later, I'll tell you what the magic numbers in the status line mean. <br><br>  In the fifth and final chapter, called ‚ÄúReflection,‚Äù we will try to learn how to manage the prince‚Äôs reflection.  From the secondary element, which had virtually no effect on the course of the game, we can turn it into one of the main ones, without which it would be impossible to complete the game, and the prince would not be so alone in those cold walls in which he was enclosed. </div><p>Source: <a href="https://habr.com/ru/post/192546/">https://habr.com/ru/post/192546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192532/index.html">Prototype housing for electronics: grow or mill?</a></li>
<li><a href="../192538/index.html">Code coverage in Badoo</a></li>
<li><a href="../192540/index.html">Free educational course "Starting a business web studio from scratch" of 6 lectures</a></li>
<li><a href="../192542/index.html">Educational projects in ABBYY: what's new?</a></li>
<li><a href="../192544/index.html">HDMI 2.0 specifications released</a></li>
<li><a href="../192548/index.html">Hello, Russia!</a></li>
<li><a href="../192554/index.html">Webcast: Dell Converged Network Solutions</a></li>
<li><a href="../192556/index.html">Flex & utf8</a></li>
<li><a href="../192558/index.html">SATA controller, blurred photography and competition</a></li>
<li><a href="../192560/index.html">We buy new Kindle and Nexus 4.7 without intermediaries</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>