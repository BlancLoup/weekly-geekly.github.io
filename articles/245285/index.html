<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Wintering cacti with online temperature control</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="For many years, as a wife became fascinated with the cultivation of cacti, and yet she could not manage to arrange for them to winter properly. The fa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Wintering cacti with online temperature control</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/0ad/d74/448/0add744488244a83a6ab27ed44d3dc90.png" alt="web interface cactus wintering temperature control"><br><br>  For many years, as a wife became fascinated with the cultivation of cacti, and yet she could not manage to arrange for them to winter properly.  The fact is that for cacti it is very important that they survive the winter at a temperature of 5 to 15 ¬∞ C - not lower, not to die, and not higher, not to decide that it is already spring.  I would like to share with you how I managed to create an <b>Arduino</b> temperature control system with online control via <b>Dropbox</b> with very affordable means. <br><a name="habracut"></a><br><h1>  Starting materials </h1><br><ul><li>  <b>Arduino Uno</b> with breadboard </li><li>  Chip temperature sensor <b>LM35</b> </li><li>  Heaterblow type heater </li><li>  Chinese extension cord </li><li>  Mechanical relay (5 V per coil for 220 V control circuit) </li><li>  Old laptop </li></ul><br><br><h1>  Heater and relay </h1><br>  A winter house is organized on a balcony where the sun does not fall, so there is always cool there.  If the temperature falls below a predetermined threshold, then the heater, which I connected to the <b>Arduino</b> via a mechanical relay, must be turned on.  In order not to disassemble the heater, I modified the Chinese extension cord: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Cut and unused an unused piece of "earth" wire from both sides </li><li>  I connected this wire to the bus instead of one of the ‚Äúactive‚Äù wires. </li><li>  Stretched the ends of both wires through the inner hole and connected them to the relay on the front of the extension cord </li><li>  Connect control cables to the relay with a convenient terminal. </li></ul><br>  Now <b>Arduino</b> can control a heater connected via an extension cord! <br><br><div class="spoiler">  <b class="spoiler_title">Stages of modification of the extension cord in the relay (photo)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/4c1/a87/c07/4c1a87c071de44d3b881cd94c8a3d3f4.jpg" alt="stages of creating a relay from a Chinese extension cable"><br></div></div><br><img src="https://habrastorage.org/files/233/e93/a06/233e93a06f4b4090b3a05ddaf002c9c2.jpg" alt="Chinese extension relay"><br><br><br><br><h1>  Schematic diagram </h1><br><img src="https://habrastorage.org/files/12c/84d/5a4/12c84d5a42e248a79fdd891994af72ff.png" alt="schematic diagram of the device for monitoring the temperature of the wintering cacti"><br><br>  <b>Arduino Uno</b> board is connected via USB to an old laptop.  As a temperature sensor, I used the <b>LM35</b> chip, which linearly displays the ambient temperature and voltage. <br><br>  A separate power supply is needed to power the relay, since the coil's rated current of 110 mA is close to the <b>Arduino Uno's</b> current output limit.  The first time, I still used the power from the <b>Arduino Uno</b> , but the readings of the temperature meter went off each time the relay was turned on, so I arranged the power through a separate USB connection. <br><br>  The heater is connected to an extension cord, the extension cord is connected to the power supply.  When the relay is turned on, the heater starts warming immediately, but at low power, so as not to frighten cacti with sudden temperature changes. <br><br><br><h1>  Program </h1><br>  The program for the <b>Arduino</b> once per second polls the temperature sensor and outputs the temperature value via a serial interface.  In addition to the instantaneous temperature value, the program outputs the averaged value and the state vector: heater control mode (always on / always off / automatic) and the temperature range for the automatic mode.  In this mode, the program turns on the heater when the temperature drops below the first preset threshold, and turns it off when it rises above the second preset threshold. <br><br><div class="spoiler">  <b class="spoiler_title">Program for Arduino</b> <div class="spoiler_text"><pre><code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/ Cactus Tracker v1.0.1 /</span></span> December <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">2014</span></span> /<span class="hljs-regexp"><span class="hljs-regexp">/ by Maksym Ganenko &lt;buratin.barabanus at Google Mail&gt; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> const int PIN_HEATER = <span class="hljs-number"><span class="hljs-number">10</span></span>; const int DELAY_MS = <span class="hljs-number"><span class="hljs-number">1000</span></span>; const int MAGIC = <span class="hljs-number"><span class="hljs-number">10101</span></span>; const float TEMP_MAX = <span class="hljs-number"><span class="hljs-number">20.0</span></span>; enum { OFF = <span class="hljs-number"><span class="hljs-number">0</span></span>, ON, AUTO }; int mode = AUTO; float tempAverage = NAN; bool heater = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; float heaterFrom = <span class="hljs-number"><span class="hljs-number">5</span></span>.f; float heaterTo = <span class="hljs-number"><span class="hljs-number">10</span></span>.f; void startHeater() { digitalWrite(PIN_HEATER, HIGH); heater = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } void stopHeater() { digitalWrite(PIN_HEATER, LOW); heater = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } void setup() { Serial.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); digitalWrite(PIN_HEATER, LOW); pinMode(PIN_HEATER, OUTPUT); analogReference(INTERNAL); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>; ++i) { analogRead(A<span class="hljs-number"><span class="hljs-number">0</span></span>); } } void loop() { float tempMV = float(analogRead(A<span class="hljs-number"><span class="hljs-number">0</span></span>)) / <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1.1</span></span>; float tempCurrent = tempMV / <span class="hljs-number"><span class="hljs-number">10</span></span>e-<span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isnan(tempAverage)) { tempAverage = tempCurrent; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { tempAverage = tempAverage * <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">95</span></span>f + tempCurrent * <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">05</span></span>f; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Serial.available()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Serial.parseInt() == MAGIC) { int newMode = Serial.parseInt(); float newHeaterFrom = Serial.parseFloat(); float newHeaterTo = Serial.parseFloat(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newMode &gt;= OFF &amp;&amp; newMode &lt;= AUTO &amp;&amp; newHeaterFrom &lt; newHeaterTo) { mode = newMode; heaterFrom = newHeaterFrom; heaterTo = newHeaterTo; stopHeater(); } } } bool overheat = tempAverage &gt;= TEMP_MAX; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!overheat &amp;&amp; (mode == ON <span class="hljs-params"><span class="hljs-params">||</span></span> (mode == AUTO &amp;&amp; tempAverage &lt;= heaterFrom))) { startHeater(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (overheat <span class="hljs-params"><span class="hljs-params">||</span></span> mode == OFF <span class="hljs-params"><span class="hljs-params">||</span></span> (mode == AUTO &amp;&amp; tempAverage &gt;= heaterTo)) { stopHeater(); } Serial.print(<span class="hljs-string"><span class="hljs-string">"mode = "</span></span>); Serial.print(mode); Serial.print(<span class="hljs-string"><span class="hljs-string">", tempCurrent = "</span></span>); Serial.print(tempCurrent); Serial.print(<span class="hljs-string"><span class="hljs-string">", tempAverage = "</span></span>); Serial.print(tempAverage); Serial.print(<span class="hljs-string"><span class="hljs-string">", heater = "</span></span>); Serial.print(heater); Serial.print(<span class="hljs-string"><span class="hljs-string">", heaterFrom = "</span></span>); Serial.print(heaterFrom); Serial.print(<span class="hljs-string"><span class="hljs-string">", heaterTo = "</span></span>); Serial.println(heaterTo); delay(DELAY_MS); } /<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span></code> </pre> </div></div><br>  On an old laptop, there is Python with the <a href="http://pyserial.sourceforge.net/">pySerial</a> library <a href="http://pyserial.sourceforge.net/">installed</a> .  A Python program connects to <b>Arduino</b> via a serial interface and every ten minutes adds the average temperature and device state vector to the <b>cactuslog.txt</b> file.  The log also includes the exact time on and off the heater.  If the program detects the command file <b>cactuscmd.txt</b> , then the contents of this file are sent to <b>Arduino</b> several times through a serial interface, and the file itself is renamed to <b>cactusini.txt</b> .  This batch file is executed once when the program starts, so if there is a power outage and a system reboot, then through this file it will restore its original state. <br><br><div class="spoiler">  <b class="spoiler_title">Python program for an old laptop</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">############################################################################### # Cactus Tracker v1.0.1 / December 8, 2014 # by Maksym Ganenko &lt;buratin.barabanus at Google Mail&gt; ############################################################################### import serial, re import sys, os, traceback from datetime import datetime # arduino serial port in your system SERIAL = (sys.platform == "win32") and "COM4" or "/dev/tty.usbmodem1421" # input / output files INIFILE = "cactusini.txt" CMDFILE = "cactuscmd.txt" LOGFILE = "cactuslog.txt" # log update period in seconds UPDATE_PERIOD_SEC = 600 ############################################################################### def execute(cmdfile, **argv): if os.path.isfile(cmdfile): try: # input fcmd = open(cmdfile) stream.write(((fcmd.read().strip() + " ") * 10).strip()) fcmd.close() if "renameTo" in argv: dstfile = argv["renameTo"] if os.path.isfile(dstfile): os.remove(dstfile) os.rename(cmdfile, dstfile) except: traceback.print_exc() if fcmd and not fcmd.closed: fcmd.close() firstRun = True fcmd, flog, timemark, lastState = None, None, None, None stream = serial.Serial(SERIAL, 9600) while True: s = stream.readline() if "mode" in s: record = dict(re.findall(r"(\w+)\s+=\s+([-.\d]+)", s)) mode, temp = int(record["mode"]), float(record["tempAverage"]) heater = int(record["heater"]) heaterFrom = float(record["heaterFrom"]) heaterTo = float(record["heaterTo"]) state = (mode, heater, heaterFrom, heaterTo) if firstRun: execute(INIFILE) firstRun = False execute(CMDFILE, renameTo = INIFILE) timeout = not timemark or \ (datetime.now() - timemark).seconds &gt; UPDATE_PERIOD_SEC if timeout or state != lastState: output = (datetime.now(), temp, mode, heater, heaterFrom, heaterTo) output = "%s,%.2f,%d,%d,%.1f,%.1f" % output try: # output flog = open(LOGFILE, "a") flog.write(output + "\n") except: traceback.print_exc() if flog: flog.close() print output timemark = datetime.now() lastState = state ###############################################################################</span></span></code> </pre></div></div><br><br><h1>  Visualization and Dropbox </h1><br>  The whole project fits in one folder added to <b>Dropbox</b> .  One Python program running on an old laptop connected to the <b>Arduino</b> , and works with logs and commands as local files.  Another Python program is launched from the same folder on any computer and creates a simple HTTP server with the specified address and port.  You will need to install several libraries for Python: <a href="http://www.scipy.org/">SciPy</a> and <a href="https://labix.org/python-dateutil">dateutil</a> . <br><br>  By running the second program, you can monitor the temperature in the zimovnik directly from the browser!  The generated page displays: <br><br><ul><li>  smoothed temperature graph for the last three days </li><li>  temperature limits for the last week </li><li>  heater activation periods </li><li>  current mode of the system with the possibility of changing </li></ul><br><div class="spoiler">  <b class="spoiler_title">Check the chart again</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/744/f3a/be5/744f3abe5f2d43ef9486b05e81630234.png" alt="web interface cactus wintering temperature control"></div></div><br>  Thanks to <b>Dropbox</b> , this project can be launched not only at home, but also, for example, at the cottage.  <b>Dropbox</b> itself will synchronize all files, and the programs are written as if they deal only with local files.  The only thing you will need to take care of a possible power outage and restart the computer. <br><br><div class="spoiler">  <b class="spoiler_title">Python program to display and control the winte</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">######################################################################################### # Cactus Tracker v1.0.5 / January 11, 2015 # by Maksym Ganenko &lt;buratin.barabanus at Google Mail&gt; ######################################################################################### import io, os, re, traceback import BaseHTTPServer, urlparse, base64 import dateutil.parser import matplotlib, numpy from matplotlib import pylab from matplotlib.ticker import AutoMinorLocator from matplotlib.colors import rgb2hex from datetime import datetime, timedelta from itertools import groupby HOST = "stepan.local" PORT = 8080 USERNAME = "cactus" PASSWORD = "forever" LOGFILE = "cactuslog.txt" CMDFILE = "cactuscmd.txt" FONT = "Arial" FONT_SIZE = 12 STATS_DAYS_NUM = 7 SMOOTH_WINDOW = 9 CURVE_ALPHA = [1.0, 0.5, 0.25, 0.1] MAGIC = 10101 # time difference in seconds between real time and log time LOG_TIME_OFFSET_SEC = 3600 OFF, ON, AUTO = 0, 1, 2 ######################################################################################### class CactusHandler(BaseHTTPServer.BaseHTTPRequestHandler): def do_GET(self): if not self.authorize(): return url = urlparse.urlparse(self.path) query = urlparse.parse_qs(url.query) pending, smooth = False, SMOOTH_WINDOW if "mode" in query and "hfrom" in query and "hto" in query: pending = True try: mode = int(query["mode"][0]) heaterFrom = float(query["hfrom"][0]) heaterTo = float(query["hto"][0]) self.update_params(mode, heaterFrom, heaterTo) except: traceback.print_exc() if "smooth" in query: try: smooth = int(query["smooth"][0]) except: traceback.print_exc() if self.path in [ "/cactus.png", "/favicon.ico" ]: self.send_image(self.path) else: self.send_page(pending, smooth) self.wfile.close() def authorize(self): if self.headers.getheader("Authorization") == None: return self.send_auth() else: auth = self.headers.getheader("Authorization") code = re.match(r"Basic (\S+)", auth) if not code: return self.send_auth() data = base64.b64decode(code.groups(0)[0]) code = re.match(r"(.*):(.*)", data) if not code: return self.send_auth() user, password = code.groups(0)[0], code.groups(0)[1] if user != USERNAME or password != PASSWORD: return self.send_auth() return True def send_auth(self): self.send_response(401) self.send_header("WWW-Authenticate", "Basic realm=\"Cactus\"") self.send_header("Content-type", "text/html") self.end_headers() self.send_default() self.wfile.close() return False def send_default(self): self.wfile.write(""" &lt;html&gt; &lt;body style="background:url(data:image/png;base64,{imageCode}) repeat;"&gt; &lt;/body&gt; &lt;/html&gt;""".format(imageCode = "iVBORw0KGgoAAAANSUhEUgAAAAYAAAAGCAYAAADgzO9IAAA" + "AJ0lEQVQIW2NkwA7+M2IR/w8UY0SXAAuCFCNLwAWRJVAEYRIYgiAJALsgBgYb" + "CawOAAAAAElFTkSuQmCC")) def address_string(self): host, port = self.client_address[:2] return host def update_params(self, mode, heaterFrom, heaterTo): if max(mode, heaterFrom, heaterTo) &gt;= MAGIC: print "invalid params values" return fout = open(CMDFILE, "w") fout.write("%d %d %.1f %.1f" % (MAGIC, mode, heaterFrom, heaterTo)) fout.close() def send_image(self, path): filename = os.path.basename(path) name, ext = os.path.splitext(filename) fimage = open(filename) self.send_response(200) format = { ".png" : "png", ".ico" : "x-icon" } aDay = timedelta(days = 1) now = datetime.now().strftime('%a, %d %b %Y %H:%M:%S GMT') expires = (datetime.now() + aDay).strftime('%a, %d %b %Y %H:%M:%S GMT') self.send_header("Content-type", "image/" + format[ext]) self.send_header("Cache-Control", "public, max-age=" + str(aDay.total_seconds())) self.send_header("Date", now) self.send_header("Expires", expires) self.send_header("Content-length", os.path.getsize(filename)) self.end_headers() self.wfile.write(fimage.read()) fimage.close() def fix_time(self, X): time = X[0].timetuple() if time.tm_hour == 0 and time.tm_min &lt;= 11: X[0] -= timedelta(seconds = time.tm_min * 60 + time.tm_sec) time = X[-1].timetuple() if time.tm_hour == 23 and time.tm_min &gt;= 49: offset = (60 - time.tm_min - 1) * 60 + (60 - time.tm_sec - 1) X[-1] += timedelta(seconds = offset) def make_smooth(self, Y, winSize): winSize = min(winSize, len(Y) - 2) if winSize == 0: return list(Y) Y = [ 2 * Y[0] - foo for foo in reversed(Y[1:winSize + 1]) ] + list(Y) \ + [ 2 * Y[-1] - foo for foo in reversed(Y[-winSize - 1:-1]) ] window = numpy.ones(winSize * 2 + 1) / float(winSize * 2 + 1) Y = numpy.convolve(Y, window, 'same') Y = Y[winSize:-winSize] return list(Y) def send_page(self, pending, smooth): self.send_response(200) self.send_header("Content-type", "text/html") self.end_headers() data, flog = [ ], None nowDate = datetime.now().date() while not flog: try: flog = open(LOGFILE) except: traceback.print_exc() mode, heater, heaterFrom, heaterTo = AUTO, 0, 5, 10 for s in flog: row = tuple(s.strip().split(",")) offset = timedelta(seconds = LOG_TIME_OFFSET_SEC) date = dateutil.parser.parse(row[0]) + offset temp = float(row[1]) if len(row) == 3: heater = int(row[2]) elif len(row) &gt;= 3: mode, heater = int(row[2]), int(row[3]) heaterFrom, heaterTo = float(row[4]), float(row[5]) data.append((date, temp, heater)) stats = [ ] matplotlib.rc("font", family = FONT, size = FONT_SIZE) fig = pylab.figure(figsize = (964 / 100.0, 350 / 100.0), dpi = 100) ax = pylab.axes() for date, points in groupby(data, lambda foo: foo[0].date().isoformat()): X, Y, H = zip(*points) deltaDays = (nowDate - X[0].date()).days if deltaDays &gt;= STATS_DAYS_NUM: continue if len(X) == 1: continue # convert to same day data alpha = CURVE_ALPHA[min(len(CURVE_ALPHA) - 1, deltaDays)] tempColor = rgb2hex((1 - alpha, 1 - alpha, 1)) heaterColor = rgb2hex((1, 1 - alpha, 1 - alpha)) X = [ datetime.combine(nowDate, foo.time()) for foo in X ] self.fix_time(X) if deltaDays &lt; len(CURVE_ALPHA) - 1: # make smooth and draw start = 0 for heater, group in groupby(zip(Y, H), lambda foo: foo[1]): finish = start + len(list(group)) XS = X[start:finish + 1] if heater: YS = Y[start:finish + 1] elif finish + 1 - start &lt; smooth: winSize = (finish + 1 - start) / 2 YS = self.make_smooth(Y[start:finish + 1], winSize) else: YS = self.make_smooth(Y[start:finish + 1], smooth) pylab.plot(XS, YS, linewidth = 2, color = heater and heaterColor or tempColor) start = finish else: for i in range(3): Y = self.make_smooth(Y, smooth) self.fix_time(X) stats.append((X, Y)) # plot stats curve if deltaDays == len(CURVE_ALPHA) - 1: X0, Y0 = stats.pop(0) for curve in stats: X1, Y1 = curve pylab.fill(X0 + list(reversed(X1)), Y0 + list(reversed(Y1)), color = tempColor) ax.xaxis_date() ax.xaxis.set_major_formatter(matplotlib.dates.DateFormatter("%H:%M")) ax.xaxis.set_major_locator(matplotlib.dates.HourLocator()) ax.yaxis.get_major_locator().set_params(integer = True, nbins = 11) ax.xaxis.grid(True, "major") ax.yaxis.grid(True, "major") ticks = ax.yaxis.get_major_locator().bin_boundaries(*ax.get_ylim()) if len(ticks) &gt;= 2 and round(ticks[1] - ticks[0]) &gt; 1: step = int(round(ticks[1] - ticks[0])) ax.yaxis.grid(True, "minor") ax.yaxis.set_minor_locator(AutoMinorLocator(n = step)) ax.tick_params(axis = "both", which = "both", direction = "out", labelright = True) ax.tick_params(axis = "x", which = "major", labelsize = 8) ax.grid(which = "major", alpha = 1.0) fig.autofmt_xdate() pylab.tight_layout() image = io.BytesIO() pylab.savefig(image, format = "png") pylab.clf() image.seek(0) graph = "&lt;img src='data:image/png;base64,%s'/&gt;" % \ base64.b64encode(image.getvalue()) image.close() pending = pending or os.path.isfile(CMDFILE) self.wfile.write(re.sub(r"{\s", r"{{ ", re.sub(r"\s}", r" }}", """ &lt;html&gt; &lt;head&gt; &lt;title&gt;Cactus Tracker&lt;/title&gt; &lt;meta http-equiv="refresh" content="{pending};URL='/'"&gt; &lt;style&gt; body { font-family: {font}, sans-serif; font-size: {fontSize}pt; width: 964px; margin: 47px 30px 0 30px; padding: 0; background-color: white; color: #262626; } h1 { font-size: 24pt; margin: 0; padding-bottom: 4px; border-bottom: 2px dotted #262626; margin-bottom: 26px; } p { margin-left: 38px; margin-bottom: 20px; } input { font-family: {font}, sans-serif; font-size: {fontSize}pt; border: 2px solid #262626; padding: 2px 6px; } button { font-family: {font}, sans-serif; font-size: {fontSize}pt; padding: 4px 8px; border: 2px solid #262626; border-radius: 10px; background-color: white; color: #262626; margin: 0 3px; } form { display: inline-block; margin: 0; } .selected, button:hover:not([disabled]) { cursor: pointer; background-color: #262626; color: white; } .selected:hover { cursor: default; } .heater { width: 50px; text-align: center; margin: 0 3px; } .pending { opacity: 0.5; } .hidden { display: none; } &lt;/style&gt; &lt;/head&gt; &lt;body&gt; &lt;h1&gt;Cactus Tracker&lt;/h1&gt; &lt;div&gt;{graph}&lt;/div&gt; &lt;table style="width: 100%;" cellspacing=0 cellpadding=0&gt; &lt;tr&gt; &lt;td align=left&gt; &lt;form action="/" class="{transparent}"&gt; &lt;p&gt;Heater: &lt;button type="submit" name="mode" class="{modeOn}" value="1" {disabled}&gt; on &lt;/button&gt; &lt;button type="submit" name="mode" class="{modeOff}" value="0" {disabled}&gt; off &lt;/button&gt; &lt;button type="submit" name="mode" class="{modeAuto}" value="2" {disabled}&gt; auto &lt;/button&gt; &lt;input type="hidden" name="hfrom" value="{heaterFrom:.0f}"/&gt; &lt;input type="hidden" name="hto" value="{heaterTo:.0f}"/&gt; &lt;/form&gt; &lt;form action="/" class="{transparent} {heaterAuto}"&gt; &lt;span style="margin-left: 30px;"&gt; &lt;input type="hidden" name="mode" value="{mode}"/&gt; heat from &lt;input name="hfrom" class="heater" maxlength=2 value="{heaterFrom:.0f}" {disabled}/&gt; to &lt;input name="hto" class="heater" maxlength=2 value="{heaterTo:.0f}" {disabled}/&gt; ¬∞C &lt;button type="submit" style="visibility: hidden;" {disabled}&gt;&lt;/button&gt; &lt;/span&gt; &lt;/form&gt; &lt;/td&gt; &lt;td style="opacity: 0.5;" align=right&gt; &lt;span style="margin-right: 40px;"&gt;The last {days} days are shown&lt;/span&gt; &lt;/td&gt; &lt;/tr&gt; &lt;/table&gt; &lt;/div&gt; &lt;div style="position: absolute; top: 7px; left: 760px;"&gt; &lt;img src="cactus.png"&gt; &lt;/div&gt; &lt;/body&gt; &lt;/html&gt; """)).format( font = FONT, fontSize = FONT_SIZE, days = STATS_DAYS_NUM, graph = graph, mode = mode, heaterFrom = heaterFrom, heaterTo = heaterTo, modeOff = (mode == OFF) and "selected" or "", modeOn = (mode == ON) and "selected" or "", modeAuto = (mode == AUTO) and "selected" or "", pending = pending and "20" or "1200", disabled = pending and "disabled=true" or "", transparent = pending and "pending" or "", heaterAuto = (mode != AUTO) and "hidden" or "")) ######################################################################################### server = BaseHTTPServer.HTTPServer((HOST, PORT), CactusHandler) server.serve_forever() #########################################################################################</span></span></code> </pre></div></div><br><br><h1>  Links </h1><br><ul><li>  <a href="https://www.dropbox.com/sh/oq4qwjb16mk14lj/AABm9rHl0FVpHnU21_2TP4hVa%3Fdl%3D0">Dropbox project folder</a> </li></ul><br><br><img src="https://habrastorage.org/files/4ee/f35/d6d/4eef35d6d1c04cdb80a3b01582940407.jpg" alt="Photo of wintering cacti with temperature control on the Arduino"><br><br><hr>  / \ / \ / \ / \ / \ / \ / \ / \ / \ / \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ / \ / \ / \ / \ / \ / \ / \ / \ / \ / \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ / \ / \ / \ / \ / \ / \ / \ / \ / \ / \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ / \ / \ / \ / \ / \ / \ / \ / \ / \ / \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ / \ / \ / \ / \ / \ / \ / \ / \ / \ / \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ / \ <br><hr><br><h1>  UPDATE </h1><br><ul><li>  Translated the project to <b>Arduino Nano</b> , which greatly improved the aesthetics and conciseness of the assembly </li><li>  Added a digital humidity sensor <b>DHT-22</b> .  At the same time, I made sure that the temperature measured by the sensor is approximately equal to the readings of <b>LM35</b> , which remained the main temperature sensor. </li><li>  I discovered the reason why the temperature sensor reads when the heater was turned on: the relay current raised the sensor ground.  Corrected by using two different controller ground inputs for a relay and a sensor.  The second power is no longer needed! </li><li>  Significantly improved graph smoothing algorithm </li></ul><img src="https://habrastorage.org/files/d6b/6d3/b19/d6b6d3b196b0478cba97056b00c13a24.png"><br></div><p>Source: <a href="https://habr.com/ru/post/245285/">https://habr.com/ru/post/245285/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245269/index.html">How to invent a bike and get to know FRP</a></li>
<li><a href="../245271/index.html">Asterisk. Sending and receiving faxes</a></li>
<li><a href="../245277/index.html">Professional development managers. Kaizen practice training on internship in Japan</a></li>
<li><a href="../245279/index.html">Toaster. Enhanced tag subscription: Receive instant email notifications of all new issues for any tag.</a></li>
<li><a href="../245281/index.html">Interview with Chalz Dahigg: how strength of habit can help you achieve your goals</a></li>
<li><a href="../245287/index.html">The new version of Veeam ONE v8 has been released - a product for monitoring the virtual infrastructure of VMware vSphere and Hyper-V</a></li>
<li><a href="../245289/index.html">As I increased sales of modules for CMS</a></li>
<li><a href="../245291/index.html">Training testers. Practical experience and advice</a></li>
<li><a href="../245293/index.html">Virtual hosting and php5.4, when already?</a></li>
<li><a href="../245295/index.html">How to download virtual corporate Office 2013 from Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>