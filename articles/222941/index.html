<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ruby 2.1 in detail (Part 1)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ruby 2.1, the last significant version of Ruby (at the time of writing), was released on Christmas Day 2013, only 10 months after the release of 2.0.0...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ruby 2.1 in detail (Part 1)</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/getpro/habr/post_images/ccd/b8f/bab/ccdb8fbabd2b13bae6145fa4da9c7ac2.png"><br>  Ruby 2.1, the last significant version of Ruby (at the time of writing), was released on Christmas Day 2013, only 10 months after the release of 2.0.0.  She came out with a number of changes and improvements, and this post describes these innovations in detail. <br><a name="habracut"></a><br><h5>  New version control policy </h5><br>  With version 2.1, Ruby moves to a new version change scheme based on <a href="http://semver.org/">Semantic Versioning</a> . <br><br>  Versions are released according to the scheme MAJOR.MINOR.TEENY, i.e.  in version 2.1.0: 2 is the major version, 1 is the minor version, the minor version is 0. The minor version number is taken from the patchlelo for the minor bug and security vulnerabilities.  The minor version number will be used for new features, mostly backward compatible, and the major version for incompatible changes, which cannot be released under the minor version. <br><br>  This means that instead of, for example 1.9.3 and 1.9.3-p545, we will receive releases of the form 2.1 and 2.1.1. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is planned to release minor versions every 12 months, i.e.  we can expect Ruby 2.2 for Christmas 2014. <br><br><h5>  Required Named Arguments </h5><br>  <a href="http://globaldev.co.uk/2013/03/ruby-2-0-0-in-detail/">Named arguments</a> introduced in Ruby 2.0.0 have added a slight improvement.  Now you can omit the default value for the named arguments when defining the method, and if they are not specified when the method is called, an error will be raised. <br><br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># length is required def pad(num, length:, char: "0") num.to_s.rjust(length, char) end pad(42, length: 6) #=&gt; "000042" pad(42) #=&gt; #&lt;ArgumentError: missing keyword: length&gt;</span></span></code> </pre> <br>  As you can see from the example above, in some situations, named arguments are needed to eliminate ambiguity, but for them it is impossible to find a suitable default value.  Now you do not need to choose. <br><br><h5>  String # freeze method optimization </h5><br>  Since  Ruby strings are mutable, each string literal is a new object each time it is executed: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">env</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">development</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment"># returns new String object on each call env.object_id #=&gt; 70329318373020 env.object_id #=&gt; 70329318372900</span></span></span></span></code> </pre><br>  It can be very wasteful - first create a certain number of objects, and then delete them by the garbage collector.  To avoid this, you can directly call the #freeze method, which means that the search for the string will take place in the table of "frozen" rows, and the same object will be used every time: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">env</span></span></span><span class="hljs-function"> "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">development</span></span></span><span class="hljs-function">".</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">freeze</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment"># returns the same String object on each call env.object_id #=&gt; 70365553080120 env.object_id #=&gt; 70365553080120</span></span></span></span></code> </pre><br>  String literals that are hash keys will also be processed without the need to call #freeze. <br><br><pre> <code class="ruby hljs">a = {<span class="hljs-string"><span class="hljs-string">"name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Arthur"</span></span>} b = {<span class="hljs-string"><span class="hljs-string">"name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"Ford"</span></span>} <span class="hljs-comment"><span class="hljs-comment"># same String object used as key in both hashes a.keys.first.object_id #=&gt; 70253124073040 b.keys.first.object_id #=&gt; 70253124073040</span></span></code> </pre><br>  In the process of developing 2.1, this feature was originally a change in the syntax, where ‚Äústring‚Äù f meant a ‚Äúfrozen‚Äù string.  However, it was decided to move from such a change to calling the #freeze method, which does not break forward and backward compatibility, plus many people dislike the unnecessary changes in the syntax. <br><br><h5>  def returns the method name as a Symbol object. </h5><br>  The result of the method declaration is now not nil, but the Symbol object corresponding to the method name.  A canonical example of using this is declaring only one method private. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Client</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">host</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">port</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end private def do_request(method, path, body, **headers) # ... end def get(path, **headers) do_request(:get, path, nil, **headers) end end</span></span></span></span></code> </pre><br>  It can also be used to add decorators to methods, the following is an example of using <a href="http://globaldev.co.uk/2013/03/ruby-2-0-0-in-detail/">Module # prepend</a> to wrap a method in before / after callbacks: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Around</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">around</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prepend</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Module</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">define_method</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">method</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |*</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">args</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">send</span></span></span><span class="hljs-class">(:"</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">before_</span></span></span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{method}") if respond_to?(:"before_#{method}", true) result = super(*args, &amp;block) send(:"after_#{method}") if respond_to?(:"after_#{method}", true) result end end) method end end class Example extend Around around def call puts "call" end def before_call puts "before" end def after_call puts "after" end end Example.new.call</span></span></span></span></code> </pre><br>  will lead <br><br><pre> <code class="ruby hljs">before call after</code> </pre><br>  The define_method and define_singleton_method methods have also been changed and now return Symbol objects instead of their proc arguments. <br><br><h5>  Literals for rational and complex numbers </h5><br>  Ruby has literals for the classes Integer (1) and Float (1.0), now they have added literals for the classes Rational (1r) and Complex (1i). <br><br>  They work well with the casting mechanism for mathematical operations in Ruby, so 1/3 can be written in Ruby as 1 / 3r.  3i represents a complex number 0 + 3i, which means that complex numbers can be written in standard mathematical notation, 2 + 3i in Ruby represents a complex number 2 + 3i! <br><br><h5>  Array / Enumerable #to_h </h5><br>  The set of classes that received the <a href="http://globaldev.co.uk/2013/03/ruby-2-0-0-in-detail/">#to_h</a> method in Ruby 2.0.0 has now been expanded with the Array class and any other class that includes Enumerable. <br><br><pre> <code class="ruby hljs">[[<span class="hljs-symbol"><span class="hljs-symbol">:id</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>], [<span class="hljs-symbol"><span class="hljs-symbol">:name</span></span>, <span class="hljs-string"><span class="hljs-string">"Arthur"</span></span>]].to_h <span class="hljs-comment"><span class="hljs-comment">#=&gt; {:id=&gt;42, :name=&gt;"Arthur"} require "set" Set[[:id, 42], [:name, "Arthur"]].to_h #=&gt; {:id=&gt;42, :name=&gt;"Arthur"}</span></span></code> </pre><br>  This can be useful when using Hash methods that return an Array: <br><br><pre> <code class="ruby hljs">headers = {<span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>} headers.map {<span class="hljs-params"><span class="hljs-params">|k, v|</span></span> [k.downcase, v]}.to_h <span class="hljs-comment"><span class="hljs-comment">#=&gt; {"content-length" =&gt; 42, "content-type" =&gt; "text/html"}</span></span></code> </pre><br><br><h5>  Split method caching </h5><br>  Prior to version 2.1, Ruby used the global method cache, which was disabled for all classes when adding a new method, connecting a module, including a module in an object, etc.  anywhere in your code.  This made some classes (such as OpenStruct) and some tricks (such as <a href="http://globaldev.co.uk/2013/09/ruby-tips-part-3/">exception tagging</a> ) useless due to performance considerations. <br><br>  Now this is not a problem, Ruby 2.1 uses method caching based on a class hierarchy, invalidating the cache only for a given class and its subclasses. <br><br>  A method has been added to the RubyVM class that returns some debug information for the method cache: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RubyVM</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stat</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#=&gt; {:global_method_state=&gt;133, :global_constant_state=&gt;820, :class_serial=&gt;5689} # setting constant increments :global_constant_state Foo::Bar = "bar" RubyVM.stat(:global_constant_state) #=&gt; 821 # defining instance method increments :class_serial class Foo def foo end end RubyVM.stat(:class_serial) #=&gt; 5690 # defining global method increments :global_method_state def foo end RubyVM.stat(:global_method_state) #=&gt; 134</span></span></span></span></code> </pre><br><br><h5>  Exceptions </h5><br>  Exception objects now have a #cause method that returns the exception that raised the given.  It is set automatically when you catch one exception and excite another. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"socket"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyProject</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Error</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardError</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotFoundError</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Error</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConnectionError</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Error</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do_get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NotFoundError</span></span></span><span class="hljs-class">, "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{path} not found" if response.code == "404" response.body rescue Errno::ECONNREFUSED, SocketError =&gt; e raise ConnectionError end end begin MyProject.get("/example") rescue MyProject::Error =&gt; e e #=&gt; #&lt;MyProject::ConnectionError: MyProject::ConnectionError&gt; e.cause #=&gt; #&lt;Errno::ECONNREFUSED: Connection refused - connect(2) for "example.com" port 80&gt; end</span></span></span></span></code> </pre><br>  At the moment, the first exception is not displayed anywhere and rescue does not pay attention to the cause of the occurrence, but the presence of the #cause method can significantly help with debugging. <br><br>  Exceptions also have a #backtrace_locations method, which <a href="http://globaldev.co.uk/2013/03/ruby-2-0-0-in-detail/">for some reason is not available in 2.0.0</a> .  It returns Thread :: Backtrace :: Location objects instead of strings, which gives easier access to backtrace details. <br><br><h5>  Generation Garbage Collector </h5><br>  Ruby 2.1 introduces generation-based garbage collection, which divides all objects into younger and older generations.  At normal start-up, the GC will view only the objects of the younger generation, while the objects of the older generation will be viewed much less frequently.  Removal of objects (sweeping) is done in the same way as in 1.9.3 (lazy sweep).  If an object from the younger generation ‚Äúsurvives‚Äù when the GC starts, it goes into the older generation. <br><br>  If you have older objects that refer to objects of the younger generation, while processing only the younger generation, GC can mistakenly find that there are no references to this object and delete it.  To prevent this, record barriers were introduced that add objects of the older generation to a special memorized set (remember set) when they begin to refer to objects of the younger generation (for example, old_array.push (young_string)).  This set is then taken into account when marking (marking) the younger generation. <br><br>  Most generational garbage collectors need such barriers for all objects, but for many third-party C extensions for Ruby this is not possible.  Therefore, as a temporary solution, it was introduced that objects for which barriers are not created (so-called ‚Äúshadow‚Äù objects) never fall into the older generation.  This solution is not ideal in terms of full use of all the features of the generational garbage collector, but it provides maximum backward compatibility. <br><br>  Now the labeling phase is much faster, but the presence of recording barriers means additional overhead, so the differences in performance directly depend on what your code does. <br><br><h5>  Class GC </h5><br>  The GC.start method can receive two new parameters, full_mark and immediate_sweep.  Both are by default true. <br>  If full_mark is set to true, the marking phase passes for both generations, if false, then only for the younger.  If immediate_sweep is set to true, complete immediate removal of objects (stop the world) will be performed; if false, a lazy sweep will be performed, only when necessary and removing the required minimum of objects. <br><br><pre> <code class="ruby hljs">GC.start <span class="hljs-comment"><span class="hljs-comment"># trigger a full GC run GC.start(full_mark: false) # only collect young generation GC.start(immediate_sweep: false) # mark only GC.start(full_mark: false, immediate_sweep: false) # minor GC</span></span></code> </pre><br>  The debug option GC.stress can now be set as an integer flag, specifying which part of the collector should be enhanced. <br><br><pre> <code class="ruby hljs">GC.stress = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-comment"><span class="hljs-comment"># full GC at every opportunity GC.stress = 1 # minor marking at every opportunity GC.stress = 2 # lazy sweep at every opportunity</span></span></code> </pre><br>  GC.stat now displays more details, and can also receive a parameter as an input and return a value only for this key, instead of displaying the entire hash of values. <br><br><pre> <code class="ruby hljs">GC.stat <span class="hljs-comment"><span class="hljs-comment">#=&gt; {:count=&gt;6, ... } GC.stat(:major_gc_count) #=&gt; 2 GC.stat(:minor_gc_count) #=&gt; 4</span></span></code> </pre><br>  Also, the latest_gc_info method appeared, which returns information about the last launch of the garbage collector. <br><br><pre> <code class="ruby hljs">GC.latest_gc_info <span class="hljs-comment"><span class="hljs-comment">#=&gt; {:major_by=&gt;:oldgen, :gc_by=&gt;:newobj, :have_finalizer=&gt;false, :immediate_sweep=&gt;false}</span></span></code> </pre><br><br><h5>  GC - setting environment variables </h5><br>  Many new environment variables have been introduced that are taken into account when Ruby's garbage collector is running. <br><br><h6>  RUBY_GC_HEAP_INIT_SLOTS </h6>  This option was previously available as RUBY_HEAP_MIN_SLOTS.  It sets the initial location of the slots and is set to 10000 by default. <br><br><h6>  RUBY_GC_HEAP_FREE_SLOTS </h6>  This option was also previously available as RUBY_FREE_MIN.  It sets the minimum number of slots that should be available after running the GC.  If the GC does not free enough slots, new ones will be allocated. The default is 4096. <br><br><h6>  RUBY_GC_HEAP_GROWTH_FACTOR </h6>  Sets the ratio by which the number of allocated slots will grow.  (next slots number) = (current slots number) * (this factor).  The default is 1.8. <br><br><h6>  RUBY_GC_HEAP_GROWTH_MAX_SLOTS </h6>  The maximum number of slots allocated at one time.  The default is 0, which means that the maximum is not set. <br><br><h6>  RUBY_GC_MALLOC_LIMIT </h6>  This option is not new, but deserves a mention.  It sets the amount of memory that can be allocated without recourse to garbage collection. The default is 16 * 1024 * 1024 (16MB). <br><br><h6>  RUBY_GC_MALLOC_LIMIT_GROWTH_FACTOR </h6>  The magnification factor is malloc_limit, the default is 1.4. <br><br><h6>  RUBY_GC_MALLOC_LIMIT_MAX </h6>  The maximum that malloc_limit can reach.  The default is 32 * 1024 * 1024 (32MB). <br><br><h6>  RUBY_GC_OLDMALLOC_LIMIT </h6>  The amount that the older generation can reach before calling full garbage collection.  The default is 16 * 1024 * 1024 (16MB). <br><br><h6>  RUBY_GC_OLDMALLOC_LIMIT_GROWTH_FACTOR </h6>  Increase factor old_malloc_limit.  The default is 1.2. <br><br><h6>  RUBY_GC_OLDMALLOC_LIMIT_MAX </h6>  The maximum that old_malloc_limit can reach.  The default is 128 * 1024 * 1024 (128MB). <br><br><h5>  ObjectSpace class for tracking memory leaks </h5><br>  Ruby 2.1 adds several tools for keeping track of situations where we leave links to old / large objects, thus preventing them from being accessed by the garbage collector. <br><br>  Now we have a set of methods for determining the placement of an object: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"objspace"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Example</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first_name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_name</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first_name</span></span></span><span class="hljs-class">, @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_name</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first_name</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last_name</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@first</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_name} #{</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_name}" end end end ObjectSpace.trace_object_allocations do obj = Example::User.new("Arthur", "Dent").name ObjectSpace.allocation_sourcefile(obj) #=&gt; "example.rb" ObjectSpace.allocation_sourceline(obj) #=&gt; 10 ObjectSpace.allocation_class_path(obj) #=&gt; "Example::User" ObjectSpace.allocation_method_id(obj) #=&gt; :name ObjectSpace.allocation_generation(obj) #=&gt; 6 end</span></span></span></span></code> </pre><br>  The number returned by the allocation_generation method is the number of garbage collections that passed at the time the object was created.  Thus, if this number is small, the object was created at the time when the application started. <br><br>  There are also trace_object_allocations_start and trace_object_allocations_stop methods as an alternative to using trace_object_allocations with block transmission, and the trace_object_allocations_clear method to reset the recorded location data of objects. <br><br>  In addition, you can output this and not only information to a file or string in JSON format for further analysis or visualization. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"objspace"</span></span> ObjectSpace.trace_object_allocations <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> puts ObjectSpace.dump([<span class="hljs-string"><span class="hljs-string">"foo"</span></span>].freeze) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  will lead <br><pre> <code class="ruby hljs">{ <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"0x007fd122123f40"</span></span>, <span class="hljs-string"><span class="hljs-string">"class"</span></span>: <span class="hljs-string"><span class="hljs-string">"0x007fd121072098"</span></span>, <span class="hljs-string"><span class="hljs-string">"embedded"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"file"</span></span>: <span class="hljs-string"><span class="hljs-string">"example.rb"</span></span>, <span class="hljs-string"><span class="hljs-string">"flags"</span></span>: { <span class="hljs-string"><span class="hljs-string">"wb_protected"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }, <span class="hljs-string"><span class="hljs-string">"frozen"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"generation"</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-string"><span class="hljs-string">"length"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"line"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"references"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"0x007fd122123f68"</span></span> ], <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"ARRAY"</span></span> }</code> </pre><br>  It is also possible to use the ObjectSpace.dump_all method to get information about all the memory on the heap. <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"objspace"</span></span> ObjectSpace.trace_object_allocations_start <span class="hljs-comment"><span class="hljs-comment"># do things ... ObjectSpace.dump_all(output: File.open("heap.json", "w"))</span></span></code> </pre><br>  Both of these methods can be used without activating object allocation tracing, but less information will be obtained. <br><br>  Finally, there is the ObjectSpace.reachable_objects_from_root method, which is similar to the ObjectSpace.reachable_objects_from method, but it takes no arguments and works from the application root.  This method has one feature - it returns a hash, which, when accessing by keys, compares them for identity, so for access you need not just the same lines, but exactly the same objects with the same object_id as in the hash itself.  Fortunately, you can get around this: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">"objspace"</span></span> reachable = ObjectSpace.reachable_objects_from_root reachable = {}.merge(reachable) <span class="hljs-comment"><span class="hljs-comment"># workaround compare_by_identity reachable["symbols"] #=&gt; ["freeze", "inspect", "intern", ...</span></span></code> </pre><br>  <i>The first part of this is completed, the next will be in a couple of days, it will be refinements, new rubygems, changes in lambdas and much more.</i> <i><br></i> <br>  <a href="http://habrahabr.ru/post/223209/">The second part</a> <a href="http://habrahabr.ru/post/223521/">The third part</a> </div><p>Source: <a href="https://habr.com/ru/post/222941/">https://habr.com/ru/post/222941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222925/index.html">DIY: Universal Ambilight for home multimedia system - Atmosvet</a></li>
<li><a href="../222931/index.html">How to poison a cat? Detective story with a happy ending</a></li>
<li><a href="../222933/index.html">Poll - Open data of the Ministry of Finance</a></li>
<li><a href="../222935/index.html">Create music from anything</a></li>
<li><a href="../222939/index.html">From Imagine Cup to a startup</a></li>
<li><a href="../222943/index.html">Caesar III Reverse Engineering (Part 2, Drawing the City)</a></li>
<li><a href="../222945/index.html">As we developed "Spetskor" - a super-custom mobile application for civilian reporters</a></li>
<li><a href="../222947/index.html">Update on the popularity of CMS-systems, analytics systems and online consultants in RuNet for the 2nd quarter</a></li>
<li><a href="../222951/index.html">Joint experiment of Yandex.Mail and Nginx teams: does SPDY really speed up the Internet?</a></li>
<li><a href="../222953/index.html">Experience one engineering investigation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>