<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Again about empty transfers in C #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This post was inspired by a recent article on Habr√© referring to an already long-standing problem (and the advising article ) about how to check that ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Again about empty transfers in C #</h1><div class="post__text post__text-html js-mediator-article">  This post was inspired by a recent <a href="https://habrahabr.ru/post/349852/">article on Habr√©</a> referring to an already long-standing problem (and the <a href="https://habrahabr.ru/post/97464/">advising article</a> ) about how to check that <b>IEnumerable</b> is empty.  However, in the original articles, the authors focused more on how to issue a check, assuming that the checks are: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsNullOrEmpty&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IEnumerable&lt;T&gt; items) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> items == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !items.Any(); }</code> </pre> <br>  will be enough, but in my opinion, this approach is not always applicable. <br><a name="habracut"></a><br>  The fact is that <b>IEnumerable</b> is, in fact, a factory for <b>IIterator</b> , but from the point of view of the calling code, the cost of creating an iterator is completely unpredictable.  The situation is complicated by the fact that in C # for lists, and for arrays, and for <b>IEnumerable,</b> you can use the same <b>foreach</b> operator and the same LINQ methods that hide the creation of <b>IIterator</b> and make in the minds of many developers indistinguishable lists, arrays, and <b>IEnumerable</b> .  However, the difference can be enormous - when calling the <b>items.Any ()</b> innocuous code, <b>there</b> can be various demanding operations such as creating a connection and querying the database, calling REST Api, or just a lot of heavy calculations: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetItemsDb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(<span class="hljs-string"><span class="hljs-string">"connection string"</span></span>)) { connection.Open(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlCommand(<span class="hljs-string"><span class="hljs-string">"SELECT Id FROM Table"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (SqlDataReader reader = command.ExecuteReader()) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (reader.Read()) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> reader.GetInt32(<span class="hljs-number"><span class="hljs-number">0</span></span>); } } } } }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetItemsLinq</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enumerable .Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) .Reverse() .Select( i =&gt; { Thread.Sleep(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i; }) .Where(i =&gt; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>); }</code> </pre> <br>  But what to do in case you need to know if a similar iterator will return some elements or not?  For example, we need to write code that summarizes all the elements returned by <b>GetItemsLinq ()</b> , but if there are no elements, then the code should return <b>null</b> : 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? result = GetSum(GetItemsLinq()); ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? GetSum(IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; items) { ... }</code> </pre> <br>  I think that many would implement the GetSum method as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? GetSum(IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; items) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> items != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; items.Any() ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>?)items.Sum() : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br>  and ... faced with situations that <b>GetSum (GetItemsLinq ())</b> runs for 19.1 seconds instead of the expected ten.  The fact is that for <b>items.Any ()</b> it is necessary to sort through 91 original elements in order to understand that there is something at the output, and we spend 100 milliseconds for each element.  Let's try to slightly optimize the <b>GetSum</b> method: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? GetSumm(IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; items) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> list = items <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IReadOnlyCollection&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ?? items?.ToList(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; list.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>?)list.Sum() : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br>  Now the code is executed in the expected 10 seconds, but at the cost of allocating an intermediate buffer in memory.  And if the items will be much more than 10?  In general, you can still optimize: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? GetSum(IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; items) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (items == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enumerator = items.GetEnumerator()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enumerator.MoveNext()) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = enumerator.Current; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (enumerator.MoveNext()) { result += enumerator.Current; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre><br>  Now the code is executed in 10 seconds and does not consume extra memory, but ... I would not like to write such code every time I need to check for the presence of elements in <b>IEnumerable</b> .  Is it possible to reuse this code?  My suggestion is to create an extension method that would take as an argument the function to which we will pass the obviously non-empty <b>IEnumerable</b> .  This function is supposed to return the result of processing this <b>IEnumerable</b> .  ‚ÄúObviously non-empty IEnumerable‚Äù is a wrapper over an already open iterator which, when the first element is requested, returns the first element already received and then continues the enumeration: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EnumerableHelper</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> TRes ProcessIfNotEmpty&lt;T, TRes&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IEnumerable&lt;T&gt; source, Func&lt;IEnumerable&lt;T&gt;, TRes&gt; handler, Func&lt;TRes&gt; defaultValue) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (source) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultValue(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> IReadOnlyCollection&lt;T&gt; collection: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collection.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? handler(collection) : defaultValue(); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> enumerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DisposeGuardWrapper&lt;T&gt;(source.GetEnumerator())) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enumerator.MoveNext()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handler(Continue(enumerator.Current, enumerator)); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultValue(); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IEnumerable&lt;T&gt; Continue&lt;T&gt;(T first, IEnumerator&lt;T&gt; startedEnumerator) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> first; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (startedEnumerator.MoveNext()) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> startedEnumerator.Current; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DisposeGuardWrapper</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IEnumerator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { ... } }</code> </pre><br>  <i><a href="https://github.com/0x1000000/ProcessIfNotEmpty">Full source code here</a></i> <br><br>  Using this auxiliary method, we can solve our problem as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? result = GetItemsLinq().ProcessIfNotEmpty(items=&gt; items.Sum(), () =&gt; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>?)<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br>  Unfortunately, this approach has one major drawback, we cannot take work with <b>items</b> beyond <b>ProcessIfNotEmpty</b> , since the iterator created to check for the presence of items will not be properly closed.  To prevent such <b>incidents, the DisposeGuardWrapper</b> class has been <b>created</b> and the following code will throw an exception: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? result = GetItemsLinq().ProcessIfNotEmpty(items=&gt; items, () =&gt; <span class="hljs-literal"><span class="hljs-literal">null</span></span>).Sum();</code> </pre> <br>  It‚Äôs unpleasant of course, but in my opinion, it‚Äôs better than spending extra resources or writing template code every time.  Maybe someone will offer the best option. </div><p>Source: <a href="https://habr.com/ru/post/349920/">https://habr.com/ru/post/349920/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349910/index.html">Three aspects of optimization (DB and software)</a></li>
<li><a href="../349912/index.html">Ruby on Rails ActionCable + Vue.js v2 for example chat</a></li>
<li><a href="../349914/index.html">Measuring the speed of Java code correctly (using JMH)</a></li>
<li><a href="../349916/index.html">The Dream Machine: The history of the computer revolution. Prologue</a></li>
<li><a href="../349918/index.html">Sound in ReactJS</a></li>
<li><a href="../349922/index.html">You are only 25 and you already have four companies behind you - what's wrong with you?</a></li>
<li><a href="../349924/index.html">Zombies that eat up your memory</a></li>
<li><a href="../349926/index.html">PHP Digest 126 (February 12 - 25, 2018)</a></li>
<li><a href="../349928/index.html">Product Design Digest February 2018</a></li>
<li><a href="../349930/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ303 (February 19 - 25, 2018)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>