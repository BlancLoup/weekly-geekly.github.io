<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Lost group. We find out the appointment of "strange" groups in AD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good time of day, habrahdrazhdane! 

 I hasten to share with you one of my gizmos, which were designed to facilitate my work, as a system administrato...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Lost group. We find out the appointment of "strange" groups in AD</h1><div class="post__text post__text-html js-mediator-article">  Good time of day, habrahdrazhdane! <br><br>  I hasten to share with you one of my gizmos, which were designed to facilitate my work, as a system administrator who understands the inherited trash in Active Directory. <br>  In my opinion, the most problematic of the inherited good are groups.  About them will be discussed in this article. <br>  Namely: we go into Active Directory, we plow the spaces of divisions and see groups, completely with faceless names (for example, Ugin, Vassa, Opel, www etc) and without a description.  Attention question: determine why these groups are needed. <br><a name="habracut"></a><habracut><br><h3>  What we get by inheritance </h3><br>  So, we see a group, scratching the head.  In a group of users from different departments.  No sign on common washed away.  Perhaps by the name of the group we can vaguely be able to determine (or guess) what it is for.  It will be plus to the one who has left all this to you.  What are we going to do? <br><br>  I also had my job, as soon as I started a domain, I found a car and a small truck of such groups.  And although all the people who were in charge of them before me remained in place, no one could give me an intelligent answer.  If earlier it was possible to close our eyes to this, there were many other things, now there is a need to restore order. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What is the meaning of group life?  As a rule, this is either access to resources in shared folders, or a filter for applying group policies (I do not take into account system groups like Domain Admins etc.) <br>  So the task for us is set: we need to check the Access Control List (ACL) of folders in shared resources and in group policies. <br><br><h3>  Hello mr.  Posh </h3><br>  Here our Swiss knife comes into the arena, with which we will open the ACL of folders and policies. <br>  Since politicians are easier, let's start with them. <br><br><h4>  Group Policies </h4><br>  To work with group policies will help us the module grouppolicy.  From this module we use two cmdlets: <br>  1. get-gpo, which sends us a list of all group policies in the domain <br>  2. get-gppermissions, which allows us to view ACL policies. <br>  Then, we simply look for a match between the name of our group and the entry in the ACL, and if there are any, we display information about this policy: <br><pre><code class="hljs bash"><span class="hljs-variable"><span class="hljs-variable">$name</span></span>=<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>-host <span class="hljs-string"><span class="hljs-string">"      "</span></span> Write-Host -Fore RED <span class="hljs-string"><span class="hljs-string">"   ..."</span></span> <span class="hljs-variable"><span class="hljs-variable">$gpos</span></span>=get-gpo -all Foreach (<span class="hljs-variable"><span class="hljs-variable">$gpo</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$gpos</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$ACls</span></span>=get-gppermissions -Name <span class="hljs-variable"><span class="hljs-variable">$gpo</span></span>.DisplayName -all Foreach (<span class="hljs-variable"><span class="hljs-variable">$acl</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$ACls</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$acl</span></span>.Trustee.Name -match <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$name</span></span></span><span class="hljs-string">"</span></span>) { Write-Host -Fore GREEN <span class="hljs-string"><span class="hljs-string">" !"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$gpo</span></span> If (<span class="hljs-variable"><span class="hljs-variable">$acl</span></span>.Permission -eq <span class="hljs-string"><span class="hljs-string">"GpoApply"</span></span>) {<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$acl</span></span>.Denied) {Write-Host -Fore RED <span class="hljs-string"><span class="hljs-string">"  "</span></span>}} } } }</code> </pre> <br>  I also want to note the Permission and Denied properties in the ACL. <br>  1. Permission - it contains permissions for an object, for example, applying a policy (GpoApply), reading a policy (GpoRead), changing a policy (GpoEdit), or generally all at once (GpoEditDeleteModifySecurity). <br>  2. Denied shows us what is allowed or denied what is displayed in Permission. <br>  If you look at a piece of the script, you can see that if the application of the policy (Permission -eq "GpoApply") is denied (Denied -eq $ true) in the ACL group, a notification will be displayed.  In principle, it was possible to paint notifications for all cases, but I am only interested in the ban on the dissemination of policies. <br>  PS The variable $ name, in which the name of our group is located, will be used in the following pieces of code. <br><br><h4>  Shared folders </h4><br>  Now we will deal with shared folders.  There are two options: <br>  1. When permission is given directly to the shared resource. <br>  2. When permission is given to the folder hidden in the depths of the shared resource. <br>  Come again in order. <br><br><h5>  Looking for on the surface </h5><br>  The easiest and most understandable way is to give permissions to shared folders.  So it‚Äôs better that you have all the permissions in one place, and you shouldn‚Äôt confuse your heirs when they get to 4 layers of folders and find one folder with photos of your birthday where only your friend from Accounting was allowed to enter.  She loses the label, guess what kind of folder she needed?  But we will return to it later. <br>  And now we need to check the ACL on shared folders on our file server (here it is called FileServer ... (yes, I am original)).  For this, we use everyone's favorite WMI.  I note that I immediately discard the folders that are not displayed when you simply log into our server.  What for?  Ordinary users will not get there, well, unusual, you can ask (if necessary, you can remove): <br><pre> <code class="hljs bash">Write-Host -Fore RED <span class="hljs-string"><span class="hljs-string">"   \\FileServer"</span></span> <span class="hljs-variable"><span class="hljs-variable">$dirs</span></span>=get-wmiobject win32_Share -computername FileServer | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span>-object {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.Name -notmatch <span class="hljs-string"><span class="hljs-string">"\$"</span></span>} Foreach (<span class="hljs-variable"><span class="hljs-variable">$dir</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$dirs</span></span>) { Trap [System.UnauthorizedAccessException] {<span class="hljs-string"><span class="hljs-string">"     </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$share</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">continue</span></span>;} <span class="hljs-variable"><span class="hljs-variable">$out</span></span>=<span class="hljs-variable"><span class="hljs-variable">$null</span></span> <span class="hljs-variable"><span class="hljs-variable">$share</span></span>=<span class="hljs-variable"><span class="hljs-variable">$dir</span></span>.Path <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$share</span></span> -match <span class="hljs-string"><span class="hljs-string">"^D:"</span></span>) {<span class="hljs-variable"><span class="hljs-variable">$share</span></span> = <span class="hljs-variable"><span class="hljs-variable">$share</span></span>.ToUpper().Replace(<span class="hljs-string"><span class="hljs-string">'D:'</span></span>,<span class="hljs-string"><span class="hljs-string">'\\FileServer\d$'</span></span>)} elseif (<span class="hljs-variable"><span class="hljs-variable">$share</span></span> -match <span class="hljs-string"><span class="hljs-string">"^C:"</span></span>) {<span class="hljs-variable"><span class="hljs-variable">$share</span></span> = <span class="hljs-variable"><span class="hljs-variable">$share</span></span>.ToUpper().Replace(<span class="hljs-string"><span class="hljs-string">'C:'</span></span>,<span class="hljs-string"><span class="hljs-string">'\\FileServer\c$'</span></span>)} <span class="hljs-variable"><span class="hljs-variable">$out</span></span>=(<span class="hljs-variable"><span class="hljs-variable">$share</span></span> | get-acl).Access | <span class="hljs-built_in"><span class="hljs-built_in">where</span></span>-object {<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.IdentityReference -match <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$name</span></span></span><span class="hljs-string">"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$out</span></span> -ne <span class="hljs-variable"><span class="hljs-variable">$null</span></span>) {Write-Host -Fore green <span class="hljs-string"><span class="hljs-string">" !"</span></span> <span class="hljs-variable"><span class="hljs-variable">$share</span></span>} }</code> </pre><br>  We also catch an error that tells us that access to certain folders is closed, and instead of red frightening errors we will get a simple message. <br>  Two lines in which we replace the 'D:' with '\\ FileServer \ d $' (and the same with the 'C' drive) are necessary, because  if this is not done, the cmdlet get-acl will try to search for these folders on our computer and most likely will not find it.  And he cannot search for the path \\ FileServer \ Folder (cmdlet get-acl).  In our example, only 2 disks, but adding more is not a problem. <br><br><h5>  We go down into the depths </h5><br>  We return to the familiar from the accounting.  Now we dig in the subfolders. <br>  I think many will say why to invent something when you can use get-childitem -recurse.  If you do not have a lot of folders on the server - yes, you can use recurse.  But if you have about 7 TB of file server, then the problems, in principle, either do not exist, you just have to wait a couple of hours, and everything will work.  And pray to God that you would not have an error in the middle of the search. <br>  So -recurse doesn't help us, then what?  Then we need to make a cycle that, according to our whim, will go deeper into the depths of the folders as much as we want (it sounds like it went).  Suppose we have a folder with subfolders for the departments (please forgive the tautology).  These folders are not shared.  In some of these folders are the folders we need, with cherished permissions. <br><pre> <code class="hljs perl">Write-Host -Fore RED <span class="hljs-string"><span class="hljs-string">"   \\FileServer\WorkFolders..."</span></span> $AllPath=@{} $sub=<span class="hljs-number"><span class="hljs-number">4</span></span> $path=dir \\FileServer\c$\WorkFolders | where-object {$_.PSIscontainer} $AllPath=$path $cnt=<span class="hljs-number"><span class="hljs-number">0</span></span> For ($o=<span class="hljs-number"><span class="hljs-number">1</span></span>; $o -<span class="hljs-keyword"><span class="hljs-keyword">lt</span></span> $Sub; $o++) { $PPath=$AllPath For ($i=$Cnt; $i -<span class="hljs-keyword"><span class="hljs-keyword">lt</span></span> $PPath.Count; $i++) { $a = dir $PPath[$i].FullName | where-object {$_.PSIscontainer} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($a -<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $null) {$AllPath = $AllPath + $a} } $cnt=$PPath.Count } Foreach ($WF in $AllPath) { Trap [System.UnauthorizedAccessException] {<span class="hljs-string"><span class="hljs-string">"    "</span></span> + $WF.FullName; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>;} $out=$null $out=(get-acl $WF.FullName).Access | where-object {$_.IdentityReference -match <span class="hljs-string"><span class="hljs-string">"$name"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($out -<span class="hljs-keyword"><span class="hljs-keyword">ne</span></span> $null) {Write-Host -Fore GREEN <span class="hljs-string"><span class="hljs-string">" !"</span></span>; $WF.FullName} }</code> </pre><br>  You may notice that we only need folders, so we filter the output using the PSIscontainer property. <br>  The $ sub variable sets the search depth.  The $ AllPath variable stores the paths to all the folders we found.  Well and further, already familiar to us gestures, check the ACL of the found folders for the presence of our group in them. <br><br><h4>  Eventually </h4><br>  Thus, it is possible to find in almost any subsoil of permission for a certain group.  Naturally, you can use it not only to search for groups, but also to search for users and computers (fortunately, I rarely come across this). <br>  Whether to make one script, one or several functions out of all this is up to you. <br><br>  In conclusion, I would like to say a few touching words: comrades, colleagues, let's not complicate each other‚Äôs life in a new place of work.  There is nothing difficult in the description of the group to write about its purpose.  And there is nothing difficult to create this group and not to hang up account permissions.  If we all do this, then soon there will be no need to write such articles. </habracut></div><p>Source: <a href="https://habr.com/ru/post/138600/">https://habr.com/ru/post/138600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../138592/index.html">Compiling header files or documentation for free</a></li>
<li><a href="../138593/index.html">Semi-Prezi in 10 minutes in .NET and WPF</a></li>
<li><a href="../138594/index.html">Closures and full object copying</a></li>
<li><a href="../138597/index.html">Site "Big White Circle" closed</a></li>
<li><a href="../138598/index.html">ABBYY Linguistic Technologies. From complicated to perfect</a></li>
<li><a href="../138601/index.html">Recovering locally downloaded letters in the mailbox on the server. IMAP</a></li>
<li><a href="../138603/index.html">Analytics and accounting of phone calls</a></li>
<li><a href="../138604/index.html">Skydrive in windows 8</a></li>
<li><a href="../138605/index.html">Hacked firmware lumix GH1, GH2, G2, GF1, GF2</a></li>
<li><a href="../138607/index.html">Machine time perception if nanoseconds were seconds</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>