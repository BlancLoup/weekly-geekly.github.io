<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of setting up and launching PVS-Studio in Docker using the example of Azure Service Fabric code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Containerization technologies are widely used for building and testing software. With the advent of PVS-Studio for Linux, users have the opportunity t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of setting up and launching PVS-Studio in Docker using the example of Azure Service Fabric code</h1><div class="post__text post__text-html js-mediator-article"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e0/db8/1f4/0e0db81f42b5cdd8fd84de22a7f755ea.png"></div><br>  Containerization technologies are widely used for building and testing software.  With the advent of PVS-Studio for Linux, users have the opportunity to add static analysis to other methods of testing their project on this platform, including in Docker.  The article will describe the features of working with the PVS-Studio analyzer in Docker, which will improve the analysis quality and usability.  And also will be given the errors found in the project Azure Service Fabric. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Docker is a program that allows the operating system to run processes in an isolated environment based on specially crafted images.  Containerization technology has become very common for many tasks, including software development and testing.  Static analysis is usually performed in the same environment as the project build, so its use in Docker is very easy to implement in already existing containers. <br><br>  Examples of integrating and running the <a href="https://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static analyzer will be given for the Linux version.  But the described analyzer setting options are possible and even recommended on any platform.  The version of the analyzer for <a href="https://www.viva64.com/ru/b/0566/">macOS</a> , which was recently presented to the public, is generally identical in use of PVS-Studio for Linux. <br><br>  The project for the integration and launch of the analyzer in Docker selected Azure Service Fabric.  <a href="https://github.com/Microsoft/service-fabric">Service Fabric</a> is a platform for distributed systems designed to deploy and manage scalable and highly reliable distributed applications.  Service Fabric runs on Windows and Linux, in any cloud, in any data center, in any region, and even on a laptop. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Phased implementation of the analyzer </h2><br>  First, let's take a look at how the project is built to choose how to integrate the analyzer.  The order of invoking scripts and commands is as follows: <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f68/4df/6a9/f684df6a923229ed7ad4568de627391c.png"></div><br>  Below is a fragment of the <i>build.sh</i> script where the project file is generated: <br><br><pre><code class="bash hljs">cmake <span class="hljs-variable"><span class="hljs-variable">${CMakeGenerator}</span></span> \ -DCMAKE_C_COMPILER=<span class="hljs-variable"><span class="hljs-variable">${CC}</span></span> \ -DCMAKE_CXX_COMPILER=<span class="hljs-variable"><span class="hljs-variable">${CXX}</span></span> \ -DCMAKE_BUILD_TYPE=<span class="hljs-variable"><span class="hljs-variable">${BuildType}</span></span> \ -DBUILD_THIRD_PARTY=<span class="hljs-variable"><span class="hljs-variable">${BuildThirdPartyLib}</span></span> \ <span class="hljs-variable"><span class="hljs-variable">${DisablePrecompileFlag}</span></span> <span class="hljs-variable"><span class="hljs-variable">${ScriptPath}</span></span>/<span class="hljs-variable"><span class="hljs-variable">$DirName</span></span></code> </pre> <br>  To analyze the project, I decided to use the method from the documentation described in the <a href="https://www.viva64.com/ru/m/0036/">Quick Start / CMake project</a> section: <br><pre> <code class="diff hljs">diff --git a/src/build.sh b/src/build.sh index 290c57d..5901fd6 100755 --- a/src/build.sh +++ b/src/build.sh @@ -179,6 +179,7 @@ BuildDir() -DCMAKE_CXX_COMPILER=${CXX} \ -DCMAKE_BUILD_TYPE=${BuildType} \ -DBUILD_THIRD_PARTY=${BuildThirdPartyLib} \ + -DCMAKE_EXPORT_COMPILE_COMMANDS=On \ ${DisablePrecompileFlag} ${ScriptPath}/$DirName if [ $? != 0 ]; then let TotalErrors+=1</code> </pre> <br>  Add analyzer setup: <br><pre> <code class="diff hljs">diff --git a/src/build.sh b/src/build.sh index 290c57d..581cbaf 100755 --- a/src/build.sh +++ b/src/build.sh @@ -156,6 +156,10 @@ BuildDir() CXX=${ProjRoot}/deps/third-party/bin/clang/bin/clang++ fi + dpkg -i /src/pvs-studio-6.23.25754.2246-amd64.deb + apt -f install -y + pvs-studio --version +</code> </pre> <br>  The <i>src</i> directory is part of the project and is mounted on <i>/ src</i> .  I also marked out the <i>PVS-Studio.cfg</i> analyzer configuration file.  Then the analyzer can be called as follows: <br><br><pre> <code class="diff hljs">diff --git a/src/build.sh b/src/build.sh index 290c57d..2a286dc 100755 --- a/src/build.sh +++ b/src/build.sh @@ -193,6 +193,9 @@ BuildDir() cd ${ProjBinRoot}/build.${DirName} + pvs-studio-analyzer analyze --cfg /src/PVS-Studio.cfg \ + -o ./service-fabric-pvs.log -j4 + if [ "false" = ${SkipBuild} ]; then if (( $NumProc &lt;= 0 )); then NumProc=$(($(getconf _NPROCESSORS_ONLN)+0))</code> </pre> <br>  I did the launch of the analyzer before building the project.  This is not the right solution, but the script has a lot of conditions under which the project builds run, so I simplified my task a bit and compiled the project in advance.  Developers who know the structure of their project better should integrate the analyzer <b>after</b> building the project. <br><br>  Now you can collect and analyze the project with the following command: <br><br><pre> <code class="bash hljs">sudo ./runbuild.sh -release -j4</code> </pre> <br>  The first results of the analysis are frustrated with warnings for numerous macros, non-existent files, incorrect paths to source code files, etc.  In the next section I will talk about the contents of the <i>PVS-Studio.cfg file</i> , where I added several settings that significantly improved the analysis. <br><br><h2>  Additional analyzer setting </h2><br>  <b>Relative path to the source directory</b> <br><br>  To view a single report on different computers, the analyzer can generate a report with relative paths to the files.  You can restore them on another computer using a converter. <br><br>  Similar analyzer settings must be performed to extract a report from the container with the correct paths to the files.  The project root directory is mounted as root, so the analyzer parameter will look like this: <br><br><pre> <code class="cpp hljs">sourcetree-root=/</code> </pre> <br>  <b>Warnings for non-existent files</b> <br><br>  The container expands the <i>/ external</i> directory, which is not in the repository.  Most likely, some project dependencies are compiled in it and can be simply excluded from the analysis: <br><br><pre> <code class="cpp hljs">exclude-path=/external</code> </pre> <br>  <b>Warnings for compiler files, tests and libraries</b> <br><br>  In the Docker, the compiler can be placed in a non-standard location and its libraries can be included in the report.  They also need to be deleted.  To do this, the directory <i>/ deps</i> and the directory with tests are excluded from the check: <br><br><pre> <code class="cpp hljs">exclude-path=/deps exclude-path=/src/prod/test</code> </pre> <br>  <b>Fighting thousands of false positives caused by failed macros</b> <br><br>  The analyzer supports setting up various diagnostics using comments.  You can read about them <a href="https://www.viva64.com/ru/m/0017/">here</a> and <a href="https://www.viva64.com/ru/m/0040/">here</a> . <br><br>  Settings can be placed in the project code or put into a separate file, as I did: <br><br><pre> <code class="cpp hljs">rules-config=/src/service-fabric.pvsconfig</code> </pre> <br>  Contents of the service-fabric.pvsconfig file: <br><br><pre> <code class="cpp hljs">#V501 <span class="hljs-comment"><span class="hljs-comment">//-V:CODING_ERROR_ASSERT:501 //-V:TEST_CONFIG_ENTRY:501 //-V:VERIFY_IS_TRUE:501 //-V:VERIFY_ARE_EQUAL:501 //-V:VERIFY_IS_FALSE:501 //-V:INTERNAL_CONFIG_ENTRY:501 //-V:INTERNAL_CONFIG_GROUP:501 //-V:PUBLIC_CONFIG_ENTRY:501 //-V:PUBLIC_CONFIG_GROUP:501 //-V:DEPRECATED_CONFIG_ENTRY:501 //-V:TR_CONFIG_PROPERTIES:501 //-V:DEFINE_SECURITY_CONFIG_ADMIN:501 //-V:DEFINE_SECURITY_CONFIG_USER:501 //-V:RE_INTERNAL_CONFIG_PROPERTIES:501 //-V:RE_CONFIG_PROPERTIES:501 //-V:TR_INTERNAL_CONFIG_PROPERTIES:501 #V523 //-V:TEST_COMMIT_ASYNC:523 #V640 //-V:END_COM_INTERFACE_LIST:640</span></span></code> </pre> <br>  Several lines of special markup remove thousands of warnings on macros from the report. <br><br>  <b>Other settings</b> <br><br>  Path to the license file and inclusion of general-purpose diagnostics only (to speed up the analysis): <br><br><pre> <code class="cpp hljs">lic-file=/src/PVS-Studio.lic analysis-mode=<span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  <b>Entire PVS-Studio.cfg file</b> <br><pre> <code class="cpp hljs">lic-file=/src/PVS-Studio.lic rules-config=/src/service-fabric.pvsconfig exclude-path=/deps exclude-path=/external exclude-path=/src/prod/test analysis-mode=<span class="hljs-number"><span class="hljs-number">4</span></span> sourcetree-root=/</code> </pre> <br><h2>  May be needed in other projects. </h2><br>  Another way to check a project requires the system utility <a href="http://man7.org/linux/man-pages/man1/strace.1.html">strace</a> .  Most likely, it will be absent in the container and you need to add the installation step of this utility from the repository to the script. <br><br>  A compiler with a non-standard name, for example, a cross-compiler, can be put into the container.  I already wrote that the compiler directory should be excluded from the analysis, but in this case, in addition, you will have to pass the analyzer the name of the new compiler: <br><pre> <code class="bash hljs">pvs-studio-analyzer analyze ... --compiler COMPILER_NAME...</code> </pre> <br>  You can duplicate the checkbox to specify multiple compilers. <br><br><h2>  View a report in Linux or Windows </h2><br>  To view the analyzer report in Linux, you can add a report generation command to the script in the required format. <br><br>  For example, for viewing in QtCreator: <br><br><pre> <code class="bash hljs">plog-converter -t tasklist -r <span class="hljs-string"><span class="hljs-string">"~/Projects/service-fabric"</span></span> \ ./service-fabric-pvs.log -o ./service-fabric-pvs.tasks</code> </pre> <br>  Or in the browser: <br><br><pre> <code class="bash hljs">plog-converter -t fullhtml -r <span class="hljs-string"><span class="hljs-string">"~/Projects/service-fabric"</span></span> \ ./service-fabric-pvs.log -o ./</code> </pre> <br>  To view the report in Windows, you can simply open the <i>.log</i> file in the <a href="https://www.viva64.com/ru/m/0033/">Standalone</a> utility, which is included in the distribution for Windows. <br><br><h2>  Error Examples from Azure Service Fabric </h2><br><h3>  Classic typos </h3><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/20c/74e/236/20c74e236ae881129a676c78180650cc.png"></div><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> CWE-571 operator == 'operator: iter-&gt; PackageName == iter-&gt; PackageName DigestedApplicationDescription.cpp 247 <br><br><pre> <code class="cpp hljs">ErrorCode DigestedApplicationDescription::ComputeAffectedServiceTypes(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (iter-&gt;PackageName == iter-&gt;PackageName &amp;&amp; originalRG != <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;ResourceGovernanceDescriptions.end() &amp;&amp; targetRG != targetDescription.ResourceGovernanceDes....end()) { .... } .... }</code> </pre> <br>  The variable <i>iter-&gt; PackageName</i> should be compared with <i>iter2-&gt; PackageName</i> or <i>codePackages</i> . <br><br>  <a href="https://www.viva64.com/ru/w/v501/">V501</a> CWE-571 There are identical sub-expressions '(dataSizeInRecordIoBuffer&gt; 0)' the operator.  OverlayStream.cpp 4966 <br><br><pre> <code class="cpp hljs">VOID OverlayStream::AsyncMultiRecordReadContextOverlay::FSMContinue( __in NTSTATUS Status ) { ULONG dataSizeInRecordMetadata = <span class="hljs-number"><span class="hljs-number">0</span></span>; ULONG dataSizeInRecordIoBuffer = <span class="hljs-number"><span class="hljs-number">0</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((dataSizeInRecordIoBuffer &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) &amp;&amp; (dataSizeInRecordIoBuffer &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)) { .... } .... }</code> </pre> <br>  Because of Copy-Paste, the size of the <i>dataSizeInRecordMetadata</i> buffer is not checked. <br><br>  <a href="https://www.viva64.com/ru/w/v534/">V534</a> CWE-691 It is likely that a variable is being compared inside the 'for' operator.  Consider reviewing 'ix0'.  RvdLoggerVerifyTests.cpp 2395 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NTSTATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReportLogStateDifferences</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ULONG ix0=<span class="hljs-number"><span class="hljs-number">0</span></span>; ix0 &lt; RecoveredState._NumberOfStreams; ix0++) { <span class="hljs-function"><span class="hljs-function">KWString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">streamId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span></span>; ULONG ix1; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ix1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; ix0 &lt; LogState._NumberOfStreams; ix1++) { ... } .... } .... }</code> </pre> <br>  Probably, the variable <i>ix1</i> should be checked in the nested loop <i>condition</i> , and not <i>ix0</i> . <br><br>  <a href="https://www.viva64.com/ru/w/v570/">V570</a> The 'statusDetails_' variable is assigned to itself.  ComposeDeploymentStatusQueryResult.cpp 49 <br><br><pre> <code class="cpp hljs">ComposeDeploymentStatusQueryResult &amp; ComposeDeploymentStatusQueryResult::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> = ( ComposeDeploymentStatusQueryResult &amp;&amp; other) <span class="hljs-comment"><span class="hljs-comment">// &lt;= { if (this != &amp; other) { deploymentName_ = move(other.deploymentName_); applicationName_ = move(other.applicationName_); dockerComposeDeploymentStatus_ = move(other....); statusDetails_ = move(statusDetails_); // &lt;= } return *this; }</span></span></code> </pre> <br>  Most likely, <i>they</i> wanted to take the value of the <i>statusDetails_</i> field from <i>other.statusDetails_</i> , but made a typo. <br><br>  <a href="https://www.viva64.com/ru/w/v606/">V606</a> Ownerless token 'false'.  CryptoUtility.Linux.h 81 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TK, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TV&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MapCompare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;TK, TV&gt;&amp; lhs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">map</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;TK, TV&gt;&amp; rhs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lhs.size() != rhs.size()) { <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::equal(lhs.begin(), lhs.end(), rhs.begin()); }</code> </pre> <br>  The missing keyword <i>return</i> caused the code to become not optimal.  Because of a typo, a quick check on the size of the collections does not work as the author intended. <br><br>  <a href="https://www.viva64.com/ru/w/v607/">V607</a> CWE-482 Ownerless expression.  EnvironmentOverrideDescription.cpp 60 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EnvironmentOverridesDescription::<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> == (....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> equals = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; EnvironmentVariables.size(); i++) { equals = EnvironmentVariables[i] == other.EnvironmentVariables[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!equals) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> equals; } } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;CodePackageRef == other.CodePackageRef; <span class="hljs-comment"><span class="hljs-comment">// &lt;= if (!equals) { return equals; } return equals; }</span></span></code> </pre> <br>  A typo is similar to the previous example, but leads to a more serious error.  The result of one of the comparisons is never saved.  The correct code should be: <br><br><pre> <code class="cpp hljs">equals = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;CodePackageRef == other.CodePackageRef; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!equals) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> equals; }</code> </pre> <br><h3>  Incorrect use of functions </h3><br>  <a href="https://www.viva64.com/ru/w/v521/">V521</a> CWE-480 Such expressions using the ',' operator are dangerous.  Make sure the expression is correct.  ReplicatedStore.SecondaryPump.cpp 1231 <br><br><pre> <code class="cpp hljs">ErrorCode ReplicatedStore::SecondaryPump::ApplyOperationsWithRetry(....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorMessage.empty()) { errorMessage = <span class="hljs-string"><span class="hljs-string">L"error details missing: LSN={0}"</span></span>, operationLsn; Assert::TestAssert(<span class="hljs-string"><span class="hljs-string">"{0}"</span></span>, errorMessage); } .... }</code> </pre> <br>  The analyzer detected a strange code to form a message in the <i>errorMessage</i> variable.  Judging by the adjacent code fragments, it is necessary to write here: <br><br><pre> <code class="cpp hljs">WriteInfo(errorMessage, <span class="hljs-string"><span class="hljs-string">L"error ....: LSN={0}"</span></span>, operationLsn);</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-570 Expression 'nwrite &lt;0' is always false.  Unsigned type value is never &lt;0. File.cpp 1941 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ScpWorkerThreadStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* param)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> nwrite = fwrite(ptr, <span class="hljs-number"><span class="hljs-number">1</span></span>, remaining, destfile); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nwrite &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { pRequest-&gt;error_.Overwrite(ErrorCode::FromErrno(errno)); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { remaining -= nwrite; ptr += nwrite; pRequest-&gt;szCopied_ += nwrite; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (remaining != <span class="hljs-number"><span class="hljs-number">0</span></span>); .... }</code> </pre> <br>  Incorrect check of the return value of the <i>fwrite ()</i> function.  Documentation for this feature can be found at <a href="http://en.cppreference.com/w/cpp/io/c/fwrite">cppreference.com</a> and <a href="http://www.cplusplus.com/reference/cstdio/fwrite/">cplusplus.com</a> . <br><br>  <a href="https://www.viva64.com/ru/w/v547/">V547</a> CWE-571 Expression 'len&gt; = 0' is always true.  Unsigned type value is always&gt; = 0. Types.cpp 121 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> BIO_ctrl_pending(BIO *b); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> TBuf&gt; <span class="hljs-function"><span class="hljs-function">TBuf </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BioMemToTBuf</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BIO* bio)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* data = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> len = BIO_ctrl_pending(bio); Invariant(len &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); .... }</code> </pre> <br>  Invalid check of function return value from OpenSSL library.  This may well be a serious mistake or even a vulnerability. <br><br><h3>  About pointers and memory </h3><br>  <a href="https://www.viva64.com/ru/w/v603/">V603</a> CWE-665  If you wish to call constructor, 'this-&gt; JsonBufferManager2 :: JsonBufferManager2 (....)' should be used.  JsonReader.h 48 <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonBufferManager2</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">friend</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsonBufferManagerTraits</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: JsonBufferManager2() { JsonBufferManager2(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } .... }</code> </pre> <br>  Probably from one constructor they wanted to call another.  But in fact, a temporary object of the <i>JsonBufferManager2</i> class is <i>created</i> and immediately destroyed.  This type of error is described in more detail in the article " <a href="https://www.viva64.com/ru/b/0127/">Without knowing the ford, do not climb into the water: part one</a> ."  This article explains how to call one constructor from another. <br><br>  <a href="https://www.viva64.com/ru/w/v568/">If you‚Äôre a</a> sizeof () ‚Äôoperator evalu evalu P P P P P P P P P P P  TimerQueue.cpp 443 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> TimerQueue::SigHandler(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sig, <span class="hljs-keyword"><span class="hljs-keyword">siginfo_t</span></span> *si, <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*) { TimerQueue* thisPtr = (TimerQueue*)si-&gt;si_value.sival_ptr; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> written = write(thisPtr-&gt;pipeFd_[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;thisPtr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(thisPtr)); Invariant(written == <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(thisPtr)); <span class="hljs-comment"><span class="hljs-comment">// &lt;= }</span></span></code> </pre> <br>  The correct <i>sizeof</i> <i>() is</i> passed to the <i>write ()</i> function, but the result of the reading function is likely to be compared with the size of the written object: <br><br><pre> <code class="cpp hljs">Invariant(written == <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(*thisPtr));</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v595/">V595</a> CWE-476 The 'globalDomain' pointer was used before it was verified against nullptr.  Check lines: 196, 197. PlacementReplica.cpp 196 <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> PlacementReplica::ForEachWeightedDefragMetric(....) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> metricIndexInGlobalDomain = totalMetricIndexInGloba.... - globalDomain-&gt;MetricStartIndex; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (globalDomain != <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span> &amp;&amp; globalDomain-&gt;Metrics[metricIndexInGlobalDomain].Weight &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!processor(totalMetricIndexInGlobalDomain)) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre> <br>  The classic error when working with the <i>globalDomain</i> pointer: first dereference, then check. <br><br>  <a href="https://www.viva64.com/ru/w/v611/">V611</a> CWE-762  Consider inspecting this code.  It's probably better to use 'delete [] groups;'.  PAL.cpp 4733 <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">NET_API_STATUS </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NetUserGetLocalGroups</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> unameA = utf16to8(UserName).substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, ACCT_NAME_MAX); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ngroups = <span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">gid_t</span></span> *groups = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">gid_t</span></span>[ngroups]; <span class="hljs-keyword"><span class="hljs-keyword">gid_t</span></span> gid; .... <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> groups; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NERR_Success; }</code> </pre> <br>  There are many places where the memory allocated for the array is freed in the wrong way.  It is necessary to use <i>delete []</i> . <br><br><h2>  Running the analyzer in Windows containers </h2><br>  In this case, the launch of the analyzer is not much different from the automation of analysis, for example, in Jenkins on a real computer.  We ourselves use Docker to test PVS-Studio for Windows.  Just install the analyzer: <br><br><pre> <code class="cpp hljs">START /w PVS-Studio_setup.exe /VERYSILENT /SUPPRESSMSGBOXES \ /NORESTART /COMPONENTS=Core,Standalone</code> </pre> <br>  and run an analysis of your project: <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\PVS-Studio\PVS-Studio_Cmd.exe"</span></span> ...</code> </pre> <br><h2>  Conclusion </h2><br>  The focus of the article was on an interesting containerization technology, which is not an obstacle to the integration of static analysis into your project.  Therefore, the PVS-Studio warnings found were reduced in the article, but are fully available for download in browser format: <a href="">service-fabric-pvs-studio-html.7z</a> . <br><br>  I suggest everyone to download and try <a href="https://www.viva64.com/ru/pvs-studio-download/">PVS-Studio</a> on their project.  The analyzer runs on Windows, Linux and macOS! <br><br><p> <a href="https://www.viva64.com/en/b/0567/"><img src="https://habrastorage.org/webt/ts/z9/km/tsz9kmyjtteajhd4x1au60rsrvq.png" align="left"></a> </p><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="https://www.viva64.com/en/b/0567/">Features of the Azure Service Fabric code.</a> <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="https://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. </div></div></div><p>Source: <a href="https://habr.com/ru/post/353438/">https://habr.com/ru/post/353438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353428/index.html">Telegram lock - prepare for the worst?</a></li>
<li><a href="../353430/index.html">18 rules of the perfect psd layout - a useful checklist for designers</a></li>
<li><a href="../353432/index.html">How to write an exchange with 50 suppliers and do not go crazy</a></li>
<li><a href="../353434/index.html">Choose Yii2 or laravel</a></li>
<li><a href="../353436/index.html">How the Internet of Things shifts analytics to the periphery</a></li>
<li><a href="../353440/index.html">Shine and Poverty Java for Desktop</a></li>
<li><a href="../353444/index.html">We write the plugin for Unity correctly. Part 2: Android</a></li>
<li><a href="../353446/index.html">Operators?. ?? and |>: future JavaScript features you'll like</a></li>
<li><a href="../353448/index.html">Great, we are going to devOps-ping. So, 15 years of planning?</a></li>
<li><a href="../353458/index.html">Code generation during application operation: real examples and techniques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>