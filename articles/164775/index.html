<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Tracking directory changes: how it is done in different operating systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to devote an article to the review of the API provided by different operating systems to monitor changes in the directory. The article ap...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Tracking directory changes: how it is done in different operating systems</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/790/349/bce/790349bce1638df51dd55dc2c5b3e3ea.jpg" align="right">  I would like to devote an article to the review of the API provided by different operating systems to monitor changes in the directory.  The article appeared as the result of my work on the demons tracking the changes for the dklab_realsync utility ( <a href="http://habrahabr.ru/post/139348/">article on the habr</a> , <a href="https://github.com/DmitryKoterov/dklab_realsync">github repository</a> ) and my own, which I don‚Äôt want to announce. <br><a name="habracut"></a><br><h1>  Windows ReadDirectoryChangesW </h1><br>  For the Windows operating system, there is a great function <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa365465(v%3Dvs.85).aspx">ReadDirectoryChangesW</a> , which returns a set of changes for a directory, including a flag for working recursively (bWatchSubtree).  Thus, the implementation of tracking changes in the directory is not difficult and in the same dklab_realsync <a href="">implementation</a> takes 80 lines of code or 3.5 KB.  Interestingly, in Windows, these events are supported even through SMB! <br><br>  However, there are certain pitfalls: <br><br><ul><li>  the final size of the change buffer, after which the event queue will overflow and these events will be lost </li><li>  According to the <a href="http://packages.python.org/watchdog/installation.html">watchdog package</a> documentation, the move event is sent before the changes are visible in the file system. </li><li>  buffer size is limited to 64 KB for network FS </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Conclusion:</b> The ReadDirectoryChangesW function allows you to easily find out about all the events in the files, but the event queue may overflow and then you will need to perform a full scan of the file system.  Also, delivery of events is possible before they become relevant. <br><br><h1>  Mac OS X, FSEvents </h1><br>  Mac OS X also has a convenient and simple API for tracking changes in the file system called <a href="https://developer.apple.com/library/mac/">FSEvents</a> .  Using this API, the <a href="">simplest daemon implementation</a> is 50 lines of code or 1.8 KB.  The queue cannot overflow (!), But a full scan may still be required if the fseventsd daemon crashes.  It should be noted that this API, up to version 10.7, does not provide changes by files, it only reports directories in which something has changed.  Since events do not disappear anywhere and are written to the log ( <a href="https://developer.apple.com/library/mac/">FSEvents service stores events in a persistent, per-volume database</a> ), specifying with accuracy for the directory saves disk space. <br><br>  <b>Conclusion:</b> FSEvents API for Mac OS X is the most unusual of all such APIs.  The queue does not overflow and even has the opportunity to receive events from the past.  However, the event details are given up to the directory (up to version 10.7), which means that the daemon is less efficient for file synchronization. <br><br><h1>  Linux inotify </h1><br>  In linux vanilla kernel, there is one way to monitor changes in a directory - it is <a href="http://linux.die.net/man/7/inotify">inotify</a> .  There is good and detailed documentation for this API, but there is no support for recursive change tracking!  Also, inotify has a limit on the maximum number of objects that can be monitored.  <a href="">The simplest</a> daemon <a href="">implementation</a> takes up 250 lines of code or 8 kb.  Static build using <a href="http://www.fefe.de/dietlibc/">dietlibc</a> takes about 14 kb.  Another unpleasant point is that the application itself must maintain correspondences between the watch descriptor (in our case it is always a directory) and the name.  There is a function <a href="http://linux.die.net/man/2/inotify_add_watch">inotify_add_watch</a> , which passes the path to the monitored directory, but there is no inverse - inotify_get_path, which would return this same path by the passed descriptor.  Events, however, contain only a watch descriptor and a relative path to the changed file within the directory. <br><br>  Pitfalls of recursive directory tracking via inotify: <br><br><ul><li>  The possibility of queue overflow (the queue length is set in / proc / sys / fs / inotify / max_queued_events) </li><li>  Limit on the maximum number of tracking objects (set in / proc / sys / fs / inotify / max_user_watches) </li><li>  Lack of recursive directory tracking </li><li>  The need to separately handle the case when a directory is created (for example, mkdir -pa / b / c).  You will receive an event that the ‚Äúa‚Äù directory has been created, but as long as you hang up the handler on this directory, you can already create another directory in it and you will not have an event about it anymore. </li><li>  The theoretical possibility of an integer overflow watch descriptor (wd), as it is given by uint32 </li></ul><br><br><h1>  FreeBSD, Mac OS X, kqueue </h1><br>  FreeBSD and Mac OS X allow you to track changes using kqueue, which is similar to inotify in its characteristics and also does not have the ability to recursively track directories.  Also, kqueue accepts open file (directory) descriptors as arguments, so when using this API, the restrictions on the number of tracked directories are even stricter. <br><br><h1>  Total: </h1><br><table><tbody><tr><th>  Mechanism </th><th>  Queue overflow </th><th>  Recursive? </th><th>  Max.  of objects </th><th>  Detailing </th></tr><tr><td>  ReadDirectoryChangesW </td><td>  Yes </td><td>  Yes </td><td>  - </td><td>  file </td></tr><tr><td>  FSEvents </td><td>  <b>Not</b> </td><td>  Yes </td><td>  - </td><td>  file (10.7+) </td></tr><tr><td>  inotify </td><td>  Yes </td><td>  <b>Not</b> </td><td>  8192 </td><td>  file </td></tr><tr><td>  kqueue </td><td>  Yes </td><td>  <b>Not</b> </td><td>  1024 </td><td>  file </td></tr></tbody></table>  As you can see, all APIs have their advantages and disadvantages.  The least convenient mechanisms are kqueue and inotify, but they are also the most effective and reliable.  Commercial operating systems provide more convenient mechanisms for tracking changes, but they also have their own characteristics.  I hope you now have a better idea of ‚Äã‚Äãhow hard the fate of Dropbox and similar programs need to get along with all this and implement reliable and effective data synchronization :). <br><br>  <i>* Picture taken from <a href="http://www.alexblogger.com/2008_01_01_archive.html">www.alexblogger.com/2008_01_01_archive.html</a></i> </div><p>Source: <a href="https://habr.com/ru/post/164775/">https://habr.com/ru/post/164775/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../164763/index.html">Darwinian Evolution of Bacteria - The Complete Picture</a></li>
<li><a href="../164767/index.html">Google closed Maps for Windows Phone users</a></li>
<li><a href="../164769/index.html">Internal device llst, part 1. Introduction to Smalltalk</a></li>
<li><a href="../164771/index.html">-90% piracy on iOS or Hackulos closes</a></li>
<li><a href="../164773/index.html">Android GameStick: The World's Smallest Game Console</a></li>
<li><a href="../164779/index.html">Django 1.5 Release Candidate released</a></li>
<li><a href="../164781/index.html">Network perversions: several identical ip on different router interfaces in FreeBSD</a></li>
<li><a href="../164783/index.html">Emigration to Poland as a student or as a freelancer</a></li>
<li><a href="../164787/index.html">Software developer for gambling faces jail sentence in the US</a></li>
<li><a href="../164789/index.html">Why does space have three dimensions? Proved with the help of "Three oranges"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>