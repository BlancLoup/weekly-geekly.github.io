<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Making a queue of incoming calls with the callback function</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When calling to call center companies often have to face long waiting times on the line, many of us listened to an annoying melody for tens of minutes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Making a queue of incoming calls with the callback function</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/26d/756/47d/26d75647d96b4a0d9b059fb1e11b653c.jpg" align="left">  When calling to call center companies often have to face long waiting times on the line, many of us listened to an annoying melody for tens of minutes at least once in a lifetime.  The most interesting thing is that it is completely unprofitable for the company to call center where you are calling, especially if you are calling 8-800.  Fortunately, a way has long been invented to solve this problem - it is a callback or callback.  The essence of this method is very simple: the caller is offered to disconnect from the call center while his number remains in the service queue and as soon as his turn comes, he will be automatically dialed and connected to the operator to whom his call was distributed.  In this way, we kill several birds with one stone: the call center lines are not engaged, costly 8-800 minutes are not spent, and customers do not experience excessive irritation while waiting for a response.  Call-center software vendors want very decent money for such a function, and we will tell under the cut how this functionality is quite simply and quickly implemented using the VoxImplant platform. <a name="habracut"></a><br>  Since we <a href="http://habrahabr.ru/post/242397/">have already written about the organization of a call center</a> using VoxImplant, we will not repeat this part in this article, but will focus on the changes that need to be made in the scenarios for implementing the callback function.  Immediately, I note that this functionality is only available for scenarios in which the ACD module is used to work with queues.  The script responsible for handling incoming calls, taking into account our callback function, will look like this: <br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   ACD require(Modules.ACD); var request, // &lt;--     ACDRequest originalCall, // &lt;--   callerid, statusInterval, callback = false; // &lt;--   - //     VoxEngine.addEventListener(AppEvents.CallAlerting, handleInboundCall); //    function handleInboundCall(e) { originalCall = e.call; callerid = e.callerid; //   originalCall.addEventListener(CallEvents.Connected, handleCallConnected); originalCall.addEventListener(CallEvents.PlaybackFinished, handlePlaybackFinished); originalCall.addEventListener(CallEvents.Failed, cleanup); originalCall.addEventListener(CallEvents.Disconnected, cleanup); //    originalCall.answer(); } //   function cleanup(e) { if (request) { //     -  request.cancel(); request = null; } //   if (!callback) VoxEngine.terminate(); } //         function handlePlaybackFinished(e) { e.call.startPlayback("http://cdn.voximplant.com/toto.mp3"); } //     function handleToneReceived(e) { if (e.tone == "#") { callback = true; originalCall.hangup(); // &lt;--        } } //   function handleCallConnected(e) { //       originalCall.handleTones(true); originalCall.addEventListener(CallEvents.ToneReceived, handleToneReceived); //     'MainQueue',       request = VoxEngine.enqueueACDRequest("MainQueue", callerid); //          request.addEventListener(ACDEvents.Queued, function (acdevent) { request.getStatus(); }); //           request.addEventListener(ACDEvents.Waiting, function (acdevent) { var minutesLeft = acdevent.ewt + 1; var minutesWord = " ."; if ((minutesLeft &gt; 10 &amp;&amp; minutesLeft &lt; 20) || (minutesLeft % 10 &gt; 4 || minutesLeft % 10 == 0)) { minutesWord = " ."; } else if (minutesLeft % 10 == 1) { minutesWord = " ."; } originalCall.say("      " + acdevent.position + ".       " + (acdevent.ewt + 1) + minutesWord + "                  .", Language.RU_RUSSIAN_FEMALE); }); //    request.addEventListener(ACDEvents.OperatorReached, function (acdevent) { if (callback) { //      ,        ,       acdevent.operatorCall.say(",    .", Language.RU_RUSSIAN_FEMALE); acdevent.operatorCall.addEventListener(CallEvents.Disconnected, VoxEngine.terminate); acdevent.operatorCall.addEventListener(CallEvents.PlaybackFinished, function (callevent) { //  .   caller id  ,       Voximplant. const callerId = "+1234567890" originalCall = VoxEngine.callPSTN(callerid, callerId); originalCall.addEventListener(CallEvents.Connected, function (callevent) { VoxEngine.sendMediaBetween(acdevent.operatorCall, originalCall); clearInterval(statusInterval); }); originalCall.addEventListener(CallEvents.Failed, cleanup); originalCall.addEventListener(CallEvents.Disconnected, cleanup); }); } else { VoxEngine.sendMediaBetween(acdevent.operatorCall, originalCall); acdevent.operatorCall.addEventListener(CallEvents.Disconnected, VoxEngine.terminate); clearInterval(statusInterval); } }); //    -       request.addEventListener(ACDEvents.Offline, function (acdevent) { originalCall.say(" ,    . ,   .", Language.RU_RUSSIAN_FEMALE); originalCall.addEventListener(CallEvents.PlaybackFinished, function (e) { VoxEngine.terminate(); }); }); //      30  statusInterval = setInterval(request.getStatus, 30000); }</span></span></code> </pre> <br>  That's all.  Having a little corrected the script from the previous tutorial about ACD we got a queue with a callback.  The baseline script that we changed is available on <a href="https://github.com/voximplant/acd">github.com/voximplant/acd</a> , as well as the simplest web background for operators. <br><br><h3>  Work with queue through HTTP API </h3><br>  The previous example was made for the case when there is an incoming call first, in real life there may be cases when a customer orders a callback on the site immediately and we need to place it in the processing queue.  In general, a queue is an abstract entity, you can throw not only calls, but also, for example, emails, messages, etc. there for processing.  In this situation, the script must be run via the <a href="httpapi/StartScenarios.html">StartScenarios</a> HTTP API method, and the script itself is slightly transformed: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> displayName, callback = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     StartScenarios VoxEngine.addEventListener(AppEvents.Started, function(e) { var data = VoxEngine.customData(); //   script_custom_data         : data = data.split(":"); callerid = data[0]; displayName = data[1]; Logger.write("Put "+displayName+" with number "+callerid+" in a queue"); //     'MainQueue' request = VoxEngine.enqueueACDRequest("MainQueue", callerid); // ...     ,      });</span></span></code> </pre><br><br><h3>  PS What if ... </h3><br>  We are sometimes asked: ‚Äúwhat if we want to use SIP phones instead of web phones made with the VoxImplant Web SDK in our call center?‚Äù <br>  The answer is: "oddly enough, it is possible, but we will tell about it in more detail in a separate article." </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/249647/">https://habr.com/ru/post/249647/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../249637/index.html">Twitter-based bot Markov and phrases from the series</a></li>
<li><a href="../249639/index.html">KISS - the design principle, containing all other design principles</a></li>
<li><a href="../249641/index.html">Diablo 3 - Resource Bubbles</a></li>
<li><a href="../249643/index.html">New Year star with Wi-Fi based on ESP8266</a></li>
<li><a href="../249645/index.html">Kernel .Net (GC, JIT, interop, ...) in Open Source</a></li>
<li><a href="../249649/index.html">Configuring Kerio Control Firewall for 3CX Phone System</a></li>
<li><a href="../249651/index.html">1987 - Exhibition "Computer Science in the Life of the United States"</a></li>
<li><a href="../249653/index.html">Isomorphic BEM</a></li>
<li><a href="../249655/index.html">Simple techniques of reverse engineering UEFI PEI-modules on a useful example</a></li>
<li><a href="../249657/index.html">Let's reinvent the wheel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>