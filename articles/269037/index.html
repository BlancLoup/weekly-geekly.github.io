<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Program modification and what is better to change: executable code or AST program?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The principles in the note are common to almost any programming language and execution system, but the emphasis will be on jvm. Consider two main appr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Program modification and what is better to change: executable code or AST program?</h1><div class="post__text post__text-html js-mediator-article">  The principles in the note are common to almost any programming language and execution system, but the emphasis will be on jvm.  Consider two main approaches to program modification: <br><br><ul><li>  manipulations with the executable code of the program after compilation or during code loading; </li><li>  change source code before compiling. </li></ul><br><img src="https://habrastorage.org/files/b41/afe/133/b41afe133ab646b48568f7b25d0f875c.jpg"><br><a name="habracut"></a><br>  The metaphor associated with the <a href="https://en.wikipedia.org/wiki/Montreal_Biosph%25C3%25A8re">image in the note</a> : the program - this is the main building, and the result of the transformation program - an auxiliary structure. <br><br><h2>  Why modify? </h2><br>  We begin by asking <b>why the</b> program <b>should</b> modify another program.  <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D1%2582%25D0%25B0%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Metaprogramming</a> helps reduce the amount of boilerplate code in a project and concentrate on the main thing, improve code readability and solve problems that are difficult to solve in another way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The simplest example in java is JavaBeans and get / set methods for accessing class fields, an example is the creation of builders for a class, the automatic implementation of equals / hash in the IDE, etc. <br><br>  The next example is logging, automatic transaction management.  Everything is used to when using the Spring Framework and rarely think about how it is implemented.  But even Spring created difficulties with the configuration and initialization of the framework for beginners, which caused the emergence of the "magic" <a href="http://projects.spring.io/spring-boot">Spring Boot</a> / <a href="http://projects.spring.io/spring-roo">Spring Roo</a> .  But this is a separate topic, we will return to the topic of program modification. <br><br>  Obfuscation and minimization of code, instrumental profilers and the world of DevOps is the third example for which you need to modify the program.  I think I missed other important examples, you can add in the comments. <br><br>  So, why modify the program, we have decided, now consider <b>how it is usually done</b> . <br><br><h2>  Modification of executable program instructions </h2><br>  You can modify the bytecode of the program and this is the most common way.  This can be done either immediately after compilation, but before building the jar, or when the class is loaded.  In the first case, it will be a plugin of the project's build system, in the second, a special class loader or java agent, or hotswap mechanism in jvm.  The approach with agents and class loaders is very similar to self-modifying machine code and polymorphic viruses. <br><br>  <a href="https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings">The bytecode of the</a> file that loads jvm has the structure described in the official <a href="http://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html">class format</a> documentation. <br>  The <a href="http://docs.oracle.com/javase/8/docs/technotes/tools/windows/javap.html">javap</a> application allows <a href="http://docs.oracle.com/javase/8/docs/technotes/tools/windows/javap.html">you</a> to view the bytecode of the compiled class. <br><div class="spoiler">  <b class="spoiler_title">Example from official documentation</b> <div class="spoiler_text">  Class Source: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.applet.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocFooter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Applet</span></span></span><span class="hljs-class"> </span></span>{ String date; String email; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ resize(<span class="hljs-number"><span class="hljs-number">500</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>); date = getParameter(<span class="hljs-string"><span class="hljs-string">"LAST_UPDATED"</span></span>); email = getParameter(<span class="hljs-string"><span class="hljs-string">"EMAIL"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">paint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graphics g)</span></span></span><span class="hljs-function"> </span></span>{ g.drawString(date + <span class="hljs-string"><span class="hljs-string">" by "</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">15</span></span>); g.drawString(email,<span class="hljs-number"><span class="hljs-number">290</span></span>,<span class="hljs-number"><span class="hljs-number">15</span></span>); } }</code> </pre> <br>  The javap output to the console for the bytecode of this class: <br><pre> <code class="java hljs">Compiled from <span class="hljs-string"><span class="hljs-string">"DocFooter.java"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DocFooter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">applet</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Applet</span></span></span><span class="hljs-class"> </span></span>{ java.lang.String date; java.lang.String email; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DocFooter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; Code: <span class="hljs-number"><span class="hljs-number">0</span></span>: aload_0 <span class="hljs-number"><span class="hljs-number">1</span></span>: invokespecial #<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">// Method java/applet/Applet."&lt;init&gt;":()V 4: return public void init(); Code: 0: aload_0 1: sipush 500 4: bipush 100 6: invokevirtual #2 // Method resize:(II)V 9: aload_0 10: aload_0 11: ldc #3 // String LAST_UPDATED 13: invokevirtual #4 // Method getParameter:(Ljava/lang/String;)Ljava/lang/String; 16: putfield #5 // Field date:Ljava/lang/String; 19: aload_0 20: aload_0 21: ldc #6 // String EMAIL 23: invokevirtual #4 // Method getParameter:(Ljava/lang/String;)Ljava/lang/String; 26: putfield #7 // Field email:Ljava/lang/String; 29: return public void paint(java.awt.Graphics); Code: 0: aload_1 1: new #8 // class java/lang/StringBuilder 4: dup 5: invokespecial #9 // Method java/lang/StringBuilder."&lt;init&gt;":()V 8: aload_0 9: getfield #5 // Field date:Ljava/lang/String; 12: invokevirtual #10 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder; 15: ldc #11 // String by 17: invokevirtual #10 // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder; 20: invokevirtual #12 // Method java/lang/StringBuilder.toString:()Ljava/lang/String; 23: bipush 100 25: bipush 15 27: invokevirtual #13 // Method java/awt/Graphics.drawString:(Ljava/lang/String;II)V 30: aload_1 31: aload_0 32: getfield #7 // Field email:Ljava/lang/String; 35: sipush 290 38: bipush 15 40: invokevirtual #13 // Method java/awt/Graphics.drawString:(Ljava/lang/String;II)V 43: return }</span></span></code> </pre> <br></div></div><br>  But manually modifying the bytecode only makes sense for training purposes or if you are a ninja who loves to create and overcome difficulties.  <a href="https://docs.oracle.com/javase/specs/jvms/se7/html/">The Java Virtual Machine Specification</a> answers most questions at this stage. <br><br>  In industrial programming, the work with byte-code is simplified by the <a href="http://asm.ow2.org/">ASM</a> , <a href="http://jboss-javassist.github.io/javassist/">javassist</a> , <a href="https://commons.apache.org/proper/commons-bcel/">BCEL</a> , <a href="https://github.com/cglib/cglib">CGLIB libraries</a> .  After parsing the code bytes, the same ASM allows the programmer to work with the bytes code both through the Tree API and in the event model using the visitor template.  In addition to the analysis, it is also possible to modify, add new instructions, fields, methods, etc.  In nature, there are other libraries work with byte code, but they are used less frequently. <br><br>  An example of using the ASM API for <div class="spoiler">  <b class="spoiler_title">bytecode analysis</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/*** * ASM examples: examples showing how ASM can be used * Copyright (c) 2000-2011 INRIA, France Telecom * All rights reserved. * * Redistribution and use in source and binary forms, with or without * modification, are permitted provided that the following conditions * are met: * 1. Redistributions of source code must retain the above copyright * notice, this list of conditions and the following disclaimer. * 2. Redistributions in binary form must reproduce the above copyright * notice, this list of conditions and the following disclaimer in the * documentation and/or other materials provided with the distribution. * 3. Neither the name of the copyright holders nor the names of its * contributors may be used to endorse or promote products derived from * this software without specific prior written permission. * * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF * THE POSSIBILITY OF SUCH DAMAGE. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashSet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Iterator; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Set; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.ClassReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.MethodVisitor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.Opcodes; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.AbstractInsnNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.ClassNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.IincInsnNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.MethodNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.VarInsnNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.analysis.Analyzer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.analysis.BasicValue; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.analysis.BasicVerifier; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.analysis.Frame; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.analysis.SourceInterpreter; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.tree.analysis.SourceValue; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.util.TraceMethodVisitor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.objectweb.asm.util.Textifier; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@author</span></span></span><span class="hljs-comment"> Eric Bruneton */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Analysis</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Opcodes</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ClassReader cr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassReader(<span class="hljs-string"><span class="hljs-string">"Analysis"</span></span>); ClassNode cn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassNode(); cr.accept(cn, ClassReader.SKIP_DEBUG); List&lt;MethodNode&gt; methods = cn.methods; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; methods.size(); ++i) { MethodNode method = methods.get(i); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method.instructions.size() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!analyze(cn, method)) { Analyzer&lt;?&gt; a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;BasicValue&gt;( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicVerifier()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { a.analyze(cn.name, method); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ignored) { } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Frame&lt;?&gt;[] frames = a.getFrames(); Textifier t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Textifier() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMaxs</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxStack, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxLocals)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; text.size(); ++i) { StringBuilder s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder( frames[i] == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? <span class="hljs-string"><span class="hljs-string">"null"</span></span> : frames[i].toString()); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (s.length() &lt; Math.max(<span class="hljs-number"><span class="hljs-number">20</span></span>, maxStack + maxLocals + <span class="hljs-number"><span class="hljs-number">1</span></span>)) { s.append(<span class="hljs-string"><span class="hljs-string">' '</span></span>); } System.err.print(Integer.toString(i + <span class="hljs-number"><span class="hljs-number">1000</span></span>) .substring(<span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">" "</span></span> + s + <span class="hljs-string"><span class="hljs-string">" : "</span></span> + text.get(i)); } System.err.println(); } }; MethodVisitor mv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TraceMethodVisitor(t); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; method.instructions.size(); ++j) { Object insn = method.instructions.get(j); ((AbstractInsnNode) insn).accept(mv); } mv.visitMaxs(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } } } } <span class="hljs-comment"><span class="hljs-comment">/* * Detects unused xSTORE instructions, ie xSTORE instructions without at * least one xLOAD corresponding instruction in their successor instructions * (in the control flow graph). */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">analyze</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ClassNode c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MethodNode m)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Analyzer&lt;SourceValue&gt; a = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Analyzer&lt;SourceValue&gt;( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SourceInterpreter()); Frame&lt;SourceValue&gt;[] frames = a.analyze(c.name, m); <span class="hljs-comment"><span class="hljs-comment">// for each xLOAD instruction, we find the xSTORE instructions that can // produce the value loaded by this instruction, and we put them in // 'stores' Set&lt;AbstractInsnNode&gt; stores = new HashSet&lt;AbstractInsnNode&gt;(); for (int i = 0; i &lt; m.instructions.size(); ++i) { AbstractInsnNode insn = m.instructions.get(i); int opcode = insn.getOpcode(); if ((opcode &gt;= ILOAD &amp;&amp; opcode &lt;= ALOAD) || opcode == IINC) { int var = opcode == IINC ? ((IincInsnNode) insn).var : ((VarInsnNode) insn).var; Frame&lt;SourceValue&gt; f = frames[i]; if (f != null) { Set&lt;AbstractInsnNode&gt; s = f.getLocal(var).insns; Iterator&lt;AbstractInsnNode&gt; j = s.iterator(); while (j.hasNext()) { insn = j.next(); if (insn instanceof VarInsnNode) { stores.add(insn); } } } } } // we then find all the xSTORE instructions that are not in 'stores' boolean ok = true; for (int i = 0; i &lt; m.instructions.size(); ++i) { AbstractInsnNode insn = m.instructions.get(i); int opcode = insn.getOpcode(); if (opcode &gt;= ISTORE &amp;&amp; opcode &lt;= ASTORE) { if (!stores.contains(insn)) { ok = false; System.err.println("method " + m.name + ", instruction " + i + ": useless store instruction"); } } } return ok; } /* * Test for the above method, with three useless xSTORE instructions. */ public int test(int i, int j) { i = i + 1; // ok, because i can be read after this point if (j == 0) { j = 1; // useless } else { try { j = j - 1; // ok, because j can be accessed in the catch int k = 0; if (i &gt; 0) { k = i - 1; } return k; } catch (Exception e) { // useless ASTORE (e is never used) j = j + 1; // useless } } return 0; } }</span></span></code> </pre> </div></div><br>  <b>An aspect-oriented</b> approach can be considered a <b>high-level method of program modification</b> .  In AspectJ implementations at the level of an agent, class loader or plug-in, all the ‚Äúmagic‚Äù of AOP turns into manipulations with class byte-code.  But how the programmer sees this when developing differs from how the byte code is modified ‚Äúunder the hood‚Äù using the same ASM and BCEL.  If you are wondering what AspectJ actually adds to the classes of your application, you can <a href="https://eclipse.org/aspectj/doc/released/pdguide/ltwdump.html">include a dump of the</a> modified classes and get into this code to your elbow, for example, using <a href="http://jd.benow.ca/">Java Decompiler</a> . <br><br>  In AspectJ, a developer defines actions in the form of classes, annotating them as aspects and indicating at which points in the program (Pointcut) they should be called.  <a href="https://eclipse.org/aspectj/doc/released/progguide/semantics-pointcuts.html">The syntax for defining pointcut</a> expressions is also quite high-level.  This approach to modifying bytecode is easier to use for a programmer. <div class="spoiler">  <b class="spoiler_title">More showed and told on examples in a series of publications on Habr√©</b> <div class="spoiler_text"><ul><li>  <a href="http://habrahabr.ru/post/268393/">We diagnose the cause, survive in JAR hell: do not breathe sulfur and do not cook in the boiler</a> </li><li>  <a href="http://habrahabr.ru/post/267009/">Publishing logs in Elasticsearch - life without regular expressions and without logstash</a> </li><li>  <a href="http://habrahabr.ru/post/266781/">Logging JDBC requests and their parameters in an existing application</a> </li><li>  <a href="http://habrahabr.ru/post/265741/">Habr shell: we build a cross-platform ssh server in java application</a> </li><li>  <a href="http://habrahabr.ru/post/264415/">Implementation of web consoles in the jvm process using the SonarQube example</a> </li><li>  <a href="http://habrahabr.ru/post/267223/">Report: "Aspect-oriented programming in distributed systems for java developers and QA"</a> </li><li>  <a href="http://habrahabr.ru/post/254571/">Files are different or the story about the "file" for java programs</a> </li></ul></div></div><br>  Program transformation due to modification of byte-code has its strengths and weaknesses: <br><table><tbody><tr><th>  pros </th><th>  Minuses </th></tr><tr><td>  the approach works in the absence of source code of the program </td><td>  complexity of analysis and modification, with non-trivial transformations </td></tr><tr><td>  compiler independence </td><td>  lack of information available only in source code </td></tr></tbody></table><br><h2>  Transformation of AST source code, metaprogramming </h2><br>  The theory and practice of transforming source code has long been used in metaprogramming, Prolog, Lisp, macros, and preprocessors of programming languages. <br><br>  With this approach, the source code of the program is transformed or supplemented by another program before compilation, and then compiled.  It is more convenient to work not with the program text itself, but with the abstract syntax tree constructed from it (abstract syntax tree, AST). <br><br>  Again, the convenience of metaprogramming depends on its support in the programming language itself.  There is a joke <blockquote>  In Lisp, if you are hunting for aspect-oriented programming, you just need to set up some macros, and you're done.  In Java, you need a Gregor Kichales, creating a new company, and months and years of trying to make everything work. </blockquote>  <a href="https://ru.wikibooks.org/wiki/%25D0%2590%25D1%2581%25D0%25BF%25D0%25B5%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Peter Norvig</a> <br><br>  Therefore, jvm is a bit more complicated, although the mechanism of reflection is part of the language and the platform can dynamically load and execute bytecode.  Two technologies that use code generation - JPA static metamodel generator and jaxb code generation come to mind.  Another example is the <a href="https://projectlombok.org/">project Lombok</a> , which allows you to automatically implement what was previously generated by the IDE or was written manually and was supported by the developers. <br><div class="spoiler">  <b class="spoiler_title">Annotations of the project Lombok</b> <div class="spoiler_text">  val <br>  Finally!  Hassle-free final local variables. <br>  @ NonNull <br>  or: How I learned to stop NullPointerException. <br>  @ Cleanup <br>  Automatic resource management: Call your close () methods safely with no hassle. <br>  @ Getter / @ setter <br>  Never write public int getFoo () {return foo;} again. <br>  @ ToString <br>  No need to start a field. Just let lombok generate a toString for you! <br>  @ EqualsAndHashCode <br>  Equality made easy: Generates hashCode and equals implementations from your fields. <br>  @ NoArgsConstructor, @ RequiredArgsConstructor and @ AllArgsConstructor <br>  Constructors made to order: Generate field for each field. <br>  @ Data <br>  All together now: A shortcut for @ ToString, @ EqualsAndHashCode, @ Getter on all fields, and @ Setter on all non-final fields, and @ RequiredArgsConstructor! <br>  @ Value <br>  Immutable classes made very easy. <br>  @ Builder <br>  ... and Bob's your uncle: No-hassle fancy-pants APIs for object creation! <br>  @ SneakyThrows <br>  Boldly throw checked exceptions <br>  @ Synchronized <br>  synchronized done right: Don't expose your locks. <br>  @ Getter (lazy = true) <br>  Laziness is a virtue! <br>  @ Log <br>  Captain's Log, stardate 24435.7: "What was that line again?" <br></div></div><br>  Implemented in Lombok by <a href="http://notatube.blogspot.ru/2010/12/project-lombok-creating-custom.html">modifying the AST</a> user program and code generation. <br><br>  Similar functionality, with its limitations, is also available in java for annotations with the scope compile time - <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/apt/">Annotation Processing Tool</a> . <br><br>  In the case of parsing java source code, it's better than anyone who is better than javac and eclipse java compiller.  There are alternatives, such as <a href="http://spoon.gforge.inria.fr/">Spoon</a> and <a href="https://sewiki.iai.uni-bonn.de/research/jtransformer/start">JTransformer</a> , but how fully they support the specification and complex classes, there is not even a desire to check. <br><br>  If we are talking about jvm, then the transformation of the source code of the program on Groovy is <a href="http://www.groovy-lang.org/metaprogramming.html">part of the language itself</a> , there are similar possibilities in the <a href="http://docs.scala-lang.org/overviews/reflection/symbols-trees-types.html">Scala</a> language. <br><br>  So, in the modification of the source code of the program there are weaknesses and strengths: <br><table><tbody><tr><th>  pros </th><th>  Minuses </th></tr><tr><td>  more information than bytecode </td><td>  compilation or interpretation stage (memory, time) </td></tr><tr><td>  features like refactoring in IDE </td><td>  requirement for source code, a way to automatically find it for a given class / jar </td></tr></tbody></table><br><br><h2>  Transformation of AST code and runtime recompilation </h2><br>  The most hardcore part of this article is thoughts about recompiling to runtime.  <b>Modification and compilation of</b> AST java <b>code at the time of execution</b> may be necessary if crutches are required: the project is either complete caprolit, or it is very laborious to do and maintain dozens of forks of different versions, or if its management and developers consider it ideal and do not allow anyone to modify it, but the source text is in the enterprise maven repository.  And this approach is needed <b>only if the task is impossible or inconvenient to solve</b> with the two previously described program transformation classes. <br><br>  Compiling is relatively simple.  <a href="https://docs.oracle.com/javase/8/docs/api/javax/tools/JavaCompiler.html">The JavaCompiler API</a> allows you to compile a program from source code at the time of execution, providing an interface independent of implementation.  While studying the manifest and source code of the eclipse EJC compiler, I discovered that it also supports the JavaCompiler API. <br><br>  But when analyzing the program text, there is still no public and universal API for working with AST.  Those.  will have to work either with <a href="http://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/index.html">com.sun.source.tree. *</a> or <a href="http://help.eclipse.org/mars/index.jsp%3Ftopic%3D%252Forg.eclipse.jdt.doc.isv%252Freference%252Fapi%252Forg%252Feclipse%252Fjdt%252Fcore%252Fdom%252FExpression.html">org.eclipse.jdt.core.dom. *</a> <br><br>  The task of finding the source code of a class is easily solved if the project was published in the maven repository along with the source artifact and in the jar with classes there are files pom.properties or pom.xml, or there is some dictionary of the name / hash correspondence of the artifact to the source code of the corresponding jar file and a way to get these sources while the program is running. <br><br>  Pros - more information is available for transformation than is in the byte-code, the application does not require rebuilding the project and is almost as convenient as the application of the AspectJ agent, but it was not possible to perform the transformation by means of the byte-code transformation, or very laborious. <br><br>  The disadvantages are the same as in the previous approach: memory, time, the requirement for the source code of the program and the way to find it for this class. <br><br>  The examples of the above in the form of the ejc + maven code will be in the coming months, and the task chosen is quite vital.  Have you encountered similar?  What tasks from your practice could be elegantly solved only with the help of java code transformation and recompilation during execution? <br><br>  By the way, the capabilities of the <a href="http://bellard.org/tcc/">TinyCC</a> compiler and its size prove that this approach is also possible for C programs. <br><br><img src="https://habrastorage.org/files/a83/068/40a/a8306840aed24516bc51adeaea8c12b3.jpg"><br><br>  In this note, we looked at several approaches to modifying the program, their strengths and weaknesses.  Modification of the executable code is more common, but not all tasks can be solved without the source code of the program and its subsequent transformation. </div><p>Source: <a href="https://habr.com/ru/post/269037/">https://habr.com/ru/post/269037/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269023/index.html">HikariCP - the fastest pool of connections in java</a></li>
<li><a href="../269025/index.html">Amazon Web Services Infrastructure Inside. Part 2</a></li>
<li><a href="../269027/index.html">Comparison of MaxMind and Sypex bases</a></li>
<li><a href="../269029/index.html">Hibernate Developer Documentation - Chapter IV. Batch processing</a></li>
<li><a href="../269035/index.html">Volkswagen TDD</a></li>
<li><a href="../269039/index.html">PHP Digest 72 - interesting news, materials and tools (October 5 - 18, 2015)</a></li>
<li><a href="../269041/index.html">Solving common problems when building an Xcode project generated by Unity3D</a></li>
<li><a href="../269045/index.html">Phone numbers in email clients</a></li>
<li><a href="../269049/index.html">Serge - the solution for continuous localization from Evernote</a></li>
<li><a href="../269055/index.html">Pulling information from the URL, in the style of Slack and Twitter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>