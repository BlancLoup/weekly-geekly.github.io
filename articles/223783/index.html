<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part 7: Unit Testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the seventh article in the series where I describe my experience of writing a Python web application using the Flask mic framework. 

 The pur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part 7: Unit Testing</h1><div class="post__text post__text-html js-mediator-article">  This is the seventh article in the series where I describe my experience of writing a Python web application using the Flask mic framework. <br><br>  The purpose of this guide is to develop a fairly functional microblog application, which I decided to call microblog, in the absence of originality. <br><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/193260/">Part 2: Templates</a> <br>  <a href="http://habrahabr.ru/post/194062/">Part 3: Forms</a> <br>  <a href="http://habrahabr.ru/post/196810/">Part 4: Database</a> <br>  <a href="http://habrahabr.ru/post/222983/">Part 5: User Login</a> <br>  <a href="http://habrahabr.ru/post/223375/">Part 6: Profile Page and Avatars</a> <br>  <a href="http://habrahabr.ru/post/223783/">Part 7: Unit Testing</a> <i>(this article)</i> <br>  <a href="http://habrahabr.ru/post/230643/">Part 8: Subscribers, Contacts and Friends</a> <br>  <a href="http://habrahabr.ru/post/230897/">Part 9: Pagination</a> <br>  <a href="http://habrahabr.ru/post/234613/">Part 10: Full Text Search</a> <br>  <a href="http://habrahabr.ru/post/234737/">Part 11: Email Support</a> <br>  <a href="http://habrahabr.ru/post/234785/">Part 12: Reconstruction</a> <br>  <a href="http://habrahabr.ru/post/236753/">Part 13: Date and Time</a> <br>  <a href="http://habrahabr.ru/post/236861/">Part 14: I18n and L10n</a> <br>  <a href="http://habrahabr.ru/post/237065/">Part 15: Ajax</a> <br>  <a href="http://habrahabr.ru/post/237317/">Part 16: Debugging, Testing, and Profiling</a> <br>  <a href="http://habrahabr.ru/post/237489/">Part 17: Deploying to Linux (and even to Raspberry Pi!)</a> <br>  <a href="http://habrahabr.ru/post/237517/">Part 18: Deploying to Heroku Cloud</a> <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Brief repetition </h4><br>  In the previous parts of this guide, we gradually developed our microblogging, step by step adding new features.  By this time, our application can use the database, can register and authorize users, and also allows them to edit their own data in the profile. <br><br>  Today we will not add new features.  Instead, we will try to make the already written code more sustainable, and also create our own framework, which in the future will help us prevent possible failures. <br><br><a name="habracut"></a><br><h4>  Search bug </h4><br>  At the end of the previous chapter, I mentioned that there is an error in the code.  Now I will tell you what it is and we will see how our application reacts to such things. <br><br>  The problem is that we have no way to ensure the uniqueness of user nicknames.  The initial nickname is automatically selected.  If the OpenID provider tells us the nickname, we use it.  Otherwise, the first part of the user's email will be used as the nickname.  If two users with the same nicknames try to register, only the first will succeed.  By allowing users to change their data themselves, we made it worse, because here we also have no way to avoid collisions. <br><br>  Before we solve these problems, let's take a look at how an application behaves when an error occurs. <br><br><h4>  Flask Debugging </h4><br>  First of all, create a new database.  If you have Linux: <br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">rm</span></span> app.db ./db_create.py</code> </pre> <br>  Windows: <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">del</span></span> app.db flask/Scripts/python db_create.py</code> </pre><br>  You will need two OpenID accounts to play the bug, better if these accounts are from different providers, otherwise there may be some difficulties with cookies.  So, the procedure is as follows: <br><ul><li>  Login using your first account. </li><li>  On the profile edit page, change the nickname to 'dup' </li><li>  Log out </li><li>  Log in with a second account </li><li>  On the profile edit page, change the nickname to 'dup' </li></ul><br>  Oops!  We got an exception caused by sqlalchemy.  The error text reads: <br><pre> <code class="hljs python">sqlalchemy.exc.IntegrityError IntegrityError: (IntegrityError) UNIQUE constraint failed: user.nickname <span class="hljs-string"><span class="hljs-string">u'UPDATE user SET nickname=?, about_me=? WHERE user.id = ?'</span></span> (<span class="hljs-string"><span class="hljs-string">u'dup'</span></span>, <span class="hljs-string"><span class="hljs-string">u''</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre><br>  Below is the <a href="http://en.wikipedia.org/wiki/Stack_trace">stack trace of</a> this error, in which you can not only see the source code of each frame, but even execute your own code directly in the browser! <br><br>  The description of the error is very clear.  The nickname we tried to assign to the user is already in the database.  Note that in the <code>User</code> model, the <code>nickname</code> field is declared as <code>unique=True</code> , which is why this situation arose. <br><br>  In addition to this error, we have another problem.  If the user's actions lead to an error (this or any other), he will see the description of the error and the whole traceback.  This is very convenient during development, but we definitely would not want anyone except us to see it. <br><br>  All this time, our application worked in otdalki mode.  This mode is activated at startup using the <code>debug=True</code> argument passed to the <code>run</code> method.  When we run the application on the battle server, you will need to make sure that the debug mode is turned off.  For this we need another script <i>(file <code>runp.py</code> )</i> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!flask/bin/python from app import app app.run(debug = False)</span></span></code> </pre><br><br>  Now run the application using this script. <br><pre> <code class="hljs">./runp.py</code> </pre><br><br>  Try again to change the nickname of the second account to 'dup'.  This time we will not see a detailed error message.  Instead, we get an HTTP error code <code>500 Internal Server Error</code> .  Flask generates this page when the debug mode is turned off and an exception occurs.  The page looks so-so, but we at least do not disclose unnecessary details about the application. <br><br>  However, we face two more challenges.  First, the default error page 500 looks ugly.  The second problem is much more serious.  If everything is left as it is, we will never know how and when errors occur, since all errors are silenced now.  Fortunately, these problems have very simple solutions. <br><br><h4>  Native HTTP Error Handlers </h4><br>  Flask allows applications to use their own pages to display errors.  As an example, we implement our pages for errors 404 and 500, since they are most often found.  For other errors, the process of creating your own pages will be exactly the same. <br><br>  To declare our own error handler, we need the <code>errorhandler</code> decorator <i>( <code>app/views.py</code> )</i> : <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.errorhandler(404) def not_found_error(error): return render_template('404.html'), 404 @app.errorhandler(500) def internal_error(error): db.session.rollback() return render_template('500.html'), 500</span></span></code> </pre><br><br>  I do not think that this code needs clarification.  The only expression worth noting here is <code>db.session.rollback()</code> .  This function will be called as a result of the exception.  If the exception was caused by an error interacting with the database, we need to roll back the current session. <br><br>  Template for 404 error: <br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- extend base layout --&gt;</span></span> {% extends "base.html" %} {% block content %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>File Not Found<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{url_for('index')}}"</span></span></span><span class="hljs-tag">&gt;</span></span>Back<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {% endblock %}</code> </pre><br><br>  As well as a template for error 500: <br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- extend base layout --&gt;</span></span> {% extends "base.html" %} {% block content %} <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>An unexpected error has occurred<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>The administrator has been notified. Sorry for the inconvenience!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{{url_for('index')}}"</span></span></span><span class="hljs-tag">&gt;</span></span>Back<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> {% endblock %}</code> </pre><br><br>  In both cases, we still use <code>base.html</code> as the parent template, as a result of which both HTTP error messages look the same as the rest of our microblog pages. <br><br><h4>  Sending error messages to the mail </h4><br>  To solve the second problem, we will configure two application error reporting systems.  The first one will send us an email every time an error occurs. <br><br>  First of all, we need to configure the mail server and the list of administrators of our application.  <i>( <code>config.py</code> )</i> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># mail server settings MAIL_SERVER = 'localhost' MAIL_PORT = 25 MAIL_USERNAME = None MAIL_PASSWORD = None # administrator list ADMINS = ['you@example.com']</span></span></code> </pre><br><br>  Of course, you need to change these values. <br><br>  Flask uses the <code>logging</code> module from the standard Python library, so setting up sending error messages to mail will be quite simple <i>(file <code>app/__init__.py</code> )</i> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> basedir, ADMINS, MAIL_SERVER, MAIL_PORT, MAIL_USERNAME, MAIL_PASSWORD <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> app.debug: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> logging.handlers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SMTPHandler credentials = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> MAIL_USERNAME <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> MAIL_PASSWORD: credentials = (MAIL_USERNAME, MAIL_PASSWORD) mail_handler = SMTPHandler((MAIL_SERVER, MAIL_PORT), <span class="hljs-string"><span class="hljs-string">'no-reply@'</span></span> + MAIL_SERVER, ADMINS, <span class="hljs-string"><span class="hljs-string">'microblog failure'</span></span>, credentials) mail_handler.setLevel(logging.ERROR) app.logger.addHandler(mail_handler)</code> </pre><br><br>  We will send these letters only if the debug mode is turned off.  It's okay if you do not have a configured mail server.  For our purposes, the SMTP debug server, provided by Python, is quite suitable.  To start it, type in the console (or on the command line if you are a Windows user): <br><pre> <code class="bash hljs">python -m smtpd -n -c DebuggingServer localhost:25</code> </pre><br>  After that, all emails sent by the application will be intercepted and displayed directly in the console.  <i>(Note. You can also use an extremely convenient SMTP server that does not require special knowledge to configure - <a href="http://mailcatcher.me/">Mailcatcher</a> . This method is much more convenient, but it also requires installing Ruby.)</i> <br><br><h4>  Write log to file </h4><br>  Receiving error messages in the mail is great, but sometimes it is not enough.  In some cases, we will need to get more detailed information than the one that is in the traceback, and then we can use the ability to maintain a log file. <br><br>  The configuration process is very similar to what we just did for mail <i>(file <code>app/__init__.py</code> )</i> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> app.debug: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> logging <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> logging.handlers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> RotatingFileHandler file_handler = RotatingFileHandler(<span class="hljs-string"><span class="hljs-string">'tmp/microblog.log'</span></span>, <span class="hljs-string"><span class="hljs-string">'a'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) file_handler.setFormatter(logging.Formatter(<span class="hljs-string"><span class="hljs-string">'%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'</span></span>)) app.logger.setLevel(logging.INFO) file_handler.setLevel(logging.INFO) app.logger.addHandler(file_handler) app.logger.info(<span class="hljs-string"><span class="hljs-string">'microblog startup'</span></span>)</code> </pre><br><br>  The log will be saved in the <code>tmp</code> folder under the name <code>microblog.log</code> .  We used <code>RotatingFileHandler</code> , which allows us to set a limit on the amount of stored data.  In our case, the file size is limited to one megabyte, while the last ten files are saved. <br><br>  The class <code>logging.Formatter</code> provides the ability to set an arbitrary format of records in the log.  Since we want to receive as much detailed information as possible, we will save the message itself, the <a href="http://ru.wikipedia.org/wiki/Timestamp">timestamp</a> , the status of the record, as well as the file name and line number from which the recording was initiated. <br><br>  To make the log more useful, we reduce the logging level in both <code>app.logger</code> and <code>file_handler</code> , this will allow us to record not only errors, but also other information that may be useful.  For example, we will record the launch time of the application.  Now every time microblogging is launched without debug mode, this event will be saved to the log. <br><br>  Currently, we have no need to use, however, if our application runs on a remote web server, diagnostics and debugging will be difficult.  That is why you should take care in advance to get the information we need without stopping the server. <br><br><h4>  Error correction </h4><br>  So, let's finally fix a bug with the same nicknames. <br><br>  As mentioned earlier, we have two problem areas where there is no duplicate check.  The first is in the <code>after_login</code> handler, which is called when the user is authorized in the system and we need to create a new User object.  Here is what we can do to get rid of the problem: <i>(file <code>app/views.py</code> )</i> : <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: nickname = resp.nickname <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> nickname <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> nickname == <span class="hljs-string"><span class="hljs-string">""</span></span>: nickname = resp.email.split(<span class="hljs-string"><span class="hljs-string">'@'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] nickname = User.make_unique_nickname(nickname) user = User(nickname = nickname, email = resp.email, role = ROLE_USER) db.session.add(user) db.session.commit()</code> </pre><br><br>  Our solution is to instruct the User class to create a unique nickname.  Here is how it is implemented <i>( <code>app/models.py</code> )</i> : <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... @staticmethod def make_unique_nickname(nickname): if User.query.filter_by(nickname = nickname).first() == None: return nickname version = 2 while True: new_nickname = nickname + str(version) if User.query.filter_by(nickname = new_nickname).first() == None: break version += 1 return new_nickname # ...</span></span></code> </pre><br><br>  This method simply adds the counter to the nick until it becomes unique.  For example, if the user ‚Äúmiguel‚Äù already exists, the method will offer the option ‚Äúmiguel2‚Äù, then, if there is such a user, ‚Äúmiguel3‚Äù and so on.  Pay attention to the <a href="http://docs.python.org/library/functions.html">staticmethod</a> decorator, we applied it, since this operation is not tied to a specific instance of the class. <br><br>  The second place where the problem of duplicates is still relevant is the profile editing page.  In this case, everything is somewhat complicated by the fact that the user himself chooses his nickname.  The best solution in this case will be to check for uniqueness and in case of failure the proposal to choose another nickname.  To do this, we need to add another validator for the corresponding field.  If the user enters an existing nickname, the form simply does not pass validation.  To add your validator, you must <i><code>app/forms.py</code></i> <code>validate</code> method <i>(file <code>app/forms.py</code> )</i> : <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> User <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EditForm</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Form)</span></span></span><span class="hljs-class">:</span></span> nickname = TextField(<span class="hljs-string"><span class="hljs-string">'nickname'</span></span>, validators = [Required()]) about_me = TextAreaField(<span class="hljs-string"><span class="hljs-string">'about_me'</span></span>, validators = [Length(min = <span class="hljs-number"><span class="hljs-number">0</span></span>, max = <span class="hljs-number"><span class="hljs-number">140</span></span>)]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, original_nickname, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> Form.__init__(self, *args, **kwargs) self.original_nickname = original_nickname <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> Form.validate(self): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.nickname.data == self.original_nickname: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> user = User.query.filter_by(nickname = self.nickname.data).first() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: self.nickname.errors.append(<span class="hljs-string"><span class="hljs-string">'This nickname is already in use. Please choose another one.'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre><br><br>  The form constructor now accepts a new argument, <code>original_nickname</code> .  The <code>validate</code> method uses it to determine if the nickname has changed or not.  If it has changed, we check for uniqueness. <br><br>  We initialize the form with a new argument: <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/edit', methods = ['GET', 'POST']) @login_required def edit(): form = EditForm(g.user.nickname) # ...</span></span></code> </pre><br><br>  We also need to display all errors that occur during form validation, next to the field in which an error was detected.  <i>(file <code>app/templates/edit.html</code> )</i> : <br><br><pre> <code class="python hljs">&lt;td&gt;Your nickname:&lt;/td&gt; &lt;td&gt; {{form.nickname(size = <span class="hljs-number"><span class="hljs-number">24</span></span>)}} {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> form.errors.nickname %} &lt;br&gt;&lt;span style=<span class="hljs-string"><span class="hljs-string">"color: red;"</span></span>&gt;[{{error}}]&lt;/span&gt; {% endfor %} &lt;/td&gt;</code> </pre><br><br>  That's it, the duplicate problem is solved!  True, we still have a potential problem with simultaneous access to a database from several threads or processes, but this topic will be covered in one of the future articles. <br><br>  Now you can try again to change the nickname to the existing one and make sure that the problem is no more. <br><br><h4>  Testing framework </h4><br>  With the development of the application, it is becoming increasingly difficult to verify that changes in the code will not break the existing functionality.  That is why it is so important to automate the testing process. <br><br>  The traditional approach to testing is quite good.  You write tests to test all the capabilities of the application.  Periodically, during the development process, you will need to run these tests to make sure everything is still stable.  The wider the coverage of the tests, the more you can be sure that everything is in order. <br><br>  Let's write a small framework for testing using the <code>unittest</code> module <i>( <code>app/tests.py</code> )</i> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!flask/bin/python import os import unittest from config import basedir from app import app, db from app.models import User class TestCase(unittest.TestCase): def setUp(self): app.config['TESTING'] = True app.config['CSRF_ENABLED'] = False app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///' + os.path.join(basedir, 'test.db') self.app = app.test_client() db.create_all() def tearDown(self): db.session.remove() db.drop_all() def test_avatar(self): u = User(nickname = 'john', email = 'john@example.com') avatar = u.avatar(128) expected = 'http://www.gravatar.com/avatar/d4c74594d841139328695756648b6bd6' assert avatar[0:len(expected)] == expected def test_make_unique_nickname(self): u = User(nickname = 'john', email = 'john@example.com') db.session.add(u) db.session.commit() nickname = User.make_unique_nickname('john') assert nickname != 'john' u = User(nickname = nickname, email = 'susan@example.com') db.session.add(u) db.session.commit() nickname2 = User.make_unique_nickname('john') assert nickname2 != 'john' assert nickname2 != nickname if __name__ == '__main__': unittest.main()</span></span></code> </pre><br><br>  The <code>unittest</code> module <code>unittest</code> is beyond the scope of this article.  If you are not familiar with this module, for now you can simply assume that our tests are in the <code>TestCase</code> class.  The <code>setUp</code> and <code>tearDown</code> have a special meaning; they are performed before and after each test, respectively.  In more complex cases, several test groups can be defined, where each group is a subclass of <code>unittest.TestCase</code> , then each group will have its own <code>setUp</code> and <code>tearDown</code> . <br><br>  In our case, there is no need for any complex actions before and after the test.  In <code>setUp</code> , the application configuration changes slightly.  For example, we use a separate database for testing.  In the <code>tearDown</code> method <code>tearDown</code> we clear the database. <br><br>  Tests are implemented as methods that should call some function of our application and compares the result of its execution with the intended one.  If the results do not match, the test is considered failed. <br><br>  So, we have two tests in our framework.  The first one checks the URL of the avatar that we implemented in the last chapter.  The second test checks the <code>make_unique_nickname</code> method we just wrote for the User class.  First a user is created with the name 'john'.  After it is stored in the database, the method under test should return a nickname other than 'john'.  Then we create and save the second user with the proposed nickname and check that another call to <code>make_unique_nickname</code> will return a name that is different from the names of both created users. <br><br>  Let's start testing: <br><br><pre> <code class="hljs">./tests.py</code> </pre><br><br>  If any errors are encountered, they will be displayed in the console. <br><br><h4>  Final words </h4><br>  This concludes our discussion of debugging, bugs and testing.  Hope you enjoyed this article.  As always, if you have any questions, ask them in the comments. <br><br>  The current microblog code can be downloaded from the following link: <br>  Download <a href="">microblog-0.7.zip</a> <br><br>  As always, the virtual environment and database are missing.  The process of their creation is described in previous articles. <br><br>  See you again! <br><br>  Miguel </div><p>Source: <a href="https://habr.com/ru/post/223783/">https://habr.com/ru/post/223783/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223769/index.html">Keyword volatile and time attack</a></li>
<li><a href="../223771/index.html">Dauria gets involved in a large microsatellite race</a></li>
<li><a href="../223773/index.html">Add gas: + 200% performance</a></li>
<li><a href="../223777/index.html">Our checklist for forms on sites</a></li>
<li><a href="../223779/index.html">Guinea pig, or one of the domestic production of MK</a></li>
<li><a href="../223785/index.html">The history of amperca</a></li>
<li><a href="../223789/index.html">(Kiev) May 26-27 seminar: Basic HP ProLiant skills from TC MUK</a></li>
<li><a href="../223791/index.html">Film-film-film! MadRobots # 1 Gadgets Video Review</a></li>
<li><a href="../223793/index.html">CLRium: mini-conference on nut.Net in St. Petersburg</a></li>
<li><a href="../223795/index.html">OpenStack and VMware: when Pets and Cattle servers work together</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>