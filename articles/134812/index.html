<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reddwarf to create a Java server using the example of the online game Stone-Scissors-Paper: Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the article RedDwarf - server platform for developing online games in Java, I told about the features of this platform for creating game servers. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reddwarf to create a Java server using the example of the online game Stone-Scissors-Paper: Server</h1><div class="post__text post__text-html js-mediator-article"><img align="right" src="https://habrastorage.org/storage2/4df/25f/10a/4df25f10a40f052334548b71bcb0dd40.jpg">  In the article <a href="http://habrahabr.ru/blogs/gdev/129174/">RedDwarf - server platform for developing online games in Java,</a> I told about the features of this platform for creating game servers.  In this article I will try to show with an example how to write a server and using RedDwarf. <br>  As an example, it was decided to write an online implementation of the game "Stone-Scissors-Paper". <br>  In this article we will write a server and try to start it.  In the <a href="http://habrahabr.ru/blogs/gdev/138039/">next article</a> we will write a small client for this server and check their performance. <br><a name="habracut"></a><br><br><h4>  Preparation for work </h4><br>  First you need to download the Reddwarf server in the sgs-server-dist-0.10.2.zip archive <a href="http://sourceforge.net/projects/reddwarf/files/0.10.2/sgs-server-dist-0.10.2.zip/download">from here</a> and unpack the contents into the sgs-server-dist-0.10.2 folder. <br><br><h4>  Creating a project </h4><br>  Create a project in your favorite development environment. <br>  The project will be simple, so we will not use maven. <br>  For development, the sgs-server-api-0.10.2.jar library is required from the sgs-server-dist-0.10.2 \ lib \ directory. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Create a folder META-INF, it should contain the manifest file MANIFEST.MF.  Without it, the platform refuses to work with the project jar file.  My file contains only one line: <br>  Manifest-Version: 1.0 <br><br>  Also in the folder META-INF, you must create the file app.properties.  This file contains server startup settings.  For our project, the file contains the following properties: <br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  .        com.sun.sgs.app.name=RockPaperScissors # ,   AppListener      com.sun.sgs.app.listener=hello.reddwarf.server.Server #  ,        com.sun.sgs.app.root=data</span></span></code> </pre> <br>  This is the minimum required set of options.  The following properties may still be useful during development: <br><ul><li>  <b><i>com.sun.sgs.impl.transport.tcp.listen.port</i></b> - the port on which the server listens (by default 62964) </li><li>  <b><i>com.sun.sgs.app.authenticators</i></b> - the names of the classes responsible for authentication (the authentication process is derived from the game logic and can be run by an independent module) </li><li>  <b><i>com.sun.sgs.impl.service.session.allow.new.login</i></b> - whether to allow already connected players to connect from another client.  If true, then the one who is now in the game throws out.  If false, do not allow to connect from another client. </li></ul><br>  More information about other properties can be found in the <a href="http://www.reddwarfserver.org/javadoc/current/server-all/com/sun/sgs/impl/kernel/doc-files/config-properties.html">documentation</a> . <br><br><h4>  Game architecture </h4><br>  The game will require the following entities. <br>  <b>Server</b> is a class that stores a list of players online and handles their connection. <br>  <b>Player</b> - is a player.  The player has the following attributes: name (it is a login) and the number of points.  May participate in the battle. <br>  <b>Battle</b> is a battle.  This object is waiting for answers from the players and determining the winner.  Keeps references to two players. <br>  <b>Weapon</b> - a simple listing of weapons: directly stone, scissors and paper. <br><br>  If you depict it as a class diagram, you get this: <br><img src="https://habrastorage.org/storage2/890/403/e13/890403e13cf28925fe367f91060c0ac0.png"><br><br>  All game entities (except for Weapon), while the server is running, are stored in an internal database that provides transactionality, link to each other, so they must implement the java.io.Serializable and com.sun.sgs.app.ManagedObject interfaces. <br><br><h5>  Class server.  Player initialization and connection </h5><br>  The Server class is the starting point of the server, so it must implement the com.sun.sgs.app.AppListener interface: <br><br>  <code>void initialize(Properties props)</code> is called when the server is first started.  It fills the internal database with the initial values ‚Äã‚Äãnecessary for the operation.  An important feature: if the server is stopped (or killed) and then restarted, this method <i>will not be</i> called, since  The internal database is stored between server launches and allows you to continue working from the moment you stop. <br><br>  <code>ClientSessionListener loggedIn(ClientSession session)</code> is called after successful authentication and must return an object that represents the player.  In our example, this will be Player. <br><br>  All players connected to the server will be stored in a special collection.  In Reddwarf, for game entities there is a special collection called ScalableHashMap.  The advantages of this collection are that with changes it is blocked (meaning the lock in the internal database) is not entirely, but partially.  And in the Server object we will not store the collection itself, but a link to it (ManagedReference). <br><br>  Moving from words to deeds, we get the following code: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello.reddwarf.server; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.util.ScalableHashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Properties; <span class="hljs-comment"><span class="hljs-comment">/** *  .     , *        . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Server</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppListener</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ManagedReference&lt;ScalableHashMap&lt;String, Player&gt;&gt; onlinePlayersRef; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Properties props)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      ScalableHashMap&lt;String, Player&gt; onlinePlayers = new ScalableHashMap&lt;String, Player&gt;(); onlinePlayersRef = AppContext.getDataManager().createReference(onlinePlayers); } @Override public ClientSessionListener loggedIn(ClientSession session) { String name = session.getName(); //  .      ,    Player player = loadOrRegister(name); //   .  -  ,    //   -     player.setSession(session); //    ,    player.connected(); //     - onlinePlayersRef.get().put(player.name, player); return player; } }</span></span></code> </pre><br><br>  DataManager is used to work with the database, which allows you to write to the database, read from the database and create ManagedReference references.  Since the database is a key-value repository, the player‚Äôs name with the prefix ‚Äúplayer.‚Äù Is used as the key, the entire Player object is serialized to the value.  Let's write the function of loading the player from the database (if the player is not found in the database, create it). <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Player </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadOrRegister</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Player) AppContext.getDataManager().getBindingForUpdate(<span class="hljs-string"><span class="hljs-string">"player."</span></span> + name); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NameNotBoundException e) { <span class="hljs-comment"><span class="hljs-comment">//       - //   ,       Player player = new Player(name, this); AppContext.getDataManager().setBinding("player." + name, player); return player; } }</span></span></code> </pre><br><br><h5>  Player class and protocol </h5><br>  It was the turn to create a class Player.  This class represents the player and receives notification of incoming messages from the platform.  So, it's time to talk about the protocol.  Reddwarf allows you to work with incoming and outgoing messages as an array of bytes, leaving the implementation of the protocol to the discretion of the game developer.  For the game "Stone-scissors-paper" we will use a simple text protocol. <br><br>  (server -&gt; client) <b>SCORE &lt;number&gt;</b> - the server tells the player the number of points <br>  (client -&gt; server) <b>PLAY</b> - the player's request to start the game <br>  (server -&gt; client) <b>BATLE &lt;name&gt;</b> - the battle with the specified player has started <br>  (server -&gt; client) <b>ERROR</b> - the player for the battle was not found (no one on the server or all in the battle) <br>  (client -&gt; server) <b>ROCK</b> - the player says "Stone" <br>  (client -&gt; server) <b>SCISSORS</b> - the player says ‚ÄúScissors‚Äù <br>  (client -&gt; server) <b>PAPER</b> - the player says "Paper" <br>  (server -&gt; client) <b>DRAW</b> - draw <br>  (server -&gt; client) <b>WON</b> - player won <br>  (server -&gt; client) <b>LOST</b> - player lost <br><br>  From the protocol, one can understand the sequence of actions and capabilities of the player, so we will not dwell on this separately. <br><br>  You can encode text into bytes and back with this code: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello.reddwarf.server; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.ByteBuffer; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Messages</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ByteBuffer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encodeString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ByteBuffer.wrap(s.getBytes()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ByteBuffer message)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[message.remaining()]; message.get(bytes); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(bytes); } }</code> </pre><br><br>  Now we are going to write the player object. <br>  The player will keep the following fields: <br><ul><li>  name </li><li>  number of points </li><li>  link to the server (to have access to the list of online players) </li><li>  link to the session (to send messages to the client) </li><li>  reference to the battle (if the player is in the battle now, otherwise null) </li></ul><br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello.reddwarf.server; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.util.ScalableHashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.ByteBuffer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedObject</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientSessionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Random random = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> score; <span class="hljs-comment"><span class="hljs-comment">//   ,        private ManagedReference&lt;ClientSession&gt; sessionRef; //        - private ManagedReference&lt;Server&gt; serverRef; //    .      -    null private ManagedReference&lt;Battle&gt; battleRef; public Player(String name, Server server) { this.name = name; serverRef = AppContext.getDataManager().createReference(server); score = 0; } @Override public void receivedMessage(ByteBuffer byteBuffer) { //          String message = Messages.decodeString(byteBuffer); if (message.equals("PLAY")) { play(); } else if (message.equals("ROCK")) { answer(Weapon.ROCK); } else if (message.equals("PAPER")) { answer(Weapon.PAPER); } else if (message.equals("SCISSORS")) { answer(Weapon.SCISSORS); } } @Override public void disconnected(boolean b) { serverRef.get().disconnect(this); } private void answer(Weapon weapon) { if (battleRef != null) { battleRef.getForUpdate().answer(this, weapon); } } private void play() { logger.info("Choosing enemy for "+name); //          Player target = getRandomPlayer(); if (target != null &amp;&amp; target.battleRef == null) { Battle battle = new Battle(this, target); this.sessionRef.get().send(Messages.encodeString("BATTLE " + target.name)); target.sessionRef.get().send(Messages.encodeString("BATTLE " + this.name)); target.battleRef = AppContext.getDataManager().createReference(battle); this.battleRef = target.battleRef; battle.start(); } else { this.sessionRef.get().send(Messages.encodeString("ERROR")); } } /** *    (  ) *     ,  null * @return    null,    */ private Player getRandomPlayer() { ScalableHashMap&lt;String,Player&gt; onlineMap = serverRef.get().onlinePlayersRef.get(); Set&lt;String&gt; namesSet = new HashSet&lt;String&gt;(onlineMap.keySet()); namesSet.remove(name); if (namesSet.isEmpty()) { return null; } else { ArrayList&lt;String&gt; namesList = new ArrayList&lt;String&gt;(namesSet); String randomName = namesList.get(random.nextInt(namesList.size())); return onlineMap.get(randomName); } } public void connected() { //      ,     sessionRef.get().send(Messages.encodeString("SCORE " + score)); } /** *  ,      */ public void battleResult(Battle.Result result) { switch (result) { case DRAW: score+=1; sessionRef.get().send(Messages.encodeString("DRAW")); break; case WON: score+=2; sessionRef.get().send(Messages.encodeString("WON")); break; case LOST: sessionRef.get().send(Messages.encodeString("LOST")); break; } sessionRef.get().send(Messages.encodeString("SCORE " + score)); battleRef = null; } public void setSession(ClientSession session) { sessionRef = AppContext.getDataManager().createReference(session); } }</span></span></code> </pre><br><br><h5>  Classes Weapon and Battle </h5><br>  The list of Weapon is very simple and does not require comments. <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello.reddwarf.server; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Weapon { ROCK, PAPER, SCISSORS; boolean beats(Weapon other) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> != other &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ordinal() == (other.ordinal() + <span class="hljs-number"><span class="hljs-number">1</span></span>) % values().length; } }</code> </pre><br><br>  Go to the battle. <br><br>  The battle has a unique identifier, contains links to two players, the answers given by them, as well as an active flag. <br><br>  As soon as the battle is created, a separate task is launched, which will end the battle in 5 seconds. <br>  After this time, the battle is summed up.  If the answer was given only by one of the players, then he is considered the winner, if both are, the winner is determined according to the usual rules of ‚ÄúRock-paper-scissors‚Äù. <br><br>  The task is executed using the TaskManager service, which can be obtained using AppContext.getTaskManager ().  This manager allows you to run tasks performed in a separate transaction either immediately, or after a specified period of time, or periodically.  As it should be expected, all tasks are also stored in the internal database, which means they will be executed after the server is restarted. <br><br>  So, the class code Battle. <br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello.reddwarf.server; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.AppContext; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.ManagedObject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.ManagedReference; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.sgs.app.Task; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.atomic.AtomicInteger; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Battle</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedObject</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serializable { //   5  private static final long BATTLE_TIME_MS = 5000; enum Result { DRAW</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WON</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LOST } private boolean active; private ManagedReference</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Player</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">starterPlayerRef</span></span></span><span class="hljs-class">; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManagedReference</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Player</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invitedPlayerRef</span></span></span><span class="hljs-class">; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Weapon</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">starterWeapon</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Weapon</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invitedWeapon</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Battle</span></span></span></span>(Player starterPlayer, Player invitedPlayer) { starterPlayerRef = AppContext.getDataManager().createReference(starterPlayer); invitedPlayerRef = AppContext.getDataManager().createReference(invitedPlayer); active = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** *  . *  ,  BATTLE_TIME_MS    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void start(){ active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; AppContext.getTaskManager().scheduleTask(new BattleTimeout(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), BATTLE_TIME_MS); } <span class="hljs-comment"><span class="hljs-comment">/** *    . *  ,  . * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> player -  * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> weapon -   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void answer(Player player, Weapon weapon){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (active) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (player.name.equals(starterPlayerRef.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().name)) { starterWeapon = weapon; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { invitedWeapon = weapon; } } } <span class="hljs-comment"><span class="hljs-comment">/** *  . *  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> void finish() { active = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Player starterPlayer = starterPlayerRef.getForUpdate(); Player invitedPlayer = invitedPlayerRef.getForUpdate(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (starterWeapon != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; starterWeapon.beats(invitedWeapon)) { starterPlayer.battleResult(Result.WON); invitedPlayer.battleResult(Result.LOST); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (invitedWeapon != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; invitedWeapon.beats(starterWeapon)) { invitedPlayer.battleResult(Result.WON); starterPlayer.battleResult(Result.LOST); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { starterPlayer.battleResult(Result.DRAW); invitedPlayer.battleResult(Result.DRAW); } AppContext.getDataManager().removeObject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * ,      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BattleTimeout</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializable</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Task { private ManagedReference</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Battle</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">battleRef</span></span></span><span class="hljs-class">; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BattleTimeout</span></span></span></span>(Battle battle) { battleRef = AppContext.getDataManager().createReference(battle); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> void run() throws Exception { battleRef.getForUpdate().finish(); } } }</code> </pre><br><br>  When reading this code, the question may arise: ‚ÄúWhy is the internal class BattleTimeout made static and keeps the reference to battle explicitly?  You can also declare it non-static and access the Battle fields directly. ‚Äù <br>  The fact is that a non-static inner class will keep the link to the parent Battle implicitly and access Battle through it.  But the features of the Reddwarf platform (transactional) prohibit accessing a ManagedObject (which is Battle) from another transaction directly: in this case, an exception will be thrown, because  direct reference to an object in another transaction is incorrect.  The recommendation of the creators of the platform to use only static inner classes is connected with this. <br><br>  Separately, I would like to mention getting a managed object by reference. <br>  The above code for the ManagedReference uses both the get () method and the getForUpdate () method. <br>  In principle, only get () can be used.  Using getForUpdate () allows the server to know before the completion of a transaction which objects will be changed and, if there are conflicting transactions, cancel the task a little earlier.  This gives some speed gain compared to using get (). <br><br>  Finally our server is almost ready. <br>  Add a bit of logging (for simplicity, use java.util.logging) and you can build the project. <br>  As a result of the build, we need to get a jar file, say, deploy.jar. <br>  If you don‚Äôt want to build it all by hand, you can get a ready file deploy.jar <a href="">from here</a> . <br>  This file must be placed in sgs-server-dist-0.10.2 \ dist. <br>  Now, being in the sgs-server-dist-0.10.2 directory, execute the following command: <br><pre> <code class="bash hljs">java -jar bin/sgs-boot.jar</code> </pre> <br><br>  As a result, the following can be seen in the console: <br><pre> <code class="bash hljs"> 02, 2012 9:45:19 PM com.sun.sgs.impl.kernel.Kernel &lt;init&gt; INFO: The Kernel is ready, version: 0.10.2.1  02, 2012 9:45:19 PM com.sun.sgs.impl.service.data.store.DataStoreImpl &lt;init&gt; INFO: Creating database directory : C:\sgs-server-dist-0.10.2.1\data\dsdb  02, 2012 9:45:19 PM com.sun.sgs.impl.service.watchdog.WatchdogServerImpl registerNode INFO: node:com.sun.sgs.impl.service.watchdog.NodeImpl[1,health:GREEN,backup:(none)]@black registered  02, 2012 9:45:19 PM hello.reddwarf.server.Server initialize INFO: Starting new Rock-Paper-Scissors Server. Initialized database.  02, 2012 9:45:19 PM com.sun.sgs.impl.kernel.Kernel startApplication INFO: RockPaperScissors: application is ready</code> </pre> <br><br>  Hooray!  The server has started!  Now you can do the client: <br>  <a href="http://habrahabr.ru/blogs/gdev/138039/">Reddwarf on the example of the online game "Stone-Scissors-Paper": Client</a> <br><br><h4>  Links </h4><br>  <a href="http://www.reddwarfserver.org/javadoc/current/server-api/">Javadoc on server API</a> <br>  <a href="http://sourceforge.net/apps/trac/reddwarf/wiki/Documentation">Community Documentation</a> <br>  <a href="http://sourceforge.net/apps/phpbb/reddwarf/index.php">Project Forum</a> </div><p>Source: <a href="https://habr.com/ru/post/134812/">https://habr.com/ru/post/134812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134807/index.html">Meridian - Metro style music player for Vkontakte</a></li>
<li><a href="../134808/index.html">KLM Royal Dutch Airlines allows you to choose your neighbor on Facebook</a></li>
<li><a href="../134809/index.html">Amazon sells a million Kindle every week.</a></li>
<li><a href="../134810/index.html">Unfair Torrent Client for Mac</a></li>
<li><a href="../134811/index.html">Open Source Project Manager at Google: mobile antivirus software is useless</a></li>
<li><a href="../134813/index.html">A bit about the "underwater satellite constellation"</a></li>
<li><a href="../134814/index.html">ZAGG Keyboard Case for Galaxy Tab 10.1</a></li>
<li><a href="../134817/index.html">TPoDT keygenme analysis # 2</a></li>
<li><a href="../134818/index.html">Kiri</a></li>
<li><a href="../134819/index.html">XNA Draw: write deferred lighting to three sources using a shader</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>