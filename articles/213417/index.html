<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Smart video player or just gesture recognition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 This article focuses on the recognition of gestures. I believe that this topic is very relevant today, because this method of entering ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Smart video player or just gesture recognition</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  This article focuses on the recognition of gestures.  I believe that this topic is very relevant today, because this method of entering information is more convenient for a person.  In YouTube you can see a lot of clips about recognition, tracking of objects, there are also articles on this topic in Habr√©, so I decided to experiment and make something of my own, useful and necessary.  I decided to make a video player that can be controlled by gestures, because sometimes I am too lazy to take up the mouse, find this slider and rewind a little bit forward or a little back, especially when I watch movies in a foreign language (I often have to rewind there) . <br><br>  In the article, basically, we will talk about how I implemented gesture recognition, and I‚Äôll only talk about the video player in general. <br><a name="habracut"></a><br><h4>  So what do we want? </h4><br>  We want to be able to give the following commands using gestures: <br><ol><li>  Fast forward / rewind </li><li>  Pause / continue </li><li>  Add / subtract sound </li><li>  Next / previous track. </li></ol><br>  Let's compare the listed actions with gestures: <br><ol><li>  Left to right / right to left </li><li>  Movement from the center upwards to the right. </li><li>  Bottom up / top down </li><li>  Movement from the center down-right / from the center down-left </li></ol><br>  Watch gestures through the webcam.  I have a built-in 0.3 megapixel camera on my laptop.  It is weak, but with good lighting, it can also be used for such purposes.  But I will use an external usb camera.  We will show gestures with some monochromatic stick, because we will select it from the background by filtering by color.  For example, we will use an ordinary pencil as such a subject.  Of course, this is not the best way to recognize a subject, but I wanted to focus on the recognition of a gesture (movement), and not the subject in the figure. <br><br><h4>  Instruments </h4><br>  I will use Qt framework 5.2 as the development environment.  To handle the stream of video from the webcam I will use OpenCV 4.6.  The GUI will be completely in QML, and the recognition block will be in C ++. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Both tools are open source, both are cross-platform.  I developed the player for Linux, but it can be transferred to any other platform, you only need to compile OpenCV with Qt support for the required platform and recompile, rebuild the player.  I tried to transfer the player to Windows, but I could not compile OpenCV with Qt support for it.  Who will try and who succeeds, please share the manual or binary. <br><br><h4>  Player structure </h4><br>  The figure below shows the structure of the player.  The player works in two streams.  The main stream is a GUI and video player.  In a separate stream, a recognition block is placed in order to prevent the interface from hanging and video playback.  I wrote the interface in QML, the player logic I wrote in JS, and the recognition block in C ++ (it is clear to everyone why).  The player "communicates" with the recognition unit using signals and slots.  I made a wrapper for the class of recognition in order to facilitate the division of the application into 2 streams.  In fact, the wrapper is in the main thread (that is, not as shown in the figure).  The wrapper creates an instance of the recognition class and places it in a new, additional stream.  Actually, everything about the player, I will continue to talk about recognition and lead code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d25/08e/6d6/d2508e6d6e955d5ed07962d4907e7075.png"><br><br><h4>  Recognition </h4><br>  In order to recognize, we will collect frames and process them with the methods of probability theory.  We will collect twenty frames per second (more webcam does not allow).  We will process ten frames. <br><br>  Algorithm: <br><ol><li>  get a frame from the webcam and send it to the filter; </li><li>  the filter returns a binary image to us, where only a pencil in the form of a white rectangle on a black background is depicted; </li><li>  The binary image is sent to the analyzer, where pencil vertices are calculated.  The top vertex is entered into the array. </li><li>  if the array has reached a size of 10 elements, then this array is sent to a probabilistic analyzer, where the analysis of a sequence of pairs of numbers using the least squares method. </li><li>  if the analysis has recognized any command, then this command is sent to the video player. </li></ol><br><br>  I will give only 3 basic recognition functions. <br><br>  The following function monitors the camera if gesture control is enabled: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MotionDetector::observCam() { m_cap &gt;&gt; m_frame; <span class="hljs-comment"><span class="hljs-comment">//     filterIm(); //    detectStick(); // ,      drawStick(m_binIm); //    showIms(); //    }</span></span></code> </pre> <br><br>  This is how the recognition function looks like: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> MotionDetector::detectStick() { m_contours.clear(); cv::findContours(m_binIm.clone(), m_contours, cv::RETR_EXTERNAL, cv::CHAIN_APPROX_SIMPLE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_contours.empty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> stickFound = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; m_contours.size(); ++i) { <span class="hljs-comment"><span class="hljs-comment">//    ,    if(cv::contourArea(m_contours[i]) &lt; m_arAtThreshold) continue; //    m_stickRect = cv::minAreaRect(m_contours[i]); cv::Point2f vertices[4]; cv::Point top; cv::Point bottom; m_stickRect.points(vertices); if (lineLength(vertices[0], vertices[1]) &gt; lineLength(vertices[1], vertices[2])){ top = cv::Point((vertices[1].x + vertices[2].x) / 2., (vertices[1].y + vertices[2].y) / 2.); bottom = cv::Point((vertices[0].x + vertices[3].x) / 2., (vertices[0].y + vertices[3].y) / 2.); } else{ top = cv::Point((vertices[0].x + vertices[1].x) / 2., (vertices[0].y + vertices[1].y) / 2.); bottom = cv::Point((vertices[2].x + vertices[3].x) / 2., (vertices[2].y + vertices[3].y) / 2.); } if (top.y &gt; bottom.y) qSwap(top, bottom); m_stick.setTop(top); m_stick.setBottom(bottom); stickFound = true; } //   switch (m_state){ case ST_OBSERVING: if (!stickFound){ m_state = ST_WAITING; m_pointSeries.clear(); break; } m_pointSeries.append(QPair&lt;double, double&gt;(m_stick.top().x, m_stick.top().y)); if (m_pointSeries.size() &gt;= 10){ m_actionPack = m_pSeriesAnaliser.analize(m_pointSeries); if (!m_actionPack.isEmpty()){ emit sendAction(m_actionPack); } m_pointSeries.clear(); } break; case ST_WAITING: m_state = ST_OBSERVING; break; } }</span></span></code> </pre><br><br>  You can read about the least squares method <a href="http://www.testent.ru/publ/studenty/vysshaja_matematika/linejnaja_regressija_ispolzovanie_metoda_naimenshikh_kvadratov_mnk/35-1-0-1149">here</a> .  Now I will show how I implemented it.  Below is a probabilistic analyzer series. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> SeriesAnaliser::linerCheck(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> QVector&lt;QPair&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt; &gt; &amp;source) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = source.size(); <span class="hljs-comment"><span class="hljs-comment">//    2  ,   . QVector&lt;double&gt; x(count); QVector&lt;double&gt; y(count); for (int i = 0; i &lt; count; ++i){ x[i] = source[i].first; y[i] = source[i].second; } double zX, zY, zX2, zXY; // z -   . zX -  x-  .. QVector&lt;double&gt; yT(count); //   zX = 0; for (int i = 0; i &lt; count; ++i) zX += x[i]; zY = 0; for (int i = 0; i &lt; count; ++i) zY += y[i]; zX2 = 0; for (int i = 0; i &lt; count; ++i) zX2 += x[i] * x[i]; zXY = 0; for (int i = 0; i &lt; count; ++i) zXY += x[i] * y[i]; //    double a = (count * zXY - zX * zY) / (count * zX2 - zX * zX); double b = (zX2 * zY - zX * zXY) / (count * zX2 - zX * zX); //   y for (int i = 0; i &lt; count; ++i) yT[i] = x[i] * a + b; double dif = 0; for (int i = 0; i &lt; count; ++i){ dif += qAbs(yT[i] - y[i]); } if (a == 0) a = 10; #ifdef QT_DEBUG qDebug() &lt;&lt; QString("%1x+%2").arg(a).arg(b); qDebug() &lt;&lt; dif; #endif //   &gt; vBorder,  ,  ,   //    epsilan,  ,  ,   //  oblMovMin &lt; a &lt; oblMovMax,  ,  ,   //    0.6,  ,  ,   //  a &lt; horMov,  ,  ,  . int vBorder = 3; int epsilan = 50; double oblMovMin = 0.5; double oblMovMax = 1.5; double horMov = 0.2; //    ,   if (qAbs(a) &lt; vBorder &amp;&amp; dif &gt; epsilan) return false; //   double msInFrame = 1000 / s_fps; double dTime = msInFrame * count; // ms double dDistance; // px double speed = 0; /*px per ser*/ if (qAbs(a) &lt; vBorder) dDistance = x[count - 1] - x[0]; //    else dDistance = y[count -1] - y[0]; speed = dDistance / dTime; //px per //    ,  if (qSqrt(qPow(x[0] - x[count - 1], 2) + qPow(y[0] - y[count - 1], 2)) &lt; 15){ return false; } //    . if (speed &gt; 0.6) return false; //   if (qAbs(a) &gt; oblMovMin &amp;&amp; qAbs(a) &lt; oblMovMax){ //  if (a &lt; 0){ //   s_actionPack = "next"; } else{ if (speed &lt; 0) s_actionPack = "play"; else //   s_actionPack = "previous"; } } else if (qAbs(a) &lt; horMov) { s_actionPack = QString("rewind %1").arg(speed * -30000); } else if (qAbs(a) &gt; vBorder){ s_actionPack = QString("volume %1").arg(speed * -1); } else return false; return true; }</span></span></code> </pre><br><br>  The following code snippet takes the recognized action (on the video player side): <br><br><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">executeComand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">comand</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comandList = comand.split(<span class="hljs-string"><span class="hljs-string">' '</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(comand); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (comandList[<span class="hljs-number"><span class="hljs-number">0</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"next"</span></span>: nextMedia(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"previous"</span></span>: previousMedia(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"play"</span></span>: playMedia(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"rewind"</span></span>: mediaPlayer.seek(mediaPlayer.position + <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(comandList[<span class="hljs-number"><span class="hljs-number">1</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"volume"</span></span>: mediaPlayer.volume += <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(comandList[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br><br>  Yes, I almost forgot, the pencil then we stand out from the background in color, and this needs to be set up somewhere.  I solved the problem as follows: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b80/b49/ce2/b80b49ce20a7ac07d6e45f4570ef2aa3.png"><br><br>  That is, we can adjust any color at any consecration, and save this color in the menu so that we can immediately use it without setting. <br><br>  Here are the results I got: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/U5v1AchAM0o%3Ffeature%3Doembed&amp;xid=25657,15700023,15700186,15700190,15700253&amp;usg=ALkJrhhsLGOlx-4NYJHzD0PR_c8hyH47JQ" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Conclusion </h4><br>  Now the video player can recognize very simple gestures.  In my opinion, the most successful and convenient thing in the player is to rewind / forward gestures.  And it is this team that works most well and stably.  Although to watch the movie, gesture control will have to be adjusted a little, but then you can not search for a mouse to rewind a little bit backwards. <br><br>  PS: Who <a href="">cares</a> , here are the sources of <a href="">SmartVP</a> . <br>  PPS: I reused many colors, the most good (resistant to fast movements) turned out to be orange. </div><p>Source: <a href="https://habr.com/ru/post/213417/">https://habr.com/ru/post/213417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../213403/index.html">Applying a Poisson transform for seamless image overlay</a></li>
<li><a href="../213405/index.html">Weather station with Ethernet and tablet as a display device</a></li>
<li><a href="../213411/index.html">Unpacking, editing and packaging of DVR firmware and IP cameras from Xiong Mai</a></li>
<li><a href="../213413/index.html">The trouble with web security or the most secure bank of America</a></li>
<li><a href="../213415/index.html">Google Maps v2 for Android: Pop-up window with full redraw and input event support</a></li>
<li><a href="../213419/index.html">How Dropbox helped get a stolen phone back (detective)</a></li>
<li><a href="../213423/index.html">Side effect: we check Firebird with PVS-Studio</a></li>
<li><a href="../213425/index.html">Remote service block multifunction BDS-M</a></li>
<li><a href="../213427/index.html">Payler launched a new site</a></li>
<li><a href="../213429/index.html">Corporate portals and e-commerce: What to do?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>