<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Squid with HTTPS filtering without certificate spoofing, integration with Active Directory 2012R2 + WPAD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This manual was written in connection with the production need to monitor the traffic (http and https) of users, as well as the distribution of access...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Squid with HTTPS filtering without certificate spoofing, integration with Active Directory 2012R2 + WPAD</h1><div class="post__text post__text-html js-mediator-article">  This manual was written in connection with the production need to monitor the traffic (http and https) of users, as well as the distribution of access on white and black lists.  The articles were taken as a basis: <a href="http://habrahabr.ru/post/272733">this</a> and <a href="http://habrahabr.ru/post/267851">this one</a> , in which the <b>peek-n-splice</b> technology was used.  In these articles, the configuration assumes the use of a host with squid as a gateway; after configuring the config, a full-fledged proxy server is obtained with the ability to distribute access rights to groups from Active Directory.  Upon completion of the configuration, the question arose of transferring proxy server settings to users.  In view of the fact that in the office often laptops take home - the whole idea is at a standstill.  Initially, the option of issuing proxy server settings via DHCP was considered, but it is not the best, since offices in different subnets and different equipment, WPAD was the way out of this situation.  In short, this technology can be said that client machines on Windows OS are looking for a host named wpad.example.ru (up to third level domains) to request a settings file for networking.  Based on this principle, you need to raise the web server, which would just give the wpad.dat file. You can raise the web server on the host with the proxy server (as was done), and create a <i>cname</i> <b>wpad</b> on the proxy server in the DNS server .  It is better to use a proxy server with the ability to collect and view statistics, since the choice is sufficient.  In view of some conservative considerations, it was decided to choose SARG.  It is easy to set up, fairly acceptable statistics for an office with up to 100 employees. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Content</b> <div class="spoiler_text"><ul><li>  <a href="https://habr.com/ru/post/314918/">1. Introduction</a> <br><br><ul><li>  <a href="https://habr.com/ru/post/314918/">1.1 Simplified WPAD Workflow</a> <br></li><li>  <a href="https://habr.com/ru/post/314918/">1.2 Pros and cons of WPAD</a> </li><li>  <a href="https://habr.com/ru/post/314918/">1.3 Squid Peek-n-splice - how to it works</a> </li><li>  <a href="https://habr.com/ru/post/314918/">1.4 Pros and cons of Peek-n-splice</a> </li><li>  <a href="https://habr.com/ru/post/314918/">1.5 Required to solve the problem</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/314918/">2 Configuring the operating system and installing Squid</a> <br><br><ul><li>  <a href="https://habr.com/ru/post/314918/">2.1 Squid build options</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.2 Installing packages from official repositories</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.3 Manual installation of Squid and additional packages</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.4 Setting permissions on the swap directory for squid</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.5 squid configuration file</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.6 Configuring the / etc / hosts file</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.7 Customize selinux</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.8 Generate swap</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.9 Enabling the squid daemon, checking the configuration file</a> </li><li>  <a href="https://habr.com/ru/post/314918/">2.10 Traffic forwarding</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/314918/">3 Integration with Active Directory Domain Controller 2012R2</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <a href="https://habr.com/ru/post/314918/">3.1 Kerberos configuration</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.2 Creating DNS Records</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.3 Domain Integration Options</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.3.1 Integration by Windows</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.3.2 Linux integration</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.4 Recommended rights to the krb5.keytab file</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.5 Groups in Active Directory to adjust Internet access</a> </li><li>  <a href="https://habr.com/ru/post/314918/">3.6 Verification of authorization in Active Directory using the krb5.keytab file</a> <a href="https://habr.com/ru/post/314918/"><br></a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/314918/">4 WPAD</a> <br><br><ul><li>  <a href="https://habr.com/ru/post/314918/">4.1 Installing and configuring the apache2 web server</a> </li><li>  <a href="https://habr.com/ru/post/314918/">4.2 wpad.dat file</a> </li><li>  <a href="https://habr.com/ru/post/314918/">4.3 CNAME in DNS</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/314918/">5 Traffic Statistics</a> <br><br><ul><li>  <a href="https://habr.com/ru/post/314918/">5.1 Installing SARG from Source</a> </li><li>  <a href="https://habr.com/ru/post/314918/">5.2 Configuring SARG</a> </li><li>  <a href="https://habr.com/ru/post/314918/">5.3 Schedule of generating attendance reports</a> </li><li>  <a href="https://habr.com/ru/post/314918/">5.4 Web server configuration</a> </li><li>  <a href="https://habr.com/ru/post/314918/">5.5 Authorization on a site with statistics</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/314918/">6 Group Policy</a> <br><br><ul><li>  <a href="https://habr.com/ru/post/314918/">6.1 GPO Editing</a> </li></ul><br></li></ul></div></div><br><br><h3>  1.1 Simplified WPAD Workflow </h3><br>  - A client on Windows OS accesses a DNS server with a request to the host <b>wpad.example.com</b> , and the DNS server name corresponding entry indicates where to apply.  Next, the client requests wpad.example.ru with a request for a settings file.  Having received it, it begins to act accordingly to the instructions in it. <br><br><h3>  1.2 How good this technology is. </h3><br>  Pros: <br><br>  - there is no need through GPO to register all clients with a proxy address <br>  - Employee mobility (Internet access outside the office) <br>  - To disable the use of this technology, it is enough to disable in the "Properties of the browser" - "Automatically receive settings" <br><br>  Minuses: <br><br>  - ‚ÄúAutomatically receive settings‚Äù can be turned off by any user, so it‚Äôs better to leave this feature enabled and prevent it from being changed via GPO <br><br><h3>  1.3 Squid Peek-n-splice - how to it works </h3><br>  An employee is trying to access the site with https through a proxy.  When an encrypted connection is established, a ‚Äúgreeting‚Äù occurs, which is transmitted in open form, the proxy server intercepts it, and based on the configuration, squid allows or denies the connection.  Those.  intercepted to look at the "greeting", allowed or dropped a connection. <br><br><h3>  1.4 Pros and cons of Peek-n-splice </h3><br>  Pros: <br><br>  - This is not a MITM attack, and there will be no problems with bank clients <br>  - Display of domain names in the statistics of sites requested by https <br><br>  Minuses: <br><br>  - Unfortunately, it‚Äôs impossible to fully view which particular webpage was opened as during a MITM attack. <br>  - This configuration showed itself well only on CentOS (there were problems on Debian, after a while kernel-panic happened) <br><br><h3>  1.5 And so, now it is worth noting that it is given </h3><br>  - Host with Active Directory 2012R2 (user authorization method - Kerberos) 10.0.0.9 <br>  - Host with CentOS 7 (x64) (it's a web server for uploading wpad.dat, it's a proxy server) 10.0.0.10 <br>  - Test host with Windows OS to test operation 10.0.0.11 <br><blockquote>  "Let's go" Gagarin Yu.A. </blockquote><br><h3>  2 Configuring the operating system and installing Squid </h3><br>  The process of installing CentOS does not make sense to describe.  So let's keep in mind that we have a freshly installed CentOS 7 x64.  So, for Squid to work equally well with http and https traffic, you need the following: <br><br><h3>  2.1 Squid should be built with these parameters </h3><br><div class="spoiler">  <b class="spoiler_title">squid -v</b> <div class="spoiler_text">  $ squid -v <br>  Squid Cache: Version 3.5.16 <br>  Service Name: squid <br>  configure options: '--build = x86_64-redhat-linux-gnu' '--host = x86_64-redhat-linux-gnu' '--program-prefix =' '--prefix = / usr' '--exec- prefix = / usr '' --bindir = / usr / bin '' --sbindir = / usr / sbin '' --sysconfdir = / etc '' --datadir = / usr / share '' --includedir = / usr / include '' --libdir = / usr / lib64 '' --libexecdir = / usr / libexec '' --sharedstatedir = / var / lib '' --mandir = / usr / share / man '' --infodir = / usr / share / info '' --verbose '' --exec_prefix = / usr '' --libexecdir = / usr / lib64 / squid '' --localstatedir = / var '' --datadir = / usr / share / squid '' --sysconfdir = / etc / squid '' --with-logdir = $ (localstatedir) / log / squid '' --with-pidfile = $ (localstatedir) /run/squid.pid '' --disable -dependency-tracking '' --enable-follow-x-forwarded-for '' --enable-auth '' --enable-auth-basic = DB, LDAP, NCSA, NIS, PAM, POP3, RADIUS, SASL, SMB, getpwnam, fake '' --enable-auth-ntlm = smb_lm, fake '' --enable-auth-digest = file, LDAP, eDirectory '' --enable-auth-negotiate = kerberos, wrapper '' - enable-external-acl-helpers = wbinfo_group, kerberos_ldap_group, LDAP_group, delayer, file_userip, SQL  _session, unix_group, session, time_quota '' --enable-cache-digests '' --enable-cachemgr-hostname = localhost '' --enable-delay-pools '' --enable-epoll '' --enable-icap -client '' --enable-ident-lookups '' --enable-linux-netfilter '' --enable-removal-policies = heap, lru '' --enable-snmp '' --enable-storeio = aufs, diskd, ufs, rock '' --enable-wccpv2 '' --enable-esi '' --enable-ssl-crtd '' --enable-icmp '' --with-aio '' --with-default- user = squid '' --with-filedescriptors = 16384 '' --with-dl '' --with-openssl '' --with-pthreads '' --with-included-ltdl '' --disable-arch- native '' --enable-ecap '' --without-nettle '' build_alias = x86_64-redhat-linux-gnu '' host_alias = x86_64-redhat-linux-gnu '' CFLAGS = -O2 -g -pipe -Wall - Wp, -D_FORTIFY_SOURCE = 2 -fexceptions -fstack-protector-strong --param = ssp-buffer-size = 4 -grecord-gcc-switches -m64 -mtune = generic '' LDFLAGS = -Wl, -z, relro '' CXXFLAGS = -O2 -g -pipe -Wall -Wp, -D_FORTIFY_SOURCE = 2 -fexceptions -fstack-protector-strong --param = ssp-buffer-size = 4 -grecord-gcc-switches -m64 -mtune = generic -fP  IC '' PKG_CONFIG_PATH =: / usr / lib64 / pkgconfig: / usr / share / pkgconfig '‚Äîenable-ltdl-convenience <br></div></div><br>  Or you can download the <b><a href="https://yadi.sk/d/JUw6VJ55z3N29">archive</a></b> with the collected squid and its dependencies. <br><br><h3>  2.2 Installing the necessary packages from the official repositories </h3><br>  It is worth noting that for the installation of squid need some dependencies.  Unfortunately, CentOS has rather poor official repositories, so some packages need to be downloaded from unofficial ones.  Installing the necessary packages from the repository: <br><br><pre><code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># yum install -y libtool-ltdl perl-DBI perl-Digest-MD5 cyrus-sasl-gssapi krb5-workstation</span></span></code> </pre> <br><h3>  2.3 Manual installation of Squid and additional packages </h3><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">rmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Uvh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">squid-3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8-4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.centos</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x86_64</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rpm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">libecap-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0-3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.centos</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x86_64</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rpm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">squid-helpers-3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.8-4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.centos</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x86_64</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rpm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">perl-Crypt-OpenSSL-X509-1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.803-4</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x86_64</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rpm</span></span></code> </pre> <br>  If something is wrong, something is missing in the terminal. <br><br><h3>  2.4 Setting permissions for the swap directory </h3><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># chown squid:squid /var/spool/squid</span></span></code> </pre> <br><h3>  2.5 configuration file /etc/squid/squid.conf </h3><br><div class="spoiler">  <b class="spoiler_title">squid.conf</b> <div class="spoiler_text">  ### negotiate kerberos <br>  auth_param negotiate program / usr / lib64 / squid / negotiate_kerberos_auth -s HTTP /sq.example.ru@EXAMPLE.RU <br>  auth_param negotiate children 60 <br>  auth_param negotiate keep_alive off <br><br>  external_acl_type inet_medium ttl = 300 negative_ttl = 60% LOGIN / usr / lib64 / squid / ext_kerberos_ldap_group_acl -g Internet-medium@EXAMPLE.RU <br>  external_acl_type inet_full ttl = 300 negative_ttl = 60% LOGIN / usr / lib64 / squid / ext_kerberos_ldap_group_acl -g Internet-full@EXAMPLE.RU <br>  external_acl_type inet_low ttl = 300 negative_ttl = 60% LOGIN / usr / lib64 / squid / ext_kerberos_ldap_group_acl -g Internet-low@EXAMPLE.RU <br><br>  acl localnet src 10.0.0.0/24 <br>  acl localnet src 192.168.0.0/24 <br><br>  acl my_full external inet_full <br>  acl my_medium external inet_medium <br>  acl my_low external inet_low <br>  acl auth proxy_auth REQUIRED <br><br>  # in addition to the default 443, for the online business serara nuzhe additional.  port 9443 <br>  acl SSL_ports port 443 9443 <br>  acl Safe_ports port 80 # http <br>  acl Safe_ports port 21 # ftp <br>  acl Safe_ports port 443 # https <br>  acl Safe_ports port 70 # gopher <br>  acl Safe_ports port 210 # wais <br>  acl Safe_ports port 1025-65535 # unregistered ports <br>  acl Safe_ports port 280 # http-mgmt <br>  acl Safe_ports port 488 # gss-http <br>  acl Safe_ports port 591 # filemaker <br>  acl Safe_ports port 777 # multiling http <br>  acl CONNECT method CONNECT <br><br>  # In this configuration, whitelist is the list of allowed sites for the Internet-low@EXAMPLE.RU user group (access only to those sites that are in whitelist.txt) <br>  # And blocked_http.txt - the list of prohibited sites for the Internet-medium@EXAMPLE.RU group (all sites can be accessed, except for those that are blocked_http.txt) <br>  acl white_list dstdomain "/etc/squid/whitelist.txt" <br>  acl black_list dstdomain "/etc/squid/blocked_http.txt" <br>  dns_nameservers 10.0.0.9 <br><br>  # access rule <br><br>  http_access deny! Safe_ports <br>  http_access deny CONNECT! SSL_ports <br>  http_access allow localhost manager <br>  http_access deny manager <br>  http_access deny! auth <br><br>  http_access deny my_medium black_list <br>  http_access allow my_medium <br>  http_access allow my_low white_list <br>  http_access deny my_low all <br>  http_access allow my_full <br>  # Allow localhost <br>  http_access allow localhost <br><br>  # Forbid everything else <br>  http_access deny all <br><br>  # Opaque port through which client hosts interact with the proxy server <br><br>  http_port 10.0.0.10:3130 options = NO_SSLv3: NO_SSLv2 <br><br>  always_direct allow all <br>  sslproxy_cert_error allow all <br>  sslproxy_flags DONT_VERIFY_PEER <br><br>  # This option is needed for peek-n-splice to work correctly.  The file blocked_https.txt itself does not affect anything, but it should not be empty either.  Magic. <br>  # <br><br>  acl blocked ssl :: server_name "/etc/squid/blocked_https.txt" <br>  acl step1 at_step SslBump1 <br>  ssl_bump peek step1 <br><br>  # we terminate connection if the client comes on the forbidden resource <br>  ssl_bump terminate blocked <br>  ssl_bump splice all <br><br>  coredump_dir / var / spool / squid <br>  refresh_pattern ^ ftp: 1440 20% 10080 <br>  refresh_pattern ^ gopher: 1440 0% 1440 <br>  refresh_pattern -i (/ cgi-bin / | \?) 0 0% 0 <br>  refresh_pattern.  0 20% 4320 <br><br>  cache_dir aufs / var / spool / squid 20000 49 256 <br>  maximum_object_size 61440 KB <br>  minimum_object_size 3 KB <br><br>  #httpd_suppress_version_string on <br>  #visible_hostname PROXYSERVER <br><br>  cache_swap_low 90 <br>  cache_swap_high 95 <br>  maximum_object_size_in_memory 512 KB <br>  memory_replacement_policy lru <br>  logfile_rotate 4 <br></div></div><br><h3>  2.6 You must first bring the file <b>/ etc / hosts</b> to such content. </h3><br><pre> <code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">localohost</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sq</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ru</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sq</span></span></code> </pre> <br><h3>  2.7 Customize selinux </h3><br>  The <b>/ etc / selinux / config</b> file should contain the value: <br><pre> <code class="hljs">SELINUX=enforcing</code> </pre> <br>  Install the package to work with selinux: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># yum install policycoreutils-python</span></span></code> </pre> <br>  Add selinux rules <br><br>  Allow connections to squid: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># setsebool -P squid_connect_any on</span></span></code> </pre> <br>  Allow kerberos: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># setsebool -P allow_kerberos on</span></span></code> </pre> <br>  We allow connections to the squid on port 3130: <br><pre> <code class="hljs sql"><span class="hljs-comment"><span class="hljs-comment"># semanage port -a -t squid_port_t -p tcp 3130</span></span></code> </pre> <br>  After changing the selinux parameters, you must reboot the system to apply them. <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># reboot</span></span></code> </pre> <br><br><h3>  2.8 swap generation </h3><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># squid -z</span></span></code> </pre> <br><h3>  2.9 Enabling the squid daemon, checking the configuration file </h3><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># systemctl enable squid # squid -k parse</span></span></code> </pre> <br>  Varningov and errorov should not be.  If there is something - you need to check the settings. <br><br><h3>  2.10 Allowed traffic forwarding </h3><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># echo </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"net.ipv4.ip_forward = 1"</span></span></span><span class="hljs-meta"> &gt;&gt; /etc/sysctl.conf</span></span></code> </pre> <br>  Apply the setting on the fly: <br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># sysctl -p</span></span></code> </pre> <br><br><h3>  3 Integration with Active Directory Domain Controller 2012R2 </h3><br>  Integration with the domain controller is necessary so that domain users can log in to the proxy server using the Kerberos protocol.  The most reasonable solution is to leave only Kerberos due to the fact that this method is the safest, authorization occurs automatically.  As for client machines that are outside the domain, there are no problems here, the username and password can be entered manually in the authorization pop-up window.  Checked works. <br><br><h3>  3.1 Configuration file /etc/krb5.conf </h3><br>  The configuration file <b>/etc/krb5.conf</b> must be brought to the following form: <br><br><div class="spoiler">  <b class="spoiler_title">krb5.conf</b> <div class="spoiler_text">  [libdefaults] <br>  default_realm = EXAMPLE.RU <br>  ticket_lifetime = 24h <br>  default_keytab_name = /etc/krb5.keytab <br><br>  [realms] <br>  EXAMPLE.RU = { <br>  kdc = dc1.example.ru <br>  admin_server = dc1.example.ru <br>  default_domain = example.ru <br>  } <br><br>  [domain_realm] <br>  .example.ru = EXAMPLE.RU <br>  example.ru = EXAMPLE.RU <br></div></div><br><h3>  3.2 Creating DNS Records </h3><br>  Everyone knows that Active Directory is closely tied to DNS, and for authorization to work correctly, you need to create a node (A or AAA) with the indication of the host name and its ip-address (It turns out the <b>sq.example.ru</b> record with the ip-address <b>10.0.0.10</b> ). <br><br><h3>  3.3 Domain Integration Options </h3><br>  And so, <s>there are two chairs</s> option integration with the domain.  The first option is using Windows ( <b>ktpass</b> ), the second option is using Linux ( <b>Msktutil</b> ).  The Windows option is good because you can disable the password expiration for the <b>squid</b> user.  The Linux version is good because you can enter into the domain through the creation of a computer account. <br><br><h3>  3.3.1 Integration by Windows </h3><br>  We create the user in AD, for example <b>squid</b> <br>  Now generate <b>krb5.keytab</b> .  At the command prompt on a domain controller with administrative rights, you must run this command: <br><br><pre> <code class="hljs kotlin">C:\Windows\system32&gt; ktpass -princ HTTP/sq.example.<span class="hljs-symbol"><span class="hljs-symbol">ru@</span></span>EXAMPLE.RU -mapuser <span class="hljs-symbol"><span class="hljs-symbol">squid@</span></span>EXAMPLE.RU -crypto rc4-hmac-nt -pass Pa$$wd12 -ptype KRB5_NT_PRINCIPAL -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> C:\</code> </pre> <br>  The krb5.keytab <b>file</b> itself (can be moved using WinSCP) to <b>sq.example.ru</b> in the <b>/ etc</b> directory. <br><br><h3>  3.3.2 Linux integration </h3><br>  In the archive with the squid and dependencies msktutil is also attached, install it: <br><br><pre> <code class="hljs css"># <span class="hljs-selector-tag"><span class="hljs-selector-tag">rpm</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-Uhv</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">msktutil-0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1-2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.el7</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.x86_64</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rpm</span></span></code> </pre> <br><br>  Now execute the following command: <br><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># msktutil -c -b </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CN=COMPUTERS"</span></span></span><span class="hljs-meta"> -s HTTP/sq.example.ru -k /etc/krb5.keytab --computer-name sq-k --upn HTTP/sq.example.ru --server dc1.example.ru --verbose --enctypes 28</span></span></code> </pre> <br>  If successful, the output of the command will be great; I see no point in copying here.  Errors and varningov should not be.  It is worth paying attention to - <b>computer-name sq-k</b> is not a typo.  The hostname must be different. <br><br>  In view of the need to update the password for the computer account, this can be done through cron. <br><pre> <code class="hljs objectivec"> <span class="hljs-meta"><span class="hljs-meta"># crontab -e</span></span></code> </pre> <br>  It is necessary to add a task to it: <br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> * * * msktutil <span class="hljs-comment"><span class="hljs-comment">--auto-update --verbose --computer-name sq-k</span></span></code> </pre> <br><br><h3>  3.4 Recommended rights to the krb5.keytab file </h3><br>  After moving <b>krb5.keytab</b> , it is recommended to lower access rights to the file <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># chown squid:squid /etc/krb5.keytab &amp;&amp; chmod 644 /etc/krb5.keytab</span></span></code> </pre> <br><h3>  3.5 AD Access Groups </h3><br>  In ActiveDirectory in <u>OU</u> <u>Users,</u> you need to create three groups according to which Internet access will be distributed: <b>Internet-full,</b> <b>Internet-medium</b> , <b>Internet-low</b> . <br><br><h3>  3.6 Authorization check </h3><br>  Verification of authorization in Active Directory using the <b>/etc/krb5.keytab</b> file <br><br><pre> <code class="hljs ruby"><span class="hljs-comment"><span class="hljs-comment"># kinit -V -k -t /etc/krb5.keytab HTTP/sq.example.ru</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@EXAMPLE</span></span></span><span class="hljs-comment">.RU</span></span></code> </pre> <br>  The output of the command should be something like this: <br><br><pre> <code class="hljs sql">Using default <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>: /tmp/krb5cc_0 <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> principal: <span class="hljs-keyword"><span class="hljs-keyword">HTTP</span></span>/sq.example.ru@EXAMPLE.RU <span class="hljs-keyword"><span class="hljs-keyword">Using</span></span> keytab: /etc/krb5.keytab <span class="hljs-keyword"><span class="hljs-keyword">Authenticated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Kerberos v5</code> </pre> <br>  And the <b>klist</b> should display the following: <br><br><div class="spoiler">  <b class="spoiler_title">klist</b> <div class="spoiler_text">  Ticket cache: FILE: / tmp / krb5cc_0 <br>  Default principal: HTTP/sq.example.ru@EXAMPLE.RU <br><br>  Valid starting Expires Service principal <br>  10/09/2016 10:19:20 AM 10.10.2016 08:19:20 krbtgt/EXAMPLE.RU@EXAMPLE.RU <br>  renew until 10/10/2016 10:19:20 PM <br></div></div><br>  The Squid configuration is almost complete, now we reboot the host to apply the settings.  After the reboot for the test, you can manually register the proxy in the <b><u>sq.example.ru</u></b> settings <b><u>by</u></b> specifying port <b><u>3130</u></b> . <br><br><h3>  4 WPAD </h3><br><h3>  4.1 Installing and configuring the apache2 web server </h3><br>  Installing a web server: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># yum install -y httpd</span></span></code> </pre> <br>  After installation we include in autoload: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># systemctl enable httpd</span></span></code> </pre> <br>  Run: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># systemctl start httpd</span></span></code> </pre> <br>  If you try to open the domain name sq.example.ru in your browser, the test page apache2 should open. <br><br>  Next, you need to create a / <b>var / www / html / wpad.dat</b> file with the following content: <br><br><div class="spoiler">  <b class="spoiler_title">wpad.dat</b> <div class="spoiler_text">  function FindProxyForURL (url, host) <br>  { <br>  // var ip_host = dnsResolve (host); <br>  // var localnet = "192.168.0.0"; <br>  // var localhost = "127.0.0.0"; <br>  // var localnet = "10.0.0.0"; <br>  if (isInNet (host, "192.168.0.0", "255.255.255.0") || <br>  isInNet (host, "10.0.0.0", "255.255.255.0") || <br>  isInNet (host, ‚Äú127.0.0.0‚Äù, ‚Äú255.0.0.0‚Äù) || <br>  shExpMatch (host, "* .example.ru")) <br>  {return "DIRECT";  } <br>  if (dnsDomainIs (host, "* .inet-example.ru")) <br>  {return "DIRECT";  } <br>  return "PROXY sq.exmaple.ru:3130"; <br>  } <br></div></div><br><h3>  4.2 Description of the wpad.dat file </h3><br>  By default, the file in the /var/www/html/wpad.dat directory is given to everyone without any additional apache2 settings, and this is just necessary for correct interaction with client machines on Windows OS. <br><br>  Lines <br><br><pre> <code class="hljs lisp">if (<span class="hljs-name"><span class="hljs-name">isInNet</span></span>( <span class="hljs-name"><span class="hljs-name">host</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span>) || isInNet( <span class="hljs-name"><span class="hljs-name">host</span></span>, <span class="hljs-string"><span class="hljs-string">"10.0.0.0"</span></span>, <span class="hljs-string"><span class="hljs-string">"255.255.255.0"</span></span>) ||</code> </pre> <br>  Indicate that calls to the hosts on the 192.168.0.0/24, 10.0.0.0/24 and 127.0.0.0/8 subnets (the latter is necessary for the correct operation of the services when accessing localhost) are transmitted directly, and also the connection to the domain hosts .example .ru: <br><br>  Lines: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dnsDomainIs( host, <span class="hljs-string"><span class="hljs-string">"*.inet-example.ru"</span></span> )) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"DIRECT"</span></span>; }</code> </pre> <br>  Indicate that when accessing domain names .inet-example.ru occurs directly <br><br>  If the requested resource does not fall under the above conditions, the following is true: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"PROXY sq.exmaple.ru:3130"</span></span>;</code> </pre> <br><h3>  4.3 Create CNAME </h3><br>  On the Active Directory DNS server you need to create a <i>cname</i> <b>wpad</b> (FQDN wpad.example.com) on sq.example.com. <br><br>  For verification, you need to open <b><a href="">wpad / wpad.dat</a></b> in the browser <b><a href="">and the wpad.dat</a></b> file should automatically download.  Thus, all hosts download the file, and based on the content act.  It is recommended to re-log or reboot all computers in the domain on Windows to download the file. <br><br><h3>  5 Statistics </h3><br><h3>  5.1 Installing SARG from Source </h3><br>  If gcc has not been installed before, now is the time: <br><br><pre> <code class="hljs dos"># yum install -y gcc gd gd-devel make wget # wget http://liquidtelecom.dl.sourceforge.<span class="hljs-built_in"><span class="hljs-built_in">net</span></span>/project/sarg/sarg/sarg-<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>/sarg-<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>.tar.gz # tar -xvzf sarg-<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>.tar.gz # <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> sarg-<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span> # ./configure # make</code> </pre> <br>  In the file <u>po / Makefile.in.in,</u> the gettext version is specified as 0.18, so that there was no error during make install, you need to change to 0.19: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># make install</span></span></code> </pre> <br><h3>  5.2 Configuring SARG </h3><br>  The standard configuration file <u>/usr/local/etc/sarg.conf is</u> better to save: <br><br><pre> <code class="hljs pgsql"># mv /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/sarg.conf /usr/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/etc/sarg.conf.<span class="hljs-keyword"><span class="hljs-keyword">default</span></span></code> </pre> <br>  Now create the <b>sarg.conf</b> file with the following content: <br><br><pre> <code class="hljs pgsql">access_log /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/squid/<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> output_dir /var/www/html/squid-reports date_format e overwrite_report yes <span class="hljs-keyword"><span class="hljs-keyword">language</span></span> UTF<span class="hljs-number"><span class="hljs-number">-8</span></span></code> </pre> <br><h3>  5.3 Report generation schedule using cron </h3><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># crontab -e</span></span></code> </pre> <br>  Add a line: <br><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">55</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> * * * <span class="hljs-regexp"><span class="hljs-regexp">/usr/local</span></span><span class="hljs-regexp"><span class="hljs-regexp">/bin/sarg</span></span> -xd day-<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  This line indicates that reports will be generated every day and for the current day at 23:55 <br><br><h3>  5.4 Web server configuration </h3><br>  The previously installed web server can also be assigned the task of displaying reports, with a request to enter a login and password for authorization.  Create the file <b>/etc/httpd/conf.d/sarg.conf</b> with the following contents: <br><br><div class="spoiler">  <b class="spoiler_title">sarg.conf</b> <div class="spoiler_text">  Alias ‚Äã‚Äã/ reports / var / www / html / squid-reports / <br><br>  &lt;Directory / var / www / html / squid-reports /&gt; <br><br>  AuthType Basic <br>  AuthName "Basic Authentication" <br>  AuthUserFile /etc/httpd/conf/.htpasswd <br>  require valid-user <br>  AddDefaultCharset UTF-8 <br></div></div><br><br><h3>  5.5 Authorization on a site with statistics </h3><br>  Generate login and password file for authorization <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># htpasswd -c /etc/httpd/conf/.htpasswd administrator</span></span></code> </pre> <br>  Restart <b>apache2</b> : <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># systemctl restart httpd</span></span></code> </pre> <br>  When you try to open <i><a href="http://sq.example.ru/reports">sq.example.ru/reports, you</a></i> will be prompted to enter your login and password.  In case of successful authorization, you can view the statistics. <br><br><h3>  6 Group Policy </h3><br>  Everything here is ambiguous and may depend on some features.  In the current task, it was a reasonable decision to exclude the possibility of installing a proxy server for the user, or disabling the ‚ÄúAutomatic detection of parameters‚Äù. <br><br><h3>  6.1 GPO Editing </h3><br>  To prohibit the input of a proxy server or change the settings for automatic detection of parameters, you can use Group Policy.  We create and associate a group policy with an <u>OU,</u> for example, <u>office</u> . <br><br>  Editing Group Policy: <br><br><blockquote>  <b><u>User ‚Üí Policies ‚Üí Administrative Templates ‚Üí Windows Components ‚Üí Internet Explorer</u></b> </blockquote><br>  In this directory, find the parameters and translate into <b>"Enabled"</b> status: <br><br><blockquote>  <b>"Prohibit changing proxy settings"</b> <br>  <b>"Disable automatic parameter changes"</b> </blockquote><br>  In conclusion, I can say this, this configuration has been working successfully since the spring of 2016, and has proven itself well.  All questions will be happy to answer. <br><br>  <b>UPD # 1: 12.11.16</b> <b><br></b>  <b>1 The extra lines of ports 3128 and 3129 were removed from the squid config.</b> <b><br></b>  <b>2 included selinux and added rules.</b> <b><br></b>  <b>3 The certificate generation was removed from the manual (it works without it)</b> <b><br></b>  <b>4 Minor fixes</b> <br>  <b>UPD # 2: 11/20/16</b> <b><br></b>  <b>1 Extra lines have been removed from krb5.conf config</b> <b><br></b>  <b>2 Added method of integration with AD through Msktutil</b> <b><br></b>  <b>3 Forwarding added</b> <b><br></b>  <b>4 Updated archive with squid and dependencies.</b> </div><p>Source: <a href="https://habr.com/ru/post/314918/">https://habr.com/ru/post/314918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314906/index.html">Designing a large project on the example of Alibaba.com analogue</a></li>
<li><a href="../314908/index.html">Not your problem</a></li>
<li><a href="../314910/index.html">Public website accessible to people with disabilities (accessibility checklist)</a></li>
<li><a href="../314912/index.html">The nuances of the introduction of protection against DDoS-attacks</a></li>
<li><a href="../314916/index.html">How to calculate the approximate cost of development for 3 minutes</a></li>
<li><a href="../314920/index.html">ThinkPHP # 13 Mitap Announcement</a></li>
<li><a href="../314922/index.html">Mitap of the MSK.NET community in Kaspersky Lab</a></li>
<li><a href="../314924/index.html">Laziness is the engine of progress. Task generator Part 2</a></li>
<li><a href="../314926/index.html">12 cases by big date: confirmed examples from the industry when a big date brings money</a></li>
<li><a href="../314928/index.html">As Tesla Motors and SpaceX nearly disappeared in 2008</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>