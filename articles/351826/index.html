<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A couple of stories about RAID'ersky lawlessness</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On the air the continuation of our Friday heading about failures, failures and other fakapy. If you missed our previous stories, here are the links: o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A couple of stories about RAID'ersky lawlessness</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/s5/l9/t-/s5l9t-tp2tduhgcesblhcl5l0j0.jpeg"><br><br>  On the air the continuation of our Friday heading about failures, failures and other fakapy.  If you missed our previous stories, here are the links: <a href="https://habrahabr.ru/company/jetinfosystems/blog/343112/">one</a> , <a href="https://habrahabr.ru/company/jetinfosystems/blog/345322/">two</a> , <a href="https://habrahabr.ru/company/jetinfosystems/blog/346502/">three</a> .  And today we will tell about the trouble with RAID in one "small but proud" data center. <br><a name="habracut"></a><br><h2>  History of inconsistency data </h2><br>  The story began with the fact that one of the disks in RAID 5 failed. Well, it came out and went out - a common thing.  The disk began to reassemble, and then another disk failed.  Too frequent problem for RAID 5. As a result, the entire disk pool in which this mdisk was located fell off.  Who does not know, mdisk is a small raid, and the disk pool consists of a heap of mdisks.  We decided to switch to the backup data center.  Everything went smoothly: the servers started up normally, there are no errors.  Everything seems to work.  While the data was in the backup data center, we reassembled the failed mdisk in the main data center.  There are no errors on it: the array glows green, the data is replicated between the arrays at the main and backup sites. <br><br>  We switch back and we understand that some of the data we start normally, and, for example, database servers - with errors.  We see them inconsistency data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We check for integrity and find a bunch of errors.  Strange, because the data in the RZOD was in order, and during reverse replication in the main data center, they came to have failed.  Unclear.  At first they thought that the problem was in the array.  But in the logs everything is clean, no errors. <br><br>  Then they began to sin on the replication procedure, because on the arrays in the primary and backup data centers the firmware versions differed by 2-3 minor versions.  In the description of the vendor found that there are indeed replication errors with different versions of firmware.  Then, with the help of a special proprietary utility, the replication consistency was checked: whether all the frames that had flown out of one array reached the other.  Everything works without problems, but as soon as we transfer data from the backup data center to the main one, we get inconsistency - some blocks come broken. <br><br>  They just began to copy data over the network.  Make a dump of the base and fill the array.  The dump comes with other hash sums.  Probably somewhere on the road data is lost.  We tried to send through different networks - everything is the same.  It turns out that the problem is in the array, despite the fact that he cheerfully reports on his trouble-free work. <br><br>  We decided to rebuild the disk pool.  The data that worked in the main data center was transferred back to the backup, the disk array was freed, the entire pool was formatted and reassembled.  And only after that the inconsistency of the data disappeared. <br><br>  The reason was in one failed element of the logic of the RAID controller.  One of the mdisks, that is, the RAID group, did not work correctly after the rebuild.  The array considered it to be functioning normally, but this was not the case.  When blocks fell on this mdisk, he wrote them down incorrectly.  For example, file servers do not write much, and inconsistency does not occur on them.  And in the database information is constantly changing, the blocks are recorded frequently and in various places of the disk pool.  Therefore, we encountered the problem of inconsistency on the server with databases. <br><br>  Since the failure of the disk pool to the launch of the system, it took about 4 hours, and all this time one of the critical business systems did not work for the customer.  Financial losses were not so great, mostly it was a blow to the reputation. <br><br>  In our practice it was the only such failure.  Although it is not uncommon for RAID 5, when one of the disks dies, the load on the remaining ones increases, and because of this, another disk dies.  So the tip: update the firmware in a timely manner and avoid inconsistency in the versions. <br><br><h2>  Inexplicable connection </h2><br>  Another amazing story that happened to us for the first time.  Actors: the same arrays and platforms, there are also main and backup data centers.  In the RODS, it crashes, freezes, and one of the controllers in the array does not rise.  Overload - the controller has risen, the array has earned.  But at this very moment on the main site we fell off the input / output on the physical Linux-servers. <br><br>  Surprisingly, the controller in the RODS and the I / O in the OZOD are completely isolated from each other.  The only thing that binds them is the FC routers on the perimeter.  They simply wrap FC traffic in IP and drive it between sites to replicate data between arrays of disk storage.  That is, the controller and I / O have absolutely everything different - SAN, physical platforms, physical servers. <br><br>  It turned out that at the moment when the controller was turned on at the backup site, he considered himself to be the SCSI initiator, instead of being a SCSI target.  At us replication goes from the main TsODA to reserve.  That is, the controller in theory should be a SCSI target, all frames should come to it.  And he decided that an active life position was more suitable for him, and began to try to send some data himself. <br><br>  At this moment, the multipathing driver on Linux servers running Red Hat 7 did not work correctly.  He took these commands verbatim.  Despite the fact that he himself is the initiator, he saw another initiator and decided, just in case, to turn off all the paths to the disks.  And since they were boot disks, they just fell off.  Literally four minutes.  Then they rose, but the customer had a short-term drawdown of business transactions.  That is, within four minutes the customer-retailer could not sell their products throughout the country.  And with two thousand retail outlets, every minute of idleness is expressed in a decent monetary equivalent, not to mention reputational losses. <br><br>  Perhaps the cause of this incident was the imposition of bugs.  Or maybe the two technologies are simply not friendly: the piling of disk storage and the multi-pass driver in Red Hat, which behaved in a strange way.  After all, even if there is another SCSI initiator, the driver simply has to say that now it is also the initiator, and continue to work, and not shoot the disks.  This should not be. <br><br>  That's all.  Less bugs to you! <br><br>  <i>Alexander Marchuk, Chief Engineer of the Jet Info Systems Service Center</i> </div><p>Source: <a href="https://habr.com/ru/post/351826/">https://habr.com/ru/post/351826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351816/index.html">The peaceful atom: Japan will build the most powerful supercomputer for nuclear research</a></li>
<li><a href="../351818/index.html">Functional programming with PHP generators</a></li>
<li><a href="../351820/index.html">What is in the new JupyterLab for users?</a></li>
<li><a href="../351822/index.html">We open statistics on the sources of views and responses on ‚ÄúMy Circle‚Äù</a></li>
<li><a href="../351824/index.html">A look at Tokio: how this asynchronous event handler works</a></li>
<li><a href="../351828/index.html">Welcome to Badoo PHP Meetup April 7</a></li>
<li><a href="../351830/index.html">The Department of Information Technology, Communications and Information Protection of the City of N requires ...</a></li>
<li><a href="../351832/index.html">‚ÄúTolik - sweetheart‚Äù, or as we did a survey of IT-satisfaction for 20 thousand people</a></li>
<li><a href="../351834/index.html">Blockchain on Go. Part 5: Addresses</a></li>
<li><a href="../351836/index.html">Sound games: an invisible market awaits heroes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>