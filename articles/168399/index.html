<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>An example of accelerating calculations in R by multithreading</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 As follows from Wikipedia:  R is a programming language for statistical data processing and graphics, as well as a free open-source com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>An example of accelerating calculations in R by multithreading</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  As follows from Wikipedia: <blockquote>  R is a programming language for statistical data processing and graphics, as well as a free open-source computing environment within the GNU project. </blockquote><br>  This language, at present, has found wide application in many practical and purely scientific fields.  However, historically, the speed of many demanding computing leaves much to be desired.  The topic of parallel computing in R for habrahabr has already been <a href="http://habrahabr.ru/post/163277/">raised</a> .  In this article I will try to show the application of this approach to a specific example using the <b>parallel</b> package for multi-threaded computing. <br><a name="habracut"></a><br><br><h4>  Formulation of the problem </h4><br>  The need to speed up computations arose when studying the connection of genetic markers with human phenotypic traits using the <b>neuralnet</b> package for building neural networks.  However, the proposed solution can be used for other tasks. <br><br><h4>  Materials and methods </h4><br>  <b>R 2.15.2 was</b> used in the work, <b>neuralnet</b> - 1.32, <b>parallel</b> - 2.15.2, <b>rbenchmark</b> - 1.0.0.  Computer running Windows 7, processor Intell Core i5-2550K CPU @ 3.40GHz (4 cores) and 8GB of RAM.  The built-in data set (infert, package = "datasets"). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Results and discussion </h4><br>  First, let's look at the processor load in the usual neural network calculation.  The example is taken from the description of the <b>neuralnet</b> package with a slight modification: <i>threshold = 0.0001</i> is one of the criteria for stopping, and <i>rep =</i> <b>20‚Äì20</b> repetitions of the computation, in order for the calculations to be more ‚Äúcomplex‚Äù. <br><br><pre><code class="python hljs">nn&lt;-function() { print(<span class="hljs-string"><span class="hljs-string">" "</span></span>) neuralnet(case~parity+induced+spontaneous, infert, err.fct=<span class="hljs-string"><span class="hljs-string">"ce"</span></span>, linear.output=FALSE, likelihood=TRUE,rep=<span class="hljs-number"><span class="hljs-number">20</span></span>, threshold=<span class="hljs-number"><span class="hljs-number">0.0001</span></span>) } nn()</code> </pre> <br><br>  From the <b>Windows Task Manager, you</b> can see that when executing, only one of the processor cores is used and the CPU load is 25%. <br>  Now measure the execution time of this code.  For this, I used the <b>rbenchmark</b> package.  In general, the code for measurement will look like this: <br><br><pre> <code class="python hljs">within(benchmark(test.name=test.function(), <span class="hljs-comment"><span class="hljs-comment">#      replications=c(3), #     (+1   "") columns=c('test', 'replications', 'elapsed'), #       order=c('elapsed', 'test')), #    { average = elapsed/replications }) #        </span></span></code> </pre><br>  The result is: <br><pre> <code class="python hljs"> test replications elapsed average <span class="hljs-number"><span class="hljs-number">1</span></span> _ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">47.83</span></span> <span class="hljs-number"><span class="hljs-number">15.94333333</span></span></code> </pre><br><br>  Now let's compare this time with performing 20 calculations not through the <i>rep = 20</i> option, but through, for example, sapply. <br><pre> <code class="python hljs">nn.s&lt;-function() { print(<span class="hljs-string"><span class="hljs-string">" "</span></span>) nets&lt;-sapply(<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>, function(X) neuralnet(case~parity+induced+spontaneous, infert, err.fct=<span class="hljs-string"><span class="hljs-string">"ce"</span></span>, linear.output=FALSE, likelihood=TRUE,rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, threshold=<span class="hljs-number"><span class="hljs-number">0.0001</span></span>)) }</code> </pre><br>  It turns out: <br><pre> <code class="python hljs"> test replications elapsed average <span class="hljs-number"><span class="hljs-number">1</span></span> _ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">46.05</span></span> <span class="hljs-number"><span class="hljs-number">15.35</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> _ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">47.52</span></span> <span class="hljs-number"><span class="hljs-number">15.84</span></span></code> </pre><br>  The execution time is about the same.  Apparently there is no optimization of the execution of repetitions inside the <b>neuralnet</b> function.  To use the rest of the kernels use the <b>parallel</b> package.  It is included in <b>R</b> c version 2.14.0 and allows you to run code in several independent threads.  Each thread will perform the <b>neuralnet</b> function. <br><pre> <code class="python hljs">nn.p&lt;-function() { print(<span class="hljs-string"><span class="hljs-string">" "</span></span>) cl &lt;- makeCluster(getOption(<span class="hljs-string"><span class="hljs-string">"cl.cores"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-comment"><span class="hljs-comment">#       clusterExport(cl,"infert") #     clusterEvalQ(cl,library(neuralnet)) #   neuralnet   parSapply(cl, 1:20, function(X) #   sapply neuralnet(case~parity+induced+spontaneous, infert, err.fct="ce", linear.output=FALSE, likelihood=TRUE,rep=1, threshold=0.0001) ) stopCluster(cl) }</span></span></code> </pre><br>  Compare lead time: <br><pre> <code class="python hljs"> test replications elapsed average <span class="hljs-number"><span class="hljs-number">3</span></span> _ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">17.38</span></span> <span class="hljs-number"><span class="hljs-number">5.793333333</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> _ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">45.88</span></span> <span class="hljs-number"><span class="hljs-number">15.293333333</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> _ <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">46.61</span></span> <span class="hljs-number"><span class="hljs-number">15.536666667</span></span></code> </pre><br>  Thus, the parallel version runs more than 2.5 times faster.  In this case, the processor load is 100%. <br><br>  For convenience, you can create your own wrapper for the <b>neuralnet</b> function. <br><pre> <code class="python hljs">pneuralnet &lt;- function(formula, data, rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, ..., cl) { clusterExport(cl,<span class="hljs-string"><span class="hljs-string">"data"</span></span>) clusterEvalQ(cl,library(neuralnet)) nets &lt;- parLapply(cl, <span class="hljs-number"><span class="hljs-number">1</span></span>:rep, function(X) neuralnet(formula, data, rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, ...) ) <span class="hljs-comment"><span class="hljs-comment">#       reached.threshold nets &lt;- nets[order(sapply(1:rep,function(i){nets[[i]]$result.matrix["reached.threshold", ]}))] return(nets) } cl &lt;- makeCluster(getOption("cl.cores", 4)) nets &lt;- pneuralnet(case~parity+induced+spontaneous, infert, err.fct="ce", linear.output=FALSE, likelihood=TRUE,rep=4, threshold=0.0001, cl=cl) stopCluster(cl)</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">All code</b> <div class="spoiler_text"><pre> <code class="python hljs">library(parallel) library(neuralnet) library(rbenchmark) data(infert, package=<span class="hljs-string"><span class="hljs-string">"datasets"</span></span>) nn&lt;-function() { print(<span class="hljs-string"><span class="hljs-string">" "</span></span>) neuralnet(case~parity+induced+spontaneous, infert, err.fct=<span class="hljs-string"><span class="hljs-string">"ce"</span></span>, linear.output=FALSE, likelihood=TRUE,rep=<span class="hljs-number"><span class="hljs-number">20</span></span>, threshold=<span class="hljs-number"><span class="hljs-number">0.0001</span></span>) } nn.s&lt;-function() { print(<span class="hljs-string"><span class="hljs-string">" "</span></span>) nets&lt;-sapply(<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>, function(X) neuralnet(case~parity+induced+spontaneous, infert, err.fct=<span class="hljs-string"><span class="hljs-string">"ce"</span></span>, linear.output=FALSE, likelihood=TRUE,rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, threshold=<span class="hljs-number"><span class="hljs-number">0.0001</span></span>)) } nn.p&lt;-function() { print(<span class="hljs-string"><span class="hljs-string">" "</span></span>) cl &lt;- makeCluster(getOption(<span class="hljs-string"><span class="hljs-string">"cl.cores"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)) clusterExport(cl,<span class="hljs-string"><span class="hljs-string">"infert"</span></span>) clusterEvalQ(cl,library(neuralnet)) parSapply(cl, <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>, function(X) neuralnet(case~parity+induced+spontaneous, infert, err.fct=<span class="hljs-string"><span class="hljs-string">"ce"</span></span>, linear.output=FALSE, likelihood=TRUE,rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, threshold=<span class="hljs-number"><span class="hljs-number">0.0001</span></span>) ) stopCluster(cl) } pneuralnet &lt;- function(formula, data, rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, ..., cl) { clusterExport(cl,<span class="hljs-string"><span class="hljs-string">"data"</span></span>) clusterEvalQ(cl,library(neuralnet)) nets &lt;- parLapply(cl, <span class="hljs-number"><span class="hljs-number">1</span></span>:rep, function(X) neuralnet(formula, data, rep=<span class="hljs-number"><span class="hljs-number">1</span></span>, ...) ) <span class="hljs-comment"><span class="hljs-comment">#       reached.threshold nets &lt;- nets[order(sapply(1:rep,function(i){nets[[i]]$result.matrix["reached.threshold", ]}))] return(nets) } within(benchmark(_=nn(), _=nn.s(), _=nn.p(), replications=c(3), columns=c('', 'replications', 'elapsed'), order=c('elapsed', 'test')), { average = elapsed/replications }) cl &lt;- makeCluster(getOption("cl.cores", 4)) nets &lt;- pneuralnet(case~parity+induced+spontaneous, infert, err.fct="ce", linear.output=FALSE, likelihood=TRUE,rep=4, threshold=0.0001, cl=cl) stopCluster(cl)</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/168399/">https://habr.com/ru/post/168399/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168383/index.html">Build Symfony2 projects using Jenkins</a></li>
<li><a href="../168385/index.html">"Spy shoes" from O2 is not only for walking</a></li>
<li><a href="../168391/index.html">Do not be fooled by your customers.</a></li>
<li><a href="../168393/index.html">Soloten told about mobile technologies in MIRBIS</a></li>
<li><a href="../168397/index.html">CES Results: Samsung New Audio Systems at the International Consumer Electronics Show</a></li>
<li><a href="../168401/index.html">Update for Nokia 808 PureView: sending photos to Twitter from Gallery</a></li>
<li><a href="../168407/index.html">TCP Congestion Control or Why speed jumps</a></li>
<li><a href="../168409/index.html">Atom Quartet. Solution for optimal placement of cheap computers in the rack</a></li>
<li><a href="../168411/index.html">Tablet is not a luxury</a></li>
<li><a href="../168413/index.html">Component for integrating Ext.grid.Panel lines with Ext.toolbar.Toolbar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>