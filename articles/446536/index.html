<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Queues and JMeter: sharing with Publisher and Subscriber</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 This is a sequel to my previous publication , in which I will talk about the options for placing messages in queues using JMeter. 

 We a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Queues and JMeter: sharing with Publisher and Subscriber</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  This is a sequel to my <a href="https://habr.com/ru/post/437172/">previous publication</a> , in which I will talk about the options for placing messages in queues using JMeter. <br><br>  We are making a data bus for a large federal company.  Different request formats, conversions, intricate routing.  For testing, you need to send a lot of messages in the queue.  Manually - the pain that not every manual worker can handle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/qk/j1/hl/qkj1hlhyamcpk4tp5c9czz9it9e.jpeg"><br><a name="habracut"></a><br><h4>  Introduction </h4><br>  Although this pain had to be tolerated at first.  It all started with RFHUtil.  Powerful, but uncomfortable and scary: <s>Well, you know Rus.</s> <br><br><img src="https://habrastorage.org/webt/n8/h_/_7/n8h__7bex8odyahincdv12fsjvq.png"><br><br>  Indispensable in some cases, but steadily falling in case of active use. <br>  Convenient testing with it is impossible. <br><br>  With JMeter, everything is easier.  After the first stage with mastering and addiction, the hope of happy testing began to dawn. <br><br>  I actively use JMS Publisher and JMS Subscriber samplers.  Unlike JMS Point-to-Point, this couple seemed to be more convenient to use.  For example, in Subscriber in JMS Selector, you can specify a variable, in Point-to-Point - no (or this method is not too obvious). <br><br><h4>  Sampler Training </h4><br><h3>  JMS Publisher </h3><br><ul><li>  Setup - Each Sample.  Apache <a href="https://jmeter.apache.org/usermanual/build-jms-topic-test-plan.html">recommends</a> using this option if queues / topics are set via variables. </li><li>  Expiration (ms) = 120000. In case of failure, test requests will disappear from the queue after 2 minutes. </li><li>  Use non-persistent delivery mode?  - true.  IBM <a href="https://www.ibm.com/support/knowledgecenter/en/SSFKSJ_9.1.0/com.ibm.mq.xms.doc/xms_cmesdelmode.htm">claims</a> that persistent mode ensures reliable storage of transmitted messages in the event of a sudden failure.  And faster exchange in non-persistent mode.  For test purposes, speed is more important. </li></ul><br>  In each Publisher, I set a jms property that Subscriber will use in JMS Selector.  For each dispatch, a random value is generated in the element of the User Parameters test plan: <br><br><img src="https://habrastorage.org/webt/tp/l5/zc/tpl5zcqakjajigr0zmlhdn3tjgy.png"><br><br>  So you can be sure that you read the correct message. <br><br>  The final "blank" pre-configured JMS Publisher: <br><br><img src="https://habrastorage.org/webt/-e/4t/0l/-e4t0l95qr_un19yvqtbfzc6yng.png"><br><br><h3>  Jms subscriber </h3><br><ul><li>  Setup - Each Sample.  Well, you understand. </li><li>  Timeout (ms) = 100000. If the request does not arrive in the queue after 100 seconds of waiting, then something went wrong. </li><li>  Stop between sample?  - true. </li></ul><br><br>  JMS Selector is a pretty handy <a href="https://www.ibm.com/support/knowledgecenter/SSFKSJ_9.1.0/com.ibm.mq.dev.doc/q031980_.htm">thing</a> .  Summary JMS Subscriber: <br><br><img src="https://habrastorage.org/webt/ww/x_/wt/wwx_wtmt2ezlmuvkxqlkbvskcnk.png"><br><br>  How to deal with Cyrillic in the transmitted messages.  In JMeter, by default, after subtracting, it is displayed crookedly.  To avoid this and enjoy the great and mighty always and everywhere, you need: <br><br><ol><li>  Add JVM argument to JMeter launcher: <br><pre><code class="java hljs">-Dfile.encoding=UTF-<span class="hljs-number"><span class="hljs-number">8</span></span></code> </pre> </li><li>  Add JSR223 PostProcessor to Subscriber with a groovy line: <pre> <code class="java hljs">prev.setDataEncoding(<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>)</code> </pre> </li></ol><br><h4>  Text transfer </h4><br>  The laziest option.  Suitable for debugging freshly written tests.  Or for cases when you need to send at least something small.  Select the <b>Message source - Textarea</b> option and place the message body in the text box: <br><br><img src="https://habrastorage.org/webt/mr/ui/cf/mruicfs6dymskxqompntk539ap4.png"><br><br><h4>  File transfer </h4><br>  The most frequent option.  Suitable for most scenarios.  Select the option <b>Message source - From file</b> and specify the path to the message in the <b>File - Filename</b> field <b>:</b> <br><br><img src="https://habrastorage.org/webt/en/qx/mo/enqxmotrqf7l2pn2wg-sc1z84h8.png"><br><br><h4>  File transfer to text field </h4><br>  The most versatile option.  Suitable for most scenarios + can be used in JMS Point-to-Point, in which there is no second sending option: <br><br><img src="https://habrastorage.org/webt/vd/tr/7v/vdtr7vkufkxecmk8h-h2krjbgeo.png"><br><br><h4>  Transfer byte array </h4><br>  The most difficult option.  Suitable for checking the immaculate-accurate transmission of requests up to a byte, without distortion, sms and perturbation.  To do this in the default JMeter will not work, <a href="https://stackoverflow.com/questions/53119886/how-to-extract-and-compare-bytes-from-jmeter-jms-subscriber-response-body">here</a> I was definitely told about it. <br><br>  So I had to download the <a href="https://github.com/apache/jmeter">source code</a> and modify <a href="">the</a> JMS Subscriber <a href="">code</a> . <br><br>  Replaced the line in the <code>extractContent(..)</code> method: <br><br><pre> <code class="java hljs">buffer.append(bytesMessage.getBodyLength() + <span class="hljs-string"><span class="hljs-string">" bytes received in BytesMessage"</span></span>);</code> </pre> <br>  on: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) bytesMessage.getBodyLength()]; bytesMessage.readBytes(bytes); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { buffer.append(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String(bytes, <span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (UnsupportedEncodingException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); }</code> </pre> <br>  and rebuilt JMeter. <br><br>  It remains to add a pair of JSR223 Sampler.  The first is before a Publisher / Subscriber pair to create a DAT file containing random bytes: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.lang3.RandomUtils; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.FileNotFoundException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.FileOutputStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; vars.put(<span class="hljs-string"><span class="hljs-string">"PATH_TO_BYTES"</span></span>, <span class="hljs-string"><span class="hljs-string">"C:\\temp\\randomBytes.dat"</span></span>); File RESULT_FILE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(vars.get(<span class="hljs-string"><span class="hljs-string">"PATH_TO_BYTES"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arr = RandomUtils.nextBytes((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(Math.random()*<span class="hljs-number"><span class="hljs-number">10000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { FileOutputStream fos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(RESULT_FILE); fos.write(arr); fos.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { System.out.println(<span class="hljs-string"><span class="hljs-string">"file not found"</span></span>); }</code> </pre> <br>  The second - at the end of the script, deletes the file: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File; File RESULT_FILE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(vars.get(<span class="hljs-string"><span class="hljs-string">"PATH_TO_BYTES"</span></span>)); RESULT_FILE.delete();</code> </pre> <br>  And do not forget to add the path to the file in Publisher: <br><br><img src="https://habrastorage.org/webt/ft/qo/hh/ftqohh0-afunmymjyl8wjhwkcrw.png"><br><br>  As well as the check in JSR223 Assertion for Subscriber - compare the original bytes with those that arrive in the recipient's queue: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.file.Files; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.file.Path; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.nio.file.Paths; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Arrays; Path path = Paths.get(vars.get(<span class="hljs-string"><span class="hljs-string">"PATH_TO_BYTES"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] originalArray = Files.readAllBytes(path); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] changedArray = ctx.getPreviousResult().getResponseData(); System.out.println(changedArray.length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Arrays.equals(originalArray, changedArray)) { SampleResult.setResponseMessage(<span class="hljs-string"><span class="hljs-string">"OK"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { SampleResult.setSuccessful(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); SampleResult.setResponseMessage(<span class="hljs-string"><span class="hljs-string">"Comparison failed"</span></span>); SampleResult.setResponseData(<span class="hljs-string"><span class="hljs-string">"Bytes have changed"</span></span>,<span class="hljs-string"><span class="hljs-string">"UTF-8"</span></span>); IsSuccess=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre> <br><h4>  Conclusion </h4><br>  Described four ways to send messages to the queue, which I use every day in practice.  I hope this information will make your life easier.  In the sequel, I plan to talk about my exchange testing experience, where there is a line at one end and a database or file system at the other. <br><br>  Take care of your time.  And thank you for your attention. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gw/-l/bs/gw-lbsso67kzbcmb8oibvw-pn1u.png" alt="image" width="400"></div></div><p>Source: <a href="https://habr.com/ru/post/446536/">https://habr.com/ru/post/446536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446520/index.html">How it all began: the story of flying drones</a></li>
<li><a href="../446522/index.html">Swift 5.1 - what's new?</a></li>
<li><a href="../446530/index.html">Word2vec in pictures</a></li>
<li><a href="../446532/index.html">Upwork introduces a fee for the right to write to a potential customer.</a></li>
<li><a href="../446534/index.html">Visual Studio 2019 released</a></li>
<li><a href="../446538/index.html">PhotoGuru went to the "dark side" and "wiser"</a></li>
<li><a href="../446546/index.html">Microsoft expands Azure IP Advantage with new IP benefits for Azure IoT innovators and startups</a></li>
<li><a href="../446550/index.html">Pattern Problems Coordinator and what's the RouteComposer</a></li>
<li><a href="../446552/index.html">Working with APDU commands using the EToken example</a></li>
<li><a href="../446554/index.html">Resident program of Yandex, or How to become an ML-engineer as an experienced backend</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>