<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Layered architecture based on yii framework</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine a company that sells a whole range of its own products - both for external users and for internal ones. Most likely, each product will not be ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Layered architecture based on yii framework</h1><div class="post__text post__text-html js-mediator-article"><img align="left" height="200" src="https://habrastorage.org/getpro/habr/post_images/e9b/e7f/932/e9be7f932020e1643ee99083552c6eac.jpg" width="300"><br>  Imagine a company that sells a whole range of its own products - both for external users and for internal ones.  Most likely, each product will not be able to exist separately, like a spherical horse in a vacuum, and to some extent will be integrated with others.  As a result, all of them together form a layer of interconnected with each other and at the same time independently developing organisms.  And most likely, their development is carried out by completely different teams. <br><br>  A good example of such an environment is Yandex (search, Direct, maps, mail, vertical and internal services) or Google.  It is clear that the listed technology giants in each product have their own, but if you take a smaller company and operate in a narrower domain, you can assume that web products will be executed on some technologies (programming languages, frameworks, etc.). <br><br>  It is about the experience in organizing the architecture of the entire product line at such a company I want to tell. <br><a name="habracut"></a><br>  Our external web products are an <a href="http://maps.2gis.ru/">online version</a> , an open <a href="http://api.2gis.ru/">reference</a> and mapping <a href="http://api.2gis.ru/">API</a> , a feedback <a href="http://flamp.ru/">service</a> .  Internal: CRM, billing, algorithmic computing, statistics systems and <br>  export-import data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We derive two concepts: <br><br>  <strong>A web infrastructure</strong> is a collection of web-products of a company that are interconnected and operate in related subject areas. <br><br>  <strong>Technological base</strong> - a single code base for the company's web infrastructure.  Contains a set of software blocks with high and low levels of abstraction.  High-level blocks are entities already developed by the development team in the company's subject area.  Low-level blocks are, for example, a set of libraries or frameworks. <br><br>  Surely more than once each of you worked on several projects and implemented modules, which you then reused in the next project.  This does not always go smoothly: a completely separate version of the module is formed in a separate SVN branch, and then in the third project it is necessary to apply something in between the first two versions of the module, etc., etc.  In other words, if you do not list all the problems, these are the criteria for the quality of the technological base.  Let's label them: <br><ul><li>  Reuse of modules and components between projects; </li><li>  extensibility of the functionality of already written modules without rewriting the entire system; </li><li>  single product deployment scheme; </li><li>  load scalability. </li></ul><br>  Our goal was to create such a web infrastructure.  The first thing we started with was the preparation of a technological base.  We have chosen the following frameworks and technologies: <br><ul><li>  PHP; </li><li>  application framework - yii; </li><li>  framework for deploying and deploying an application - phing; </li><li>  framework for writing unit tests - phpUnit; </li><li>  continuous integration system - Jenkins; </li><li>  functional and UI testing - Selenium; </li><li>  Postgres DBMS; </li><li>  key-value of storage memcached, redis; </li><li>  nginx web server. </li></ul><br>  (Why these systems are chosen, we will not discuss, this is a topic for a separate publication.) <br><br>  To ensure the quality criteria of the technological base, we decided to lay out a layered architecture. <br>  <strong>A layered architecture</strong> is a system architecture in which a system consists of some ordered set of software subsystems called layers, such that: <br><ul><li>  on each layer, nothing is known about the properties (and even the existence) of the subsequent (higher) layers; </li><li>  each layer can interact in control (access to components) with the immediately preceding (lower) layer through a predetermined interface, without knowing anything about the internal structure of all the previous layers; </li><li>  Each layer has certain resources, which it either hides from other layers, or provides directly to the next layer (through the specified interface) some of their abstractions. </li></ul><br>  Thus, in a layered software system, each layer can implement some kind of data abstraction.  The connections between the layers are limited by transferring the values ‚Äã‚Äãof the parameters for each layer's access to the layer adjacent to the bottom and by outputting the results of this treatment from the top layer to the top.  It is not allowed to use global data in multiple layers.  A more complete definition can be found in the <a href="http://www.ozon.ru/context/detail/id/1616782/">works of Fowler</a> . <br><br>  Without considering the network and servers, which themselves are separate layers, consider the device technological platform.  There are three layers in it: <br><br><img height="284" src="https://habrastorage.org/getpro/habr/post_images/ae3/704/60b/ae370460bff69e72aaabacc772a75432.jpg" width="318"><br>  <strong>Fig.</strong>  <strong>1.</strong> Layers of technology platform architecture <br><br>  In fig.  1 there are three layers: <br><ul><li>  <strong>Core layer</strong> - the core layer.  Here are the common low-level libraries and frameworks.  For example, yii. </li><li>  <strong>Shared layer</strong> - a layer of modules that implement some kind of system functionality that can be used in several projects. </li><li>  <strong>Application layer</strong> - application layer.  At this level all applications with their specific modules are located. </li></ul><br>  In this case, the important point is that the modules should be able to easily move from the application layer to the level of common modules.  This is explained very simply: when a new project starts, the most necessary functionality is usually implemented.  As the project develops, it begins to overgrow with connections with other products (it was decided, for example, to pull reviews from one project to cafes on another our project), and perhaps some of the modules may be required for other projects.  Either the project is divided into parts, and the modules are divided into several applications. <br><br>  Consider in more detail the file organization of the application in the Application layer, taking into account the specificity of yii. <br><br><pre>  application
 	 framework - the framework is here
 	 lib - components from core and shared.  For this folder, a separate alias is created in the Yii config		
		 components
		 extensions
		 ...
	 protected
		 components
		 extensions
		 ...
	 public
	 themes
	 config
</pre><br>  <strong>Figure 2.</strong> Application file organization yii <br><br>  As we can see, components and extensions exist both at the application level and at the general level (shared).  Here is the structure of the application already collected from the repository.  Of course, in the version control system you can organize everything differently.  We, for example, have two assembly modes, when everything is poured into the application folder and when symlinks are made to the extension library.  The first is needed to isolate different applications, when we cannot separately upgrade extensions without updating all applications, and to deploy multiple instances on one machine.  Or deploying different branches on the same server.  The second is convenient for developers when working with code. <br><br>  So, we have set a flexible foundation for our web infrastructure, but is that enough?  Not.  Two important things are missing: <br><ul><li>  application architecture must be weakly engaged and shared; </li><li>  Deploy system and product assembly. </li></ul><br>  Now for each item in more detail. <br><br><h2>  Application architecture </h2><br>  The application architecture is also based on layers.  Highlight the following levels: <br><img height="297" src="https://habrastorage.org/getpro/habr/post_images/972/36f/a6a/97236fa6a623091310c91f08c5cdf273.jpg" width="238"><br>  <strong>Figure 3. Layers of yii application</strong> <br><br>  The layer of ‚Äúthin‚Äù controllers contains a minimum of logic and operates with the extensions API.  A business logic layer consists of an extension level and a data model level.  The layer of Yii-extensions and data models have a very strong degree of connectedness, this is shown in the diagram by a bold arrow. <br><br>  The greatest degree of connectivity exists between the application and the ‚Äúthin‚Äù controllers.  The likelihood of reuse is minimal.  But the connection between the layer of "thin" controllers and the layer of business logic needs to be done as little as possible, since we can and should reuse business logic in our other applications.  And we can do this with the help of the flexibility of Yii and its config. <br><br>  The config connects the set of components and extensions we need.  Example connection extension: <br><br><blockquote>  <font color="#0000ff">'geoip'</font> <font color="#339933">=&gt;</font> <font color="#990000">array</font> <font color="#009900">(</font> <font color="#0000ff">'class'</font> <font color="#339933">=&gt;</font> <font color="#0000ff">'application.extensions.GeoIP.CGeoIP'</font> <font color="#009900">)</font> <font color="#339933">,</font> </blockquote><br><br>  The initialized extension in the application can be accessed using the geoip key.  For example: <br><br><blockquote>  Yii <font color="#339933">::</font> <font color="#000088">$ app</font> <font color="#339933">-&gt;</font> <font color="#004000">geoip</font> <font color="#339933">;</font> </blockquote><br><br>  The first time the component is accessed, the CGeoIP class will be initialized.  Flexibility is in the presence of a key :-) We can change the implementation at any time through the config, and the application will still work using the geoip key. <br><br>  Based on this flexibility, we can easily manage the connectivity between the application and the business logic layer. <br><br>  By grouping the logic of working with a certain application essence into extensions, we make it detachable.  All models are thus encapsulated in the extension and the application controller works with the data through the extension API. <br><br>  Extensions are an additional level of abstraction for us, behind which we can hide the data sources necessary for the inner workings of certain extension API methods. <br><br>  Let's fantasize a bit and come up with an application: <br><br> <a href=""><img height="343" src="https://habrastorage.org/getpro/habr/post_images/6a8/1f3/96d/6a81f396d15f3d4f239907b338162764.jpg" width="640"></a> <br>  <strong>Figure 4. Example of yii application architecture</strong> <br><br>  Our application works with several extensions.  Extensions operate on a data set and are closely related to the model layer.  An important point: the degree of connectivity between layers of honey grows from top to bottom.  The most closely related data model. <br><br>  Now let's imagine that it became necessary to create a single user authorization service for all products.  We can easily implement such a project as a separate application.  To work with the new application, write the extension - rest-userServiceRestClient.  The client will have the same API as the UserExtension API.  We look at the picture for clarity: <br><br> <a href=""><img height="776" src="https://habrastorage.org/getpro/habr/post_images/1fa/e94/aa0/1fae94aa0a7738b67b1add0e3f081cf7.jpg" width="640"></a> <br>  <strong>rice</strong>  <strong>five</strong> <br><br>  We put UserServiceRestClient in a shared-level and change the class to be used in the application's config.  Since the API is the same, the implementation has been changed without changing the code.  Very flexible!  All other applications also work with the user service using the UserServiceRestClient. <br><br>  So, we have dealt with the architecture, but the configuration of the application with this approach will be rather big.  Hands to prescribe all dependencies for the application - not at all Jedi.  Especially when the project lives and there are also database migrations.  All these issues can be solved with the help of its assembly system and product deployment. <br><br><h2>  Deploy and assembly system </h2><br>  What should deploy system: <br><ul><li>  deliver the code to the specified directory on the server; </li><li>  pull up all dependencies of the application (extensions of the shared level and the framework); </li><li>  generate application config; </li><li>  perform sql database migration. </li></ul><br>  And also - the tasks of launching unit tests, building debug-versions of the project, etc. I don‚Äôt list everything, this is a matter of taste, and quite a lot of attention has already been paid to all these operations on the Internet.  For example, our deployment system configures accompanying software such as nginx, Sphinx, RabbitMQ and creates documentation.  Conveniently! <br><br>  In general, the tasks are ordinary: file operations, working with version control systems, launching third-party utilities (PHPUnit, for example, or Doxygen), etc. Attention should be paid to generating a config.  We made it according to a template with a meta-configuration file: <br><br><pre>  application
	 protected
		 config
		 main.php.template - yii config template
	 public
	 themes
	 build.prop - meta-configuration file
	 build.xml - phing'a config </pre><br>  <strong>rice</strong>  <strong>6</strong> <br><br>  During the generation of the Phing config, the template is parsed and replaces all placeholders with the corresponding parameters set in the meta-configuration file.  It turned out very convenient.  All dependencies of the application set the meta-config: <br><br><blockquote>  <font color="#666666">## List of extensions, components and etc.</font>  <font color="#666666">to install ##</font> <br>  EXTENSIONS = myExt, myExt2 <br>  COMPONENTS = component1, component2 <br>  HELPERS = myHeper, myTextHelper <br>  COMMANDS = </blockquote><br><br>  Also in the meta-config database is registered, the paths, the hosts - in general, everything.  Additional convenience for automation again is that all these parameters can be passed through the command line to Phing and redefine it.  And in the future, for example, to set up the build packages for the OS used by you * nix. <br><br>  Thus, the meta-configuration file is a layer of abstraction on the format and number of configs in our application. <br><br>  As a result, the flexibility of the configuration Yii + build system = easily configurable and assembled products. <br><br><h2>  Total </h2><br>  So, what did the experience of using such a scheme for a year show us? <br><ul><li>  If there is a need to reuse any extensions, this will not become a problem, the process of continuous integration is also built without any special problems. </li><li>  There is a necessary margin of flexibility that makes it easy to develop and increase the functionality of applications.  Functional blocks can be done extremely quickly, without thinking about the performance and quality of the code. </li><li>  If the interface is thought out, you can always fearlessly finish the functionality, improve performance, change the data storage and refactor. </li><li>  A well-designed application deployment system allows you to quickly deploy a system for testing and minimizes errors when deploying to combat servers due to human inattention. </li><li>  Due to the isolation of individual functional modules, it is always possible to select a separate development group for working with it.  This allows you to solve the problems of growth of the development department and not turn into a large uncontrolled collective farm, where everyone works on everything, and thus only interferes with each other. </li></ul><br><br>  PS And yes, we <a href="http://company.2gis.ru/nsk/vacancy/">are looking for</a> yii developers in Novosibirsk and Kiev.  Come!  :-) </div><p>Source: <a href="https://habr.com/ru/post/130162/">https://habr.com/ru/post/130162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130156/index.html">Tracking the status of a small project</a></li>
<li><a href="../130157/index.html">Droider Chart. Release 73, road</a></li>
<li><a href="../130158/index.html">Countering mobile fraud: what happens after phishing emails</a></li>
<li><a href="../130159/index.html">DealHunter - as we did foursquare for lovers of discounts and sales</a></li>
<li><a href="../130160/index.html">Experience using TFS 2010: (Control system. Branches. Creation)</a></li>
<li><a href="../130164/index.html">Says and shows. Toaster!</a></li>
<li><a href="../130165/index.html">JavaScript-Linux screwed "disks permanent memory"</a></li>
<li><a href="../130166/index.html">Updates in {iOS | Android | Symbian} -> WP7</a></li>
<li><a href="../130168/index.html">$ 3M investment in NGINX</a></li>
<li><a href="../130169/index.html">The Sandbox has appeared in the Yandex.Direct API.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>