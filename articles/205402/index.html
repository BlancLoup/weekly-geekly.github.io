<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TeamCity setup for newbies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is primarily useful to those who use the same technology stack as our team, namely: ASP.NET, C #, NUnit, Selenium 2, git, MSBuild. Such t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TeamCity setup for newbies</h1><div class="post__text post__text-html js-mediator-article">  This article is primarily useful to those who use the same technology stack as our team, namely: ASP.NET, C #, NUnit, Selenium 2, git, MSBuild.  Such tasks as integration with git, building C # projects, NUnit tests (both modular and UI tests), as well as deploying to the server will be considered.  However, for sure there will be an interesting one for other users, except perhaps they have eaten a dog on this issue.  But again, they will be able to pay attention to errors in the article or to advise something: for example, how to optimize the deployment phase. <br><a name="habracut"></a><br>  What is ‚Äúcontinuous integration‚Äù is perfectly described <a href="http://habrahabr.ru/post/82724/">here</a> and <a href="http://habrahabr.ru/post/185740/">here</a> , it is hardly necessary to repeat this topic for the hundredth time. <br><br>  Well, for starters - what can TeamCity (hereinafter - just TC)?  Or maybe it is the following: when changes appear in the specified repository branch (or other event), execute a script that includes, for example, building an application, running tests, executing other scripts, uploading files to a remote server, etc. <br><br>  The important point is that the ‚Äúintegration server‚Äù and the ‚Äúmachine on which this process will take place‚Äù are usually (not necessarily) different servers.  Moreover, there are several, even many, machines that run assemblies and tests, and all are on different operating systems - in general, there is where to turn. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To start the build process, an agent program is used that accepts commands from a TC server, and it can be launched on any of the major operating systems (the glory of Java multiplatform).  You can install several agents on one computer and run them in parallel, but it is important to remember that one agent can process only one project at a time.  When starting a task, TC selects the first suitable unallocated agent, and you can install ‚Äúfilters‚Äù, for example, select an agent only from Windows OS or only with installed .NET version not lower than 4.0, etc. <br><br>  Now you need to come up with a work script.  We use the following branches in our work: <br><ol><li>  <b>release</b> - contains the actual code, the working version, which is located on the combat server; </li><li>  <b>dev</b> - all new features go to it, later it is added to release; </li><li>  <b>a separate branch for each feature</b> that buds off dev and returns to it. </li></ol><br>  In general, almost standard git-flow, which can be read in more detail, for example, <a href="http://habrahabr.ru/post/147260/">here</a> . <br><br>  In this regard, our script will look like this: <br><br><ol><li>  pick up the latest changes from the dev repository; </li><li>  compile the project; </li><li>  if everything went well at the previous step - run the unit tests; </li><li>  if everything went well in the previous step, run the functional tests; </li><li>  if everything went well in the previous step, upload the changes to the test server. </li></ol><br>  For the release branch, we are doing the same thing, but at the time of uploading new data, suspend the server and show the stub. <br><br>  Now go ahead - implement the script! <br><br><br><h2>  Pick up fresh changes from repository </h2><br>  It all starts with a simple project creation. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd4/47e/3ee/cd447e3eeb5e83710b7100b644d051ab.png"><br><br>  After - create ‚Äú <b>build configuration</b> ‚Äù.  The configuration defines the build script. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f78/9c6/17b/f789c617b94ed9552fc91691a9260454.png"><br><br>  At the second step of creating the configuration, we will be asked about the VCS used, so we answer honestly that we have git here.  You may have another VCS - do not get lost.  A new repository is added using the <b>Create and attach new VCS root</b> button. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/05a/d18/9c0/05ad189c00ada79ff21ea66993fb436b.png"><br><br>  So, the key settings: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/705/bfe/f1d/705bfef1d86d672ae68727521547f57c.png"><br><br><ul><li>  <b>VCS root ID</b> can not touch - a unique code, anyway.  If left blank, automatically generated; </li><li>  <b>Fetch URL</b> - the address from which we will take the contents of the repository; </li><li>  <b>Default branch</b> - the branch from which the information will be taken; <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c7a/425/b65/c7a425b659c5c24de261022b072e4288.png"><br><br></li><li>  <b>Authentication method</b> - the most interesting - authentication method.  There can be access without authorization (if the data is on the internal server, for example), and by key, and by password.  For each option, additional fields will be your own, you know. </li></ul><br>  The rest of the variety of options - for your taste and color. <br><br>  Next, you need to configure the automatic start of the task.  Go to ‚Äú <b>Build Triggers</b> ‚Äù (build conditions) and select the <b>VCS Trigger</b> condition - with the default settings it will check for new commits in the repository once a minute, and if there are any, it will launch the task for execution. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/664/c63/675/664c6367508e098c4c8d8676207a8ed5.png"><br><br><br><h2>  Compile project </h2><br>  Since we have a project on ASP.NET in the form of a Solution from Visual Studio - everything was also simple here. <br><br>  Go to the " <b>Build Steps</b> " menu, select the <b>runner type</b> (and there are really a lot of them here) and stop at <b>MSBuild</b> .  Why on it?  It provides a fairly simple way to describe the build process, even a fairly complicated one, by adding or removing various steps in a simple XML file. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bbc/bbe/2bb/bbcbbe2bbe24a294dde5d2f0dd46ab7a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f2b/b0b/258/f2bb0b2585f994c8d0bc6ac471799b09.png"><br><br>  Then everything is elementary. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e72/24c/28c/e7224c28c9b63c4400f633761ed89ac0.png"><br><br>  <b>Build file path</b> - the path to the sln file. <br>  <b>MSBuild version</b> , <b>MSBuild ToolsVersion</b> and <b>Run platform</b> select the requirements of your project. <br><br>  If there are several configurations in a project, then you can use the <b>Command line parameters</b> option to enter something like this key: <br><br><pre><code class="bash hljs">/p:Configuration=Production</code> </pre> <br>  where <b>Production is</b> replaced by the desired config. <br><br><br><h2>  Enable NuGet Download </h2><br>  An important point if you are using NuGet packages;  if not, you can go directly to the next item. <br><br>  Since NuGet packages weigh a lot, and you don‚Äôt feel like storing library binaries unnecessarily, you can use the wonderful option <b>NuGet Package Restore</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/46a/da1/540/46ada1540820081036ca1663e888f198.png"><br><br>  In this situation, library binaries are not included in the repository, but are downloaded as needed during the build process. <br><br>  But <b>MSBuild</b> is a real gentleman and will not do extra gestures without permission, so there will be no way to download packages - this process should be allowed to it.  To do this, you must either set the <b>Enable NuGet Package Restore</b> environment variable to <b>true</b> on the client, or go to the <b>Build Parameters</b> menu and set it there. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2fa/c30/eeb/2fac30eebbbf83e8a588e869d6af5188.png"><br><br><br><h2>  Run unit tests </h2><br>  Our unit tests are a separate project within the solution.  So at the previous step they were already compiled - it remains to run them. <br><br>  We add a new step, only now <b>Runner</b> is <b>NUnit</b> .  Pay attention to the parameter <b>Execute step</b> : it indicates the conditions under which the step should be performed, and has 4 values: <br><ul><li>  <b>If all previous steps finished successfully (zero exit code)</b> - if all previous steps have completed without errors.  The check is performed purely on the agent; </li><li>  <b>Only if build status is successful</b> - similar to the previous one, but the agent also specifies the build status of the TC server.  It is necessary for more fine control of the task logic, for example, if the zero return code of a specific step is an error for us; </li><li>  <b>Even if some of the previous steps failed</b> - even if one <b>of the previous steps failed</b> with an error; </li><li>  <b>Always, even if build stop command was issued</b> - perform a step, even if a <b>command is issued</b> to cancel the execution of the assembly. </li></ul><br>  Here the most important thing is to indicate the correct path to the assembly with tests inside the project in the column Run tests from.  Here, for example, it looks like this: <br><br><pre> <code class="bash hljs">%teamcity.build.checkoutDir%\project\project.FuncTests\bin\Dev\project.FuncTests.dll</code> </pre> <br>  <b>% teamcity.build.checkoutDir%</b> is a variable indicating the folder into which the data is downloaded from the repository.  In principle, it is not required to be specified, since  by default, the path is relative to this directory, so the path could be shortened to: <br><br><pre> <code class="bash hljs">project\project.FuncTests\bin\Dev\project.FuncTests.dll</code> </pre> <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2b5/30b/86a/2b530b86a7d60ee03927508239ab83fe.png"><br><br>  I will separately mark the <b>Run recently failed test first</b> option - if in the previous run some tests fell, then they will be the first to be launched in the next run, and you will quickly learn about the success of the last changes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d73/e43/e1a/d73e43e1aff332910145941bb0af4602.png"><br><br><br><h2>  Run interface tests (functional tests) </h2><br>  Everything is much more interesting here than with unit tests.  The cap here suggests that, in order to test the project in the browser, it, i.e.  project must be run.  But here we fooled by running the web server directly from the Selenium test code: <br><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">SetUpFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ServerInit</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ApplicationName = <span class="hljs-string"><span class="hljs-string">"justtest"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Process _iisProcess; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetApplicationPath</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> applicationName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tmpDirName=AppDomain.CurrentDomain.BaseDirectory.TrimEnd(<span class="hljs-string"><span class="hljs-string">'\\'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> solutionFolder = Path.GetDirectoryName(Path.GetDirectoryName(Path.GetDirectoryName(tmpDirName))); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = Path.Combine(solutionFolder, applicationName); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } [SetUp] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunBeforeAnyTests</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { [‚Ä¶] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> applicationPath = GetApplicationPath(ApplicationName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> programFiles = Environment.GetFolderPath(Environment.SpecialFolder.ProgramFiles); _iisProcess = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process { StartInfo = { FileName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}/IIS Express/iisexpress.exe"</span></span>, programFiles), Arguments = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"/path:\"{0}\" /port:{1}"</span></span>, applicationPath, UrlProvider.Port) } }; _iisProcess.Start(); } [TearDown] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunAfterAnyTests</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { [‚Ä¶] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_iisProcess.HasExited == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { _iisProcess.Kill(); } } }]</code> </pre><br>  And the launch itself looks exactly the same as on the unit tests stage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/265/fd4/3b9/265fd43b956a5f2be8dd22cba959770e.png"><br><br><br><h2>  Pour changes to the test server </h2><br>  The server on which the TC agent is located and the server on which IIS is installed are different servers, and, moreover, they are located on different networks.  Therefore, the files must somehow be delivered to the destination server.  And here the solution is chosen, maybe not very elegant, but extremely simple.  We use upload via FTP, and <b>MSBuild</b> does this for us. <br><br>  The scheme is as follows: <br><ol><li>  set up an FTP account on the server for uploading files.  For additional security, you can disable casting for all IP except the internal one, if the TC server is on the internal network, of course; </li><li>  install on the <b>MSBuild Community Tasks</b> agent in order to be able to use the ‚ÄúUpload via FTP‚Äù task.  <a href="http://code.google.com/p/msbuildtasks/downloads/list">Download here</a> ; </li><li>  prepare a script file for MSBuild that will perform the following actions: <br><ol><li>  building the application in a temporary folder; </li><li>  substitution of the configuration file; </li><li>  file upload via FTP. </li></ol></li></ol><br><div class="spoiler">  <b class="spoiler_title">This is how this file will look like (deploy.xml)</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/developer/msbuild/2003"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ToolsVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">DefaultTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">UsingTask</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TransformXml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AssemblyFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v11.0\Web\Microsoft.Web.Publishing.Tasks.dll"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildExtensionsPath32)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">OutputDir</span></span></span><span class="hljs-tag">&gt;</span></span>bin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">OutputDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PublishDir</span></span></span><span class="hljs-tag">&gt;</span></span>../output<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PublishDir</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Configuration</span></span></span><span class="hljs-tag">&gt;</span></span>Dev<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformInputFile</span></span></span><span class="hljs-tag">&gt;</span></span>..\project\project\Web.template.config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformInputFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformFile</span></span></span><span class="hljs-tag">&gt;</span></span>..\project\project\Web.$(Configuration).config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformOutputFile</span></span></span><span class="hljs-tag">&gt;</span></span>..\project\output\Web.config<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformOutputFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackTraceEnabled</span></span></span><span class="hljs-tag">&gt;</span></span>False<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StackTraceEnabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ProjectToBuild</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"../project/project.sln"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Properties</span></span></span><span class="hljs-tag">&gt;</span></span>WebProjectOutputDir=$(PublishDir);OutputPath=$(OutputDir);Configuration=Dev<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ProjectToBuild</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MSBuild</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Projects</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@(ProjectToBuild)"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CreateWebConfigs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AfterTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TransformXml</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Source</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(TransformInputFile)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Transform</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(TransformFile)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Destination</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(TransformOutputFile)"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"AfterBuild"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AfterTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CreateWebConfigs"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ftpHost</span></span></span><span class="hljs-tag">&gt;</span></span>dev.example.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ftpHost</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ftpUser</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ftpUser</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ftpPass</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ftpPass</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDirectory</span></span></span><span class="hljs-tag">&gt;</span></span>..\project\output<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LocalDirectory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FtpUploadDirectoryContent</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ServerHost</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ftpHost)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"21"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Username</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ftpUser)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(ftpPass)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">LocalDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(LocalDirectory)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">RemoteDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Recursive</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br></div></div><br>  And so - the task of his call: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cc/205/3f9/2cc2053f92df2c684ba95799b97cba8d.png"><br><br>  Lack of solution - ALL files are uploaded, not just new ones that have changed.  On a project with a bunch of layout files or multiple modules, this can be a problem because of the time it takes to fill. <br><br>  Another drawback is that when a file is found with a non-Latin name in the name, it falls with an error.  Latin letters and numbers are processed normally.  The legs of this problem seem to grow out of the specifics of the FTP protocol: it is based on ASCII, but it doesn‚Äôt describe how to encode non-ASCII characters, suggesting ‚Äúdo what your server will understand‚Äù.  Accordingly, to cure the problem, without changing the scheme, you need to patch MSBuild Community Tasks, since the <a href="">source code is open</a> .  Well, or use an alternative way to upload files, for example through WinSCP. <br><br><br><h2>  Stop and start the server for the release script </h2><br>  We solve it a little wild, but nice way.  IIS has a feature: if you put a file named <b>app_offline.html</b> in the root of the site, the site is <b>chopped</b> off, and when you access all files, the contents of this file will be <b>displayed</b> . <br><br>  Minus - the appeal is precisely that to all files, including static.  So, if you want to make a stub with the design, CSS and images, use inline-styles and data: url, well, or as an option - put them on a separate server. <br><br>  We enable / disable the server through a WinSCP script and such files: <br><br><div class="spoiler">  <b class="spoiler_title">server_off.cmd</b> <div class="spoiler_text"><pre> <code class="hljs javascript">winscp.exe /<span class="hljs-built_in"><span class="hljs-built_in">console</span></span> /script=server_off.txt</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">server_on.cmd</b> <div class="spoiler_text"><pre> <code class="hljs javascript">winscp.exe /<span class="hljs-built_in"><span class="hljs-built_in">console</span></span> /script=server_on.txt</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">server_off.txt</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">option</span></span> batch <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> confirm <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> ftp://:@dev.example.com mv _app_offline.htm app_offline.htm <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">server_on.txt</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">option</span></span> batch <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> confirm <span class="hljs-keyword"><span class="hljs-keyword">off</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> ftp://:@dev.example.com rm app_offline.htm <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> </div></div><br>  That is, initially the file is in the root and is called <b>_app_offline.html</b> .  When you need to block access for an update, we rename it to <b>app_offline.html</b> .  When files are <b>uploaded</b> , the new <b>_app_offline.html</b> file is <b>uploaded</b> , and when finished, the <b>app_offline.html</b> file is <b>deleted</b> .  And we get exactly what it was originally. <br><br>  In the text of the blank page, I highly recommend using the <a href="http://en.wikipedia.org/wiki/Meta_refresh">refresh</a> meta-tag, which will periodically refresh the page.  If by this time the update process is completed, the user will return back to the service, which will certainly be incredibly happy. <br><br>  Calling the script to enable the stub (shutting off the stub is similar): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ff/c75/108/1ffc751087611f277848f2d764c7ad2a.png"><br><br>  Yes, <b>WinCSP</b> lies as a result right in the repository.  Yes, passwords in the clear form are in the file.  Yes, not the most elegant solution, but since only developers from our team have access to the repository and the virtual machine with an agent, why not?  Yes, it would be possible to store a file with passwords, for example, directly on the agent, but this would not increase security in principle, but, for example, the scanning of a new agent would slow down. <br><br>  These settings are used by us for about half a year, and so far not a single problem has arisen - everything works like a clock, which is good news. <br><br>  That's all.  I am pleased to hear comments and tips on how to improve these steps, as well as your stories about what features of TC you use in yourself. <br><br>  <b>Update from November 3, 2014.</b> <br>  Choosing Runner Type "Command line" does not require any screening of spaces - Team City will take care of this on its own. </div><p>Source: <a href="https://habr.com/ru/post/205402/">https://habr.com/ru/post/205402/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205388/index.html">Share the secret</a></li>
<li><a href="../205390/index.html">Global Government Observation Reform</a></li>
<li><a href="../205394/index.html">Map of Russian science: resonant or resonant project?</a></li>
<li><a href="../205396/index.html">IT quest marathon for the habr</a></li>
<li><a href="../205398/index.html">Search for cropped duplicate images using perceptual hashes</a></li>
<li><a href="../205404/index.html">WebRTC Expo 2013 and new features of the VoxImplant platform</a></li>
<li><a href="../205406/index.html">Ball pen to create conductive drawings on Kickstarter collected 477 thousand dollars instead of 85 thousand</a></li>
<li><a href="../205410/index.html">The first part of 1,500,000 pages of ancient manuscripts is digitized.</a></li>
<li><a href="../205412/index.html">Google Analytics. Caution bots</a></li>
<li><a href="../205414/index.html">Computer mouse turned 45 years old</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>