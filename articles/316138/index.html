<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Call Transfer Using Script in Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, one of our clients felt the need to transfer calls (incoming and outgoing) by clicking from a browser. The logic is as follows: a gro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Call Transfer Using Script in Asterisk</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/72c/d25/f52/72cd25f52f95495e9c935a99cdb148f1.jpg"><br><br>  Not so long ago, one of our clients felt the need to transfer calls (incoming and outgoing) by clicking from a browser.  The logic is as follows: a group of call center operators receives and makes calls, and after talking and clarifying the needs, they need to connect the client with one of the customers or another specialist of the organization. <br><a name="habracut"></a><br>  It would seem that the operator can transfer the call in the classical way - by ‚Äúblind‚Äù transferring the required number from his telephone or softphone, but in fact it turned out that there are more than five hundred numbers that need to be transferred and they are constantly being added and changed, so that even the centralized automatic filling of the softphone phone book does not allow operators to work comfortably and quickly: first you need to find out the client‚Äôs need, then find the number with which to connect it in CRM, then or time  Learning to enter a number, or find the same number in the softphone phonebook.  This leads to the inefficient use of operators' working time, a high probability of translation errors and a decrease in the quality of customer service in general. <br><br>  In some cases, a similar problem is solved as follows: the event in CRM in a certain database is entered the number of the operator, and the number with which you want to connect his interlocutor.  After that, the operator transfers the call to the service number, in the context of the transfer, a request to the database is made and the call is finally transferred to the desired number.  Dialplan for outbound in this case looks like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code>[operator-out] <br> exten =&gt; _X.,1,Noop(Outgoing call from ${CALLERID(num)} to ${EXTEN}) <br> exten =&gt; _X.,n,Set(__TRANSFER_CONTEXT=transfer) <br> exten =&gt; _X.,n,Dial(SIP/provider/${EXTEN},30,T) <br> <br> [transfer] <br> exten =&gt; 800,1,Set(num=ODBC_GETXFERNUM(${CALLERID(num)} <br> exten =&gt; 800,n,Noop(Transfer to ${num}) <br> exten =&gt; 800,n,Goto(some-context,${num},1)</code> <br> <br>  For an outgoing call, the channel variable TRANSFER_CONTEXT is set, which overrides the context for transferring calls, and if the call is transferred to number 800 using ODBC, we get a number to which you actually need to transfer.  However, before the translation itself, the unambiguous correspondence of the operator‚Äôs internal number and the number to which the call must be transferred must be entered in the appropriate fields of the table, which requires at least one extra action from the employee (in CRM he needs to choose the number where he wants to transfer call, and then on the phone or softphone perform the translation itself), and you also need to ensure that the data in the table is correct: delete the record immediately after the transfer, check and process empty records in the dialplan. <br><br>  With all the shortcomings, this method can be applied if you know in advance which number you may need to transfer the call to.  Suppose a call center works on outgoing calls to customers of several customers.  The call is automatically generated from the CRM (using the callfile or via the originate in AMI), where the operator presses the ‚Äúnext call‚Äù button and sees the conversation script with the client.  Then you can simply add an inherited variable with a number, and transfer the call to it: <br><br>  In the callfile add the inherited variable __num: <br><br> <code>Channel: Local/101@from-internal <br> Callerid: 74950000000 <br> MaxRetries: 2 <br> RetryTime: 600 <br> WaitTime: 30 <br> Context: from-internal <br> Extension: 74950000000 <br> Priority: 1 <br> <b>Set: __num=79991112233</b></code> <br> <br>  And the translation context will look even simpler: <br><br> <code>exten =&gt; 800,1,Noop(Transfer to ${num}) <br> exten =&gt; 800,n,Goto(some-context,${num},1)</code> <br> <br>  However, in our case, as mentioned above, this method is undesirable. <br><br>  Fortunately, the asterisk developers took care of us, and through cli you can translate a specific channel into the specified context: <br><br> <code><code>channel redirect &lt;[[context,]exten,]priority&gt; <br> <br>      AMI: <br> <br> Action: Redirect <br> [ActionID:] value <br> Channel: value <br> [ExtraChannel:] value <br> Exten: value <br> [ExtraExten:] value <br> Context: value <br> [ExtraContext:] value <br> Priority: value <br> [ExtraPriority:] value&gt; <br></code> <br> <br>    :   ,    ,      . <br> <br>  ,       .      bridge show all     . <br> <br> <code>&gt; bridge show all <br> Bridge-ID Chans Type Technology <br> 14418b64-0635-46e7-bd48-f4b820461eaa 2 basic simple_bridge</code> <br> <br>   bridge show &lt;bridge-id&gt;    ,      . <br> <br> ,    bridge-id     ,            bridge-id,         : <br> <br> <code>&gt; core show channels concise <br> SIP/RT-00000453!incoming!!1!Up!AppDial!(Outgoing Line)!89063448810!!!3!134!14418b64-0635-46e7-bd48-f4b820461eaa!1479984681.1659 <br> SIP/67-00000452!macro-dialout-trunk!s!23!Up!Dial!SIP/RT/89063448810,300,TtL(7200000)!67!!!3!134!14418b64-0635-46e7-bd48-f4b820461eaa!1479984681.1658</code> <br> <br>  ,        2    bridge-id(14418b64-0635-46e7-bd48-f4b820461eaa),      .         .   bash-,     (  FreePBX 13): <br> <br> <code class="bash">#!/bin/bash context="from-internal" #  ,      exten=$1 #    num=$2 #     ,     bridge=$(asterisk -rx 'core show channels concise' | grep SIP/$exten- | cut -d '!' -f13 ) #  bridge-id       SIP/xx-aaaaa channel=$(asterisk -rx 'core show channels concise' | grep $bridge | grep -v SIP/$exten- | cut -d '!' -f1) #  channel      SIP/provider-000000 result=$(asterisk -rx "channel redirect $channel $context,$num,1") #       echo $result exit 0</code> <br> <br>      -    ,     .   ‚Äú‚Äù CRM   . <br> <br>      ?                  ,    CRM      asterisk  .  ,      ,     . <br> <br>      --,    ,         ,           .</code> <pre> <code class="hljs erlang-repl"><code>channel redirect &lt;[[context,]exten,]priority&gt; <br> <br>      AMI: <br> <br> Action: Redirect <br> [ActionID:] value <br> Channel: value <br> [ExtraChannel:] value <br> Exten: value <br> [ExtraExten:] value <br> Context: value <br> [ExtraContext:] value <br> Priority: value <br> [ExtraPriority:] value&gt; <br></code> <br> <br>    :   ,    ,      . <br> <br>  ,       .      bridge show all     . <br> <br> <code>&gt; bridge show all <br> Bridge-ID Chans Type Technology <br> <span class="hljs-number"><span class="hljs-number">14418</span></span>b64-<span class="hljs-number"><span class="hljs-number">0635</span></span>-<span class="hljs-number"><span class="hljs-number">46e7</span></span>-bd48-f4b820461eaa <span class="hljs-number"><span class="hljs-number">2</span></span> basic simple_bridge</code> <br> <br>   bridge show &lt;bridge-id&gt;    ,      . <br> <br> ,    bridge-id     ,            bridge-id,         : <br> <br> <code>&gt; core show channels concise <br> SIP/RT-<span class="hljs-number"><span class="hljs-number">00000453</span></span>!incoming!!<span class="hljs-number"><span class="hljs-number">1</span></span>!Up!AppDial!(Outgoing Line)!<span class="hljs-number"><span class="hljs-number">89063448810</span></span>!!!<span class="hljs-number"><span class="hljs-number">3</span></span>!<span class="hljs-number"><span class="hljs-number">134</span></span>!<span class="hljs-number"><span class="hljs-number">14418</span></span>b64-<span class="hljs-number"><span class="hljs-number">0635</span></span>-<span class="hljs-number"><span class="hljs-number">46e7</span></span>-bd48-f4b820461eaa!<span class="hljs-number"><span class="hljs-number">1479984681.1659</span></span> <br> SIP/<span class="hljs-number"><span class="hljs-number">67</span></span>-<span class="hljs-number"><span class="hljs-number">00000452</span></span>!macro-dialout-trunk!s!<span class="hljs-number"><span class="hljs-number">23</span></span>!Up!Dial!SIP/RT/<span class="hljs-number"><span class="hljs-number">89063448810</span></span>,<span class="hljs-number"><span class="hljs-number">300</span></span>,TtL(<span class="hljs-number"><span class="hljs-number">7200000</span></span>)!<span class="hljs-number"><span class="hljs-number">67</span></span>!!!<span class="hljs-number"><span class="hljs-number">3</span></span>!<span class="hljs-number"><span class="hljs-number">134</span></span>!<span class="hljs-number"><span class="hljs-number">14418</span></span>b64-<span class="hljs-number"><span class="hljs-number">0635</span></span>-<span class="hljs-number"><span class="hljs-number">46e7</span></span>-bd48-f4b820461eaa!<span class="hljs-number"><span class="hljs-number">1479984681.1658</span></span></code> <br> <br>  ,        <span class="hljs-number"><span class="hljs-number">2</span></span>    bridge-id(<span class="hljs-number"><span class="hljs-number">14418</span></span>b64-<span class="hljs-number"><span class="hljs-number">0635</span></span>-<span class="hljs-number"><span class="hljs-number">46e7</span></span>-bd48-f4b820461eaa),      .         .   bash-,     (  FreePBX <span class="hljs-number"><span class="hljs-number">13</span></span>): <br> <br> <code class="bash">#!/bin/bash context=<span class="hljs-string"><span class="hljs-string">"from-internal"</span></span> #  ,      exten=$<span class="hljs-number"><span class="hljs-number">1</span></span> #    num=$<span class="hljs-number"><span class="hljs-number">2</span></span> #     ,     bridge=$(asterisk -rx <span class="hljs-string"><span class="hljs-string">'core show channels concise'</span></span> | grep SIP/$exten- | cut -d <span class="hljs-string"><span class="hljs-string">'!'</span></span> -f13 ) #  bridge-id       SIP/xx-aaaaa channel=$(asterisk -rx <span class="hljs-string"><span class="hljs-string">'core show channels concise'</span></span> | grep $bridge | grep -v SIP/$exten- | cut -d <span class="hljs-string"><span class="hljs-string">'!'</span></span> -f1) #  channel      SIP/provider-<span class="hljs-number"><span class="hljs-number">000000</span></span> result=$(asterisk -rx <span class="hljs-string"><span class="hljs-string">"channel redirect $channel $context,$num,1"</span></span>) #       echo $result exit <span class="hljs-number"><span class="hljs-number">0</span></span></code> <br> <br>      -    ,     .   ‚Äú‚Äù CRM   . <br> <br>      ?                  ,    CRM      asterisk  .  ,      ,     . <br> <br>      --,    ,         ,           .</code> </pre> <code><code>channel redirect &lt;[[context,]exten,]priority&gt; <br> <br>      AMI: <br> <br> Action: Redirect <br> [ActionID:] value <br> Channel: value <br> [ExtraChannel:] value <br> Exten: value <br> [ExtraExten:] value <br> Context: value <br> [ExtraContext:] value <br> Priority: value <br> [ExtraPriority:] value&gt; <br></code> <br> <br>    :   ,    ,      . <br> <br>  ,       .      bridge show all     . <br> <br> <code>&gt; bridge show all <br> Bridge-ID Chans Type Technology <br> 14418b64-0635-46e7-bd48-f4b820461eaa 2 basic simple_bridge</code> <br> <br>   bridge show &lt;bridge-id&gt;    ,      . <br> <br> ,    bridge-id     ,            bridge-id,         : <br> <br> <code>&gt; core show channels concise <br> SIP/RT-00000453!incoming!!1!Up!AppDial!(Outgoing Line)!89063448810!!!3!134!14418b64-0635-46e7-bd48-f4b820461eaa!1479984681.1659 <br> SIP/67-00000452!macro-dialout-trunk!s!23!Up!Dial!SIP/RT/89063448810,300,TtL(7200000)!67!!!3!134!14418b64-0635-46e7-bd48-f4b820461eaa!1479984681.1658</code> <br> <br>  ,        2    bridge-id(14418b64-0635-46e7-bd48-f4b820461eaa),      .         .   bash-,     (  FreePBX 13): <br> <br> <code class="bash">#!/bin/bash context="from-internal" #  ,      exten=$1 #    num=$2 #     ,     bridge=$(asterisk -rx 'core show channels concise' | grep SIP/$exten- | cut -d '!' -f13 ) #  bridge-id       SIP/xx-aaaaa channel=$(asterisk -rx 'core show channels concise' | grep $bridge | grep -v SIP/$exten- | cut -d '!' -f1) #  channel      SIP/provider-000000 result=$(asterisk -rx "channel redirect $channel $context,$num,1") #       echo $result exit 0</code> <br> <br>      -    ,     .   ‚Äú‚Äù CRM   . <br> <br>      ?                  ,    CRM      asterisk  .  ,      ,     . <br> <br>      --,    ,         ,           .</code> </div><p>Source: <a href="https://habr.com/ru/post/316138/">https://habr.com/ru/post/316138/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316126/index.html">Interweaving the narrative into the procedural worlds</a></li>
<li><a href="../316128/index.html">TCP puzzles</a></li>
<li><a href="../316132/index.html">Google Chrome Developer Console: Ten Unobvious Utilities</a></li>
<li><a href="../316134/index.html">How to make the presentation interactive</a></li>
<li><a href="../316136/index.html">Pro Rendering Optimization - With Optimism</a></li>
<li><a href="../316140/index.html">How to test a legacy without pain and fear</a></li>
<li><a href="../316142/index.html">How we built a cloud backend for a mobile shooter</a></li>
<li><a href="../316144/index.html">Ambient Occlusion Volumes for burnt samovars</a></li>
<li><a href="../316146/index.html">FlyElephant celebrates its first year of public access and announces cooperation with HPC-HUB</a></li>
<li><a href="../316148/index.html">Monitoring the status of your resource using Telegram-bot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>