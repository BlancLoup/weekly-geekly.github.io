<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Introduction to Actors Based on Java / GPars, Part I</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The API of the GPars library and the solution of a multi-threaded problem of medium complexity are briefly discussed, the results of which can be usef...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Introduction to Actors Based on Java / GPars, Part I</h1><div class="post__text post__text-html js-mediator-article">  The API of the <a href="http://gpars.codehaus.org/">GPars</a> library and the solution of a multi-threaded problem of medium complexity are briefly discussed, the results of which can be useful in the ‚Äúnational economy‚Äù. <br><br>  This article was written in the course of researching various actor libraries available to a Java programmer in preparation for reading the course <a href="http://habrahabr.ru/company/golovachcourses/blog/217051/">Multicore programming in Java</a> . <br><br>  I also teach <a href="https://www.udemy.com/scala-for-java-developers-ru/%3FcouponCode%3DHABR-GPARS">Scala for Java Developers</a> on the udemy.com online education platform (equivalent to Coursera / EdX). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is the first article in a series of articles whose goal is to compare the API, speed, and implementation of Akka actors with implementations in other libraries on a model problem.  This article offers this task and solution on GPars. <br><br>  GPars is a Clojure library with extensive support for various parallel computing approaches. <br>  GPars pros <br><ul><li>  The source code is written in Java (as opposed to Akka, written in Scala).  It is always interesting to see "what's under the hood" in the "native" programming language. </li><li>  GPars is a whole ‚Äúzoo‚Äù of approaches (Actor, Agent, STM, CSP, Dataflow) </li><li>  GPars uses classes from the Clojure runtime library written in Java.  It is interesting to dig </li></ul><br><a name="habracut"></a><br><h4>  "Installation" GPars </h4><br>  Connect to Maven GPars and Groovy <br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.codehaus.gpars<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>gpars<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.1.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.codehaus.groovy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>groovy-all<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.2.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Without Maven, just download from the <a href="http://search.maven.org/remotecontent%3Ffilepath%3Dorg/codehaus/gpars/gpars/1.1.0/gpars-1.1.0.jar">GPars-1.1.0</a> ( <a href="http://search.maven.org/remotecontent%3Ffilepath%3Dorg/codehaus/gpars/gpars/1.1.0/gpars-1.1.0-sources.jar">sources</a> ) and <a href="http://search.maven.org/remotecontent%3Ffilepath%3Dorg/codehaus/groovy/groovy-all/2.2.2/groovy-all-2.2.2.jar">Groovy-2.2.2</a> ( <a href="http://search.maven.org/remotecontent%3Ffilepath%3Dorg/codehaus/groovy/groovy-all/2.2.2/groovy-all-2.2.2-sources.jar">sources</a> ) repository and connect to the project. <br><br><h4>  Stateless actor </h4><br>  Let's start with simple examples. <br>  We send the message to the actor. <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Demo { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { Actor actor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DynamicDispatchActor() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(String msg) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("receive: " + msg); } }.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); actor.send("Hello!"); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } } &gt;&gt; receive: Hello!</code> </pre><br><br>  We send the message and we wait for the answer <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Demo { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { Actor actor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DynamicDispatchActor() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(String msg) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("ping: " + msg); getSender().send(msg.toUpperCase()); } }.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("pong: " + actor.sendAndWait("Hello!")); } } &gt;&gt; ping: Hello! &gt;&gt; pong: HELLO!</code> </pre><br><br>  We send the message and we hang up on the answer asynchronous callback <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.MessagingRunnable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Demo { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { Actor actor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DynamicDispatchActor() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(String msg) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("ping: " + msg); getSender().send(msg.toUpperCase()); } }.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); actor.sendAndContinue("Hello!", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MessagingRunnable&lt;String&gt;() { protected <span class="hljs-type"><span class="hljs-type">void</span></span> doRun(String msg) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("pong: " + msg); } }); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } } &gt;&gt; ping: Hello! &gt;&gt; pong: HELLO!</code> </pre><br><br>  Making pattern matching by type of received message <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Actor actor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DynamicDispatchActor() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String arg)</span></span></span><span class="hljs-function"> </span></span>{ getSender().send(arg.toUpperCase()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long arg)</span></span></span><span class="hljs-function"> </span></span>{ getSender().send(<span class="hljs-number"><span class="hljs-number">1000</span></span> + arg); } }.start(); System.out.println(<span class="hljs-string"><span class="hljs-string">"42.0 -&gt; "</span></span> + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">42.0</span></span>)); } } &gt;&gt; Hello! -&gt; HELLO! &gt;&gt; <span class="hljs-number"><span class="hljs-number">42</span></span> -&gt; <span class="hljs-number"><span class="hljs-number">1042</span></span></code> </pre><br><br>  Pattern matching did not find a suitable handler. <br><pre> <code class="hljs cs">import groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Demo</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">) throws Exception</span></span> { Actor actor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DynamicDispatchActor() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String arg</span></span></span><span class="hljs-function">)</span></span> { getSender().send(arg.toUpperCase()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMessage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Long arg</span></span></span><span class="hljs-function">)</span></span> { getSender().send(<span class="hljs-number"><span class="hljs-number">1000</span></span> + arg); } }.start(); System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(<span class="hljs-string"><span class="hljs-string">"42.0 -&gt; "</span></span> + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">42.0</span></span>)); } } &gt;&gt; An exception occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the Actor thread Actor Thread <span class="hljs-number"><span class="hljs-number">1</span></span> &gt;&gt; groovy.lang.MissingMethodException: No signature of method: &gt;&gt; net.golovach.Demo_4$<span class="hljs-number"><span class="hljs-number">1.</span></span>onMessage() <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> applicable <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> argument types: (java.lang.Double) values: [<span class="hljs-number"><span class="hljs-number">42.0</span></span>] &gt;&gt; Possible solutions: onMessage(java.lang.Long), onMessage(java.lang.String) &gt;&gt; at org.codehaus.groovy.runtime.ScriptBytecodeAdapter ... &gt;&gt; ...</code> </pre><br><br>  What can be seen <br>  - ‚Äúpattern matching‚Äù makes the selection of a suitable overloaded (overloaded) version of the onMessage (&lt;one-arg&gt;) method, if there is none, then we ‚Äúget‚Äù an exception <br>  - the actors work on the basis of a pool of threads, ‚Äúdemons‚Äù, so we need to somehow suspend the work of the main () method (I used System.in.read ()) in order to prevent the premature termination of the JVM <br>  - using the reply () method as an example, we see that when inheriting from DynamicDispatchActor, the actor‚Äôs namespace contains many methods (reply, replyIfExists, getSender, terminate, ...) <br><br>  Although the authors of GPars call the heirs of the DynamicDispatchActor class <a href="http://gpars.org/guide/guide/actors.html">stateless actor</a> , these are regular instances of java classes that can have mutated fields and store their state in them.  Show it <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> StatelessActorTest { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws InterruptedException { Actor actor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DynamicDispatchActor() { private final List&lt;<span class="hljs-type"><span class="hljs-type">Double</span></span>&gt; state = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(final <span class="hljs-type"><span class="hljs-type">Double</span></span> msg) { state.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(msg); reply(state); } }.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("answer: " + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">1.0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("answer: " + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">2.0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("answer: " + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">3.0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("answer: " + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">4.0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("answer: " + actor.sendAndWait(<span class="hljs-number"><span class="hljs-number">5.0</span></span>)); } } &gt;&gt; answer: [<span class="hljs-number"><span class="hljs-number">1.0</span></span>] &gt;&gt; answer: [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>] &gt;&gt; answer: [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>] &gt;&gt; answer: [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>] &gt;&gt; answer: [<span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>, <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-number"><span class="hljs-number">4.0</span></span>, <span class="hljs-number"><span class="hljs-number">5.0</span></span>]</code> </pre><br><br><h4>  Statefull actor </h4><br>  Introducing the stateless / statefull division, the authors mean that Statefull Actor allows you to seamlessly create implementations of the State pattern.  Consider a simple example (inheritors of DefaultActor - Statefull Actors) <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.MessagingRunnable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> java.util.Arrays.asList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatefulActorTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Actor actor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyStatefulActor().start(); actor.send(<span class="hljs-string"><span class="hljs-string">"A"</span></span>); actor.send(<span class="hljs-number"><span class="hljs-number">1.0</span></span>); actor.send(Arrays.asList(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); actor.send(<span class="hljs-string"><span class="hljs-string">"B"</span></span>); actor.send(<span class="hljs-number"><span class="hljs-number">2.0</span></span>); actor.send(Arrays.asList(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)); System.in.read(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyStatefulActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">act</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ loop(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagingRunnable&lt;Object&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRun</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Object msg)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"react: "</span></span> + msg); } }); } }); } } } &gt;&gt; react: A &gt;&gt; react: <span class="hljs-number"><span class="hljs-number">1.0</span></span> &gt;&gt; react: [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] &gt;&gt; react: B &gt;&gt; react: <span class="hljs-number"><span class="hljs-number">2.0</span></span> &gt;&gt; react: [<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>]</code> </pre><br><br>  However, the promised implementation of the State pattern does not ‚Äúsmell‚Äù at all.  Let's go on this side (Java is not the best language for such tricks; Clojure / Scala doesn‚Äôt have this code much more compact) <br><pre> <code class="hljs cs">import groovyx.gpars.MessagingRunnable; import groovyx.gpars.actor.*; import java.util.List; import <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> java.util.Arrays.asList; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StatefulActorTest</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">) throws Exception</span></span> { Actor actor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyStatefulActor().start(); actor.send(<span class="hljs-string"><span class="hljs-string">"A"</span></span>); actor.send(<span class="hljs-number"><span class="hljs-number">1.0</span></span>); actor.send(asList(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); actor.send(<span class="hljs-string"><span class="hljs-string">"B"</span></span>); actor.send(<span class="hljs-number"><span class="hljs-number">2.0</span></span>); actor.send(asList(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)); System.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.read(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyStatefulActor</span></span> <span class="hljs-title"><span class="hljs-title">extends</span></span> <span class="hljs-title"><span class="hljs-title">DefaultActor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">act</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { loop(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagingRunnable&lt;String&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRun</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">final String msg</span></span></span><span class="hljs-function">)</span></span> { System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(<span class="hljs-string"><span class="hljs-string">"Stage #0: "</span></span> + msg); react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagingRunnable&lt;Double&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRun</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">final Double msg</span></span></span><span class="hljs-function">)</span></span> { System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(<span class="hljs-string"><span class="hljs-string">" Stage #1: "</span></span> + msg); react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagingRunnable&lt;List&lt;Integer&gt;&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRun</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">final List&lt;Integer&gt; msg</span></span></span><span class="hljs-function">)</span></span> { System.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(<span class="hljs-string"><span class="hljs-string">" Stage #2: "</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>); } }); } }); } }); } }); } } } &gt;&gt; Stage <span class="hljs-meta"><span class="hljs-meta">#0: A &gt;&gt; Stage #1: 1.0 &gt;&gt; Stage #2: [1, 2, 3] &gt;&gt; &gt;&gt; Stage #0: B &gt;&gt; Stage #1: 2.0 &gt;&gt; Stage #2: [4, 5, 6]</span></span></code> </pre><br><br>  Well, or let's get rid of this terrible nesting of anonymous classes and ‚Äúmaterialize states‚Äù <br><pre> <code class="hljs scala"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.<span class="hljs-type"><span class="hljs-type">MessagingRunnable</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.<span class="hljs-type"><span class="hljs-type">List</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> static java.util.<span class="hljs-type"><span class="hljs-type">Arrays</span></span>.asList; public <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StatefulActorTest</span></span></span><span class="hljs-class"> </span></span>{ public static void main(<span class="hljs-type"><span class="hljs-type">String</span></span>[] args) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> <span class="hljs-type"><span class="hljs-type">Exception</span></span> { <span class="hljs-type"><span class="hljs-type">Actor</span></span> actor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">MyStatefulActor</span></span>().start(); actor.send(<span class="hljs-string"><span class="hljs-string">"A"</span></span>); actor.send(<span class="hljs-number"><span class="hljs-number">1.0</span></span>); actor.send(asList(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)); actor.send(<span class="hljs-string"><span class="hljs-string">"B"</span></span>); actor.send(<span class="hljs-number"><span class="hljs-number">2.0</span></span>); actor.send(asList(<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>)); <span class="hljs-type"><span class="hljs-type">System</span></span>.in.read(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyStatefulActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void act() { loop(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Runnable</span></span>() { public void run() { react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Stage0</span></span>(<span class="hljs-type"><span class="hljs-type">MyStatefulActor</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); } }); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stage0</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessagingRunnable&lt;String&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-type"><span class="hljs-type">DefaultActor</span></span> owner; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">Stage0</span></span>(<span class="hljs-type"><span class="hljs-type">DefaultActor</span></span> owner) {<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.owner = owner;} <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void doRun(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-type"><span class="hljs-type">String</span></span> msg) { <span class="hljs-type"><span class="hljs-type">System</span></span>.out.println(<span class="hljs-string"><span class="hljs-string">"Stage #0: "</span></span> + msg); owner.react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Stage1</span></span>(owner)); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stage1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessagingRunnable&lt;Double&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-type"><span class="hljs-type">DefaultActor</span></span> owner; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-type"><span class="hljs-type">Stage1</span></span>(<span class="hljs-type"><span class="hljs-type">DefaultActor</span></span> owner) {<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.owner = owner;} <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void doRun(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-type"><span class="hljs-type">Double</span></span> msg) { <span class="hljs-type"><span class="hljs-type">System</span></span>.out.println(<span class="hljs-string"><span class="hljs-string">" Stage #1: "</span></span> + msg); owner.react(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Stage2</span></span>()); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stage2</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessagingRunnable&lt;List&lt;Integer&gt;&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> void doRun(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-type"><span class="hljs-type">List</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Integer</span></span>&gt; msg) { <span class="hljs-type"><span class="hljs-type">System</span></span>.out.println(<span class="hljs-string"><span class="hljs-string">" Stage #2: "</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>); } } }</code> </pre><br>  Yes, yes, I fully agree with you, Java is an extremely verbose language. <br><br>  This is how the transition diagram looks like (we didn‚Äôt do a fork in the argument) <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ START /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ----- /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | +--------+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +-&gt;| Stage0 | ---String----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +--------+ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ^ v /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | +--------+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | Stage1 | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ List&lt;Integer&gt; +--------+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | +--------+ Double /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +--| Stage2 |&lt;-------+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +--------+</span></span></code> </pre><br><br><h4>  Timer </h4><br>  To solve my problem, I will need a timer - something that can be programmed to notify me of the end of a certain period of time.  In "normal" Java, we use java.util.concurrent. ScheduledThreadPoolExecutor or java.util.Timer at worst.  But we are in the world of actors! <br>  This is a Statefull Actor that hangs waiting for a message in the react () method with a timeout.  If no message arrives during this period of time, the GPars infrastructure sends us the message Actor.TIMEOUT (this is just the ‚ÄúTIMEOUT‚Äù string) and we ‚Äúreturn‚Äù the message from the timeoutMsg constructor to our creator.  If you want to "turn off" the timer - send him any other message (I will send him the string "KILL") <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.MessagingRunnable; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.impl.MessageStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> java.util.concurrent.TimeUnit.MILLISECONDS; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Timer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> timeout; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> T timeoutMsg; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MessageStream replyTo; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Timer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout, T timeoutMsg, MessageStream replyTo)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeout = timeout; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeoutMsg = timeoutMsg; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.replyTo = replyTo; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">act</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ loop(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ react(timeout, MILLISECONDS, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessagingRunnable() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doRun</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object argument)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Actor.TIMEOUT.equals(argument)) { replyTo.send(timeoutMsg); } terminate(); } }); } }); } }</code> </pre><br><br>  An example of using a timer. <br>  I create two timers, timerX and timerY, which with a delay of 1000ms will send me messages ‚ÄúX‚Äù and ‚ÄúY‚Äù, respectively.  But after 500ms I changed my mind and ‚Äúhit‚Äù timerX. <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.Actor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.impl.MessageStream; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> TimerDemo { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { Actor timerX = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Timer&lt;&gt;(<span class="hljs-number"><span class="hljs-number">1000</span></span>, "X", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MessageStream() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> MessageStream send(<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> msg) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("timerX send timeout message: '" + msg + "'"); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } }).<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); Actor timerY = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Timer&lt;&gt;(<span class="hljs-number"><span class="hljs-number">1000</span></span>, "Y", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MessageStream() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> MessageStream send(<span class="hljs-keyword"><span class="hljs-keyword">Object</span></span> msg) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("timerY send timeout message: '" + msg + "'"); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this; } }).<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); Thread.sleep(<span class="hljs-number"><span class="hljs-number">500</span></span>); timerX.send("KILL"); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } } &gt;&gt; timerY send timeout message: <span class="hljs-string"><span class="hljs-string">'Y'</span></span></code> </pre><br><br><h4>  Problem statement and solution scheme </h4><br>  Consider the following very general problem. <br>  1. We have many threads that quite often call some function. <br>  2. This function has two options: processing one argument and processing an argument list. <br>  3. This function is such that the processing of the argument list consumes less system resources than the sum of each individual processing. <br>  4. The task is to place some Batcher between the threads and the function, which collects the arguments from the threads in a ‚Äúbundle‚Äù, transfers the functions, it processes the list, Batcher ‚Äúdistributes‚Äù the results to the senders. <br>  5. Batcher transmits the list of arguments in two cases: they collected a ‚Äúpack‚Äù of sufficient size or after a waiting time, during which it was not possible to assemble a full ‚Äúpack‚Äù, but it was time for the threads to return the results. <br><br>  Let's look at the solution scheme. <br>  Timeout 100ms, the maximum size of the "pack" - 3 arguments <br><br>  At time 0, flow T-0 sends the argument ‚ÄúA‚Äù.  Batcher is in "pure" state, generation 0 <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 --"A"-----&gt; +-------+ generationId=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[]</span></span></code> </pre><br><br>  After a moment, Batcher knows that it is necessary to short ‚ÄúA‚Äù and return T-0 to the stream.  A timer is set for generation 0 <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:0.001 +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["A"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-0]</span></span></code> </pre><br><br>  At time of 25 milliseconds, the T-1 thread sends ‚ÄúB‚Äù to the processing. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:25 +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 ---"B"----&gt; |Batcher| argList=["A"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-0]</span></span></code> </pre><br><br>  After a moment, Batcher knows that it is necessary to shortcut ‚ÄúA‚Äù and ‚ÄúB‚Äù and return it to the T-0 and T-1 streams. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:25.001 +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["A","B"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-0,T-1]</span></span></code> </pre><br><br>  At time of 50 milliseconds, the T-2 stream sends ‚ÄúC‚Äù to processing. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:50 +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["A","B"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 ----"C"---&gt; +-------+ replyToList=[T-0,T-1]</span></span></code> </pre><br><br>  After a moment, Batcher knows that it is necessary to shortcut ‚ÄúA‚Äù, ‚ÄúB‚Äù and ‚ÄúC‚Äù and return to the T-0, T-1 and T-2 streams.  Finds out that the "pack" is full and "kills" the timer <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +-"KILL"-&gt;|Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:50.001 | +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=0 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["A","B","C"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-0,T-1,T-2]</span></span></code> </pre><br><br>  After a moment, Batcher gives the data to the computation in a separate actor (anonimous), clears the state and changes the generation from 0 to 1 <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:50.002 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+ argList=["A","B","C"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |anonymous| replyToList=[T-0,T-1,T-2] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+</span></span></code> </pre><br><br>  After a moment (for the ‚Äústoryboard‚Äù I will assume that the calculations are instantaneous), the anonymous actor performs the action on the argument list [‚ÄúA‚Äù, ‚ÄúB‚Äù, ‚ÄúC‚Äù] -&gt; [‚Äúres # A‚Äù, ‚Äúres # B‚Äù, ‚Äú res # C ‚Äù] <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:50.003 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+ resultList=["res#A","res#B","res#B"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |anonymous| replyToList=[T-0,T-1,T-2] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+</span></span></code> </pre><br><br>  After a moment, an anonymous actor distributes the results of calculations to threads <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:50.004 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 &lt;-----------+ +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 &lt;---------+ | |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 &lt;-------+ | | +-------+ replyToList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | | +---"res#A"--- +---------+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | +---"res#B"----- |anonymous| /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +--"res#C"-------- +---------+</span></span></code> </pre><br><br>  After a moment, the system returns to its original ‚Äúclean‚Äù state. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:50.005 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[]</span></span></code> </pre><br><br>  Later, at the time point, the 75th T-2 stream passes the ‚ÄúD‚Äù to the calculation. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:75 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 ----"D"---&gt; +-------+ replyToList=[]</span></span></code> </pre><br><br>  After a moment, the Batcher knows that it is necessary to shortcut ‚ÄúD‚Äù and return to the T-2 stream. In addition, a timer has been launched for generation 1 <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:75.001 +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["D"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-2]</span></span></code> </pre><br><br>  After 100ms (at the time of 175ms), the infrastructure of GPars notifies the timer about the expiration of the waiting period. <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +--"TIMEOUT"-- /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ v /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:175 +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["D"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-2]</span></span></code> </pre><br><br>  A moment later, the timer notifies Batcher that generation 1 has timed out and ends suicide by terminating () <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/ +-----+ timeoutMsg=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +----1-----|Timer| timeout=100 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/time:175.001 | +-----+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ v /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=1 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=["D"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[T-2]</span></span></code> </pre><br><br>  An anonymous actor is created that performs calculations on the argument list (there are only 1 argument).  The generation from 1 changes to 2 <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:175.002 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+ argList=["D"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |anonymous| replyToList=[T-2] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+</span></span></code> </pre><br><br>  Actor has done the job <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:175.003 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+ resultList=["res#D"] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ |anonymous| replyToList=[T-2] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+</span></span></code> </pre><br><br>  Actor gives the result <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:175.004 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+generationId=2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher|argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 &lt;-------+ +-------+replyToList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ | +---------+ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +--"res#C"----- |anonymous| /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ +---------+</span></span></code> </pre><br><br>  The system is in its original "clean" state <br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/time:175.005 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-0 +-------+ generationId=2 /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-1 |Batcher| argList=[] /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ T-2 +-------+ replyToList=[]</span></span></code> </pre><br><br><h4>  The solution of the problem </h4><br><br>  BatchProcessor - interface "functions".  batch processing enabled <br><pre> <code class="hljs php">import java.util.<span class="hljs-keyword"><span class="hljs-keyword">List</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BatchProcessor</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ARG</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RES</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;RES&gt; onBatch(<span class="hljs-keyword"><span class="hljs-keyword">List</span></span>&lt;ARG&gt; argList) throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>; }</code> </pre><br><br>  Batcher is a class that packs arguments.  Core solution <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.impl.MessageStream; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Batcher&lt;ARG, RES&gt; extends DynamicDispatchActor { // fixed parameters private final BatchProcessor&lt;ARG, RES&gt; processor; private final <span class="hljs-type"><span class="hljs-type">int</span></span> maxBatchSize; private final long batchWaitTimeout; // <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> state private final List&lt;ARG&gt; argList = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(); private final List&lt;MessageStream&gt; replyToList = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(); private long generationId = <span class="hljs-number"><span class="hljs-number">0</span></span>; private Actor lastTimer; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Batcher(BatchProcessor&lt;ARG, RES&gt; processor, <span class="hljs-type"><span class="hljs-type">int</span></span> maxBatchSize, long batchWaitTimeout) { this.processor = processor; this.maxBatchSize = maxBatchSize; this.batchWaitTimeout = batchWaitTimeout; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(final ARG elem) { argList.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(elem); replyToList.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(getSender()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argList.size() == <span class="hljs-number"><span class="hljs-number">1</span></span>) { lastTimer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Timer&lt;&gt;(batchWaitTimeout, ++generationId, this).<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argList.size() == maxBatchSize) { lastTimer.send("KILL"); lastTimer = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; nextGeneration(); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(final long timeOutId) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (generationId == timeOutId) {nextGeneration();} } private <span class="hljs-type"><span class="hljs-type">void</span></span> nextGeneration() { <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DynamicDispatchActor() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> onMessage(final <span class="hljs-keyword"><span class="hljs-keyword">Work</span></span>&lt;ARG, RES&gt; <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>) throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { List&lt;RES&gt; resultList = <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>.batcher.onBatch(<span class="hljs-keyword"><span class="hljs-keyword">work</span></span>.argList); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; resultList.size(); k++) { <span class="hljs-keyword"><span class="hljs-keyword">work</span></span>.replyToList.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(k).send(resultList.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(k)); } terminate(); } }.<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>().send(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Work</span></span>&lt;&gt;(processor, <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(argList), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(replyToList))); argList.clear(); replyToList.clear(); generationId = generationId + <span class="hljs-number"><span class="hljs-number">1</span></span>; } private static <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Work</span></span>&lt;ARG, RES&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> final BatchProcessor&lt;ARG, RES&gt; batcher; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> final List&lt;ARG&gt; argList; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> final List&lt;MessageStream&gt; replyToList; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Work</span></span>(BatchProcessor&lt;ARG, RES&gt; batcher, List&lt;ARG&gt; argList, List&lt;MessageStream&gt; replyToList) { this.batcher = batcher; this.argList = argList; this.replyToList = replyToList; } } }</code> </pre><br><br>  BatcherDemo - demonstration of the work of the class Batcher.  Coincides with the schematic plan. <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovyx.gpars.actor.Actor; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> static java.util.concurrent.Executors.newCachedThreadPool; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> BatcherDemo { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static final <span class="hljs-type"><span class="hljs-type">int</span></span> BATCH_SIZE = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static final long BATCH_TIMEOUT = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">void</span></span> main(String[] args) throws InterruptedException, IOException { final Actor actor = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Batcher&lt;&gt;(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BatchProcessor&lt;String, String&gt;() { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> List&lt;String&gt; onBatch(List&lt;String&gt; argList) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("onBatch(" + argList + ")"); ArrayList&lt;String&gt; result = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;&gt;(argList.size()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String arg : argList) { result.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>("res#" + arg); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }, BATCH_SIZE, BATCH_TIMEOUT).<span class="hljs-keyword"><span class="hljs-keyword">start</span></span>(); ExecutorService exec = newCachedThreadPool(); exec.submit(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Callable&lt;<span class="hljs-type"><span class="hljs-type">Void</span></span>&gt;() { // T<span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">Void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>() throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(actor.sendAndWait(("A"))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }); exec.submit(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Callable&lt;<span class="hljs-type"><span class="hljs-type">Void</span></span>&gt;() { // T<span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">Void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>() throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">25</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(actor.sendAndWait(("B"))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }); exec.submit(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Callable&lt;<span class="hljs-type"><span class="hljs-type">Void</span></span>&gt;() { // T<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">Void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>() throws <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(actor.sendAndWait(("C"))); Thread.sleep(<span class="hljs-number"><span class="hljs-number">25</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(actor.sendAndWait(("D"))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }); exec.shutdown(); } } &gt;&gt; onBatch([A, B, C]) &gt;&gt; res#A &gt;&gt; res#B &gt;&gt; res#C &gt;&gt; onBatch([D]) &gt;&gt; res#D</code> </pre><br><br><h4>  Conclusion </h4><br>  In my view, actors are good at programming multi-threaded primitives, which are finite automata with a complex transition diagram, which, among other things, may depend on the incoming arguments. <br><br>  Some examples of this article are variations of the code found on the web in various places, including <a href="http://gpars.org/guide/index.html">gpars.org/guide</a> . <br><br>  In the second part we <br><ul><li>  Let's measure the speed of the proposed solution </li><li>  Let's speed up work with JDBC by combining requests from different streams from separate transactions into one big RDBMS transaction.  That is, let's make batch not within the same Connection, but between different Connection s. </li></ul><br><br>  <b>UPD</b> <br>  Thanks for the comment <a href="https://habrahabr.ru/users/fury/" class="user_link">Fury</a> : <br>  GPars is written in a mix of Java + Groovy. <br>  The <a href="http://search.maven.org/remotecontent%3Ffilepath%3Dorg/codehaus/gpars/gpars/1.1.0/gpars-1.1.0-sources.jar">source code</a> shows that packages are written in Groovy <br>  - groovyx.gpars.csp. * <br>  - groovyx.gpars.pa. * <br>  - groovyx.gpars. * (Partially) <br><br><h4>  Contacts </h4><br><br>  I do Java online training (here <a href="http://golovachcourses.com/">are the programming courses</a> ) and publish some of the training materials as part of the reworking <a href="http://habrahabr.ru/company/golovachcourses/blog/218841/">of the Java Core course</a> .  You can see videos of lectures in the audience on the <a href="http://www.youtube.com/user/KharkovITCourses">youtube channel</a> , perhaps the video of the channel is better organized in <a href="http://habrahabr.ru/company/golovachcourses/blog/215275/">this article</a> . <br><br>  skype: GolovachCourses <br>  email: GolovachCourses@gmail.com </div><p>Source: <a href="https://habr.com/ru/post/217899/">https://habr.com/ru/post/217899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217889/index.html">Video review tablet Samsung Galaxy Tab Pro 10.1</a></li>
<li><a href="../217891/index.html">Connect the elliptical trainer and pygame</a></li>
<li><a href="../217893/index.html">Microcomputer Module MB 77.07 - Russian Answer Raspberry Pi</a></li>
<li><a href="../217895/index.html">Simple Science - Experiment Digest # 30</a></li>
<li><a href="../217897/index.html">The final version of Microsoft SQL Server 2014 has been released</a></li>
<li><a href="../217901/index.html">Node.js, Require and Exports</a></li>
<li><a href="../217903/index.html">Cybathlon 2016: Cyborg Competitions</a></li>
<li><a href="../217905/index.html">Introduction to D3</a></li>
<li><a href="../217909/index.html">Simple 2D races in space under Tizen or How to win hackathon Tizen Association</a></li>
<li><a href="../217911/index.html">We control overflow of a cell of the table by means of max-width</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>