<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FPGA Accelerator Programming Example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, we talked about the new Selectel service - cloud high-performance computing on FPGA accelerators . In a new article on this topic, we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FPGA Accelerator Programming Example</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/u-/s-/li/u-s-liwcm4mufz__x0fd8yxbznk.png"><br><br>  Not so long ago, we talked about the new Selectel service - <a href="https://blog.selectel.ru/fpga-uskoriteli-uxodyat-v-oblaka/%3Futm_source%3Dblog_selectel_ru%26amp%3Butm_medium%3Dinner_referral" rel="noopener noreferrer">cloud high-performance computing on FPGA accelerators</a> .  In a new article on this topic, we consider an example of programming FPGA to build a Mandelbrot set, a well-known mathematical algorithm for visualizing fractal images.  The article uses material from the <a href="http://eulerproject.com/" rel="noopener noreferrer">Euler Project</a> website. <br><br><ul><li>  <a href="https://habr.com/ru/company/selectel/blog/418403/">Instead of the preface</a> </li><li>  <a href="https://habr.com/ru/company/selectel/blog/418403/">Looking ahead: try FPGA at work</a> </li><li>  <a href="https://habr.com/ru/company/selectel/blog/418403/">About the OpenCL standard for FPGA programming</a> </li><li>  <a href="https://habr.com/ru/company/selectel/blog/418403/">OpenCL environment for creating executable code</a> </li><li>  <a href="https://habr.com/ru/company/selectel/blog/418403/">Get to the point: building a fractal</a> </li><li>  <a href="https://habr.com/ru/company/selectel/blog/418403/">Conclusion</a> </li></ul><br><a name="habracut"></a><br><h2>  Instead of the preface </h2><br>  First, a few terms.  A computer system with an FPGA accelerator - as a rule, it is a PCIe adapter with an FPGA chip comprising x64 server.  The accelerator takes on a separate resource-intensive task in which parallel computations can be used and performs it many orders of magnitude faster than the x64 processor, unloading it and increasing the performance of the entire computing system.  For example, a calculation cycle with 100 thousand repetitions can be performed on an FPGA in just one pass instead of sequentially performing 100 thousand times on a classic x64 processor.  Logic elements, hardware resources, communication links of the FPGA chip are programmed by the user directly under the task itself, which allows to realize the task as implementation of the algorithm in silicon - Algorithm in Silicon and thereby achieve high performance, and with very modest power consumption. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Today, the threshold for entering FPGA technology is quite affordable even for startups - a server with an FPGA accelerator and all necessary software (SDK) can be rented in the Selectel cloud for reasonable money (the so-called ‚Äúcloud FPGA‚Äù), and the support of the Open CL standard in FPGA leads to that a programmer who knows how to work with the C language is able to prepare and run a program on the FPGA. <br><br><h2>  Looking ahead: try FPGA at work </h2><br>  The programming example described below for building the Mandelbrot set is already implemented on a test server <a href="https://selectel.ru/lab/fpga/%3Futm_source%3Dblog_selectel_ru%26amp%3Butm_medium%3Dinner_referral" rel="noopener noreferrer">in the Selectel Lab</a> , where anyone can rate it (registration will be required). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3AxNR1jXQWg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  The project is provided in code and prepared for compilation.  Selectel offers remote access to the server with the Intel Arria 10 FPGA accelerator.  On the server side, SDK and BSP tools are deployed for developing, debugging and compiling OpenCL code, Visual Studio for preparing host applications (control applications for the server‚Äôs central processor). <br><blockquote>  Note that the example itself does not have any practical significance; it is chosen for reasons of a visual demonstration of acceleration methods using the principles of parallelism.  In this example, the reader becomes familiar with the route of designing an application in a heterogeneous computing system with FPGA, - later this route can be used to develop your own applications with parallel computing. </blockquote>  <strong>UPDATE</strong> : In the spring of 2018, Intel introduced the high-performance hybrid Xeon Gold 6138P processor with an integrated Arria 10 FPGA chip.  It is expected that by the end of 2018 serial processors of this type will be available to customers through partners Intel.  We at Selectel are looking forward to this chip, and we hope that we will be the first in Russia to provide our customers with the opportunity to test this unique novelty. <br><br><h2>  About the OpenCL standard for FPGA programming </h2><br>  The OpenCL standard was developed by the Khronos Group - the world's leading chip and software makers such as Intel, AMD, Apple, ARM, Nvidia, Sony Computer Entertainment, and others. It is intended for writing applications that use parallel computing on various types of processors, including FPGAs.  The OpenCL standard includes the C programming language based on the C99 version of the language (the latest C99 version is ISO / IEC 9899: 1999 / Cor 3: 2007 from 2007-11-15) and the application programming environment. <br><br>  The popularity of using OpenCL for programming high-performance computing is based on the fact that it is an open standard and does not require a license to use it.  Moreover, OpenCL does not limit the range of supported devices to any particular brand, allowing the use of hardware from different manufacturers on one software platform. <br><blockquote><p>  In addition about OpenCL: <a href="https://habr.com/post/124925/" rel="nofollow noopener noreferrer">Introduction to OpenCL on Habr</a> . </p><br></blockquote>  A bit of history - the FPGA design route, which existed before the OpenCL standard, was extremely specific and time-consuming, while even exceeding the design complexity of custom-made microchips (ASIC, application-specific integrated circuit, ‚Äúspecial-purpose integrated circuit‚Äù).  It required a rigorous understanding of the hardware structure of the FPGA, the configuration of which had to be carried out in a low-level hardware description language (HDL).  Possession of this design and verification route has been and remains an art that, due to its extreme complexity, is available to a limited circle of developers. <br><br>  The emergence of the OpenCL support toolkit for FPGA from Intel has partially resolved the problem of the availability of FPGA programming for software developers.  The programmer independently selects that part of his algorithm that is suitable for processing by the method of parallel computing and describes it in C, then the OpenCL compiler for FPGA from Intel creates a binary configuration file for running this fragment of the algorithm on the accelerator. <br>  Using the familiar Visual Studio environment or the standard gcc compiler, a host application is prepared (an .exe type application running on the x64 main processor), with all the necessary support libraries included in the SDK.  When the host application starts, the FPGA firmware is loaded, the data is loaded into the chip's core, and processing starts according to the designed algorithm. <br><blockquote><p>  The FPGA (FPGA) chip is a user-reproducible, massively parallel hardware structure with millions of logic elements, thousands of DSP signal blocks and tens of megabytes of cache memory for onboard calculations without accessing the server‚Äôs main memory modules.  Fast I / O interfaces (10GE, 40GE, 100GE, PCIe Gen 3, etc.) allow you to effectively communicate with the main processor of the server. </p><br></blockquote>  The OpenCL standard is a medium for running heterogeneous software.  The environment consists of two separate parts: <br><br><ol><li>  Host software is an application running on the main CPU of the server, written in C / C ++ and using the OpenCL API feature set.  The server of the host organizes the whole process of calculations, the supply of the initial and the output data, and the interaction of all the server systems with the FPGA accelerator. </li><li>  Accelerator software is a program written in the OpenCL C language (C language with a number of restrictions), compiled for execution on an FPGA chip. </li></ol><br>  A typical server for parallel computing is an x64-based computer (for running host applications), which has a hardware FPGA accelerator, most often connected via a PCI-Express bus.  By the way, such a system is presented in the Selectel Lab. <br><br>  The sequence of programming and compiling code for an FPGA accelerator consists of two stages.  The host application code is compiled with a standard compiler (Visual C ++, GCC) to obtain an executable file in the server‚Äôs operating system (for example, * .exe).  The source code of the FPGA accelerator (kernel, kernel) is prepared by the AOC compiler as part of the SDK, to obtain a binary file (* .aocx).  This file is just designed for programming accelerator. <br><br> <a href=""><img title="Architecture on the OpenCL Compilation Environment" src="https://habrastorage.org/getpro/habr/post_images/d7d/f21/34b/d7df2134b9135739340bced60509484c.png" alt="Architecture of compilation environment for OpenCL program" width="640" height="403"></a> <br>  Fig.  Architecture of the compilation environment of the program on OpenCL <br><br>  Consider some sample code for calculating a large vector in two variants. <br>  ( <b>PS Do not shoot the pianist - hereinafter the code from the Euler Project site is used</b> ): <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> N</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;N; i++) a[i] = a[i] + c; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... inc(a,c,N); ... }</code> </pre> <br><pre> <code class="hljs cs">_<span class="hljs-function"><span class="hljs-function">kernel </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inc</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">_global </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = get_global_id(<span class="hljs-number"><span class="hljs-number">0</span></span>); a[i] = a[i] + c; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... clEnqueueNDRangeKernel(...,&amp;N,...) ... }</code> </pre> <br>  The code at the beginning is an example of how a single-threaded C implementation can look like using the method of sequential calculation of scalar elements. <br><br>  The second version of the code is a possible implementation of the algorithm on OpenCL as a function calculated on an FPGA accelerator.  There is no loop, and the calculation takes place in one iteration of the loop.  The calculation of the vector array occurs as the execution of N copies of this function.  Each copy has its own index, which is substituted into the iterator in a loop, and the number of repetitions is set from the host when the code is executed.  The iterator action is provided by the get_global_id () function, which works with an index within 0 ‚â§ index &lt;N. <br><br><h2>  Get to the point: building a fractal </h2><br>  The Mandelbrot set is an array of ‚Äúc‚Äù points on the complex plane, for which the recurrence relation Zn + 1 = Zn¬≤ + c for Z0 = 0 defines a bounded sequence. <br><br>  We define Zn = Zn + IYn, and also with = p + iq. <br>  For each point, the following sequence is calculated: <br><p>  Xn + 1 = Xn¬≤ + Yn¬≤ + p <br>  Yn + 1 = 2XnYn + q </p><br>  The calculation of the point belonging to the set at each iteration is performed as an equation <br>  Xn¬≤ + Yn¬≤ &lt;4. <br><br>  To display the Mandelbrot set on the screen, we define the rule: <br><br><ol><li>  If the inequality is satisfied at any iterations, then the point enters the set and will be shown in black. </li><li>  If the inequality is not satisfied, starting with a certain value of iterations n = N, then the color is determined by the number of iterations N. </li></ol><br>  The calculation process on the host will be as follows: <br><br><ul><li>  The calculation of the number of iterations for each point inside the pixel window is assigned to the function mandel_pixel (). </li><li>  Sequential enumeration of image points will be provided by the softwareCalculateFrame () function.  The parameters specify the real interval of the calculated points, the real algorithm step and the pointer to the image color buffer of the size (theWidth * theHeight). </li><li>  The color of the dot is matched by the theSoftColorTable palette. </li></ul><br>  Let's go to the code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> mandel_pixel( <span class="hljs-type"><span class="hljs-type">double</span></span> x0, <span class="hljs-type"><span class="hljs-type">double</span></span> y0, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> maxIterations ) { // variables <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the calculation <span class="hljs-type"><span class="hljs-type">double</span></span> x = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> y = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> xSqr = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; <span class="hljs-type"><span class="hljs-type">double</span></span> ySqr = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> iterations = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> up <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the maximum number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> iterations <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> solve // the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> <span class="hljs-type"><span class="hljs-type">point</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the image <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ( xSqr + ySqr &lt; <span class="hljs-number"><span class="hljs-number">4.0</span></span> &amp;&amp;iterations &lt; maxIterations ) { // <span class="hljs-keyword"><span class="hljs-keyword">perform</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> iteration xSqr = x*x; ySqr = y*y; y = <span class="hljs-number"><span class="hljs-number">2</span></span>*x*y + y0; x = xSqr - ySqr + x0; // <span class="hljs-keyword"><span class="hljs-keyword">increment</span></span> iteration count iterations++; } // return the iteration count return iterations; }</code> </pre> <br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">int</span></span> softwareCalculateFrame( <span class="hljs-type"><span class="hljs-type">double</span></span> aStartX, <span class="hljs-type"><span class="hljs-type">double</span></span> aStartY, <span class="hljs-type"><span class="hljs-type">double</span></span> aScale, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span>* aFrameBuffer ) { // <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> pointer <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> variables unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> * fb_ptr = aFrameBuffer; unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> j, k, pixel; // <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> position variables <span class="hljs-type"><span class="hljs-type">double</span></span> x = aStartX; <span class="hljs-type"><span class="hljs-type">double</span></span> y = aStartY; <span class="hljs-type"><span class="hljs-type">double</span></span> cur_x, cur_y; <span class="hljs-type"><span class="hljs-type">double</span></span> cur_step_size = aScale; // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the y dimension <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( j = <span class="hljs-number"><span class="hljs-number">0</span></span>, cur_y = y; j &lt; theHeight; j++, cur_y -= cur_step_size ) { // <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the x dimension <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( cur_x = x, k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k&lt; theWidth; k++, cur_x += cur_step_size ) { // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the pixel <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">window</span></span> pixel = mandel_pixel(cur_x, cur_y, theSoftColorTableSize); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( pixel == theSoftColorTableSize ) *fb_ptr++ = <span class="hljs-number"><span class="hljs-number">0x0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> *fb_ptr++ = theSoftColorTable[pixel]; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  Each pixel is calculated independently of the other, and therefore it is possible to parallelize this process.  When the algorithm is implemented, a SIMD instruction is created for the FPGA accelerator to calculate the number for each pixel of iterations (determining the color code on the palette).  The implementation of two nested loops on the image buffer is framed via OpenCL by running the operation (theWidth * theHeight). <br><br>  The kernel instances in the listing below are called the work-item, and the set of all instances is called the index space.  The features of the hardware function include the following: <br><br><ul><li>  The function declaration begins with the keyword __kernel. </li><li>  The type of hardware function - the return type is always void. </li><li>  Values ‚Äã‚Äãare returned via buffers passed as parameters. <br><ul><li>  The first three parameters define a real grid, the nodes of which correspond to the image pixels on the output. </li><li>  The fourth parameter limits the number of iterations to prevent looping for points belonging to the Mandelbrot set. </li><li>  The fifth parameter is a pointer to the output color buffer. </li><li>  The __global keyword indicates the type of memory through which the buffer will be transferred: this is the shared DDR memory (QDR) on the accelerator itself. </li><li>  The restrict keyword bans the use of indirect references to the buffer to the optimizer. </li><li>  In the 6th parameter, a pointer to the palette is passed. </li><li>  The __constant keyword optimizes buffer access by generating the cache with the read-only attribute. </li></ul><br>  The description of the function in the listing is close to the implementation for the x64 processor.  Here, the definition of the current kernel instance is made via the get_global_id function, to which the dimension number (0, 1) is passed as a parameter. <br><br>  For better optimization, an explicit indication of the start of the cycle is introduced.  In the absence of information on the number of iterations at the time of compilation, the number of cycle steps is clearly indicated, since their own hardware blocks will be created for them.  With such coding, one should ‚Äúlook around‚Äù at the capacity of a particular chip installed on the accelerator, due to the consumption of FPGA resources for a greater number of cycles. <br><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ mandelbrot_kernel.cl : Hardware implementation of the mandelbrot algorithm /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Amount of loop unrolling. #ifndef UNROLL #define UNROLL 20 #endif /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Define the color black as 0 #define BLACK 0x00000000 __kernel void hw_mandelbrot_frame ( const double x0, const double y0, const double stepSize, const unsigned int maxIterations, __global unsigned int *restrict framebuffer, __constant const unsigned int *restrict colorLUT, const unsigned int windowWidth) { /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Work-item position const size_t windowPosX = get_global_id(0); const size_t windowPosY = get_global_id(1); const double stepPosX = x0 + (windowPosX * stepSize); const double stepPosY = y0 - (windowPosY * stepSize); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Variables for the calculation double x = 0.0; double y = 0.0; double xSqr = 0.0; double ySqr = 0.0;&lt;/code</span></span>&gt; &lt;code&gt;unsigned <span class="hljs-comment"><span class="hljs-comment">#pragma while { int iterations = 0; // Perform up to the maximum number of iterations to solve // the current work-item's position in the image // The loop unrolling factor can be adjusted based on the amount of FPGA // resources available. unroll UNROLL xSqr + ySqr &lt; 4.0 &amp;&amp; iterations &lt; maxIterations ) // Perform the current iteration xSqr = x*x; ySqr = y*y; y = 2*x*y + stepPosY; x = xSqr - ySqr + stepPosX; // Increment iteration count iterations++; } // Output black if we never finished, and a color from the look up table otherwise framebuffer[windowWidth * windowPosY + windowPosX] = (iterations == maxIterations) ? BLACK : colorLUT[iterations]; }</span></span></code> </pre> <br>  The Intel FPGA SDK for OpenCL utilities package will need to be installed on the host before the hardware implementation of the algorithm is compiled.  The number of pre-installed software should include the BSP (Board Support Package) from the manufacturer of a specific accelerator card.  In the example, Intel Quartus Prime Pro 16.1 is installed with support for OpenCL and BSP Euler Thread accelerator (Intel Arria 10). <br><br>  Below is the setting of paths and environment variables.  The ALTERAOCLSDKROOT variable contains the path to the Intel FPGA SDK, and the AOCL_BOARD_PACKAGE_ROOT variable to the BSP accelerator. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> ALTERAOCLSDKROOT=C:\intelFPGA_pro\<span class="hljs-number"><span class="hljs-number">16.1</span></span>\hld <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> AOCL_BOARD_PACKAGE_ROOT=C:\intelFPGA_pro\<span class="hljs-number"><span class="hljs-number">16.1</span></span>\hld\board\euler_thread <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\quartus\bin64 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\board\a10_ref\windows64\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\hld\host\windows64\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\intelFPGA_pro\16.1\qsys\bin <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=%<span class="hljs-keyword"><span class="hljs-keyword">path</span></span>%;C:\Program Files (x86)\GnuWin32\bin\</code> </pre> <br>  For compilation, the aoc compiler from the SDK is used. <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">aoc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mandelbrot_kernel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mandelbrot_kernel</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.aocx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--board</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">thread</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-v</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-v</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">--report</span></span></code> </pre> <br>  Decipher: mandelbrot_kernel.cl is the source file, mandelbrot_kernel.aocx is the output object file for FPGA programming, thread is the name of the accelerator from the BSP package.  Key --report displays a report on the consumption of resources FPGA.  The ‚Äìv key displays diagnostic information when compiled.  The report on resource consumption for kernel is as follows: <br><br>  + ------------------------------------------------- ------------------- + <br>  ;  Estimated Resource Usage Summary; <br>  + ---------------------------------------- + -------- ------------------- + <br>  ;  Resource + Usage; <br>  + ---------------------------------------- + -------- ------------------- + <br>  ;  Logic utilization;  49%; <br>  ;  ALUTs;  26%; <br>  ;  Dedicated logic registers;  25%; <br>  ;  Memory blocks;  21%; <br>  ;  DSP blocks;  sixteen%; <br>  + ---------------------------------------- + -------- -------------------; <br><br>  To compile the host application, the example used Microsoft Visual Studio 2010 Express with Microsoft SDK 7.1 installed.  In the project settings, the configuration for x64 is selected.  Next, you should connect the folder for external header files and in the linker settings specify the path to the additional libraries of the Intel FPGA SDK. <br>  Additional directories include files = $ (ALTERAOCLSDKROOT) \ host \ include; <br>  Additional library catalogs = $ (AOCL_BOARD_PACKAGE_ROOT) \ windows64 \ lib; <br><pre> <code class="hljs tex"><span class="hljs-formula"><span class="hljs-formula">$(ALTERAOCLSDKROOT)</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">host</span></span></span></span></span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">windows</span></span></span></span></span><span class="hljs-formula">64</span><span class="hljs-tag"><span class="hljs-formula"><span class="hljs-tag">\</span></span><span class="hljs-name"><span class="hljs-formula"><span class="hljs-tag"><span class="hljs-name">lib</span></span></span></span></span><span class="hljs-formula">;</span></span></code> </pre> <br>  The general action plan for launching the kernel on the accelerator will be as follows: <br><br><ol><li>  get a list of platforms; </li><li>  get a list of devices; </li><li>  create context; </li><li>  load the kernel into the device; </li><li>  send input buffers to the device; </li><li>  run the kernel for execution; </li><li>  read the output buffer from the device; </li><li>  release context. </li></ol><br>  Consider some points related directly to the launch of the kernel.  So, one core is designed to handle one pixel of the image.  Thus, you need to run N copies of the kernel, where N is the total number of pixels in the image. <br><br>  Below we note the case when there are several accelerator boards in the server ‚Äî then the task can be distributed between them.  In each of the accelerators you need to load the kernel (file mandelbrot_kernel.aocx).  Suppose the number of accelerators is equal to numDevices, and the image lines are divided between all accelerators: <br><br><pre> <code class="hljs django"><span class="xml"><span class="xml">#define MAXDEV 10 static cl_context theContext; static cl_program theProgram; static cl_kernel theKernels[MAXDEV]; //.. // Create the program object theProgram = createProgramFromBinary( theContext, "mandelbrot_kernel.aocx", theDevices, numDevices); // Create the kernels for ( unsigned i = 0; i </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateKernel(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theProgram</span></span></span></span><span class="xml"><span class="hljs-tag">, "</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hw_mandelbrot_frame</span></span></span></span><span class="xml"><span class="hljs-tag">", &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> ); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">pixel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buffers</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">every</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; ++</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateBuffer(theContext,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_MEM_WRITE_ONLY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Preparing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">writing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">palette</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">buffer</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">every</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">device</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clCreateBuffer(theContext,</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_MEM_READ_ONLY</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">++ ) </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueWriteBuffer(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_TRUE</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Preparing</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernels</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">run</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag"> ( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">rowsPerDevice[i++]</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Create</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">ND</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">range</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">size_t</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">globalSize</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">] = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">] }; // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Set</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">arguments</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*) &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aStartX</span></span></span></span><span class="xml"><span class="hljs-tag"> ); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">double</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">offsetedStartY</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">aStartY</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aScale</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">offsetedStartY</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_double</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aScale</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_uint</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTableSize</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_mem</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_mem</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theHardColorTable</span></span></span></span><span class="xml"><span class="hljs-tag">); </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clSetKernelArg(theKernels[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">argi</span></span></span></span><span class="xml"><span class="hljs-tag">++, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cl_uint</span></span></span></span><span class="xml"><span class="hljs-tag">), (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">void</span></span></span></span><span class="xml"><span class="hljs-tag">*)&amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theWidth</span></span></span></span><span class="xml"><span class="hljs-tag">); // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Launch</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">kernel</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueNDRangeKernel(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theKernels</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">2</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">globalSize</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); } </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span></span><span class="xml"><span class="hljs-tag">( </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0;</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag"> &lt; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">numDevices</span></span></span></span><span class="xml"><span class="hljs-tag">; </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> += </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">rowsPerDevice[i++]</span></span></span></span><span class="xml"><span class="hljs-tag"> ) { // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Read</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">the</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">output</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">clEnqueueReadBuffer(theQueues[i],</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelData</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">CL_TRUE</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">thePixelDataWidth</span></span></span></span><span class="xml"><span class="hljs-tag">*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowsPerDevice</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">i</span></span></span></span><span class="xml"><span class="hljs-tag">]*</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">sizeof</span></span></span></span><span class="xml"><span class="hljs-tag">(</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">unsigned</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">int</span></span></span></span><span class="xml"><span class="hljs-tag">), &amp;</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">aFrameBuffer</span></span></span></span><span class="xml"><span class="hljs-tag">[</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowOffset</span></span></span></span><span class="xml"><span class="hljs-tag"> * </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">theWidth</span></span></span></span><span class="xml"><span class="hljs-tag">], </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">, </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">NULL</span></span></span></span><span class="xml"><span class="hljs-tag">); } / / </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">.</span></span></span></span></span></span></code> </pre><br><ul><li>  The createProgramFromBinary function creates an OpenCL program object from an object file. </li><li>  Next, for each device, a kernel is created based on the program object. </li><li>  ThePixelData buffers are created to get output from each kernel. </li><li>  A buffer is created to store the color palette and loaded into each of the accelerators. </li><li>  Next, for each device, the binding of local application parameters and kernel parameters is set using the clSetKernelArg function. </li><li>  Parameters are determined by the sequence numbers in the kernel function declaration, starting from zero. </li></ul><br>  The next important point is determining the size of the task based on the index space according to the globalSize array.  This array can be one-, two- or three-dimensional.  For each dimension, the dimension is given as an integer.  The dimension of the space will determine the order of indexing the work-item in the kernel. <br><br>  In the example, for each core, a two-dimensional space is defined, where one of the axes is the pixel row elements, the second is the set of image lines processed on this device.  In the kernel code, the pixel number in a line is obtained by calling get_global_id (0), the line number is get_global_id (1).  The globalSize variable is passed to the clEnqueueNDRangeKernel function to run the required number of kernel instances for execution. <br><br>  Upon completion of the execution of the kernels, pixel buffers are read from the device to local arrays.  Let us estimate the speed by the number of frames per second - the result is visible in the demonstration carried out at the SelectelTechDay conference ( <a href="https://habr.com/ru/company/selectel/blog/418403/">see the beginning of the article</a> ). <br><br><h2>  Conclusion </h2><br>  Programming FPGA accelerators in a high-level language has undoubtedly reduced the threshold for developers to access this technology by an order of magnitude.  For example, for those who are just mastering this toolkit, there is even an FPGA implementation of the famous <a href="https://www.altera.com/support/support-resources/design-examples/design-software/opencl/hello-world.html" rel="noopener noreferrer">‚ÄúHello World‚Äù</a> example. <br><br>  But not everything is so simple.  Writing - and especially - debugging a well-functioning algorithm of a real applied task still requires high professionalism.  Another limitation is that each FPGA chip can perform only one computational task within the framework of the application.  For another task, it must be reprogrammed again. <br><blockquote>  By the way, the platform usage model allows you to have more than one FPGA accelerator on a host, although this is a rather expensive solution. <br>  The host (host application) manages the process of creating the context (data structures for the accelerator) and the command queue.  Those.  A single host application, in which there are different subtasks for parallel computing on FPGA, can load them onto different accelerators: <br>  KERNEL1 =&gt; ACCELERATOR A <br>  KERNEL2 =&gt; ACCELERATOR B </blockquote><br>  Nevertheless, efforts to master FPGA accelerators are worth it ‚Äî in many application areas this technology is becoming indispensable: telecom, biotechnology, big data processing, pattern recognition, signal and image processing, computational mathematics, and modeling physical fields. <br><br>  Additional information to the article: <br>  <a href="http://www.altera.com/" rel="noopener noreferrer">www.altera.com</a> is the main resource for Intel FPGA technologies. <br>  <a href="http://eulerproject.com/" rel="noopener noreferrer">www.eulerproject.com</a> - the official website of the Euler Project. <br>  <a href="https://habr.com/post/269009/" rel="noopener noreferrer">Altera + OpenCL: we program under FPGA without knowledge of VHDL / Verilog</a> - article on Habr. <br><cut></cut></li></ul></div><p>Source: <a href="https://habr.com/ru/post/418403/">https://habr.com/ru/post/418403/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../418393/index.html">[Friday] How we sawed the 3d web</a></li>
<li><a href="../418395/index.html">Ilon Musk: local electromagnetic field generators will protect colonists on Mars</a></li>
<li><a href="../418397/index.html">Friday Management: Free Skillbox Webinars</a></li>
<li><a href="../418399/index.html">On the wave of Selectel FM</a></li>
<li><a href="../418401/index.html">How I did not become you: a post of love for sysadmins</a></li>
<li><a href="../418405/index.html">The principle of the inverted pyramid in analytics. We build a clear dashboard</a></li>
<li><a href="../418407/index.html">Cloud mining Hashflare closed. Money does not return</a></li>
<li><a href="../418411/index.html">Browser Network Shooter on Node.js</a></li>
<li><a href="../418415/index.html">Telegram introduced its own Passport service to verify and authorize users.</a></li>
<li><a href="../418417/index.html">Apollo: 9 months - normal flight</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>