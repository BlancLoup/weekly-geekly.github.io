<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The game "guess anime on frame" - protection against cheating</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably, many participated in games where you had to guess a movie or a series of shots from it. Very often, these tops-games are found on the forums...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The game "guess anime on frame" - protection against cheating</h1><div class="post__text post__text-html js-mediator-article">  Probably, many participated in games where you had to guess a movie or a series of shots from it.  Very often, these tops-games are found on the forums.  And recently I was shown a site entirely dedicated to guessing anime by frame.  With an automated game: taking into account points, with options for answers. <br><br>  After several games, my interest as an anime artist was satisfied, and an IT person woke up in me.  It became interesting, and what is on the site protection from cheating.  In the course of a brief analysis, it turned out that with cheat protection everything is sad, you can even hack the game with basic knowledge of JS.  Here I would go out to my IT interests, but no, I wondered what was to be done to protect such a game from cheaters.  So this article appeared. <br><img src="https://habrastorage.org/storage2/0e5/4a2/774/0e54a2774c082bfc56aa308f596886c7.png"><br>  <sup>(picture to attract attention)</sup> <br><br>  Then I will talk about the weak points found in the game and about the methods of protection against cheating for such games that I managed to invent. <br><a name="habracut"></a><br><h4>  The essence of the game </h4><br>  At each step, the player is shown a frame from the anime and 4 possible answers, of which 1 is correct.  The game goes to the first incorrectly guessed frame.  For each frame, the player is given 15 seconds.  Also, once you can skip a frame or use the hint "50 to 50". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Technical details and "hacking" of the game </h4><br>  Looking at the URLs of the site pages, I easily found that it works in PHP.  And the fact that the game took place without reloading the page spoke of using AJAX.  Client functionality was in the only script game.js. <br><br>  The first thing that disappointed me about the security of the game is that game.js is not obfuscated.  Extra spaces have been removed there, but, apart from this, the code is in its original form. <br><br>  But it was still sadder.  Running Firebug and looking at the contents of the AJAX responses, I found one very interesting option. <br><img src="https://habrastorage.org/storage2/700/7dd/ed5/7007dded5dc0e36940d3f75d1a99939a.png"><br>  Yes, this parameter contained nothing more than the index of the correct answer, from 0 to 3. I didn‚Äôt expect that everything would be so simple that it wasn‚Äôt even interesting.  Hopes that it will be necessary to connect Google Images for guessing, collapsed. <br><br>  Then there was the matter of technology.  First of all, I passed the code from game.js through JS Beautifier, having received readable code.  The code was pretty simple and without any protection.  AJAX responses were processed in the startGame function.  It only remained to override this function.  For this, I connected a small greasemonkey script. <br><br>  In the script, I simply highlighted the desired button using the response number received from the XML.  Subsequently made automatic pressing it in 2 seconds.  I will not give the code, so as not to indulge the cheaters, let them think at least a little if they wish.  There are literally 3 lines.  But I was surprised that with such protection no one with the maximum number of points appeared in the top. <br><br><h4>  Weak points of the game and protection from cheating </h4><br>  The transfer of the correct answer together with the options and the riddle is difficult even to call a weak point, the authors in general, most likely, did not think about the cheaters.  The correct answer number, of course, should be saved to the session and checked on the server side, which is easy to do with PHP. <br><br>  The first thing I‚Äôll consider is protection on the client side.  The game has two limitations in JS: it ends automatically if the time to guess a frame has expired, or in the case of switching to another window.  I do not quite understand why to prohibit switching to another window, while time is already limited.  Only if the player does not quickly google the frame.  But so decided the creators of the site. <br><br>  <b>Protection against switching to another window.</b> <br>  Its weak point is that JS is completely under the control of the client.  Fully solve the problem can not, you can only make it difficult for an attacker to break.  In order to somehow protect the game from JS changes, it, of course, needs to be obfuscated.  It would be very good to generate and obfuscate js-file on the fly every time the page loads, putting there different functions for calculating a certain token that would be tested via AJAX.  So it would be difficult for an attacker to spoof JS.  It is difficult, but not quite. <br><br>  In the end, to disable protection from switching to another window, you only need to override window.onblur.  But even this can be solved by periodically checking whether the event handler of this event has been redefined. <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> onblur_handler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ alert(<span class="hljs-string"><span class="hljs-string">'game over'</span></span>); }; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onblur = onblur_handler; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> check_onblur = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onblur !== onblur_handler) { alert(<span class="hljs-string"><span class="hljs-string">', !     IP.   !'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.onblur = onblur_handler; } } setInterval(check_onblur, <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// evil code setTimeout(function() { window.onblur = function() { console.log('cheating'); }; }, 2500);</span></span></code> </pre> <br>  An attacker, of course, may not execute our JS at all, but if it is obfuscated, and even contain some tokens for an AJAX request, this will cause trouble. <br><br>  Thus, it turns out that our application will have to send a response number and a token received from JS to the server;  and receive from the server a link to the next image and response options. <br><br>  <b>Time limit</b> <br>  With a time limit, you can do the same, leaving protection on the client side.  But you can insure, checking the time and on the server.  But it is worth considering that the picture is not instantly displayed at the client, and after clicking on the button, the request to the server does not come immediately either.  Therefore, you need to give the client some odds compared to the server.  It would be ideal to analyze the ‚Äúlag‚Äù of the client, and take action only if it is significant. <br><br>  <b>Frame repetition.</b> <br>  This problem is not entirely related to security, but I will consider it too.  The bottom line is that once frames are randomly selected, then within one game two frames can match.  It is not right.  Solve the problem can be quite simple.  Given that the total number of frames is not very large, you can load all frames (or rather, their identifiers) into the array when you start the game, sort it randomly, save the array into the session, and take turns issuing frames to the player.  In PHP, random sorting is just a function. <br><pre> <code class="php hljs">shuffle($screenshots);</code> </pre><br>  <b>Links to screenshots.</b> <br>  Another weak point of the game - links to screenshots.  On the website of the game, they all have the format of the form /web/ANIME_ID/SCREENSHOT_INDEX.jpg, that is, the answer is already displayed in the address of the picture.  Therefore, it is not necessary to give direct links to screenshots at all.  You can always give a screenshot with PHP using the same address.  Just before each new riddle you need to save to the session the identifier of the selected frame and send this frame when accessing a specific php script. <br><br>  <b>The problem of the finite number of screenshots.</b> <br>  Finally, the most difficult problem.  The fact is that the number of frames is limited, so in new games they will be repeated.  An attacker can simply write a program that collects all the frames and the corresponding anime.  After that, it remains only to compare the current frame with all saved sets using another program.  I note that if the problem of links would not have been solved, it would be enough for an attacker to compare only the links. <br><br>  In fact, any player with time can remember the frames that will be repeated.  But unlike cheaters, he will do it on his own.  To combat the cheaters, it only remains to complicate the process of software frame comparison. <br><br>  To achieve the goal, it will be necessary to make changes to the frame each time the user is transferred.  If you do not do this, it will be easy for an attacker to find two identical files of the same frame.  You can change the pictures using the GD library, included in the PHP package. <br><br>  The simplest is to randomly change the quality of the JPEG transmitted to the client. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">open_screenshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($filename)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> imagecreatefromjpeg($filename); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">echo_screenshot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image)</span></span></span><span class="hljs-function"> </span></span>{ $quality = rand(<span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); ob_start(); imagejpeg($image, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, $quality); $buffer = ob_get_clean(); header(<span class="hljs-string"><span class="hljs-string">'Content-Type: image/jpeg'</span></span>); header(<span class="hljs-string"><span class="hljs-string">'Content-Length: '</span></span>.strlen($buffer)); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $buffer; } $image = open_screenshot(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/1.jpg'</span></span>); echo_screenshot($image);</code> </pre><br>  If this is not enough, then you can play with the brightness and contrast or other filters. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image)</span></span></span><span class="hljs-function"> </span></span>{ $brightness = rand(<span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); $contrast = rand(<span class="hljs-number"><span class="hljs-number">-10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); imagefilter($image, IMG_FILTER_BRIGHTNESS, $brightness); imagefilter($image, IMG_FILTER_CONTRAST, $contrast); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $image; }</code> </pre><br>  However, all these manipulations only slightly distort the colors, but leave the possibility of a simple pixel-by-pixel comparison.  To complicate the task, you can crop the frame horizontally and vertically, keeping the proportions and then increasing it to its original size. <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cut_image</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($image)</span></span></span><span class="hljs-function"> </span></span>{ $k = rand(<span class="hljs-number"><span class="hljs-number">98000</span></span>, <span class="hljs-number"><span class="hljs-number">100000</span></span>) * <span class="hljs-number"><span class="hljs-number">0.00001</span></span>; $w1 = imagesx($image); $h1 = imagesy($image); $w2 = round($k * $w1); $h2 = round($k * $h1); $x = rand(<span class="hljs-number"><span class="hljs-number">0</span></span>, $w1 - $w2); $y = rand(<span class="hljs-number"><span class="hljs-number">0</span></span>, $h1 - $h2); $result = imagecreatetruecolor($w1, $h1); imagecopyresampled ($result, $image, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, $x, $y, $w1, $h1, $w2, $h2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; }</code> </pre><br>  Now, if there are a lot of frames in the game, the comparison task will not be so trivial.  Although if at the disposal of the attacker there are comparison algorithms like in Google Images, then this will not be a hindrance either.  As well as the effect of circumcision is less when comparing reduced versions of frames. <br><img src="https://habrastorage.org/storage2/05b/953/783/05b95378357bbe6e78e9bf25bd3a1c7a.jpg"><br>  The picture consists of 6 frame options, obtained by the above method.  As you can see, there are different values ‚Äã‚Äãof brightness and contrast everywhere.  If you look closely, you may find that in some frames the image is cropped at the edges more than in others. <br><br>  By the way, I didn‚Äôt come up with a protection from a banal googling screenshot.  Unless to distort it even more strongly, but it can affect and recognition by the person. <br><br>  Perhaps this is all I can say about the technical side of protection against cheaters in this case.  I think that such ideas would sooner or later have occurred to any developer who was concerned about the protection of such games. <br><br><h4>  Conclusion </h4><br>  After all, I have not yet become even from an IT interest, because hacking the protection of this level is not a big reason to boast. <br><br>  In fact, the lack of protection against cheating is also protection.  Cheating in this case does not give anything, and the ease of dishonest play kills any interest in it.  Of course, if the site would like to maintain real ratings, then it would be worthwhile to take care of the protection. <br><br>  By the way, I want to note that something described in this article can be applied not only to this kind of games, but to something more serious.  For example, online tests. <br><br><h5>  PS </h5>  I still haven‚Äôt written the address of the site so that it doesn‚Äôt look like an advertisement.  But I will not play with you in the "guess the site by the screenshot".  The site in question is <a href="http://guessanime.com/">guessanime.com</a> . <br>  I have nothing to do with the site.  If the article somehow touches the owners, I'm sorry. </div><p>Source: <a href="https://habr.com/ru/post/184260/">https://habr.com/ru/post/184260/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184242/index.html">Qt Charts 1.3.0 released</a></li>
<li><a href="../184244/index.html">Cheap dedicated: on what do we save?</a></li>
<li><a href="../184246/index.html">On Edward Snowden opened a criminal case for espionage</a></li>
<li><a href="../184248/index.html">Github limits the maximum file size to 100 megabytes.</a></li>
<li><a href="../184250/index.html">The "constexpr" functions do not have the "const" specifier</a></li>
<li><a href="../184262/index.html">Centrifuge - real-time messaging broker</a></li>
<li><a href="../184264/index.html">Auto-completion of SQL code directly in PHPStorm</a></li>
<li><a href="../184266/index.html">Facebook leaked personal data to 6 million users</a></li>
<li><a href="../184268/index.html">A collection of resources for frontend and backend developers</a></li>
<li><a href="../184274/index.html">Text in line or how to beat designer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>