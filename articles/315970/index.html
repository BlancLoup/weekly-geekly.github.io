<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The technique of total prescale in the lighting algorithm for a 2D 2D tile game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My last game is an isometric walker, one of the features of which is the ‚Äúexploration‚Äù of the territory: initially the map is black and the pla...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The technique of total prescale in the lighting algorithm for a 2D 2D tile game</h1><div class="post__text post__text-html js-mediator-article">  Hello!  My last game is an isometric walker, one of the features of which is the ‚Äúexploration‚Äù of the territory: initially the map is black and the player opens this ‚Äúfog of war‚Äù as the game progresses.  Moreover, the visibility of the tiles depends not only on the distance to the character, but also on the environment: the cells behind opaque walls are not visible, even if you go to a stop, and, for example, the bush shrinks the visibility of the cells behind it by 50%. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c2/ff7/02e/5c2ff702e7fb2ca479449e19d39ac7fc.png" alt="image"><br><br>  In order not to load the processor by frame-by-frame ray tracing (to determine which cell is currently visible as far as possible), I used a rather interesting ‚Äútotal pre-calculation‚Äù method - the main parameters for virtually all possible situations are considered before playing a large matrix, and during the game it remains only access it by choosing the desired values. <br><a name="habracut"></a><br>  What do I mean by preliminary calculations: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The hero is placed in the cell of the origin (0; 0).  For each cell within the visibility of the screen (with a margin, within two screens), various game parameters are counted, including a list of cells that the segment crosses from the origin to its center: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/78f/f85/3fc/78ff853fcf7d6b438a1565a0625df350.png" alt="image"><br><br>  To be more precise, such lists are counted for each of the 4 corners of each cell: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5fb/3b1/c2c/5fb3b1c2c585ff195ef1aea600636fdc.png" alt="image"><br><br>  All this data is recorded in the "matrix of appearances" M. <br><br>  How it works?  Each object in the game has an ‚Äúopacity‚Äù parameter - a value from 0 to 1, a percentage of the view being blocked.  In the game, to find out how visible the tile (xt; yt) is relative to the position of the hero (x0; y0), I need to: <br><br>  <b>1.</b> Refer to the matrix element Mt = M [xt-x0; yt-y0] <br>  <b>2.</b> Calculate how visible each of the corners of this tile is (and the corners that are blocked by the tile itself (xt; yt), so there are 2 or 3) are not taken into account: for this, I read the vector of tiles from Mt that occur on the way to the corner and I multiply the "degrees of visibility" of all the objects that are in them (and yes, as soon as an object with zero visibility is encountered, the passage through the list can not be continued). <br>  <b>3. The</b> degree of visibility of the tile Vt = arithmetic average of the appearances of each of its corners. <br><br>  So I do for each of the tiles in a certain area around the hero when something changes (the position of the hero or objects). <br><br>  The calculation in the corners instead of one center of the tile is carried out to smooth artifacts, when a cell is slightly blocked by some opaque wall with its end, but because of this the cell becomes completely invisible. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bee/432/8c1/bee4328c10b842ededb57fcc81960ac9.png" alt="image"><br><br>  The method, as you understand, is not entirely accurate (compared to honest "analog" ray tracing), but it gives good values.  Discreteness is noticeable, the less visually the smaller cells in the game. <br><br>  How much performance will increase the preliminary calculation of all parameters in the ‚Äúmatrix of appearances‚Äù (compared to determining parameters on the fly) will depend on the language, but essentially all geometric calculations are replaced by the operation of accessing the matrix / vector element.  On my AIR, the speed gain varies from 7 to 11 times (depending on the degree of loading of the map area with objects) <br><br>  The same matrix can be used to determine the illumination of a cell, when some objects can emit light, and some block it.  The algorithm here is exactly the same. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/189/578/639/18957863946353bf4226bedd0e4dec2d.png" alt="image"><br>  <i>(coins have a slight glow)</i> <br><br>  Demonstration of changing the visibility of tiles in dynamics: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/45Vey5RLd0Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/315970/">https://habr.com/ru/post/315970/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../315960/index.html">Linux wifi from the command line with wpa_supplicant</a></li>
<li><a href="../315962/index.html">The release of CLion 2016.3: improved support for C11, C ++ 11 and C ++ 14, changes in working with the CMake design model and much more</a></li>
<li><a href="../315964/index.html">About types of used routers on MSK-IX and W-IX</a></li>
<li><a href="../315966/index.html">Create a simple VR demo with the Unreal Engine</a></li>
<li><a href="../315968/index.html">How we made a bot for the bank "Opening"</a></li>
<li><a href="../315972/index.html">Protection of virtual machines located in the data center</a></li>
<li><a href="../315974/index.html">A person. Guido Van Rossum - Python Creator</a></li>
<li><a href="../315976/index.html">The train coming late: Announcement of the JPoint 2017 Java Conference</a></li>
<li><a href="../315978/index.html">As I wrote the visualization system for the stand</a></li>
<li><a href="../315982/index.html">Information on the threshold of immortality</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>