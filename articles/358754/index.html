<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Logging hits (payload) Google Analytics to Google Sheets via Google Tag Manager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task: determine which events exceed the payload size of Google Analytics 
 Solution: logging Google Analytics hits (including payload size) to Google ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Logging hits (payload) Google Analytics to Google Sheets via Google Tag Manager</h1><div class="post__text post__text-html js-mediator-article">  <b>Task:</b> determine which events exceed the payload size of Google Analytics <br>  <b>Solution:</b> logging Google Analytics hits (including payload size) to Google Sheets using Google Tag Manager, without the participation of developers <br><br><h3>  The essence of the problem </h3><br>  If you have been able to implement Enhanced Ecommerce for Google Analytics (GA) via Google Tag Manager (GTM) and then debug this business using the <a href="https://chrome.google.com/webstore/detail/google-analytics-debugger/jnkmfdileelhofjcijamephohjechhna%3Fhl%3Den">Google Analytics debugger</a> , then you have probably come across the fact that some events "for some reason" do not reach GA and Error: <b>Payload size is to large (9000).</b>  <b>Max allowed is 8192</b> <br><br><img src="https://habrastorage.org/webt/bw/l_/bq/bwl_bquweqqu88oprblyd5sbezu.png"><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Why it happens? </h3><br>  The fact is that <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/reference">the analytics.js library does not accept hits of more than 8192 bytes</a> .  If the hit size is larger, then it will not reach GA and will be empty in the event reports. <br><br>  Example situation: <br><br>  The web analyst asks the developer to push (or shoves) all product impressions in one hit.  As a result, the hit does not reach.  in the listing on one page more than 50 products.  Or 50+ different products are added to the basket, as a result of which there are problems with the events of checkout step and transaction. <br><br><h3>  What do we have to do </h3><br>  Try to always optimize the data structure of the hit (for example, send hits as the product appears in the user's field of view, do not push unnecessary variables into the hit (variant, category, brand), do not use long product names, etc.) This, firstly, will increase the speed of sending the hit;  secondly, it will allow to avoid problems with payload size. <br><br>  If it is impossible to optimize, then there are several ways to get around these limitations: <br><br><ul><li>  <a href="https://www.simoahava.com/analytics/automatically-reduce-google-analytics-payload-length/">A beautiful solution to the problem with customTask.</a>  <a href="https://www.simoahava.com/analytics/automatically-reduce-google-analytics-payload-length/">One by one, it removes unnecessary parameters from payload until it is less than 8192. You can customize what to throw out specifically.</a> </li><li>  <a href="https://www.savio.no/analytics/easier-enhanced-ecommerce-product-promo-tracking">Cut the hit into several pieces and send it into pieces.</a> </li><li>  <a href="https://support.google.com/analytics/answer/6014867%3Fhl%3Den">GA data import (we push only product id into hit, the rest is loaded in the form of a database through data import).</a> </li></ul><br><h3>  Preparation for action </h3><br>  Before we start cutting hits and optimizing the content, we will determine which events exceed the payload size. <br><br><h3>  Step 1. Setting up Google Sheets </h3><br>  Create a new table. <br><br>  In the header (1 line), write the names of the parameters that we want to extract from the hit (be careful, the names indicate exactly the same ones that you will then use in the JS script in GTM).  As an example, we extract the following data: <br><br><ul><li>  timestamp </li><li>  payLoadLength </li><li>  tid (tracking id) </li><li>  cid (client id) </li><li>  uid (user id) </li><li>  t (type of hit) </li><li>  pa (product action) </li><li>  ni (non interaction) </li><li>  dl (document location) </li><li>  dp (document path) </li><li>  dt (document title) </li><li>  ec (event category) </li><li>  ea (event action) </li><li>  el (event label) </li><li>  ti (transaction id) </li><li>  tr (transaction revenue) </li></ul><br><img src="https://habrastorage.org/webt/vp/lr/0x/vplr0xyjv-cutmotebt_yaokxzm.png" alt="image"><br>  <i>Example of mapping columns for logging payload in Google Sheet</i> <br><br>  The order of the parameters in the columns is unimportant (except for the timestamp - it must be first).  Columns with cid and ti parameters should be formatted as <b>Plain text</b> (Format&gt; Number&gt; Plain text), in order to avoid errors with auto-formatting. <br>  If you wish, you can add / remove the necessary parameters (do not forget to change the list of variables in the JS script in GTM).  <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference">List of possible fields and parameters analytics.js</a> <br><br>  Next, open the script editor and add the code (the original script belongs to Martin Hawksey <a href="https://gist.github.com/mhawksey/1276293">https://gist.github.com/mhawksey/1276293</a> ): <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handleResponse(e); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> handleResponse(e); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleResponse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lock = LockService.getPublicLock(); lock.waitLock(<span class="hljs-number"><span class="hljs-number">30000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// wait 30 seconds before conceding defeat. try { // next set where we write the data - you could write to multiple/alternate destinations var ss = SpreadsheetApp.getActiveSpreadsheet(); var sheet = ss.getSheets()[0]; // we'll assume header is in row 1 but you can override with header_row in GET/POST data var headRow = e.parameter.header_row || 1; var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0]; var nextRow = sheet.getLastRow()+1; // get next row var row = []; // loop through the header columns for (i in headers){ if (headers[i] == "timestamp"){ // special case if you include a 'timestamp' column row.push(Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "MMM d yyyy HH:mm:ss")); } else { // else use header name to get data row.push(e.parameter[headers[i]]); } } // more efficient to set values as [][] array than individually sheet.getRange(nextRow, 1, 1, row.length).setValues([row]); // return json success results return ContentService .createTextOutput(JSON.stringify({"result":"success", "row": nextRow})) .setMimeType(ContentService.MimeType.JSON); } catch(e){ // if error return this return ContentService .createTextOutput(JSON.stringify({"result":"error", "error": e})) .setMimeType(ContentService.MimeType.JSON); } finally { //release lock lock.releaseLock(); } }</span></span></code> </pre> <br>  Deploy the script as a web application (Publish&gt; Deploy as web app ...).  Permissions - anyone, even anonymous.  We publish. <br><br><img src="https://habrastorage.org/webt/ua/x4/sw/uax4swgme3mzkdb05df_3cjqqia.png"><br>  <i>Google Script editor settings</i> <br><br>  In the future, we will need the URL of our web application (Current web app URL), so do not close the tab yet. <br><br><h3>  Step 2. Configure GTM </h3><br>  Create 2 custom JavaScript variables: <br><br><ol><li>  v_EE_timestamp </li><li>  v_EE_mimic GA payload </li></ol><br><img src="https://habrastorage.org/webt/ga/qh/j2/gaqhj26vrmhuoyzchwkxikmzwdy.png"><br>  <i>JavaScript variable example in GTM</i> <br><br>  <b>The first JS variable</b> , to determine the time of sending the hit (timestamp).  This variable will be used in the second JS variable. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Get local time as ISO string with offset at the end var now = new Date(); var tzo = -now.getTimezoneOffset(); var dif = tzo &gt;= 0 ? ' Timezone: +' : ' Timezone: -'; var pad = function(num) { var norm = Math.abs(Math.floor(num)); return (norm &lt; 10 ? '0' : '') + norm; }; return now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + ' Time' + pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds()) + dif + pad(tzo / 60) + ':' + pad(tzo % 60); }</span></span></code> </pre><br>  <b>The second JS variable</b> , for catching the necessary hits and transferring them to Google Sheet (the code from <a href="https://stickler.de/en/information/analytics-tag-manager/send-analytics-hits-to-your-own-server-endpoint%3Ffilter_tag%255B0%255D%3D">this material is</a> taken as the basis). <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHitTask</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">model</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payLoad = model.get(<span class="hljs-string"><span class="hljs-string">'hitPayload'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> trackingBaseUrls = [<span class="hljs-string"><span class="hljs-string">'https://www.google-analytics.com/collect'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://script.google.com/macros/s/AKfycbxJLy3eYBLpPu_S_eNccxzn_GwHXkZWr-93feMuBaAZelk3fj01yB/exec'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; trackingBaseUrls.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> baseUrl = trackingBaseUrls[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (trackingBaseUrls[i].indexOf(<span class="hljs-string"><span class="hljs-string">'collect'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> req = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); req.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, baseUrl, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); req.send(payLoad); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (payLoad.length &gt; <span class="hljs-number"><span class="hljs-number">7500</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payLoadExtract = payLoad.split(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payLoadArray = {}; <span class="hljs-comment"><span class="hljs-comment">// Push values to array for later access for (i = 0; i &lt; payLoadExtract.length; i++){ var splitArray = payLoadExtract[i].split('='); payLoadArray[splitArray[0].trim()] = splitArray[1].trim(); } // Specify values to be sent to Google Sheets from array var tid = 'tid=' + payLoadArray.tid, cid = '&amp;cid=' + payLoadArray.cid, uid = '&amp;uid=' + payLoadArray.uid, t = '&amp;t=' + payLoadArray.t, pa = '&amp;pa=' + payLoadArray.pa, ni = '&amp;ni=' + payLoadArray.ni, dl = '&amp;dl=' + payLoadArray.dl, dp = '&amp;dp=' + payLoadArray.dp, dt = '&amp;dt=' + payLoadArray.dt, ec = '&amp;ec=' + payLoadArray.ec, ea = '&amp;ea=' + payLoadArray.ea, el = '&amp;el=' + payLoadArray.el, ti = '&amp;ti=' + payLoadArray.ti, tr = '&amp;tr=' + payLoadArray.tr, timestamp = '&amp;timestamp=' + {{v_EE_timestamp}}, payLoadLength = '&amp;payLoadLength=' + payLoad.length; var collectPayLoad = tid + cid + uid + t + pa + ni + dl + dp + dt + ec + ea + el + ti + tr + timestamp + payLoadLength; // Send Values to Google Sheets var collectUrl = baseUrl +'?'+ collectPayLoad; var myImage = new Image(); myImage.src = collectUrl; } } } }</span></span></code> </pre><br>  What you need to configure: <br><br><ul><li>  We insert the url of your web application (created in step 1) and the url google analytics into the <b>trackingBaseUrls</b> variable. </li><li>  In <b>payLoad.length</b> determine the size of the hit that you want to catch.  In the example,&gt; 7500 is set.  we catch everything that could potentially exceed the threshold of 8192 bytes.  You can put less, if the whole log is interesting. </li><li>  In <b>req.open</b> , the hit sending method is defined (it can be POST or GET, depending on the hit size; <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/reference">Google recommends using POST</a> since this allows you to send a larger payload).  By default, GA events are sent via GET.  For Enhanced Ecommerce I recommend changing the way to send to POST (done by adding to the Enhance Ecommerce tag in Fields to set: <b>transport - beakon</b> ) </li></ul><br>  Now, we find in our container a tag (tags) responsible for sending Enhanced Ecommerce events to GA and create a copy of them with binding to the corresponding triggers. <br>  In the copy of the tags, we change the GA ID to any (test / fake) and add the <b>sendHitTask</b> field and the name JS variable (v_EE_mimic GA payload) to the Fields to Set. <br>  sendHitTask, in this case, is modified i.e.  we send hit data to the test GA (you can not send it, for this, delete in the code the value <b>'https://www.google-analytics.com/collect',</b> ) and in Google Sheet (if it exceeds the specified payload size). <br>  A copy of the tags with a test GA ID is needed for security, so as not to touch the original Enhanced Ecommerce tag.  You can modify sendHitTask in the original tag (without creating copies), but then you cannot use customTask (you have to modify it by integrating sendHitTask into it) and there is a risk that the hit will not reach GA (I haven‚Äôt seen this, but better insure). <br><br><img src="https://habrastorage.org/webt/ia/ua/cn/iauacnx27rvtj1c7zxyoklrvzzw.png"><br>  <i>Enhanced Ecommerce tag settings in GTM</i> <br><br>  Save the tag, publish the new version of the GTM container. <br><br><h3>  Total </h3><br>  Now, when the Enhance Ecommerce tag is triggered, the v_EE_mimic GA payload script will also work.  If at the specified payload settings exceeds its values, this hit will be recorded in Google Sheet. <br><br>  By collecting logs by hits, you can determine which specific event did not reach GA, where it happened, in which browser, etc.  (see the <a href="https://developers.google.com/analytics/devguides/collection/analyticsjs/field-reference">list of possible fields and analytics.js parameters</a> ). <br><br>  Thanks for attention! <br><br>  I hope this material will be useful to you and make life easier with the Google Analytics debug. <br><br>  <b>PS</b> Who can / knows how to automate the verification of GTM tags (autotest for tags), please respond!  Once upon a time, Simo wrote an article about this <a href="https://www.simoahava.com/analytics/automated-tests-for-google-tag-managers-datalayer/">www.simoahava.com/analytics/automated-tests-for-google-tag-managers-datalayer</a> but couldn‚Äôt understand it, can anyone try / know other ways.  I would be very grateful for advice and assistance in this matter. </div><p>Source: <a href="https://habr.com/ru/post/358754/">https://habr.com/ru/post/358754/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358744/index.html">Marvin Minsky "The Emotion Machine": Chapter 4 "Consciousness"</a></li>
<li><a href="../358746/index.html">Developing your own visualization plugin for Grafana</a></li>
<li><a href="../358748/index.html">Codable Tips and Examples</a></li>
<li><a href="../358750/index.html">Integration of Veeam Backup & Replication and PureStorage</a></li>
<li><a href="../358752/index.html">OpenVINO Toolkit - to look at the world with a clear look</a></li>
<li><a href="../358758/index.html">Need more gold. How is marketing in GameDev-company?</a></li>
<li><a href="../358760/index.html">Sales using voice assistant Yandex: create skills for Alice</a></li>
<li><a href="../358762/index.html">Development of Clickhouse API for Rambler / Top-100</a></li>
<li><a href="../358764/index.html">Fintech-digest: blockchain-smartphone from HTC, determination of solvency by phone brand and regulation of ICO in Russia</a></li>
<li><a href="../358766/index.html">How I started to love Vue</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>