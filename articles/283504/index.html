<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of testing technology C / R in Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In 2012, Andrew Morton was pessimistic about the future of the CRIU (Checkpoint and Restore In Userspace) project when he accepted the first changes t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of testing technology C / R in Linux</h1><div class="post__text post__text-html js-mediator-article"><img width="400" align="left" src="https://habrastorage.org/files/28c/ef3/d1e/28cef3d1e1354f159c436db74d5b1379.png"><br><br>  In 2012, Andrew Morton was pessimistic about the future of the CRIU (Checkpoint and Restore In Userspace) project when he accepted the first changes to the Linux kernel to support C / R (Checkpoint / Restore).  The idea to implement the functionality of saving and restoring running processes in user space looked <a href="http://git.kernel.org/cgit/linux/kernel/git/torvalds/linux.git/commit/%3Fid%3D099469502f62fbe0d7e4f0b83a2f22538367f734">crazy</a> , and after 4 years the project is not only alive, but more and more interesting for itself.  Before the start of the CRIU project, attempts were made to implement C / R in Linux (DMTCP, BLCR, OpenVZ, CKPT, etc.), but all of them were doomed for failure for various reasons while CRIU became a viable project.  Unfortunately, the C / R task in Linux has not become any easier.  In this article I will talk about the features of testing CRIU. <a name="habracut"></a><br><br>  Books and hundreds of articles have already been written about the benefits of unit testing, the use of continuous integration systems.  These techniques are known to every experienced developer and are the absolute standard for any software project.  Therefore, we will not describe here the advantages of using these techniques, but instead we will only tell about the nuances that distinguish CRIU from other projects. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The CRIU development process itself is no different from the Linux kernel development: every new change is one complete thought.  All patches arrive on the <a href="http://lists.openvz.org/pipermail/criu">criu @</a> newsletter, where they are reviewed.  Patches that have been reviewed are added to the repository by the project manager.  Although at the review stage some of the problems in the code come to light, it‚Äôs impossible to reduce them to zero due to the number of scenarios and configurations.  Therefore, to detect degradation, we run tests for each new change.  The guarantor of the constant launch of tests is automatic working tests. <br><br>  In the early stages of development, we began to use functional tests from the <a href="https://criu.org/ZDTM_Test_Suite">ZDTM</a> (Zero DownTime Migration) test suite, which we successfully tested the <a href="https://openvz.org/Checkpointing_and_live_migration">in-kernel C / R implementation in OpenVZ</a> .  Now, each test from this set is launched separately and goes through 3 stages: preparation of the environment, ‚Äúdemonization‚Äù and waiting for a signal (which signals the test that it is time to check its status), check the result.  Tests are conditionally divided for two groups.  The first group is static tests that prepare some kind of constant environment or state and ‚Äúfall asleep‚Äù while waiting for a signal.  The second group is dynamic tests that constantly change their state and / or environment (for example, they send data via a TCP connection).  If in 2012, the CRIU unit-testing system consisted of about 70 individual test programs, today their number <a href="https://github.com/xemul/criu/tree/master/test">has increased to 200</a> .  But truly terrifying is the number of combinations that you need to run to complete CRIU testing. <br><br>  The basic configuration is the launch of the entire test suite on the host, in which each test program sits in a certain position, the test process is saved and restored, and then asked to check in the same position if it remains or not.  The next most important configuration is to check that C / R not only works, but after C the main process did not fail.  Therefore, each test must also be eliminated in the variant when only the first part is performed (without recovery) and check that the posture is observed.  This is a spontaneous test.  The reconstructed process may be in the same position, but is not suitable for repeated C / R.  So another configuration appears - repeat C / R.  Then there are configurations with snapshots, C / R surrounded by namespaces, C / R with normal user rights, C / R with backward compatibility testing, checking for successful recovery on BTRFS and NFS (because these filesystems have their own <a href="https://criu.org/Filesystems_pecularities">‚Äúfeatures‚Äù</a> ).  But in addition to C / R for individual processes, you can do group C / R - saving groups of processes, when all processes are in the same position and when each process is in its own position. <br><br>  CRIU supports several hardware architectures, now they are x86_64, ARM, AArch64, PPC64le and on the i386 approach.  The harsh reality forces us to test several kernel versions: the latest official release of the vanilla kernel, the RHEL7 core (which is based on 3.11) and the linux-next branch.  The duration of the tests is small (2-10 minutes), but if we take into account the number of combinations of existing scenarios and possible configurations, it turns out an impressive figure. <br><br>  As I already wrote, tests benefit only when they are regularly used.  Until some time, we started the tests manually, but at some point we realized that local testing takes a lot of time from the developers and set up a system to continuously run tests for each new change. <br><br>  We use two CI systems: <a href="https://travis-ci.org/xemul/criu/branches">Travis CI is</a> used to check compilation on all supported hardware architectures.  Since Travis CI uses the kernel below version 3.8, which lacks most of the patches required for CRIU, Travis is not suitable for running tests and, additionally, we use the well-known <a href="https://ci.openvz.org/view/CRIU/">Jenkins CI</a> . <br><br><h3>  findings </h3><br><br><ul><li>  assembly, testing and code coverage measurements should be automated </li><li>  there are no many tests, we have a ratio of a useful code to a test code of about 1.6 (48 KLOC vs 30 KLOC) and there is much to strive for </li><li>  if the number of configurations to test is huge, prioritize </li><li>  hands as always not enough, <a href="https://criu.org/Contacts">come to our CRIU</a> , eh? </li></ul><br><br>  <i>The CRIU project was launched in 2012 by engineers from Virtuozzo, but was later supported by <a href="https://criu.org/Community">other companies</a> interested in creating C / R technology in Linux.</i> </div><p>Source: <a href="https://habr.com/ru/post/283504/">https://habr.com/ru/post/283504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283492/index.html">Let's collect a moss-mite under a microscope or focus-stacking photos from the console</a></li>
<li><a href="../283494/index.html">Developing a simple pedometer application on ReactNative</a></li>
<li><a href="../283496/index.html">In the Opera browser appeared power saving mode</a></li>
<li><a href="../283498/index.html">Announcement of the track Windows conference DevCon 2016</a></li>
<li><a href="../283502/index.html">Chess Ice and Flame</a></li>
<li><a href="../283508/index.html">Introducing the new Intel RealSense SR300 Camera</a></li>
<li><a href="../283510/index.html">Report from Moscow Atlassian Meetup April 20</a></li>
<li><a href="../283512/index.html">How does cross-device advertising work: the complexity and prospects of technology development</a></li>
<li><a href="../283514/index.html">Bushido Mobius: Member Path</a></li>
<li><a href="../283516/index.html">.NET development: nine questions for adults</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>