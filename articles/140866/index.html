<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Support of the heated backup by means of two MikroTik'ov</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, I talked about a possible way to make centralized backup configurations from MikroTik routers. It would seem that one can calm do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Support of the heated backup by means of two MikroTik'ov</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/post/135541/">In the last article,</a> I talked about a possible way to make centralized backup configurations from MikroTik routers.  It would seem that one can calm down, but for some branches the management requires immediate restoration of work in case of failure of any part of the network.  The first thing that comes to mind is, of course, you need to have two identical glands nearby.  However, the second logical thought is that using VRRP is not suitable for a number of reasons, one of which is the use of IPSec.  So you need to again shaman crutch and synchronize the configuration in the semi-manual mode, that is, to be scripted. <br><a name="habracut"></a><br><h4>  Logics </h4><br>  1. We connect via ssh to the active router and change the address of the physical interface through which the heated router is connected to 10.0.0.1/24 <br>  2. Using port forwarding by firewall, we connect via ssh to the pre-heated router through the active <br>  3. We check the serial number to make sure that they are actually connected to the heated router, so as not to threaten the active <br>  4. Retrieve the ftp backup from the active router and reboot the reheat <br>  5. We connect via ssh to the active router and return the original physical interface address to 10.0.0.2/24, through which the heated router is connected <br>  I need manipulations with changing the address for the reason that once a day I remove backup from all routers.  Further, when I will upload a backup to a pre-heated router, I will need to somehow get to it, for this it will already have the address 10.0.0.2/24 configured, and on the active one I will temporarily set the address 10.0.0.1/24, this IP in backups will never appear.  In this way, we achieve identity configurations. <br><br><h4>  We connect the heated piece of iron </h4><br><img src="https://habrastorage.org/storage2/1cf/d06/15e/1cfd0615e4f4cbfc5475625f88c5d174.png" alt="image"><br><br>  ... as it is shown in the picture, namely - it does not matter how you connect the Internet and LAN in your case, the only important thing is that the interfaces with which we connect the active and heated routers are the same.  Further it will be clear why. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We will configure the interfaces in an identical way - yes, yes, there is nothing criminal in this. <br><br> <code>/add address=10.0.0.2/24 comment=backup disabled=no interface=ether10 network=10.0.0.0</code> <br> <br>  We also need SSH onboard both glands: <br><br> <code>/set ssh address="" disabled=no port=2222</code> <br> <br>  Let there be a non-standard port, since  What is the standard for which you may still need. <br><br>  We also do port forwarding: <br><br> <code>/ip firewall nat add action=dst-nat chain=dstnat comment="dst-nat to knock-to hotbackup" disabled=no dst-port=2422 protocol=tcp to-addresses=10.0.0.2 to-ports=2222 <br> /ip firewall nat add action=src-nat chain=srcnat comment="to knock-to hotbackup we either need to change source address from ssh being connected" disabled=no dst-address=10.0.0.2 dst-port=2222 protocol=tcp to-addresses=10.0.0.1</code> <br> <br>  That's right, changing the source address as the second rule, because the backup router will already have some kind of default gateway and it will try to answer through it, and we need to go back to the active router. <br><br>  In addition, you need FTP, but we will hide it from outsiders: <br><br> <code>/set ftp address=10.0.0.0/24 disabled=no port=21</code> <br> <br>  At this preparatory work is over, draw a script. <br><br><h4>  Script </h4><br>  There is already a prepared blank from the previous experience, you just need to add some touches: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- # for SSH import paramiko from paramiko import SSHClient from paramiko import AutoAddPolicy # for versioning import datetime # for file operations import os # for sleep import time # for strip() import string # versioning Version = datetime.date.today() print "\n" + str(Version) # credentials array arrCreds = (\ ("R0", "11.22.33.44", "user0", "password0", "serial0"), \ ("R1", "1.1.1.1", "user1", "password1", "serial1"), \ ("R2", "2.2.2.2", "user2", "password2", "serial2"), \ ) # FTPD IP FtpdIP = "10.0.0.1/24" BackupIP = "10.0.0.2/24" sshCli = SSHClient() sshCli.set_missing_host_key_policy(AutoAddPolicy()) LogFile = "/var/log/remotes/scripts/scripts1.log" paramiko.util.log_to_file(LogFile, level=10) print "header done" # loop adresses inside given network for (site, host, user, Password, SerialNumberA) in arrCreds: print datetime.datetime.now() print "\n" + host # define operations ChangeBackupIfAddr = '/ip address set [/ip address find address="' + BackupIP + '"] address="' + FtpdIP + '"' SSHToBackup = "/system ssh address=" + BackupIP.replace('/24', '') + " port=2222 user=" + user + "\n" GetSerial = ':put [system routerboard get value-name=serial-number]' GetBackupFromFtp = "/tool fetch address=" + FtpdIP.replace('/24', '') + " mode=ftp src-path=" + site + "_" + host + "_" + str(Version) + ".backup" + " user=" + user + " password=" + Password ApplyBackup = "/system backup load name=" + site + "_" + host + "_" + str(Version) + ".backup" ChangeBackupIfAddrA = '/ip address set [/ip address find address="' + FtpdIP + '"] address="' + BackupIP + '"' # try for not to fail the whole script on one error try: print "connecting to active router.." + site + "_" + host + "@" + user + ":" + Password sshCli.connect(str(host), port=2222, username=str(user), password=str(Password)) time.sleep(2) print "..done" print "changing backup interface IP address form 10.0.0.2/24 to 10.0.0.1/24.. " + ChangeBackupIfAddr sshCli.exec_command(ChangeBackupIfAddr) print "..done" print "connecting to hotbackup router.. " sshCli.connect(str(host), port=2422, username=str(user), password=str(Password)) time.sleep(2) print "..done" # we need to check if we're not still on active router print "checking router serial number.. " + GetSerial stdin, stdout, stderr = sshCli.exec_command(GetSerial) type(stdin) SerialNumberCurrent = stdout.read() SerialNumberCurrent = SerialNumberCurrent.strip() print "SNA=" + SerialNumberCurrent # if SerialNumber == Active router SN, so we are still on active router and must stop script if SerialNumberCurrent == SerialNumberA: print "we are still on active device, aborting host processing" continue else: print "successfully connected to hotbackup device, going on futher host processing" print "downloading backup from active router ftp.. /" + GetBackupFromFtp sshCli.exec_command(GetBackupFromFtp) time.sleep(2) print "..backup downloaded from active router" print "apply backup on HotBackup.. /" + ApplyBackup sshCli.exec_command(ApplyBackup) # and say yes sshCli.exec_command("y") time.sleep(2) print "..done" print "connecting to active router.. " sshCli.connect(str(host), port=2222, username=str(user), password=str(Password)) time.sleep(2) print "..done" print "giving backup interface address 10.0.0.2/24.." sshCli.exec_command(ChangeBackupIfAddrA) time.sleep(2) print "..done" except: print "Error connecting to host", host</span></span></code> </pre><br><br>  When the active router breaks down, you just have to use your hands to plug all the wires into the heated router ‚Äî I checked it myself, it works. <br><br><h4>  Minuses </h4><br>  - the scheme of work is such that it will oil the built-in flash drive during each execution, thereby reducing its lifetime, so I would not advise performing this operation more often than once a week <br>  - the method will work only with hardware of the same model and the same firmware version, otherwise the numbering of the interfaces may shift <br>  - this is still a crutch and you need to understand it <br><br>  Respect to habraiser <a href="https://habrahabr.ru/users/just_wow/" class="user_link">just_wow</a> for <a href="https://habrahabr.ru/users/just_wow/" class="user_link">practical</a> advice on organizing an array with credentials. </div><p>Source: <a href="https://habr.com/ru/post/140866/">https://habr.com/ru/post/140866/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140859/index.html">Facebook Garage in Moscow</a></li>
<li><a href="../140861/index.html">Pianorama for WP7</a></li>
<li><a href="../140862/index.html">Another accident at Selectel</a></li>
<li><a href="../140864/index.html">First page of issue is not a guarantee of security</a></li>
<li><a href="../140865/index.html">ASP.NET MVC, Web API, Razor and Open Source</a></li>
<li><a href="../140867/index.html">Case - Automation of contextual advertising on offers GdeSlon.ru using the service ApiShops.com</a></li>
<li><a href="../140868/index.html">HTTP notifications in Yandex.Money - now for p2p transfers</a></li>
<li><a href="../140869/index.html">Ubuntu Advantage subscription: now in Russia</a></li>
<li><a href="../140870/index.html">Mailcheck.js - check email typos</a></li>
<li><a href="../140872/index.html">Comparison of development environments, build and upgrade of operating systems and applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>