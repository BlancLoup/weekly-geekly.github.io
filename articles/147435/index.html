<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of Robokassa into ActiveMerchant</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note the translator - the post about integration of Robokassa and Rails already was , but the method provided there, I believe, will not suit many. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of Robokassa into ActiveMerchant</h1><div class="post__text post__text-html js-mediator-article">  <i>Note</i>  <i>the translator - the post about integration of Robokassa and Rails already <a href="http://habrahabr.ru/post/128922/">was</a> , but the method provided there, I believe, will not suit many.</i> <br><br>  When you have an application written in Ruby on Rails and you plan to add some payment system (for example, PayPal, Moneybookers or Robokassa, as in our case), the first gem you should think about is the <a href="https://github.com/Shopify/active_merchant/">active_merchant</a> from Shopify. <br><br>  ActiveMerchant is a simple abstract payment library used and sponsored by Shopify. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So when I needed to add payments through Robokassa to our project, I opened the list of supported payment systems and was a bit disappointed because Robokassa was not included there.  A little later, I found a fork that added support for it, but it was already out of date, so some tests fell on <a href="https://github.com/twinslash/active_merchant/commit/ec801d3d4f8074c514d8facc573286f35c1cafde">ec801d3d4f8</a> .  So I decided to look at this code and correct it, and not to write everything from scratch. <br><a name="habracut"></a><br>  In fact, in order to fix the tests, I had to just fix a small typo <a href="https://github.com/twinslash/active_merchant/commit/07fb5494134f4ec8b3650ad3efee2f39f7c9be7d">07fb5494134</a> ( <i>zbs - approx. Lane</i> ).  Yes, it was easy.  Then I decided to add to the previous solution different urls for the test environment and production (Robokassa recommends that you first test your code in the sandbox, and only then, when everything works, use it in live mode).  Look at this code here - <a href="https://github.com/twinslash/active_merchant/commit/c2ec85d53cb6b8e367fca323799a372c73a222f0">c2ec85d53cb</a> . <br><br>  Now it's time to add active_merchant to the project.  Add it to the gemfile: <br><br><pre><code class="ruby hljs">gem <span class="hljs-string"><span class="hljs-string">'activemerchant'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:require</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'active_merchant'</span></span></code> </pre> <br>  To use ActionView helpers (such as payment_service_for) you need to put the activemerchant.rb file in the initializers folder: <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'active_merchant'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> <span class="hljs-string"><span class="hljs-string">'active_merchant/billing/integrations/action_view_helper'</span></span> ActionView::Base.send(<span class="hljs-symbol"><span class="hljs-symbol">:include</span></span>, ActiveMerchant::Billing::Integrations::ActionViewHelper)</code> </pre> <br>  To use the production mode in the initializer you need to add another line: <br><br><pre> <code class="ruby hljs">ActiveMerchant::Billing::Base.integration_mode = <span class="hljs-symbol"><span class="hljs-symbol">:production</span></span> <span class="hljs-comment"><span class="hljs-comment"># :test for sandbox</span></span></code> </pre> <br>  The next step is the routes.  Robokassa makes a push request to the application when the transaction is completed, so you need to add the following lines to routes.rb: <br><br><pre> <code class="ruby hljs">scope <span class="hljs-string"><span class="hljs-string">'robokassa'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> match <span class="hljs-string"><span class="hljs-string">'paid'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'robokassa#paid'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:as</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:robokassa_paid</span></span> <span class="hljs-comment"><span class="hljs-comment"># to handle Robokassa push request match 'success' =&gt; 'robokassa#success', :as =&gt; :robokassa_success # to handle Robokassa success redirect match 'fail' =&gt; 'robokassa#fail', :as =&gt; :robokassa_fail # to handle Robokassa fail redirect end</span></span></code> </pre> <br>  Now create a controller to make it all work: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RobokassaController</span></span></span><span class="hljs-class"> &lt; ApplicationController </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ActiveMerchant::Billing::Integrations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">skip_before_filter</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">verify_authenticity_token</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># skip before filter if you chosen POST request for callbacks before_filter :create_notification before_filter :find_payment # Robokassa call this action after transaction def paid if </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.acknowledge # check if it's genuine Robokassa request </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.approve! # project-specific code render :text =&gt; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.success_response else head :bad_request end end # Robokassa redirect user to this action if it's all ok def success if !</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.approved? &amp;&amp; </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.acknowledge </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.approve! end redirect_to </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">, :notice =&gt; I18n.t("notice.robokassa.success") end # Robokassa redirect user to this action if it's not def fail redirect_to </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment">, :notice =&gt; I18n.t("notice.robokassa.fail") end private def create_notification </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Robokassa::Notification.new(request.raw_post, :secret =&gt; AppConfig.robokassa_secret) end def find_payment </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@payment</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Payment.find(</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@notification</span></span></span></span><span class="hljs-class"><span class="hljs-comment">.item_id) end end</span></span></span></span></code> </pre> <br>  Finally, let's add a form to the page: <br><br><pre> <code class="ruby hljs">&lt;%= payment_service_for @payment.id, AppConfig.robokassa_login, <span class="hljs-symbol"><span class="hljs-symbol">:amount</span></span> =&gt; @payment.amount, <span class="hljs-symbol"><span class="hljs-symbol">:service</span></span> =&gt; <span class="hljs-symbol"><span class="hljs-symbol">:robokassa</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:secret</span></span> =&gt; AppConfig.robokassa_secret <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|s|</span></span> %&gt; &lt;%= submit_tag <span class="hljs-string"><span class="hljs-string">"Submit"</span></span> %&gt; &lt;% <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %&gt;</code> </pre> <br>  That's all!  Now, if an <code>@payment</code> object <code>@payment</code> , then after submitting the form, a redirect will occur to the Robokassa website, where you can make a payment for the amount specified in <code>@payment.amount</code> . </div><p>Source: <a href="https://habr.com/ru/post/147435/">https://habr.com/ru/post/147435/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../147428/index.html">Atomic shadow photography</a></li>
<li><a href="../147429/index.html">Survarium development video diary</a></li>
<li><a href="../147431/index.html">Goblin Wars II.NET - the story of creating a network game on C # from scratch</a></li>
<li><a href="../147432/index.html">Sequential saving of settings using AJAX and jQuery queues</a></li>
<li><a href="../147434/index.html">Windows 8 Contracts and Extensions</a></li>
<li><a href="../147436/index.html">One bit - one molecule</a></li>
<li><a href="../147437/index.html">Ukrainian students have created sign-to-speech gloves</a></li>
<li><a href="../147438/index.html">Another look at the evolution of the ugly duckling or spaghetti refactoring</a></li>
<li><a href="../147439/index.html">Microsoft buys Perceptive Pixel, a manufacturer of 82-inch touch screens</a></li>
<li><a href="../147440/index.html">MIO promises the Holy Grail for athletes this fall.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>