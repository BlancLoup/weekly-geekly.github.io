<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Meet Koa or coroutine in nodejs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 I have been attracted to javascript for a very long time as a single language for web development, but until recently all my research ended...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Meet Koa or coroutine in nodejs</h1><div class="post__text post__text-html js-mediator-article"><h4>  <b>Foreword</b> </h4><br>  I have been attracted to javascript for a very long time as a single language for web development, but until recently all my research ended with reading nodejs documentation and articles that this is a callback hell, that developing it brings only pain and suffering.  I have not yet discovered that the yield operator appeared in harmony, after which I came across koa, and it went off. <br><a name="habracut"></a><br><h4>  <b>What's the salt</b> </h4><br>  Actually, koa is in many ways similar to its predecessor - express, with the exception of the omnipresent callbacks.  Instead, he uses coroutines in which control can be transferred to subroutines (thunk), promises (promises), an array with subroutines \ promises, or an object.  In some places, some backward compatibility has been preserved through a group of co functions written by the creators of koa and many followers.  Any function that previously used callback can be thunkify for use with co or koa. <br><br>  It looks like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> func = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">opt</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">done</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> (‚Ä¶) &amp;&amp; done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, data) || done(err) } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> func2 = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">opt</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">done</span></span></span><span class="hljs-function">)</span></span>{ oldFuncWithCallback(opt, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, data</span></span></span><span class="hljs-function">)</span></span>{ (...) &amp;&amp; done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, data) || done(err) } } } co(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">*</span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ‚Ä¶ */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> func(opt); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result2 = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> func2(opt); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> thunkify = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'thunkify'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result3 = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> thunkify(oldFuncWithCallback(opt)) })()</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this case, data will return to result, and done (err) will cause an exception, and you will not leave the function, as it would have been with callback, and you will not block the interpreter, execution will go to the next yield, and it looks elegant, in other words - just a fairy tale. <br><br><h5>  <b>Time to write code</b> </h5><br>  Koa is based on middleware, as well as express, but now they are executed as a coroutine, like tornado in python.  Further the code of a simple site and my thoughts goes. <br><br>  Project structure: <br><br><ul><li>  node_modules </li><li>  src - All source code here <br><ul><li>  server - Server </li><li>  app - Folder with applications </li><li>  public - Static </li><li>  template - Templates </li><li>  config - configuration files </li></ul></li></ul><br>  Since my previous hobby was Django, it may seem to someone that this has affected the organization of the code in the project, maybe it's true, I like to organize the code into modules. <br><br>  <b>src / server / index.js</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">'use strict'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> koa = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'koa'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> compose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'koa-compose'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      middleware`   var app = module.exports = koa(); //   var projectRoot = __dirname; var staticRoot = path.join(projectRoot, '../public'); var templateRoot = path.join(projectRoot, '../template'); //      settings.py  django var middlewareStack = [ require('koa-session')(), //    session require('koa-less')('/less', {dest: '/css', pathRoot: staticRoot}), //  less  css,      ,     require('koa-logger')(), //   http  require('koa-favicon')(staticRoot + '/favicon.png'), require('koa-static')(staticRoot), //  ,   ,     nginx` require('koa-views')(templateRoot, {'default': 'jade'}) // Jade      nodejs ]; require('koa-locals')(app); //   locals   ,      ,   app.use(compose(middlewareStack)); /*   middleware    ,       -   ,   callback`       ,   , ,    */ var routes = require('./handlers'); app.use(function *(next) { //   this, middleware  app,        this.locals.url = function (url, params) { return routes.url(url, params); }; yield next }); /*    middleware,        url,     ,    ,         */ app.use(routes.middleware());</span></span></code> </pre><br>  It must be remembered that this chain is called every time the server receives a request.  To better understand the order of their execution, you can use the following example: <br><br><pre> <code class="javascript hljs">app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">*(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> heavyFunc() <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> next }) app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">*(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> next })</code> </pre><br>  Each request to the console will be displayed. <br><pre>  one
 3
 2 </pre><br>  Next, in the server folder, I put handlers.js, a module that registers applications from the src / app folder. <br><br>  <b>src / server / handlers.js</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Router = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'koa-router'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> router = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Router(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRoutes</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj, routes</span></span></span><span class="hljs-function">)</span></span>{ routes.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">val</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> func = val.method.toLowerCase() == <span class="hljs-string"><span class="hljs-string">'get'</span></span> ? obj.get : val.method.toLowerCase() == <span class="hljs-string"><span class="hljs-string">'post'</span></span> ? obj.post : val.method.toLowerCase() == <span class="hljs-string"><span class="hljs-string">'all'</span></span> ? obj.all : obj.get; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> func.call(obj, val.name, val.url, val.middleware) }) } loadRoutes(router, <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'src/app/home'</span></span>).routes); <span class="hljs-comment"><span class="hljs-comment">//      app module.exports = router;</span></span></code> </pre><br><br>  The module encapsulates the loadRoutes method, which accepts a newly created instance of the router and a list of objects containing route information.  Using home as an example, I‚Äôll show how applications for working with this module look like: <br><br>  <b>src / app / home.js</b> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.render(<span class="hljs-string"><span class="hljs-string">'home/index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">Hello</span></span>: <span class="hljs-string"><span class="hljs-string">'World!'</span></span> }) } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> routes = [ {<span class="hljs-attr"><span class="hljs-attr">method</span></span>: <span class="hljs-string"><span class="hljs-string">'get'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'index'</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">'/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">middleware</span></span>: index} ]; exports.routes = routes;</code> </pre><br><br>  It looks very simple and organic, here I went a little further than the modularity proposed in django, I liked the complete isolation of the module from the rest of the application, including my own routes.  Of course, with this approach, a conflict of urls may arise and you will not get what you expected.  You can add the name of the application, or use koa-mount, or improve the recorder to prevent duplicates. <br><br>  I must say that for rendering the page you need to fill this.body, which is what this.render does, or transfer the execution further, with the help of yield next, otherwise you will get ‚ÄúNot Found‚Äù in the body of the page.  If none of the middlewares have filled the body and continued execution, the correct 404 page can be drawn by placing the following middleware at the end of src / server / index.js: <br><br><pre> <code class="javascript hljs">app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">*(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status = <span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.render(<span class="hljs-string"><span class="hljs-string">'service/404'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  ,    })</span></span></code> </pre><br><br><h4>  <b>Conclusion</b> </h4><br>  For sweet decided to leave error handling.  From the adepts of nodejs and express, I heard that this does not require hefty attention to each callback and even it does not always help.  If we recall the order in which the middleware is executed, global processing can be done simply by adding the following code to the beginning of the request processing: <br><br><pre> <code class="javascript hljs">app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">next</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> next } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.app.emit(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, err, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      yield this.render('service/error', { message: err.message, error: err }) } )</span></span></code> </pre><br><br>  With this we conclude all the project code in try..catch, well, do not forget that the app is primarily an eventEmitter.  In my opinion, this is simply brilliant.  There are already a lot of modules written for koa, almost every module for express is already adapted for koa, such as mongoose, passport, request and many others.  So we got asynchronous programming, which brings joy and fun.  In addition, the notorious TJ remains to support koa. <br><br><blockquote>  Philosophically, Koa seeks to fix and replace nodejs, while Express extends nodejs. </blockquote><br>  Excerpt from the beginning of the article, <a href="">koa-vs-express</a> . <br><br>  Thanks for reading.  Best regards, all nodejs. </div><p>Source: <a href="https://habr.com/ru/post/238095/">https://habr.com/ru/post/238095/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238085/index.html">Panasonic's smart mirror gives tips on how it looks</a></li>
<li><a href="../238087/index.html">Why I wrote a plugin for Maven</a></li>
<li><a href="../238089/index.html">The main marketing chips in the SaaS project</a></li>
<li><a href="../238091/index.html">Memory addresses: physical, virtual, logical, linear, efficient, guest</a></li>
<li><a href="../238093/index.html">azexo</a></li>
<li><a href="../238097/index.html">10 reasons to learn ITIL and implement ITSM solutions</a></li>
<li><a href="../238101/index.html">Facebook drones from Facebook the size of a Boeing 747 will be in the air for months</a></li>
<li><a href="../238105/index.html">Detailed review of Apple iOS 8</a></li>
<li><a href="../238107/index.html">Transition from an approximate solution to an exact one: the problem of splitting a square into 50 similar acute-angled triangles</a></li>
<li><a href="../238109/index.html">Monitoring the availability of servers from Infobox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>