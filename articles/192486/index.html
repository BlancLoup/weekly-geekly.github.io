<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C # Extensions Module Development Guide for Visual Studio 2005-2012 and Atmel Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="annotation 
 About a year ago we published a series of articles on the development of plug-ins for Visual Studio in C # on our blog. Now we have rewor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C # Extensions Module Development Guide for Visual Studio 2005-2012 and Atmel Studio</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/e62/82d/87d/e6282d87db074b7c771e65e7fc321eda.png" alt="C # Plugins"><br><h2>  annotation </h2><br>  About a year ago we published a series of articles on the development of plug-ins for Visual Studio in C # on our blog.  Now we have reworked these materials, added new sections and bring to your attention a new version of the manual. <br><a name="habracut"></a><br>  Creating extension modules (or plug-ins) for the Microsoft Visual Studio development environment at first may seem very simple.  After all, there is excellent MSDN documentation, articles, examples, and many additional materials.  But it may seem difficult when some actions will not give the result that is expected.  And although this behavior is often typical for any programmer task, the topic of plug-in development is not fully disclosed. <br><br>  We are developing the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static code analyzer.  And although the tool itself is intended for C ++ programmers, a considerable part of it is written in C #.  When we started to develop our plugin, Visual Studio 2005 was considered the newest and most modern version of Visual Studio in the world. And although now that Visual Studio 2012 has already been released, some may say that Visual Studio 2005 is not entirely relevant, we still support this version in your tool.  During the time that we supported different versions of Visual Studio and used different features of the environment, we have gained a lot of practical knowledge about how to create (and especially incorrectly!) Plug-ins correctly.  There was no more strength in holding this knowledge.  Therefore, we decided to issue them and publish them.  After all, some solutions that now seem obvious were found only a few years later.  And those problems that have long been resolved, may still torment some plugin developers. <br><br>  The following questions will be considered: <ul><li>  basic information on creating and debugging MSVS plug-ins, as well as support for these extension projects in a single code base for several versions of Visual Studio; </li><li>  overview of object automation model and MPF classes (Managed Package Framework); </li><li>  extensions of the development environment interface using the object automation model API (EnvDTE) and MPF classes (Managed Package Framework) with custom menus, toolbars, tool windows and settings dialogs; </li><li>  Review of the Visual Studio project model, interaction with custom project models using the example of the Atmel Studio environment implemented as a Visual Studio Isolated Shell </li><li>  collecting all the necessary data, such as the parameters and settings for compiling different configurations and platforms, using the Visual C ++ project model for working with an external preprocessor / compiler; </li></ul>  A more detailed and complete description of the topics covered in the article is available at the links to the official materials of the MSDN library and other third-party resources given at the end of each section. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Only development of plug-ins for Visual Studio 2005 and above will be considered.  This limitation is due to the fact that PVS-Studio only supports systems with VS2005 and higher.  Such a limitation in the development of PVS-Studio is caused by the appearance of a new API model in the Visual Studio 2005 environment, which is not compatible with previous versions of the environment extension API. <br><br><h2>  Creating, debugging and deploying Microsoft Visual Studio 2005/2008/2010/2012 expansion packs </h2><br>  In this section, we review the various methods for extending the functionality of the Visual Studio environment.  Details will be considered the creation of extensions of the form of Visual Studio Extension Package (Visual Studio expansion pack), their debugging, registration and deployment on the end-user machine. <br><br><h3>  Creating and debugging VSPackage Visual Studio and Visual Studio Isolated Shell Extension Modules </h3><br>  There are many ways to extend the functionality of Microsoft Visual Studio.  At the most basic level, you can automate simple routine actions with macros.  For software automation of simple actions with UI environment objects, manipulations with menu items, etc.  You can use the plug-in (add-in). <br><br>  Extending the built-in editors of the environment is possible through the MEF (Managed Extensibility Framework) components (starting with version MSVS 2010).  For the integration of large independent components into Visual Studio, extensions of the <a href="http://www.viva64.com/go.php%3Furl%3D902">Extension Package type</a> (extension packages, also known as VSPackage) are best suited.  At the same time, VSPackage allows you to combine the automation of the management of IDE components through <a href="http://www.viva64.com/go.php%3Furl%3D970">the automation object model</a> with the extension of the environment through the MEF (Managed Extensibility Framework) and <a href="http://www.viva64.com/go.php%3Furl%3D960">Managed Package Framework</a> classes (such as the Package).  In fact, while Visual Studio itself provides only common interface components and services, standard modules, such as Visual C ++ or Visual C #, are implemented as extensions of the environment. <br><br>  The first versions of the PVS-Studio plugin (more precisely 1.XX and 2.XX, when our product was also called Viva64), we released as an Add-In.  From the PVS-Studio 3.00 version we remade it on VSPackage.  The reason for the transition was that we were cramped in the Add-In and it was inconvenient to debug.  In addition, I wanted to have my own icon on the Visual Studio screen saver! <br><br>  VSPackage modules allow you to expand the automation model itself, providing opportunities for adding custom automation objects to it.  Such objects are made available through the automation model for other extension modules, giving them programmatic access to third-party integrated user components.  This, in particular, allows third-party developers to add support for new programming languages ‚Äã‚Äãand compilers to the environment through extensions, as well as to provide interfaces for automating these new components. <br><br>  In addition to expanding directly into the Visual Studio environment itself, the VSPackage modules can also be used to add functionality to the isolated \ Integrated Shell Visual Studio wrappers.  Visual Studio's isolated / integrated shell allows any third-party developer to re-use standard interface components and Visual Studio services (code editor, auto-completion system, etc.), adding support for their own project model and / or compilers to the environment.  Such a distribution kit will not contain Microsoft proprietary language components (Visual Basic, Visual C ++, etc.), and can be installed by the end user even on a system without a pre-installed version of Visual Studio IDE. <br><br>  The isolated Visual Studio shell will remain detached after installation even on a system with Visual Studio preinstalled, and the integrated shell will be merged with the pre-installed environment.  If the developer of an isolated / integrated shell extends the automation model of Visual Studio, adding interfaces for its specific components, the developer of the VSPackage plugin will have access to these interfaces.  As an example of Visual Studio Isolated Shell, you can take the environment for creating embedded systems Atmel Studio.  Atmel Studio uses its own project model, which is an implementation of the standard Visual Studio model for MSBuild, and a variant of the gcc compiler. <br><br><h4>  VSPackage plug-in projects, creating an expansion pack </h4><br>  Consider creating a view plugin for the Visual Studio Package (VSPackage, an extension package).  Unlike plug-ins (Add-In), developing an environment expansion pack will require the installation of the Microsoft Visual Studio SDK for the target version of the development environment.  That is, to develop an expansion pack for each version of Visual Studio, you will need to install a separate SDK.  When you create an extension pack for Visual Studio Isolated \ Integrated Shell, you need an SDK for the version of Visual Studio that this shell is based on. <br><br>  In the future, we will consider the development of extensions for versions of the environment 2005, 2008, 2010 and 2012 and Visual Studio 2010 Isolated Shell (using the example of Atmel Studio).  The installation of the Visual Studio SDK adds a project of the type Visual Studio Package to the standard environment templates (the Other Project Types -&gt; Extensibility item).  This template will generate the simplest MSBuild project for the extension module, allowing you to set the development language and stubs for several typical components (menu item, editor, custom window). <br><br>  We will use the C # project (csproj) VSPackage, which is the MSBuild dynamic link library (dll) project.  In our case, this is a managed assembly, which also contains several package bundle-specific XML assembly nodes, such as the VCST compiler and IncludeInVSIX for the latest versions of Visual Studio. <br><br>  The main class of the Visual Studio extension package must be inherited from the <a href="http://www.viva64.com/go.php%3Furl%3D945">Microsoft.VisualStudio.Shell.Package</a> class.  This base class provides the managed wrappers for the interaction interfaces with the IDE required by the full Visual Studio expansion pack. <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyPackage</span></span>: <span class="hljs-title"><span class="hljs-title">Package</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyPackage</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} ... }</code> </pre> <br>  The Package class provides the ability to override the base Initialize method.  The Initialize method gets control at the moment of the expansion pack initialization for the current IDE session. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Initialize(); ... }</code> </pre><br>  The module is initialized when it is first accessed, and can also be called automatically, for example, when the IDE is started, when the user enters the specified UI context (for example, opening a project), etc. <br><br>  In general, it is very important to understand how the expansion module starts and how it ends.  After all, it may be that the developer is trying to use some kind of Visual Studio functionality, which cannot be used at the moment.  During the development of PVS-Studio, we had situations when the environment ‚Äúbeat us hands‚Äù for not understanding that at the end of Visual Studio it is impossible to show the message box with a question ‚Äúin the forehead‚Äù. <br><br><h4>  Debugging Expansion Packs and Experimental Instance </h4><br>  The task of debugging a plug-in or extension for a development environment is not entirely trivial.  After all, the environment itself is used both for development and for debugging such a module.  Connecting such an unstable new module to the IDE can lead to instability in the development environment itself.  Additional inconvenience will create the need to uninstall the module being developed from the development environment each time before debugging its new version, which often requires restarting the environment itself (since the IDE can block an already connected dll, which will have to be replaced with a new version for debugging). <br><br>  It should be noted that debugging VSPackage is much more convenient than Add-In.  This was one of the reasons for the change of the Add-In model used in PVS-Studio to VSPackage. <br><br>  To solve these problems when developing and debugging VSPackage packages, you can use an experimental instance of Visual Studio.  It can be started by adding a special parameter to the environment launch string: <br><pre> <code class="cs hljs"><span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\Microsoft Visual Studio 10.0\ Common7\IDE\devenv.exe"</span></span> /RootSuffix Exp</code> </pre> <br>  The experimental instance of the environment uses a separate independent branch in the system registry (experimental hive) to save the registration information of the installed components and environment settings.  Any changes in the IDE settings, registration or modification of new components in the Experimental Hive branch will not affect the instance of the environment that is used directly for the development and debugging of the module (ie, in the basic basic version that runs by default). <br><br>  Visual Studio SDK provides a special utility for creating or clearing experimental instances - <a href="http://www.viva64.com/go.php%3Furl%3D944">CreateExpInstance</a> .  The call to CreateExpInstance to create a new experimental branch is as follows: <br><pre> <code class="cs hljs">CreateExpInstance.exe /Reset /VSInstance=<span class="hljs-number"><span class="hljs-number">10.0</span></span> /RootSuffix=PVSExp</code> </pre> <br>  Execution of this command will create a new experimental registry branch with the PVSExp suffix in the name for version 10 of the IDE (Visual Studio 2010), with a preliminary reset of all environment settings to default values.  The path to the new branch in the system registry will look like this: <br><pre> <code class="cs hljs">HKEY_CURRENT_USER\Software\Microsoft\VisualStudio\<span class="hljs-number"><span class="hljs-number">10.0</span></span>PVSExp</code> </pre> <br>  Although the Exp (and the corresponding registry branch) suffix is ‚Äã‚Äãused by default when debugging in the VSPackage template project, nothing prevents you from creating other experimental branches, respectively, with other name suffixes.  To launch an instance of the environment in the previously created new experimental branch (containing PVSExp in the name), you need to run: <br><pre> <code class="cs hljs"><span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\Microsoft Visual Studio 10.0\ Common7\IDE\devenv.exe"</span></span> /RootSuffix PVSExp</code> </pre> <br>  The ability to create several experimental branches on one local machine can be useful, for example, for the simultaneous development of several expansion packs in environments isolated from each other. <br><br>  After installing the SDK, a link will also be added to the program menu, allowing you to reset the settings of the experimental IDE instance to default values ‚Äã‚Äã(for example, Reset the Microsoft Visual Studio 2010 Experimental Instance). <br><br>  When developing extensions for Isolated Shell, the problems described above with the ‚Äúdamage‚Äù of the development environment do not arise, therefore there is no need to use Experimental Instance.  But, in any case, the sooner you understand how to work with the debugging environment, the less you will have problems with not understanding what, why and how it is loaded when developing a plug-in. <br><br><h3>  Register and Deploy Visual Studio Expansion Packs </h3><br>  Registration of an extension package requires registration of the package itself, as well as all components that it integrates into the IDE (for example, menu items, settings pages, custom windows, etc.).  Registration is done through the creation of records corresponding to components in the main branch of the Visual Studio registry. <br><br>  All information about the components required for registration is recorded in a special pkgdef file during the assembly of a VSPackage project based on the special attributes of the main module class (the Package subclass).  The pkgdef file can also be generated manually using the <a href="http://www.viva64.com/go.php%3Furl%3D906">CreatePkgDef</a> utility.  This utility collects registration information about the module using the .NET method of reflection through the special attributes of the package subclass.  Consider these attributes. <br><br>  The <a href="http://www.viva64.com/go.php%3Furl%3D946">PackageRegistration</a> attribute informs the registration utility that this class is a module extension of Visual Studio.  After its detection, additional registration attributes will be searched. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">PackageRegistration(UseManagedResourcesOnly = true)</span></span>]</code> </pre> <br>  The Guid attribute sets the unique identifier of the extension module, which will then be used to create a registration sub-branch in the system registry, in the Visual Studio branch. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Guid(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"a0fcf0f3-577e-4c47-9847-5f152c16c02c"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre> <br>  The <a href="http://www.viva64.com/go.php%3Furl%3D947">InstalledProductRegistration</a> attribute allows you to add information to the Help -&gt; About dialog and to splash the loading screen of the Visual Studio environment. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">InstalledProductRegistration(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"#110"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"#112"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1.0"</span></span></span><span class="hljs-meta">, IconResourceID = 400)</span></span>]</code> </pre> <br>  The <a href="http://www.viva64.com/go.php%3Furl%3D950">ProvideAutoLoad</a> attribute allows <a href="http://www.viva64.com/go.php%3Furl%3D950">you</a> to assign an automatic module initialization to activate the specified environment context UI.  When the user enters this context, the module will be loaded and initialized automatically.  Let us give an example of the purpose of initializing a module to open a solution file. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideAutoLoad(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"D2567162-F94F-4091-8798-A096E61B8B50"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre> <br>  The GUID values ‚Äã‚Äãof identifiers for different IDE contexts can be found in the class Microsoft.VisualStudio.VSConstants.UICONTEXT. <br><br>  The <a href="http://www.viva64.com/go.php%3Furl%3D948">ProvideMenuResource</a> attribute specifies the resource IDs of user commands and menus for registering with the IDE. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideMenuResource(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Menus.ctmenu"</span></span></span><span class="hljs-meta">, 1)</span></span>]</code> </pre> <br>  The <a href="http://www.viva64.com/go.php%3Furl%3D951">DefaultRegistryRoot</a> attribute specifies the path for recording registration information in the system registry.  Beginning with Visual Studio 2010, this attribute can be omitted, and the corresponding registration information should be recorded in the VSIX container manifest.  An example of using an attribute to register a module in Visual Studio 2008: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">DefaultRegistryRoot(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Software\\Microsoft\\VisualStudio\\9.0"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre> <br>  Registration of other custom components, such as tool and document windows, editors, settings pages, etc., also requires the addition of corresponding attributes for a custom subclass of Package.  We will look at these attributes as we look at the components themselves. <br><br>  If it is necessary to add the user keys to the registry when registering the extension package, or if values ‚Äã‚Äãneed to be added for already existing keys, it is possible to create custom registration attributes by inheriting from the <a href="http://www.viva64.com/go.php%3Furl%3D949">RegistrationAttribute</a> abstract class <a href="http://www.viva64.com/go.php%3Furl%3D949">.</a> <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Class, Inherited = true, AllowMultiple = false)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomRegistrationAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">RegistrationAttribute</span></span> { }</code> </pre> <br>  The attribute-successor of the RegistrationAttribute will be required to override the Register and Unregister methods that are used to modify the registration information in the registry. <br><br>  To add registration information to the registry, you can use the <a href="http://www.viva64.com/go.php%3Furl%3D907">RegPkg</a> utility, which automatically registers all the components listed in the pkgdef file transferred to it to the registry branch specified via the / root argument.  For example, the RegPkg call is automatically registered in Visual Studio projects for registering the module being developed in the experimental registry branch for ease of debugging.  After adding all the registration information to the registry, you need to run Visual Studio (devenv.exe) with the / setup parameter to register new components already in the IDE itself. <br><br><h4>  Deploying the plug-in to the developer‚Äôs machine and to the end-user‚Äôs machine, Package Load Key </h4><br>  Before proceeding with the description of the deployment procedure, remember the important rule: <br><br>  <b>When creating a distribution kit with a plugin developed by you, be sure to test it each time on a machine without Visual Studio SDK to make sure that a regular user logs in correctly to the system.</b> <br><br>  Now, when the first releases of PVS-Studio are long gone, we have no problems with this.  However, at first, several unsuccessful versions got to the users. <br><br>  Deploying the plug-in for Visual Studio 2005/2008 environments will require starting the regpkg for the pkgdef file with the IDE's main registry key, or adding all the keys from the pkgdef file to the registry manually.  An example of a command to automatically add registration information from the pkgdef file to the registry (in one line): <br><pre> <code class="cs hljs">RegPkg.exe /root:Software\Microsoft\VisualStudio\<span class="hljs-number"><span class="hljs-number">9.0</span></span>Exp <span class="hljs-string"><span class="hljs-string">"/pkgdeffile:obj\Debug\PVS-Studio-vs2008.pkgdef"</span></span> <span class="hljs-string"><span class="hljs-string">"C:\MyPackage\MyPackage.dll"</span></span></code> </pre> <br>  After adding registration information to the registry, you must start Visual Studio with the / setup parameter, usually this is the last step in the installation procedure of the new module. <br><pre> <code class="cs hljs">Devenv.exe /setup</code> </pre> <br>  Running the environment with this key instructs Visual Studio to read the metadata about the resources of custom components from all available extension modules in order to display them correctly in the interface.  Running devenv with this key does not open the IDE GUI window. <br><br>  In PVS-Studio, we do without starting RegPkg, and manually add the necessary information to the registry during installation.  This is done from those considerations so as not to depend on another third-party utility, but to fully control the installation process yourself.  But we still use RegPkg when developing a plugin for ease of debugging. <br><br><h4>  VSIX packages </h4><br>  Starting with Visual Studio 2010, it has become possible to significantly simplify the deployment of VSPackage modules using <a href="http://www.viva64.com/go.php%3Furl%3D905">VSIX</a> packages.  The VSIX package is a standard OPC (Open Packaging Conventions) archive containing the plug-in binaries and all the supporting files needed for their deployment.  This archive can be transferred to the standard utility VSIXInstaller.exe, which will automatically register the extensions contained in it. <br><pre> <code class="cs hljs">VSIXInstaller.exe MyPackage.vsix</code> </pre> <br>  Using the VSIX installer, you can also remove the installed package with the / uninstall command, indicating the module's unique identifier GUID. <br><pre> <code class="cs hljs">VSIXInstaller.exe /uninstall: <span class="hljs-number"><span class="hljs-number">009084B</span></span>1<span class="hljs-number"><span class="hljs-number">-6271</span></span><span class="hljs-number"><span class="hljs-number">-4621</span></span>-A893<span class="hljs-number"><span class="hljs-number">-6</span></span>D72F2B67A4D</code> </pre> <br>  The contents of the VSIX container are specified through a special vsixmanifest file, which must be added to the plug-in project.  Vsixmanifest allows you to specify: <ul><li>  module supported target version and edition of the Visual Studio environment for installation; </li><li>  Module GUID; </li><li>  components required for registration (VSPackage, MEF component, toolbox control, etc.); </li><li>  information about the installed module (description, license, version, etc.). </li></ul>  To include additional files from the project into the container, you must specify the IncludeInVSIX node for these files in the MSBuild project (you can also mark such files in the SolutionExplorer through the Properties window). <br><pre> <code class="cs hljs">&lt;Content Include=<span class="hljs-string"><span class="hljs-string">"MyPackage.pdb"</span></span>&gt; &lt;IncludeInVSIX&gt;<span class="hljs-literal"><span class="hljs-literal">true</span></span>&lt;/IncludeInVSIX&gt; &lt;/Content&gt;</code> </pre><br>  In fact, the VSIX file is a full-fledged installer for the latest versions of Visual Studio extensions (20010 and 2012), allowing you to install the package using the ‚Äúone-click‚Äù method.  The publication of the VSIX package on the IDE extensions official site of the <a href="http://www.viva64.com/go.php%3Furl%3D969">Visual Studio Gallery</a> will allow the user to install such a module through the Tools -&gt; Extension Manager environment dialog. <br><br>  VSIX allows you to deploy an expansion pack in both the usual edition of Visual Studio and in isolated \ integrated shells.  If you are integrated into an isolated shell, you will need to specify a special identifier string for such a target environment instead of the Visual Studio version in the manifest file.  For example, for the Atmel Studio 6.1 environment, this line would look like this: "AtmelStudio, 6.1".  If your extension is based on interaction with common interfaces of the automation model (interfaces for interacting with a text editor, an abstract project tree, etc.), and does not use any specific interfaces (such as interfaces for interacting with Visual C ++ projects) , no one bothers you to specify in the supported versions at once both several editions of Visual Studio and several different versions of Isolated Shell.  This, in turn, will allow you to get one common installer for a wide range of Visual Studio products. <br><br>  Appeared in VS2010 installation in the form of VSIX greatly facilitated the user (and the developer) installation of extensions.  And so much so that some plugin developers make only the installer for VS2010, just not to get involved with the development of the plug-in and installer for older versions of Visual Studio. <br><br>  In practice, unfortunately, as is often the case in the programming world, problems are possible when using the VSIX installer together with the extension manager interface in Visual Studio 2010. In particular, in some cases binary files are not always deleted correctly, which blocks the work of both the VSIX installer and and a studio extension manager and forces you to find and delete these files manually.  Therefore, you should use VSIX with caution, if possible, ensuring that before starting the installation, direct removal of files from the old version of the plugin being installed. <br><br><h4>  Package load key </h4><br>  Each VSPackage module loaded into Visual Studio must contain a unique PLK (Package Load Key) key.  The PLK key is specified via the ProvideLoadKey attribute of the Package class for IDE 2005 and 2008 versions. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideLoadKey(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Standard"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"9.99"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MyPackage"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"My Company"</span></span></span><span class="hljs-meta">, 100)</span></span>]</code> </pre> <br>  Starting from Visual Studio 2010, the presence of PLK and, accordingly, the ProvideLoadKey attribute is not mandatory, but it can be used if the developed module targets several versions of the MSVS environment.  To obtain a PLK key, you must register on the <a href="http://www.viva64.com/go.php%3Furl%3D910">Visual Studio Industry Partner</a> portal, i.e.  The PLK key ensures that only Microsoft-certified packages are loaded in the development environment.  However, an exception is made for machines with the Visual Studio SDK installed.  Together with the SDK, the Developer License Key is installed, which allows you to later load any extension module into the corresponding Visual Studio SDK environment, regardless of the validity of its PLK key. <br><br>  And once again it is worth recalling the need to test a ready-made distribution on a machine without the Visual Studio SDK installed.  The fact is that if you have the wrong PLK key set, then on the developer's machine it will be difficult to understand, since the expansion module will work. <br><br><h4>  Features registration extensions with support for multiple versions of Visual Studio </h4><br>  By default, the VSPackage template generates an extension project for the current, used during development, version of Visual Studio.  However, this is not a necessary requirement, i.e.  It is possible to develop extensions for one version of the environment using another version.  It is worth remembering that when you automatically update the project file to a newer version via devenv / Upgrade, the target version of the IDE and, accordingly, the connected managed wrapper library APIs will remain unchanged, i.e.  from a previous version of visual studio. <br><br>  To change the target version of Visual Studio (or rather, to register the plugin in this version of the environment), you need to change the values ‚Äã‚Äãthat are passed to the DefaultRegistryRoot attribute (for versions 2005 and 2008, starting with the version of Visual Studio 2010, this attribute is not needed), or change the target version in the file VSIX manifest (for versions after 2008). <br><br>  VSIX support appeared only in Visual Studio 2010, so to build and debug a plug-in for earlier versions of Visual Studio 2010 (and newer versions), you will need to ensure that all the previously described registration steps are performed manually, without using the VSIX manifest.  When changing the target version of the IDE, you should remember to change the versions of the wrapper libraries used in the managed plugin for COM interfaces. <br><br>  Changing the target IDE version for a plugin affects the following attributes of the Package class: <ul><li>  The InstalledProductRegistration attribute since Visual Studio 2010 does not support overloading a constructor with a signature (Boolean, String, String, String); </li><li>  The DefaultRegistryRoot and ProvideLoadKey attributes are optional for modules developed only for a version of Visual Studio no less than 10th (that is, starting from Visual Studio 2010), since  similar values ‚Äã‚Äãare now specified in the VSIX manifest file; </li></ul><br><h3>  Recommended links </h3><br><ol><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D903">Experimental Build.</a> </li><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D904">How to: Register a VSPackage.</a> </li><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D905">VSIX Deployment.</a> </li><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D909">How to: Obtain a PLK for a VSPackage.</a> </li><li>  MZ-Tools.  <a href="http://www.viva64.com/go.php%3Furl%3D913">Resources about Visual Studio .NET extensibility.</a> </li><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D920">Creating Add-ins and Wizards.</a> </li><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D949">Using a Custom Registration Attribute to Register an Extension.</a> </li><li>  Msdn  <a href="http://www.viva64.com/go.php%3Furl%3D1232">Shell (Integrated or Isolated).</a> </li></ol><br><h2>  Visual Studio Automation Object Model, EnvDTE and Visual Studio Shell Interop Interfaces </h2><br>  This section reviews the Visual Studio automation object model.  The general structure of the model is considered, access to its interfaces using the top-level DTE / DTE2 objects is described, and examples of using some of its elements are given.  It also discusses the use of model interfaces in multi-threaded applications and provides an implementation of multi-thread interaction mechanisms with COM interfaces in managed code. <br><br><h3>  Introduction </h3><br>  The Visual Studio development environment is built on the principles of automation and extensibility, allowing developers to integrate into themselves virtually any new elements and interact with both standard and custom components.  To implement these tasks, Visual Studio users are provided with several mutually complementary tools.  The most basic and versatile of which is the Visual Studio automation object model. <br><br>  The object automation model is a series of libraries containing an extensive, well-structured set of APIs covering all aspects of IDE automation and most aspects of its extensibility.  Despite the fact that this model, in comparison with other IDE extension tools, does not provide opportunities for interacting with some areas of Visual Studio (mainly, it concerns the extension of some IDE functionality), it is the most flexible and versatile tool. <br><br>         IDE ,            .  ,           Visual Studio,          . <br><br><h3>     </h3><br>   Visual Studio      ,      ,        .             DTE (Development Tools Environment).   1           . <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/a48/452/83c/a4845283cf2829afe3a3e6fe4c04e21a.png" alt=" 1 ‚Äî Visual Studio Automation Object Model (    )"></a> <br><br>  1 ‚Äî Visual Studio Automation Object Model (    ) <br><br>         : <ul><li>   (   ,   ); </li><li>   (      ); </li><li>     (      ); </li><li>    . </li></ul>        VSPackage. <br><br>         2  . 1  ‚Äì    EnvDTE  Visual Studio Interop,           Visual Studio, ,  ,  ,     .. 2-  ‚Äì     .            (late-bound properties), ..      - .   (..    Visual Studio  )  ,   Visual C++  Visual Basic,     .       ,           . <br><br> ,      1-                   Visual Studio,      \  (Visual Studio Isolated\Integrated Shell).             . <br><br>   ,     ,               .  ,        , ..       -,  Add-In  VSPackage.      ,         . <br><br>   Microsoft.VisualStudio.Shell.Interop    COM ,        Visual Studio  managed .  MPF (Managed Package Framework),    ,  ,   VSPackage ,       .            EnvDTE,  VS Package       ,    . <br><br><h3>     DTE/DTE2 </h3><br>     Visual Studio          .   , -,    ,   managed   API     EnvDTE. -,           ‚Äî  DTE2. <br><br>     Visual Studio          .        -,     EnvDTE      EnvDTE80, EnvDTE90, EnvDTE100  ..        ,    EnvDTE,       , , Solution  Solution2.         ,       .  ,      DTE2  ,     DTE, ..    dte2.Solution  Solution,   Solution2,   . <br><br>   ,     EnvDTE80, EnvDTE90, EnvDTE100    ,   EnvDTE       . ,       ,       managed - COM ,       DTE,    DTE2. <br><br>       EnvDTE      Visual Studio.   3  : Add-In, VSPackage    MSVS  . <br><br><h4> Add-In  </h4><br>      Add-In,   DTE      OnConnection,       <a href="http://www.viva64.com/go.php%3Furl%3D994">IDTExtensibility</a> ,        Add-In .  OnConncetion       IDE,         ,       .     : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application, ext_ConnectMode connectMode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addInInst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Array custom</span></span></span><span class="hljs-function">)</span></span> { _dte2 = (DTE2)application; ... }</code> </pre> <br> Add-In          ,            IDE. ,       OnConnection    <a href="http://www.viva64.com/go.php%3Furl%3D914">connectMode</a> . <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(connectMode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ext_ConnectMode.ext_cm_UISetup: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ext_ConnectMode.ext_cm_Startup: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ext_ConnectMode.ext_cm_AfterStartup: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ext_ConnectMode.ext_cm_CommandLine: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre> <br>    , Add-in        IDE (  startup  Add-In manager),     ,       .  ext_ConnectMode.ext_cm_UISetup   1     ,     .         UI  (    ). <br><br>  Add-In    Visual Studio (ext_ConnectMode.ext_cm_Startup),       OnConnect       .      DTE        .       IDTExtensibility  OnStartupComplete. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStartupComplete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Array custom</span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre> <br><h4> VSPackage  </h4><br>    VSPackage  DTE       Visual Studio    GetService  Package: <br><pre> <code class="cs hljs">DTE dte = MyPackage.GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DTE)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DTE;</code> </pre> <br>  ,   GetService    null  ,  Visual Studio      ,       ¬´zombie¬ª .            DTE  ,    .       DTE     Initialize,     IVsShellPropertyEvents (     Package),       OnShellPropertyChange. <br><pre> <code class="cs hljs">DTE dte; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> cookie; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Initialize(); IVsShell shellService = GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SVsShell)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IVsShell; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shellService != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ErrorHandler.ThrowOnFailure( shellService.AdviseShellPropertyChanges(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> cookie)); ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnShellPropertyChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> propid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">var</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// when zombie state changes to false, finish package initialization if ((int)__VSSPROPID.VSSPROPID_Zombie == propid) { if ((bool)var == false) { this.dte = GetService(typeof(SDTE)) as DTE; IVsShell shellService = GetService(typeof(SVsShell)) as IVsShell; if (shellService != null) ErrorHandler.ThrowOnFailure( shellService.UnadviseShellPropertyChanges(this.cookie) ); this.cookie = 0; } } return VSConstants.S_OK; }</span></span></code> </pre> <br>     ,     Visual Studio   VSPackage    IDE   -.   VS2005  VS2008,     ,    DTE    null.  Visual Studio 2010    ,   Initialize()     DTE .    ,    DTE    ¬´¬ª   ,   DTE       .            IDE    Visual Studio. <br><br><h4>    </h4><br> DTE  -     Visual Studio   .            ProgID COM ,  VisualStudio.DTE.10.0  Visual Studio 2010.      IDE      DTE . <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Get the ProgID for DTE 8.0. System.Type t = System.Type.GetTypeFromProgID( "VisualStudio.DTE.10.0", true); // Create a new instance of the IDE. object obj = System.Activator.CreateInstance(t, true); // Cast the instance to DTE2 and assign to variable dte. EnvDTE80.DTE2 dte = (EnvDTE80.DTE2)obj; // Show IDE Main Window dte.MainWindow.Activate();</span></span></code> </pre> <br>         DTE,   devenv.exe  CreateInstance.   GUI         Activate.       DTE     Visual Studio   : <br><pre> <code class="cs hljs">EnvDTE80.DTE2 dte2; dte2 = (EnvDTE80.DTE2) System.Runtime.InteropServices.Marshal.GetActiveObject( <span class="hljs-string"><span class="hljs-string">"VisualStudio.DTE.10.0"</span></span>);</code> </pre> <br>       IDE,   GetActiveObject           .       DTE     Visual Studio  PID  . <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> EnvDTE80; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.InteropServices.ComTypes; [DllImport(<span class="hljs-string"><span class="hljs-string">"ole32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateBindCtx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reserved, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IBindCtx ppbc</span></span></span><span class="hljs-function">)</span></span>; [DllImport(<span class="hljs-string"><span class="hljs-string">"ole32.dll"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRunningObjectTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> reserved, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IRunningObjectTable prot</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> DTE2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByID</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ID</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//rot entry for visual studio running under current process. string rotEntry = String.Format("!VisualStudio.DTE.10.0:{0}", ID); IRunningObjectTable rot; GetRunningObjectTable(0, out rot); IEnumMoniker enumMoniker; rot.EnumRunning(out enumMoniker); enumMoniker.Reset(); IntPtr fetched = IntPtr.Zero; IMoniker[] moniker = new IMoniker[1]; while (enumMoniker.Next(1, moniker, fetched) == 0) { IBindCtx bindCtx; CreateBindCtx(0, out bindCtx); string displayName; moniker[0].GetDisplayName(bindCtx, null, out displayName); if (displayName == rotEntry) { object comObject; rot.GetObject(moniker[0], out comObject); return (EnvDTE80.DTE2)comObject; } } return null; }</span></span></code> </pre> <br>     DTE,     IDE    COM  (ROT, Running Object Table)   .     DTE      Visual Studio, : <br><pre> <code class="cs hljs">Process Devenv; ... <span class="hljs-comment"><span class="hljs-comment">//Get DTE by Process ID EnvDTE80.DTE2 dte2 = GetByID(Devenv.Id);</span></span></code> </pre> <br> ,   -  (      ),     CSharpProjects,   DTE ,    GetObject: <br><pre> <code class="cs hljs">Projects projects = (Projects)dte.GetObject(<span class="hljs-string"><span class="hljs-string">"CSharpProjects"</span></span>);</code> </pre> <br>  GetObject    Projects  Project ,    ,      ,         . <br><br><h3>    Visual Studio </h3><br>      Visual Studio     <a href="http://www.viva64.com/go.php%3Furl%3D987">TextDocument</a> .  C/C++      . TextDocument        ( <a href="http://www.viva64.com/go.php%3Furl%3D988">Document</a> ),        Visual Studio .          Object  Document. , ,     (..    )     IDE. <br><pre> <code class="cs hljs">EnvDTE.TextDocument objTextDoc = (TextDocument)PVSStudio.DTE.ActiveDocument.Object(<span class="hljs-string"><span class="hljs-string">"TextDocument"</span></span>);</code> </pre> <br><h4>   </h4><br>  <a href="http://www.viva64.com/go.php%3Furl%3D990">TextSelection</a>      .        Visual Studio, ..       UI . <br><pre> <code class="cs hljs">EnvDTE.TextDocument Doc = (TextDocument)PVSStudio.DTE.ActiveDocument.Object(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty); Doc.Selection.SelectLine(); TextSelection Sel = Doc.Selection; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurLine = Sel.TopPoint.Line; String Text = Sel.Text; Sel.Insert(<span class="hljs-string"><span class="hljs-string">"test\r\n"</span></span>);</code> </pre><br>         ,         'test'. <br><br>   TextDocument        <a href="http://www.viva64.com/go.php%3Furl%3D989">EditPoint</a> .      TextSelection,          ,   ,    .   ,         ,  WordWrap  Virtual Spaces. ,           read-only . <br><br>      EditPoint,          (  ). <br><pre> <code class="cs hljs">objEditPt = objTextDoc.StartPoint.CreateEditPoint(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lineNumber = objTextDoc.Selection.CurrentLine; objEditPt.LineDown(lineNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>); EditPoint objEditPt2 = objTextDoc.StartPoint.CreateEditPoint(); objEditPt2.LineDown(lineNumber - <span class="hljs-number"><span class="hljs-number">1</span></span>); objEditPt2.CharRight(objEditPt2.LineLength); String line = objEditPt.GetText(objEditPt.LineLength); String newLine = line + <span class="hljs-string"><span class="hljs-string">"test"</span></span>; objEditPt.ReplaceText(objEditPt2, newLine, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)vsEPReplaceTextOptions.vsEPReplaceTextKeepMarkers);</code> </pre> <br><h4>    </h4><br>    VSPackage     ,     .       Managed Package Framework  Package.GetGlobalService(). ,         EnvDTE,       Package           Visual Studio.   ,         IDE       Document,          . <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D991">IVsUIShellOpenDocument</a>      .           . <br><pre> <code class="cs hljs">String path = <span class="hljs-string"><span class="hljs-string">"C:\Test\test.cpp"</span></span>; IVsUIShellOpenDocument openDoc = Package.GetGlobalService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IVsUIShellOpenDocument)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IVsUIShellOpenDocument; IVsWindowFrame frame; Microsoft.VisualStudio.OLE.Interop.IServiceProvider sp; IVsUIHierarchy hier; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> itemid; Guid logicalView = VSConstants.LOGVIEWID_Code; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ErrorHandler.Failed( openDoc.OpenDocumentViaProject(path, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> logicalView, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> sp, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> hier, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> itemid, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> frame)) || frame == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> docData; frame.GetProperty((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)__VSFPROPID.VSFPROPID_DocData, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> docData);</code> </pre><br>       ,     ,      .         <a href="http://www.viva64.com/go.php%3Furl%3D992">VsTextBuffer</a> . <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Get the VsTextBuffer VsTextBuffer buffer = docData as VsTextBuffer; if (buffer == null) { IVsTextBufferProvider bufferProvider = docData as IVsTextBufferProvider; if (bufferProvider != null) { IVsTextLines lines; ErrorHandler.ThrowOnFailure(bufferProvider.GetTextBuffer( out lines)); buffer = lines as VsTextBuffer; Debug.Assert(buffer != null, "IVsTextLines does not implement IVsTextBuffer"); if (buffer == null) { return; } } }</span></span></code> </pre><br>  <a href="http://www.viva64.com/go.php%3Furl%3D993">IVsTextManager</a>     ,   . ,            NavigateToLineAndColumn    : <br><pre> <code class="cs hljs">IVsTextManager mgr = Package.GetGlobalService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(VsTextManagerClass)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IVsTextManager; mgr.NavigateToLineAndColumn(buffer, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> logicalView, line, column, line, column);</code> </pre> <br><h3>     </h3><br>        DTE.Events.          ()  IDE (CommandEvents, SolutionEvents),        (  , ,   ..),      .           GetObject. <br><br>     DTE  ,            .            ,    DTE.Events      -.           DTE   -    ,      . <br><br>       Visual C++,   <a href="http://www.viva64.com/go.php%3Furl%3D985">VCProjectEngineEvents</a>        Solution : <br><pre> <code class="cs hljs">VCProjectEngineEvents m_ProjectItemsEvents = PVSStudio.DTE.Events.GetObject(<span class="hljs-string"><span class="hljs-string">"VCProjectEngineEventsObject"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCProjectEngineEvents; m_ProjectItemsEvents.ItemRemoved += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _dispVCProjectEngineEvents_ItemRemovedEventHandler( m_ProjectItemsEvents_ItemRemoved);</code> </pre> <br><h4>  MDI  </h4><br>     MDI      Events.WindowEvents.          (   EnvDTE.Window),        . <br><br>         : <br><pre> <code class="cs hljs">WindowEvents WE = PVSStudio.DTE.Events.WindowEvents; WE.WindowActivated += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _dispWindowEvents_WindowActivatedEventHandler( Package.WE_WindowActivated);</code> </pre> <br>               WindowEvents: <br><pre> <code class="cs hljs">WindowEvents WE = m_dte.Events.WindowEvents[MyPackage.DTE.ActiveWindow]; WE.WindowActivated += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _dispWindowEvents_WindowActivatedEventHandler( MyPackage.WE_WindowActivated);</code> </pre> <br><h4>  IDE  </h4><br>              .        (    ).         Events.CommandEvents.  CommandEvents,      MDI ,         IDE,        . <br><br>         : <br><pre> <code class="cs hljs">CommandEvents CEvents = DTE.Events.CommandEvents; CEvents.AfterExecute += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _dispCommandEvents_AfterExecuteEventHandler(C_AfterExecute);</code> </pre> <br>          .      GUID:ID,            ,     (VSCT). Visual Studio     ,     .            (  Visual Studio 2010): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">HKEY_CURRENT_USER\Software\Microsoft\VisualStudio\10.0\General</span></span>] <span class="hljs-string"><span class="hljs-string">"EnableVSIPLogging"</span></span>=dword:<span class="hljs-number"><span class="hljs-number">00000001</span></span></code> </pre><br>      ,    (   ,   )    CTRL+SHIFT   ,       .      Guid  CmdID.      File.NewFile: <br><pre> <code class="cs hljs">CommandEvents CEvents = DTE.Events.CommandEvents[ <span class="hljs-string"><span class="hljs-string">"{5EFC7975-14BC-11CF-9B2B-00AA00573819}"</span></span>, <span class="hljs-number"><span class="hljs-number">221</span></span>]; CEvents.AfterExecute += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> _dispCommandEvents_AfterExecuteEventHandler(C_AfterExecute);</code> </pre> <br> ,   ,     . <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">C_AfterExecute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Guid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ID, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CustomIn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> CustomOut</span></span></span><span class="hljs-function">)</span></span> { ... }</code> </pre> <br>      (  )      ,        ( -  ,    ).           IDE  . <br><br>     ,    - (VSPackage) PVS-Studio         ,      - (,  CommandEvents, WindowEvents  ),       Package.       ,    ,        . ,         .NET.      ,          DTE,         -. <br><br><h3>      ( VSPackage ) </h3><br>       Microsoft.VisualStudio.Shell.Interop,          Visual Studio.           EnvDTE,         VS Package (.. ,   Package  Managed Package Framework). ,            ,   DTE. , ,             MPF. <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1236">IVsSolutionEvents</a>    ,   Package,   Visual Studio,   Visual Studio 2005,     \   (Visual Studio isolated\integrated shell).     , ,               ,  OnAfterCloseSolution, OnBeforeCloseProject, OnQueryCloseSolution  ..  For example: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAfterLoadProject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IVsHierarchy pStubHierarchy, IVsHierarchy pRealHierarchy</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//your custom handler code return VSConstants.S_OK; }</span></span></code> </pre> <br>  ,         IVsHierarchy,   .          ,      Visual Studio. <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D1237">IVsSolutionLoadEvents</a> ,    ,     Package        Visual Studio 2010.       ,          ()   ( OnBeforeLoadProjectBatch  OnBeforeBackgroundSolutionLoadBegins),       ( OnAfterBackgroundSolutionLoadComplete).       ,      -     ,           \.                 ()     ,      ,    runtime . <br><br>   Visual Studio  PVS-Studio         VSPackage .    Package ,    ,     (,   ),    - . ,       ,      . <br><br>       ,     ,    ,        : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyPackage</span></span>: <span class="hljs-title"><span class="hljs-title">Package</span></span>, <span class="hljs-title"><span class="hljs-title">IVsSolutionLoadEvents</span></span>, <span class="hljs-title"><span class="hljs-title">IVsSolutionEvents</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Implementation of Package, IVsSolutionLoadEvents, IVsSolutionEvents ... }</span></span></code> </pre> <br><h3>     Visual Studio </h3><br>           ,         MDI  (        VSPackage ),               Visual Studio.         Visual Studio 2012      (Dark  Light),        ¬´ ¬ª. <br><br>  ¬´¬ª       GetVSSysColorEx  <a href="http://www.viva64.com/go.php%3Furl%3D1240">IVsUIShell2</a>  Visual Studio Interop.      VSPackage . <br><pre> <code class="cs hljs">IVsUIShell2 vsshell = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SVsUIShell)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IVsUIShell2;</code> </pre> <br>    __VSSYSCOLOREX  __VSSYSCOLOREX3,    GetVSSysColorEx,       Visual Studio      . ,         : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Win32Color; vsshell.GetVSSysColorEx((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)__VSSYSCOLOREX3.VSCOLOR_COMMANDBAR_MENU_BACKGROUND_GRADIENTBEGIN, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Win32Color); Color BackgroundGradient1 = ColorTranslator.FromWin32((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Win32Color);</code> </pre> <br>      Color  ¬´¬ª   .     ,       UI ,   , ,  ,     (Tools -&gt; Options),    ,       . <br><br>       -     IVsUIShell2 (,     VSPackage ),         Visual Studio,        UI     ,    .           ,     <a href="http://www.viva64.com/go.php%3Furl%3D1241"></a>         Visual Studio.     C#            Visual Studio 2012  managed . <br><br><h3>   COM     </h3><br>    PVS-Studio     -          Visual Studio API.             ,   ,  .        .     ComException                       COM Interop. <br><br>     Visual Studio   -,        .  Visual Studio  COM (Component Object Mode) .   COM- (     -)  -   COM  ,   STA (single-threaded apartment) .   COM Apartment      ,          . STA        ,    .        -   STA        .             ,   STA,              . <br><br><h4>  Apartment   managed  </h4><br>  .NET Framework   Apartment  COM. ,    COM  managed    COM , CLR (Common Language Runtime)     apartment . Managed        MTA (multi-threaded apartment, , ,   STA,     ),    STA, ,  ,      MTA.  apartment     Thread.SetApartmentState    : <br><pre> <code class="cs hljs">Thread t = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(ThreadProc); t.SetApartmentState(ApartmentState.STA); ... t.Start();</code> </pre> <br>  Since apartment        ,        managed   STA    STAThread: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">STAThread</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> {...}</code> </pre> <br><h4>      COM   managed  </h4><br>    STA    COM  ,           ,   ,          apartment .  ,  COM    , .NET COM Interop    System.Runtime.InteropServices.COMException (¬´The message filter indicated that the application is busy¬ª). <br><br>      Visual Studio  (VSPackage, Add-In)  ,        STA UI   ( event',     ..).   COM        .            EnvDTE   (,  ,       ),         . <br><br>     COM Exception       PVS-Studio      Visual Studio         IDE.  ,         ,   STA,  ,     . <br><br>        COM   IMessageFilter.    ,       HandleIncomingCall,         RetryRejectedCall.       ,       (,       ).         managed . <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ComImport()</span></span>] [Guid(<span class="hljs-string"><span class="hljs-string">"00000016-0000-0000-C000-000000000046"</span></span>)] [InterfaceType(ComInterfaceType.InterfaceIsIUnknown)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMessageFilter</span></span> { [PreserveSig] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleInComingCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwCallType, IntPtr hTaskCaller, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwTickCount, IntPtr lpInterfaceInfo</span></span></span><span class="hljs-function">)</span></span>; [PreserveSig] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RetryRejectedCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IntPtr hTaskCallee, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwTickCount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwRejectType</span></span></span><span class="hljs-function">)</span></span>; [PreserveSig] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessagePending</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IntPtr hTaskCallee, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwTickCount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dwPendingType</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageFilter</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span>, <span class="hljs-title"><span class="hljs-title">IDisposable</span></span>, <span class="hljs-title"><span class="hljs-title">IMessageFilter</span></span> { [DllImport(<span class="hljs-string"><span class="hljs-string">"ole32.dll"</span></span>)] [PreserveSig] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">extern</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CoRegisterMessageFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IMessageFilter lpMessageFilter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IMessageFilter lplpMessageFilter</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IMessageFilter oldFilter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SERVERCALL_ISHANDLED = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PENDINGMSG_WAITNOPROCESS = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SERVERCALL_RETRYLATER = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MessageFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//Starting IMessageFilter for COM objects int hr = MessageFilter.CoRegisterMessageFilter( (IMessageFilter)this, out this.oldFilter); System.Diagnostics.Debug.Assert(hr &gt;= 0, "Registering COM IMessageFilter failed!"); } public void Dispose() { //disabling IMessageFilter IMessageFilter dummy; int hr = MessageFilter.CoRegisterMessageFilter(this.oldFilter, out dummy); System.Diagnostics.Debug.Assert(hr &gt;= 0, "De-Registering COM IMessageFilter failed!") System.GC.SuppressFinalize(this); } int IMessageFilter.HandleInComingCall(int dwCallType, IntPtr threadIdCaller, int dwTickCount, IntPtr lpInterfaceInfo) { // Return the ole default (don't let the call through). return MessageFilter.SERVERCALL_ISHANDLED; } int IMessageFilter.RetryRejectedCall(IntPtr threadIDCallee, int dwTickCount, int dwRejectType) { if (dwRejectType == MessageFilter.SERVERCALL_RETRYLATER) { // Retry the thread call immediately if return &gt;=0 &amp; // &lt;100. return 150; //waiting 150 mseconds until retry } // Too busy; cancel call. SERVERCALL_REJECTED return -1; //Call was rejected by callee. //(Exception from HRESULT: 0x80010001 (RPC_E_CALL_REJECTED)) } int IMessageFilter.MessagePending( IntPtr threadIDCallee, int dwTickCount, int dwPendingType) { // Perform default processing. return MessageFilter.PENDINGMSG_WAITNOPROCESS; } }</span></span></code> </pre><br>     MessageFilter    COM    : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageFilter()) { <span class="hljs-comment"><span class="hljs-comment">//COM-interface dependent code ... }</span></span></code> </pre> <br><h3>   </h3><br><ol><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D911">Referencing Automation Assemblies and the DTE2 Object.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D912">Functional Automation Groups.</a> </li><li>  Microsoft Development Network. <a href="http://www.viva64.com/go.php%3Furl%3D916">FAQ ‚Äî  Visual Studio</a> . </li><li> MZ-Tools. <a href="http://www.viva64.com/go.php%3Furl%3D995">HOWTO: Use correctly the OnConnection method of a Visual Studio add-in.</a> </li><li> The Code Project. <a href="http://www.viva64.com/go.php%3Furl%3D917">Understanding The COM Single-Threaded Apartment.</a> </li><li> MZ-Tools. <a href="http://www.viva64.com/go.php%3Furl%3D984">HOWTO: Add an event handler from a Visual Studio add-in</a> . </li><li>  Dr. eX's Blog. <a href="http://www.viva64.com/go.php%3Furl%3D986">Using EnableVSIPLogging to identify menus and commands with VS 2005 + SP1.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D1233">Visual Studio Interop Assemblies.</a> </li></ol><br><h2>  Visual Studio </h2><br>       ,     Visual Studio  -          IDE .    IDE   UI        . <br><br><h3>  Introduction </h3><br>  Visual Studio         .             .           .         UI  ,       IDE,     , , ,      . <br><br> - PVS-Studio  IDE       UI  (     )     Visual Studio    ,            ,         . <br><br><h3>   </h3><br>  IDE ,      (  )   IDE,       Command Window  Immediate Window,        devenv.exe /command     . <br><br>           -  ,       File.        Keyboard, Environment   Options.  Tools -&gt; Customize -&gt; Commands      ,         (,  ),    ,     . <br><br>     ,   .        File -&gt; New -&gt; File,     ,    Command Window: <br><pre> <code class="cs hljs">&gt;File.NewFile Mytext /t:<span class="hljs-string"><span class="hljs-string">"General\Text File"</span></span> /e:<span class="hljs-string"><span class="hljs-string">"Source Code (text) Editor"</span></span></code> </pre> <br>      : <ul><li>        </li><li>        </li><li>   (^)     </li><li>      ,  /case (/c)  /word (/w)     /cw </li></ul>     command,            : <br><pre> <code class="cs hljs">devenv.exe /command <span class="hljs-string"><span class="hljs-string">"MyGroup.MyCommandName arg1 arg2"</span></span></code> </pre> <br>            alias: <br><pre> <code class="cs hljs">&gt;<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> MyAlias File.NewFile MyFile</code> </pre> <br> ,     IDE - PVS-Studio,        /command,  , ,           .  ,      PVS-Studio.exe      ,      , ..               ,       stdout/strerr.   ,            (,     MSBuild, NMake   GNU Make)      C/C++ .                    ,     (  )    .         PVS-Studio.exe,              ,         ,     ,     . <br><br>      PVS-Studio    ,      (..       )    -  Visual Studio  /command, ,   PVS-Studio.CheckSolution. ,            Visual C++ (vcproj/vcxproj). <br><br>    Visual Studio      /command,       .         UI , ,          /.  ,     Visual Studio   UI           . , ,             Microsoft MSBuild,      Visual Studio. <br><br>       Visual Studio  /command        (,     Windows). ,      PVS-Studio    Microsoft Team Foundation,      , ..   Team Foundation    Windows .            ,       ,        .  Visual Studio    ,     .    ,    Visual Studio  ,       .         LocalSystem,    Team Foundation. ,    Visual Studio        /command,    .         ,       .        ,  Visual Studio  LocalSystem       psexec   <a href="http://www.viva64.com/go.php%3Furl%3D685">PSTools</a> . <br><br><h3>      VSPackage, Vsct  </h3><br>      IDE   VSPackage    (Visual Studio Command Table, vsct ).   ‚Äî       XML,  VSCT-   cto- (command table output). CTO          - IDE.   VCST         IDE    .  VSCT     Visual Studio 2005,    IDE     CTC (command table compiler) ,        . <br><br>    vsct     ‚Äî CommandID,   ,     .           (     ),      .. <br><br>    VSCT .     CommandTable   - Commands,       , , ,    ..  Commands     Package  ,     . -   Symbols        VSCT  . -   KeyBindings         . <br><pre> <code class="cs hljs">&lt;CommandTable<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/VisualStudio/2005-10- 18/CommandTable"</span></span>&gt; &lt;Extern href=<span class="hljs-string"><span class="hljs-string">"stdidcmd.h"</span></span>/&gt; &lt;Extern href=<span class="hljs-string"><span class="hljs-string">"vsshlids.h"</span></span>/&gt; &lt;Commands&gt; &lt;Groups&gt; ... &lt;/Groups&gt; &lt;Bitmaps&gt; ... &lt;/Bitmaps&gt; &lt;/Commands&gt; &lt;Commands package=<span class="hljs-string"><span class="hljs-string">"guidMyPackage"</span></span>&gt; &lt;Menus&gt; ... &lt;/Menus&gt; &lt;Buttons&gt; ... &lt;/Buttons&gt; &lt;/Commands&gt; &lt;KeyBindings&gt; &lt;KeyBinding guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackage"</span></span> id=<span class="hljs-string"><span class="hljs-string">"cmdidMyCommand1"</span></span> editor=<span class="hljs-string"><span class="hljs-string">"guidVSStd97"</span></span> key1=<span class="hljs-string"><span class="hljs-string">"221"</span></span> mod1=<span class="hljs-string"><span class="hljs-string">"Alt"</span></span> /&gt; &lt;/KeyBindings&gt; &lt;Symbols&gt; &lt;GuidSymbol name=<span class="hljs-string"><span class="hljs-string">"guidMyPackage"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">"{B837A59E-5BF0-4190-B8FC- FDC35BE5C342}"</span></span> /&gt; &lt;GuidSymbol name=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">"{CC8B1E36-FE6B-48C1- B9A9-2CC0EAB4E71F}"</span></span>&gt; &lt;IDSymbol name=<span class="hljs-string"><span class="hljs-string">"cmdidMyCommand1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">"0x0101"</span></span> /&gt; &lt;/GuidSymbol&gt; &lt;/Symbols&gt; &lt;/CommandTable&gt;</code> </pre> <br>  Buttons    IDE ,          . <br><pre> <code class="cs hljs">&lt;Button guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"cmdidMyCommand1"</span></span> priority=<span class="hljs-string"><span class="hljs-string">"0x0102"</span></span> type=<span class="hljs-string"><span class="hljs-string">"Button"</span></span>&gt; &lt;Parent guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"MyTopLevelMenuGroup"</span></span> /&gt; &lt;Icon guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"bmpMyCommand1"</span></span> /&gt; &lt;CommandFlag&gt;Pict&lt;/CommandFlag&gt; &lt;CommandFlag&gt;TextOnly&lt;/CommandFlag&gt; &lt;CommandFlag&gt;IconAndText&lt;/CommandFlag&gt; &lt;CommandFlag&gt;DefaultDisabled&lt;/CommandFlag&gt; &lt;Strings&gt; &lt;ButtonText&gt;My &amp;amp;Command <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;/ButtonText&gt; &lt;/Strings&gt; &lt;/Button&gt;</code> </pre> <br>  Menus   UI      ,        Groups.  ,    Menu,         . <br><pre> <code class="cs hljs">&lt;Menu guid=<span class="hljs-string"><span class="hljs-string">" guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"SubMenu1"</span></span> priority=<span class="hljs-string"><span class="hljs-string">"0x0000"</span></span> type=<span class="hljs-string"><span class="hljs-string">"Menu"</span></span>&gt; &lt;Parent guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"MyTopLevelMenuGroup"</span></span>/&gt; &lt;Strings&gt; &lt;ButtonText&gt;Sub Menu <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;/ButtonText&gt; &lt;/Strings&gt; &lt;/Menu&gt; &lt;Menu guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"MyToolBar1"</span></span> priority=<span class="hljs-string"><span class="hljs-string">"0x0010"</span></span> type=<span class="hljs-string"><span class="hljs-string">"Toolbar"</span></span>&gt; &lt;/Menu&gt;</code> </pre> <br>  Groups     . <br><pre> <code class="cs hljs">&lt;Group guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"MySubGroup1"</span></span> priority=<span class="hljs-string"><span class="hljs-string">"0x0020"</span></span>&gt; &lt;Parent guid=<span class="hljs-string"><span class="hljs-string">"guidMyPackageCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"MyGroup1"</span></span> /&gt; &lt;/Group&gt;</code> </pre><br>   vsct   MSBuild  VSPackage        VSCT   csproj  (   SDK  VSPackage vsct      ): <br><pre> <code class="cs hljs">&lt;ItemGroup&gt; &lt;VSCTCompile Include=<span class="hljs-string"><span class="hljs-string">"TopLevelMenu.vsct"</span></span>&gt; &lt;ResourceName&gt;Menus.ctmenu&lt;/ResourceName&gt; &lt;/VSCTCompile&gt; &lt;/ItemGroup&gt;</code> </pre> <br>             Visual Studio,            parent. ,           Solution Explorer: <br><pre> <code class="cs hljs">&lt;Group guid=<span class="hljs-string"><span class="hljs-string">"guidMyCmdSet"</span></span> id=<span class="hljs-string"><span class="hljs-string">"ProjectNodeContextMenuGroup"</span></span> priority=<span class="hljs-string"><span class="hljs-string">"0x07A0"</span></span>&gt; &lt;Parent guid=<span class="hljs-string"><span class="hljs-string">"guidSHLMainMenu"</span></span> id=<span class="hljs-string"><span class="hljs-string">"IDM_VS_CTXT_PROJNODE"</span></span> /&gt; &lt;/Group&gt;</code> </pre> <br>  ,     IDM_VS_CTXT_PROJNODE.    <a href="http://www.viva64.com/go.php%3Furl%3D1255"></a> ,         Visual Studio. <br><br>         ProvideMenuResource     Package: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideMenuResource(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Menus.ctmenu"</span></span></span><span class="hljs-meta">, 1)</span></span>] ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyPackage</span></span> : <span class="hljs-title"><span class="hljs-title">Package</span></span></code> </pre> <br>    ,   VSCT ,    ,    <a href="http://www.viva64.com/go.php%3Furl%3D923">IMenuCommandService</a> .         GetService  Package: <br><pre> <code class="cs hljs">OleMenuCommandService MCS = GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IMenuCommandService)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> OleMenuCommandService;</code> </pre> <br>        (     vsct  ): <br><pre> <code class="cs hljs">EventHandler eh = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventHandler(CMDHandler); CommandID menuCommandID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandID(guidCommand1CmdSet, id); <span class="hljs-comment"><span class="hljs-comment">//ID and GUID should be the same as in the VCST file OleMenuCommand menuItem = new OleMenuCommand(eh, menuCommandID); menuItem.ParametersDescription = "$"; MCS.AddCommand(menuItem);</span></span></code> </pre><br>               EventArgs  OleMenuCmdEventArgs: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CMDHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { OleMenuCmdEventArgs eventArgs = (OleMenuCmdEventArgs)e; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventArgs.InValue != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) param = eventArgs.InValue.ToString(); ... }</code> </pre> <br><h2>      EnvDTE.DTE </h2><br>   EnvDTE.DTE        (, , )    dte.Commands   dte.ExecuteCommand. <br><br>      ,    IDE ,     VSCT,    VSPackage,      - Visual Studio  Add-In. <br><br>   DTE   ,       <a href="http://www.viva64.com/go.php%3Furl%3D954">DTE.Commands</a> .  Commands.AddNamedCommand     IDE (  Add-In ): <br><pre> <code class="cs hljs">dte.Commands.AddNamedCommand(add_in, <span class="hljs-string"><span class="hljs-string">"MyCommand"</span></span>, <span class="hljs-string"><span class="hljs-string">"My Command"</span></span>, <span class="hljs-string"><span class="hljs-string">"My Tooltip"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre> <br>          IDE       ,        .           Add-In     (     ,     Visual Studio).   OnConnection Add-In      (   ),        ,       UI   IDE. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application, ext_ConnectMode connectMode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addInInst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Array custom</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(connectMode) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ext_ConnectMode.ext_cm_UISetup: ... <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... }</code> </pre> <br>  } <br><br>  <a href="http://www.viva64.com/go.php%3Furl%3D952">EnvDTE.Command</a>      IDE.         .          VSPackage,    Add-In .      EnvDTE.Command     MyCommand1        ¬´ ¬ª  : <br><pre> <code class="cs hljs">EnvDTE.Command MyCommand1 = MyPackage.DTE.Commands.Item(<span class="hljs-string"><span class="hljs-string">"MyGroup.MyCommand1"</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>); MyCommand1.Bindings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[<span class="hljs-number"><span class="hljs-number">1</span></span>] { <span class="hljs-string"><span class="hljs-string">"Global::Alt+1"</span></span> };</code> </pre> <br>    MyGroup.MyCommand1            Keyboard, Environment. <br><br>  ,   Visual Studio       IDE.   Commands.AddCommandBar     UI ,    ,  ,  ,      . <br><pre> <code class="cs hljs">CommandBar MyToolbar = dte.Commands.AddCommandBar(<span class="hljs-string"><span class="hljs-string">"MyToolbar1"</span></span>, vsCommandBarType.vsCommandBarTypeToolbar) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CommandBar; CommandBar MyMenu = dte.Commands.AddCommandBar(<span class="hljs-string"><span class="hljs-string">"MyMenu1"</span></span>, vsCommandBarType.vsCommandBarTypeMenu) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CommandBar; CommandBarButton MyButton1 = MyCommand1.AddControl(MyToolbar) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CommandBarButton; MyButton1.Caption = <span class="hljs-string"><span class="hljs-string">"My Command 1"</span></span>;</code> </pre> <br>        IDE    Delete  Command/ CommandBar: <br><pre> <code class="cs hljs">MyCommand1.Delete();</code> </pre> <br>            Add-In       , ..      IDE,       OnDisconnect          . ,          / , , ,     DTE   ,    .   Add-Inn       DTE      ,     EnvDTE. <br><br>    ( ,   )         ExecuteCommand.      MyCommand1: <br><pre> <code class="cs hljs">MyPackage.DTE.ExecuteCommand(<span class="hljs-string"><span class="hljs-string">"MyGroup.MyCommand1"</span></span>, args);</code> </pre> <br>      Add-In      IDTCommandTarget     Exec: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Exec</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> commandName, vsCommandExecOption executeOption, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> varIn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> varOut, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> handled</span></span></span><span class="hljs-function">)</span></span> { handled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(executeOption == vsCommandExecOption.vsCommandExecOptionDoDefault) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(commandName == <span class="hljs-string"><span class="hljs-string">"MyAddin1.Connect.MyCommand1"</span></span>) { ... handled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } }</code> </pre> <br><h3>   </h3><br><ol><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D921">Visual Studio Commands and Switches.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D919">Visual Studio Command Table (.Vsct) Files.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D922">Designing XML Command Table (.Vsct) Files.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D926">Walkthrough: Adding a Toolbar to the IDE.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D927">How VSPackages Add User Interface Elements to the IDE.</a> </li><li> MZ-Tools. HOWTO: <a href="http://www.viva64.com/go.php%3Furl%3D955">Adding buttons, commandbars and toolbars to Visual Studio .NET from an add-in.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D956">How to: Create Toolbars for Tool Windows.</a> </li></ol><br><h2>   Visual Studio </h2><br>      Visual Studio       .            VSPackage  Add-In,     ,      . <br><br><h3>  Introduction </h3><br>   (tool window) ‚Äî   MDI (Multiple Document Interface)  Visual Studio    . Solution Explorer  Error List   .            ,     <a href="http://www.viva64.com/go.php%3Furl%3D932"> </a> . <br><br> - PVS-Studio   IDE   ,         (PVS-Studio Output Window).       ,     .    PVS-Studio     Visual Studio (PVS-Studio -&gt; Show PVS-Studio Output Window)      . <br><br>    IDE          (single instance window),           .        ,          ,       .      IDE Multi-Instance   (.. ,      )  .          IDE (..  ).            . <br><br>     IDE   VSPackage  Add-In   (      ),           . <br><br><h3>      </h3><br>    Visual Studio SDK   VSPackage           -.         ,               Visual Studio. <br><br><h4> ,      VSPackage </h4><br>                 Visual Studio.         pkgdef ,           .  pkgdef         Package. <br><br>         VSPackage   <a href="http://www.viva64.com/go.php%3Furl%3D934">ProvideToolWindow</a>  Package: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideToolWindow(typeof(MyWindowPane), Orientation = ToolWindowOrientation.Right, Style = VsDockStyle.Tabbed, Window = Microsoft.VisualStudio.Shell.Interop.ToolWindowGuids.Outputwindow, MultiInstances = false, Transient = true, Width = 500, Height = 250, PositionX = 300, PositionY = 300)</span></span>]</code> </pre><br>      . Typeof        (ToolWindowPane).  MultiInstances     Multi-Instance , ..       .  Orientaton, Size  Style        .  ,      IDE        . Transient ,         Visual Studio  ,         IDE. <br><br>  ,      VSPackage (    )        Package,        . ,       PVS-Studio    ,      (  )         Visual Studio,    ,    ProvideToolWindow   Transient = true.  ,   ,         IDE,             ,          . <br><br>            <a href="http://www.viva64.com/go.php%3Furl%3D935">ProvideToolWindowVisibility</a> , : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideToolWindowVisibility(typeof(MyWindowPane), /*UICONTEXT_SolutionExists*/</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"f1536ef8-92ec-443c-9ed7-fdadf150da82"</span></span></span><span class="hljs-meta">)</span></span>]</code> </pre> <br>            UI  ¬´Solution Exists¬ª.,         ,       . <br><br>        VSPackage    <a href="http://www.viva64.com/go.php%3Furl%3D937">FindToolWindow</a>  Package.       toolwindow ,      (   single-instance ).     single-instance : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ShowMyWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { ToolWindowPane MyWindow = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.FindToolWindow(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MyToolWindow), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-literal"><span class="hljs-literal">null</span></span> == MyWindow) || (<span class="hljs-literal"><span class="hljs-literal">null</span></span> == MyWindow.Frame)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotSupportedException(Resources.CanNotCreateWindow); } IVsWindowFrame windowFrame = (IVsWindowFrame) MyWindow.Frame; ErrorHandler.ThrowOnFailure(windowFrame.Show()); }</code> </pre> <br>          ,  ,     .      FindToolWindow  bool ,        ,     . <br><br>   Multi-Instance      <a href="http://www.viva64.com/go.php%3Furl%3D938">CreateToolWindow</a> ,      .    toolwindow    : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateMyWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i++) { <span class="hljs-comment"><span class="hljs-comment">// Find existing windows. var currentWindow = this.FindToolWindow(typeof(MyToolWindow), i, false); if (currentWindow == null) { // Create the window with the first free ID. var window = (ToolWindowPane)this.CreateToolWindow(typeof(MyToolWindow), i); if ((null == window) || (null == window.Frame)) { throw new NotSupportedException(Resources.CanNotCreateWindow); } IVsWindowFrame windowFrame = (IVsWindowFrame)window.Frame; ErrorHandler.ThrowOnFailure(windowFrame.Show()); break; } } }</span></span></code> </pre> <br>  ,     FindToolWindow   3-   false, ..    ,     . <br><br>    single-instance ,           ,      .    -          ,       SetFramePos  IVsWindowFrame: <br><pre> <code class="cs hljs">Guid gd = Guid.Empty; windowFrame.SetFramePos(VSSETFRAMEPOS.SFP_fDockBottom, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> gd, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>);</code> </pre><br>  ,    SetFramePos()      Show(). <br><br><h4>      Add-In </h4><br>    Add-In         EndDTE  Window2: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application, ext_ConnectMode connectMode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addInInst, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Array custom</span></span></span><span class="hljs-function">)</span></span> { _applicationObject = (DTE2)application; _addInInstance = (AddIn)addInInst; EnvDTE80.Windows2 window; AddIn add_in; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> ctlobj = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; Window myWindow; <span class="hljs-comment"><span class="hljs-comment">// Get the window object add_in = _applicationObject.AddIns.Item(1); window = (Windows2)_applicationObject.Windows; // This section specifies the path and class name of the windows // control that you want to host in the new tool window, as well as // its caption and a unique GUID. string assemblypath = "C:\\MyToolwindow\\MyToolWindowControl.dll"; string classname = " MyToolWindowControl.MyUserControl"; string guidpos = "{E87F0FC8-5330-442C-AF56-4F42B5F1AD11}"; string caption = "My Window"; // Creates the new tool window and inserts the user control into it. myWindow = window.CreateToolWindow2(add_in, assemblypath, classname, caption, guidpos, ref ctlobj); myWindow.Visible = true; }</span></span></code> </pre><br>       ,   MyToolWindowControl.MyUserControl    .  MyToolWindowControl.MyUserControl       assembly,     add-in,    ,   COM  (,   Register for COM interop   ).   MyUserControl        UserControl. <br><br><h3>       VSPackage </h3><br>     -  .               (docking),    .   (pane)   ,  .      WinForms  WPF        ,   OnShow, OnMove  .. <br><br>   ,     ,     ,     IDE ‚Äî <a href="http://www.viva64.com/go.php%3Furl%3D996">ToolWindowPane</a> : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Guid(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"870ab1d8-b434-4e86-a479-e49b3c6797f0"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyToolWindow</span></span> : <span class="hljs-title"><span class="hljs-title">ToolWindowPane</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyToolWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>):</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Caption = Resources.ToolWindowTitle; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BitmapResourceID = <span class="hljs-number"><span class="hljs-number">301</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BitmapIndex = <span class="hljs-number"><span class="hljs-number">1</span></span>; ... }</code> </pre> <br>  } <br><br>  Guid     .         ,        Guid.  ToolWindowPane               . <br><br><h4>    </h4><br>   ToolWindowPane     .           WinForms  WPF . <br><br>   Visual Studio 2008      WinForms  ,     WPF    WPF Interoperability  ElementHost.   Visual Studio 2010,       WPF,        WinForms    . <br><br>      WinForms      Window  ToolWindowPane: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MyUserControl control; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyToolWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>):</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Caption = Resources.ToolWindowTitle; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BitmapResourceID = <span class="hljs-number"><span class="hljs-number">301</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BitmapIndex = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.control = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyUserControl(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IWin32Window Window { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IWin32Window)control; } }</code> </pre> <br>   MyUserControl       System.Windows.Forms.UserControl,      .   WPF        WPF ElementHost. <br><br>    Visual Studio 2010     WPF .        WPF   Content  : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyToolWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>):</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Caption = Resources.ToolWindowTitle; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BitmapResourceID = <span class="hljs-number"><span class="hljs-number">301</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BitmapIndex = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Content = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyWPFUserControl(); }</code> </pre> <br> ,        .   WPF   base.Content   Window  . <br><br>    Output Window - PVS-Studio   ,   open-source  <a href="http://www.viva64.com/go.php%3Furl%3D1003">SourceGrid</a> ,       .         ADO.NET System.Data.Datatable,         .   4.00 PVS-Studio       IDE  Error List, ,     ,    .           ,          , Error List,   real grid ,     1-2  .            IDE.      ,    ,   Chromium  LLVM,     (     ,     )        . <br><br>      PVS-Studio    ,    ,          .               ,           ¬´¬ª     1-2 ,  .       Datatable        SQL ,              . <br><br><h4>      </h4><br>     (     ToolWindowPane)        IDE.            <a href="http://www.viva64.com/go.php%3Furl%3D941">IVsWindowFrameNotify3.</a>     : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WindowStatus</span></span>: <span class="hljs-title"><span class="hljs-title">IVsWindowFrameNotify3</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Private fields to keep track of the last known state private int x = 0; private int y = 0; private int width = 0; private int height = 0; private bool dockable = false; #region Public properties // Return the current horizontal position of the window public int X { get { return x; } } // Return the current vertical position of the window public int Y { get { return y; } } // Return the current width of the window public int Width { get { return width; } } // Return the current height of the window public int Height { get { return height; } } // Is the window dockable public bool IsDockable { get { return dockable; } } #endregion public WindowStatus() {} #region IVsWindowFrameNotify3 Members // This is called when the window is being closed public int OnClose(ref uint pgrfSaveOptions) { return Microsoft.VisualStudio.VSConstants.S_OK; } // This is called when a window "dock state" changes. public int OnDockableChange(int fDockable, int x, int y, int w, int h) { this.x = x; this.y = y; this.width = w; this.height = h; this.dockable = (fDockable != 0); return Microsoft.VisualStudio.VSConstants.S_OK; } // This is called when the window is moved public int OnMove(int x, int y, int w, int h) { this.x = x; this.y = y; this.width = w; this.height = h; return Microsoft.VisualStudio.VSConstants.S_OK; } // This is called when the window is shown or hidden public int OnShow(int fShow) { return Microsoft.VisualStudio.VSConstants.S_OK; } /// This is called when the window is resized public int OnSize(int x, int y, int w, int h) { this.x = x; this.y = y; this.width = w; this.height = h; return Microsoft.VisualStudio.VSConstants.S_OK; } #endregion }</span></span></code> </pre> <br>     ,    WindowStatus        ,   ,   ,   ..        .     OnToolWindowCreated   - ToolWindowPane: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyToolWindow</span></span>: <span class="hljs-title"><span class="hljs-title">ToolWindowPane</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnToolWindowCreated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnToolWindowCreated(); <span class="hljs-comment"><span class="hljs-comment">// Register to the window events WindowStatus windowFrameEventsHandler = new WindowStatus(); ErrorHandler.ThrowOnFailure(((IVsWindowFrame)this.Frame).SetProperty( (int)__VSFPROPID.VSFPROPID_ViewHelper, (IVsWindowFrameNotify3)windowFrameEventsHandler)); } ... }</span></span></code> </pre> <br><h4>    </h4><br>             IVsWindowFrameNotify3. <br><br>  OnShow  -      ,   /   , ,         .         fShow,   <a href="http://www.viva64.com/go.php%3Furl%3D942">__FRAMESHOW.</a> <br><br>  OnClose     ,     IDE    pgrfSaveOptions,          ( <a href="http://www.viva64.com/go.php%3Furl%3D943">__FRAMECLOSE</a> ). <br><br>  OnDockableChange     docking  .  fDockable ,     - ,             . <br><br>   OnMove  OnSize    /       . <br><br><h3>   </h3><br><ol><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D940">Kinds of Windows.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D928">Tool Windows.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D931">Tool Window Essentials.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D929">Tool Window Walkthroughs.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D930">Arranging and Using Windows in Visual Studio.</a> </li><li> MZ-Tools. <a href="http://www.viva64.com/go.php%3Furl%3D939">HOWTO: Understanding toolwindow states in Visual Studio.</a> </li></ol><br><h2>    Visual Studio </h2><br>       Visual Studio          .      IDE          ,        .            Visual Studio,      . <br><br><h3>  Introduction </h3><br> Visual Studio            .        IDE Tools -&gt; Options.    Visual Studio   .   Options               .               ,     Visual Basic : ¬´Text Editor, Basic¬ª. <br><br> -            IDE .                   MPF (Managed Package Framework,    VSPackage ). Visual Studio       -,    ,       . <br><br><h3>       </h3><br>   - Visual Studio               Tools -&gt; Options.          UI            IDE.     ,    IDE          -    (   MPF). <br><br><h4>    MPF  </h4><br> Managed Package Framework          <a href="http://www.viva64.com/go.php%3Furl%3D961">DialogPage</a> .    ,             Tools -&gt; Options,           . <br><br> ,      ,       Visual Studio (VSPackage)   <a href="http://www.viva64.com/go.php%3Furl%3D962">ProvideOptionPage</a>  Package. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProvideOptionPageAttribute(typeof(OptionsPageRegistration), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MyPackage"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"MyOptionsPage"</span></span></span><span class="hljs-meta">, 113, 114, true)</span></span>]</code> </pre> <br>          IDE         .          pkgdef ,          .             : <br><pre> <code class="cs hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VisualStudio\&lt;VsVersion&gt;\ ToolsOptionsPages</code> </pre> <br>  &lt;VsVersion&gt; ‚Äî   Visual Studio,  10.0.         ProvideOptionPage.   ,    -  Visual Studio         ,     ,     .    Visual Studio 2010 VSPackage    VSIX      ,    VSIX         .     IDE     ,   standalone . <br><br>  bool          .      ,       EnvDTE,   plug-in .          (      )   : <br><pre> <code class="cs hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VisualStudio\&lt;Version\Packages\ &lt;PackageGUID&gt;\Automation HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VisualStudio\&lt;Version&gt;\ AutomationProperties</code> </pre> <br>  <a href="http://www.viva64.com/go.php%3Furl%3D963">ProvideProfile</a>         ,   IProfileManager,    IDE   . <br><br><h4>    MPF  DialogPage </h4><br>     DialogPage         -   (public properties).       : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">MyPackage</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyOptionsPage</span></span> : <span class="hljs-title"><span class="hljs-title">DialogPage</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> myOption = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> MyOption { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>. myOption; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>. myOption = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } } }</code> </pre> <br>     DialogPage           PropertyGrid,        -.    ,              PropertyGrid .                    (,    DPI)      Visual Studio. <br><br>           <a href="http://www.viva64.com/go.php%3Furl%3D1013">Window</a>  DialogPage: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">BrowsableAttribute(false)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> IWin32Window Window { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MyUserControl; } }</code> </pre> <br>         IWin32Window,     .   ,  Visual Studio      , ..       .  Since  ,  Windows Forms,          handle,    ,     UserControl. <br><br>   AutomationObject   ,    DialogPage,    ,                IDE   .   AutomationObject      DialogPage,       -  ,              .          .    DialogPage. <a href="http://www.viva64.com/go.php%3Furl%3D965">SaveSettingsToStorage</a>          ( ,   LoadSettingsFromStorage      ). <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SaveSettingsToStorage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... }</code> </pre> <br>         ,         ,   XML      Tools -&gt; Import/Export Settings     SaveSettingsToXml,       . <br><br> ,      Visual Studio           IDE .    PropertyGrid      ,       -    ,           .           (,       IDE   ),         ,            , DPI  ..   ,               . <br><br>  - PVS-Studio         xml-,  ,   IDE,    \      .       Visual Studio         PVS-Studio,  . ,   -          Visual Studio (,     )    . <br><br><h4>   xml  Add-In  </h4><br>        IDE    XML   AddIn.             ,  System.Windows.Forms.UserControl.         Add-In ,          ,       .   addin ,      .   xml   Add-In ,      . <br><pre> <code class="cs hljs">&lt;?xml version=<span class="hljs-string"><span class="hljs-string">"1.0"</span></span> encoding=<span class="hljs-string"><span class="hljs-string">"UTF-16"</span></span> standalone=<span class="hljs-string"><span class="hljs-string">"no"</span></span>?&gt; &lt;Extensibility xmlns=<span class="hljs-string"><span class="hljs-string">"http://schemas.microsoft.com/AutomationExtensibility"</span></span>&gt; &lt;HostApplication&gt; &lt;Name&gt;Microsoft Visual Studio Macros&lt;/Name&gt; &lt;Version&gt;<span class="hljs-number"><span class="hljs-number">10.0</span></span>&lt;/Version&gt; &lt;/HostApplication&gt; &lt;HostApplication&gt; &lt;Name&gt;Microsoft Visual Studio&lt;/Name&gt; &lt;Version&gt;<span class="hljs-number"><span class="hljs-number">10.0</span></span>&lt;/Version&gt; &lt;/HostApplication&gt; &lt;Addin&gt; &lt;FriendlyName&gt;My Add <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>&lt;/FriendlyName&gt; &lt;Description&gt;My Addin <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;/Description&gt; &lt;Assembly&gt;c:\MyAddIn1\MyAddin1.dll&lt;/Assembly&gt; &lt;FullClassName&gt;MyAddin1.Connect&lt;/FullClassName&gt; &lt;LoadBehavior&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>&lt;/LoadBehavior&gt; &lt;CommandPreload&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;/CommandPreload&gt; &lt;CommandLineSafe&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>&lt;/CommandLineSafe&gt; &lt;/Addin&gt; &lt;ToolsOptionsPage&gt; &lt;Category Name=<span class="hljs-string"><span class="hljs-string">"MyAddIn1"</span></span>&gt; &lt;SubCategory Name=<span class="hljs-string"><span class="hljs-string">"My Tools Options Page"</span></span>&gt; &lt;Assembly&gt; c:\MyAddIn1\MyAddin1.dll&lt;/Assembly&gt; &lt;FullClassName&gt;MyAddin1.UserControl1&lt;/FullClassName&gt; &lt;/SubCategory&gt; &lt;/Category&gt; &lt;/ToolsOptionsPage&gt; &lt;/Extensibility&gt;</code> </pre> <br>        &lt;ToolsOptionsPage&gt;.   &lt;Assembly&gt;   ,   ,         .  &lt;FullClassName&gt;         Namespace.ClassName.  &lt;Category&gt;  &lt;SubCategory&gt;          Tools -&gt; Options,      .   &lt;Category&gt;      ,    .    ,      MyAddin1.UserControl1       ,      . <br><br> Visual Studio           Options.        Managed Package Framework,      xml   addin, , ,         . Visual Studio    addin     .  addin    ,     Environment -&gt; Add-In/Macross Security.     ,   MPF,       ,   ,  ,                 IDE    . <br><br><h3>         </h3><br>    Visual Studio           Tools -&gt; Options,   Dynamic Help  Fonts and Colors (    API).          ,       ,      . <br><br>       get_Properties  EnvDTE.DTE: <br><pre> <code class="cs hljs">Properties propertiesList = PVSStudio.DTE.get_Properties(<span class="hljs-string"><span class="hljs-string">"MyPackage"</span></span>, <span class="hljs-string"><span class="hljs-string">"MyOptionsPage"</span></span>);</code> </pre> <br>           .     : <br><pre> <code class="cs hljs">Property MyProp1 = propertiesList.Item(<span class="hljs-string"><span class="hljs-string">"MyOption1"</span></span>);</code> </pre> <br>          MyProp1.Value. <br><br>        Options    ShowOptionPage MPF  Package: <br><pre> <code class="cs hljs">MyPackage.ShowOptionPage(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MyOptionsPage));</code> </pre> <br>     ( typeof)     DialogPage.    ,    VSPackage (,   IDE  ,    ),      GUID ,      : <br><pre> <code class="cs hljs">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\VisualStudio\<span class="hljs-number"><span class="hljs-number">9.0</span></span>\ ToolsOptionsPages\&lt;OptionsPageNme&gt;\</code> </pre> <br>  &lt;OptionsPageName&gt; ‚Äî     Tools -&gt; Options.      IDE TextEditor -&gt; General     IMenuCommandService: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> targetGUID = <span class="hljs-string"><span class="hljs-string">"734A5DE2-DEBA-11d0-A6D0-00C04FB67F6A"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandID(VSConstants.GUID_VSStandardCommandSet97, VSConstants.cmdidToolsOptions); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mcs = GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(IMenuCommandService)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> MenuCommandService; mcs.GlobalInvoke(command, targetGUID);</code> </pre> <br>   ,        Tools.Options.        ExecuteCommand  EnvDTE.DTE: <br><pre> <code class="cs hljs">dte.ExecuteCommand(<span class="hljs-string"><span class="hljs-string">"Tools.Options"</span></span>, <span class="hljs-string"><span class="hljs-string">"734A5DE2-DEBA-11d0-A6D0-00C04FB67F6A"</span></span>).</code> </pre> <br><h3>   </h3><br><ol><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D957">Options Pages.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D958">State Persistence and the Visual Studio IDE.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D959">User Settings and Options.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D964">Registering Custom Options Pages</a> . </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D966">Providing Automation for VSPackages.</a> </li></ol><br><h2>   Visual Studio </h2><br>         Visual Studio        Visual C++ (VCProject).                 .     ()         (Visual Studio Isolated Shell) Atmel Studio <br><br><h3>  Introduction </h3><br>   Visual Studio    ,   ,     ,    MSVS- .    <a href="http://0001_ooo_program_verification_systems_blog_launch.docx/">  </a>  late-bound  VCProjects.   Visual C++      Visual Studio,       Visual C++ (vcrpoj/vcxproj)  .   Visual C++   COM ,    VCProjectEngine.dll,         Visual Studio.        ,     Visual Studio      . <br><br><h3>    </h3><br> Visual Studio   -  ,    , ,  ,   ..   MSVS      .    ,     ,       Project.   Visual C++       : <br><pre> <code class="cs hljs">Projects |- Project -- Object(unique <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the project type) |- ProjectItems (a collection of ProjectItem) |- ProjectItem (single <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>) -- ProjectItems (another collection) |- Object(unique <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the project type)</code> </pre><br>  Projects      Project.  Project   , ..       ,   .            ,    , .         Project.Object. ,    Visual C++       VCProject,     Atmel Studio  , , AvrGCCNode: <br><pre> <code class="cs hljs">Project proj; ... VCProject vcproj = proj.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCProject; AvrGCCNode AvrGccProject = proj.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvrGCCNode;</code> </pre> <br>  Projects       IDE  solution    dte.Solution.Projects         DTE.GetObject. ,   Visual C++: <br><pre> <code class="cs hljs">Projects vcprojs = m_dte.GetObject(<span class="hljs-string"><span class="hljs-string">"VCProjects"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Projects;</code> </pre> <br>         : <br><pre> <code class="cs hljs">Projects AllProjs = PVSStudio.DTE.Solution.Projects;</code> </pre> <br>  ProjectItems        ProjectItem.    Project, ProjectItem     ,          ProjectItems (  ProjectItem.ProjectItems)    Project.            ProjectItem.Object. ,    Visual C++       VCFile,     Atmel Studio ‚Äî AvrGccFileNode: <br><pre> <code class="cs hljs">ProjectItem projectItem; ... VCFile file = projectItem.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCFile; AvrGccFileNode file = projectItem.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvrGccFileNode;</code> </pre> <br>      ,  ,      : <br><pre> <code class="cs hljs">Project proj = projectItem.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Project;</code> </pre> <br><h3>      Solution  </h3><br>    Solution       <a href="http://www.viva64.com/go.php%3Furl%3D973">IVsHierarchy</a> .       ,      ,       .       DWORD  VSITEMID.              . <br><br>            VsShellUtilities.GetHierarchy: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IVsHierarchy </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToHierarchy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EnvDTE.Project project</span></span></span><span class="hljs-function">)</span></span> { System.IServiceProvider serviceProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceProvider(project.DTE <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Microsoft.VisualStudio.OLE.Interop.IServiceProvider); Guid guid = GetProjectGuid(serviceProvider, project); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (guid == Guid.Empty) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> VsShellUtilities.GetHierarchy(serviceProvider, guid); }</code> </pre> <br>         GUID .    GetProjectGuid,     : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Guid </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProjectGuid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">System.IServiceProvider serviceProvider, Project project</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ProjectUnloaded(project)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.Empty; IVsSolution solution = (IVsSolution)serviceProvider.GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SVsSolution)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IVsSolution; IVsHierarchy hierarchy; solution.GetProjectOfUniqueName(project.FullName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> hierarchy); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hierarchy != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Guid projectGuid; ErrorHandler.ThrowOnFailure( hierarchy.GetGuidProperty( VSConstants.VSITEMID_ROOT, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)__VSHPROPID.VSHPROPID_ProjectIDGuid, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> projectGuid)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (projectGuid != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> projectGuid; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.Empty; }</code> </pre> <br>  <a href="http://www.viva64.com/go.php%3Furl%3D974">IEnumHierarchies</a>         ,  ,   solution. <a href="http://www.viva64.com/go.php%3Furl%3D975">GetProjectEnum</a> .      Visual C++  Solution : <br><pre> <code class="cs hljs">IVsSolution solution = PVSStudio._IVsSolution; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">null</span></span> != solution) { IEnumHierarchies penum; Guid nullGuid = Guid.Empty; Guid vsppProjectGuid = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Guid(<span class="hljs-string"><span class="hljs-string">"8BC9CEB8-8B4A-11D0-8D11-00A0C91BC942"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//You can ask the solution to enumerate projects based on the //__VSENUMPROJFLAGS flags passed in. For //example if you want to only enumerate C# projects use //EPF_MATCHTYPE and pass C# project guid. See //Common\IDL\vsshell.idl for more details. int hr = solution.GetProjectEnum( (uint)(__VSENUMPROJFLAGS.EPF_LOADEDINSOLUTION | __VSENUMPROJFLAGS.EPF_MATCHTYPE), ref vsppProjectGuid, out penum); ErrorHandler.ThrowOnFailure(hr); if ((VSConstants.S_OK == hr) &amp;&amp; (penum != null)) { uint fetched; IVsHierarchy[] rgelt = new IVsHierarchy[1]; PatternsForActiveConfigurations.Clear(); while (penum.Next(1, rgelt, out fetched) == 0 &amp;&amp; fetched == 1) { ... } } }</span></span></code> </pre> <br>   GetProjectEnum       GUID  . GUID      Visual Studio/MSBuild    <a href="http://www.viva64.com/go.php%3Furl%3D976"></a> .  penum.Next()          ( rgelt).  ,    ,    ,      .           XML    . <br><br>   IDE  PVS-Studio, , ,     , ..   ,  GUID     ,   ,    .  ,      VCProject,      Android.  ,         , ..     API      VCProject  (,  OpenMP).     ,          ,  ,   .        ,      (    )  IDE,          . <br><br>    IVsHierarchy ,          Solution     hierarchy. <a href="http://www.viva64.com/go.php%3Furl%3D978">GetProperty</a> ,       : <br><pre> <code class="cs hljs">EnumHierarchyItemsFlat(VSConstants.VSITEMID_ROOT, MyProjectHierarchy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnumHierarchyItemsFlat</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> itemid, IVsHierarchy hierarchy, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> recursionLevel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> visibleNodesOnly</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hierarchy == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> hr; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> pVar; hr = hierarchy.GetProperty(itemid, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)__VSHPROPID.VSHPROPID_ExtObject, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> pVar); ProjectItem projectItem = pVar <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ProjectItem; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (projectItem != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... } recursionLevel++; <span class="hljs-comment"><span class="hljs-comment">//Get the first child node of the current hierarchy being walked hr = hierarchy.GetProperty(itemid, (visibleNodesOnly ? (int)__VSHPROPID.VSHPROPID_FirstVisibleChild :(int)__VSHPROPID.VSHPROPID_FirstChild), out pVar); Microsoft.VisualStudio.ErrorHandler.ThrowOnFailure(hr); if (VSConstants.S_OK == hr) { //We are using Depth first search so at each level we recurse //to check if the node has any children // and then look for siblings. uint childId = GetItemId(pVar); while (childId != VSConstants.VSITEMID_NIL) { EnumHierarchyItemsFlat(childId, hierarchy, recursionLevel, visibleNodesOnly); hr = hierarchy.GetProperty(childId, (visibleNodesOnly ? (int)__VSHPROPID.VSHPROPID_NextVisibleSibling : (int)__VSHPROPID.VSHPROPID_NextSibling), out pVar); if (VSConstants.S_OK == hr) { childId = GetItemId(pVar); } else { Microsoft.VisualStudio.ErrorHandler.ThrowOnFailure(hr); break; } } } } private uint GetItemId(object pvar) { if (pvar == null) return VSConstants.VSITEMID_NIL; if (pvar is int) return (uint)(int)pvar; if (pvar is uint) return (uint)pvar; if (pvar is short) return (uint)(short)pvar; if (pvar is ushort) return (uint)(ushort)pvar; if (pvar is long) return (uint)(long)pvar; return VSConstants.VSITEMID_NIL; }</span></span></code> </pre><br>       ProjectItem             Visual ++ (     )    Object,    . <br><br><h4>    Solution  </h4><br>         DTE.Solution.Projects: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m_DTE.Solution.Projects != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> prj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> m_DTE.Solution.Projects) { EnvDTE.Project proj = prj <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> EnvDTE.Project; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (proj != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) WalkSolutionFolders(proj); } } }</code> </pre><br>   , Solution     - (Solution Folders).       Project : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WalkSolutionFolders</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Project prj</span></span></span><span class="hljs-function">)</span></span> { VCProject vcprj = prj.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCProject; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vcprj != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; prj.Kind.Equals(VCCProjectTypeGUID)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ProjectExcludedFromBuild(prj)) { IVsHierarchy projectHierarchy = ToHierarchy(prj); EnumHierarchyItemsFlat(VSConstants.VSITEMID_ROOT, projectHierarchy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prj.ProjectItems != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (ProjectItem item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> prj.ProjectItems) { Project nextlevelprj = item.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Project; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nextlevelprj != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !ProjectUnloaded(nextlevelprj)) WalkSolutionFolders(nextlevelprj); } } }</code> </pre> <br>      ,   , ..           : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProjectExcludedFromBuild</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Project project</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (project.UniqueName.Equals(<span class="hljs-string"><span class="hljs-string">"&lt;MiscFiles&gt;"</span></span>, StringComparison.InvariantCultureIgnoreCase)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Solution2 solution = m_DTE.Solution <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Solution2; SolutionBuild2 solutionBuild = (SolutionBuild2)solution.SolutionBuild; SolutionContexts projectContexts = solutionBuild.ActiveConfiguration.SolutionContexts; <span class="hljs-comment"><span class="hljs-comment">//Skip this project if it is excluded from build. bool shouldbuild = projectContexts.Item(project.UniqueName).ShouldBuild; return !shouldbuild; }</span></span></code> </pre> <br><h4>    </h4><br>   ,      Solution Explorer,    DTE.SelectedItems. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (SelectedItem item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> items) { VCProject vcproj = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item.Project != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { vcproj = item.Project.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCProject; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vcproj != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; item.Project.Kind.Equals(<span class="hljs-string"><span class="hljs-string">"{"</span></span> + VSProjectTypes.VCpp + <span class="hljs-string"><span class="hljs-string">"}"</span></span>)) { IVsHierarchy projectHierarchy = ToHierarchy(item.Project); PatternsForActiveConfigurations.Clear(); EnumHierarchyItemsFlat(VSConstants.VSITEMID_ROOT, projectHierarchy, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, files, showProgressDialog); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item.Project.ProjectItems != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//solution folder if (!ProjectUnloaded(item.Project)) WalkSolutionFolders(item.Project); } } else if (item.ProjectItem != null) { //walking files ... else if (item.ProjectItem.ProjectItems != null) if (item.ProjectItem.ProjectItems.Count &gt; 0) WalkProjectItemTree(item.ProjectItem); } } private void WalkProjectItemTree(object CurrentItem) { Project CurProject = null; CurProject = CurrentItem as Project; if (CurProject != null) { IVsHierarchy projectHierarchy = ToHierarchy(CurProject); PatternsForActiveConfigurations.Clear(); EnumHierarchyItemsFlat(VSConstants.VSITEMID_ROOT, projectHierarchy, 0, false); return; } ProjectItem item = null; item = CurrentItem as ProjectItem; if (item != null) { ... if (item.ProjectItems != null) if (item.ProjectItems.Count &gt; 0) { foreach (object NextItem in item.ProjectItems) WalkProjectItemTree(NextItem); } } }</span></span></code> </pre> <br><h3>   Visual C++.       </h3><br>    ,     Visual Studio,     EnvDTE       .          ‚Äî Microsoft Visual C++,      Microsoft.VisualStudio.VCProjectEngine. <br><br>   Visual C++     Visual Studio,  ,                . ,    Visual C++,    Microsoft.VisualStudio.VCProjectEngine.dll,          . <br><br>  Visual C++     ( , ,   - ,      ..) /++       xml  (vcproj/vcxproj).     Visual Studio       (Property Pages). <br><br>          (, Debug  Release)    (Win32, x64, IA64  ..).          ,           (      ).          ,         ExcludedFromBuild,    cpp      . <br><br><h4>   </h4><br>    Visual C++      <a href="http://www.viva64.com/go.php%3Furl%3D979">VCConfiguration</a> ( )  <a href="http://www.viva64.com/go.php%3Furl%3D981">VCFileConfiguration</a> ( ).         ProjectItem,     Solution  . <br><pre> <code class="cs hljs">ProjectItem item; VCFile vcfile = item.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCFile; Project project = item.ContainingProject; String pattern = <span class="hljs-string"><span class="hljs-string">"Release|x64"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(pattern)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; VCFileConfiguration fileconfig = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; IVCCollection fileCfgs = (IVCCollection)vcfile.FileConfigurations; fileconfig = fileCfgs.Item(pattern) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCFileConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fileconfig == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fileCfgs.Count == <span class="hljs-number"><span class="hljs-number">1</span></span>) fileconfig = (VCFileConfiguration)fileCfgs.Item(<span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>          VCFile (/C++    )    Item(),    pattern (    )   . Pattern      .     (   IDE)  . <br><pre> <code class="cs hljs">ConfigurationManager cm = project.ConfigurationManager; Configuration conf = cm.ActiveConfiguration; String platformName = conf.PlatformName; String configName = conf.ConfigurationName; String pattern = configName + <span class="hljs-string"><span class="hljs-string">"|"</span></span> + platformName; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pattern;</code> </pre> <br>  ActiveConfiguration    , ..             IDE - PVS-Studio.  ,          ,   Visual Studio           .          ,             . ,        COM ,     ,  EnvDTE ,          . <br><br>    ,   : <br><pre> <code class="cs hljs">VCConfiguration cfg=(VCConfiguration)fileconfig.ProjectConfiguration;</code> </pre> <br>          General,         ,       VCConfiguration.Tools  VCFileConfiguration.Tool (      ). <br><br> , , ,   C++  <a href="http://www.viva64.com/go.php%3Furl%3D982">VCCLCompilerTool</a> : <br><pre> <code class="cs hljs">ct = ((IVCCollection)cfg.Tools).Item(<span class="hljs-string"><span class="hljs-string">"VCCLCompilerTool"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCCLCompilerTool; ctf = fileconfig.Tool <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> VCCLCompilerTool;</code> </pre> <br>      AdditionalOptions  ,          Evaluate. <br><pre> <code class="cs hljs">String ct_add = fileconfig.Evaluate(ct.AdditionalOptions); String ctf_add = fileconfig.Evaluate(ctf.AdditionalOptions);</code> </pre> <br><h4> Property Sheets </h4><br>   (property sheets)   XML    props,       (..     , ,    ). Property sheets              , .. ,     (vcproj/vcxproj),          props . <br><br>      (Property sheets)   Visual C++   <a href="http://www.viva64.com/go.php%3Furl%3D983">VCPropertySheet.</a>      VCPropertySheet     VCConfiguration. PropertySheets: <br><pre> <code class="cs hljs">IVCCollection PSheets_all = fileconfig.PropertySheets;</code> </pre> <br>   PropertySheets  VCPropertySheet           .        : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessAllPropertySheets</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">VCConfiguration cfg, IVCCollection PSheets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (VCPropertySheet propertySheet <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PSheets) { VCCLCompilerTool ctPS = (VCCLCompilerTool)((IVCCollection)propertySheet.Tools).Item( <span class="hljs-string"><span class="hljs-string">"VCCLCompilerTool"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctPS != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ... IVCCollection InherPSS = propertySheet.PropertySheets; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (InherPSS != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (InherPSS.Count != <span class="hljs-number"><span class="hljs-number">0</span></span>) ProcessAllPropertySheets(cfg, InherPSS); } } }</code> </pre> <br>        VCCLCompilerTool ( )  PropertySheet  .  ,      ,      ,      . <br><br>  VCPropertySheet         ,         Evaluate  .  , ,       ,        props . ,   MSBuild,   4 ,        vcxproj  Visual Studio 2010.  MSBuildThisFileDirectory,  ,       ,      cfg.Evaluate      vcxproj ,    props ,    . <br><br>     Visual C++       .       props ,        .    ,   MSVC      props   .   props         ,      . ,   CharacterSet        Property Sheets    props ,     (Unicode, _Unicode). ,   ,   props ,  ,                   ,   API  . ,            . <br><br><h3>   Atmel Studio,       </h3><br>       Visual Studio  C/C++   Microsoft Visual C++,      Visual Studio.    Visual Studio ,             (       - VSPackage). ,         ,       ,       ,    Visual C++,    . <br><br>      ,     embedded  Atmel Studio. ,   ‚Äì    Atmel Studio,       Visual Studio?   Atmel Studio    Visual Studio (Isolated Shell).        ,       ,  ,               Visual Studio,       .           Visual Studio,   isolated shell ,     . <br><br>   Atmel      Visual Studio.  ,     Visual C++,  ,     Atmel Studio. ,    ,    AvrGCC.dll, AvrProjectManagement.dll  Atmel.Studio.Toolchain.Interfaces.dll,   ,    Atmel Studio Extension Developer's Kit (XDK). <br><br>    Atmel Studio       cproj, ,      MSBuild (, ,       Visual Studio).  Atmel Studio    C/C++        GCC. <br><br><h4>      </h4><br> Atmel Studio  2  : C  C++ .  ,      GUID ,       . <br><br>   Atmel    2    ‚Äì GNU C compiler  GNU C++ Compiler,     .   ,    C       C , C++       C   C++ .        ,    , ..   ¬´¬ª      2- ! <br><br>             ProjectToolchainOptions. <br><pre> <code class="cs hljs">ProjectItem item; ... AvrGccFileNode file = item.Object <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvrGccFileNode; AvrGCCNode project = file.ProjectMgr <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvrGCCNode; AvrProjectConfigProperties ActiveProps = project.ConfigurationManager.GetActiveConfigProperties(); ProjectToolchainOptions ToolChainOptions = ActiveProps.ToolchainOptions; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ToolChainOptions.CppCompiler != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-comment"><span class="hljs-comment">//Toolchain compiler options for C++ compiler if (ToolChainOptions.CCompiler != null) //Toolchain compiler options for C Compiler</span></span></code> </pre> <br><h4>    </h4><br>              CompilerOptions (   CppCompilerOptions  CCompilerOptions).       ,  Include  : <br><pre> <code class="cs hljs">CompilerOptions options; ... List&lt;String&gt; Includes = options. IncludePaths;</code> </pre> <br> ,         (..  C  C++ ). ,    Include : <br><pre> <code class="cs hljs">List&lt;String&gt; SystemIncludes = options. DefaultIncludePaths;</code> </pre> <br>       Dictionary&lt;String, IList&lt;String&gt;&gt;  OtherProperties.  ,   ()        . <br><br>      ,     MSBuild (, ,  ),     ,          CommandLine ( ,   VCProjectEngine!): <br><pre> <code class="cs hljs">String RawCommandLine = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.compilerOptions.CommandLine;</code> </pre> <br>            General , ,   Include . <br><br> , , ,    ,   ,     ,    MSBuild .      GetAllProjectProperties  AvrGCCNode: <br><pre> <code class="cs hljs">AvrGCCNode project; ... Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; MSBuildProps = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); project.GetAllProjectProperties().ForEach(x =&gt;MSBuildProps.Add(x.Key, x.Value));</code> </pre> <br>               MSBuildProps. <br><br>           ,   ‚Äì  ,      .        AvrFileNodeProperties: <br><pre> <code class="cs hljs">AvrGccFileNode file; ... AvrFileNodeProperties FileProps = file.NodeProperties <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> AvrFileNodeProperties; String AdditionalFlags = FileProps.CustomCompilationSetting;</code> </pre> <br><h3>   </h3><br><ol><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D967">Visual C++ Project Model.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D968">Project Modeling.</a> </li><li> MSDN. <a href="http://www.viva64.com/go.php%3Furl%3D971">Automation Model Overview.</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/192486/">https://habr.com/ru/post/192486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192468/index.html">This is Science: Simple and Cheap Solar Energy</a></li>
<li><a href="../192470/index.html">Apple sent out invitations to the presentation on September 10</a></li>
<li><a href="../192476/index.html">The program for universities "5 in 100" or "playing catch-up for billions or elimination"</a></li>
<li><a href="../192482/index.html">Huawei Tecal ES3000: a great combination of price and quality in the PCI-e SSD camp</a></li>
<li><a href="../192484/index.html">Development and testing on open technologies in the cloud using the example of Node.js, Riak, Ruby on Rails and dozens of others</a></li>
<li><a href="../192488/index.html">Smart photocopying with Kyocera FS-1135 MFP</a></li>
<li><a href="../192490/index.html">3CX Phone System Version 12 Release Candidate 2 (build 32127) released</a></li>
<li><a href="../192492/index.html">3CXPhone for Windows user guide published</a></li>
<li><a href="../192494/index.html">How not to do validation checking email</a></li>
<li><a href="../192496/index.html">Happy Farm selected 8 start-up projects for the third cycle of the acceleration program.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>