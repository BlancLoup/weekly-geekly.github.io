<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>10 tips for using AVR microcontrollers in motorized systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Among those who are fond of electronics, one of the most popular etudes is the manufacture of a tracked robot. This topic is devoted to the mass of ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>10 tips for using AVR microcontrollers in motorized systems</h1><div class="post__text post__text-html js-mediator-article">  Among those who are fond of electronics, one of the most popular etudes is the manufacture of a tracked robot.  This topic is devoted to the mass of articles, including on Habr√©.  The abundance of manuals, schemes and articles led me to believe that it would not be so difficult, and I also wanted to make such an excellent home-made product myself.  It can be said that I was not lucky - in the process of work I ran into a lot of problems associated with the presence of engines.  In the end, I managed to solve all these problems, but it took a lot of time.  In this article, I offer some tips on designing circuits containing engines based on AVR microcontrollers.  I had to make sure of the practical usefulness of all these tips on my own experience.  Many tips, it seems to me, are suitable for other microcontrollers. <br><br><a name="habracut"></a><br><br>  I have to say that when I started this project, my experience in electronics was minimal.  Arduino by the time I had for quite some time, so I bought caterpillars and Tamiya dual gearboxes, an L293NE (driver driver) chip, and for a couple of evenings I created a label for Arduino with which this ‚Äúrobot‚Äù was cheerfully running around the room (albeit completely stupid) . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But I wanted more.  Annoyed by the need to carry a separate battery "Krona" for powering the Arduino.  And the very fact of using Arduino (I apologize to his fans!) Left an unpleasant feeling - it‚Äôs the same as assembling a machine from a designer (but from Arduino, a quite <a href="http://arduino.cc/en/Tutorial/ArduinoISP">convenient programmer for AVR</a> is obtained - I used it). <br><br>  I had an <a href="http://www.atmel.com/Images/Atmel-2486-8-bit-AVR-microcontroller-ATmega8_L_datasheet.pdf">Atmega8</a> , <a href="http://www.seeedstudio.com/depot/serial-port-bluetooth-module-masterslave-p-572.html%3FcPath%3D139_142">a Bluetooth module</a> , an ultrasonic <a href="http://www.seeedstudio.com/depot/ultra-sonic-range-measurement-module-p-626.html%3FcPath%3D144_149">distance sensor</a> , a <a href="http://www.seeedstudio.com/depot/grove-3axis-digital-accelerometer16g-p-1156.html%3FcPath%3D144_146">three-axis accelerometer</a> , <a href="http://www.ti.com/lit/ds/symlink/l293d.pdf">L293NE</a> and <a href="http://www.nxp.com/documents/data_sheet/74HC_HCT595.pdf">74HC595 chips,</a> and a whole host of resistors, capacitors and LEDs of all sorts and colors, as well as a photoresistor, a potentiometer, and an electromagnetic sound generator.  I set myself the task of powering the engines and the logical part from one source - four AA 1.2V batteries.  I saw radio-controlled tanks powered by such a source, so I had no doubt that this was possible. <br><br>  I drew a circuit printed board and assembled it.  I wrote a test firmware, made sure that the lights were flashing, Bluetooth was connecting, the beeper squeaked - and decided to give a test engine start.  And plunged into the exciting world of working with AVR in a highly noisy environment. <br><br>  Collector motors behave indecently.  They make noise in a wide range of frequencies, and the start and jamming current is several times higher than the rated current at optimum load.  In the work of my system, this was expressed in two manifestations: <br><br><ul><li>  Spontaneous reset MK when you turn on the engine.  It manifested itself more often when two engines were turned on at the same time, and especially when using PWM.  The voltage drop was visible to the naked eye to reduce the brightness of the diodes; </li><li>  Failures in the MK.  Hangup, skipping pieces of the program, spontaneous increase or decrease in clock frequency. </li></ul><br><br>  Eliminating these problems took me a year and a half (not continuous work, of course!).  In the end, everything worked, though the whole system had to be redone again. <br><br>  All the considerations collected below are surely in one form or another present on the Internet.  My main goal was to collect all the tips together: if such an article would have caught my eye earlier, it would save me a lot of time, money and peace of mind. <br><br>  So, the tips. <br><ol><li>  <strong>Isolation of power</strong> <br>  At the time of start-up, the motors consume much more current than in normal mode.  For example, for motors that I use, the starting current is 1A.  This leads to the fact that at startup there is an instantaneous voltage drop, often enough to reboot the microcontroller.  To overcome this drawdown, it is necessary to decouple the power supply with a Schottky diode and a large capacitor. <br><img src="https://habrastorage.org/storage2/e59/7eb/13e/e597eb13e53a323035ccaec1f5c431eb.png"><br>  The <em>Vcc</em> line feeds the entire logical part of the circuit, and the power part of the engine driver is powered by the battery itself (the topmost line in the figure).  When the supply voltage drops, the diode closes, and the current from the capacitors goes only to the <em>Vcc</em> line, which is what we need.  The capacitance of the capacitor must be sufficient to maintain the logic power for the duration of the drawdown.  I had two capacitors of 4.7mF.  A series inductance turns the entire structure into an LC filter. <br></li><li>  <strong>Separate ground into analog and digital parts.</strong> <br>  The previous figure shows that the land is divided into two branches, <em>AGND</em> and <em>DGND</em> .  In the diagram, this is not important, but in practice this means that the ground line serving the digital part and the ground of the engines should intersect only at one point as close as possible to the ‚Äúminus‚Äù of the power supply. <br><img src="https://habrastorage.org/storage2/e3d/7d0/9f1/e3d7d09f113b543372c61081c79c6c4b.jpg"><br>  Of course, the land polygons must also be separated (the dash-dotted line in the figure). <br></li><li>  <strong>Ensure the integrity of the mechanical parts.</strong> <br>  I have not met this advice on the Internet, but in my case it turned out to be one of the decisive ones.  On one of my engines, a plastic gear cracked on the shaft.  This had practically no effect on the performance of the engine with a gearbox, so I noticed this only on an oscilloscope.  At the moment the gearbox gear hit the crack, a slight wedging occurred, which resulted in an instantaneous increase in current consumption and the appearance of interference at the engine rotational speed. <br></li><li>  <strong>Ground Quartz Resonator</strong> <br>  The external clock circuit of the Atmega XTAL1 <em>/ XTAL2</em> serves as an excellent way for pickup.  Therefore, if you use a quartz resonator in your project, it is likely that in a highly noisy environment the controller will start going crazy.  In my case, this was reflected in a hangup, skipping pieces of the program, or a sudden change in the frequency of work up or down.  To defeat this problem, I had enough advice from p. 2. However, if this did not help, try to ground the quartz by soldering a wire to digital ground on its case.  Be careful - the quartz resonator is easy to disable with overheating. <br></li><li>  <strong>Screen quartz resonator</strong> <br>  I usually do a whole-earth fill on the board, but if you don‚Äôt like it, make at least a small ground around quartz and ballast capacitors, as told by Atmel.  As in the previous paragraph, this will help protect the clocking line from interference.  The same applies to the case if any analog line runs parallel to the logic - it makes sense to divide them with an earth ground. <br></li><li>  <strong>Use the internal oscillator</strong> <br>  Many AVR controllers are equipped with an internal oscillator.  It is not as accurate as a quartz resonator, and also (for example, in the case of my Atmega8) often does not give the maximum clock frequency for the controller.  But if nothing comes out at all, you can try using it.  The first unsuccessful model of my robot worked stably only with the internal oscillator. <br></li><li>  <strong>Electronics - the science of bad contact</strong> <br>  Three times check all contacts for bad propayka.  Avoid jumpers on the logic power line. <br>  Contacts are good, but not where needed.  I had a case where the robot worked fine, but it instantly rebooted when I tried to send something via Bluetooth.  It turned out that <em>Reset</em> was shorted to the serial port line with a bit of solder. <br></li><li>  <strong>Follow the manufacturers recommendations.</strong> <br>  Almost all datasheets offer recommendations on body kit.  Atmel even releases a separate document - <a href="http://www.atmel.com/images/doc2521.pdf">AVR Hardware Design Considerations</a> . <br>  For example, the Atmega8 should be equipped with four capacitors ( <em>Reset, Vcc, ARef, AVCC</em> ) located as close as possible to the corresponding terminals.  <em>The reset</em> must be pulled to power through a 10KŒ© resistor, the main power supply ( <em>Vcc</em> ) is equipped with its own separate LC filter.  Quartz and ballast capacitors should be located as close as possible to the MK.  In general, any microcircuit should have its own separate capacitor, decoupling the power. <br></li><li>  <strong>Place capacitors parallel to motor contacts.</strong> <br>  Capacitors (100nF) should be soldered directly to the motor contacts.  Actually, I knew this from the very beginning, and this advice here is just to complete the picture. <br></li><li>  <strong>Lower Brown-out level</strong> <br>  Brown-out - means a drop in voltage.  Microcontrollers are equipped with such a drawdown detector.  When it occurs, the microcontroller turns off.  However, the level at which the shutdown occurs can be adjusted.  For example, the Atmega8 has three options: detection is disabled, operation at 2.7V level, operation at 4.0V level.  I do not advise turning off Brown-out detection completely, but lowering the trigger level may help.  When I lowered the level to 2.7V, the system began to work much more stable. <br></li></ol><br><br>  That's all.  In order not to be unfounded, in conclusion I will give a video demonstrating my robot in action.  I hope that my article will be useful to someone and thank you for your attention! <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/71E6BF_Gs44%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253&amp;usg=ALkJrhhb_K_fBHII34_Duy4bNfhQe1Ydmg" frameborder="0" allowfullscreen=""></iframe><br><br><h5>  Links </h5><br><ol><li>  <a href="http://www.elart.narod.ru/articles/article11/article11.htm">PCB layout</a> </li><li>  <a href="http://www.atmel.com/images/doc2521.pdf">AVR Hardware Design Considerations</a> </li><li>  <a href="http://myrobot.ru/articles/mc_stab.php">Atmel AVR Connection: Microcontroller Stabilization</a> </li></ol><br><br>  <em>I want to thank my friends, without whose help and advice I would have given up long ago, and this article would never have been written.</em> </div><p>Source: <a href="https://habr.com/ru/post/176203/">https://habr.com/ru/post/176203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176193/index.html">Sony Xperia SP will be available at the end of the month at a price of 17990</a></li>
<li><a href="../176195/index.html">Storage of objects for the OpenStack cloud: Swift and Ceph comparison</a></li>
<li><a href="../176197/index.html">Scala conference in St. Petersburg tomorrow</a></li>
<li><a href="../176199/index.html">Hipster Bootstrap. Remember the millennium!</a></li>
<li><a href="../176201/index.html">Monosnap updated to version two</a></li>
<li><a href="../176205/index.html">How to start flying by yourself, at least on something, with a motor</a></li>
<li><a href="../176207/index.html">'Clean' javascript: "Start"</a></li>
<li><a href="../176209/index.html">Websphere mq for beginners</a></li>
<li><a href="../176211/index.html">April 11-12. Online Broadcast Conference Software People 2013</a></li>
<li><a href="../176215/index.html">2D scrolling week</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>