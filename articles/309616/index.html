<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Google Analytics for Telegram Bot</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© there are already several articles about the bot telegram. But how to monitor the use of the bot? Under the cat we collect data to assess the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Google Analytics for Telegram Bot</h1><div class="post__text post__text-html js-mediator-article">  On Habr√© there are already several articles about the bot telegram.  But how to monitor the use of the bot?  Under the cat we collect data to assess the most used bot functions, campaign effectiveness and failure rates. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/4b3/123/c4e/4b3123c4ea164955ba828f3c2f8b0fce" alt="image"></div><a name="habracut"></a><br>  First a small note.  I am neither an analyst nor a seo specialist.  Perhaps some tasks can be solved more efficiently, but there is very little information about this.  It so happened that our colleagues overseas flatly refused to work with the Yandex <a href="https://habrahabr.ru/company/yandex/blog/264121/">botan</a> product and demanded a familiar interface ‚Äúlike in google analytics‚Äù.  It was decided to use <a href="https://developers.google.com/analytics/devguides/collection/protocol/v1/">google analytics measurement protocol</a> .  With it, you can transfer almost all the same data to google analytics as you normally would (for example, a script on the site). <br><br>  If your bot is written in laravel, we can advise the <a href="https://packagist.org/packages/irazasyed/laravel-gamp">irazasyed / laravel-gamp package</a> for running the measurement protocol. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  How to use the bot? </h3><br>  In our bot, we have marked the main user interaction with the bot on the dialogues and steps.  For example, the settings dialog looks like this: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d61/ad1/23d/d61ad123de554b34851b0ece78463d0b" alt="image"></div><br>  In fact, this is one step of the dialogue with buttons and 6 separate steps for setting specific parameters.  This structure can be represented as addresses: <br><br><ul><li>  / settings <br><ul><li>  / settings / gender </li><li>  / settings / frequency </li><li>  / settings / language </li><li>  ... </li></ul></li></ul><br>  We consider a set of current user buttons as its state or as the page on which it is located.  Accordingly, we can send a page view to analytics. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Irazasyed</span></span>\<span class="hljs-title"><span class="hljs-title">LaravelGAMP</span></span>\<span class="hljs-title"><span class="hljs-title">Facades</span></span>\<span class="hljs-title"><span class="hljs-title">GAMP</span></span>; ... $gamp = GAMP::setClientId( <span class="hljs-string"><span class="hljs-string">'123456'</span></span> ); $gamp-&gt;setDocumentPath( <span class="hljs-string"><span class="hljs-string">'/settings'</span></span> ); $gamp-&gt;sendPageview(); ...</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/837/135/657/837135657f6d47c9aeb912671797ede7" alt="image"></div><br><h3>  Where do new users come from? </h3><br>  If the analogy of the pages of the site with the state of the user (his current keyboard) is quite obvious, then how to draw an analogy with the source of traffic?  In fact, we can‚Äôt find out exactly how the user found our bot.  But there is one trick.  We already had a tool to transfer the utm_campaign analog to Google Analytics. <br><br>  Telegram allows you to start a dialogue with a user not from scratch.  When the user presses the ‚Äústart‚Äù button in the telegram application, the bot receives the message ‚Äú <i>/ start</i> ‚Äù.  This message can be extended with <a href="https://core.telegram.org/bots/">an additional parameter</a> .  Each bot has a link that opens a chat with it in a telegram - <a href="https://telegram.me/">telegram.me</a> <i>&lt;bot_name&gt;</i> .  To this link you can add the parameter ‚Äústart‚Äù (or ‚Äústartgroup‚Äù), for example: <br><br><blockquote> <code>https://telegram.me/bot_name?start=habr-gamp</code> </blockquote> <br>  In this case, we can transmit to the analyst the source ‚Äúhabr‚Äù and even clarify it with the channel ‚Äúgamp‚Äù. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($campaign){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(strpos($campaign,<span class="hljs-string"><span class="hljs-string">'-'</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>($campaign,$medium) = explode(<span class="hljs-string"><span class="hljs-string">'-'</span></span>,$campaign); $gamp-&gt;setCampaignMedium($medium); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ $gamp-&gt;setCampaignMedium(<span class="hljs-string"><span class="hljs-string">'none'</span></span>); } $gamp-&gt;setCampaignSource($campaign); }</code> </pre><br>  From this moment we can follow the success of advertising campaigns: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/71d/a34/1a8/71da341a866d45f899df82cb6f3200f9" alt="image"></div><br><h3>  What to do if the user has blocked the bot? </h3><br>  The next time you send a message, you may encounter an unpleasant situation - the user has blocked the bot.  How to reflect this in analytics?  In fact, we cannot give analytek a page view of ‚Äú <i>/ unsubscribe</i> ‚Äù or similar, because  The user is now in a different state (on another "page").  But gamp supports and events.  Accordingly, we send him an event about blocking the user. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Irazasyed</span></span>\<span class="hljs-title"><span class="hljs-title">LaravelGAMP</span></span>\<span class="hljs-title"><span class="hljs-title">Facades</span></span>\<span class="hljs-title"><span class="hljs-title">GAMP</span></span>; ... $gamp = GAMP::setClientId( <span class="hljs-string"><span class="hljs-string">'123456'</span></span> ); $gamp-&gt;setEventCategory(<span class="hljs-string"><span class="hljs-string">'User'</span></span>) -&gt;setEventAction(<span class="hljs-string"><span class="hljs-string">'Unsubscribe'</span></span>) -&gt;setEventLabel(<span class="hljs-string"><span class="hljs-string">'Blocked'</span></span>) -&gt;sendEvent(); ...</code> </pre><br><h3>  Bot geography </h3><br>  Since  all messages come from the same server, its geographical affiliation is almost irrelevant.  We are interested in the distribution of the bot audience.  Basically, we can find out about a user's location in two ways: by the sent geolocation or by his ip. <br><br><ul><li>  Api google maps have a wonderful geocoding service and, in particular, <a href="https://developers.google.com/maps/documentation/geocoding/intro%3Fhl%3Dru">reverse geocoding</a> .  Accordingly, it remains to give the analyst the relevant country: <br><br><pre> <code class="php hljs"> $gamp-&gt;setGeographicalOverride($oChat-&gt;country);</code> </pre><br><br></li><li>  An alternative method is to <s>calculate by</s> ip the user's ip.  The only way to get to know him is to ‚Äúlure‚Äù the user to the site.  For example, through short links redirects. <br><br>  In this case, it is not necessary to find out which country belongs to ip, google knows how to do it yourself. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;gamp-&gt;setIpOverride($oChat-&gt;last_ip_address)</code> </pre></li></ul><br><img src="https://habrastorage.org/files/cb2/354/43d/cb235443dce14376a6e7ea537656dec1" alt="image"><br><br>  The attentive reader may have noticed that for some reason Greenland has almost as many sessions as Russia.  The fact is that this is a little trick.  Not all users follow the links or send their location.  Since it is important for us to understand not only the geographical location, but also how many users did not provide it to us, we decided to everyone who did not have time to tell us about their location in a large but sparsely populated Greenland. </div><p>Source: <a href="https://habr.com/ru/post/309616/">https://habr.com/ru/post/309616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309602/index.html">Skype-bot with a human face (on the Microsoft Bot Framework V3 and Slack API)</a></li>
<li><a href="../309606/index.html">Moscow JS Meetup in Badoo</a></li>
<li><a href="../309608/index.html">Business planning web studio at the start</a></li>
<li><a href="../309612/index.html">What interesting things have I learned in two years of developing and promoting a mobile game?</a></li>
<li><a href="../309614/index.html">‚ÄúNot a single break‚Äù: what is the cost of making an online broadcast that will not fall, slow down and cause pain in the eyes?</a></li>
<li><a href="../309618/index.html">A little bit about ARM Security Extensions (aka ARM TrustZone)</a></li>
<li><a href="../309622/index.html">Manual start timer (work on bugs)</a></li>
<li><a href="../309624/index.html">The work of NSFetchRequest and NSFetchedResultsController, as well as why there is a grocery market</a></li>
<li><a href="../309626/index.html">The logic of consciousness. Part 5. The semantic approach to the analysis of information</a></li>
<li><a href="../309628/index.html">Script for those who are too lazy to understand Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>