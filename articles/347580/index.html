<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On Lee effect waves: Pitonizing DAF generation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to statistics, 1-4% of the world's population is subject to a speech defect characterized by frequent prolongation of sounds (syllables, wor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On Lee effect waves: Pitonizing DAF generation</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a49/c88/eaa/a49c88eaa91267c95da70856a1dc3ded.png" align="left" alt="image">  According to statistics, 1-4% of the world's population is subject to a speech defect characterized by frequent prolongation of sounds (syllables, words) and / or frequent stops in speech that violate its rhythmic flow.  In the common people, this phenomenon is known as stuttering. <br><br>  At the moment, the world does not know the panacea, 100% relieving from stuttering, however, there is a most interesting method that allows with some success or another to stop this speech disorder in most stutterers.  The method is based on the Lie effect, which is the effect of the delay in acoustic acoustic afferentation on the smoothness of speech, and is called DAF (Delayed Auditory Feedback). <br><br>  Below we consider an example of building a simple voice feedback generator on the knee of Python and PyQt.  Oooh, it's gonna be fun! <br><a name="habracut"></a><br><h3>  <font color="#cc0000">What's what and why</font> </h3><br>  The effect of Lee, named after the submariner Bernard Lee ( <i>Lee</i> , 1951), is manifested in the fact that an ordinary person listening through headphones own speech, delayed with the help of special equipment for 80-200 ms, (directly at the time of conversation) causes hesitancy, very reminiscent of stuttering.  At the same time, a person who is prone to stuttering, the effect of Lee has the opposite effect.  This is the basis of the DAF method.  The reason for the delay in speech reproduction in headphones is to synchronize the operation of speech centers - the Wernicke hearing center and Broca's speech-motor center ( <i>cryptometaphorus: delay = gamma generation function for the self-synchronizing stream cipher</i> ).  Various studies have revealed that the delay in the range of 50-75 ms can reduce stuttering by 60-80% with normal and accelerated speech.  A delay of 190 ms turned out to be slightly more efficient than 75 ms, however, the optimal amount of delay is chosen individually based on the sensations of the subject. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The idea of ‚Äã‚Äãa hardware approach to the normalization of speech is as old as the world ‚Äî the first device operating on the principle of ‚Äúregulation of feedback‚Äù was designed in 1959. Being large, wired and clumsy, it seemed to be ineffective for use in everyday life, but technology does not stand still , and now there are a number of ways to conveniently generate DAF: using separate mini-devices, as well as softin for Vedroid, Apple (searching by the keyword ‚ÄúDAF‚Äù in your application store will show the entire selection of such solutions) and PC (here with  false, look at the next paragraph). <br><br><h3>  <font color="#cc0000">Why this post</font> </h3><br>  The cost of applications for mobile platforms varies within a few dollars.  Permissible.  However, for Windows, there is only one similar program costing $ 30 for the basic version for ‚Äúpersonal needs only‚Äù (I will not give the name - it is based on the same keyword on the first link of the search engine).  Here I wondered how many lines of code the self-made implementation of such a trivial functionality would arise.  The result of this interest was a lonely GUI-interface window that hides a simple DAF generator under the hood, which I want to share with others - maybe someone will come in handy. <br><br><h3>  <font color="#cc0000">Trial.</font>  <font color="#cc0000">CLI interface</font> </h3><br>  To begin with we will sketch a concept in the form of a trial script.  We will use a bunch of " <i>Python3</i> + <i>PyAudio</i> ", where <i>PyAudio</i> is a module for working with sound.  The kernel will look like this: <br><br><pre><code class="python hljs">CHANNELS = <span class="hljs-number"><span class="hljs-number">2</span></span> RATE = <span class="hljs-number"><span class="hljs-number">44100</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genDAF</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(delay)</span></span></span><span class="hljs-function">:</span></span> bufferSize = floor(delay / <span class="hljs-number"><span class="hljs-number">1000</span></span> * RATE) device = PyAudio() <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: streamIn = device.open( format=paFloat32, channels=CHANNELS, rate=RATE, input=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, frames_per_buffer=bufferSize ) streamOut = device.open( format=paFloat32, channels=CHANNELS, rate=RATE, output=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, frames_per_buffer=bufferSize ) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> OSError: print(<span class="hljs-string"><span class="hljs-string">'genDAF: error: No input/output device found! Connect and rerun'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> print(<span class="hljs-string"><span class="hljs-string">'CTRL-C to stop capture'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> streamIn.is_active(): start = clock() audioData = streamIn.read(bufferSize) streamOut.write(audioData) actualDelay = floor((clock() - start) * <span class="hljs-number"><span class="hljs-number">1000</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Actual Delay: {} ms'</span></span>.format(actualDelay))</code> </pre> <br>  The <i>genDAF</i> procedure accepts a delay in milliseconds, calculates the required buffer size (based on the optimal bit rate of 44.1 kHz) for voice recording, and then, <u>if there are connections to input and output audio</u> (aka microphone and speakers), it creates two streams, input and output, respectively.  Then, in the main loop, reading and instant playback of the recorded piece of audio data begins, while the actual delay is taken against the background, which is required to perform a couple of read / write operations.  It took about 20 lines of code. <br><br>  Full source CLI-implementation under the spoiler: <br><br><div class="spoiler">  <b class="spoiler_title">dafgen_cli.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 # -*- coding: utf-8 -*- # Usage: python3 dafgen_cli.py &lt;delay_in_ms&gt; from pyaudio import PyAudio, paFloat32 from math import floor from time import clock import sys CHANNELS = 2 RATE = 44100 def genDAF(delay): bufferSize = floor(delay / 1000 * RATE) device = PyAudio() try: streamIn = device.open( format=paFloat32, channels=CHANNELS, rate=RATE, input=True, frames_per_buffer=bufferSize ) streamOut = device.open( format=paFloat32, channels=CHANNELS, rate=RATE, output=True, frames_per_buffer=bufferSize ) except OSError: print('genDAF: error: No input/output device found! Connect and rerun') return print('CTRL-C to stop capture') while streamIn.is_active(): start = clock() audioData = streamIn.read(bufferSize) streamOut.write(audioData) actualDelay = floor((clock() - start) * 1000) print('Actual Delay: {} ms'.format(actualDelay)) def main(): if len(sys.argv) != 2: print('Usage: python3 {} &lt;delay_in_ms&gt;'.format(sys.argv[0])) sys.exit(1) try: delay = int(sys.argv[1]) except ValueError: print('main: error: Invalid input type') sys.exit(1) if not 50 &lt;= delay &lt;= 200: print('main: error: Delay must be in [50; 200] ms') sys.exit(1) print('Delay: {} ms\n'.format(delay)) try: genDAF(delay) except KeyboardInterrupt: print('Stopped') if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br><h3>  <font color="#cc0000">Final.</font>  <font color="#cc0000">GUI interface</font> </h3><br>  Green letters on the black background of the terminal - romantic, but not always convenient, we can do better.  Let's add a framework for graphics to our bundle of tools, it will turn out " <i>Python3</i> + <i>PyAudio</i> + <i>PyQt5</i> ". <br><br>  Sketch in the designer a couple of buttons, a slider and 2 text fields: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0a0/d52/4b0/0a0d524b0e5c595066f8e1ac1ac3587d.png" alt="image"></div><br>  Let's add logic, distributing the main DAF generation code into two classes: the control application (MainApp) and the class for a separate thread (Worker), responsible for executing the _genDAF <i>while loop</i> , so that the main window does not hang.  The full code is given at the end of the paragraph, and now only the main part. <br><br>  Control Application: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainApp</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(QMainWindow, Ui_DAFGen)</span></span></span><span class="hljs-class">:</span></span> _CHANNELS = <span class="hljs-number"><span class="hljs-number">2</span></span> _RATE = <span class="hljs-number"><span class="hljs-number">44100</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> super().__init__() self.setupUi(self) <span class="hljs-comment"><span class="hljs-comment"># ... # ... def _startCapture(self): bufferSize = floor(self.delaySlider.value() / 1000 * self._RATE) device = PyAudio() try: streamIn = device.open( format=paFloat32, channels=self._CHANNELS, rate=self._RATE, input=True, frames_per_buffer=bufferSize ) streamOut = device.open( format=paFloat32, channels=self._CHANNELS, rate=self._RATE, output=True, frames_per_buffer=bufferSize ) except OSError: QMessageBox.critical(self, 'Error', 'No input/output device found! Connect and rerun.') return self._workerThread = Worker(bufferSize, streamIn, streamOut) self._workerThread._trigger.connect(self._updateActualDelay) # ... self._workerThread.start()</span></span></code> </pre><br>  Second stream: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Worker</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(QThread)</span></span></span><span class="hljs-class">:</span></span> _trigger = pyqtSignal(float) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, bufferSize, streamIn, streamOut)</span></span></span><span class="hljs-function">:</span></span> QThread.__init__(self) self._bufferSize = bufferSize self._streamIn = streamIn self._streamOut = streamOut <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__del__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.wait() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_genDAF</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> self._streamIn.is_active(): start = clock() audioData = self._streamIn.read(self._bufferSize) self._streamOut.write(audioData) actualDelay = clock() - start self._trigger.emit(actualDelay) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._genDAF()</code> </pre><br>  The source for the logic of the GUI-implementation under the spoiler: <br><br><div class="spoiler">  <b class="spoiler_title">dafgen.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 # -*- coding: utf-8 -*- # Usage: python3 dafgen.py from PyQt5.QtWidgets import * from PyQt5.QtCore import * from ui_dafgen import Ui_DAFGen from pyaudio import PyAudio, paFloat32 from math import floor from time import clock import sys class Worker(QThread): _trigger = pyqtSignal(float) def __init__(self, bufferSize, streamIn, streamOut): QThread.__init__(self) self._bufferSize = bufferSize self._streamIn = streamIn self._streamOut = streamOut def __del__(self): self.wait() def _genDAF(self): while self._streamIn.is_active(): start = clock() audioData = self._streamIn.read(self._bufferSize) self._streamOut.write(audioData) actualDelay = clock() - start self._trigger.emit(actualDelay) def run(self): self._genDAF() class MainApp(QMainWindow, Ui_DAFGen): _CHANNELS = 2 _RATE = 44100 def __init__(self): super().__init__() self.setupUi(self) self.stopButton.setEnabled(False) self._updateDelay() self.delaySlider.valueChanged.connect(self._updateDelay) self.startButton.clicked.connect(self._startCapture) self.stopButton.clicked.connect(self._stopCapture) self.quitButton.clicked.connect(QApplication.quit) def _updateDelay(self): self.delayEdit.setPlainText(str(self.delaySlider.value()) + ' ms') def _startCapture(self): bufferSize = floor(self.delaySlider.value() / 1000 * self._RATE) device = PyAudio() try: streamIn = device.open( format=paFloat32, channels=self._CHANNELS, rate=self._RATE, input=True, frames_per_buffer=bufferSize ) streamOut = device.open( format=paFloat32, channels=self._CHANNELS, rate=self._RATE, output=True, frames_per_buffer=bufferSize ) except OSError: QMessageBox.critical(self, 'Error', 'No input/output device found! Connect and rerun.') return self._workerThread = Worker(bufferSize, streamIn, streamOut) self._workerThread._trigger.connect(self._updateActualDelay) self.startButton.setEnabled(False) self.delaySlider.setEnabled(False) self.stopButton.setEnabled(True) self._workerThread.start() def _stopCapture(self): self._workerThread.terminate() self.actualDelayEdit.clear() self.startButton.setEnabled(True) self.delaySlider.setEnabled(True) self.stopButton.setEnabled(False) def _updateActualDelay(self, t): newValue = floor(t * 1000) self.actualDelayEdit.setPlainText(str(newValue) + ' ms') def main(): app = QApplication(sys.argv) win = MainApp() win.show() sys.exit(app.exec_()) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br><h3>  <font color="#cc0000">Conclusion and code</font> </h3><br>  Actually everything I wanted to tell.  Feel free to use. <br><br>  I will also leave the <a href="https://github.com/snovvcrash/daf-generator">link</a> to the project entirely: in addition, there are the GUI code and the template for the PyQt Designer. <br><br>  Thanks for attention! <br><br><h3>  <font color="#cc0000">Literature</font> </h3><br>  Missulovin L. Ya., Yurova M. S. Overcoming stuttering in adolescents and adults with the use of devices such as "AIR" // Scientific-methodical electronic journal "Concept".  - 2015. - ‚Ññ S23.  - pp. 46‚Äì50.  - URL: <a href="http://e-koncept.ru/2015/75287.htm">e-koncept.ru/2015/75287.htm</a> . </div><p>Source: <a href="https://habr.com/ru/post/347580/">https://habr.com/ru/post/347580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347570/index.html">Again about services for ICO: read and be terrified</a></li>
<li><a href="../347572/index.html">The story of how two graduates of "mathex" made the first sales</a></li>
<li><a href="../347574/index.html">We use Apple Pay and Troika card as a pass to work</a></li>
<li><a href="../347576/index.html">Object in a case or Optional in Java 8 and Java 9. Part 2: ‚ÄúHow it is done in Java 8‚Äù</a></li>
<li><a href="../347578/index.html">‚ÄúWhen you tell a true story, they believe it much more‚Äù - Interview with Oleg Shelaev, part 2</a></li>
<li><a href="../347582/index.html">Personal experience: how we transferred the infrastructure from one data center to the US to another</a></li>
<li><a href="../347584/index.html">Disable triggers in ZABBIX on schedule</a></li>
<li><a href="../347586/index.html">How I made AI to identify fake news with an accuracy of 95% and almost went crazy</a></li>
<li><a href="../347588/index.html">Tough and flexible IT skills: everything is more and less serious than I would like to think</a></li>
<li><a href="../347590/index.html">Open science school hackathon DeepHack.Babel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>