<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connecting Access Points to a Cisco Wi-Fi Controller</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Using the first tutorial from my series of articles, you configured and connected to your local network your Cisco Wireless Access Point Controller WL...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connecting Access Points to a Cisco Wi-Fi Controller</h1><div class="post__text post__text-html js-mediator-article">  Using the <a href="http://habrahabr.ru/post/145082/">first tutorial</a> from my series of articles, you configured and connected to your local network your Cisco Wireless Access Point Controller WLC.  There is access to it, but there is no ‚Äúwifi users‚Äù yet.  Your next step is to connect to the controller the available access points, which will serve the radio clients.  How to make it, and will be discussed today. <br><a name="habracut"></a><br><br>  Despite the openness of the CAPWAP protocol, your controller will work only with Cisco-made points, which is directly stated by the manufacturer.  From the currently available devices, there are several classes: <br><ul><li>  with one 2.4 GHz radio module (b / g / n), or with two 2.4 and 5 GHz (a / n).  Due to the foulness of the first band (there are only three non-overlapping 20-MHz channels: 1, 6, 11), it is highly recommended to choose dual-band access points, since the controller has the means of ‚Äúsqueezing‚Äù clients into a free 5 GHz band (about 23 channels); </li><li>  with the support of high transmission rates (-n), which is mainly achieved by other signal modulations (MCS), an increase in the number of input / output streams (MIMO), channel fusion, games with interframe intervals and other tricks).  It must be remembered that the speed of data transmission between the client and the access point has, roughly speaking, an inverse dependence on distance, and the total capacity of the network segment is shared between all users; </li><li>  with support for connecting external antennas, or with built-in ones (choose - for you to work in a simple office with cardboard walls, or in a warehouse, street, ...); </li><li>  having the ability to work autonomously, or only through a controller (Aironet 3600); </li><li>  simple in functionality of electronics, or with tricks to work in difficult radio conditions (ClientLink, CleanAir, ...) </li></ul><br>  A good comparison of the capabilities of different devices is <a href="http://www.cisco.com/en/US/products/hw/wireless/products_category_buyers_guide.html">given</a> by the manufacturer.  Pick yourself, depending on the budget, the task.  For experiments, or a simple network, old, not fully supported models 1121 b / g (but for $ 15), or newer devices, 1131AG, are quite suitable.  How many points to take - it is necessary to find out experimentally by measuring the signal level, calculations, own and others experience.  In any case, later nothing will prevent you from simply adding one or two new access points to a place where a weak signal level is clearly visible (software like <a href="http://www.cisco.com/en/US/products/ps11686/index.html">WCS / NCS</a> will show you directly on the map, and even give advice in the planning mode).  In this case, no reconfiguration is required, the controller will sort out the power level and frequency plan automatically.  The number of supported access points is determined by the license;  for some controllers (5508 and 2504) additional licenses can be purchased.  It is recommended to increase the fault tolerance, it is desirable to have two controllers, and correctly distribute the points between them.  About this, apparently, another time. <br><br>  In the meantime, if your access points come from the ‚Äúautonomous world‚Äù (AIR-AP-xxx), they need to be converted to the world of controllers (AIR-LAP-xx).  All access points support this operation.  To do this, you will need an access point itself, accessible over the network (with a specified IP address and known access rights), and either a special <a href="http://www.cisco.com/en/US/docs/wireless/access_point/conversion/lwapp/upgrade/guide/lwapnote.html">free utility</a> or a WCS or NCS management software with the required tool.  All preproshivka, by and large, is reduced to the following operations: <br><ul><li>  rewriting (TFTP) of a special recovery image to an access point </li><li>  delete old config file </li><li>  remove existing offline software </li><li>  clock synchronization </li><li>  generation of the certificate of the access point, if it does not already exist </li></ul><br>  The certificate is needed because the communication protocol of the access point with the controller, CAPWAP, is based on the Datagram TLS protocol, which is actually protected via UDP transport certificates. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The converted access point reboots and then ‚Äúsearches‚Äù for its controller.  So does the ‚Äúlightweight‚Äù access point out of the box, which was purchased immediately.  The search process includes getting the IP address of the device, as well as getting a list of controllers, checking the availability, availability and load of each of them, and actually registering with the selected one.  Let us dwell on this issue in detail, since it is the key in this article, and usually causes the most problems. <br><br>  The access point can <b>OR</b> obtain an IP address from a DHCP server (any manufacturer: Cisco IOS, Miscosoft, Unix ISC-DHCP), <b>OR</b> use a statically configured IP address.  Depending on the circumstances, you can use any method.  In your case, it may turn out that there is no DHCP server (or no rights to it), or the access point is already installed in a hard-to-reach place (behind a false ceiling).  Either there is no longer a COM port anywhere (but we hope that you are aware of the USB-COM adapters). <br><br>  To manually configure the access point, you need to connect to the console (9600/8 / N / 1), except for the Model 1121, which has no console port.  When loading, the access point gets into the mode of receiving the address, and finding the controller.  By default, the login and password is " <b>Cisco</b> " (with a capital letter), the <i>enable</i> password is the same.  With a certain number of unsuccessful attempts, the point reboots and continues the process forever.  To prevent reboots, cancel them with the following undocumented command: <br><br> <code>debug capwap client no-reload</code> <br> <br>  Next, we explicitly set the address to the point: <br><br> <code>capwap ap ip address &lt;ip_address&gt; &lt;subnet mask&gt; <br> capwap ap ip default-gateway &lt;gw_address&gt;</code> <br> <br>  Attention!  The lightweight access point performs a special IOS version in which the configuration mode is not available.  In an amicable way, it is not needed: the point receives all configuration settings from the controller at the time of registration on it.  The exception is a small set of static configuration, such as an IP address.  In theory, you can force the point to switch to configuration mode from the command line through an undocumented <b>debug capwap console cli command</b> , but this method is fraught with consequences and is not needed in practice. <br><br>  Next, set the point addresses of the controllers.  The first controller (one is enough): <br><br> <code>capwap ap controller ip address &lt;wlc_mgmt_ip&gt;</code> <br> <br>  If you have two or more controllers, then this is better: <br><br> <code>capwap ap primary-base &lt;controller_name&gt; &lt;wlc_mgmt_ip&gt; <br> capwap ap secondary-base &lt;controller_name&gt; &lt;wlc_mgmt_ip&gt;</code> <br> <br>  You must specify the address of the <i>management</i> interface of the controller (where you connect to the web interface), and not the address of the <i>ap-manager</i> interface.  You can view the result of the configuration with the <b>show capwap client config</b> command: <br><br> <code>configMagicMark 0xF1E2D3C4 <br> chkSumV2 47358 <br> chkSumV1 27913 <br> swVer 7.0.220.0 <br> adminState ADMIN_ENABLED(1) <br> name ap2.wlab <br> location KorpusXX <br> group name ApGg1 <br> mwarName wlc2...n <br> mwarIPAddress ...3 <br> mwarName <br> mwarIPAddress 0.0.0.0 <br> mwarName <br> mwarIPAddress 0.0.0.0 <br> ssh status Enabled <br> Telnet status Disabled <br> ... <br></code> <br>  To automatically configure the IP address of the access point via DHCP, you must also set an additional option, number 43, which tells the point about the addresses of the controllers available to it.  Read more about setting up different servers <a href="http://www.cisco.com/en/US/tech/tk722/tk809/technologies_configuration_example09186a00808714fe.shtml">here</a> .  The trick is to pass in the parameters of option 43 the addresses of your controllers.  The parameter value (in HEX format) has the format TLV, for example, <i>f108c0a80a05c0a80a14</i> , where 0xf1 (241) is the parameter number of the option, 0x08 (data length, twice 4 bytes / octet of the IP address), 0xc0a80a05 is translated into 192.168.10.5 and 0xc0a80a14 at 192.168.10.20. <br><br>  The access point can get the addresses of the controllers also through a query by DNS, or from neighbors "by air". <br><br>  A little about connecting the device to the local network.  All the access point needs is IP connectivity with the controller.  Simply connect it to the access-port (access port) of your local network, along with other computers.  Only in the case of video or voice applications in the radio network, you will need to <a href="http://www.cisco.com/en/US/tech/tk722/tk809/technologies_configuration_example09186a00807e9717.shtml">configure prioritization</a> , and in the case of a remote office and the H-REAP configuration point, the trunk port.  Even if one access point provides connectivity to multiple SSIDs (radio networks) with its own security policies and connection to VLANs, you only need to worry about the interface settings with the wired network at the controller level. <br><br>  Having established a point in the local network, we look at how it tries to connect to the controller ( <b>Monitor-AP Join</b> ): <br><br><img src="https://habrastorage.org/storage2/566/693/eeb/566693eebce7c936f45fc9a50dc05284.jpg"><br><br>  However, it happens that the access point seems to see the controller, but does not want to connect to it point-blank.  This is almost certainly due to the established security policies that are configured in the " <b>Security-AAA-AP Policies</b> " menu.  Almost all of these policies are somehow related to certificates.  We will understand this issue in detail. <br><br>  As stated above, due to the details of the CAPWAP operation, the data between the point and the controller is encrypted using certificates.  Certificates are, of course, on the controller, and on the access point.  The controller comes with already installed Cisco Systems certificates (root, and its derivatives), may carry additional certificates for web authorization and a local RADIUS server that do not belong to access points, and can also be supplemented with a certificate from your own Certificate Authority (PKI) .  Certificates of access points, which are then authorized on the controller, are of the following four types: <br><ul><li>  MIC (Manufacture Installed Certificate) </li><li>  SSC (Self-Signed Certificate) </li><li>  LSC (Locally Significant Certificate) </li><li>  LBS-SSC (Location-Based Services-SSC) </li></ul><br>  The first type of certificates is present at all access points, including autonomous, issued after 2006.  This certificate is sewn at the factory, signed by the vendor itself, and tied to the MAC address of the access point. <br>  SSC certificates are generated by the point itself at the time of its conversion to the ‚Äúlightweight‚Äù one if the MIC certificate is not present.  It is signed by itself. <br>  You <a href="http://www.cisco.com/en/US/products/ps6366/products_configuration_example09186a0080a99e23.shtml">can write out</a> LSC certificates <a href="http://www.cisco.com/en/US/products/ps6366/products_configuration_example09186a0080a99e23.shtml">yourself</a> with your PKI, if your organization has instructions to use only local means for digital signature and encryption systems. <br>  The LBS-SSC certificate is created and used by <a href="http://www.cisco.com/en/US/products/ps9742/index.html">Mobility Services Engine</a> devices when interacting with the controller. <br><br>  What types of certificates of access points to take when trying to authorize, you can configure yourself. <br><br><img src="https://habrastorage.org/storage2/4d8/1c7/93f/4d81c793f7ded41b1a2e106028f124c9.jpg"><br><br>  In addition, you can use the RADIUS server to verify the validity of the MAC address of the access point.  You can also explicitly set the MAC address of the point using the MIC certificate (auth-list).  However, for SSC certificates, in any case, you must add each of them to the list, while not only specifying the MAC address of the Ethernet interface of the access point, but also the hash of the certificate.  Where to get it?  On the controller, enable debugging of the certificate verification process: <br><br>  (Cisco Controller)&gt; <b>debug pm pki enable</b> <br> <code>*spamReceiveTask: Jun 10 21:49:39.450: sshpmGetCID: called to evaluate cscoDefaultIdCert <br> *spamReceiveTask: Jun 10 21:49:39.450: sshpmGetCID: comparing to row 0, CA cert bsnOldDefaultCaCert <br> *spamReceiveTask: Jun 10 21:49:39.450: sshpmGetCID: comparing to row 1, CA cert bsnDefaultRootCaCert <br> *spamReceiveTask: Jun 10 21:49:39.450: sshpmGetCID: comparing to row 2, CA cert bsnDefaultCaCert <br> ... <br> *spamReceiveTask: Jun 10 21:49:39.731: sshpmGetIssuerHandles: subject L=San Jose, ST=California, C=US, O=Cisco Systems, MAILTO=support@cisco.com, CN=C1100-000f244ed6aa <br> *spamReceiveTask: Jun 10 21:49:39.731: sshpmGetIssuerHandles: issuer L=San Jose, ST=California, C=US, O=Cisco Systems, MAILTO=support@cisco.com, CN=C1100-000f244ed6aa <br> *spamReceiveTask: Jun 10 21:49:39.732: sshpmGetIssuerHandles: Mac Address in subject is 00:0f:24:4e:d6:aa <br> *spamReceiveTask: Jun 10 21:49:39.732: sshpmGetIssuerHandles: Cert Name in subject is C1100-000f244ed6aa <br> *spamReceiveTask: Jun 10 21:49:39.732: sshpmGetIssuerHandles: Cert is issued by Cisco Systems. <br> *spamReceiveTask: Jun 10 21:49:39.741: ssphmSsUserCertVerify: self-signed user cert verfied. <br> ... <br> *spamReceiveTask: Jun 10 21:49:39.752: sshpmGetIssuerHandles: SSC Key Hash is d886bcaf0d22398538ccdef3f53d6ec7893463b8 <br> *spamReceiveTask: Jun 10 21:49:39.755: sshpmFreePublicKeyHandle: called with 0xf2de114 <br></code> <br><br>  Select Add, type SSC, Copy-MAC address and hash in the corresponding fields, Apply, wait for the point to reboot, turn off debug (debug disable-all), the point is connected: <br><br><img src="https://habrastorage.org/storage2/ecc/1d0/706/ecc1d07064b4953d5c910d0ef2853af2.jpg"><br><br>  You can also add a certificate hash manually: <br> <code>config auth-list ap-policy ssc enable <br> config auth-list add ssc 00:0f:24:4e:d6:aa d886bcaf0d22398538ccdef3f53d6ec7893463b8 <br></code> <br>  Everything that can be done with the controller via the web interface can also be obtained via the command line.  This is a matter of convenience and habit.  Warning: some specific commands are available only from the command line. <br><br>  Now that our access point is connected (I hope all the others too), you can turn on the radio interfaces (Wireless - 802.11a / n, 802.11b / g / n), the -g, -n modes, and go on to setting up wireless networks (SSID)  About this next time. <br>  UPD: Continued: <a href="http://habrahabr.ru/post/148903/">Configuring Wireless Networks on a Cisco Controller</a> </div><p>Source: <a href="https://habr.com/ru/post/145677/">https://habr.com/ru/post/145677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145670/index.html">What is Red Hat CloudForms?</a></li>
<li><a href="../145671/index.html">Delivering e-books from Amazon costs more than delivering paper books</a></li>
<li><a href="../145672/index.html">Effective web development with Visual Studio 2012: innovations in the WebForms editor</a></li>
<li><a href="../145673/index.html">Methods like first class citizens in C ++</a></li>
<li><a href="../145674/index.html">"Random Millionaire" received from the bank $ 7.7 million by mistake</a></li>
<li><a href="../145678/index.html">Practical tasks from unity3dstudent.com</a></li>
<li><a href="../145679/index.html">ObjectDB - database management system for Java applications</a></li>
<li><a href="../145680/index.html">Website development with responsive design</a></li>
<li><a href="../145681/index.html">Exchange 2007/2010, sending letters to domain users who have external mailing addresses</a></li>
<li><a href="../145682/index.html">Algorithms of sorting. Gnome Sort on C</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>