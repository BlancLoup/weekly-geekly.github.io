<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Manage SkyKettle Kettle from GNU / Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introductory 
 Quite a lot even on Giktimes advertise the technology of the company Redmond which supports the technology R4S - Ready For Sky. 

 Ever...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Manage SkyKettle Kettle from GNU / Linux</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introductory </h4><br>  Quite a lot even on Giktimes advertise the technology of the company Redmond which supports the technology R4S - Ready For Sky. <br><br>  Everything would be fine, but this technology is controlled via Bluetooth from a smartphone.  And no more.  There is, they say, an option with some kind of gateway and control from the cloud ... but to expose my favorite teapot outside is no joy. <br><br>  The situation is strange.  On the one hand Ready For Sky is in the consortium - allseenalliance, which, it seems, is some kind of open source.  On the other hand, I have not seen a code fragment or a line of documentation for the protocol of my teapot.  I suspect that inside something like a NORDIC SEMICONDUCTOR chip - and maybe you should read the dock on it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Anyone who buys equipment with closed protocols commits violence against the future. <br><img src="https://habrastorage.org/files/c52/851/373/c5285137339f495ead6e18fa30946a60.png"><br>  This article describes the first step in managing a teapot in GNU / Linux ‚Äî the ability to turn it on and off from the console (with reservations).  This is important because if you want tea - you are not taking your hands off the keyboard and put it to boil.  Then go drink it.  Before that - I had to look for a smartphone and clap my fingers at it - it's easier to walk to the teapot.  Another advantage is access multiplexing - while you can only keep one smartphone connected to the kettle, and the results of the console query can be broadcasted in many places. <br><br>  I think everyone can extend this approach to a small web application. <br><a name="habracut"></a><br><br><h5>  How to get exchange data </h5><br>  Starting with Android 4.4, it seems that the option - Settings-&gt; Developer Options-&gt; Enable Bluetooth HCI snoop log has appeared in the developer menu (The developer menu is hidden by default).  When this option is enabled, all phone communication via Bluetooth is logged in the btsnoop_hci.log file (the file name in the phone memory may differ depending on the settings).  Then this log can be copied to a PC and analyzed there using wireshark.  That conveniently and accurately shows the entire exchange, opening and unpacking packages. <br>  Thus, the scenario is trivial - we work with a teapot from a regular application, save the log, analyze it.  Next is the task - to repeat the exchange of their funds, posing as a telephone. <br><br><h5>  What is the exchange protocol </h5><br>  I am not a big Bluetooth specialist, but Bluetooth Low Energy devices have several protocols on top of the connection itself - one of them is the GATT / BT ATT protocol - <a href="https://en.wikipedia.org/wiki/List_of_Bluetooth_protocols">en.wikipedia.org/wiki/List_of_Bluetooth_protocols#Low_Energy_Attribute_Protocol_.28ATT.29</a> , it is in turn overwritten over the L2CAP protocol.  It is for BT ATT that the kettle and the smartphone communicate. <br><br>  If we scan and query the teapot for primary services, we‚Äôll get something like <br><br><pre><code class="bash hljs">gatttool -b E7:5A:53:79:82:A4 -t random --primary</code> </pre> <br><ul><li>  attr handle = 0x0001, end grp handle = 0x0007 uuid: 00001800-0000-1000-8000-00805f9b34fb Generic Access </li><li>  attr handle = 0x0008, end grp handle = 0x0008 uuid: 00001801-0000-1000-8000-00805f9b34fb Generic Attribute </li><li>  attr handle = 0x0009, end grp handle = 0xffff uuid: 6e400001-b5a3-f393-e0a9-e50e24dcca9e UART Service </li></ul><br><br>  It is through the latter service that the communication will be conducted. <br>  Now you can see all the detailed features - <br><br><pre> <code class="bash hljs"> gatttool -b E7:5A:53:79:82:A4 -t random --characteristics</code> </pre><br><ul><li>  handle = 0x0002, char properties = 0x0a, char value handle = 0x0003, uuid = 00002a00-0000-1000-8000-00805f9b34fb read write </li><li>  handle = 0x0004, char properties = 0x02, char value handle = 0x0005, uuid = 00002a01-0000-1000-8000-00805f9b34fb read </li><li>  handle = 0x0006, char properties = 0x02, char value handle = 0x0007, uuid = 00002a04-0000-1000-8000-00805f9b34fb read </li><li>  handle = 0x000a, char properties = 0x10, char value handle = 0x000b, uuid = 6e400003-b5a3-f393-e0a9-e50e24dcca9e notify read </li><li>  handle = 0x000d, char properties = 0x0c, char value handle = 0x000e, uuid = 6e400002-b5a3-f393-e0a9-e50e24dcca9e write </li></ul><br>  I am somewhat confused by the absence in the enumeration of handle 0x000c, which is used in communication.  Anyway. <br><br>  So, how is the communication: <br>  - the smartphone establishes a connection with the kettle <br>  - reads, like me just now, the capabilities of a teapot. <br>  - then initiates communication by writing down the handle 0x000c (of which the value 0x0100 appears to be when polled and not) <br>  - then it sends commands to the teapot according to its own protocol (or maybe it is a protocol from NORDIC), and periodically polls its status - all this is on top of UART Service&gt; ATT&gt; BLE <br><br><h5>  How to manage it? </h5><br>  The question is naturally divided into hardware and software.  It's not difficult with the first one - I bought the first dongle on ALI and it earned - <a href="http://ru.aliexpress.com/item/Bluetooth-4-0-Dongles-Mini-USB-2-0-3-0-Bluetooth-Dongle-Adapters-Dual-Mode-adapter/32292553074.html">ru.aliexpress.com/item/Bluetooth-4-0-Dongles-Mini-USB-2-0-3-0-Bluetooth-Dongle-Adapters -Dual-Mode-adapter / 32292553074.html</a> <br><br>  With the software part is much more complicated.  Actually under GNU / Linux we have no choice - BlueZ.  And there are problems with this. <br>  If I understand correctly, the typical way to work with BlueZ is through DBUS.  C / C ++ / Phyton bindings, like and is, but not for the BT ATT protocol.  But for him there is a command line tool gatttool. <br><br>  It seemed to be a good thing - an open source tool, and you can see how it works - <a href="http://code.metager.de/source/xref/linux/bluetooth/bluez/attrib/">code.metager.de/source/xref/linux/bluetooth/bluez/attrib</a> .  But there is little confusion from the source code - it is not easily separated from bluez and glib.  I was too lazy to finish off and collect it separately.  And I would like to make some corrections.  Gatttool has an inversion of abstraction ‚Äî it hides a connection from the user in a ‚Äúnon-interactive‚Äù mode, and cannot be reasonably automated in an ‚Äúinteractive‚Äù one.  Moreover, the documentation in blueZ is very bad. <br><br>  The kettle very quickly breaks the connection - within a second.  And the protocol requires immediately after reconnect to send 0x0100 to handle 0x000e - so we have two choices left - <br>  1. Try to wrap up the gatttool interactive mode and access it - running in the background via bash or python. <br>  2. Send 0x0100 to handle 0x000e always.  In the hope that it includes something inside there, and this something will not turn on again for the second time. <br><br>  I did not master the first approach, although I tried very hard, the fact is that gatttool uses not pure stdout for output, but the GNU Readline Library, and the task of the wrapper was equal to the task of reassembly.  Because he went the second way. <br><br><h5>  So back to the communication protocol. </h5><br>  It is time to dive into the wilds. <br>  First of all, to control the kettle you need to log in. <br>  A smartphone for this selects the key and sends successively the parcels to the handle 0x000e and receives answers from the handle 0x000b <br><br> <code>SEND 55:00:ff: [8  ] :aa <br> RECV: 55:00:ff:00:aa <br> SEND 55:01:ff: [8  ] :aa <br> RECV: 55:01:ff:00:aa <br> SEND 55:02:ff: [8  ] :aa <br> RECV: 55:02:ff:00:aa <br></code> <br><br>  From this simple exchange it can be seen that the messages to the handle are numbered and the answers come with the same number - for ease of identification.  Each exchange starts with 0x55 and ends with 0xAA (striped numbers).  Usually the third byte of the response repeats the command number. <br><br>  Now you need to walk to the kettle and press the "+" button on it for 10 seconds.  Just as they did with the smartphone.  In this case, the output will change to <br> <code>SEND: 55:1e:ff: [8  ] :aa <br> RECV: 55:1e:ff: <font color="red">01</font> :aa <br></code> <br>  Now it will always be with this request.  Key remembered.  What kind of team uses a smartphone after logging in? <br><h6>  Sending immediately after switching on - the meaning is not clear until the end </h6><br> <code>SEND: 55: counter :01:aa <br> RECV: 55: counter :01:02:06:aa <br></code> <br>  There remains a mystery value of 4 and 5th bytes. <br><h6>  Boil and / or support </h6><br> <code>SEND: 55: counter :05:00:00:28:00:aa <br> SEND: 55: counter :05:00:00:00:00:aa -   . <br> SEND: 55: counter :05:01:00:5f:00:aa <br> RECV: 55: counter :05:01:aa // 01 status meens OK <br></code> <br>  The format looks like this: <br> <code>55: counter :05:[  ]:00: [ ] :00:aa <br></code> <br>  5, 7 request bytes are not clear to me - non-zero ones I did not see them <br><h6>  Power off </h6><br> <code>SEND: 55: counter :04:aa <br> RECV: 55: counter :04:01:aa // 01 status meens OK <br></code> <br><h6>  Request status </h6><br> <code>SEND: 55: counter :06:aa <br> RECV: 55: counter :06:00:00:00:00:00:0c:00:00:00:00:51:00:00:00:00:00:aa - kettle is on in boiling <br> RECV: 55: counter :06:00:00:28:00:00:0c:00:01:02:00:33:00:00:00:00:00:aa - kettle is on <br> RECV: 55: counter :06:00:00:00:00:00:0c:00:00:00:00:3e:00:00:00:00:00:aa - kettle is off <br> RECV: 55: counter :06 00 00 28 00 00 0c 00 01 00 00 64 00 00 00 00 00 aa <br> RECV: 55: counter :06 01 00 28 00 00 0c 00 01 02 00 64 00 00 00 00 00 aa - kettle finished boiling <br> RECV: 55: counter :06 01 00 28 00 00 0c 00 01 02 00 63 00 00 00 00 00 aa - a while after finished boiling <br> <br>  : <br> 55: counter :06: keep warm? :00: keepwarm temp? :00:00:0c:00:01: heater? :00: temp :00:00:00:00:00:aa <br> <br> heater -   ,   -   10-12 . <br> - 0x00 - off <br> - 0x02 - on <br> temp <br> -     ( ) <br> keepwarm temp <br> -   ,    <br></code> <br>  Most of the bytes except the temperature I do not understand.  Must be, probably, the gauge of emptiness of a teapot. <br><h5>  How to use it </h5><br>  - put yourself on GNU / Linux bluez and check that you have gatttool - it should be included. <br>  - to find out the MAC of your kettle calling <br>  bt-device -l <br>  - download the script from the repository below <br>  - execute one of the following commands (you may need to have rights to write to bluetooth) <br>  (if not already done - authorize the app by pressing "+" on the kettle.) <br><br>  ./connect.sh [KETTLE MAC] auth - just waiting for authorization <br>  ./connect.sh [KETTLE MAC] query - request status in a loop <br>  ./connect.sh [KETTLE MAC] queryone - query status once <br>  ./connect.sh [KETTLE MAC] keeptemp ‚Äî enable in boil-up mode and maintain <br>  ./connect.sh [KETTLE MAC] on - enable <br>  ./connect.sh [KETTLE MAC] off - disable <br><br>  - remember that only one device can control the teapot at any one time - if you have an active application on your smartphone running and active - nothing will work. <br><br><h5>  Problems remain </h5><br>  1. It is not clear when deauthorization occurs.  Obviously not by reconnect.  Possible by exhausting 255 meter requests. <br>  2. The bash code is delayed and all sorts of races are possible.  It's horrible.  You must still gut gatttool and make a neat implementation. <br>  3. Perhaps it is necessary to peel the teapot to understand what color of offal is it and what else can you do with it on BT?  can alter and add something useful there? <br>  4. I will author you all with a hard-coded key ... and then I can manage all your kettles if you are my neighbor.  This is all too correct. <br>  5. Unzip all the details of the protocol.  Are there any vulnerabilities? <br><br><h5>  Where to get? </h5><br><br>  Well, the repository is raw - <a href="https://github.com/PimenovAlexander/r4s-bluetooth">github.com/PimenovAlexander/r4s-</a> bluetooth. <br>  There are also dumps that can be viewed using wireshark <br>  If you have other R4S devices you can try to break them too.  If someone understands the Bluetooth pliz tell me where did this 0x000s handle come from. </div><p>Source: <a href="https://habr.com/ru/post/371965/">https://habr.com/ru/post/371965/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../371953/index.html">The monkey driving the wheelchair and the VR avatar by the power of thought is real</a></li>
<li><a href="../371955/index.html">Digital medicine: are consumers ready for mobile check-ins and telemedicine?</a></li>
<li><a href="../371957/index.html">PwC Blockchain Market Research: Application Potential and Key Trends</a></li>
<li><a href="../371959/index.html">The story of one project. Rating and Anonymizer</a></li>
<li><a href="../371963/index.html">Smartphone, laptop and tablet controls the light in the apartment</a></li>
<li><a href="../371969/index.html">Home archeology or forgotten artifacts</a></li>
<li><a href="../371971/index.html">Swatch will release a new smart watch brand Tissot</a></li>
<li><a href="../371973/index.html">A simple digital thermometer / hygrometer on AM2302 (DHT22), ATtiny13 and MAX7219</a></li>
<li><a href="../371977/index.html">People with high IQ do not need a lot of friends for happiness</a></li>
<li><a href="../371979/index.html">Why geeks buy bread makers or how trade in niche bio-goods is arranged</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>