<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stripe API version control system as a separate tool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author of the material talks about the device version control system, which is implemented in the company Stripe. 



 When it comes to the API, c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stripe API version control system as a separate tool</h1><div class="post__text post__text-html js-mediator-article">  <i>The author of the material talks about the device version control system, which is implemented in the company Stripe.</i> <br><br><img src="https://habrastorage.org/web/569/d41/8f0/569d418f01234c76938d2e4bfdd13aa6.jpg" alt="image"><br><br>  When it comes to the API, change is unpopular.  While many software developers are accustomed to working in the mode of frequent and fast iterations, API developers lose this flexibility as soon as they get at least the first user of their interface.  Many of us are familiar with the evolutionary history of the Unix operating system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In 1994, the book Unix-Hater Desktop Guide (Unix-Haters Handbook) was published, which touched upon a whole list of a variety of sensitive topics, from the names of tele-optimized commands with a completely incomprehensible history of origin to irreversible deletion of data, incomprehensible intuitive programs from excess options.  More than 20 years later, the overwhelming majority of these complaints are still relevant, despite the diversity of currently available systems-heirs and branches.  Unix has become so widely popular that changing its behavior can lead to far-reaching consequences.  Good or bad, but between him and his users have already developed certain agreements that determine the behavior of Unix-interfaces. <br><br>  Similarly, the API is a communication contract, which cannot be changed without a significant amount of cooperation and effort on both sides.  Many businesses rely on Stripe as an infrastructure provider, and therefore we have been thinking about this kind of interaction from the very beginning of our company.  Currently, we have managed to maintain support for each version of our API since the company appeared in 2011.  In this article, we would like to share with you how we in Stripe manage to organize work with API versions. <br><a name="habracut"></a><br>  Written to integrate with the code, the code is initially associated with some expectations.  If the endpoint returns a boolean field called to indicate the status of a bank account, the user can write something like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> bank_account[:verified] ... else ... End</code> </pre> <br>  If after this we replace the Boolean field verified by the status field, which may include the verified field (as we did in 2014), the code will stop working because it depends on the field that no longer exists.  This type of change leads to a reverse incompatibility, and therefore we avoid such changes.  Fields that were previously present must continue to be present and always retain the same type and name.  However, not all changes lead to reverse incompatibility.  For example, it is safe to add a new API endpoint or a completely new field to an existing point. <br><br>  With sufficient coordination of efforts, we could keep users abreast of the upcoming changes and ask them to update their integrations in advance, but even if it were possible, such an approach cannot be called customer-oriented.  Like connecting electricity or water to a network, our API should work as long as possible without any need to make changes. <br><br>  Stripe provides an economic infrastructure for the Internet.  Just like electricity producers should not change the voltage every two years, we also believe that our users should be sure that the API will maintain its stability as long as possible. <br><br><h3>  API Versioning Schemes </h3><br>  There is a common approach that allows you to develop an Internet API - support for different versions.  When performing queries, users indicate the version of the API, and its suppliers can make changes in its next iteration, while maintaining compatibility in the current one.  As new versions are released, users can upgrade to newer at a convenient time for them. <br><br>  The essence of the most common version control scheme today is to use names like v1, v2 and v3, transmitted as a prefix to the URL (for example, / v1 / widgets) or via an HTTP header like Accept.  This approach may work, but its main drawback is that when the size of the update between versions is large, and it itself includes major changes, the complexity of the transition is equivalent to the need to re-integrate from scratch. <br><br>  The positive aspects of such a transition are not so obvious, since there is always a class of users who are unable or unwilling to upgrade, as a result of which they find themselves trapped in old versions of the API.  In this case, suppliers face a difficult choice between abandoning old versions and, as a result, losing such customers, and continuing support for old versions forever, which entails substantial costs.  Despite the fact that the second option may, at first glance, seem to be right from the point of view of customer-oriented solutions, support for outdated versions indirectly affects the quality of the project as a whole, because in fact it reduces the pace of work on innovations.  Instead of developing new features, the working time of engineers is partially eaten by the support of the old code. <br><br>  We at Stripe apply version control, named for the release date (for example, 2017-05-24).  Despite their backward incompatibility, each such update contains a small set of changes that make updating and updating their integration into a smooth and relatively simple process. <br><br>  When you first access the API from the user, the freshest version available is automatically assigned to his account, after which the system automatically implies that every subsequent API call will access this version from their side.  This approach eliminates the situation when users accidentally get a change that violates their integration, and also makes the initial integration less painful by reducing the amount of work required to configure it.  Users can enforce the version of each individual request by manually setting the Stripe-Version header, or by updating the version assigned in their account from the Stripe control panel. <br><br>  Some readers may have already noticed that the Stripe API also identifies major versions using the path prefix (for example, / v1 / charges).  And although we reserve the right to take advantage of this scheme sooner or later, it is unlikely that this will happen in the foreseeable future.  As noted above, major changes usually make upgrades difficult and unpleasant, and it is difficult for us to imagine such an important API redesign that could justify such inconvenience to users.  Our current approach has shown its effectiveness over nearly hundreds of backward-incompatible updates released over the past six years. <br><br><h3>  Under the hood version control system </h3><br>  Versioning is always a trade-off between improved developer tools and the added burden of supporting older versions.  In every way we strive to achieve the first, while at the same time minimizing the cost of work on the second item.  To achieve these goals, we have introduced a version control system.  Let's take a quick example of how it works.  Each possible answer from the Stripe API is written in the form of a class called the API resource.  Such resources define their possible fields using a domain-specific language: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChargeAPIResource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">required</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">required</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">End</span></span></span></span></code> </pre> <br>  API resources are written in such a way that the structure they describe is what we expect to get from the current version of the API.  When we need to make a backward-incompatible change, we encapsulate it in a version change module that defines the change documentation, the transformation itself, and the set of API resource types that are subject to change: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CollapseEventRequest</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractVersionChange</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">description</span></span></span><span class="hljs-class"> \ ‚Äú</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class">  ( -)   ‚Äú \ ‚Äú </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">,  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">   ‚Äú \ ‚Äú     ‚Äú \ ‚Äú </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> .‚Äù </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EventAPIResource</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">change</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type_old</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type_new</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hash</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">run</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">merge</span></span></span><span class="hljs-class">(:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> </span></span>=&gt; data[:request][:id]) end end end</code> </pre><br>  In other cases, changes are assigned in accordance with the data from the master list: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VersionChanges</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VERSIONS</span></span></span><span class="hljs-class"> </span></span>= { <span class="hljs-string"><span class="hljs-string">'2017-05-25'</span></span> =&gt; [ Change::AccountTypes, <span class="hljs-attr"><span class="hljs-attr">Change</span></span>::CollapseEventRequest, <span class="hljs-attr"><span class="hljs-attr">Change</span></span>::EventAccountToUserID ], <span class="hljs-string"><span class="hljs-string">'2017-04-06'</span></span> =&gt; [Change::LegacyTransfers], <span class="hljs-string"><span class="hljs-string">'2017-02-14'</span></span> =&gt; [ Change::AutoexpandChargeDispute, <span class="hljs-attr"><span class="hljs-attr">Change</span></span>::AutoexpandChargeRule ], <span class="hljs-string"><span class="hljs-string">'2017-01-27'</span></span> =&gt; [Change::SourcedTransfersOnBts], ... } end</code> </pre> <br>  Version changes are written in such a way that, if necessary, they are automatically applied in the reverse order from the current version of the API.  Each version change assumes, in spite of the presence of more recent changes ahead, that the data they receive will look the same as they were originally written. <br><br>  When generating the response, the API primarily formats the data by describing the API resource of the current version.  After that, the target API version is determined based on: <br><br><ul><li>  Heading Stripe-Version, if one has been transmitted. </li><li>  Versions of an authorized OAuth application, if requested on behalf of the user. </li><li>  The version assigned to the user, assigned when the very first request is sent to Stripe. </li></ul><br>  After this, the API does a reverse version crawl and applies each version change module in its path until it reaches the required version. <br><br><img src="https://habrastorage.org/web/50c/512/023/50c512023e4e45dfbf064260019f5030.png" alt="image"><br><br>  Before the API returns a response, all requests are processed by versioning modules. <br><br>  Modules version changes allow you to abstract from the old version of the API when working with the main code.  As a result, most of the time, developers can avoid thinking about older versions while developing new products. <br><br><h3>  Changes with side effects </h3><br>  Most of our back-incompatible API changes change its response, but this happens forever.  Sometimes a more complex change is required that results from the module defining it.  We assign the note has_side_effects to such modules, (there are side effects) and the transformation they describe turns into a blank code: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LegacyTransfers</span></span></span><span class="hljs-class"> &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractVersionChange</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">description</span></span></span><span class="hljs-class"> "..." </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_side_effects</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">End</span></span></span></span></code> </pre> <br>  The fact of their deactivation will also be checked in other parts of the code: <br><br><pre> <code class="javascript hljs">VersionChanges.active?(LegacyTransfers)</code> </pre> <br>  This reduction in encapsulation makes it difficult to support changes with side effects, so we try to avoid this approach. <br><br><h3>  Declarative changes </h3><br>  One of the advantages of standalone version change modules is that they can declare documentation that describes which fields and resources they impact.  We can use this to quickly provide our users with more useful information.  For example, the change log of our API is generated programmatically and updated as soon as we deploy new versions of services. <br><br>  We also customize API reference documentation to fit individual user needs.  It checks that the user is authorized in the system, and leaves notes to the fields, based on the current API version of his account.  In the image below, for example, we warn the developer that backward-incompatible changes have been made to newer versions of the API compared to its fixed version.  The event request field was previously a string, but now it is a sub-object that also contains the idempotency key (created within the version change code shown above): <br><br><img src="https://habrastorage.org/web/dcc/941/e20/dcc941e20a1c4c9ab82927b15acf20b2.png" alt="image"><br><br>  Our documentation defines the user version of the API and shows it the corresponding warnings. <br><br><h3>  Minimizing change </h3><br>  Providing enhanced backward compatibility is not a gift.  Each new version adds more code that needs to be understood and maintained.  We try to write as clean as possible, but over time dozens of revisions of versions that cannot be clearly encapsulated can cause the project to become overgrown with unnecessary things and, as a result, become slower, brittle and lose its readability.  In order to avoid the accumulation of this kind of expensive technical debt, we have taken several measures. <br><br>  Despite the fact that we have a well thought-out version control system, we do everything possible to avoid using it and, above all, we try to build the architecture of our API from the very beginning.  Any planned changes go through a simple review process, in which they are described in a brief information document and sent by mailing.  This allows you to look at the proposed changes more broadly, in terms of different departments of the company.  Increases the likelihood of detecting errors and inconsistencies before they get into the release. <br><br>  We try to always keep in mind the balance between the need to maintain previous versions and the development of new features.  Compatibility support is important, but even so, we expect to eventually abandon the older versions.  Helping users to upgrade to new versions gives them access to new features and simplifies the foundation we use to create new features. <br><br><h3>  Principles underlying change </h3><br>  The combination of rolling out the version and the internal framework supporting them allowed us to significantly expand our user base and make a huge number of changes to the API, which, however, had practically no effect on the quality of existing integrations.  This approach is based on several principles that we have chosen as a result of many years of practice.  We believe that it is important for API updates to meet the following criteria: <br><br><ul><li>  <b>Lightness</b>  Upgrades should be made as low-cost (both for users and for us) as possible. </li><li>  <b>First-class approach</b> .  Turn version control into a first-class concept for your API.  Make it so that you can use it for accurate documentation and improvement of tools, as well as for automatic generation of changelogs. </li><li>  <b>Fixed cost</b>  Make sure that the old versions add only a minimum of maintenance work, by firmly encapsulating them into versioning modules.  In other words, the less you need to think about the old behavior patterns while writing new code, the better. </li></ul><br>  Despite the fact that we are very interested to observe disputes and developments in topics such as REST vs.  GraphQL vs.  gRPC, and also - in a broader sense - discussions of how the API will look in the future, we believe to continue supporting version control schemes for quite some time. <br><br> <a href="http://payonline.ru/%3Futm_source%3Dhabrahabr%26utm_medium%3Dreferral%26utm_campaign%3Dwebpayments-main"><img src="https://habrastorage.org/files/8f6/e15/80b/8f6e1580b42a45e78421d1678ed655ad.png" alt="image"></a> </div><p>Source: <a href="https://habr.com/ru/post/319758/">https://habr.com/ru/post/319758/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319748/index.html">MySpace syndrome, which is also peculiar to Facebook</a></li>
<li><a href="../319750/index.html">Why payments are at the heart of tourist experience</a></li>
<li><a href="../319752/index.html">Zelle launch - proof that fintech companies can influence large banks</a></li>
<li><a href="../319754/index.html">How to create a virtual machine in Google Spreadsheets</a></li>
<li><a href="../319756/index.html">Reaching for milleniali: trends and mobile marketing techniques</a></li>
<li><a href="../319760/index.html">Terraform, Azure, Irkutsk and another 1207 words about transferring the game to the cloud</a></li>
<li><a href="../319762/index.html">7 services for finding mobile application vulnerabilities</a></li>
<li><a href="../319766/index.html">How to teach at the Yandex Interface Development School, and what I learned there</a></li>
<li><a href="../319768/index.html">In-depth training with the support of a virtual manager in the game against inefficiency</a></li>
<li><a href="../319770/index.html">Example of restoring PostgreSQL tables using the new mega features pg_filedump</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>