<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Example of implementation of a general performance indicator of MS SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 Often there is a need to create such a performance indicator, which would show the status of the DBMS relative to the previous period or a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Example of implementation of a general performance indicator of MS SQL Server</h1><div class="post__text post__text-html js-mediator-article"><h3>  Foreword </h3><br>  Often there is a need to create such a performance indicator, which would show the status of the DBMS relative to the previous period or a particular day.  The article <a href="https://habrahabr.ru/post/314494/">Implementing the performance indicator of queries, stored procedures and triggers in MS SQL Server.</a>  <a href="https://habrahabr.ru/post/314494/">An autotracing</a> example was proposed for the implementation of such an indicator.  Here we also describe another simpler method, which, besides, allows us to look historically not just for how long the request was executed, but also how it was executed, and also to get the execution plans for each time point. <br><br>  This method is especially useful when presenting daily reports to a worthwhile guide, which can not only be automated, but also output to a report with minimal technical details. <br><br>  In this article, we will consider an example of the implementation of such a general indicator, where the entire query execution time (Total Elapsed Time) will be taken as a measure. <br><a name="habracut"></a><br><h3>  Decision </h3><br>  First we give a general algorithm: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) Take a snapshot of active requests <br>  2) Save the result <br>  3) At the end of the day, we do a general analysis and save the result in a table <br>  4) We make a comparative analysis of the data obtained <br><br>  Now we give the detail: <br>  To take a snapshot of active queries, create the following tables: <br><br>  1) Table of query plans: <br><br><div class="spoiler">  <b class="spoiler_title">Query plan table</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[PlanQuery]( [PlanHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [SQLHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [QueryPlan] [<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_PlanQuery] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [SQLHandle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [PlanHandle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[PlanQuery] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_PlanQuery_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> </div></div><br>  2) Request table: <br><br><div class="spoiler">  <b class="spoiler_title">Query table</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQLQuery]( [SQLHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TSQL] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_SQLQuery] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [SQLHandle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] TEXTIMAGE_ON [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[SQLQuery] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_SQLQuery_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  3) Table of storing snapshots for active requests: <br><br><div class="spoiler">  <b class="spoiler_title">Snapshot storage table for active queries</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[RequestStatistics]( [session_id] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [request_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [start_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [command] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [sql_handle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [statement_start_offset] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [statement_end_offset] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [plan_handle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [database_id] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [user_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [connection_id] [uniqueidentifier] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [blocking_session_id] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [wait_type] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [wait_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_wait_type] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [wait_resource] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [open_transaction_count] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [open_resultset_count] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [transaction_id] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [context_info] [varbinary](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [percent_complete] [<span class="hljs-built_in"><span class="hljs-built_in">real</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [estimated_completion_time] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [cpu_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [total_elapsed_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [scheduler_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [task_address] [varbinary](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [writes] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [logical_reads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [text_size] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [date_first] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [quoted_identifier] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [arithabort] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_null_dflt_on] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_defaults] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_warnings] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_padding] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_nulls] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [concat_null_yields_null] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [transaction_isolation_level] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [lock_timeout] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [deadlock_priority] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [prev_error] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nest_level] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [granted_query_memory] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [executing_managed_code] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [query_hash] [<span class="hljs-built_in"><span class="hljs-built_in">binary</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [query_plan_hash] [<span class="hljs-built_in"><span class="hljs-built_in">binary</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [most_recent_session_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [net_transport] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [protocol_type] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [protocol_version] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [endpoint_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [encrypt_option] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [auth_scheme] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [node_affinity] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [num_reads] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [num_writes] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_read] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_write] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [net_packet_size] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_net_address] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">48</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_tcp_port] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [local_net_address] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">48</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [local_tcp_port] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [parent_connection_id] [uniqueidentifier] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [most_recent_sql_handle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [login_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [host_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [program_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [host_process_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_version] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_interface_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [security_id] [varbinary](<span class="hljs-number"><span class="hljs-number">85</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [login_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nt_domain] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nt_user_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [memory_usage] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [total_scheduled_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_request_start_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_request_end_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [is_user_process] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [original_security_id] [varbinary](<span class="hljs-number"><span class="hljs-number">85</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [original_login_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_successful_logon] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_unsuccessful_logon] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [unsuccessful_logons] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [authenticating_database_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [InsertUTCDate] [datetime] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [EndRegUTCDate] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[RequestStatistics] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_RequestStatistics_InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_PADDING <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> CLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [indRequest] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [srv].[RequestStatistics] ( [session_id] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [request_id] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [database_id] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [user_id] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [start_time] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [command] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [sql_handle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [plan_handle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [transaction_id] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [connection_id] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, DROP_EXISTING = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_PADDING <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [indPlanQuery] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [srv].[RequestStatistics] ( [plan_handle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, [sql_handle] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ([sql_handle] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> [plan_handle] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, DROP_EXISTING = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  And a table for the archive [srv]. [RequestStatisticsArchive] is created in the same way. <br><br>  4) Table for storing daily totals: <br><br><div class="spoiler">  <b class="spoiler_title">Table for storing daily totals</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[TSQL_DAY_Statistics]( [command] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [DBName] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [PlanHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [SqlHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [execution_count] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [min_wait_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [min_estimated_completion_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [min_cpu_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [min_total_elapsed_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [min_lock_timeoutSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_wait_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_estimated_completion_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_cpu_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_total_elapsed_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_lock_timeoutSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">23</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[TSQL_DAY_Statistics] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_TSQL_DAY_Statistics_DATE] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> NONCLUSTERED <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> [indDATE] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [srv].[TSQL_DAY_Statistics] ( [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, DROP_EXISTING = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br>  5) View on recorded snapshots of active requests: <br><br><div class="spoiler">  <b class="spoiler_title">View from recorded snapshots of active requests</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vRequestStatistics] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rs.[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,rs.[InsertUTCDate] ,rs.[start_time] ,rs.[command] <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [command] ,rs.[session_id] ,rs.[blocking_session_id] ,<span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(rs.[total_elapsed_time] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>))/<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [total_elapsed_timeSec] ,DB_NAME(rs.[database_id]) <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [DBName] ,rs.[is_user_process] ,rs.[login_name] <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [login_name] ,rs.[program_name] <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [program_name] ,rs.[host_name] <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [host_name] ,sq.[TSQL] <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span> Cyrillic_General_CI_AS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [TSQL]<span class="hljs-comment"><span class="hljs-comment">--,(select top(1) text from sys.dm_exec_sql_text([sql_handle])) as [TSQL] ,pq.[QueryPlan] ,rs.[plan_handle] ,rs.[user_id] ,rs.[connection_id] ,rs.[database_id] ,rs.[sql_handle] ,rs.[statement_start_offset]--          ,     .        sql_handle, statement_end_offset  sys.dm_exec_sql_text         .   NULL. ,rs.[statement_end_offset]--          ,     .        sql_handle, statement_end_offset  sys.dm_exec_sql_text         .   NULL. ,rs.[wait_type] collate Cyrillic_General_CI_AS as [wait_type]--  ,rs.[wait_time]--     ,       ( ).    NULL. ,round(cast(rs.[wait_time] as decimal(18,3))/1000, 3) as [wait_timeSec] ,rs.[last_wait_type] collate Cyrillic_General_CI_AS as [last_wait_type]--    ,      .    NULL. ,rs.[wait_resource] collate Cyrillic_General_CI_AS as [wait_resource]--     ,    ,    .    NULL. ,rs.[open_transaction_count]-- ,    .    NULL. ,rs.[open_resultset_count]--  ,    .    NULL. ,rs.[transaction_id]-- ,    .    NULL. ,rs.[context_info] ,rs.[percent_complete] ,rs.[estimated_completion_time] ,round(cast(rs.[estimated_completion_time] as decimal(18,3))/1000, 3) as [estimated_completion_timeSec] ,rs.[cpu_time]--  ( ),    .    NULL. ,round(cast(rs.[cpu_time] as decimal(18,3))/1000, 3) as [cpu_timeSec] ,rs.[total_elapsed_time]-- ,      ( ).    NULL. ,rs.[scheduler_id]-- ,    .    NULL. ,rs.[task_address]--  ,   ,    .   NULL. ,rs.[reads]--  ,   .    NULL. ,rs.[writes]--  ,   .    NULL. ,rs.[logical_reads]--   ,   .    NULL. ,rs.[text_size]--  TEXTSIZE   .    NULL. ,rs.[language] collate Cyrillic_General_CI_AS as [language]--    .   NULL. ,rs.[date_format] collate Cyrillic_General_CI_AS as [date_format]--  DATEFORMAT   .   NULL. ,rs.[date_first]--  DATEFIRST   .    NULL. ,rs.[quoted_identifier] ,rs.[arithabort] ,rs.[ansi_null_dflt_on] ,rs.[ansi_defaults] ,rs.[ansi_warnings] ,rs.[ansi_padding] ,rs.[ansi_nulls] ,rs.[concat_null_yields_null] ,rs.[transaction_isolation_level]-- ,       .    NULL (0- ,  1  5    ) ,rs.[lock_timeout]--      ( ).    NULL. ,round(cast(rs.[lock_timeout] as decimal(18,3))/1000, 3) as [lock_timeoutSec] ,rs.[deadlock_priority]--  DEADLOCK_PRIORITY   .    NULL. ,rs.[row_count]-- ,     .    NULL. ,rs.[prev_error]-- ,    .    NULL. ,rs.[nest_level]--   ,    .    NULL. ,rs.[granted_query_memory]-- ,     .    NULL. ,rs.[executing_managed_code]--,           CLR (, ,   ).       ,    CLR   ,       Transact-SQL.    NULL. ,rs.[group_id]--   ,    .    NULL. ,rs.[query_hash]-- -           .           ,      . ,rs.[query_plan_hash]-- -             .              . ,rs.[last_request_start_time] ,rs.[last_request_end_time] ,rs.[total_scheduled_time] ,rs.[memory_usage] ,rs.[nt_user_name] collate Cyrillic_General_CI_AS as [nt_user_name] ,rs.[nt_domain] collate Cyrillic_General_CI_AS as [nt_domain] ,rs.[security_id] ,rs.[client_interface_name] collate Cyrillic_General_CI_AS as [client_interface_name] ,rs.[client_version] ,rs.[host_process_id] ,rs.[login_time] ,rs.[most_recent_sql_handle] ,rs.[parent_connection_id] ,rs.[local_tcp_port] ,rs.[local_net_address] collate Cyrillic_General_CI_AS as [local_net_address] ,rs.[client_tcp_port] ,rs.[client_net_address] collate Cyrillic_General_CI_AS as [client_net_address] ,rs.[EndRegUTCDate] FROM [srv].[RequestStatistics] as rs with(readuncommitted) inner join [srv].[PlanQuery] as pq on rs.[plan_handle]=pq.[PlanHandle] and rs.[sql_handle]=pq.[SqlHandle] inner join [srv].[SQLQuery] as sq on sq.[SqlHandle]=pq.[SqlHandle] union all SELECT rs.[status] collate Cyrillic_General_CI_AS ,rs.[InsertUTCDate] ,rs.[start_time] ,rs.[command] collate Cyrillic_General_CI_AS ,rs.[session_id] ,rs.[blocking_session_id] ,round(cast(rs.[total_elapsed_time] as decimal(18,3))/1000, 3) as [total_elapsed_timeSec] ,DB_NAME(rs.[database_id]) collate Cyrillic_General_CI_AS as [DBName] ,rs.[is_user_process] ,rs.[login_name] collate Cyrillic_General_CI_AS ,rs.[program_name] collate Cyrillic_General_CI_AS ,rs.[host_name] collate Cyrillic_General_CI_AS ,sq.[TSQL] collate Cyrillic_General_CI_AS--,(select top(1) text from sys.dm_exec_sql_text([sql_handle])) as [TSQL] ,pq.[QueryPlan] ,rs.[plan_handle] ,rs.[user_id] ,rs.[connection_id] ,rs.[database_id] ,rs.[sql_handle] ,rs.[statement_start_offset]--          ,     .        sql_handle, statement_end_offset  sys.dm_exec_sql_text         .   NULL. ,rs.[statement_end_offset]--          ,     .        sql_handle, statement_end_offset  sys.dm_exec_sql_text         .   NULL. ,rs.[wait_type] collate Cyrillic_General_CI_AS--  ,rs.[wait_time]--     ,       ( ).    NULL. ,round(cast(rs.[wait_time] as decimal(18,3))/1000, 3) as [wait_timeSec] ,rs.[last_wait_type] collate Cyrillic_General_CI_AS--    ,      .    NULL. ,rs.[wait_resource] collate Cyrillic_General_CI_AS--     ,    ,    .    NULL. ,rs.[open_transaction_count]-- ,    .    NULL. ,rs.[open_resultset_count]--  ,    .    NULL. ,rs.[transaction_id]-- ,    .    NULL. ,rs.[context_info] ,rs.[percent_complete] ,rs.[estimated_completion_time] ,round(cast(rs.[estimated_completion_time] as decimal(18,3))/1000, 3) as [estimated_completion_timeSec] ,rs.[cpu_time]--  ( ),    .    NULL. ,round(cast(rs.[cpu_time] as decimal(18,3))/1000, 3) as [cpu_timeSec] ,rs.[total_elapsed_time]-- ,      ( ).    NULL. ,rs.[scheduler_id]-- ,    .    NULL. ,rs.[task_address]--  ,   ,    .   NULL. ,rs.[reads]--  ,   .    NULL. ,rs.[writes]--  ,   .    NULL. ,rs.[logical_reads]--   ,   .    NULL. ,rs.[text_size]--  TEXTSIZE   .    NULL. ,rs.[language] collate Cyrillic_General_CI_AS--    .   NULL. ,rs.[date_format] collate Cyrillic_General_CI_AS--  DATEFORMAT   .   NULL. ,rs.[date_first]--  DATEFIRST   .    NULL. ,rs.[quoted_identifier] ,rs.[arithabort] ,rs.[ansi_null_dflt_on] ,rs.[ansi_defaults] ,rs.[ansi_warnings] ,rs.[ansi_padding] ,rs.[ansi_nulls] ,rs.[concat_null_yields_null] ,rs.[transaction_isolation_level]-- ,       .    NULL (0- ,  1  5    ) ,rs.[lock_timeout]--      ( ).    NULL. ,round(cast(rs.[lock_timeout] as decimal(18,3))/1000, 3) as [lock_timeoutSec] ,rs.[deadlock_priority]--  DEADLOCK_PRIORITY   .    NULL. ,rs.[row_count]-- ,     .    NULL. ,rs.[prev_error]-- ,    .    NULL. ,rs.[nest_level]--   ,    .    NULL. ,rs.[granted_query_memory]-- ,     .    NULL. ,rs.[executing_managed_code]--,           CLR (, ,   ).       ,    CLR   ,       Transact-SQL.    NULL. ,rs.[group_id]--   ,    .    NULL. ,rs.[query_hash]-- -           .           ,      . ,rs.[query_plan_hash]-- -             .              . ,rs.[last_request_start_time] ,rs.[last_request_end_time] ,rs.[total_scheduled_time] ,rs.[memory_usage] ,rs.[nt_user_name] collate Cyrillic_General_CI_AS ,rs.[nt_domain] collate Cyrillic_General_CI_AS ,rs.[security_id] ,rs.[client_interface_name] collate Cyrillic_General_CI_AS ,rs.[client_version] ,rs.[host_process_id] ,rs.[login_time] ,rs.[most_recent_sql_handle] ,rs.[parent_connection_id] ,rs.[local_tcp_port] ,rs.[local_net_address] collate Cyrillic_General_CI_AS ,rs.[client_tcp_port] ,rs.[client_net_address] collate Cyrillic_General_CI_AS ,rs.[EndRegUTCDate] FROM [srv].[RequestStatisticsArchive] as rs with(readuncommitted) inner join [srv].[PlanQuery] as pq on rs.[plan_handle]=pq.[PlanHandle] and rs.[sql_handle]=pq.[SqlHandle] inner join [srv].[SQLQuery] as sq on sq.[SqlHandle]=pq.[SqlHandle] GO</span></span></code> </pre></div></div><br>  6) View on a sample of active requests at the current time: <br><br><div class="spoiler">  <b class="spoiler_title">View on the selection of active requests at the current time</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [inf].[vRequestDetail] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-comment"><span class="hljs-comment">/*,      ,   ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tbl0 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> ES.[session_id] ,ER.[blocking_session_id] ,ER.[request_id] ,ER.[start_time] ,ER.[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,ER.[command] ,ER.[percent_complete] ,DB_Name(<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(ER.[database_id], ES.[database_id])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [DBName] ,(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_sql_text(ER.[sql_handle])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [TSQL] ,(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1</span></span>) [query_plan] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_query_plan(ER.[plan_handle])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [QueryPlan] ,ER.[wait_type] ,ES.[login_time] ,ES.[host_name] ,ES.[program_name] ,ER.[wait_time] ,ER.[last_wait_type] ,ER.[wait_resource] ,ER.[open_transaction_count] ,ER.[open_resultset_count] ,ER.[transaction_id] ,ER.[context_info] ,ER.[estimated_completion_time] ,ER.[cpu_time] ,ER.[total_elapsed_time] ,ER.[scheduler_id] ,ER.[task_address] ,ER.[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,ER.[writes] ,ER.[logical_reads] ,ER.[text_size] ,ER.[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,ER.[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,ER.[date_first] ,ER.[quoted_identifier] ,ER.[arithabort] ,ER.[ansi_null_dflt_on] ,ER.[ansi_defaults] ,ER.[ansi_warnings] ,ER.[ansi_padding] ,ER.[ansi_nulls] ,ER.[concat_null_yields_null] ,ER.[transaction_isolation_level] ,ER.[lock_timeout] ,ER.[deadlock_priority] ,ER.[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,ER.[prev_error] ,ER.[nest_level] ,ER.[granted_query_memory] ,ER.[executing_managed_code] ,ER.[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,ER.[query_hash] ,ER.[query_plan_hash] ,EC.[most_recent_session_id] ,EC.[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,EC.[net_transport] ,EC.[protocol_type] ,EC.[protocol_version] ,EC.[endpoint_id] ,EC.[encrypt_option] ,EC.[auth_scheme] ,EC.[node_affinity] ,EC.[num_reads] ,EC.[num_writes] ,EC.[last_read] ,EC.[last_write] ,EC.[net_packet_size] ,EC.[client_net_address] ,EC.[client_tcp_port] ,EC.[local_net_address] ,EC.[local_tcp_port] ,EC.[parent_connection_id] ,EC.[most_recent_sql_handle] ,ES.[host_process_id] ,ES.[client_version] ,ES.[client_interface_name] ,ES.[security_id] ,ES.[login_name] ,ES.[nt_domain] ,ES.[nt_user_name] ,ES.[memory_usage] ,ES.[total_scheduled_time] ,ES.[last_request_start_time] ,ES.[last_request_end_time] ,ES.[is_user_process] ,ES.[original_security_id] ,ES.[original_login_name] ,ES.[last_successful_logon] ,ES.[last_unsuccessful_logon] ,ES.[unsuccessful_logons] ,ES.[authenticating_database_id] ,ER.[sql_handle] ,ER.[statement_start_offset] ,ER.[statement_end_offset] ,ER.[plan_handle] ,<span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(ER.[database_id], ES.[database_id]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [database_id] ,ER.[user_id] ,ER.[connection_id] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_requests ER <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(readuncommitted) <span class="hljs-keyword"><span class="hljs-keyword">right</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.dm_exec_sessions ES <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(readuncommitted) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ES.session_id = ER.session_id <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.dm_exec_connections EC <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(readuncommitted) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> EC.session_id = ES.session_id ) , tbl <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [session_id] ,[blocking_session_id] ,[request_id] ,[start_time] ,[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,[command] ,[percent_complete] ,[DBName] ,[TSQL] ,[QueryPlan] ,[wait_type] ,[login_time] ,[host_name] ,[program_name] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,[writes] ,[logical_reads] ,[text_size] ,[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] ,[sql_handle] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[database_id] ,[user_id] ,[connection_id] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl0 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'suspended'</span></span>, <span class="hljs-string"><span class="hljs-string">'running'</span></span>, <span class="hljs-string"><span class="hljs-string">'runnable'</span></span>) ) , tbl_group <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [blocking_session_id] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [blocking_session_id]&lt;&gt;<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [blocking_session_id] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [session_id] ,[blocking_session_id] ,[request_id] ,[start_time] ,[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,[command] ,[percent_complete] ,[DBName] ,[TSQL] ,[QueryPlan] ,[wait_type] ,[login_time] ,[host_name] ,[program_name] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,[writes] ,[logical_reads] ,[text_size] ,[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] ,[sql_handle] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[database_id] ,[user_id] ,[connection_id] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> tbl0.[session_id] ,tbl0.[blocking_session_id] ,tbl0.[request_id] ,tbl0.[start_time] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,tbl0.[command] ,tbl0.[percent_complete] ,tbl0.[DBName] ,tbl0.[TSQL] ,tbl0.[QueryPlan] ,tbl0.[wait_type] ,tbl0.[login_time] ,tbl0.[host_name] ,tbl0.[program_name] ,tbl0.[wait_time] ,tbl0.[last_wait_type] ,tbl0.[wait_resource] ,tbl0.[open_transaction_count] ,tbl0.[open_resultset_count] ,tbl0.[transaction_id] ,tbl0.[context_info] ,tbl0.[estimated_completion_time] ,tbl0.[cpu_time] ,tbl0.[total_elapsed_time] ,tbl0.[scheduler_id] ,tbl0.[task_address] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,tbl0.[writes] ,tbl0.[logical_reads] ,tbl0.[text_size] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,tbl0.[date_first] ,tbl0.[quoted_identifier] ,tbl0.[arithabort] ,tbl0.[ansi_null_dflt_on] ,tbl0.[ansi_defaults] ,tbl0.[ansi_warnings] ,tbl0.[ansi_padding] ,tbl0.[ansi_nulls] ,tbl0.[concat_null_yields_null] ,tbl0.[transaction_isolation_level] ,tbl0.[lock_timeout] ,tbl0.[deadlock_priority] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,tbl0.[prev_error] ,tbl0.[nest_level] ,tbl0.[granted_query_memory] ,tbl0.[executing_managed_code] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,tbl0.[query_hash] ,tbl0.[query_plan_hash] ,tbl0.[most_recent_session_id] ,tbl0.[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,tbl0.[net_transport] ,tbl0.[protocol_type] ,tbl0.[protocol_version] ,tbl0.[endpoint_id] ,tbl0.[encrypt_option] ,tbl0.[auth_scheme] ,tbl0.[node_affinity] ,tbl0.[num_reads] ,tbl0.[num_writes] ,tbl0.[last_read] ,tbl0.[last_write] ,tbl0.[net_packet_size] ,tbl0.[client_net_address] ,tbl0.[client_tcp_port] ,tbl0.[local_net_address] ,tbl0.[local_tcp_port] ,tbl0.[parent_connection_id] ,tbl0.[most_recent_sql_handle] ,tbl0.[host_process_id] ,tbl0.[client_version] ,tbl0.[client_interface_name] ,tbl0.[security_id] ,tbl0.[login_name] ,tbl0.[nt_domain] ,tbl0.[nt_user_name] ,tbl0.[memory_usage] ,tbl0.[total_scheduled_time] ,tbl0.[last_request_start_time] ,tbl0.[last_request_end_time] ,tbl0.[is_user_process] ,tbl0.[original_security_id] ,tbl0.[original_login_name] ,tbl0.[last_successful_logon] ,tbl0.[last_unsuccessful_logon] ,tbl0.[unsuccessful_logons] ,tbl0.[authenticating_database_id] ,tbl0.[sql_handle] ,tbl0.[statement_start_offset] ,tbl0.[statement_end_offset] ,tbl0.[plan_handle] ,tbl0.[database_id] ,tbl0.[user_id] ,tbl0.[connection_id] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl_group <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tg <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> tbl0 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tg.blocking_session_id=tbl0.session_id; GO</code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To take a snapshot of the active queries and then save it to the above tables, create a stored procedure: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">An example implementation of a stored procedure to collect snapshots of active requests</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[AutoStatisticsActiveRequests] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> UNCOMMITTED; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tbl0 <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( [SQLHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TSQL] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tbl1 <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( [PlanHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [SQLHandle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [QueryPlan] [<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @tbl2 <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ( [session_id] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [request_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [start_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [command] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [sql_handle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [statement_start_offset] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [statement_end_offset] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [plan_handle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [database_id] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [user_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [connection_id] [uniqueidentifier] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [blocking_session_id] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [wait_type] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [wait_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_wait_type] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">60</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [wait_resource] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [open_transaction_count] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [open_resultset_count] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [transaction_id] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [context_info] [varbinary](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [percent_complete] [<span class="hljs-built_in"><span class="hljs-built_in">real</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [estimated_completion_time] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [cpu_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [total_elapsed_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [scheduler_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [task_address] [varbinary](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [writes] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [logical_reads] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [text_size] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [date_first] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [quoted_identifier] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [arithabort] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_null_dflt_on] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_defaults] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_warnings] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_padding] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [ansi_nulls] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [concat_null_yields_null] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [transaction_isolation_level] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [lock_timeout] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [deadlock_priority] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [prev_error] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nest_level] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [granted_query_memory] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [executing_managed_code] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [query_hash] [<span class="hljs-built_in"><span class="hljs-built_in">binary</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [query_plan_hash] [<span class="hljs-built_in"><span class="hljs-built_in">binary</span></span>](<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [most_recent_session_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [net_transport] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [protocol_type] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [protocol_version] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [endpoint_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [encrypt_option] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [auth_scheme] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">40</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [node_affinity] [<span class="hljs-built_in"><span class="hljs-built_in">smallint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [num_reads] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [num_writes] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_read] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_write] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [net_packet_size] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_net_address] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">48</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_tcp_port] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [local_net_address] [<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>](<span class="hljs-number"><span class="hljs-number">48</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [local_tcp_port] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [parent_connection_id] [uniqueidentifier] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [most_recent_sql_handle] [varbinary](<span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [login_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [host_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [program_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [host_process_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_version] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [client_interface_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [security_id] [varbinary](<span class="hljs-number"><span class="hljs-number">85</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [login_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nt_domain] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [nt_user_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [memory_usage] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [total_scheduled_time] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_request_start_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_request_end_time] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [is_user_process] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [original_security_id] [varbinary](<span class="hljs-number"><span class="hljs-number">85</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [original_login_name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_successful_logon] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [last_unsuccessful_logon] [datetime] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [unsuccessful_logons] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [authenticating_database_id] [<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [TSQL] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [QueryPlan] [<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @tbl2 ( [session_id] ,[request_id] ,[start_time] ,[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,[command] ,[sql_handle] ,[TSQL] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[QueryPlan] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,[writes] ,[logical_reads] ,[text_size] ,[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [session_id] ,[request_id] ,[start_time] ,[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,[command] ,[sql_handle] ,[TSQL] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[QueryPlan] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,[writes] ,[logical_reads] ,[text_size] ,[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [inf].[vRequestDetail]; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @tbl1 ( [PlanHandle], [SQLHandle], [QueryPlan] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [plan_handle], [sql_handle], (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1</span></span>) [query_plan] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_query_plan([plan_handle])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [QueryPlan] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> @tbl2 <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1</span></span>) [query_plan] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_query_plan([plan_handle])) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [plan_handle], [sql_handle]; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @tbl0 ( [SQLHandle], [TSQL] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [sql_handle], (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> top(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.dm_exec_sql_text([sql_handle])) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [TSQL]<span class="hljs-comment"><span class="hljs-comment">--[query_text] from @tbl2 where (select top(1) text from sys.dm_exec_sql_text([sql_handle])) is not null group by [sql_handle]; ;merge [srv].[SQLQuery] as trg using @tbl0 as src on trg.[SQLHandle]=src.[SQLHandle] WHEN NOT MATCHED BY TARGET THEN INSERT ( [SQLHandle], [TSQL] ) VALUES ( src.[SQLHandle], src.[TSQL] ); ;merge [srv].[PlanQuery] as trg using @tbl1 as src on trg.[SQLHandle]=src.[SQLHandle] and trg.[PlanHandle]=src.[PlanHandle] WHEN NOT MATCHED BY TARGET THEN INSERT ( [PlanHandle], [SQLHandle], [QueryPlan] ) VALUES ( src.[PlanHandle], src.[SQLHandle], src.[QueryPlan] ); select [session_id] ,[request_id] ,[start_time] ,[status] ,[command] ,[sql_handle] ,(select top(1) 1 from @tbl0 as t where t.[SQLHandle]=tt.[sql_handle]) as [TSQL] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,(select top(1) 1 from @tbl1 as t where t.[PlanHandle]=tt.[plan_handle]) as [QueryPlan] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[reads] ,[writes] ,[logical_reads] ,[text_size] ,[language] ,[date_format] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[row_count] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[group_id] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[connect_time] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] into #ttt from @tbl2 as tt group by [session_id] ,[request_id] ,[start_time] ,[status] ,[command] ,[sql_handle] ,[TSQL] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[reads] ,[writes] ,[logical_reads] ,[text_size] ,[language] ,[date_format] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[row_count] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[group_id] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[connect_time] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id]; UPDATE trg SET trg.[status] =case when (trg.[status]&lt;&gt;'suspended') then coalesce(src.[status] collate DATABASE_DEFAULT, trg.[status] collate DATABASE_DEFAULT) else trg.[status] end --,trg.[command] =coalesce(src.[command] collate DATABASE_DEFAULT, trg.[command] collate DATABASE_DEFAULT) --,trg.[sql_handle] =coalesce(src.[sql_handle] , trg.[sql_handle] ) --,trg.[TSQL] =coalesce(src.[TSQL] collate DATABASE_DEFAULT, trg.[TSQL] collate DATABASE_DEFAULT) ,trg.[statement_start_offset] =coalesce(src.[statement_start_offset] , trg.[statement_start_offset] ) ,trg.[statement_end_offset] =coalesce(src.[statement_end_offset] , trg.[statement_end_offset] ) --,trg.[plan_handle] =coalesce(src.[plan_handle] , trg.[plan_handle] ) --,trg.[QueryPlan] =coalesce(src.[QueryPlan] , trg.[QueryPlan] ) --,trg.[connection_id] =coalesce(src.[connection_id] , trg.[connection_id] ) ,trg.[blocking_session_id] =coalesce(trg.[blocking_session_id] , src.[blocking_session_id] ) ,trg.[wait_type] =coalesce(trg.[wait_type] collate DATABASE_DEFAULT, src.[wait_type] collate DATABASE_DEFAULT) ,trg.[wait_time] =coalesce(src.[wait_time] , trg.[wait_time] ) ,trg.[last_wait_type] =coalesce(src.[last_wait_type] collate DATABASE_DEFAULT, trg.[last_wait_type] collate DATABASE_DEFAULT) ,trg.[wait_resource] =coalesce(src.[wait_resource] collate DATABASE_DEFAULT, trg.[wait_resource] collate DATABASE_DEFAULT) ,trg.[open_transaction_count] =coalesce(src.[open_transaction_count] , trg.[open_transaction_count] ) ,trg.[open_resultset_count] =coalesce(src.[open_resultset_count] , trg.[open_resultset_count] ) --,trg.[transaction_id] =coalesce(src.[transaction_id] , trg.[transaction_id] ) ,trg.[context_info] =coalesce(src.[context_info] , trg.[context_info] ) ,trg.[percent_complete] =coalesce(src.[percent_complete] , trg.[percent_complete] ) ,trg.[estimated_completion_time] =coalesce(src.[estimated_completion_time] , trg.[estimated_completion_time] ) ,trg.[cpu_time] =coalesce(src.[cpu_time] , trg.[cpu_time] ) ,trg.[total_elapsed_time] =coalesce(src.[total_elapsed_time] , trg.[total_elapsed_time] ) ,trg.[scheduler_id] =coalesce(src.[scheduler_id] , trg.[scheduler_id] ) ,trg.[task_address] =coalesce(src.[task_address] , trg.[task_address] ) ,trg.[reads] =coalesce(src.[reads] , trg.[reads] ) ,trg.[writes] =coalesce(src.[writes] , trg.[writes] ) ,trg.[logical_reads] =coalesce(src.[logical_reads] , trg.[logical_reads] ) ,trg.[text_size] =coalesce(src.[text_size] , trg.[text_size] ) ,trg.[language] =coalesce(src.[language] collate DATABASE_DEFAULT, trg.[language] collate DATABASE_DEFAULT) ,trg.[date_format] =coalesce(src.[date_format] , trg.[date_format] ) ,trg.[date_first] =coalesce(src.[date_first] , trg.[date_first] ) ,trg.[quoted_identifier] =coalesce(src.[quoted_identifier] , trg.[quoted_identifier] ) ,trg.[arithabort] =coalesce(src.[arithabort] , trg.[arithabort] ) ,trg.[ansi_null_dflt_on] =coalesce(src.[ansi_null_dflt_on] , trg.[ansi_null_dflt_on] ) ,trg.[ansi_defaults] =coalesce(src.[ansi_defaults] , trg.[ansi_defaults] ) ,trg.[ansi_warnings] =coalesce(src.[ansi_warnings] , trg.[ansi_warnings] ) ,trg.[ansi_padding] =coalesce(src.[ansi_padding] , trg.[ansi_padding] ) ,trg.[ansi_nulls] =coalesce(src.[ansi_nulls] , trg.[ansi_nulls] ) ,trg.[concat_null_yields_null] =coalesce(src.[concat_null_yields_null] , trg.[concat_null_yields_null] ) ,trg.[transaction_isolation_level] =coalesce(src.[transaction_isolation_level] , trg.[transaction_isolation_level] ) ,trg.[lock_timeout] =coalesce(src.[lock_timeout] , trg.[lock_timeout] ) ,trg.[deadlock_priority] =coalesce(src.[deadlock_priority] , trg.[deadlock_priority] ) ,trg.[row_count] =coalesce(src.[row_count] , trg.[row_count] ) ,trg.[prev_error] =coalesce(src.[prev_error] , trg.[prev_error] ) ,trg.[nest_level] =coalesce(src.[nest_level] , trg.[nest_level] ) ,trg.[granted_query_memory] =coalesce(src.[granted_query_memory] , trg.[granted_query_memory] ) ,trg.[executing_managed_code] =coalesce(src.[executing_managed_code] , trg.[executing_managed_code] ) ,trg.[group_id] =coalesce(src.[group_id] , trg.[group_id] ) ,trg.[query_hash] =coalesce(src.[query_hash] , trg.[query_hash] ) ,trg.[query_plan_hash] =coalesce(src.[query_plan_hash] , trg.[query_plan_hash] ) ,trg.[most_recent_session_id] =coalesce(src.[most_recent_session_id] , trg.[most_recent_session_id] ) ,trg.[connect_time] =coalesce(src.[connect_time] , trg.[connect_time] ) ,trg.[net_transport] =coalesce(src.[net_transport] collate DATABASE_DEFAULT, trg.[net_transport] collate DATABASE_DEFAULT) ,trg.[protocol_type] =coalesce(src.[protocol_type] collate DATABASE_DEFAULT, trg.[protocol_type] collate DATABASE_DEFAULT) ,trg.[protocol_version] =coalesce(src.[protocol_version] , trg.[protocol_version] ) ,trg.[endpoint_id] =coalesce(src.[endpoint_id] , trg.[endpoint_id] ) ,trg.[encrypt_option] =coalesce(src.[encrypt_option] collate DATABASE_DEFAULT, trg.[encrypt_option] collate DATABASE_DEFAULT) ,trg.[auth_scheme] =coalesce(src.[auth_scheme] collate DATABASE_DEFAULT, trg.[auth_scheme] collate DATABASE_DEFAULT) ,trg.[node_affinity] =coalesce(src.[node_affinity] , trg.[node_affinity] ) ,trg.[num_reads] =coalesce(src.[num_reads] , trg.[num_reads] ) ,trg.[num_writes] =coalesce(src.[num_writes] , trg.[num_writes] ) ,trg.[last_read] =coalesce(src.[last_read] , trg.[last_read] ) ,trg.[last_write] =coalesce(src.[last_write] , trg.[last_write] ) ,trg.[net_packet_size] =coalesce(src.[net_packet_size] , trg.[net_packet_size] ) ,trg.[client_net_address] =coalesce(src.[client_net_address] collate DATABASE_DEFAULT, trg.[client_net_address] collate DATABASE_DEFAULT) ,trg.[client_tcp_port] =coalesce(src.[client_tcp_port] , trg.[client_tcp_port] ) ,trg.[local_net_address] =coalesce(src.[local_net_address] collate DATABASE_DEFAULT, trg.[local_net_address] collate DATABASE_DEFAULT) ,trg.[local_tcp_port] =coalesce(src.[local_tcp_port] , trg.[local_tcp_port] ) ,trg.[parent_connection_id] =coalesce(src.[parent_connection_id] , trg.[parent_connection_id] ) ,trg.[most_recent_sql_handle] =coalesce(src.[most_recent_sql_handle] , trg.[most_recent_sql_handle] ) ,trg.[login_time] =coalesce(src.[login_time] , trg.[login_time] ) ,trg.[host_name] =coalesce(src.[host_name] collate DATABASE_DEFAULT, trg.[host_name] collate DATABASE_DEFAULT) ,trg.[program_name] =coalesce(src.[program_name] collate DATABASE_DEFAULT, trg.[program_name] collate DATABASE_DEFAULT) ,trg.[host_process_id] =coalesce(src.[host_process_id] , trg.[host_process_id] ) ,trg.[client_version] =coalesce(src.[client_version] , trg.[client_version] ) ,trg.[client_interface_name] =coalesce(src.[client_interface_name] collate DATABASE_DEFAULT, trg.[client_interface_name] collate DATABASE_DEFAULT) ,trg.[security_id] =coalesce(src.[security_id] , trg.[security_id] ) ,trg.[login_name] =coalesce(src.[login_name] collate DATABASE_DEFAULT, trg.[login_name] collate DATABASE_DEFAULT) ,trg.[nt_domain] =coalesce(src.[nt_domain] collate DATABASE_DEFAULT, trg.[nt_domain] collate DATABASE_DEFAULT) ,trg.[nt_user_name] =coalesce(src.[nt_user_name] collate DATABASE_DEFAULT, trg.[nt_user_name] collate DATABASE_DEFAULT) ,trg.[memory_usage] =coalesce(src.[memory_usage] , trg.[memory_usage] ) ,trg.[total_scheduled_time] =coalesce(src.[total_scheduled_time] , trg.[total_scheduled_time] ) ,trg.[last_request_start_time] =coalesce(src.[last_request_start_time] , trg.[last_request_start_time] ) ,trg.[last_request_end_time] =coalesce(src.[last_request_end_time] , trg.[last_request_end_time] ) ,trg.[is_user_process] =coalesce(src.[is_user_process] , trg.[is_user_process] ) ,trg.[original_security_id] =coalesce(src.[original_security_id] , trg.[original_security_id] ) ,trg.[original_login_name] =coalesce(src.[original_login_name] collate DATABASE_DEFAULT, trg.[original_login_name] collate DATABASE_DEFAULT) ,trg.[last_successful_logon] =coalesce(src.[last_successful_logon] , trg.[last_successful_logon] ) ,trg.[last_unsuccessful_logon] =coalesce(src.[last_unsuccessful_logon] , trg.[last_unsuccessful_logon] ) ,trg.[unsuccessful_logons] =coalesce(src.[unsuccessful_logons] , trg.[unsuccessful_logons] ) ,trg.[authenticating_database_id] =coalesce(src.[authenticating_database_id] , trg.[authenticating_database_id] ) from [srv].[RequestStatistics] as trg inner join #ttt as src on (trg.[session_id]=src.[session_id]) and (trg.[request_id]=src.[request_id]) and (trg.[database_id]=src.[database_id]) and (trg.[user_id]=src.[user_id]) and (trg.[start_time]=src.[start_time]) and (trg.[command] collate DATABASE_DEFAULT=src.[command] collate DATABASE_DEFAULT) and ((trg.[sql_handle]=src.[sql_handle] and src.[sql_handle] IS NOT NULL) or (src.[sql_handle] IS NULL)) and ((trg.[plan_handle]=src.[plan_handle] and src.[plan_handle] IS NOT NULL) or (src.[plan_handle] IS NULL)) and (trg.[transaction_id]=src.[transaction_id]) and ((trg.[connection_id]=src.[connection_id] and src.[connection_id] IS NOT NULL) or (src.[connection_id] IS NULL)); UPDATE trg SET trg.[EndRegUTCDate]=GetUTCDate() from [srv].[RequestStatistics] as trg where not exists( select top(1) 1 from #ttt as src where (trg.[session_id]=src.[session_id]) and (trg.[request_id]=src.[request_id]) and (trg.[database_id]=src.[database_id]) and (trg.[user_id]=src.[user_id]) and (trg.[start_time]=src.[start_time]) and (trg.[command] collate DATABASE_DEFAULT=src.[command] collate DATABASE_DEFAULT) and ((trg.[sql_handle]=src.[sql_handle] and src.[sql_handle] IS NOT NULL) or (src.[sql_handle] IS NULL)) and ((trg.[plan_handle]=src.[plan_handle] and src.[plan_handle] IS NOT NULL) or (src.[plan_handle] IS NULL)) and (trg.[transaction_id]=src.[transaction_id]) and ((trg.[connection_id]=src.[connection_id] and src.[connection_id] IS NOT NULL) or (src.[connection_id] IS NULL)) ); INSERT into [srv].[RequestStatistics] ([session_id] ,[request_id] ,[start_time] ,[status] ,[command] ,[sql_handle] --,[TSQL] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] --,[QueryPlan] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[reads] ,[writes] ,[logical_reads] ,[text_size] ,[language] ,[date_format] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[row_count] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[group_id] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[connect_time] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id]) select src.[session_id] ,src.[request_id] ,src.[start_time] ,src.[status] ,src.[command] ,src.[sql_handle] --,src.[TSQL] ,src.[statement_start_offset] ,src.[statement_end_offset] ,src.[plan_handle] --,src.[QueryPlan] ,src.[database_id] ,src.[user_id] ,src.[connection_id] ,src.[blocking_session_id] ,src.[wait_type] ,src.[wait_time] ,src.[last_wait_type] ,src.[wait_resource] ,src.[open_transaction_count] ,src.[open_resultset_count] ,src.[transaction_id] ,src.[context_info] ,src.[percent_complete] ,src.[estimated_completion_time] ,src.[cpu_time] ,src.[total_elapsed_time] ,src.[scheduler_id] ,src.[task_address] ,src.[reads] ,src.[writes] ,src.[logical_reads] ,src.[text_size] ,src.[language] ,src.[date_format] ,src.[date_first] ,src.[quoted_identifier] ,src.[arithabort] ,src.[ansi_null_dflt_on] ,src.[ansi_defaults] ,src.[ansi_warnings] ,src.[ansi_padding] ,src.[ansi_nulls] ,src.[concat_null_yields_null] ,src.[transaction_isolation_level] ,src.[lock_timeout] ,src.[deadlock_priority] ,src.[row_count] ,src.[prev_error] ,src.[nest_level] ,src.[granted_query_memory] ,src.[executing_managed_code] ,src.[group_id] ,src.[query_hash] ,src.[query_plan_hash] ,src.[most_recent_session_id] ,src.[connect_time] ,src.[net_transport] ,src.[protocol_type] ,src.[protocol_version] ,src.[endpoint_id] ,src.[encrypt_option] ,src.[auth_scheme] ,src.[node_affinity] ,src.[num_reads] ,src.[num_writes] ,src.[last_read] ,src.[last_write] ,src.[net_packet_size] ,src.[client_net_address] ,src.[client_tcp_port] ,src.[local_net_address] ,src.[local_tcp_port] ,src.[parent_connection_id] ,src.[most_recent_sql_handle] ,src.[login_time] ,src.[host_name] ,src.[program_name] ,src.[host_process_id] ,src.[client_version] ,src.[client_interface_name] ,src.[security_id] ,src.[login_name] ,src.[nt_domain] ,src.[nt_user_name] ,src.[memory_usage] ,src.[total_scheduled_time] ,src.[last_request_start_time] ,src.[last_request_end_time] ,src.[is_user_process] ,src.[original_security_id] ,src.[original_login_name] ,src.[last_successful_logon] ,src.[last_unsuccessful_logon] ,src.[unsuccessful_logons] ,src.[authenticating_database_id] from #ttt as src where not exists( select top(1) 1 from [srv].[RequestStatistics] as trg where (trg.[session_id]=src.[session_id]) and (trg.[request_id]=src.[request_id]) and (trg.[database_id]=src.[database_id]) and (trg.[user_id]=src.[user_id]) and (trg.[start_time]=src.[start_time]) and (trg.[command] collate DATABASE_DEFAULT=src.[command] collate DATABASE_DEFAULT) and ((trg.[sql_handle]=src.[sql_handle] and src.[sql_handle] IS NOT NULL) or (src.[sql_handle] IS NULL)) and ((trg.[plan_handle]=src.[plan_handle] and src.[plan_handle] IS NOT NULL) or (src.[plan_handle] IS NULL)) and (trg.[transaction_id]=src.[transaction_id]) and ((trg.[connection_id]=src.[connection_id] and src.[connection_id] IS NOT NULL) or (src.[connection_id] IS NULL)) ); drop table #ttt; END GO</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The collection process can be automated. </font><font style="vertical-align: inherit;">For example, if a call to this stored procedure is placed on an Agent with a schedule (for example, every 10 seconds) or by an event (for example, [Databases]. [Active Transactions]. [_ Total]&gt; 0). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the end of the day, we do a general analysis and save the result to a table via a stored procedure call.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Table implementation</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [srv].[IndicatorStatistics]( [execution_count] [<span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_total_elapsed_timeSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [max_total_elapsed_timeLastSec] [<span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>](<span class="hljs-number"><span class="hljs-number">38</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_IndicatorStatistics] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ( [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementing a stored procedure</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [srv].[AutoStatisticsTimeRequests] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> UNCOMMITTED; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [srv].[TSQL_DAY_Statistics] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>]&lt;=<span class="hljs-keyword"><span class="hljs-keyword">DateAdd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,<span class="hljs-number"><span class="hljs-number">-180</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">GetUTCDate</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [srv].[TSQL_DAY_Statistics] ([command] ,[DBName] ,[PlanHandle] ,[SqlHandle] ,[execution_count] ,[min_wait_timeSec] ,[min_estimated_completion_timeSec] ,[min_cpu_timeSec] ,[min_total_elapsed_timeSec] ,[min_lock_timeoutSec] ,[max_wait_timeSec] ,[max_estimated_completion_timeSec] ,[max_cpu_timeSec] ,[max_total_elapsed_timeSec] ,[max_lock_timeoutSec] ,[<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [command] ,[DBName] ,[plan_handle] ,[sql_handle] ,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [execution_count] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([wait_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_wait_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([estimated_completion_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_estimated_completion_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([cpu_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_cpu_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([lock_timeoutSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_lock_timeoutSec] ,<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([wait_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_wait_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([estimated_completion_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_estimated_completion_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([cpu_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_cpu_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([lock_timeoutSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_lock_timeoutSec] ,<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>([InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [srv].[vRequestStatistics] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span>(readuncommitted) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>([InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">DateAdd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">GetUTCDate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> [command] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-string"><span class="hljs-string">'UPDATE'</span></span>, <span class="hljs-string"><span class="hljs-string">'TRUNCATE TABLE'</span></span>, <span class="hljs-string"><span class="hljs-string">'SET OPTION ON'</span></span>, <span class="hljs-string"><span class="hljs-string">'SET COMMAND'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT INTO'</span></span>, <span class="hljs-string"><span class="hljs-string">'SELECT'</span></span>, <span class="hljs-string"><span class="hljs-string">'NOP'</span></span>, <span class="hljs-string"><span class="hljs-string">'INSERT'</span></span>, <span class="hljs-string"><span class="hljs-string">'EXECUTE'</span></span>, <span class="hljs-string"><span class="hljs-string">'DELETE'</span></span>, <span class="hljs-string"><span class="hljs-string">'DECLARE'</span></span>, <span class="hljs-string"><span class="hljs-string">'CONDITIONAL'</span></span>, <span class="hljs-string"><span class="hljs-string">'BULK INSERT'</span></span>, <span class="hljs-string"><span class="hljs-string">'BEGIN TRY'</span></span>, <span class="hljs-string"><span class="hljs-string">'BEGIN CATCH'</span></span>, <span class="hljs-string"><span class="hljs-string">'AWAITING COMMAND'</span></span>, <span class="hljs-string"><span class="hljs-string">'ASSIGN'</span></span>, <span class="hljs-string"><span class="hljs-string">'ALTER TABLE'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> [database_id] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-comment"><span class="hljs-comment">/*    DB_ID('_')*/</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> [DBName] <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [command] ,[DBName] ,[plan_handle] ,[sql_handle] ,<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>([InsertUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @inddt <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>; ;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tbl11 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [SqlHandle], <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_max_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>([max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [avg_max_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>([execution_count]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [execution_count] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [srv].[TSQL_DAY_Statistics] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [max_total_elapsed_timeSec]&gt;=<span class="hljs-number"><span class="hljs-number">0.001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>]&lt;<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DateAdd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,-@inddt,<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">GetUTCDate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [SqlHandle] ) , tbl12 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [SqlHandle], <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>([max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">min</span></span>([max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [min_max_total_elapsed_timeSec] ,<span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>([max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [avg_max_total_elapsed_timeSec] ,[<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [srv].[TSQL_DAY_Statistics] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [max_total_elapsed_timeSec]&gt;=<span class="hljs-number"><span class="hljs-number">0.001</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>]=<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DateAdd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,-@inddt,<span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">GetUTCDate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [SqlHandle], [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] ) , tbl1_sum <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>([execution_count]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [sum_execution_count] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl11) , tbl1_total <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [sum_execution_count] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl1_sum) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [execution_count] , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(tbl11.[max_total_elapsed_timeSec]*tbl11.[execution_count])/(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [sum_execution_count] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl1_sum) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_total_elapsed_timeSec] , <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(tbl12.[max_total_elapsed_timeSec]*tbl11.[execution_count])/(<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> [sum_execution_count] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl1_sum) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [max_total_elapsed_timeLastSec] , tbl12.[<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl11 <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> tbl12 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tbl11.[SqlHandle]=tbl12.[SqlHandle] <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> tbl12.[<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [srv].[IndicatorStatistics] ([<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] ,[execution_count] ,[max_total_elapsed_timeSec] ,[max_total_elapsed_timeLastSec] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t1.[<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] ,t1.[execution_count] ,t1.[max_total_elapsed_timeSec] ,t1.[max_total_elapsed_timeLastSec] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl1_total <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t1; <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @dt datetime=<span class="hljs-keyword"><span class="hljs-keyword">DateAdd</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">day</span></span>,<span class="hljs-number"><span class="hljs-number">-2</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">GetUTCDate</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [srv].[RequestStatisticsArchive] ([session_id] ,[request_id] ,[start_time] ,[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,[command] ,[sql_handle] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,[writes] ,[logical_reads] ,[text_size] ,[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] ,[InsertUTCDate] ,[EndRegUTCDate]) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [session_id] ,[request_id] ,[start_time] ,[<span class="hljs-keyword"><span class="hljs-keyword">status</span></span>] ,[command] ,[sql_handle] ,[statement_start_offset] ,[statement_end_offset] ,[plan_handle] ,[database_id] ,[user_id] ,[connection_id] ,[blocking_session_id] ,[wait_type] ,[wait_time] ,[last_wait_type] ,[wait_resource] ,[open_transaction_count] ,[open_resultset_count] ,[transaction_id] ,[context_info] ,[percent_complete] ,[estimated_completion_time] ,[cpu_time] ,[total_elapsed_time] ,[scheduler_id] ,[task_address] ,[<span class="hljs-keyword"><span class="hljs-keyword">reads</span></span>] ,[writes] ,[logical_reads] ,[text_size] ,[<span class="hljs-keyword"><span class="hljs-keyword">language</span></span>] ,[<span class="hljs-keyword"><span class="hljs-keyword">date_format</span></span>] ,[date_first] ,[quoted_identifier] ,[arithabort] ,[ansi_null_dflt_on] ,[ansi_defaults] ,[ansi_warnings] ,[ansi_padding] ,[ansi_nulls] ,[concat_null_yields_null] ,[transaction_isolation_level] ,[lock_timeout] ,[deadlock_priority] ,[<span class="hljs-keyword"><span class="hljs-keyword">row_count</span></span>] ,[prev_error] ,[nest_level] ,[granted_query_memory] ,[executing_managed_code] ,[<span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>] ,[query_hash] ,[query_plan_hash] ,[most_recent_session_id] ,[<span class="hljs-keyword"><span class="hljs-keyword">connect_time</span></span>] ,[net_transport] ,[protocol_type] ,[protocol_version] ,[endpoint_id] ,[encrypt_option] ,[auth_scheme] ,[node_affinity] ,[num_reads] ,[num_writes] ,[last_read] ,[last_write] ,[net_packet_size] ,[client_net_address] ,[client_tcp_port] ,[local_net_address] ,[local_tcp_port] ,[parent_connection_id] ,[most_recent_sql_handle] ,[login_time] ,[host_name] ,[program_name] ,[host_process_id] ,[client_version] ,[client_interface_name] ,[security_id] ,[login_name] ,[nt_domain] ,[nt_user_name] ,[memory_usage] ,[total_scheduled_time] ,[last_request_start_time] ,[last_request_end_time] ,[is_user_process] ,[original_security_id] ,[original_login_name] ,[last_successful_logon] ,[last_unsuccessful_logon] ,[unsuccessful_logons] ,[authenticating_database_id] ,[InsertUTCDate] ,[EndRegUTCDate] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [srv].[RequestStatistics] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [InsertUTCDate]&lt;=@dt; <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [srv].[RequestStatistics] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [InsertUTCDate]&lt;=@dt; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As can be seen from the code, the stored procedure also cleans the [srv]. [RequestStatistics] table to prevent its growth and ensure quick insertion of snapshots of active requests. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This stored procedure can also be set in the Agent's call every day at the end of the day. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We now turn to the analysis of the collected data. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To compare the current state of the DBMS to the previous period, you can use the following view:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">View implementation</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [ ] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ANSI_NULLS <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> QUOTED_IDENTIFIER <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">view</span></span> [srv].[vIndicatorStatistics] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] ,[execution_count] ,[max_total_elapsed_timeSec] ,[max_total_elapsed_timeLastSec] ,[max_total_elapsed_timeLastSec]-[max_total_elapsed_timeSec] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [DiffSnapshot] ,([max_total_elapsed_timeLastSec]-[max_total_elapsed_timeSec])*<span class="hljs-number"><span class="hljs-number">100</span></span>/[max_total_elapsed_timeSec] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [% <span class="hljs-keyword"><span class="hljs-keyword">Snapshot</span></span>] , <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ([max_total_elapsed_timeLastSec]&lt;[max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> N<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> ([max_total_elapsed_timeLastSec]&gt;[max_total_elapsed_timeSec]) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> N<span class="hljs-string"><span class="hljs-string">''</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> N<span class="hljs-string"><span class="hljs-string">' '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'IndicatorSnapshot'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [srv].[IndicatorStatistics] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To compare the current state of the DBMS to a specific day, you can run the following query: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Request</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> tbl1 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(total_elapsed_timeSec) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(total_elapsed_timeSec) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(total_elapsed_timeSec) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>], [sql_handle], <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>], <span class="hljs-string"><span class="hljs-string">'2017-11-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [srv].[vRequestStatisticsArchive] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [start_time] <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-string"><span class="hljs-string">'2017-11-01T07:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'2017-11-01T21:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [sql_handle] ) , tbl2 <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span>(total_elapsed_timeSec) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(total_elapsed_timeSec) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">avg</span></span>(total_elapsed_timeSec) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>], [sql_handle], <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>], <span class="hljs-string"><span class="hljs-string">'2017-11-08'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> [srv].[vRequestStatistics] <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> [start_time] <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-string"><span class="hljs-string">'2017-11-08T07:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">'2017-11-08T21:00:00'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> [sql_handle] ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl1.[sql_handle], tbl2.[sql_handle]) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [sql_handle], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl1.[<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span> <span class="hljs-number"><span class="hljs-number">01.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl2.[<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span> <span class="hljs-number"><span class="hljs-number">08.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl1.[<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span> <span class="hljs-number"><span class="hljs-number">01.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl2.[<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span> <span class="hljs-number"><span class="hljs-number">08.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl1.[<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span> <span class="hljs-number"><span class="hljs-number">01.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl2.[<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span> <span class="hljs-number"><span class="hljs-number">08.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl1.[<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span> <span class="hljs-number"><span class="hljs-number">01.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>], <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(tbl2.[<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Count</span></span> <span class="hljs-number"><span class="hljs-number">08.11</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tbl1 <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">outer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> tbl2 <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tbl1.[sql_handle]=tbl2.[sql_handle]; GO</code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It compares work from 07-00 to 21-00 1 and November 8, 2017 (for example, this is the working time of the enterprise, to exclude the analysis of the work of the routine tasks). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This download can be arranged as a detailed report and attached to the general report obtained from the [srv]. [VIndicatorStatistics] view. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To understand how the query was executed and what happened at any given time, it suffices to refer to the [srv] view. [vRequestStatistics] with filter by [start_time] (date and time of the request launch).</font></font><br><br><h3>  Result </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This article has reviewed an example of the implementation of a general performance indicator of MS SQL Server, which allows determining the status of the DBMS relative to the previous period or a specific day. As a measure, the entire query execution time (Total Elapsed Time) was taken. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This method is universal. T it needs to be adjusted, proceeding from requirements, and also to define a measure (t e that we will collect and compare). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, this approach allows you to detect a problem immediately or for a certain range of past time. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On the received data, you can implement a robot that would make decisions on which queries to improve or disable, in order to prevent the fall of the entire system, and then notify administrators.</font></font><br><br><h3>  Sources: </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬ª </font></font><a href="https://habrahabr.ru/post/314494/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementing a performance indicator for queries, stored procedures and triggers in MS SQL Server</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href="https://msdn.microsoft.com/ru-ru"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MSDN</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/342794/">https://habr.com/ru/post/342794/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../342782/index.html">SensioLabs closed multiple vulnerabilities in all supported symfony versions</a></li>
<li><a href="../342786/index.html">Hedgehogs on wheels: how do we maintain the quality of communication in Moscow</a></li>
<li><a href="../342788/index.html">6 lines of deep learning</a></li>
<li><a href="../342790/index.html">Spring WebSocket. How it works?</a></li>
<li><a href="../342792/index.html">United company Yandex.Taxi and Uber plans to hold an IPO in 2019</a></li>
<li><a href="../342796/index.html">Machine learning do-it-yourself (part 2). Service for the classification of calls to those. support</a></li>
<li><a href="../342798/index.html">JBreak 2018 Java Conference Announcement: Connecting the Dots</a></li>
<li><a href="../342800/index.html">YouTrack 2017.4 Release: Time Evaluation Report, Markdown Support, and more</a></li>
<li><a href="../342802/index.html">How to cook blockchain</a></li>
<li><a href="../342804/index.html">Postgres Pro Quiz Task at Highload ++ 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>