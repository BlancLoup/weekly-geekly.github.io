<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing a DLL for Metastock from scratch. Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will explain how to connect arguments to our indicators ( part 1 , part 2 ). Two service functions are responsible for the arguments...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing a DLL for Metastock from scratch. Part 3</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/9f0/406/bc2/9f0406bc27bd44b082396dd10c8eecfd.bmp" alt="DLL  Metastock" title="DLL for Metastock"><br><br>  In this article I will explain how to connect arguments to our indicators ( <a href="http://habrahabr.ru/post/219133/">part 1</a> , <a href="http://habrahabr.ru/post/219953/">part 2</a> ).  Two service functions are responsible for the arguments in the MSX DLL dynamic library of the Metastock program: MSXNthArg and MSXNthCustomString. <br><a name="habracut"></a><br><h3>  Arguments </h3><br>  <b>MSXNthArg</b> is called during initialization for each argument, each external function that has arguments. <br><br><pre><code class="cpp hljs">BOOL __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MSXNthArg</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a_iNthFunc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a_iNthArg, MSXFuncArgDef *a_psFuncArgDef)</span></span></span></span></code> </pre> <br>  where <br>  ‚Ä¢ a_iNthFunc - index of the external function. <br>  ‚Ä¢ a_iNthArg - index of the argument of this function. <br>  ‚Ä¢ a_psFuncArgDef - Pointer to the MSXFuncArgDef data structure used to fill the user with information about the argument of the external function. <br>  The function returns: <br>  ‚Ä¢ MSX_SUCCESS if everything is correct and <br>  ‚Ä¢ MSX_ERROR in case of an error. <br>  All arguments are divided into four types: <br>  ‚Ä¢ MSXDataArray - data array <br>  ‚Ä¢ MSXNumeric - number, <br>  ‚Ä¢ MSXString - string, <br>  ‚Ä¢ MSXCustom - custom. <br>  When using an argument, the user must specify its type and name.  An argument of type MSXCustom is a specific set, the members of which I will call custom-arguments.  If the argument type is MSXCustom, then you must also specify the number of custom arguments.  That is, when describing an argument, we write functions in the MSXNthArg <br>  for non-MSXCustom type: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs">a_psFuncArgDef-&gt;iArgType = MSXDataArray; <span class="hljs-comment"><span class="hljs-comment">//  MSXNumeric  MSXString strcpy (a_psFuncArgDef-&gt;szArgName, " ");</span></span></code> </pre><br>  for MSXCustom type: <br><br><pre> <code class="cpp hljs">a_psFuncArgDef-&gt;iArgType = MSXCustom; a_psFuncArgDef-&gt;iNCustomStrings = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  custom- strcpy (a_psFuncArgDef-&gt;szArgName, " ");</span></span></code> </pre><br><br>  <b>MSXNthCustomString</b> is responsible for custom arguments. <br><br><pre> <code class="cpp hljs">BOOL __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MSXNthCustomString</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a_iNthFunc, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a_iNthArg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a_iNthString, MSXFuncCustomString *a_psCustomString)</span></span></span></span></code> </pre><br>  where <br>  ‚Ä¢ a_iNthFunc - index of the external function. <br>  ‚Ä¢ a_iNthArg - index of the argument of this function. <br>  ‚Ä¢ a_iNthString - index of the custom argument. <br>  ‚Ä¢ a_psFuncArgDef - Pointer to the MSXFuncCustomString data structure used to fill the user with information about the custom arguments of the external function. <br>  The function returns the same values ‚Äã‚Äãas the previous one. <br>  A custom argument is a pair: a string-identifier. The MSXNthCustomString function matches a string with a numeric identifier (ID).  In the external function, custom arguments are called by ID.  Strings used to define custom arguments must consist of alphanumeric characters only.  Spaces and special characters are not allowed.  Custom arguments are not case sensitive. <br>  The number of arguments of each type cannot be more than ten.  Do not forget that functions and arguments are numbered from 0. <br><br><h3>  Exceptions </h3><br>  To avoid the crash of the Metastock program, you must add exception handling to each external function.  Exceptions may be as follows: <br>  ‚Ä¢ Incorrect number of arguments. <br>  ‚Ä¢ Incoming (used for calculations) array does not meet Metastock standards (see part 2), <br>  ‚Ä¢ Argument not received, <br>  ‚Ä¢ The argument is not correct, <br>  ‚Ä¢ The outgoing (calculation result) array does not meet Metastock standards. <br>  Each of these situations we will handle in the following general form: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (  ,  , ) { <span class="hljs-built_in"><span class="hljs-built_in">strncpy</span></span> (a_psResult-&gt;szExtendedError, <span class="hljs-string"><span class="hljs-string">"Error:  "</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(a_psResult-&gt;szExtendedError)<span class="hljs-number"><span class="hljs-number">-1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; }</span></span></code> </pre><br>  For exception handling, I added a few extra features. <br><br><h3>  Example </h3><br>  In the following example, I created four indicators that deal with addition.  Each indicator has two arguments - one array, and the second one of four types.  As promised in the first part, I painted a sequence of actions in steps. <br>  Create a project in Visual Studio with three files: MSXStruc.h, Add.cpp, Add.def.  Our library will be named Add.dll. <br><br>  <b>Step 1 - Headers and Export</b> <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;math.h&gt; #include &lt;float.h&gt; #include &lt;tchar.h&gt; #include "MSXStruc.h" #define DLL_EXPORT extern "C" __declspec(dllexport)</span></span></span></span></code> </pre><br></div></div><br>  <b>Step 2 - Variable Parameters</b> <br><br>  All the parameters of functions and arguments that are changed by the user are written here. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//    const char *szMayCopyright ="VS 2010 C++ MSX DLL, Copyright (c) andrzwet, 2014"; const int MyFuncs = 4; //    (fan1,fan2,fan3,fan4) //   const char *szNfan1 = "fan1"; const char *szNfan2 = "fan2"; const char *szNfan3 = "fan3"; const char *szNfan4 = "fan4"; //   const char *szDfan1 = "Add- (DA1 + DA2)"; const char *szDfan2 = "Add- (DA1 + Number)"; const char *szDfan3 = "Add- (DA1 + DAStr)"; const char *szDfan4 = "Add- (DA1 + DACust)"; const int fan1Args = 2; // 2    fan1 - 2  //    fan1 const char *szNAfan1Arg1 = "DA1"; const char *szNAfan1Arg2 = "DA2"; const int fan2Args = 2; // 2    fan2 - 1  ,1  //    fan2 const char *szNAfan2Arg1 = "DA1"; const char *szNNfan2Arg2 = "Numeric"; const int fan3Args = 2; // 2    fan3 - 1  ,1  //    fan3 const char *szNAfan3Arg1 = "DA1"; const char *szNSfan3Arg2 = "DAStr"; const int fan4Args = 2; // 2    fan4 - 1  ,1 CustomType //    fan4 const char *szNAfan4Arg1 = "DA1"; const char *szNCfan4Arg2 = "DACust"; const int fan4ArgsCust = 8; //      fan4  Custom, //       8  () //  custom-   char *szCust1 = "Open"; char *szCust5 = "O"; int id1 = 0; char *szCust2 = "High"; char *szCust6 = "H"; int id2 = 1; char *szCust3 = "Low"; char *szCust7 = "L"; int id3 = 2; char *szCust4 = "Close"; char *szCust8 = "C"; int id4 = 3;</span></span></code> </pre><br></div></div><br>  <b>Step 3 - Initialization Functions</b> <br><br>  Four functions are described here: MSXInfo, MSXNthFunction, MSXNthArg, MSXNthCustomString. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ---------------------------------------------------- DLL_EXPORT BOOL __stdcall MSXInfo (MSXDLLDef *a_psDLLDef) { strncpy (a_psDLLDef-&gt;szCopyright, szMayCopyright, sizeof(a_psDLLDef-&gt;szCopyright)-1); a_psDLLDef-&gt;iNFuncs = MyFuncs; //  . a_psDLLDef-&gt;iVersion = MSX_VERSION; return MSX_SUCCESS; } // ---------------------------------------------------- DLL_EXPORT BOOL __stdcall MSXNthFunction (int a_iNthFunc, MSXFuncDef *a_psFuncDef) { BOOL l_bRtrn = MSX_SUCCESS; switch (a_iNthFunc) { case 0: // --- fan1 --- strcpy (a_psFuncDef-&gt;szFunctionName, szNfan1); //  strcpy (a_psFuncDef-&gt;szFunctionDescription, szDfan1); //  a_psFuncDef-&gt;iNArguments = fan1Args; //   break; case 1: // --- fan2 --- strcpy (a_psFuncDef-&gt;szFunctionName, szNfan2); //  strcpy (a_psFuncDef-&gt;szFunctionDescription, szDfan2); //  a_psFuncDef-&gt;iNArguments = fan2Args; //   break; case 2: // --- fan3 --- strcpy (a_psFuncDef-&gt;szFunctionName, szNfan3); //  strcpy (a_psFuncDef-&gt;szFunctionDescription, szDfan3); //  a_psFuncDef-&gt;iNArguments = fan3Args; //   break; case 3: // --- fan4 --- strcpy (a_psFuncDef-&gt;szFunctionName, szNfan4); //  strcpy (a_psFuncDef-&gt;szFunctionDescription, szDfan4); //  a_psFuncDef-&gt;iNArguments = fan4Args; //  . break; default: l_bRtrn = MSX_ERROR; break; } return l_bRtrn; } // ---------------------------------------------------- DLL_EXPORT BOOL __stdcall MSXNthArg (int a_iNthFunc, int a_iNthArg, MSXFuncArgDef *a_psFuncArgDef) { BOOL l_bRtrn = MSX_SUCCESS; //   custom- = 0 () a_psFuncArgDef-&gt;iNCustomStrings = 0; switch (a_iNthFunc) { case 0: // ---  fan1 --- switch (a_iNthArg) { case 0: a_psFuncArgDef-&gt;iArgType = MSXDataArray; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNAfan1Arg1); //  break; case 1: a_psFuncArgDef-&gt;iArgType = MSXDataArray; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNAfan1Arg2); //  break; default: l_bRtrn = MSX_ERROR; break; } break; case 1: // ---  fan2 --- switch (a_iNthArg) { case 0: a_psFuncArgDef-&gt;iArgType = MSXDataArray; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNAfan2Arg1); //  break; case 1: a_psFuncArgDef-&gt;iArgType = MSXNumeric; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNNfan2Arg2); //  break; default: l_bRtrn = MSX_ERROR; break; } break; case 2: // ---  fan3 --- switch (a_iNthArg) { case 0: a_psFuncArgDef-&gt;iArgType = MSXDataArray; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNAfan3Arg1); //  break; case 1: a_psFuncArgDef-&gt;iArgType = MSXString; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNSfan3Arg2); //  break; default: l_bRtrn = MSX_ERROR; break; } break; case 3: // ---  fan4 --- switch (a_iNthArg) { case 0: a_psFuncArgDef-&gt;iArgType = MSXDataArray; //  strcpy (a_psFuncArgDef-&gt;szArgName, szNAfan4Arg1); //  break; case 1: a_psFuncArgDef-&gt;iArgType = MSXCustom; //  a_psFuncArgDef-&gt;iNCustomStrings = fan4ArgsCust; // - custom- strcpy (a_psFuncArgDef-&gt;szArgName, szNCfan4Arg2); //  break; default: l_bRtrn = MSX_ERROR; break; } break; default: l_bRtrn = MSX_ERROR; break; } return l_bRtrn; } // ---------------------------------------------------- DLL_EXPORT BOOL __stdcall MSXNthCustomString (int a_iNthFunc, int a_iNthArg, int a_iNthString, MSXFuncCustomString *a_psCustomString) { BOOL l_bRtrn = MSX_SUCCESS; //  a_psCustomString-&gt;szString[0] = '\0'; a_psCustomString-&gt;iID = -1; //   typedef struct { char *szString; int iID; } LocalStringElement; //        LocalStringElement l_sTheStrings[] = { {szCust1, id1}, {szCust5, id1}, {szCust2, id2}, {szCust6, id2}, {szCust3, id3}, {szCust7, id3}, {szCust4, id4}, {szCust8, id4} }; switch (a_iNthFunc) { case 3: // Custom-       (fan4) switch (a_iNthArg) { case 1: // Custom-      fan4 //   Custom-. if(a_iNthString &gt;= 0 &amp;&amp; a_iNthString &lt; fan4ArgsCust) { //     ID strncpy (a_psCustomString-&gt;szString, l_sTheStrings[a_iNthString].szString, sizeof(a_psCustomString-&gt;szString)-1); a_psCustomString-&gt;iID = l_sTheStrings[a_iNthString].iID; } break; default: l_bRtrn = MSX_ERROR; break; } break; default: l_bRtrn = MSX_ERROR; break; } return l_bRtrn; }</span></span></code> </pre><br></div></div><br>  <b>Step 4 - Additional Functions</b> <br><br>  Here we write the functions needed to handle exceptions. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* ForceFloatRange -              float . ‚Ä¢ FLT_MAX ‚Äî   ,      float (3.402823466e+38F), ‚Ä¢ FLT_MIN ‚Äî   ,      float (1.175494351e-38F). */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MSXMax(a,b) (((a) &gt; (b)) ? (a) : (b)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MSXMin(a,b) (((a) </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; (b)) ? (a) : (b)) double ForceFloatRange (double a_lfDbl) { if (a_lfDbl &gt; 0.0) { a_lfDbl = MSXMin (a_lfDbl, double(FLT_MAX)); a_lfDbl = MSXMax (a_lfDbl, double(FLT_MIN)); } else { if (a_lfDbl &lt; 0.0) { a_lfDbl = MSXMax (a_lfDbl, double(-FLT_MAX)); a_lfDbl = MSXMin (a_lfDbl, double(-FLT_MIN)); } } return a_lfDbl; } /* MSXArray -               MetaStock.       MSXDataRec    .      ,          MSXDataRec.   ,  ,              Metastock BasicData,     . ,         ,    MetaStock'. */ BOOL MSXArray(const MSXDataRec *BasicData, const MSXDataInfoRec *ArgData) { if (ArgData-&gt;iFirstValid &lt; 0) return FALSE; if (ArgData-&gt;iLastValid &lt; 0) return FALSE; if (ArgData-&gt;iLastValid &lt; ArgData-&gt;iFirstValid) return FALSE; if (ArgData-&gt;iFirstValid &lt; BasicData-&gt;sClose.iFirstValid) return FALSE; if (ArgData-&gt;iLastValid &gt; BasicData-&gt;sClose.iLastValid) return FALSE; return TRUE; }</span></span></span></span></code> </pre><br></div></div><br>  <b>Step 5 - External Functions</b> <br><br>  <b>Fan1</b> summarizes two data arrays ( <b>ExtFml ("Add.fan1", DA1, DA2)</b> ). <br>  The function has two arguments, both are data arrays. <br><div class="spoiler">  <b class="spoiler_title">fan1</b> <div class="spoiler_text"><pre> <code class="cpp hljs">DLL_EXPORT BOOL __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fan1</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataRec *a_psBasic, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataInfoRecArgsArray *a_psArrayArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXNumericArgsArray *a_psNumericArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXStringArgsArray *a_psStringArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXCustomArgsArray *a_psCustomArgs, MSXResultRec *a_psResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//     (  ) int iMinRecords = a_psBasic-&gt;sClose.iFirstValid; int iMaxRecords = a_psBasic-&gt;sClose.iLastValid; //   const MSXDataInfoRec *l_psInput1 = a_psArrayArgs-&gt;psDataInfoRecs[0]; const MSXDataInfoRec *l_psInput2 = a_psArrayArgs-&gt;psDataInfoRecs[1]; int iLvi; int iFvi; // ,     if ( a_psArrayArgs-&gt;iNRecs == 2 &amp;&amp; a_psNumericArgs-&gt;iNRecs == 0 &amp;&amp; a_psStringArgs-&gt;iNRecs == 0 &amp;&amp; a_psCustomArgs-&gt;iNRecs == 0) { if (!(MSXArray(a_psBasic, l_psInput1) &amp;&amp; MSXArray(a_psBasic, l_psInput2) )) { //    ,    strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Input Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } //      if (l_psInput1 &amp;&amp; l_psInput2) { //    fan1 for (i=iMinRecords; i&lt;=iMaxRecords; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float (ForceFloatRange(l_psInput1-&gt;pfValue[i] + l_psInput2-&gt;pfValue[i])); //        iFvi = MSXMax(l_psInput1-&gt;iFirstValid,l_psInput2-&gt;iFirstValid); iLvi = MSXMin(l_psInput1-&gt;iLastValid,l_psInput2-&gt;iLastValid); a_psResult-&gt;psResultArray-&gt;iFirstValid = iFvi; a_psResult-&gt;psResultArray-&gt;iLastValid = iLvi; } else { //  ! strncpy (a_psResult-&gt;szExtendedError, "Error: Data array argument missing", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Wrong number of arguments", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } if (!MSXArray(a_psBasic, a_psResult-&gt;psResultArray)) { //    ,    strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Result Array.", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } return MSX_SUCCESS; }</span></span></code> </pre><br></div></div><br>  <b>Fan2</b> summarizes the data array and the number ( <b>ExtFml ("Add.fan2", DA1, Numeric)</b> ). <br>  The function has two arguments, one is the data array, the other is the number. <br><div class="spoiler">  <b class="spoiler_title">fan2</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs">DLL_EXPORT BOOL __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fan2</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataRec *a_psBasic, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataInfoRecArgsArray *a_psArrayArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXNumericArgsArray *a_psNumericArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXStringArgsArray *a_psStringArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXCustomArgsArray *a_psCustomArgs, MSXResultRec *a_psResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   const MSXDataInfoRec *l_psInput = a_psArrayArgs-&gt;psDataInfoRecs[0]; // float l_fNumber = a_psNumericArgs-&gt;fNumerics[0]; // // ,     if ( a_psArrayArgs-&gt;iNRecs == 1 &amp;&amp; a_psNumericArgs-&gt;iNRecs == 1 &amp;&amp; a_psStringArgs-&gt;iNRecs == 0 &amp;&amp; a_psCustomArgs-&gt;iNRecs == 0) { if (!MSXArray(a_psBasic, l_psInput)) { //     strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Input Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } //     if (l_psInput) { //    fan2 for (i=l_psInput-&gt;iFirstValid; i&lt;=l_psInput-&gt;iLastValid; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float (ForceFloatRange(l_psInput-&gt;pfValue[i] + l_fNumber)); //        a_psResult-&gt;psResultArray-&gt;iFirstValid = l_psInput-&gt;iFirstValid; a_psResult-&gt;psResultArray-&gt;iLastValid = l_psInput-&gt;iLastValid; } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Array argument missing", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Wrong number of arguments", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } if (!MSXArray(a_psBasic, a_psResult-&gt;psResultArray)) { //    ,    strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Result Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } return MSX_SUCCESS; }</span></span></code> </pre><br></div></div><br>  <b>fan3</b> summarizes the data array and data array, defined by the string argument <br>  ( <b>ExtFml ("Add.fan3", DA1, DAStr)</b> ). <br>  The function has two arguments, one is the data array, the other is a string. <br><div class="spoiler">  <b class="spoiler_title">fan3</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs">DLL_EXPORT BOOL __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fan3</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataRec *a_psBasic, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataInfoRecArgsArray *a_psArrayArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXNumericArgsArray *a_psNumericArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXStringArgsArray *a_psStringArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXCustomArgsArray *a_psCustomArgs, MSXResultRec *a_psResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iMinRecords = a_psBasic-&gt;sClose.iFirstValid; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iMaxRecords = a_psBasic-&gt;sClose.iLastValid; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MSXDataInfoRec *l_psInput1; l_psInput1 = a_psArrayArgs-&gt;psDataInfoRecs[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//  const char *l_pszInput2 =a_psStringArgs-&gt;pszStrings[0]; //  const MSXDataInfoRec *l_psData; int iLvi; int iFvi; //  ,    if ( a_psArrayArgs-&gt;iNRecs == 1 &amp;&amp; a_psNumericArgs-&gt;iNRecs == 0 &amp;&amp; a_psStringArgs-&gt;iNRecs == 1 &amp;&amp; a_psCustomArgs-&gt;iNRecs == 0) { if (!MSXArray(a_psBasic, l_psInput1)) { //     strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Input Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } //      if (l_psInput1) { //      if (l_pszInput2) { while (*l_pszInput2) { //    switch (*l_pszInput2++) { case 'O': case 'o': l_psData = &amp;a_psBasic-&gt;sOpen; break; case 'H': case 'h': l_psData = &amp;a_psBasic-&gt;sHigh; break; case 'L': case 'l': l_psData = &amp;a_psBasic-&gt;sLow; break; case 'C': case 'c': l_psData = &amp;a_psBasic-&gt;sClose; break; default: //    ! strncpy (a_psResult-&gt;szExtendedError, "Error: Wrong String argument", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; break; } //    fan3 for (i=iMinRecords; i&lt;=iMaxRecords; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float(ForceFloatRange( l_psData-&gt;pfValue[i] + l_psInput1-&gt;pfValue[i])); iFvi = MSXMax(l_psInput1-&gt;iFirstValid, l_psData-&gt;iFirstValid); iLvi = MSXMin(l_psInput1-&gt;iLastValid, l_psData-&gt;iLastValid); a_psResult-&gt;psResultArray-&gt;iFirstValid = iFvi; a_psResult-&gt;psResultArray-&gt;iLastValid = iLvi; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: String argument missing", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Array argument missing", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Wrong number of arguments", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } if (!MSXArray(a_psBasic, a_psResult-&gt;psResultArray)) { strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Result Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } return MSX_SUCCESS; }</span></span></code> </pre><br></div></div><br>  <b>fan4</b> summarizes the data array and data array defined by the custom argument <br>  ( <b>ExtFml ("Add.fan4", DA1, DACust)</b> ). <br>  The function has two arguments, one is the data array, the other is an argument of the MSXCustom type. <br><div class="spoiler">  <b class="spoiler_title">fan4</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs">DLL_EXPORT BOOL __<span class="hljs-function"><span class="hljs-function">stdcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fan4</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataRec *a_psBasic, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXDataInfoRecArgsArray *a_psArrayArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXNumericArgsArray *a_psNumericArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXStringArgsArray *a_psStringArgs, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MSXCustomArgsArray *a_psCustomArgs, MSXResultRec *a_psResult)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iMinRecords = a_psBasic-&gt;sClose.iFirstValid; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> iMaxRecords = a_psBasic-&gt;sClose.iLastValid; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MSXDataInfoRec *l_psInput1; l_psInput1 = a_psArrayArgs-&gt;psDataInfoRecs[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//  int l_psInput2 = a_psCustomArgs-&gt;iCustomIDs[0]; // custom int iLvi; int iFvi; // ,     if ( a_psArrayArgs-&gt;iNRecs == 1 &amp;&amp; a_psNumericArgs-&gt;iNRecs == 0 &amp;&amp; a_psStringArgs-&gt;iNRecs == 0 &amp;&amp; a_psCustomArgs-&gt;iNRecs == 1) { if (!(MSXArray(a_psBasic, l_psInput1) ) ) { strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Input Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } //   if (l_psInput1) { switch (l_psInput2) { case 0: // Open { for (i=iMinRecords; i&lt;=iMaxRecords; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float(ForceFloatRange(a_psBasic-&gt;sOpen.pfValue[ i ] + l_psInput1-&gt;pfValue[i])); iLvi = MSXMin(l_psInput1-&gt;iLastValid,iMaxRecords); iFvi = MSXMax(l_psInput1-&gt;iFirstValid,iMinRecords); a_psResult-&gt;psResultArray-&gt;iFirstValid = iFvi; a_psResult-&gt;psResultArray-&gt;iLastValid = iLvi; } break; case 1: // High { for (i=iMinRecords; i&lt;=iMaxRecords; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float(ForceFloatRange(a_psBasic-&gt;sHigh.pfValue[ i ] + l_psInput1-&gt;pfValue[i])); iLvi = MSXMin(l_psInput1-&gt;iLastValid,iMaxRecords); iFvi = MSXMax(l_psInput1-&gt;iFirstValid,iMinRecords); a_psResult-&gt;psResultArray-&gt;iFirstValid = iFvi; a_psResult-&gt;psResultArray-&gt;iLastValid = iLvi; } break; case 2: // Low { for (i=iMinRecords; i&lt;=iMaxRecords; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float(ForceFloatRange(a_psBasic-&gt;sLow.pfValue[ i ] + l_psInput1-&gt;pfValue[i])); iLvi = MSXMin(l_psInput1-&gt;iLastValid,iMaxRecords); iFvi = MSXMax(l_psInput1-&gt;iFirstValid,iMinRecords); a_psResult-&gt;psResultArray-&gt;iFirstValid = iFvi; a_psResult-&gt;psResultArray-&gt;iLastValid = iLvi; } break; case 3: // Close { for (i=iMinRecords; i&lt;=iMaxRecords; i++) a_psResult-&gt;psResultArray-&gt;pfValue[i] = float(ForceFloatRange(a_psBasic-&gt;sClose.pfValue[ i ] + l_psInput1-&gt;pfValue[i])); iLvi = MSXMin(l_psInput1-&gt;iLastValid,iMaxRecords); iFvi = MSXMax(l_psInput1-&gt;iFirstValid,iMinRecords); a_psResult-&gt;psResultArray-&gt;iFirstValid = iFvi; a_psResult-&gt;psResultArray-&gt;iLastValid = iLvi; } break; default: { //   custom-! strncpy (a_psResult-&gt;szExtendedError, "Error: Invalid Custom argument", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } break; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Array argument missing", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } } else { //   ! strncpy (a_psResult-&gt;szExtendedError, "Error: Wrong number of arguments", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } if (!MSXArray(a_psBasic, a_psResult-&gt;psResultArray)) { strncpy (a_psResult-&gt;szExtendedError, "Error: Corrupted Result Array", sizeof(a_psResult-&gt;szExtendedError)-1); a_psResult-&gt;psResultArray-&gt;iFirstValid = 0; a_psResult-&gt;psResultArray-&gt;iLastValid = -1; return MSX_ERROR; } return MSX_SUCCESS; }</span></span></code> </pre><br></div></div><br>  <b>Step 6 - DEF File</b> <br><br>  Below is an example DEF file for my project. <br>  The DEF file is a separate text file, and must have the same name as your project. <br><div class="spoiler">  <b class="spoiler_title">Add.def</b> <div class="spoiler_text"><br><pre> <code class="cpp hljs">LIBRARY Add EXPORTS MSXInfo MSXNthFunction MSXNthArg MSXNthCustomString fan1 fan2 fan3 fan4</code> </pre><br></div></div><br>  I hope that in my articles I was able to explain the principles for constructing the MSX DLL dynamic library for the Metastock program. </div><p>Source: <a href="https://habr.com/ru/post/220111/">https://habr.com/ru/post/220111/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220093/index.html">Popcorn Time developers disappear one by one</a></li>
<li><a href="../220095/index.html">OpenWorm: a digital model of a nematode worm in the browser</a></li>
<li><a href="../220097/index.html">Python-digest # 23. News, interesting projects, articles and interviews [April 13, 2014 - April 20, 2014]</a></li>
<li><a href="../220103/index.html">History of portable game consoles. Part 1 (Until 2000)</a></li>
<li><a href="../220107/index.html">Quixter's new Pay-By-Palm biometric electronic payment technology scans the veins of your palms.</a></li>
<li><a href="../220113/index.html">Exploitation of vulnerability in DrWeb update procedure</a></li>
<li><a href="../220115/index.html">Maketon Nova Base - a marathon for assembling a 3D printer</a></li>
<li><a href="../220117/index.html">Embarcadero RAD studio XE6</a></li>
<li><a href="../220119/index.html">Kirill Safonov: ‚ÄúIt's like racing on the ocean on small yachts‚Äù</a></li>
<li><a href="../220123/index.html">Internet radio with a host of leading from different cities and calls live</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>