<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Module loading on demand to AngularJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you are in a hurry: then yes, deferred loading of modules into AngularJS is possible, and you can see the code needed for this below. 

 Does Angul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Module loading on demand to AngularJS</h1><div class="post__text post__text-html js-mediator-article"> If you are in a hurry: then yes, deferred loading of modules into <code>AngularJS</code> is possible, and you can see the code needed for this below. <br><br><h4>  Does AngularJS really not support deferred loading in any way? </h4><br>  AngularJS is one of the best templates for front end development, but it is still young, and does not have several important features (who said a good router?). <br>  While most of these features can be added in the form of modules that can be found on google or on <a href="http://ngmodules.org/">specialized web sites</a> , there are some features that cannot be added in this way. <br>  Currently, many require asynchronous loading of modules, and it seems Google is going to implement it in the second version of the framework, but who knows when it will be ... <br><a name="habracut"></a><br>  I'm looking for a way to do this now, because I want to optimize my application and speed up the time it loads. <br>  I found two very interesting articles (in English): <a href="http://ify.io/lazy-loading-in-angularjs/">deferred loading in AngularJS</a> and <a href="http://www.bennadel.com/blog/2554-Loading-AngularJS-Components-With-RequireJS-After-Application-Bootstrap.htm">loading components of AngularJS after starting the application using RequireJS</a> . <br>  But both of them explain the delayed loading of controllers, services, filters, directives, but not the delayed loading of modules. <br>  I decided to study the angular source code for loading modules (you can see it here), and I noticed that the registration of modules occurs after initialization, but the new loaded modules and their dependencies simply do not connect to the application and are not initialized. <br><br><h4>  Wait, can't you do it yourself? </h4><br>  Well, yes, of course it can be done!  All we need to do is make sure that the module we are adding has not been previously added to the application, since we have no desire to rewrite the already existing code.  Imagine you need a service that has already been loaded and configured before, it will very quickly stop working as needed if you rewrite it. <br>  So, we need a list of previously loaded modules, which should be easy to find, right? <br>  Well ... yes ... actually ... no. <br>  If you look at the source code, you will find there an internal variable called <code>modules</code> .  This variable is used to store a list of all loaded modules, and it is not accessible from the outside. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Therefore, we can not get a list of modules? </h4><br>  No, we can not.  But we can recreate it again. <br>  We can use <code>angular.module('moduleName')</code> at any time to get an existing module.  If you output its result to the log, you will notice the property: <code>_invokeQueue</code> .  This is the list of its dependencies. <br>  Since modules can only be loaded at startup and the application can only be started using the <code>ng-app</code> directive, if you can find the application module, you can get the entire list of loaded modules and their dependencies. <br>  <i>Translator's note: in fact, the application can be started without the ng-app directive, but in this case it does not matter.</i> <br>  You can do this with the following code: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">element</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> elements = [element], appElement, <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>, names = [<span class="hljs-string"><span class="hljs-string">'ng:app'</span></span>, <span class="hljs-string"><span class="hljs-string">'ng-app'</span></span>, <span class="hljs-string"><span class="hljs-string">'x-ng-app'</span></span>, <span class="hljs-string"><span class="hljs-string">'data-ng-app'</span></span>], NG_APP_CLASS_REGEXP = <span class="hljs-regexp"><span class="hljs-regexp">/\sng[:\-]app(:\s*([\w\d_]+);?)?\s/</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">elm</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (elm &amp;&amp; elements.push(elm)); } angular.forEach(names, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ names[name] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; append(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(name)); name = name.replace(<span class="hljs-string"><span class="hljs-string">':'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\:'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(element.querySelectorAll) { angular.forEach(element.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'.'</span></span> + name), append); angular.forEach(element.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'.'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'\\:'</span></span>), append); angular.forEach(element.querySelectorAll(<span class="hljs-string"><span class="hljs-string">'['</span></span> + name + <span class="hljs-string"><span class="hljs-string">']'</span></span>), append); } }); angular.forEach(elements, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">elm</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!appElement) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> className = <span class="hljs-string"><span class="hljs-string">' '</span></span> + element.className + <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> match = NG_APP_CLASS_REGEXP.exec(className); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(match) { appElement = elm; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> = (match[<span class="hljs-number"><span class="hljs-number">2</span></span>] || <span class="hljs-string"><span class="hljs-string">''</span></span>).replace(<span class="hljs-regexp"><span class="hljs-regexp">/\s+/g</span></span>, <span class="hljs-string"><span class="hljs-string">','</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { angular.forEach(elm.attributes, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">attr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!appElement &amp;&amp; names[attr.name]) { appElement = elm; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span> = attr.value; } }); } } }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(appElement) { (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addReg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(regModules.indexOf(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>) === <span class="hljs-number"><span class="hljs-number">-1</span></span>) { regModules.push(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mainModule = angular.module(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); angular.forEach(mainModule.requires, addReg); } })(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); } }</code> </pre><br><h4>  Registration of new modules </h4><br>  Now, when we have a list of previously loaded modules, we can add new modules (only those that have not been loaded before). <br>  To do this, we need to understand how modules and dependencies are invoked in angular. <br>  As soon as a module is registered, all its dependencies are loaded (in the ‚Äúinitialization‚Äù phase), which are added to the module as a result of initialization.  If any dependency already exists in memory, then the initialization phase will be skipped, and a link to the existing dependency will be added to the module. <br>  A module can go through configuration and execution phases. <br>  The configuration phase is performed before the dependencies are downloaded. <br>  The execution phase begins only after the configuration phase and the complete loading of all the required dependencies.  You can see the code for the execution phase in the <code>_runBlocks</code> parameter. <br>  To start the execution phase, we will use the invoke function of the <code>$injector</code> service. <br>  So, in the end, we will make a list of all dependencies, track the configuration and execution phases, and call them in the correct order. <br>  In fact, we will reproduce the way in which angular loads its modules, which you can explore from <a href="">source codes</a> . <br>  The result is shown in the following function: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">providers, registerModules, $log</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, ii, k, invokeQueue, moduleName, moduleFn, invokeArgs, provider; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(registerModules) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> runBlocks = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(k = registerModules.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; k &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; k--) { moduleName = registerModules[k]; regModules.push(moduleName); moduleFn = angular.module(moduleName); runBlocks = runBlocks.concat(moduleFn._runBlocks); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(invokeQueue = moduleFn._invokeQueue, i = <span class="hljs-number"><span class="hljs-number">0</span></span>, ii = invokeQueue.length; i &lt; ii; i++) { invokeArgs = invokeQueue[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(providers.hasOwnProperty(invokeArgs[<span class="hljs-number"><span class="hljs-number">0</span></span>])) { provider = providers[invokeArgs[<span class="hljs-number"><span class="hljs-number">0</span></span>]]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $log.error(<span class="hljs-string"><span class="hljs-string">"unsupported provider "</span></span> + invokeArgs[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } provider[invokeArgs[<span class="hljs-number"><span class="hljs-number">1</span></span>]].apply(provider, invokeArgs[<span class="hljs-number"><span class="hljs-number">2</span></span>]); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(e.message) { e.message += <span class="hljs-string"><span class="hljs-string">' from '</span></span> + moduleName; } $log.error(e.message); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> e; } registerModules.pop(); } angular.forEach(runBlocks, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fn</span></span></span><span class="hljs-function">) </span></span>{ providers.$injector.invoke(fn); }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br>  But be careful, when registering dependencies, we need to use the correct provider.  We do not want to use the service provider when registering the directive. <br><br><h4>  Let's write our service </h4><br>  Each provider and injector are available in configuration and initialization phases.  We need to keep a link to them if we want to use them later. <br>  We also need to keep track of loaded modules in order to prevent them from re-loading. <br>  I don‚Äôt want to write my own asynchronous loader, as there are quite a lot of them on the market (requireJS, script.js ...) and it would be stupid to reinvent your own bike, so you‚Äôll have to figure this out yourself using the configuration. <br>  You can use any bootloader that supports the following syntax: <br><pre> <code class="javascript hljs">loader([urls], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{});</code> </pre><br>  This way you can load any resources that you need (only js files, css, etc.). <br>  In this example, I will use <a href="https://github.com/ded/script.js/">script.js</a> . <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modules = {}, asyncLoader, providers = { <span class="hljs-attr"><span class="hljs-attr">$controllerProvider</span></span>: $controllerProvider, <span class="hljs-attr"><span class="hljs-attr">$compileProvider</span></span>: $compileProvider, <span class="hljs-attr"><span class="hljs-attr">$filterProvider</span></span>: $filterProvider, <span class="hljs-attr"><span class="hljs-attr">$provide</span></span>: $provide, <span class="hljs-comment"><span class="hljs-comment">// other things $injector: $injector };</span></span></code> </pre><br>  This is a fairly easy part of the configuration, we need to define an asynchronous loader and a list of modules that we could load using a directive. <br>  We also run the initialization script, which was previously defined, to fill in the list of modules for initial initialization. <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.config = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">config</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> config.asyncLoader === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>(<span class="hljs-string"><span class="hljs-string">'You need to define an async loader such as requireJS or script.js'</span></span>); } asyncLoader = config.asyncLoader; init(angular.element(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.document)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> config.modules !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(angular.isArray(config.modules)) { angular.forEach(config.modules, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleConfig</span></span></span><span class="hljs-function">) </span></span>{ modules[moduleConfig.name] = moduleConfig; }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { modules[config.modules.name] = config.modules; } } };</code> </pre><br>  To set up a provider, simply add this code to your application: <br><pre> <code class="javascript hljs">angular.module(<span class="hljs-string"><span class="hljs-string">'app'</span></span>).config([<span class="hljs-string"><span class="hljs-string">'$ocLazyLoadProvider'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$ocLazyLoadProvider</span></span></span><span class="hljs-function">) </span></span>{ $ocLazyLoadProvider.config({ <span class="hljs-attr"><span class="hljs-attr">modules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'TestModule'</span></span>, <span class="hljs-attr"><span class="hljs-attr">files</span></span>: [<span class="hljs-string"><span class="hljs-string">'js/testModule.js'</span></span>], <span class="hljs-attr"><span class="hljs-attr">template</span></span>: <span class="hljs-string"><span class="hljs-string">'partials/testLazyLoad.html'</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">asyncLoader</span></span>: $script }); }]);</code> </pre><br>  As we write the provider, the only place where we can use component injection is the <code>$get</code> property.  That that will return this property, and will be available in your service. <br>  We will define getters and setters for configuring modules and a function for loading them. <br>  We will also add a getter for the list of modules, since it must be available if someone wants to write a plugin. <br>  Getters and setters are easily identified: <br><pre> <code class="javascript hljs">getModuleConfig: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!modules[name]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> modules[name]; }, <span class="hljs-attr"><span class="hljs-attr">setModuleConfig</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function">) </span></span>{ modules[<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.name] = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>; }, <span class="hljs-attr"><span class="hljs-attr">getModules</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> regModules; }</code> </pre><br>  Now let's take a closer look at the download function.  We need to implement the loading of modules by name or configuration. <br>  The configuration object contains the name of the module, a list of files (scripts, css ...) and an optional template. <br>  If we load a module using a directive, the template will be used to replace its code. <br>  We will also maintain a list of module dependencies so that they can be registered. <br>  The download function will return a promise, which will simplify further development. <br><pre> <code class="javascript hljs">load: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, config, moduleCache = [], deferred = $q.defer(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> name === <span class="hljs-string"><span class="hljs-string">'string'</span></span>) { config = self.getModuleConfig(name); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> name === <span class="hljs-string"><span class="hljs-string">'object'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> name.name !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { config = self.setModuleConfig(name); name = name.name; } moduleCache.push = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.indexOf(value) === <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.prototype.push.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!config) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errorText = <span class="hljs-string"><span class="hljs-string">'Module "'</span></span> + name + <span class="hljs-string"><span class="hljs-string">'" not configured'</span></span>; $log.error(errorText); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> errorText; } }</code> </pre><br>  We need a function to get the dependencies of the module: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRequires</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requires = []; angular.forEach(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.requires, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">requireModule</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(regModules.indexOf(requireModule) === <span class="hljs-number"><span class="hljs-number">-1</span></span>) { requires.push(requireModule); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> requires; }</code> </pre><br>  We also need a function to check whether a specific module was previously loaded, in case we missed something from the moment of initialization to the present.  There is no ‚Äúclean‚Äù way to do this, so you have to use the ‚Äúdirty‚Äù one: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">moduleExists</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { angular.module(moduleName); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-regexp"><span class="hljs-regexp">/No module/</span></span>.test(e) || (e.message.indexOf(<span class="hljs-string"><span class="hljs-string">'$injector:nomod'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br>  Now we can write a function that will load the dependencies of the new module.  It will immediately return control if the module has been loaded before or fill in the variable <code>moduleCache</code> to get a list of new modules and their dependencies for registration. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadDependencies</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleName, allDependencyLoad</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(regModules.indexOf(moduleName) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allDependencyLoad(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loadedModule = angular.module(moduleName), requires = getRequires(loadedModule); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onModuleLoad</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleLoaded</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(moduleLoaded) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = requires.indexOf(moduleLoaded); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(index &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { requires.splice(index, <span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(requires.length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { $timeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ allDependencyLoad(moduleName); }); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requireNeeded = getRequires(loadedModule); angular.forEach(requireNeeded, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">requireModule</span></span></span><span class="hljs-function">) </span></span>{ moduleCache.push(requireModule); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(moduleExists(requireModule)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> onModuleLoad(requireModule); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requireModuleConfig = self.getConfig(requireModule); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(requireModuleConfig &amp;&amp; (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> requireModuleConfig.files !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>)) { asyncLoader(requireModuleConfig.files, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ loadDependencies(requireModule, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requireModuleLoaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ onModuleLoad(name); }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $log.warn(<span class="hljs-string"><span class="hljs-string">'module "'</span></span> + requireModule + <span class="hljs-string"><span class="hljs-string">"' not loaded and not configured"</span></span>); onModuleLoad(requireModule); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(requireNeeded.length === <span class="hljs-number"><span class="hljs-number">0</span></span>) { onModuleLoad(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br>  In the end, we need to call an asynchronous loader that loads the dependencies and registers them. <br><pre> <code class="javascript hljs">asyncLoader(config.files, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ moduleCache.push(name); loadDependencies(name, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ register(providers, moduleCache, $log); $timeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ deferred.resolve(config); }); }); });</code> </pre><br>  We made it, now it is possible to load modules on demand !!! <br><pre> <code class="javascript hljs">$ocLazyLoad.load({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'TestModule'</span></span>, <span class="hljs-attr"><span class="hljs-attr">files</span></span>: [<span class="hljs-string"><span class="hljs-string">'js/testModule.js'</span></span>] }).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'done!'</span></span>); });</code> </pre><br><h4>  Use directive </h4><br>  We should be able to load the module through a directive.  To do this, we will use the <code>template</code> parameter that we mentioned earlier.  This template will replace the directive. <br>  We will use the <code>$templateCache</code> service to prevent the loading of templates that already exist in the cache of our application. <br>  The directive will be called as follows: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">oc-lazy-load</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"{name: 'TestModule', files: ['js/testModule.js'], template: 'partials/testLazyLoad.html'}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  If we have defined the configuration of the <code>TestModule</code> module in the provider settings, we can call our directive as follows: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">oc-lazy-load</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'TestModule'"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Writing a directive is not the purpose of this article, so I‚Äôll skip its description.  An important part of the directive is to download a new template by its url, or from the cache, if it was loaded earlier: <br><pre> <code class="javascript hljs">ocLazyLoad.directive(<span class="hljs-string"><span class="hljs-string">'ocLazyLoad'</span></span>, [<span class="hljs-string"><span class="hljs-string">'$http'</span></span>, <span class="hljs-string"><span class="hljs-string">'$log'</span></span>, <span class="hljs-string"><span class="hljs-string">'$ocLazyLoad'</span></span>, <span class="hljs-string"><span class="hljs-string">'$compile'</span></span>, <span class="hljs-string"><span class="hljs-string">'$timeout'</span></span>, <span class="hljs-string"><span class="hljs-string">'$templateCache'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$http, $log, $ocLazyLoad, $compile, $timeout, $templateCache</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">link</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">scope, element, attr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> childScope; <span class="hljs-comment"><span class="hljs-comment">/** * Destroy the current scope of this element and empty the html */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearContent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(childScope) { childScope.$destroy(); childScope = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } element.html(<span class="hljs-string"><span class="hljs-string">''</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * Load a template from cache or url * @param url * @param callback */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadTemplate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, callback</span></span></span><span class="hljs-function">) </span></span>{ scope.$apply(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> view; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(view = $templateCache.get(url)) !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { scope.$evalAsync(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ callback(view); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $http.get(url) .success(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ $templateCache.put(<span class="hljs-string"><span class="hljs-string">'view:'</span></span> + url, data); scope.$evalAsync(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ callback(data); }); }) .error(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ $log.error(<span class="hljs-string"><span class="hljs-string">'Error load template "'</span></span> + url + <span class="hljs-string"><span class="hljs-string">"': "</span></span> + data); }); } }); } scope.$watch(attr.ocLazyLoad, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(moduleName) { $ocLazyLoad.load(moduleName).then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">moduleConfig</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!moduleConfig.template) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } loadTemplate(moduleConfig.template, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">template</span></span></span><span class="hljs-function">) </span></span>{ childScope = scope.$<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(); element.html(template); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> content = element.contents(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> linkFn = $compile(content); $timeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ linkFn(childScope); }); }); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { clearContent(); } }); } }; }]);</code> </pre><br><h4>  Integration of our service with ui-router </h4><br>  Delayed loading of modules usually occurs when you load a new route.  Let's see how you can do it with <a href="https://github.com/angular-ui/ui-router">ui-router</a> (but it will work with <code>ng-route</code> ). <br>  Since we can load our module using a service or a directive, we can use two options: use the <code>resolve</code> object or use a template. <br>  Using the service requires the use of the <code>resolve</code> object.  The <code>resolve</code> object allows you to define some parameters for your route, and is called before loading the template.  This is important, the template can use a controller that performs deferred loading. <br>  Each parameter to the <code>resolve</code> function allows the promise to determine how it should be allowed.  Since our loading function returns a promise, we can simply use it.  Here the <code>views</code> part is mandatory, this is just for this example. <br><pre> <code class="javascript hljs">$stateProvider.state(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-comment"><span class="hljs-comment">// root route views: { "lazyLoadView": { templateUrl: 'partials/testLazyLoad.html' } }, resolve: { test: ['$ocLazyLoad', function($ocLazyLoad) { return $ocLazyLoad.load({ name: 'TestModule', files: ['js/testModule.js'] }); }] } });</span></span></code> </pre><br>  Using the directive is also simple: <br><pre> <code class="javascript hljs">$stateProvider.state(<span class="hljs-string"><span class="hljs-string">'index'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-string"><span class="hljs-string">"/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">views</span></span>: { <span class="hljs-string"><span class="hljs-string">"lazyLoadView"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">template</span></span>: <span class="hljs-string"><span class="hljs-string">'&lt;div oc-lazy-load="{name: \'TestModule\', files: [\'js/testModule.js\'], template: \'partials/testLazyLoad.html\'}"&gt;&lt;/div&gt;'</span></span> } } });</code> </pre><br>  I think this is a bit less optimal than using the function <code>resolve</code> , since we added a complex layer, but this can be very useful in some cases. <br>  Here we are done.  I hope you find this delayed bootloader useful! <br>  Fully working example you can look at <a href="http://plnkr.co/edit/aGxuXMiPgYA0TFc67YL4">Plunkr</a> . <br>  You can also look at all the code and an example on <a href="https://github.com/ocombe/ocLazyLoad">github</a> . <br>  I used <a href="http://ngmodules.org/modules/loadOnDemand">this angular module</a> as a base for my project, but I greatly improved it by adding new features that I needed. </div><p>Source: <a href="https://habr.com/ru/post/208164/">https://habr.com/ru/post/208164/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208148/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 90 (December 29 - January 4, 2014)</a></li>
<li><a href="../208150/index.html">Another brilliant idea in the style of a crowdfude TK text game</a></li>
<li><a href="../208152/index.html">vmware esxi 4.1 and ntp attacks</a></li>
<li><a href="../208154/index.html">Why behind the market share of 80% only half of smartphone users can hide</a></li>
<li><a href="../208160/index.html">Worldwide database of passwords for Wi-Fi networks on your mobile phone</a></li>
<li><a href="../208170/index.html">What developers are NOT talking about or 7 favorite programmer expressions</a></li>
<li><a href="../208172/index.html">10 rules of the Zen programmer</a></li>
<li><a href="../208174/index.html">Pattern recognition. Potential function method</a></li>
<li><a href="../208176/index.html">Tribute to HIEW</a></li>
<li><a href="../208178/index.html">Generation of random numbers of high digit capacity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>