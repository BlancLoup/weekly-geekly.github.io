<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Magento Enterprise: What is Full Page Cache and why is it needed?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Magento Enterprise: What is Full Page Cache and why it is needed. 

 For those who are familiar with Magento, it is not a secret that this e-commerce ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Magento Enterprise: What is Full Page Cache and why is it needed?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/12d/5b4/b83/12d5b4b83c0043cefab6d1505764acaa.png" alt="Magento Enterprise - Full Page Cache"><br><br><h2>  Magento Enterprise: What is Full Page Cache and why it is needed. </h2><br><br>  For those who are familiar with Magento, it is not a secret that this e-commerce engine is quite demanding on hardware.  But the developers of this online store tried to solve this problem and came up with many different kinds of "accelerators", without which, perhaps, launching a store on the Magento engine in production is not worth it.  For too long, Magento will give the page to the end user.  Among such "accelerators" are caches, indices, compilation, combining JS / CSS into one compressed file, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      One of the main "chips" Magento Enterprise is Full Page Cache (hereinafter referred to as FPC).  This "chip" implements the module Enterprise_PageCache, which is part of the package Magento Enterprise. <br><br>  The article discusses the latest version of Magento Enterprise at the time of this writing: 1.13.1. <br><br>  FPC allows you to give the server a page in milliseconds, practically without loading the server.  I spent time measuring the return time of the product page by the server (in one of the projects I was working on), here are the results: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d32/cad/23d/d32cad23d249b8ce6f954ebbde271ded.png" alt="Magento Enterprise - FPC"><br><br><ul><li>  65 ms with FPC enabled (when all blocks have been cached); </li><li>  1250 ms with FPC turned off (with all other types of cache turned on); </li><li>  2500 ms with all types of cache disabled. </li></ul><br>  Why is the difference so great?  Let's figure it out. <br><a name="habracut"></a><br><h2>  What and when to cache FPC </h2><br>  As the name implies, Full Page Cache caches the entire page.  But not all pages are cached.  At least, because there is no point for it.  By default, only product pages, category pages, CMS pages and a 404 error page (page not found) are cached.  This can be seen by looking at the module configuration (config.xml): <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frontend</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requests</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">_no_route</span></span></span><span class="hljs-tag">&gt;</span></span>enterprise_pagecache/processor_noroute<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">_no_route</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cms</span></span></span><span class="hljs-tag">&gt;</span></span>enterprise_pagecache/processor_default<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cms</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">catalog</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">view</span></span></span><span class="hljs-tag">&gt;</span></span>enterprise_pagecache/processor_category<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">view</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">catalog</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">catalog</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">view</span></span></span><span class="hljs-tag">&gt;</span></span>enterprise_pagecache/processor_product<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">view</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">catalog</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requests</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frontend</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  In the frontend / cache / requests section, here is the frontName of the module controller (its value is stored in the module configuration along the path: frontend / routers / route_name / args / frontName), then the controller and the action (controller and action are optional parameters).  And the transmitted value is the request processor. <br><br>  In the same way, you can force the caching of the controllers / controller / action of your module; it is enough to add data to the necessary section in the same way as the Enterprise_PageCache module does.  Example: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frontend</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requests</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">productinfo</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">index</span></span></span><span class="hljs-tag">&gt;</span></span>enterprise_pagecache/processor_default<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">index</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">productinfo</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requests</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">frontend</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  At the same time there are a number of conditions under which FPC does not cache pages.  For example, HTTPS pages, pages with the GET parameter no_cache are not cached.  The canProcessRequest and isAllowed methods of the Enterprise_PageCache_Model_Processor class: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Do basic validation for request to be cached * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Zend_Controller_Request_Http $request * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canProcessRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Zend_Controller_Request_Http $request)</span></span></span><span class="hljs-function"> </span></span>{ $res = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isAllowed(); $res = $res &amp;&amp; Mage::app()-&gt;useCache(<span class="hljs-string"><span class="hljs-string">'full_page'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($request-&gt;getParam(<span class="hljs-string"><span class="hljs-string">'no_cache'</span></span>)) { $res = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($res) { $maxDepth = Mage::getStoreConfig(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::XML_PATH_ALLOWED_DEPTH); $queryParams = $request-&gt;getQuery(); <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($queryParams[Enterprise_PageCache_Model_Cache::REQUEST_MESSAGE_GET_PARAM]); $res = count($queryParams)&lt;=$maxDepth; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($res) { $multicurrency = Mage::getStoreConfig(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::XML_PATH_CACHE_MULTICURRENCY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$multicurrency &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_COOKIE[<span class="hljs-string"><span class="hljs-string">'currency'</span></span>])) { $res = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $res; }</code> </pre><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Check if processor is allowed for current HTTP request. * Disable processing HTTPS requests and requests with "NO_CACHE" cookie * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAllowed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_requestId) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTPS'</span></span>]) &amp;&amp; $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTPS'</span></span>] == <span class="hljs-string"><span class="hljs-string">'on'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_COOKIE[<span class="hljs-string"><span class="hljs-string">'NO_CACHE'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[<span class="hljs-string"><span class="hljs-string">'no_cache'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_GET[Mage_Core_Model_Session_Abstract::SESSION_ID_QUERY_PARAM])) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Mage::app()-&gt;useCache(<span class="hljs-string"><span class="hljs-string">'full_page'</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br><br><h2>  How does FPC work </h2><br>  If the page is cached by the FPC cache, the FPC disables the standard block cache.  See the process_PreDispatch method of the Enterprise_PageCache_Model_Observer class, which is triggered when the controller_action_predispatch event occurs: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Check when cache should be disabled * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Varien_Event_Observer $observer * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Enterprise_PageCache_Model_Observer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processPreDispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Varien_Event_Observer $observer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isCacheEnabled()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } $action = $observer-&gt;getEvent()-&gt;getControllerAction(); <span class="hljs-comment"><span class="hljs-comment">/* </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $request Mage_Core_Controller_Request_Http */</span></span> $request = $action-&gt;getRequest(); $noCache = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getCookie()-&gt;get(Enterprise_PageCache_Model_Processor::NO_CACHE_COOKIE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($noCache) { Mage::getSingleton(<span class="hljs-string"><span class="hljs-string">'catalog/session'</span></span>)-&gt;setParamsMemorizeDisabled(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getCookie()-&gt;renew(Enterprise_PageCache_Model_Processor::NO_CACHE_COOKIE); } <span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($action) { Mage::getSingleton(<span class="hljs-string"><span class="hljs-string">'catalog/session'</span></span>)-&gt;setParamsMemorizeDisabled(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** * Check if request will be cached */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_processor-&gt;canProcessRequest($request)) { Mage::app()-&gt;getCacheInstance()-&gt;banUse(Mage_Core_Block_Abstract::CACHE_GROUP); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getCookie()-&gt;updateCustomerCookies(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  FPC generates for each HTTP request its cache identifier, which will be used to save the page to the cache.  The cache identifier depends on several parameters: whether the user is authorized or not, which segments it belongs to, which group of users it belongs to, etc. You can see how this identifier is generated in the _ _ _ _ _ _; _RequestIds method of the Enterprise_PageCache_Model_Processor class: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Populate request ids * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Enterprise_PageCache_Model_Processor */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_createRequestIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $uri = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getFullPageUrl(); <span class="hljs-comment"><span class="hljs-comment">//Removing get params $pieces = explode('?', $uri); $uri = array_shift($pieces); /** * Define COOKIE state */ if ($uri) { if (isset($_COOKIE['store'])) { $uri = $uri.'_'.$_COOKIE['store']; } if (isset($_COOKIE['currency'])) { $uri = $uri.'_'.$_COOKIE['currency']; } if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP])) { $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP]; } if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN])) { $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN]; } if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS])) { $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS]; } if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::IS_USER_ALLOWED_SAVE_COOKIE])) { $uri .= '_' . $_COOKIE[Enterprise_PageCache_Model_Cookie::IS_USER_ALLOWED_SAVE_COOKIE]; } $designPackage = $this-&gt;_getDesignPackage(); if ($designPackage) { $uri .= '_' . $designPackage; } } $this-&gt;_requestId = $uri; $this-&gt;_requestCacheId = $this-&gt;prepareCacheId($this-&gt;_requestId); return $this; }</span></span></code> </pre><br><br>  FPC uses placeholders.  They are added to Magento using the cache.xml configuration file in the etc folder of the module.  A placeholder is handled by a placeholder container.  The container is the class that the placeholder will process during the FPC rendering (the rendering process of the block by the FPC cache is different from the usual rendering of the block).  An example of the cache.xml file: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">placeholders</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">turnkeye_popup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span>turnkeye_popup/popup<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">placeholder</span></span></span><span class="hljs-tag">&gt;</span></span>POPUP<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">placeholder</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">container</span></span></span><span class="hljs-tag">&gt;</span></span>Turnkeye_Popup_Model_PageCache_Container_Popup<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">container</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache_lifetime</span></span></span><span class="hljs-tag">&gt;</span></span>86400<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">cache_lifetime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">turnkeye_popup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">placeholders</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">config</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Briefly about the configuration of the placeholder: <br><br><ul><li>  block - block type or class </li><li>  placeholder - name of the placeholder </li><li>  container - type or class of placeholder container </li><li>  cache_lifetime - cache lifetime </li></ul><br>  During rendering, with FPC turned on, the contents of each block are wrapped with a placeholder and cached: when the core_block_abstract_to_html_after event fires, the renderBlockPlaceholder method of the Enterprise_PageCache_Model_Observer class is executed: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Render placeholder tags around the block if needed * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Varien_Event_Observer $observer * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Enterprise_PageCache_Model_Observer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderBlockPlaceholder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Varien_Event_Observer $observer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_isEnabled) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } $block = $observer-&gt;getEvent()-&gt;getBlock(); $transport = $observer-&gt;getEvent()-&gt;getTransport(); $placeholder = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_config-&gt;getBlockPlaceholder($block); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($transport &amp;&amp; $placeholder &amp;&amp; !$block-&gt;getSkipRenderTag()) { $blockHtml = $transport-&gt;getHtml(); $request = Mage::app()-&gt;getFrontController()-&gt;getRequest(); <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $processor Enterprise_PageCache_Model_Processor_Default */</span></span> $processor = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_processor-&gt;getRequestProcessor($request); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($processor &amp;&amp; $processor-&gt;allowCache($request)) { $container = $placeholder-&gt;getContainerClass(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($container &amp;&amp; !Mage::getIsDeveloperMode()) { $container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $container($placeholder); $container-&gt;setProcessor(Mage::getSingleton(<span class="hljs-string"><span class="hljs-string">'enterprise_pagecache/processor'</span></span>)); $container-&gt;setPlaceholderBlock($block); $container-&gt;saveCache($blockHtml); } } $blockHtml = $placeholder-&gt;getStartTag() . $blockHtml . $placeholder-&gt;getEndTag(); $transport-&gt;setHtml($blockHtml); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  Here $ placeholder is obtained using the Enterprise_PageCache_Model_Config class using the getBlockPlaceholder method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Create placeholder object based on block information * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Mage_Core_Block_Abstract $block * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Enterprise_PageCache_Model_Container_Placeholder */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBlockPlaceholder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($block)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_initPlaceholders(); $type = $block-&gt;getType(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholders[$type])) { $placeholderData = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholders[$type] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $placeholderInfo) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($placeholderInfo[<span class="hljs-string"><span class="hljs-string">'name'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($placeholderInfo[<span class="hljs-string"><span class="hljs-string">'name'</span></span>] == $block-&gt;getNameInLayout()) { $placeholderData = $placeholderInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $placeholderData = $placeholderInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$placeholderData) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $placeholder = $placeholderData[<span class="hljs-string"><span class="hljs-string">'code'</span></span>] . <span class="hljs-string"><span class="hljs-string">' container="'</span></span> . $placeholderData[<span class="hljs-string"><span class="hljs-string">'container'</span></span>] . <span class="hljs-string"><span class="hljs-string">'"'</span></span> . <span class="hljs-string"><span class="hljs-string">' block="'</span></span> . get_class($block) . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; $placeholder.= <span class="hljs-string"><span class="hljs-string">' cache_id="'</span></span> . $block-&gt;getCacheKey() . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($placeholderData[<span class="hljs-string"><span class="hljs-string">'cache_lifetime'</span></span>])) { $placeholder .= <span class="hljs-string"><span class="hljs-string">' cache_lifetime="'</span></span> . $placeholderData[<span class="hljs-string"><span class="hljs-string">'cache_lifetime'</span></span>] . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($block-&gt;getCacheKeyInfo() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $k =&gt; $v) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_string($k) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($k)) { $placeholder .= <span class="hljs-string"><span class="hljs-string">' '</span></span> . $k . <span class="hljs-string"><span class="hljs-string">'="'</span></span> . $v . <span class="hljs-string"><span class="hljs-string">'"'</span></span>; } } $placeholder = Mage::getModel(<span class="hljs-string"><span class="hljs-string">'enterprise_pagecache/container_placeholder'</span></span>, $placeholder); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $placeholder; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br><br>  The constructor for the Enterprise_PageCache_Model_Container_Placeholder class is: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Class constructor. * Initialize placeholder name and attributes based on definition * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $definition */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($definition)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($definition &amp;&amp; array_key_exists($definition, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_definitionMap)) { $definition = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_definitionMap[$definition]; } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_definition = $definition; $definition = explode(<span class="hljs-string"><span class="hljs-string">' '</span></span>, $definition); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_name = $definition[<span class="hljs-number"><span class="hljs-number">0</span></span>]; $count = count($definition); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($count&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i=<span class="hljs-number"><span class="hljs-number">1</span></span>; $i_attributes[$info[<span class="hljs-number"><span class="hljs-number">0</span></span>]] = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($info[<span class="hljs-number"><span class="hljs-number">1</span></span>]) ? trim($info[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'"\''</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } }</code> </pre><br><br>  In the future, it will be possible to get block attributes in the container class using the getAttribute method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Get attribute by specific code * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $code string * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAttribute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($code)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_attributes[$code]) ? <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_attributes[$code] : <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br><br>  Methods for wrapping content block wrapper: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Retrieve placeholder definition hash * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getDefinitionHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $definition = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getDefinition(); $result = array_search($definition, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_definitionMap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($result === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $result = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getName() . <span class="hljs-string"><span class="hljs-string">'_'</span></span> . md5($definition); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::$_definitionMap[$result] = $definition; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $result; } <span class="hljs-comment"><span class="hljs-comment">/** * Get placeholder start tag for block html generation * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getStartTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;!--{'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getDefinitionHash() . <span class="hljs-string"><span class="hljs-string">'}--&gt;'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Get placeholder end tag for block html generation * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEndTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;!--/{'</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getDefinitionHash() . <span class="hljs-string"><span class="hljs-string">'}--&gt;'</span></span>; }</code> </pre><br><br>  Example of a wrapper content wrapper block content: <br><br><pre> <code class="php hljs">&lt; !--{TOPMENU_21c7f778e21d072d331836703b6295f5}--&gt; &lt; div <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nav</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">container</span></span></span><span class="hljs-class">"&gt; &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nav</span></span></span><span class="hljs-class">"&gt; &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">level0</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nav</span></span></span><span class="hljs-class">-1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">first</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">last</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">level</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">top</span></span></span><span class="hljs-class">"&gt; &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">level</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">top</span></span></span><span class="hljs-class">" </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">href</span></span></span><span class="hljs-class">="</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">://</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">example</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">category</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">html</span></span></span><span class="hljs-class">"&gt; &lt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Test</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">category</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">span</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">li</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ul</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">div</span></span></span><span class="hljs-class">&gt; &lt; !--/</span></span>{TOPMENU_21c7f778e21d072d331836703b6295f5}--&gt;</code> </pre><br><br>  Before a response is sent to the request, the controller_front_send_response_before event is fired and the cacheResponse method of the Enterprise_PageCache_Model_Observer class is executed, which saves the page to the cache, if necessary.  The code for the cacheResponse method is: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Save page body to cache storage * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Varien_Event_Observer $observer * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Enterprise_PageCache_Model_Observer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cacheResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Varien_Event_Observer $observer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;isCacheEnabled()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; } $frontController = $observer-&gt;getEvent()-&gt;getFront(); $request = $frontController-&gt;getRequest(); $response = $frontController-&gt;getResponse(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_saveDesignException(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_processor-&gt;processRequestResponse($request, $response); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>; }</code> </pre><br><br>  Here, the processRequestResponse method saves the entire page and the necessary data to the cache, if necessary: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Process response body by specific request * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Zend_Controller_Request_Http $request * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Zend_Controller_Response_Http $response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Enterprise_PageCache_Model_Processor */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processRequestResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Zend_Controller_Request_Http $request, Zend_Controller_Response_Http $response )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// we should add original path info tag as another way we can't drop some entities from cron job $this-&gt;addRequestTag(Enterprise_PageCache_Helper_Url::prepareRequestPathTag($request-&gt;getOriginalPathInfo())); $cacheInstance = Enterprise_PageCache_Model_Cache::getCacheInstance(); /** * Basic validation for request processing */ if ($this-&gt;canProcessRequest($request)) { $processor = $this-&gt;getRequestProcessor($request); if ($processor &amp;&amp; $processor-&gt;allowCache($request)) { $this-&gt;setMetadata('cache_subprocessor', get_class($processor)); $cacheId = $this-&gt;prepareCacheId($processor-&gt;getPageIdInApp($this)); $content = $processor-&gt;prepareContent($response); /** * Replace all occurrences of session_id with unique marker */ Enterprise_PageCache_Helper_Url::replaceSid($content); Enterprise_PageCache_Helper_Form_Key::replaceFormKey($content); if (function_exists('gzcompress')) { $content = gzcompress($content); } $contentSize = strlen($content); $currentStorageSize = (int) $cacheInstance-&gt;load(self::CACHE_SIZE_KEY); if (Mage::getStoreConfig(Enterprise_PageCache_Model_Processor::XML_PATH_CACHE_DEBUG)) { $response-&gt;setBody(implode(', ', $this-&gt;getRequestTags()) . $response-&gt;getBody()); } $maxSizeInBytes = Mage::getStoreConfig(self::XML_PATH_CACHE_MAX_SIZE) * 1024 * 1024; if ($currentStorageSize &gt;= $maxSizeInBytes) { Mage::app()-&gt;getCacheInstance()-&gt;invalidateType('full_page'); return $this; } $cacheInstance-&gt;save($content, $cacheId, $this-&gt;getRequestTags()); $cacheInstance-&gt;save( $currentStorageSize + $contentSize, self::CACHE_SIZE_KEY, $this-&gt;getRequestTags() ); /* * Save design change in cache */ $designChange = Mage::getSingleton('core/design'); if ($designChange-&gt;getData()) { $cacheInstance-&gt;save( serialize($designChange-&gt;getData()), $this-&gt;getRequestCacheId() . self::DESIGN_CHANGE_CACHE_SUFFIX, $this-&gt;getRequestTags() ); } // save response headers $this-&gt;setMetadata('response_headers', $response-&gt;getHeaders()); // save original routing info $this-&gt;setMetadata('routing_aliases', Mage::app()-&gt;getRequest()-&gt;getAliases()); $this-&gt;setMetadata('routing_requested_route', Mage::app()-&gt;getRequest()-&gt;getRequestedRouteName()); $this-&gt;setMetadata('routing_requested_controller', Mage::app()-&gt;getRequest()-&gt;getRequestedControllerName()); $this-&gt;setMetadata('routing_requested_action', Mage::app()-&gt;getRequest()-&gt;getRequestedActionName()); $this-&gt;setMetadata('sid_cookie_name', Mage::getSingleton('core/session')-&gt;getSessionName()); Mage::dispatchEvent('pagecache_processor_metadata_before_save', array('processor' =&gt; $this)); $this-&gt;_saveMetadata(); } if (isset($_GET[Mage_Core_Model_Session_Abstract::SESSION_ID_QUERY_PARAM])) { Mage::getSingleton('enterprise_pagecache/cookie')-&gt;updateCustomerCookies(); Mage::getModel('enterprise_pagecache/observer')-&gt;updateCustomerProductIndex(); } } return $this; }</span></span></code> </pre><br><br>  Here, a very important point is that before storing the page cache, the contents of the blocks with the placeholder are replaced with the block description: $ content = $ processor-&gt; prepareContent ($ response) ;.  PrepareContent method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Prepare response body before caching * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Zend_Controller_Response_Http $response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Zend_Controller_Response_Http $response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;replaceContentToPlaceholderReplacer($response-&gt;getBody()); }</code> </pre><br><br>  The replaceContentToPlaceholderReplacer method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Replace block content to placeholder replacer * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $content * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceContentToPlaceholderReplacer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($content)</span></span></span><span class="hljs-function"> </span></span>{ $placeholders = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); preg_match_all( Enterprise_PageCache_Model_Container_Placeholder::HTML_NAME_PATTERN, $content, $placeholders, PREG_PATTERN_ORDER ); $placeholders = array_unique($placeholders[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($placeholders <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $definition) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder = Mage::getModel(<span class="hljs-string"><span class="hljs-string">'enterprise_pagecache/container_placeholder'</span></span>, $definition); $content = preg_replace_callback(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder-&gt;getPattern(), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>, <span class="hljs-string"><span class="hljs-string">'_getPlaceholderReplacer'</span></span>), $content); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> $e; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $content; }</code> </pre><br><br>  As a result, the page cache will contain information about the block instead of the block contents.  This information will help to render the block in the future.  Here is an example of such information that FPC will replace with the block contents during its rendering: <br><br><pre> <code class="php hljs">&lt; !--{POPUP container=<span class="hljs-string"><span class="hljs-string">"Turnkeye_Popup_Model_PageCache_Container_Popup"</span></span> block=<span class="hljs-string"><span class="hljs-string">"Turnkeye_Popup_Block_Popup"</span></span> cache_id=<span class="hljs-string"><span class="hljs-string">"c3b32091a1ebd3b276a8fd70496a8e6da20865d0"</span></span> cache_lifetime=<span class="hljs-string"><span class="hljs-string">"86400"</span></span> template=<span class="hljs-string"><span class="hljs-string">"turnkeye/popup/popup.phtml"</span></span> handles=<span class="hljs-string"><span class="hljs-string">"a:2:{i:0;s:15:"</span></span>cms_index_index<span class="hljs-string"><span class="hljs-string">";i:1;s:8:"</span></span>cms_page<span class="hljs-string"><span class="hljs-string">";}"</span></span> customer_segment_ids=<span class="hljs-string"><span class="hljs-string">"a:1:{i:0;i:0;}"</span></span> popup_ids=<span class="hljs-string"><span class="hljs-string">"a:1:{i:0;s:1:"</span></span><span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">";}"</span></span> excluded_popup_ids=<span class="hljs-string"><span class="hljs-string">"a:1:{i:0;i:1;}"</span></span>}--&gt;</code> </pre><br><br>  The next time this page is loaded, Magento will load this page from the cache (see the EnterpriseConageCache_Model_Processor class extractContent method).  If the cache is empty - the usual rendering with the initialization of Magento (as if the FPC was not), followed by saving the page to the cache.  If the page is in the cache, the FPC will process the content from this cache. <br><br>  The _processContent and _processContainers methods of the Enterprise_PageCache_Model_Processor class: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Determine and process all defined containers. * Direct request to pagecache/request/process action if necessary for additional processing * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $content * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string|false */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_processContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($content)</span></span></span><span class="hljs-function"> </span></span>{ $containers = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_processContainers($content); $isProcessed = <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($containers); <span class="hljs-comment"><span class="hljs-comment">// renew session cookie $sessionInfo = Enterprise_PageCache_Model_Cache::getCacheInstance()-&gt;load($this-&gt;getSessionInfoCacheId()); if ($sessionInfo) { $sessionInfo = unserialize($sessionInfo); foreach ($sessionInfo as $cookieName =&gt; $cookieInfo) { if (isset($_COOKIE[$cookieName]) &amp;&amp; isset($cookieInfo['lifetime']) &amp;&amp; isset($cookieInfo['path']) &amp;&amp; isset($cookieInfo['domain']) &amp;&amp; isset($cookieInfo['secure']) &amp;&amp; isset($cookieInfo['httponly']) ) { $lifeTime = (0 == $cookieInfo['lifetime']) ? 0 : time() + $cookieInfo['lifetime']; setcookie($cookieName, $_COOKIE[$cookieName], $lifeTime, $cookieInfo['path'], $cookieInfo['domain'], $cookieInfo['secure'], $cookieInfo['httponly'] ); } } } else { $isProcessed = false; } if (isset($_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_FORM_KEY])) { $formKey = $_COOKIE[Enterprise_PageCache_Model_Cookie::COOKIE_FORM_KEY]; } else { $formKey = Enterprise_PageCache_Helper_Data::getRandomString(16); Enterprise_PageCache_Model_Cookie::setFormKeyCookieValue($formKey); } Enterprise_PageCache_Helper_Form_Key::restoreFormKey($content, $formKey); /** * restore session_id in content whether content is completely processed or not */ $sidCookieName = $this-&gt;getMetadata('sid_cookie_name'); $sidCookieValue = $sidCookieName &amp;&amp; isset($_COOKIE[$sidCookieName]) ? $_COOKIE[$sidCookieName] : ''; // XSS vulnerability protection provided by htmlspcialchars call - escape &amp; " ' &lt; &gt; chars Enterprise_PageCache_Helper_Url::restoreSid($content, htmlspecialchars($sidCookieValue, ENT_QUOTES)); if ($isProcessed) { return $content; } else { Mage::register('cached_page_content', $content); Mage::register('cached_page_containers', $containers); Mage::app()-&gt;getRequest() -&gt;setModuleName('pagecache') -&gt;setControllerName('request') -&gt;setActionName('process') -&gt;isStraight(true); // restore original routing info $routingInfo = array( 'aliases' =&gt; $this-&gt;getMetadata('routing_aliases'), 'requested_route' =&gt; $this-&gt;getMetadata('routing_requested_route'), 'requested_controller' =&gt; $this-&gt;getMetadata('routing_requested_controller'), 'requested_action' =&gt; $this-&gt;getMetadata('routing_requested_action') ); Mage::app()-&gt;getRequest()-&gt;setRoutingInfo($routingInfo); return false; } }</span></span></code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Process Containers * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $content * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_processContainers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$content)</span></span></span><span class="hljs-function"> </span></span>{ $placeholders = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); preg_match_all( Enterprise_PageCache_Model_Container_Placeholder::HTML_NAME_PATTERN, $content, $placeholders, PREG_PATTERN_ORDER ); $placeholders = array_unique($placeholders[<span class="hljs-number"><span class="hljs-number">1</span></span>]); $containers = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($placeholders <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $definition) { $placeholder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Enterprise_PageCache_Model_Container_Placeholder($definition); $container = $placeholder-&gt;getContainerClass(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$container) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } $container = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $container($placeholder); $container-&gt;setProcessor(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$container-&gt;applyWithoutApp($content)) { $containers[] = $container; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { preg_match($placeholder-&gt;getPattern(), $content, $matches); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (array_key_exists(<span class="hljs-number"><span class="hljs-number">1</span></span>,$matches)) { $containers = array_merge(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_processContainers($matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]), $containers); $content = preg_replace($placeholder-&gt;getPattern(), str_replace(<span class="hljs-string"><span class="hljs-string">'$'</span></span>, <span class="hljs-string"><span class="hljs-string">'\\$'</span></span>, $matches[<span class="hljs-number"><span class="hljs-number">1</span></span>]), $content); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $containers; }</code> </pre><br><br>  As can be seen from the code of these methods, only blocks that have placeholders are processed.  If there is no placeholder for your block, its contents will not change.  Therefore, if you want to display dynamically changing blocks, then you need to create placeholders for them. <br><br>  Placeholder containers are first processed by the applyWithoutApp method.  This method attempts to replace the block contents in the cached page with the content we need.  An example of the applyWithoutApp method abstract for all containers of the class Enterprise_PageCache_Model_Container_Abstract: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Generate placeholder content before application was initialized and apply to page content if possible * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $content * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyWithoutApp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$content)</span></span></span><span class="hljs-function"> </span></span>{ $cacheId = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getCacheId(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($cacheId === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_applyToContent($content, <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } $block = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_loadCache($cacheId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($block === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } $block = Enterprise_PageCache_Helper_Url::replaceUenc($block); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_applyToContent($content, $block); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br><br>  From the code it is clear that if you want to change the block dynamically, you need to define the container _getCacheId method based on the logic of your block.  If at least one container was not processed (applyWithoutApp returned false), then it must be rendered (see the _processContent method of the Enterprise_PageCache_Model_Processor class), and Magento will be initialized (Mage :: app () will execute).  In this case, the request is processed by the Enterprise_PageCache_RequestController controller by the action process.  Process action code: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Request processing action */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $processor = Mage::getSingleton(<span class="hljs-string"><span class="hljs-string">'enterprise_pagecache/processor'</span></span>); $content = Mage::registry(<span class="hljs-string"><span class="hljs-string">'cached_page_content'</span></span>); $containers = Mage::registry(<span class="hljs-string"><span class="hljs-string">'cached_page_containers'</span></span>); $cacheInstance = Enterprise_PageCache_Model_Cache::getCacheInstance(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($containers <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $container) { $container-&gt;applyInApp($content); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getResponse()-&gt;appendBody($content); <span class="hljs-comment"><span class="hljs-comment">// save session cookie lifetime info $cacheId = $processor-&gt;getSessionInfoCacheId(); $sessionInfo = $cacheInstance-&gt;load($cacheId); if ($sessionInfo) { $sessionInfo = unserialize($sessionInfo); } else { $sessionInfo = array(); } $session = Mage::getSingleton('core/session'); $cookieName = $session-&gt;getSessionName(); $cookieInfo = array( 'lifetime' =&gt; $session-&gt;getCookie()-&gt;getLifetime(), 'path' =&gt; $session-&gt;getCookie()-&gt;getPath(), 'domain' =&gt; $session-&gt;getCookie()-&gt;getDomain(), 'secure' =&gt; $session-&gt;getCookie()-&gt;isSecure(), 'httponly' =&gt; $session-&gt;getCookie()-&gt;getHttponly(), ); if (!isset($sessionInfo[$cookieName]) || $sessionInfo[$cookieName] != $cookieInfo) { $sessionInfo[$cookieName] = $cookieInfo; // customer cookies have to be refreshed as well as the session cookie $sessionInfo[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER] = $cookieInfo; $sessionInfo[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_GROUP] = $cookieInfo; $sessionInfo[Enterprise_PageCache_Model_Cookie::COOKIE_CUSTOMER_LOGGED_IN] = $cookieInfo; $sessionInfo[Enterprise_PageCache_Model_Cookie::CUSTOMER_SEGMENT_IDS] = $cookieInfo; $sessionInfo[Enterprise_PageCache_Model_Cookie::COOKIE_MESSAGE] = $cookieInfo; $sessionInfo = serialize($sessionInfo); $cacheInstance-&gt;save($sessionInfo, $cacheId, array(Enterprise_PageCache_Model_Processor::CACHE_TAG)); } }</span></span></code> </pre><br><br>  For each unprocessed container, the applyInApp method is run, which must render the block and replace the contents of the placeholder in the content.  The code of the applyInApp method is abstract for containers of the class Enterprise_PageCache_Model_Container_Abstract: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Generate and apply container content in controller after application is initialized * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> string $content * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> bool */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyInApp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$content)</span></span></span><span class="hljs-function"> </span></span>{ $blockContent = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_renderBlock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($blockContent === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mage::getStoreConfig(Enterprise_PageCache_Model_Processor::XML_PATH_CACHE_DEBUG)) { $debugBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Enterprise_PageCache_Block_Debug(); $debugBlock-&gt;setDynamicBlockContent($blockContent); $debugBlock-&gt;setTags(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getPlaceHolderBlock()-&gt;getCacheTags()); $debugBlock-&gt;setType(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder-&gt;getName()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_applyToContent($content, $debugBlock-&gt;toHtml()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_applyToContent($content, $blockContent); } $subprocessor = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_processor-&gt;getSubprocessor(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($subprocessor) { $contentWithoutNestedBlocks = $subprocessor-&gt;replaceContentToPlaceholderReplacer($blockContent); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;saveCache($contentWithoutNestedBlocks); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; }</code> </pre><br><br>  Here, as we see, the content is obtained by the _renderBlock method of the container class.  This method is usually unique for each container and contains some special logic.  In the abstract class Enterprise_PageCache_Model_Container_Abstract for containers, this method returns false.  It should return the HTML content of the block. <br><br>  However, there is a problem with the rendering of containers.  For the container block, the parent could not be rendered, and the controller is executed by another.  This means that some data inside the block may not be present and this case must be considered (for example, you get the product in this way: $ product = Mage :: registry ('current_product'), or you set a property by the parent block: $ this-&gt; getChild ('block_alias') -&gt; setProduct ($ _ product)). <br><br>  But, as we remember, FPC saves all the information necessary for rendering.  Therefore, if you passed the information in the getCacheKeyInfo method of your block to be saved, you can set it during FPC rendering.  This should be done in the container _renderBlock method.  You can get a block instance in it using the _getPlaceHolderBlock method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Get Placeholder Block * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Mage_Core_Block_Abstract */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getPlaceHolderBlock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span> === <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholderBlock) { $blockName = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder-&gt;getAttribute(<span class="hljs-string"><span class="hljs-string">'block'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholderBlock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> $blockName; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholderBlock-&gt;setTemplate(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder-&gt;getAttribute(<span class="hljs-string"><span class="hljs-string">'template'</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholderBlock-&gt;setLayout(Mage::app()-&gt;getLayout()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholderBlock-&gt;setSkipRenderTag(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholderBlock; }</code> </pre><br><br>  As you can see, we get an instance of the block class with the template set.  An example of the _renderBlock method: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Render block content from placeholder * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> string|false */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_renderBlock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $block Turnkeye_Popup_Block_Popup */</span></span> $block = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getPlaceHolderBlock(); $placeholder = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_placeholder; $serializedParameters = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'handles'</span></span>, <span class="hljs-string"><span class="hljs-string">'popup_ids'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($serializedParameters <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $parameter) { $value = unserialize($placeholder-&gt;getAttribute($parameter)); $block-&gt;setDataUsingMethod($parameter, $value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $block-&gt;toHtml(); }</code> </pre><br><br>  Here, as can be seen from the code, we passed the parameters handles and popup_ids to the block.  In the block itself, they must be received like this: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPopupIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;hasData(<span class="hljs-string"><span class="hljs-string">'popup_ids'</span></span>)) { $popupIds = ... ... <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;setData(<span class="hljs-string"><span class="hljs-string">'popup_ids'</span></span>, $popupIds); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getData(<span class="hljs-string"><span class="hljs-string">'popup_ids'</span></span>); }</code> </pre><br><br>  I hope this article opened the veil of secrecy over the FPC functionality, and you learned how the FPC mechanism works from the inside. <br><br>  The cache is really efficient and works great, reducing the load on the server and ensuring fast operation of the online store with high attendance. <br><br>      FPC  ,        Magento Enterprise         FPC. </div><p>Source: <a href="https://habr.com/ru/post/214645/">https://habr.com/ru/post/214645/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214631/index.html">Apple CarPlay Application Design</a></li>
<li><a href="../214635/index.html">Recognition from a non-standard microphone</a></li>
<li><a href="../214637/index.html">Creating custom UIActivity for publishing photos and text on the social network VKontakte</a></li>
<li><a href="../214639/index.html">Online compiler for ASP.Net MVC</a></li>
<li><a href="../214643/index.html">Aggregates of multidimensional OLAP cubes in RAM</a></li>
<li><a href="../214647/index.html">PHP and various types of NoSQL</a></li>
<li><a href="../214649/index.html">Up! Plus 2. Overview: unpacking, calibration, analysis and first print</a></li>
<li><a href="../214651/index.html">Testing on the 1C: Enterprise 8 platform</a></li>
<li><a href="../214653/index.html">As we Russian firms investigated</a></li>
<li><a href="../214655/index.html">Sports robotics: an interview with a member of RobotChallenge 2014</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>