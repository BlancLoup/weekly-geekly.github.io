<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Another thermostat on Arduino, but with OpenTherm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Reading the first part of the heading, many of you probably thought - another thermostat on the long-suffering Arduino. And ... It's true - yes, this ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Another thermostat on Arduino, but with OpenTherm</h1><div class="post__text post__text-html js-mediator-article"><img height="200" width="200" src="https://habrastorage.org/files/531/057/338/53105733876d4483b6f08190f00b19b8.jpg"><br><br>  Reading the first part of the heading, many of you probably thought - another thermostat on the long-suffering Arduino.  And ... It's true - yes, this is another thermostat for the next boiler, the next house, but the truth is only partly - in the article I don‚Äôt want to concentrate on the device itself - there are really plenty of them (articles).  Undoubtedly, I will describe the thermostat, but I would like to tell you more about how I connected the microcontroller with the boiler itself.  So, who cares - please ... <br><a name="habracut"></a><br><h4>  How it all began </h4><br>  First of all, I want to say that I am not a programmer at all and have not dealt with this microcontroller before.  My first acquaintance with AVR MK (and indeed with MK) was still in high school when I wanted to find out how this mysterious thing still works.  I read several articles and since then I have only fragments left in my memory that could be described in just two words - DDR and PORT - and this was where my knowledge ended.  Then there was the university, the 5th year - ‚ÄúProgramming microcontrollers‚Äù where we all met MSC51 in a virtual environment.  There were already interrupts, timers, and everything else.  Well, with such a baggage of knowledge I came to the problem.  Let's finish on this autobiographical note and move on to the more interesting part. <br><br>  So, actually, how did the creation of the thermostat begin - after installing the autonomous heating with a gas boiler, I, like many, faced the usual problems - the temperature in the house was very dependent on the weather outside - frost - it was cold in the apartment, you need to increase the coolant temperature in battery powered, warmer - on the contrary.  Such dances with a tambourine did not suit me much, because  the adjustment of the boiler was complicated by the fact that it was installed behind the door, and the door was backed by a microwave, on which lay a pile of junk.  Well, you understand - a needle in an egg, an egg in a duck, etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This problem was solved very simply - with an OTC sensor (Outside Temperature Compensation), which connects to the boiler and allows it to automatically adjust the temperature of the heat carrier depending on the outdoor temperature.  The problem seemed to be solved, but reading the service manual on the boiler (Ferolli Domiproject C24D) quickly crushed my hope - the connection of the external temperature sensor in this model is not provided.  Everything?  Everything.  So, probably, it would be possible to finish it, but in the summer, in a thunderstorm, the control board is still burning in an unintelligible way to me, and talking to the service man (the board was subsequently repaired), I asked if it was possible to connect the OTC to my boiler?  He replied that they were connecting using external thermostats.  This was deposited in my memory, but I didn‚Äôt really concentrate on it until the onset of cold weather, and then the exact same problem. <br><br>  Leafing through the same service manual, but with the aim of seeing how the thermostat is connected, I noticed that the ‚ÄúOpenTherm controller‚Äù is connected to the same terminals.  Here I understood - this is IT!  Google search "OpenTherm Arduino" also disappointed me again - nothing particularly sensible.  There was a message monitor, but this is not the case - I‚Äôm listening to, there‚Äôs nothing - the thermostat is needed. <br><br>  Then I stumbled upon an article <a href="http://habrahabr.ru/post/214257/">habrahabr.ru/post/214257</a> , the end of which upset me - the author without an oscilloscope could not connect the boiler with a microcontroller.  And here, if a person‚Äôs acquaintance with MK didn‚Äôt work out, what should I try?  A full description of the Opentherm v2.2 protocol was found on the Internet, which further cooled my heat - the physical level of the protocol was somewhat complicated - a current loop in which data from the boiler is transmitted by the current level (5-7mA - low, 17-23mA - high) , and from the thermostat to the boiler the voltage level (&lt;7V - low level, 15-18V - high), which in turn will require a pairing circuit, and I am very close to electronics.  Plus, the data was transmitted by the Manchester code, that ... well, you understand. <br><br>  Only one conclusion - do not bother - just move the microwave and norms.  But I have one peculiarity in character - if you put a certain idea in your head, then sooner or later it will come true - yes, I will forget about it (this idea), but still it‚Äôs not going anywhere (it turned out to be the case with home). media center on XBMC, satellite to it, on a DVB card, and many, many other things).  You sleep, and the plan is already turning in your head, how to accept the Manchester code. <br><br>  So, I will briefly describe how the OT / + protocol works (in the article above, OT types are described).  Communication between devices takes place in a request-response format.  The initiator can only be a thermostat.  It sends a request at least 1 time per second and waits for a response from 20 to 800 ms.  The messages themselves are 32-bit with one start and one stop bit: <br><br>  Where MSG-TYPE is the message type for the thermostat: <br>  0x0 - READ-DATA ‚Äî read data; <br>  0x1 - WRITE-DATA - write; <br>  for the boiler: <br>  0x4 - READ-ACK - confirm reading (it comes the answer); <br>  0x5 - WRITE-ACK - confirm the record; <br>  0x6 - DATA-INVALID - the data is incorrect; <br>  0x7 - UNKNOWN-DATAID - there is no such DATA-ID. <br><br>  DATA-ID - parameter identifier.  The first 128 are reserved and most are already spelled out in the specification, the other 128 are each vendor using at their discretion. <br><br>  DATA-VALUE - actually, the value of the parameter itself.  It may be in a different format, depending on the parameter itself.  Two 8-bit flag values, an unsigned 16-bit integer, a fixed-point fractional, etc.  For each parameter, a value type is defined. <br><br>  For each FROM device, a set of parameters is defined, which it must support without fail: <br><table><tbody><tr><td>  Data id </td><td>  Description </td><td>  Thermostat </td><td>  Boiler </td></tr><tr><td>  0 </td><td>  Device Status Flags </td><td>  Must send a read request, with the required functions set in the high byte of the DATA-VALUE field </td><td>  Must respond to a request with status bits set in the low byte of the DATA-VALUE field </td></tr><tr><td>  one </td><td>  Setting the required temperature of the coolant </td><td>  Must send a write request with the required temperature value </td><td>  Must respond with confirmation that the required temperature is set. </td></tr><tr><td>  3 </td><td>  Boiler configuration </td><td>  Must read parameter </td><td>  Must respond to the request and support all functions transferred in response </td></tr><tr><td>  14 </td><td>  Maximum modulation level of the flame </td><td>  Optional parameter </td><td>  Must be implemented </td></tr><tr><td>  17 </td><td>  Current flame modulation level </td><td>  Optional parameter </td><td>  Must be implemented </td></tr><tr><td>  25 </td><td>  Coolant temperature </td><td>  Optional parameter </td><td>  Must be implemented </td></tr></tbody></table><br>  The answer to all other parameters is at the request of the boiler manufacturer. <br><br>  I will explain a little what flame modulation is for those who do not know.  All modern gas boilers are able to regulate the level of flame in the firebox - this is called modulation.  The greater the power of the burner, the faster the coolant heats up, too much power leads to constant on / off of the boiler (clocking), too low - to the inability to achieve the desired temperature.  The best is the mode of operation in which the boiler does not turn off and burns with an intensity that is sufficient to maintain a given level of coolant. <br><br>  As you can see - everything is extremely simple - write the implementation and get control of the boiler.  But the devil, as they say, lies in the details.  Remember the physical level - the data from the boiler is transmitted by the current level, to the boiler by the voltage level - a person new to electronics is confused.  Food from the boiler?  So how to control the voltage?  You can not just connect the wires from the boiler to the Arduino.  For those who know, the answer is obvious - this is the current loop and the interface circuit is quite simple.  I‚Äôm somewhere in the middle, so I‚Äôm looking in the Internet and quickly found the <a href="http://otgw.tclcode.com/">otgw.tclcode.com</a> site where enthusiasts made OpenTherm Gateway, however, on PIC.  There was a pairing scheme.  It would seem - take PIC, yes, please - a good attempt, laziness, but no - I want my own, not that. <br><br>  That's all - take it, collect it.  Then I began to ask the price for details and the set as a whole, but still there was an obstacle in the form of the Manchester code - I simply did not know which way to approach it in order to accept it.  Here begins the next part of my story. <br><br><h4>  Manchester code </h4><br>  In the Opentherm protocol, the Manchester code is used for the physical presentation of data, or, as it is called in the Bi-Phase L specification. <br><br>  Actually, here it is: <br><br><img src="https://habrastorage.org/files/4f3/6f0/4b1/4f36f04b19a4462fa55ada6b8bb0e8aa.png"><br><br>  The whole point is that the bits are not encoded by the signal level, but by a transition between the levels in the middle of the period: <br><br><img src="https://habrastorage.org/files/462/6b5/bab/4626b5bab7b146a9b89497a5d4c28710.png"><br><br>  In addition, this very transition does not occur exactly in the middle of the period, but somewhere around: <br><br><img src="https://habrastorage.org/files/0ab/68b/7aa/0ab68b7aa44a454ab38e355f0b136665.png"><br><br>  As you can see, the period itself is 1ms -10% + 15% and the transition is somewhere in the middle. <br><br>  This is where I stopped for a long time.  There was no desire to copy something from the Internet, since  each project has its own stumbling block, deciding which one feels not just a mindless copy-pasteur of libraries, but a developer who does this very project.  This, in fact, is the heart of the thermostat - working with OT, copying it means simply collecting another toy from the designer, and not creating something of your own. <br><br>  It was here that I wanted to apply all my poor knowledge of the MC - and interrupts and timers, etc.  Yes, delay () is much simpler, but firstly the transmission is too slow to receive with delay (), but I wanted to perform other actions in parallel during the reception / transmission, secondly I wanted everything looked decent, and not as an odd student. <br><br>  I thought I thought how beautifully to catch that transition, and even if it was a front or a decline, and when I looked at it from a different angle, everything became crystal clear why there was a transition at all!  After all, the level of the first half of the period is the desired value of the bit: <br><br><img src="https://habrastorage.org/files/10c/8e4/0b4/10c8e40b47654ee3928f6de111afbfe0.png"><br><br>  There is a first step - to take the level of the first half of the period (somewhere after 250 Œºs after the start) - that‚Äôs all the decoding.  But here I was waited by the following disappointment - it is not always possible to catch the beginning of the period: if a combination of 01 or 10 is on, then nothing remarkable happens between the periods, because  It is obvious that the level does not change - you need to look further.  And here the second revelation - in the middle of the period there is ALWAYS a transition - they are coded with 0 and 1. So you can attach to it, and the value of the next bit will be in half the period!  It was here that everything finally became clear. <br><br>  Imagine that we have already taken part of the bits and are just in the middle of the first period: <br><br><img src="https://habrastorage.org/files/28f/888/27c/28f88827cc5f4f1a9991be470cd74a8f.png"><br><br>  All that needs to be done is to enable the interrupt by changing the signal at the input.  As soon as this happens, it means that we are exactly in the middle of the period.  Turn off the interrupt by changing the signal, reset the timer, and make the timer interrupt somewhere in the period (which is 750 ¬µs for the OT), when the timer interrupt is triggered, record the input level, turn off the timer interrupt, which is the required bit and repeat all over again for all the remaining bits. <br><br>  A special case is the first bit, because  wait for his level is not ¬æ and ¬º period. <br><br>  Quickly interrupt handlers were thrown and the firmware was assembled, but how could we debug it without an oscilloscope and a signal generator?  The knowledge from the university came to the aid - Proteus, in which you could step by step to see what was happening. <br><br>  Found, installed, and then all the charms of the practice went - it turns out that the interrupt flags must be forcibly removed before interrupts are turned on, and if you load OCR2A / B before changing the timer mode from FastPWM to CTC, then "this cool slurry turned out" in the program, but as it turned out in the gland is still more fun).  Well, and other little things that quickly decided.  I remind you that at this stage I didn‚Äôt have iron yet, and I didn‚Äôt have specific requirements for the thermostat. <br><br>  I quote a code fragment responsible for receiving the Manchester code: <br><br><pre><code class="hljs ruby">inline void OpenTherm::receive(){ cli(); first=<span class="hljs-number"><span class="hljs-number">1</span></span>;<span class="hljs-regexp"><span class="hljs-regexp">//receiving</span></span> first bit buf=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-regexp"><span class="hljs-regexp">//clear</span></span> buffer rx=<span class="hljs-number"><span class="hljs-number">1</span></span>; data_ready=<span class="hljs-number"><span class="hljs-number">0</span></span>; length=<span class="hljs-number"><span class="hljs-number">0</span></span>; parity=<span class="hljs-number"><span class="hljs-number">0</span></span>; PCICR<span class="hljs-params"><span class="hljs-params">|=bit(rx_pcie); //enabling Pin Change Interrupt </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span><span class="hljs-params"> RX port *rx_pcmsk|</span></span>=rx_bitmask; <span class="hljs-regexp"><span class="hljs-regexp">//enabling</span></span> Pin Change Interrupt <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RX pin of rx Port TCCR2A=bit(WGM21);<span class="hljs-regexp"><span class="hljs-regexp">//mode</span></span> CTC TCCR2B=<span class="hljs-number"><span class="hljs-number">0</span></span>; OCR2A=TICKS_PER_MS*<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">75</span></span>;<span class="hljs-regexp"><span class="hljs-regexp">//interrupt</span></span> at <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">75</span></span>ms TCNT2=TICKS_PER_MS*<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>;<span class="hljs-regexp"><span class="hljs-regexp">//preload</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span>ms TIMSK2=bit(OCIE2A);<span class="hljs-regexp"><span class="hljs-regexp">//interrupt</span></span> on OC0A TIFR2=bit(OCF2A); sei(); bool OpenTherm::extIntHandler(){ *rx_pcmsk&amp;=~rx_bitmask; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Disable PCINT <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RX pin <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (first) { first=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ TCNT2=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length &gt; MSG_LENGTH){ data_ready=<span class="hljs-number"><span class="hljs-number">1</span></span>; TCCR2B=<span class="hljs-number"><span class="hljs-number">0</span></span>;<span class="hljs-regexp"><span class="hljs-regexp">//disable</span></span> Timer2 TIMSK2=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> TCCR2B=bit(CS22); <span class="hljs-regexp"><span class="hljs-regexp">//start</span></span> timer clk/<span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }; void OpenTherm::timer2CompAHandler(){ uint32_t tmp_buf; tmp_buf=buf; tmp_buf=tmp_buf&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rx) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*rx_port &amp; rx_bitmask) { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Reading RX value tmp_buf=tmp_buf <span class="hljs-params"><span class="hljs-params">| 1; </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">if</span></span></span><span class="hljs-params"> (length &gt; 1 ) parity^=1; //Don't calculate parity </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">for</span></span></span><span class="hljs-params"> start bit } *rx_pcmsk|</span></span>=rx_bitmask; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>Re-enabling PCINT <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> RX pin TCCR2B=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//stop</span></span> Timer2 } length++; buf=tmp_buf; }; }</code> </pre> <br><br>  The transfer, later, perfectly logically and practically fit into the same handlers. <br><br>  Timer 2 works all in the same CTC mode with zeroing every millisecond. In the zeroing interrupt handler (OC2A in CTC mode), switch the output according to the next bit.  Additionally, the OC2B interrupt is enabled, which triggers at exactly half the period (0.5 ms) and the inverting state of the output.  That's the whole wisdom of the transfer. <br><br>  Here I collected the pairing scheme and in 3 hours I figured out the principle of its operation, which turned out to be quite simple, changed the scheme a little to transfer data in a direct, not inverted form, as in the original: <br><br><img height="220" width="475" src="https://habrastorage.org/files/124/7c1/de3/1247c1de387b498aa75f126c5417f149.png"><br><br>  In addition, I had to write (well, how to write, take from the Internet and change for myself) the signal generator to HDL, because  Manually type 34 bits in the Manchester code, this is not 4 or 5. <br><br>  In the end, reception / transmission were established, and it was time to decide on the necessary equipment. <br><br><h4>  Equipment </h4><br>  So, I had a boiler (Ferolli Domiproject C24D) and the firmware for receiving / transmitting OT messages in the Manchester code in the emulator.  It's time to move on. <br><br>  What, above all, is necessary for almost every device on the Arduino?  Arduino itself?  Wrong!  Enkoder, and certainly with a button, how is it different?  It's just that I was always attracted to this type of input device - you have to try it. <br><br>  Next, the thermostat needs to get the temperature in the room and outside - for this purpose, 2 DS18B20 sensors will work, one will be filled with hot melt and put on the street, the second will be on the board.  Naturally, a display is needed - without it, you can simply put radio components in a jar, wrap it in Silpo bag and prevent it - the effect is identical.  I decided to take a standard sign-generating LCD 20 * 4 - it would have been enough, I2C port extender for LCD.  The controller itself - quite enough Arduino Nano (now I would take the Pro Mini with a programmer, then I will tell you why).  Well, a handful of details for the pairing scheme. <br><br>  As you can see from the photo in the title, something went wrong.  The seller had very attractive prices for everything, so I decided to change the list a little.  Instead of two DS18B20, I took one in a waterproof case + DHT22, so now you can get more humidity in the room.  LCD 20 * 4 was not available, and I took the display from Nokia 5110, there were no encoders with a button, so the usual + 2 buttons were taken. <br><br>  After receiving everything was soldered and tested on test examples.  The first thing we blink is the LED (as I understood when the Arduino board was first turned on, this is sacred).  Everything worked as expected, so you can start to improve. <br>  Despite the presence of hardware SPI on the Atmega 328, I decided to give it up, because  the restrictions imposed by him did not make me very happy - MISO automatically adjusts to the input, and SS must be the output - minus two outputs, and therefore we leave the software SPI.  I remove the CE display output control from the library and immediately connect it to the GND on the LCD.  I get - something like: <br><br><img height="500" width="750" src="https://habrastorage.org/files/a5b/861/18d/a5b86118d9054b268b2f24c796f68cc7.jpg"><br><br>  I expand the pairing scheme into Proteus and try to repeat something similar on the breadboard: <br><br><img height="750" width="500" src="https://habrastorage.org/files/67a/bf5/d2f/67abf5d2fd4a4bf0a5afbf10824daa7b.jpg"><br><br>  At the end of the wire you can see the standard terminal strip of the boiler, which turned out to be quite convenient - it is connected and disconnected without the use of tools and removing the cover. <br><br>  Well, now you can write a primitive firmware and try to communicate with the boiler.  I am writing, stitching, connecting, and ... <br><br>  The boiler works as needed, the article can be closed. <br>  Trollface.jpg <br><br>  Naturally nothing works. <br>  I poke the tester into the pairing board - it does not work - the input is always 20V.  I make out, look, smile.  I paid the payment from a friend.  Immediately I remembered the dialogue. <br><br>  -Well, a lot more? <br>  No, almost done.  Now this long path to solder and that's it.  The main thing is not to forget to connect these two nearby contacts. <br><br>  Guess from the first time that I forgot? <br><br>  So the "Product" is fixed, I connect, I check.  The levels are normal, you can connect the controller.  Connect - silence.  All - arrived.  Further without an oscillograph there is nothing to do.  I will finish as the author of the first article.  But there is still a little hope. <br><br>  We recall the part about receiving, and specifically resetting the timer on the level change in the middle of the period.  I thought, you never know, suddenly zeroing is not enough and with the timings of the incoming signal is in general trouble, it means I will turn it off before that at the time of reading the level for a quarter of a period, and turn it on from zero to change - strangely, it helped.  It was the same victory - without communicating with MK never before, write a library from scratch, which I did not find on the Internet, and even make it work the second time without an oscilloscope.  My joy knew no bounds. <br><br>  A little away from the feeling of euphoria, I realized that I needed to continue, because flashing the controller every time I needed to read a new parameter (the test firmware read the same parameter once a second), probably not much user-friendly. <br><br>  I learned to get the values ‚Äã‚Äãof the parameters, only in this form it is not a thermostat, but a remote display.  In order for this to become what is required, you need to learn how to operate the boiler, and here surprises also awaited me. <br><br><h4>  Debugging and working with OpenTherm </h4><br>  So, the first value - the status of the boiler - received.  The only thing that immediately embarrassed me - the DHW temperature when connecting the microcontroller immediately became the maximum allowable, regardless of the setting on the boiler panel, as I later read in the manual to the standard OT thermostat from the manufacturer (Ferolli Romeo W): when it is connected, the knobs serve only enable / disable the relevant functions, and no longer affect anything.  It was logical to assume that the value of the DHW temperature parameter will remain as it was before connecting to OT, but Honeywell programmers (board manufacturer and the rest of the automation for the boiler) have their own opinion on this matter. <br><br>  The control of the boiler was complicated by the fact that I didn‚Äôt have a sample thermostat on my hands to see the correct sequence of messages, so it was akin to being blindfolded.  In the specification, the DHW Setpoint parameter was found (hereinafter, in parentheses, I will give the DATA-ID of the called parameters, in this case 56), which, apparently, was responsible for the DHW temperature.  I rented, stitched - now when the button was pressed, the desired temperature was sent.  Checking it is.  The water temperature immediately became normal, it is time to start adjusting the CH Setpoint (1) - the temperature of the heating circuit - for which reason everything was started.  Here I was stuck for a long time, for three days.  No matter how hard I tried, whatever the desired temperature I set, the boiler still kept it around 30 degrees.  I already had the idea that the manufacturer was protected from connecting other people's thermostats - the only obvious solution was to consider Member-ID (3) from the boiler and answer it the same (2).  And this also did not help, briefly outlined the situation to a friend, and he had an assumption: <br>  - Listen, what if one vendor for the master (thermostat) and slave (boiler) devices uses different Member-IDs.  Count how the boiler automation is surprised when it realizes that another boiler controls it? <br><br>  But everything turned out to be much simpler.  It was in the parameter Max CH Setpoint (57) - the maximum temperature of the heating circuit.  After the events with the DHW circuit, it was logical to assume that the maximum value is there, but no, the value was set at 30 degrees.  After that, things went noticeably more fun. <br>  Here begins the story of the thermostat. <br><br><h4>  Thermostat </h4><br>  It is obvious that he should give out a bunch of boiler parameters, and be able to change them, without this there would be no point in creating another thermostat at all.  As I said, each request must be sent approximately once a second, the most logical was to write a finite state machine that will go from one state to another once per cycle, and its states will respond to the current requested parameters.  In the end, the branches of the machine turned out 3: <br>  1. A working branch in which the current state of the boiler is polled, temperature, modulation level.  In short, it can be represented as follows: <br><br><img src="https://habrastorage.org/files/cef/a02/126/cefa021268f2454b9c3ce6b87efcf881.png"><br><br>  2. The branch of receiving information and the boiler: additional temperature sensors, flow sensors, etc.  When you exit the "Info" menu, we return to the first branch. <br>  3. The statistics receiving branch: burner operation time, number of fan / pump starts, etc.  When exiting is identical to p.2. <br><br>  For all this work, the function call update (), without parameters.  It is enough to call it approximately 1 time per second.  It receives the result of the previous query and sends a new one based on it.  To switch between branches, you need to call a function with a parameter that is equal to the first parameter of the desired branch.  For example, update (0) goes to the main branch (0 - request status of the boiler), update (18) - the second branch, which begins with a request for parameter 18 (pressure request in the heating circuit), branch 3 - parameter 116 (number of burner starts). <br><br>  There are also other argument values: <br>  1 - record the new temperature of the heating circuit; <br>  56 - record the new temperature of the DHW circuit, etc. <br><br>  All possible arguments can be seen at the end of the update function. <br><br>  So, all the required parameters are obtained, but it was not done without a fly in the ointment - remember, I wrote after the table - all other parameters as desired by the boiler manufacturer?  So - half of them in my boiler are zero, half are not known at all.  Only wrote in vain, although it may even be useful to someone. <br><br>  The most routine and boring task, quite obviously, was writing the menu.  As promised, I will not go into details about the thermostat itself, everything can be seen in the final firmware <br>  The last thing I decided to add at the time of writing this article is that instead of a boring screen with ‚Äúmany letters‚Äù, I made a semblance of a graphic display (something similar to a sample - factory Romeo W).  Well, the clock - there are not many of them in the apartment, only the RTC DS323x is missing - when you turn off the power, you have to set the time again.  To do this, I had to manually draw a few characters and add them to the font.  The result can be seen in the photo in the title and below. <br><br><img height="200" width="200" src="https://habrastorage.org/files/12f/ec1/531/12fec153167140e5a1253a20dfccbb8d.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">Sketch</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">OpenTherm</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">LCD5110_Basic</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">OneWire</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;dht.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;dallastemp.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;avr/eeprom.h&gt; //<span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">Power</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">DHT22_PIN</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_3</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_INFO_1</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_INFO_2</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_1</span></span> <span class="hljs-number"><span class="hljs-number">31</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_2</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MODE</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_EN</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW_EN</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_MAX</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ROOM</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_BRIGH</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ACTIVE</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MAX_MODULATION</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DAYS</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_HOURS</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MINUTES</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KP</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KI</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> dht internal_s; <span class="hljs-type"><span class="hljs-type">OneWire</span></span> ow(<span class="hljs-type"><span class="hljs-type">A1</span></span>); <span class="hljs-type"><span class="hljs-type">Dallastemp</span></span> external_s(&amp;ow); <span class="hljs-type"><span class="hljs-type">OpenTherm</span></span> ot(<span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>); <span class="hljs-type"><span class="hljs-type">LCD5110</span></span> lcd(<span class="hljs-number"><span class="hljs-number">13</span></span>,<span class="hljs-number"><span class="hljs-number">11</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); //<span class="hljs-type"><span class="hljs-type">Power</span></span> sleep; extern uint8_t <span class="hljs-type"><span class="hljs-type">SmallFont</span></span>[]; extern uint8_t <span class="hljs-type"><span class="hljs-type">MediumNumbers</span></span>[]; extern uint8_t <span class="hljs-type"><span class="hljs-type">BigNumbers</span></span>[]; //<span class="hljs-type"><span class="hljs-type">Encoder</span></span> handling volatile uint32_t ts_enc=<span class="hljs-number"><span class="hljs-number">0</span></span>; volatile int8_t encoder=<span class="hljs-number"><span class="hljs-number">0</span></span>; //<span class="hljs-type"><span class="hljs-type">Clock</span></span> handling uint32_t clock_ts=<span class="hljs-number"><span class="hljs-number">0</span></span>,clock_delta=<span class="hljs-number"><span class="hljs-number">0</span></span>; uint8_t hour=<span class="hljs-number"><span class="hljs-number">0</span></span>,minute=<span class="hljs-number"><span class="hljs-number">0</span></span>,second=<span class="hljs-number"><span class="hljs-number">0</span></span>,day=<span class="hljs-number"><span class="hljs-number">0</span></span>; //<span class="hljs-type"><span class="hljs-type">Menu</span></span> <span class="hljs-type"><span class="hljs-type">Handling</span></span> uint8_t menu,item; int8_t pos=<span class="hljs-number"><span class="hljs-number">0</span></span>; const char* day_names[<span class="hljs-number"><span class="hljs-number">7</span></span>]={<span class="hljs-comment"><span class="hljs-comment">"Mon"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Tue"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Wed"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Thu"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Fri"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Sat"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Sun"</span></span>}; const char* mode_names[<span class="hljs-number"><span class="hljs-number">2</span></span>]={<span class="hljs-comment"><span class="hljs-comment">"Manual"</span></span>,<span class="hljs-comment"><span class="hljs-comment">"Auto"</span></span>}; //<span class="hljs-type"><span class="hljs-type">Misc</span></span> uint8_t display_enabled,cfg_enabled,button1=<span class="hljs-number"><span class="hljs-number">0</span></span>,button2=<span class="hljs-number"><span class="hljs-number">0</span></span>,item_tmp=<span class="hljs-number"><span class="hljs-number">0</span></span>,update_period=<span class="hljs-number"><span class="hljs-number">0</span></span>; float iSum; struct thermostat_config{ uint8_t address[<span class="hljs-number"><span class="hljs-number">8</span></span>]; ot_init_settings ot_settings; float indoor_target_temp; uint8_t active_time; uint8_t brightness; uint8_t mode; uint8_t <span class="hljs-type"><span class="hljs-type">Kp</span></span>; uint8_t <span class="hljs-type"><span class="hljs-type">Ki</span></span>; uint8_t reserved[<span class="hljs-number"><span class="hljs-number">8</span></span>]; }; //thermostat_config settings={{<span class="hljs-number"><span class="hljs-number">0x28</span></span>,<span class="hljs-number"><span class="hljs-number">0xFF</span></span>,<span class="hljs-number"><span class="hljs-number">0x53</span></span>,<span class="hljs-number"><span class="hljs-number">0x76</span></span>,<span class="hljs-number"><span class="hljs-number">0x60</span></span>,<span class="hljs-number"><span class="hljs-number">0x14</span></span>,<span class="hljs-number"><span class="hljs-number">0x02</span></span>,<span class="hljs-number"><span class="hljs-number">0xFC</span></span>},{<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">70</span></span>,<span class="hljs-number"><span class="hljs-number">30.0</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>},<span class="hljs-number"><span class="hljs-number">22.0</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>,<span class="hljs-number"><span class="hljs-number">130</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>}; thermostat_config settings; /* <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">INT0_vect</span></span>){ ot.extIntHandler(); } */ <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">PCINT0_vect</span></span>){ ot.extIntHandler(); } <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">PCINT1_vect</span></span>){ ot.extIntHandler(); } <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">PCINT2_vect</span></span>){ ot.extIntHandler(); } <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">TIMER2_COMPA_vect</span></span>){ ot.timer2CompAHandler(); } <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">TIMER2_COMPB_vect</span></span>){ ot.timer2CompBHandler(); } <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">WDT_vect</span></span>) { // sleep.watchdogEvent(); } <span class="hljs-type"><span class="hljs-type">ISR</span></span>(<span class="hljs-type"><span class="hljs-type">INT1_vect</span></span>){ display_enabled=settings.active_time; <span class="hljs-type"><span class="hljs-type">OCR1A</span></span>=settings.brightness; if((millis()-ts_enc &gt;<span class="hljs-number"><span class="hljs-number">20</span></span>) &amp;&amp; cfg_enabled) { ts_enc=millis(); if ((<span class="hljs-type"><span class="hljs-type">PIND</span></span>&amp;bit(<span class="hljs-number"><span class="hljs-number">4</span></span>))) { encoder++; } else { encoder--; } } } void fade_display(){ for(uint8_t i=settings.brightness;i&gt;<span class="hljs-number"><span class="hljs-number">10</span></span>;i-=<span class="hljs-number"><span class="hljs-number">10</span></span>){ <span class="hljs-type"><span class="hljs-type">OCR1A</span></span>=i; delay(<span class="hljs-number"><span class="hljs-number">20</span></span>); } <span class="hljs-type"><span class="hljs-type">OCR1A</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; } void enc_setup(){ cli(); <span class="hljs-type"><span class="hljs-type">DDRD</span></span>&amp;=~(bit(<span class="hljs-number"><span class="hljs-number">3</span></span>)|bit(<span class="hljs-number"><span class="hljs-number">4</span></span>)); //set <span class="hljs-type"><span class="hljs-type">A</span></span> and <span class="hljs-type"><span class="hljs-type">B</span></span> to input <span class="hljs-type"><span class="hljs-type">EIMSK</span></span>|=bit(<span class="hljs-type"><span class="hljs-type">INT1</span></span>); <span class="hljs-type"><span class="hljs-type">EICRA</span></span>|=bit(<span class="hljs-type"><span class="hljs-type">ISC11</span></span>); <span class="hljs-type"><span class="hljs-type">EICRA</span></span>&amp;=~bit(<span class="hljs-type"><span class="hljs-type">ISC10</span></span>); <span class="hljs-type"><span class="hljs-type">EIFR</span></span>|=bit(<span class="hljs-type"><span class="hljs-type">INTF1</span></span>); sei(); } void button_setup(){ <span class="hljs-type"><span class="hljs-type">DDRC</span></span>&amp;=~(bit(<span class="hljs-number"><span class="hljs-number">2</span></span>)|bit(<span class="hljs-number"><span class="hljs-number">3</span></span>)); } void read_config(){ eeprom_read_block(&amp;settings, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(thermostat_config)); } void write_config(){ eeprom_write_block(&amp;settings, <span class="hljs-number"><span class="hljs-number">0</span></span>, sizeof(thermostat_config)); } void lcd_idle(){ char mod_lev[<span class="hljs-number"><span class="hljs-number">2</span></span>]={<span class="hljs-string"><span class="hljs-string">'\0'</span></span>,<span class="hljs-string"><span class="hljs-string">'\0'</span></span>}; lcd.setFont(<span class="hljs-type"><span class="hljs-type">BigNumbers</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">":"</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">";"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>);//<span class="hljs-comment"><span class="hljs-comment">";"</span></span> - thermometer icon lcd.print(<span class="hljs-comment"><span class="hljs-comment">"0"</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"0"</span></span>,<span class="hljs-number"><span class="hljs-number">34</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"&lt;=&gt;"</span></span>,<span class="hljs-number"><span class="hljs-number">42</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>);//<span class="hljs-comment"><span class="hljs-comment">"&lt;=&gt;"</span></span> - <span class="hljs-type"><span class="hljs-type">House</span></span> icon lcd.printNumI(hour,(hour&gt;<span class="hljs-number"><span class="hljs-number">9</span></span>)?<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumI(minute,(minute&gt;<span class="hljs-number"><span class="hljs-number">9</span></span>)?<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.setFont(<span class="hljs-type"><span class="hljs-type">SmallFont</span></span>); lcd.print(day_names[day],<span class="hljs-number"><span class="hljs-number">62</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumF(internal_s.temperature,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">60</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); switch(ot.status&amp;<span class="hljs-number"><span class="hljs-number">0x7</span></span>){ case <span class="hljs-type"><span class="hljs-type">OT_STATUS_CH</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"&gt;"</span></span>,<span class="hljs-number"><span class="hljs-number">78</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_STATUS_DHW</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"="</span></span>,<span class="hljs-number"><span class="hljs-number">78</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_STATUS_FAULT</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"?@"</span></span>,<span class="hljs-number"><span class="hljs-number">72</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); break; }; if (ot.status&amp;<span class="hljs-number"><span class="hljs-number">0x8</span></span>){ if (ot.modulation &lt; <span class="hljs-number"><span class="hljs-number">34</span></span>) *mod_lev=<span class="hljs-string"><span class="hljs-string">'^'</span></span>; else if (ot.modulation &lt; <span class="hljs-number"><span class="hljs-number">67</span></span>) *mod_lev=<span class="hljs-string"><span class="hljs-string">'_'</span></span>; else *mod_lev=<span class="hljs-string"><span class="hljs-string">'`'</span></span>; lcd.print(mod_lev,<span class="hljs-number"><span class="hljs-number">72</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); } lcd.setFont(<span class="hljs-type"><span class="hljs-type">MediumNumbers</span></span>); lcd.printNumF(external_s.getTemp(settings.address),<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumI(internal_s.temperature,<span class="hljs-number"><span class="hljs-number">48</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); } void lcd_main(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Room: /"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumF(internal_s.temperature,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); if (settings.mode) lcd.printNumF(settings.indoor_target_temp,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">60</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); else lcd.print(<span class="hljs-comment"><span class="hljs-comment">" "</span></span>,<span class="hljs-number"><span class="hljs-number">54</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Hum: \%"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumF(internal_s.humidity,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Outdoor:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumF(external_s.getTemp(settings.address),<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Heat: /"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumF(ot.<span class="hljs-type"><span class="hljs-type">CH</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">30</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumF(settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">60</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"DHW: /"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumF(ot.<span class="hljs-type"><span class="hljs-type">DHW</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumF(ot.target_DHW,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">54</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); switch(ot.status&amp;<span class="hljs-number"><span class="hljs-number">0x7</span></span>){ case <span class="hljs-type"><span class="hljs-type">OT_STATUS_CH</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"CH "</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_STATUS_DHW</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"DHW "</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_STATUS_FAULT</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"FAULT:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); switch(ot.fault&amp;<span class="hljs-number"><span class="hljs-number">0x3D</span></span>){ case <span class="hljs-type"><span class="hljs-type">OT_FAULT_SERVICE</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"FAULT:SERV REQ"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_FAULT_LOW_WATER</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"FAULT:NO WATER"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_FAULT_GAS</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"FAULT:NO FLAME"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_FAULT_AIR_PRESSURE</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"FAULT:AIR PRES"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; case <span class="hljs-type"><span class="hljs-type">OT_FAULT_WATER_OV_TEMP</span></span>: lcd.print(<span class="hljs-comment"><span class="hljs-comment">"FAULT:WATER OT"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; } break; default: lcd.print(<span class="hljs-comment"><span class="hljs-comment">" "</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); break; }; if (ot.status&amp;<span class="hljs-number"><span class="hljs-number">0x8</span></span>) { lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Flame: %"</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI(ot.modulation,<span class="hljs-number"><span class="hljs-number">60</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); } } void lcd_menu(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" 1)Config"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" 2)Info"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" 3)Stats"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); } void lcd_config_1(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Mode:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(mode_names[(item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_MODE</span></span>)?item_tmp:settings.mode],<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH enabled:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_EN</span></span>)?item_tmp:ot.<span class="hljs-type"><span class="hljs-type">CH_enabled</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW enabled:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW_EN</span></span>)?item_tmp:ot.<span class="hljs-type"><span class="hljs-type">DHW_enabled</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH max t:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_MAX</span></span>)?item_tmp:ot.<span class="hljs-type"><span class="hljs-type">CH_max</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH temp:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH</span></span>)?item_tmp:ot.target_CH,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW temp:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW</span></span>)?item_tmp:ot.target_DHW,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); } void lcd_config_2(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Room temp:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumF((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_ROOM</span></span>)?(float)item_tmp/<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10</span></span>:settings.indoor_target_temp,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Brightness:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_BRIGH</span></span>)?item_tmp:settings.brightness,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Light time:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_ACTIVE</span></span>)?item_tmp:settings.active_time,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Max modul:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_MAX_MODULATION</span></span>)?item_tmp:settings.ot_settings.max_modulation,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Days:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.print(day_names[(item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_DAYS</span></span>)?item_tmp:day],<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Hours:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_HOURS</span></span>)?item_tmp:hour,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); } void lcd_config_3(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Minutes"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_MINUTES</span></span>)?item_tmp:minute,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Kp"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_KP</span></span>)?item_tmp:settings.<span class="hljs-type"><span class="hljs-type">Kp</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Ki"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumI((item==<span class="hljs-type"><span class="hljs-type">LCD_ITEM_KI</span></span>)?item_tmp:settings.<span class="hljs-type"><span class="hljs-type">Ki</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); } void lcd_info_1(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH press:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumF(ot.<span class="hljs-type"><span class="hljs-type">CH_water_pressure</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW flow:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumF(ot.<span class="hljs-type"><span class="hljs-type">DHW_flow</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Ret.temp:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumF(ot.<span class="hljs-type"><span class="hljs-type">CH_return_temp</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Max cap.:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumI(ot.max_capacity,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Min mod.:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumI(ot.min_modulation,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW min lim:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">DHW_min_lim</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); } void lcd_info_2(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW lim:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">DHW_max_lim</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH lim:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">CH_min_lim</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH lim:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">CH_max_lim</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Int.Sum.:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumF(iSum,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); } void lcd_stats_1(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" Burn.st:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumI(ot.burner_starts,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CH pump:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">CH_pump_starts</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW p/v:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">DHW_pump_starts</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHW bur:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">DHW_burner_starts</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" B.hours:"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumI(ot.burner_op_hours,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" CHpump H"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">CH_pump_op_hours</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); } void lcd_stats_2(){ lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHWp/v H"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">DHW_pump_op_hours</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" DHWburn H"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.printNumI(ot.<span class="hljs-type"><span class="hljs-type">DHW_burner_op_hours</span></span>,<span class="hljs-type"><span class="hljs-type">RIGHT</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); } void update_clock(){ uint32_t tmp=millis()-clock_ts; clock_delta+=(tmp&gt;<span class="hljs-number"><span class="hljs-number">0</span></span>)?tmp:<span class="hljs-number"><span class="hljs-number">0</span></span>; clock_ts=millis(); while (clock_delta &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>){ second++; clock_delta-=<span class="hljs-number"><span class="hljs-number">1000</span></span>; if (second &gt; <span class="hljs-number"><span class="hljs-number">59</span></span>){ second=<span class="hljs-number"><span class="hljs-number">0</span></span>; minute++; if (minute &gt; <span class="hljs-number"><span class="hljs-number">59</span></span>){ minute=<span class="hljs-number"><span class="hljs-number">0</span></span>; hour++; if (hour &gt; <span class="hljs-number"><span class="hljs-number">23</span></span>){ hour=<span class="hljs-number"><span class="hljs-number">0</span></span>; day++; if (day&gt;<span class="hljs-number"><span class="hljs-number">6</span></span>) day=<span class="hljs-number"><span class="hljs-number">0</span></span>; } } } } } void update_display(){ lcd.clrScr(); lcd.setFont(<span class="hljs-type"><span class="hljs-type">SmallFont</span></span>); if (menu != <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span> &amp;&amp; menu != <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span>) { if (pos&gt;<span class="hljs-number"><span class="hljs-number">5</span></span>){ pos=<span class="hljs-number"><span class="hljs-number">0</span></span>; switch(menu){ case <span class="hljs-type"><span class="hljs-type">LCD_INFO_1</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_INFO_2</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_1</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_2</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_CONFIG_3</span></span>; break; default: pos=<span class="hljs-number"><span class="hljs-number">5</span></span>; } } if (pos&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>){ pos=<span class="hljs-number"><span class="hljs-number">5</span></span>; switch(menu){ case <span class="hljs-type"><span class="hljs-type">LCD_INFO_2</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_INFO_1</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_2</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_1</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_3</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>; break; default: pos=<span class="hljs-number"><span class="hljs-number">0</span></span>; } } }; switch(menu){ case <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span>: lcd_idle(); break; case <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>: lcd_main(); break; case <span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span>: lcd_menu(); break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span>: lcd_config_1(); break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>: lcd_config_2(); break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_3</span></span>: lcd_config_3(); break; case <span class="hljs-type"><span class="hljs-type">LCD_INFO_1</span></span>: lcd_info_1(); break; case <span class="hljs-type"><span class="hljs-type">LCD_INFO_2</span></span>: lcd_info_2(); break; case <span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_1</span></span>: lcd_stats_1(); break; case <span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_2</span></span>: lcd_stats_2(); break; }; if (menu != <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span> &amp;&amp; menu != <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>) if(! item) lcd.print(<span class="hljs-comment"><span class="hljs-comment">"\\"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,pos*<span class="hljs-number"><span class="hljs-number">8</span></span>); else lcd.print(<span class="hljs-comment"><span class="hljs-comment">"*"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,pos*<span class="hljs-number"><span class="hljs-number">8</span></span>); } void setup(){ lcd.<span class="hljs-type"><span class="hljs-type">InitLCD</span></span>(); lcd.setFont(<span class="hljs-type"><span class="hljs-type">SmallFont</span></span>); lcd.clrScr(); enc_setup(); button_setup(); read_config(); //sleep.measure_wdt(<span class="hljs-number"><span class="hljs-number">1</span></span>); // external_s.setRes(settings.address,<span class="hljs-type"><span class="hljs-type">TEMP_11_BIT</span></span>); // external_s.startConv(settings.address); analogWrite(<span class="hljs-number"><span class="hljs-number">9</span></span>,settings.brightness); display_enabled=settings.active_time; lcd.print(<span class="hljs-comment"><span class="hljs-comment">"OT init."</span></span>,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); ot.begin(&amp;settings.ot_settings); //sleep.measure_wdt(<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.clrScr(); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Slave OT ver.:"</span></span>,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); lcd.printNumF(ot.slave_ver,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Slave Memb. ID:"</span></span>,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); lcd.printNumI(ot.member_id,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">"Slave CFG:"</span></span>,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); lcd.printNumI(ot.sl_cfg,<span class="hljs-type"><span class="hljs-type">CENTER</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); } void loop(){ //<span class="hljs-type"><span class="hljs-type">DEBUG</span></span> //uint8_t type=<span class="hljs-number"><span class="hljs-number">0</span></span>,id=<span class="hljs-number"><span class="hljs-number">0</span></span>; //uint16_t data=<span class="hljs-number"><span class="hljs-number">0</span></span>; float ext_temp,int_temp,t_error; if (!update_period) { internal_s.read22(<span class="hljs-type"><span class="hljs-type">DHT22_PIN</span></span>); external_s.startConv(settings.address); } if(display_enabled){ <span class="hljs-type"><span class="hljs-type">OCR1A</span></span>=settings.brightness; if(! --display_enabled) { fade_display(); cfg_enabled=<span class="hljs-number"><span class="hljs-number">0</span></span>; menu=<span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span>; item=<span class="hljs-number"><span class="hljs-number">0</span></span>; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">0</span></span>); //main thread update_display(); } } if (cfg_enabled) delay (<span class="hljs-number"><span class="hljs-number">100</span></span>); else delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); //sleep <span class="hljs-number"><span class="hljs-number">1</span></span>s here // else sleep.sleep(); if (cfg_enabled || !update_period) { update_display(); } if ( (<span class="hljs-type"><span class="hljs-type">PINC</span></span>&amp;bit(<span class="hljs-number"><span class="hljs-number">2</span></span>)) &amp;&amp; button1) button1=<span class="hljs-number"><span class="hljs-number">0</span></span>; //if button released reset state if ( (<span class="hljs-type"><span class="hljs-type">PINC</span></span>&amp;bit(<span class="hljs-number"><span class="hljs-number">3</span></span>)) &amp;&amp; button2) button2=<span class="hljs-number"><span class="hljs-number">0</span></span>; //<span class="hljs-type"><span class="hljs-type">Esc</span></span> if (! (<span class="hljs-type"><span class="hljs-type">PINC</span></span>&amp;bit(<span class="hljs-number"><span class="hljs-number">2</span></span>)) &amp;&amp; ! button1) { button1=<span class="hljs-number"><span class="hljs-number">1</span></span>; display_enabled=settings.active_time; <span class="hljs-type"><span class="hljs-type">OCR1A</span></span>=settings.brightness; cfg_enabled=<span class="hljs-number"><span class="hljs-number">1</span></span>; switch(menu){ case <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>: if ((ot.status&amp;<span class="hljs-number"><span class="hljs-number">0x7</span></span>) == <span class="hljs-type"><span class="hljs-type">OT_STATUS_FAULT</span></span>) { delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.communicate(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-number"><span class="hljs-number">256</span></span>); } break; case <span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span>: case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>: case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_3</span></span>: if(! item) menu=<span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span>; else item=<span class="hljs-number"><span class="hljs-number">0</span></span>; break; default: menu=<span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span>; break; }; pos=<span class="hljs-number"><span class="hljs-number">0</span></span>; } //<span class="hljs-type"><span class="hljs-type">Enter</span></span> if (! (<span class="hljs-type"><span class="hljs-type">PINC</span></span>&amp;bit(<span class="hljs-number"><span class="hljs-number">3</span></span>)) &amp;&amp; ! button2) { button2=<span class="hljs-number"><span class="hljs-number">1</span></span>; display_enabled=settings.active_time; <span class="hljs-type"><span class="hljs-type">OCR1A</span></span>=settings.brightness; cfg_enabled=<span class="hljs-number"><span class="hljs-number">1</span></span>; if (! item){ //standart menu navigation switch(menu){ case <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span>: case <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_MENU</span></span>: switch(pos){ case <span class="hljs-number"><span class="hljs-number">0</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span>; break; case <span class="hljs-number"><span class="hljs-number">1</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_INFO_1</span></span>; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">18</span></span>); //start to get info break; case <span class="hljs-number"><span class="hljs-number">2</span></span>: menu=<span class="hljs-type"><span class="hljs-type">LCD_STATISTICS_1</span></span>; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">116</span></span>); //start to get stats break; } break; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_1</span></span>: if (!item) item=pos+<span class="hljs-number"><span class="hljs-number">1</span></span>; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_2</span></span>: if (!item) item=pos+<span class="hljs-number"><span class="hljs-number">7</span></span>; case <span class="hljs-type"><span class="hljs-type">LCD_CONFIG_3</span></span>: if (!item) item=pos+<span class="hljs-number"><span class="hljs-number">13</span></span>; switch(item){ case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MODE</span></span>: item_tmp=settings.mode; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_EN</span></span>: item_tmp=ot.<span class="hljs-type"><span class="hljs-type">CH_enabled</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW_EN</span></span>: item_tmp=ot.<span class="hljs-type"><span class="hljs-type">DHW_enabled</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_MAX</span></span>: item_tmp=ot.<span class="hljs-type"><span class="hljs-type">CH_max</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH</span></span>: item_tmp=settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW</span></span>: item_tmp=ot.target_DHW; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ROOM</span></span>: item_tmp=(uint8_t)(settings.indoor_target_temp*<span class="hljs-number"><span class="hljs-number">10</span></span> - <span class="hljs-number"><span class="hljs-number">100</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_BRIGH</span></span>: item_tmp=settings.brightness; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ACTIVE</span></span>: item_tmp=settings.active_time; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MAX_MODULATION</span></span>: item_tmp=settings.ot_settings.max_modulation; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DAYS</span></span>: item_tmp=day; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_HOURS</span></span>: item_tmp=hour; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MINUTES</span></span>: item_tmp=minute; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KP</span></span>: item_tmp=settings.<span class="hljs-type"><span class="hljs-type">Kp</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KI</span></span>: item_tmp=settings.<span class="hljs-type"><span class="hljs-type">Ki</span></span>; break; } break; case <span class="hljs-type"><span class="hljs-type">LCD_INFO_1</span></span>: break; case <span class="hljs-type"><span class="hljs-type">LCD_INFO_2</span></span>: break; }; if (!item) pos=<span class="hljs-number"><span class="hljs-number">0</span></span>; } else { //item save switch(item){ case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MODE</span></span>: settings.mode=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_EN</span></span>: ot.<span class="hljs-type"><span class="hljs-type">CH_enabled</span></span>=item_tmp; settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_enabled</span></span>=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW_EN</span></span>: ot.<span class="hljs-type"><span class="hljs-type">DHW_enabled</span></span>=item_tmp; settings.ot_settings.<span class="hljs-type"><span class="hljs-type">DHW_enabled</span></span>=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_MAX</span></span>: ot.<span class="hljs-type"><span class="hljs-type">CH_max</span></span>=item_tmp; settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_max_temp</span></span>=item_tmp; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">57</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH</span></span>: settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>=item_tmp; ot.target_CH=item_tmp; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">1</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW</span></span>: ot.target_DHW=item_tmp; settings.ot_settings.<span class="hljs-type"><span class="hljs-type">DHW_temp</span></span>=item_tmp; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">56</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ROOM</span></span>: settings.indoor_target_temp=(float)item_tmp/<span class="hljs-number"><span class="hljs-number">10</span></span>+<span class="hljs-number"><span class="hljs-number">10.0</span></span>; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_BRIGH</span></span>: settings.brightness=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ACTIVE</span></span>: settings.active_time=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MAX_MODULATION</span></span>: ot.max_modulation=item_tmp; settings.ot_settings.max_modulation=item_tmp; delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">14</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DAYS</span></span>: day=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_HOURS</span></span>: hour=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MINUTES</span></span>: minute=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KP</span></span>: settings.<span class="hljs-type"><span class="hljs-type">Kp</span></span>=item_tmp; break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KI</span></span>: settings.<span class="hljs-type"><span class="hljs-type">Ki</span></span>=item_tmp; break; } write_config(); item_tmp=<span class="hljs-number"><span class="hljs-number">0</span></span>; item=<span class="hljs-number"><span class="hljs-number">0</span></span>; } } /* ot.complete(&amp;type,&amp;id,&amp;data); lcd.setFont(<span class="hljs-type"><span class="hljs-type">SmallFont</span></span>); lcd.print(<span class="hljs-comment"><span class="hljs-comment">" / /"</span></span>,<span class="hljs-type"><span class="hljs-type">LEFT</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI(type,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI(id,<span class="hljs-number"><span class="hljs-number">12</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); lcd.printNumI(data,<span class="hljs-number"><span class="hljs-number">36</span></span>,<span class="hljs-number"><span class="hljs-number">40</span></span>); //debug */ if (encoder !=<span class="hljs-number"><span class="hljs-number">0</span></span> ) { if (menu != <span class="hljs-type"><span class="hljs-type">LCD_MAIN</span></span>) if(!item) pos=constrain(pos+encoder,<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>); else switch (item){ case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MODE</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_EN</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW_EN</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH_MAX</span></span>: item_tmp=constrain(item_tmp+encoder,ot.<span class="hljs-type"><span class="hljs-type">CH_min_lim</span></span>,ot.<span class="hljs-type"><span class="hljs-type">CH_max_lim</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_CH</span></span>: item_tmp=constrain(item_tmp+encoder,ot.<span class="hljs-type"><span class="hljs-type">CH_min_lim</span></span>,ot.<span class="hljs-type"><span class="hljs-type">CH_max_lim</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DHW</span></span>: item_tmp=constrain(item_tmp+encoder,ot.<span class="hljs-type"><span class="hljs-type">DHW_min_lim</span></span>,ot.<span class="hljs-type"><span class="hljs-type">DHW_max_lim</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ROOM</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">50</span></span>,<span class="hljs-number"><span class="hljs-number">180</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_BRIGH</span></span>: item_tmp=constrain(item_tmp+encoder*<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_ACTIVE</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MAX_MODULATION</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">100</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_DAYS</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">6</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_HOURS</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">23</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_MINUTES</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">59</span></span>); break; case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KP</span></span>: case <span class="hljs-type"><span class="hljs-type">LCD_ITEM_KI</span></span>: item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>); break; item_tmp=constrain(item_tmp+encoder,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">255</span></span>); break; } else if (settings.mode) settings.indoor_target_temp=constrain(settings.indoor_target_temp+encoder*<span class="hljs-number"><span class="hljs-number">0.1</span></span>,<span class="hljs-number"><span class="hljs-number">15.0</span></span>,<span class="hljs-number"><span class="hljs-number">28.0</span></span>); else settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>+=encoder*<span class="hljs-number"><span class="hljs-number">0.1</span></span>; encoder=<span class="hljs-number"><span class="hljs-number">0</span></span>; }; if (menu == <span class="hljs-type"><span class="hljs-type">LCD_IDLE</span></span> &amp;&amp; ! cfg_enabled &amp;&amp; !update_period--) { update_period=<span class="hljs-number"><span class="hljs-number">60</span></span>; update_clock(); int_temp=internal_s.temperature; ext_temp=external_s.getTemp(settings.address); t_error=settings.indoor_target_temp-int_temp; iSum=constrain(iSum+t_error,-ot.<span class="hljs-type"><span class="hljs-type">CH_max_lim</span></span>,ot.<span class="hljs-type"><span class="hljs-type">CH_max_lim</span></span>); if (settings.mode) settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>*(<span class="hljs-number"><span class="hljs-number">20.0</span></span> + (settings.indoor_target_temp-ext_temp)) + settings.<span class="hljs-type"><span class="hljs-type">Kp</span></span>*t_error + settings.<span class="hljs-type"><span class="hljs-type">Ki</span></span>*iSum/<span class="hljs-number"><span class="hljs-number">256</span></span>; if (settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span> &lt; ot.<span class="hljs-type"><span class="hljs-type">CH_min_lim</span></span>) ot.<span class="hljs-type"><span class="hljs-type">CH_enabled</span></span>=<span class="hljs-number"><span class="hljs-number">0</span></span>; else ot.<span class="hljs-type"><span class="hljs-type">CH_enabled</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>=constrain(settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>,ot.<span class="hljs-type"><span class="hljs-type">CH_min_lim</span></span>,ot.<span class="hljs-type"><span class="hljs-type">CH_max_lim</span></span>); if ((!settings.mode &amp;&amp; ot.target_CH != settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span> ) || (settings.mode &amp;&amp; abs(ot.target_CH - settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span>)){ ot.target_CH=settings.ot_settings.<span class="hljs-type"><span class="hljs-type">CH_temp</span></span>; // delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ot.update(<span class="hljs-number"><span class="hljs-number">1</span></span>); return; } } ot.update(); }</code> </pre></div></div><br>       -,  ,  ,    .         .    ,          ,         , ,          -.          -,    . <br><br>      : <br><br> 1)   CH Setpoint ‚Äì           (     /  ). <br> 2)    OTC. <br><br> ,          (  (settings.indoor_target_temp-ext_temp)),       . <br><br>       OTC.        , ,   ,       MIDI .            (..     ).          ,       . <br><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><img height="700" width="500" src="https://habrastorage.org/files/70c/738/0d1/70c7380d19dd47e8a3d8d8bcc3c76eeb.jpg"><br><img height="700" width="500" src="https://habrastorage.org/files/fe0/4dd/345/fe04dd345a424590822d143b5f9d3327.jpg"><br><img height="500" width="700" src="https://habrastorage.org/files/ffc/e31/7b6/ffce317b627b4da893b3f17c089cb4d1.jpg"><br></div></div><br><h4>  </h4><br> ,     , ,    Power.           .   ,   delay(1000)   ,      1.   ,     ,   Timer2  / OpenTherm ,   ,   .  , Proteus      Sleep,       .  ,  millis()  (      watchdog-),    .         Pro Mini (     ) ‚Äì  +    3.3,         .    Power,  ,  : <br><br><div class="spoiler"> <b class="spoiler_title">Power.h</b> <div class="spoiler_text"><pre> <code class="hljs kotlin">#include &lt;avr/wdt.h&gt; #include &lt;avr/sleep.h&gt; #include &lt;Arduino.h&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Power</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: uint16_t wdt_delay; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> uint32_t ts,delta; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> uint8_t wdt_count; uint8_t calibration; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: void watchdogEvent(); void prepare_wdt(); void measure_wdt(uint8_t); void sleep(); };</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">Power.cpp</b> <div class="spoiler_text"><pre> <code class="hljs rust">#include <span class="hljs-string"><span class="hljs-string">"Power.h"</span></span> void Power::watchdogEvent(){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (calibration) { delta+=millis()-ts; ts=millis(); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wdt_disable(); wdt_count++; } void Power::prepare_wdt(){ wdt_reset(); WDTCSR|=<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDCE|<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDE; WDTCSR=<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDIE|<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDP2|<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;WDP1; } void Power::measure_wdt(uint8_t start){ cli(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (start){ prepare_wdt(); ts=millis(); calibration=<span class="hljs-number"><span class="hljs-number">1</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ calibration=<span class="hljs-number"><span class="hljs-number">0</span></span>; wdt_delay=delta/wdt_count; } sei(); } void Power::sleep(){ <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> volatile unsigned long timer0_millis; prepare_wdt(); set_sleep_mode (SLEEP_MODE_PWR_DOWN); sleep_enable(); wdt_count=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> sleep_cpu(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!wdt_count); timer0_millis+=wdt_delay; sleep_disable(); }</code> </pre></div></div><br>    ,        ‚Äì    ,   ,       : <br><br><img src="https://habrastorage.org/files/1bf/dfa/e62/1bfdfae62f964f738cad226be7fcaf03.png"><br><br>    ‚Äì        .       ,      : <br><br><img height="240" width="480" src="https://habrastorage.org/files/423/b9a/efd/423b9aefdb3f4e4d88278622bee4b30c.jpg"><br><br>      ‚Äì      ,        .   ,   3D-,      ,       ,           .   ,   : <br><br> ‚Äî   ,          ? <br> ‚Äî ? <br> ‚Äî , , ,   ‚Äì . <br><br>              : <br><br><div class="spoiler">  <b class="spoiler_title">A photo</b> <div class="spoiler_text"><img height="500" width="750" src="https://habrastorage.org/files/c1e/840/774/c1e84077451548e8a98564ba09591432.jpg"><br><img height="230" width="250" src="https://habrastorage.org/files/aac/fa8/9a6/aacfa89a68cf4867bc7cae723dec3c7b.jpg"><br><img height="200" width="250" src="https://habrastorage.org/files/119/e8b/5ab/119e8b5ab86d4137b8e2e67e9648da2e.jpg"><br></div></div><br><br><div class="spoiler"> <b class="spoiler_title">  </b> <div class="spoiler_text"><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">6</span></span><span class="hljs-symbol"><span class="hljs-symbol">x8:</span></span> <span class="hljs-number"><span class="hljs-number">0x98</span></span>, <span class="hljs-number"><span class="hljs-number">0x3c</span></span>, <span class="hljs-number"><span class="hljs-number">0x66</span></span>, <span class="hljs-number"><span class="hljs-number">0x99</span></span>, <span class="hljs-number"><span class="hljs-number">0x7e</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">0x3c</span></span>, <span class="hljs-number"><span class="hljs-number">0x18</span></span>, <span class="hljs-number"><span class="hljs-number">0x1a</span></span>, <span class="hljs-number"><span class="hljs-number">0x1e</span></span>, <span class="hljs-number"><span class="hljs-number">0xba</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  ( ) <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0xfd</span></span>, <span class="hljs-number"><span class="hljs-number">0x84</span></span>, <span class="hljs-number"><span class="hljs-number">0xfd</span></span>, <span class="hljs-number"><span class="hljs-number">0x84</span></span>, <span class="hljs-number"><span class="hljs-number">0xfd</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> ( ) <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x8c</span></span>, <span class="hljs-number"><span class="hljs-number">0x82</span></span>, <span class="hljs-number"><span class="hljs-number">0xdd</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    ( ) <span class="hljs-number"><span class="hljs-number">0xdd</span></span>, <span class="hljs-number"><span class="hljs-number">0x82</span></span>, <span class="hljs-number"><span class="hljs-number">0x8c</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x60</span></span>, <span class="hljs-number"><span class="hljs-number">0xf0</span></span>, <span class="hljs-number"><span class="hljs-number">0x7a</span></span>, <span class="hljs-number"><span class="hljs-number">0x20</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x70</span></span>, <span class="hljs-number"><span class="hljs-number">0xd8</span></span>, <span class="hljs-number"><span class="hljs-number">0x6d</span></span>, <span class="hljs-number"><span class="hljs-number">0x18</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">0x0c</span></span>, <span class="hljs-number"><span class="hljs-number">0x72</span></span>, <span class="hljs-number"><span class="hljs-number">0xdb</span></span>, <span class="hljs-number"><span class="hljs-number">0x6c</span></span>, <span class="hljs-number"><span class="hljs-number">0x1b</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  <span class="hljs-number"><span class="hljs-number">24</span></span><span class="hljs-symbol"><span class="hljs-symbol">x14:</span></span> <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0xfa</span></span>, <span class="hljs-number"><span class="hljs-number">0x85</span></span>, <span class="hljs-number"><span class="hljs-number">0x3a</span></span>, <span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0x28</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xff</span></span>, <span class="hljs-number"><span class="hljs-number">0xf0</span></span>, <span class="hljs-number"><span class="hljs-number">0xff</span></span>, <span class="hljs-number"><span class="hljs-number">0xAA</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x1c</span></span>, <span class="hljs-number"><span class="hljs-number">0x3f</span></span>, <span class="hljs-number"><span class="hljs-number">0x3f</span></span>, <span class="hljs-number"><span class="hljs-number">0x3f</span></span>, <span class="hljs-number"><span class="hljs-number">0x1c</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0xc0</span></span>, <span class="hljs-number"><span class="hljs-number">0xc0</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x20</span></span>, <span class="hljs-number"><span class="hljs-number">0x20</span></span>, <span class="hljs-number"><span class="hljs-number">0x20</span></span>, <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xff</span></span>, <span class="hljs-number"><span class="hljs-number">0xff</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x7f</span></span>, <span class="hljs-number"><span class="hljs-number">0x7f</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x04</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x08</span></span>, <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">0x10</span></span>, <span class="hljs-number"><span class="hljs-number">0x1a</span></span>, <span class="hljs-number"><span class="hljs-number">0x3b</span></span>, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">0x20</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-regexp"><span class="hljs-regexp">//</span></span></code> </pre><br></div></div><br>  ,    ,   ,       update(),            ,   communicate() ‚Äî    complete() ‚Äî   <br><h4>  Links </h4><br> <a href="https://github.com/gavrilov-i/OpenTherm">github.com/gavrilov-i/OpenTherm</a> <br> <a href="http://habrahabr.ru/post/214257/">habrahabr.ru/post/214257</a> <br> <a href="http://otgw.tclcode.com/">otgw.tclcode.com</a> <br> <a href="http://www.domoticaforum.eu/uploaded/Ard%2520M/Opentherm%2520Protocol%2520v2-2.pdf">www.domoticaforum.eu/uploaded/Ard%20M/Opentherm%20Protocol%20v2-2.pdf</a> <br><br> PS  , ,     ‚Äì    ‚Äî  ,  .       , ..   ,   OpenTherm,     . <br> PPS          ,     . ,   ‚Äî +5, TX (   ), RX (   ) ‚Äî  1,5, GND. <br>    : <br><blockquote>      ‚Äî   ,  .  RX  (  .     )  TX ( R3)  +5.        20.    R3   ‚Äî    7 ( 5).  ,      .        . </blockquote></div><p>Source: <a href="https://habr.com/ru/post/251539/">https://habr.com/ru/post/251539/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../251529/index.html">Vagrant for kids, or as on Windows it is easy to get a customized server for developing web applications</a></li>
<li><a href="../251531/index.html">Formatting Python Code</a></li>
<li><a href="../251533/index.html">Market growth, games from The Sun, Angry Birds in Chinese - and other news of the week for a mobile developer</a></li>
<li><a href="../251535/index.html">How to create 40% more sales in the online store using cashback services</a></li>
<li><a href="../251537/index.html">Fractal Flame - Build Algorithm</a></li>
<li><a href="../251541/index.html">Merge Proxmox nodes into a cluster using OpenVPN</a></li>
<li><a href="../251543/index.html">We add MVP to games on Unity3D</a></li>
<li><a href="../251545/index.html">Creating a system for blogging and working with documentation: The experience of the Kato messenger team</a></li>
<li><a href="../251547/index.html">Secure cisco</a></li>
<li><a href="../251549/index.html">Smilies in domain names</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>