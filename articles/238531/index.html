<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Experience of integrating the OpenIAB library into the Android application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we would like to share our experience of integrating the OpenIAB library into our Android application that helps you learn English wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Experience of integrating the OpenIAB library into the Android application</h1><div class="post__text post__text-html js-mediator-article">  In this article, we would like to share our experience of integrating the OpenIAB library into our Android application that helps you learn <a href="http://www.engwords.net/ru">English words</a> .  If anyone does not know, then OpenIAB is a library that allows you to connect in-App purchases of various app stores, abstracting from the details of the implementation of the API of a particular store. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/98f/96f/944/98f96f944c4b4525b921b4d592d79eb2.png"></div><br>  OpenIAB is developed on the basis of the following principles: <br><br>  * The library API should be as similar as possible to the Google Play In-app Billing API. <br>  * One APK file should work for all supported app stores. <br>  * No intermediaries when making payments.  This means that there are no third parties that process transactions.  Under the hood of the library, all transactions are processed by the same Google Play, Yandex.Store and other native store applications.  In fact, OpenIAB is a layer that brings the various appstor APIs to the same API, which we will use in our application. <br><a name="habracut"></a><br><h3>  Connection process </h3><br><h4>  Connect the OpenIAB library to the project </h4><br>  To use the library's API, we, of course, need to connect it to our project.  This can be done in several ways: <br>  1. Download the jar library file from here (http://www.onepf.org/openiab) and put it in the lib folder of our eclipse project. <br>  2. Clone the project from the git repository (git clone <a href="">github.com/onepf/OpenIAB.git</a> ) and connect it to the project as the Library Project. <br>  The first option is simpler, and we will use it. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order for the library to interact with the app stores, it will need an internet connection, so do not forget to add the permission &lt;uses-permission android: name = "android.permission.INTERNET" /&gt; in AndroidManifest.xml. <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> &lt;!</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">permissions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">download</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">files</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">billing</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">support</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  This completes the connection of the library to the project, and it is time to configure it to work with the application store. <br><br><h4>  Customization </h4><br>  Our application is distributed through Yandex.Store, and we will consider setting up the library on the example of this particular store.  First you need to create what we want to sell.  To do this, follow the Developer Console (https://developer.store.yandex.ru) of Yandex and create a new application there.  Further, in the ‚ÄúPurchases in the application‚Äù section, you need to create an entry for each position of the virtual goods that we will offer to the user.  When adding each purchase, among other parameters, we are required to specify its ID.  These IDs we will use when interacting with the app store. <br><br>  Now, when purchases exist on the side of the store, it's time to prepare our application to work with Yandex.Store.  The clearest thing is to immediately show the code. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    API . private OpenIabHelper mIABHelper; private boolean isIABHelperSetup = false; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_dict); //  API. OpenIabHelper.Options.Builder builder = new OpenIabHelper.Options.Builder() .setCheckInventory(true) .addPreferredStoreName(OpenIabHelper.NAME_YANDEX) .setVerifyMode(OpenIabHelper.Options.VERIFY_EVERYTHING) .addStoreKeys(SettingsManager.STORE_KEYS_MAP); //  . mIABHelper = new OpenIabHelper(this, builder.build()); mIABHelper.startSetup(new IabHelper.OnIabSetupFinishedListener() { public void onIabSetupFinished(IabResult result) { if(!result.isSuccess()) { isIABHelperSetup = false; //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      . return; } if(mIABHelper != null) { isIABHelperSetup = true; //API   . } } }); } @Override public void onDestroy() { super.onDestroy(); if(mIABHelper != null) mIABHelper.dispose(); mIABHelper = null; } }</span></span></code> </pre><br><br>  mIABHelper is the very object through which the library API will be accessed.  Its configuration is done by passing it to the constructor of the OpenIabHelper.Options structure.  Let's look at the most useful settings possible: <br>  - setCheckInventory (boolean checkInventory).  Tells the OpenIAB library to connect to each available app store, retrieve a list of available purchases from the user, and determine whether the store is suitable for further work or not based on the data obtained. <br>  - addPreferredStoreName (String ... storeNames).  Sets the priority for using available stores.  It can be useful if the purchase can be carried out through several stores simultaneously. <br>  - addStoreKeys (Map &lt;String, String&gt; storeKeys).  Many application stores, including Yandex.Store, sign messages sent to the application.  Thus, by checking the signature, the application can always make sure that the message is not fake.  To verify the signature, the public key is used, which, as a rule, can be obtained from the developer console of a specific application store.  With this option, you can set the public keys for the stores used. <br>  -setVerifyMode (int verifyMode).  Defines the signature verification mode when analyzing store messages.  There are three modes available: <br>  * OpenIabHelper.Options.VERIFY_EVERYTHING - always verify the signature.  If the store does not specify a public key, then working with it will not be possible. <br>  * OpenIabHelper.Options.VERIFY_SKIP - do not verify the signature.  It can be useful if you are processing purchases on the server, and not in the application. <br>  * OpenIabHelper.Options.VERIFY_ONLY_KNOWN - check the signature only if the public key is specified for this store, for example, by the option addStoreKeys (Map &lt;String, String&gt; storeKeys). <br><br>  The OpenIabHelper.startSetup method (IabHelper.OnIabSetupFinishedListener) starts the library initialization process.  This is an asynchronous call, and the result of the operation will be returned to the onIabSetupFinished () method of the passed object. <br><br>  In order for our application to use Yandex.Store for making purchases, we need to give it the appropriate permissions in the project manifest file. <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> &lt;!</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">permissions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">download</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">files</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">billing</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">support</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">--</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.onepf.openiab.permission.BILLING"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">manifest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The frame is ready, we are almost ready to sell something. <br><br><h4>  Processing purchases </h4><br>  In order to start the purchase process, we need to make a call. <br>  OpenIabHelper.launchPurchaseFlow (Activity act, String sku, int requestCode, IabHelper.OnIabPurchaseFinishedListener listener). <br><pre> <code class="java hljs">... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((mIABHelper != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; isIABHelperSetup) { String sku = <span class="hljs-string"><span class="hljs-string">"duct_1"</span></span>; mIABHelper.launchPurchaseFlow(DictActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, sku, <span class="hljs-number"><span class="hljs-number">10001</span></span>, mPurchaseFinishedListener); } ...</code> </pre><br><br>  Here <br>  act - activation from which the purchase is made. <br>  sku is the same ID that we specified when registering a purchase in the app store. <br>  requestCode - code to call the store activation. <br>  listener - the listener in which we will process the result of the operation. <br><br>  By itself, the OpenIAB library does not make any requests, but only delegates calls to the application of the selected store.  In our case, this application will be Yandex.Store.  Thus, after calling the launchPurchaseFlow () user will be redirected to the application of the corresponding store, which will conduct the purchase transaction.  After the user confirms or does not confirm the purchase, we will get the result in the onActivityResult () method of our activation.  In order for the OpenIAB library to interpret the response received, we must pass on this response to it.  This is done by calling the handleActivityResult (int requestCode, int resultCode, Intent data).  This method interprets the data received from the store application, checks the signature and transfers control to the onIabPurchaseFinished (IabResult result, Purchase Purchase) method specified when the listener startedPurchaseFlow (). <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makePurchase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((mIABHelper != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; isIABHelperSetup) { String sku = <span class="hljs-string"><span class="hljs-string">"duct_1"</span></span>; mIABHelper.launchPurchaseFlow(DictActivity.<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, sku, <span class="hljs-number"><span class="hljs-number">10001</span></span>, mPurchaseFinishedListener); } } ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActivityResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> requestCode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> resultCode, Intent data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((mIABHelper == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) || !mIABHelper.handleActivityResult(requestCode, resultCode, data)) <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onActivityResult(requestCode, resultCode, data); } ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> OnIabPurchaseFinishedListener mPurchaseFinishedListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnIabPurchaseFinishedListener() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onIabPurchaseFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IabResult result, Purchase purchase)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(result.isFailure()) { <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> -   ,    . return; } //   String purchaseName = purchase.getSku(); markPurchaseAsConfirmed(purchaseName); } }; private void markPurchaseAsConfirmed(String purchase) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">           //  UI . } }</span></span></code> </pre><br><br>  Now the user has the opportunity to become the happy owner of our virtual goods, and it's time to bring the final touch to our application, namely ... <br><br><h4>  Recovery of purchases </h4><br>  Typically, app stores support several types of products.  The most common types are: consumable goods, non-consumable goods and subscriptions.  The consumed goods include, for example, in-game currency.  The user can purchase the consumed product several times.  An example of a non-consumable product is any additional functionality of your application.  User pays it once and always uses. <br><br>  In our case, we allow the user to purchase additional dictionaries, which, logically, should not be consumed goods. The feature of non-consumable goods is that they are tied to a user account, and not to a specific instance of the program.  This means that even if a user has installed your application on several devices under one account, he can only purchase goods once, and the purchased goods must be available on all these devices.  Therefore, we should be able to receive information from the application store on goods that have been purchased once, so that the user can use them in the newly installed application.  In addition, the process of processing a purchase transaction is quite complex and involves the transfer of data over the network and the interaction of several applications within the system itself.  At any moment something might go wrong.  In the worst case, a failure can occur after the purchase was made from the app store‚Äôs point of view, but before we processed the purchase in our application.  In this case, the user will not receive the desired product in the application, although it will be listed as purchased in the app store.  To handle these situations, call <br>  queryInventoryAsync (IabHelper.QueryInventoryFinishedListener listener). <br><br>  This method will make an asynchronous request to the application store for the presence of goods purchased by the user and will return an answer to the listener.  A good solution would be to call this method immediately after the OpenIAB library was initialized. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onIabSetupFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IabResult result)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!result.isSuccess()) { isIABHelperSetup = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      . return; } if(mIABHelper != null) { isIABHelperSetup = true; //API   . //    . mIABHelper.queryInventoryAsync(mGotInventoryListener); } } ... private QueryInventoryFinishedListener mGotInventoryListener = new QueryInventoryFinishedListener() { @Override public void onQueryInventoryFinished(IabResult result, Inventory inventory) { if (result.isFailure()) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">   . return; } //        . List&lt;Purchase&gt; purchases = inventory.getAllPurchases(); for(Purchase p : purchases) { String sku = p.getSku(); if(!isPurchaseConfirmed(sku)) markPurchaseAsConfirmed(sku); } } }; private boolean isPurchaseConfirmed(String purchase) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">  true,      , //  false. } private void markPurchaseAsConfirmed(String purchase) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">    ,   ,    //  UI . } }</span></span></code> </pre><br><br><h4>  Together </h4><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    API . private OpenIabHelper mIABHelper; private boolean isIABHelperSetup = false; @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_dict); //  API. OpenIabHelper.Options.Builder builder = new OpenIabHelper.Options.Builder() .setCheckInventory(true) .addPreferredStoreName(OpenIabHelper.NAME_YANDEX) .setVerifyMode(OpenIabHelper.Options.VERIFY_EVERYTHING) .addStoreKeys(SettingsManager.STORE_KEYS_MAP); //  . mIABHelper = new OpenIabHelper(this, builder.build()); mIABHelper.startSetup(new IabHelper.OnIabSetupFinishedListener() { public void onIabSetupFinished(IabResult result) { if(!result.isSuccess()) { isIABHelperSetup = false; //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">      . return; } if(mIABHelper != null) { isIABHelperSetup = true; //API   . //    . mIABHelper.queryInventoryAsync(mGotInventoryListener); } } }); final Button buy = (Button)findViewById(R.id.buy); buy.setOnClickListener(new OnClickListener() { @Override public void onClick(View v) { if((mIABHelper != null) &amp;&amp; isIABHelperSetup) { String payload = "payload"; String sku = "duct_1"; mIABHelper.launchPurchaseFlow(DictActivity.this, sku, 10001, mPurchaseFinishedListener, payload); } } }); } @Override public void onDestroy() { super.onDestroy(); if(mIABHelper != null) mIABHelper.dispose(); mIABHelper = null; } @Override protected void onActivityResult(int requestCode, int resultCode, Intent data) { if((mIABHelper == null) || !mIABHelper.handleActivityResult(requestCode, resultCode, data)) super.onActivityResult(requestCode, resultCode, data); } private OnIabPurchaseFinishedListener mPurchaseFinishedListener = new OnIabPurchaseFinishedListener() { public void onIabPurchaseFinished(IabResult result, Purchase purchase) { if (result.isFailure()) { showMessage("Error purchasing: " + result); return; } String purchaseName = purchase.getSku(); markPurchaseAsConfirmed(purchaseName); } }; private QueryInventoryFinishedListener mGotInventoryListener = new QueryInventoryFinishedListener() { @Override public void onQueryInventoryFinished(IabResult result, Inventory inventory) { if (result.isFailure()) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">   . return; } //        . List&lt;Purchase&gt; purchases = inventory.getAllPurchases(); for(Purchase p : purchases) { String sku = p.getSku(); if(!isPurchaseConfirmed(sku)) markPurchaseAsConfirmed(sku); } } }; private void markPurchaseAsConfirmed(String purchase) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">    ,   ,    //  UI . } private boolean isPurchaseConfirmed(String purchase) { //</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment">  true,      , //  false. } }</span></span></code> </pre><br><br><h4>  Conclusion </h4><br>  If you plan to make money on your application outside the google play infrastructure, then OpenIAB is what you need.  Connecting new app stores is carried out with just a few lines of code, and the similarity of the API with the Google Billing API allows you to quickly migrate to it from Google Play. <br><br><h4>  Links </h4><br>  <a href="https://github.com/onepf/OpenIAB/">github.com/onepf/OpenIAB</a> is a project on GitHub. <br>  <a href="http://www.engwords.net/ru">www.engwords.net/ru</a> - for example, an application site with built-in OpenIAB for Yandex.Store </div><p>Source: <a href="https://habr.com/ru/post/238531/">https://habr.com/ru/post/238531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../238519/index.html">Javascript elevator layout</a></li>
<li><a href="../238521/index.html">Configuring Oracle Two-Way Database Synchronization (Oracle Streams)</a></li>
<li><a href="../238523/index.html">Environment anticipating thought</a></li>
<li><a href="../238525/index.html">Overview of gadgets with alternative charging</a></li>
<li><a href="../238529/index.html">Back end based on Microsoft Azure</a></li>
<li><a href="../238533/index.html">Courses of information technology Yandex. Life before and after</a></li>
<li><a href="../238535/index.html">New drives - what's the future?</a></li>
<li><a href="../238537/index.html">How I made a project in OpenSCADA</a></li>
<li><a href="../238539/index.html">Start of active use of ShellShock</a></li>
<li><a href="../238541/index.html">Dropclock for xscreensaver or as a coder wrote a screensaver for Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>