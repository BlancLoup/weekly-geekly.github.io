<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We broadcast sound over the network using Java</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It became interesting to me to experiment with the transmission of sound over the network. 
 I chose Java technology for this. 
 As a result, I wrote ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We broadcast sound over the network using Java</h1><div class="post__text post__text-html js-mediator-article">  It became interesting to me to experiment with the transmission of sound over the network. <br>  I chose Java technology for this. <br>  As a result, I wrote three components - a transmitter for Java SE, a receiver for Java SE and a receiver for Android. <br><br>  In Java SE, classes from the <i>javax.sound.sampled</i> package were used to work with sound, in Android, classes <i>android.media.AudioFormat</i> , <i>android.media.AudioManager</i> and <i>android.media.AudioTrack were used</i> . <br>  To work with the network - standard <i>Socket</i> and <i>ServerSocket</i> . <br><br>  With the help of these components, we were able to successfully conduct a voice communication session between the Russian Far East and the Netherlands. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And another possible application - if you install a virtual sound card, for example, Virtual Audio Cable, you can stream music to other devices, and thus listen to music simultaneously in several rooms of the apartment (if you have the appropriate number of devices). <br><br><a name="habracut"></a><br><h4>  1. Transmitter. </h4><br><br>  The sound transmission method is trivial - we read the stream of bytes from the microphone, and write it to the output stream of the socket. <br><br>  Working with a microphone and data transmission over the network occurs in separate streams: <br><br><pre><code class="java hljs">mr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MicrophoneReader(); mr.start(); ServerSocket ss = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServerSocket(<span class="hljs-number"><span class="hljs-number">7373</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { Socket s = ss.accept(); Sender sndr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sender(s); senderList.add(sndr); sndr.start(); }</code> </pre> <br><br>  Stream to work with a microphone: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { microphone = AudioSystem.getTargetDataLine(format); DataLine.Info info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataLine.Info(TargetDataLine.class, format); microphone = (TargetDataLine) AudioSystem.getLine(info); microphone.open(format); data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[CHUNK_SIZE]; microphone.start(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!finishFlag) { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (senderNotReady==sendersCreated) { monitor.notifyAll(); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } numBytesRead = microphone.read(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, CHUNK_SIZE); } System.out.print(<span class="hljs-string"><span class="hljs-string">"Microphone reader: "</span></span>); System.out.print(numBytesRead); System.out.println(<span class="hljs-string"><span class="hljs-string">" bytes read"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (LineUnavailableException e) { e.printStackTrace(); } }</code> </pre><br><br>  UPD.  Note: it is important to correctly select the <i>CHUNK_SIZE</i> parameter.  If the value is too small, stuttering will be heard; if it is too large, the sound delay becomes noticeable. <br><br>  Audio stream: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { OutputStream os = s.getOutputStream(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!finishFlag) { <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { senderNotReady++; monitor.wait(); os.write(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, numBytesRead); os.flush(); senderNotReady--; } System.out.print(<span class="hljs-string"><span class="hljs-string">"Sender #"</span></span>); System.out.print(senderNumber); System.out.print(<span class="hljs-string"><span class="hljs-string">": "</span></span>); System.out.print(numBytesRead); System.out.println(<span class="hljs-string"><span class="hljs-string">" bytes sent"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } }</code> </pre><br><br>  Both thread classes ‚Äî nested, the outer <i>data</i> class variables <i>data</i> , <i>numBytesRead</i> , <i>senderNotReady</i> , <i>sendersCreated,</i> and <i>monitor</i> must be declared <i>volatile</i> . <br>  The <i>monitor</i> object is used to synchronize streams. <br><br><h4>  2. Receiver for Java SE. </h4><br><br>  The method is also trivial - we read the stream of bytes from the socket, and write to the audio output. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { InetAddress ipAddr = InetAddress.getByName(host); Socket s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Socket(ipAddr, <span class="hljs-number"><span class="hljs-number">7373</span></span>); InputStream is = s.getInputStream(); DataLine.Info dataLineInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataLine.Info(SourceDataLine.class, format); speakers = (SourceDataLine) AudioSystem.getLine(dataLineInfo); speakers.open(format); speakers.start(); Scanner sc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scanner(System.in); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numBytesRead; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">204800</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { numBytesRead = is.read(data); speakers.write(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, numBytesRead); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); }</code> </pre><br><br><h4>  3. Receiver for Android. </h4><br><br>  The way is the same. <br>  The only difference is that instead of <i>javax.sound.sampled.SourceDataLine we</i> use <i>android.media.AudioTrack</i> . <br>  It is also necessary to take into account that in Android work with the network can not occur in the main flow of the application. <br>  With the creation of services I decided not to bother, we will start the workflow from the main Activity. <br><br><pre> <code class="java hljs">toogle.setOnClickListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> View.OnClickListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isRunning) { isRunning = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; toogle.setText(<span class="hljs-string"><span class="hljs-string">"Stop"</span></span>); rp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReceiverPlayer(hostname.getText().toString()); rp.start(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { toogle.setText(<span class="hljs-string"><span class="hljs-string">"Start"</span></span>); isRunning = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; rp.setFinishFlag(); } } });</code> </pre><br><br>  The code for the workflow itself: <br><br><pre> <code class="hljs java"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReceiverPlayer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thread</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> finishFlag; String host; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReceiverPlayer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String hostname)</span></span></span><span class="hljs-function"> </span></span>{ host = hostname; finishFlag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setFinishFlag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ finishFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { InetAddress ipAddr = InetAddress.getByName(host); Socket s = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Socket(ipAddr, <span class="hljs-number"><span class="hljs-number">7373</span></span>); InputStream is = s.getInputStream(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bufferSize = AudioTrack.getMinBufferSize(<span class="hljs-number"><span class="hljs-number">16000</span></span>, AudioFormat.CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> numBytesRead; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[bufferSize]; AudioTrack aTrack = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AudioTrack(AudioManager.STREAM_MUSIC, <span class="hljs-number"><span class="hljs-number">16000</span></span>, AudioFormat.CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT, bufferSize, AudioTrack.MODE_STREAM); aTrack.play(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!finishFlag) { numBytesRead = is.read(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, bufferSize); aTrack.write(data, <span class="hljs-number"><span class="hljs-number">0</span></span>, numBytesRead); } aTrack.stop(); s.close(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { StringWriter sw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringWriter(); PrintWriter pw = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter(sw); e.printStackTrace(pw); Log.e(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,sw.toString()); } } }</code> </pre><br><br><h4>  4. A note about audio formats. </h4><br><br>  Java SE uses the <a href="https://docs.oracle.com/javase/7/docs/api/javax/sound/sampled/AudioFormat.html">javax.sound.sampled.AudioFormat</a> class. <br><br>  In Android, audio parameters are transferred directly to the <a href="http://developer.android.com/reference/android/media/AudioTrack.html">android.media.AudioTrack</a> object constructor. <br><br>  Consider the constructors of these classes that were used in my code. <br><br>  Java SE: <br><br>  <i>AudioFormat (float sampleRate, int sampleSizeInBits, int channels, boolean signed, boolean bigEndian)</i> <br>  Constructs an AudioFormat with a linear PCM encoding and the given parameters. <br><br>  Android: <br><br>  <i>AudioTrack (int streamType, int sampleRateInHz, int channelConfig, int audioFormat, int bufferSizeInBytes, int mode)</i> . <br><br>  For successful playback, the receiver and transmitter <i>parameters sampleRate / sampleRate</i> , <i>sampleSizeInBits / audioFormat</i> and <i>channels / channelConfig</i> must match. <br><br>  In addition, the <i>mode</i> value for Android needs to be set to <i>AudioTrack.MODE_STREAM</i> . <br><br>  Also, it was experimentally established that for successful playback on Android you need to transfer data in the <i>signed little endian</i> format, that is: <br>  <i>signed = true;</i>  <i>bigEndian = false.</i> <br><br>  As a result, the following formats were chosen: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Java SE: AudioFormat format = new AudioFormat(16000.0f, 16, 2, true, bigEndian); // Android: AudioTrack aTrack = new AudioTrack(AudioManager.STREAM_MUSIC, 16000, AudioFormat.CHANNEL_OUT_STEREO, AudioFormat.ENCODING_PCM_16BIT, bufferSize, AudioTrack.MODE_STREAM);</span></span></code> </pre><br><br><h4>  5. Testing. </h4><br><br>  Between the laptop on Windows 8 and the desktop on Debian Wheezy everything started right away without any problems. <br><br>  The receiver on Android initially produced only noise, but this problem was eliminated after proper selection of the <i>signed</i> and <i>bigEndian parameters</i> for the audio format. <br><br>  On the Raspberry Pi (Raspbian Wheezy), stuttering was initially heard - crutches were needed in the form of installing an avian lightweight virtual java-machine. <br><br>  I wrote the following startup script: <br><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> start) java -avian -jar jAudioReceiver.jar 192.168.1.50 &amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"kill -KILL $!"</span></span>&gt;kill_receiver.sh ;; stop) ./kill_receiver.sh ;; <span class="hljs-keyword"><span class="hljs-keyword">esac</span></span></code> </pre><br><br>  Source codes of all components here: <br><br>  <a href="https://github.com/tabatsky/NetworkingAudio">github.com/tabatsky/NetworkingAudio</a> <br><br></div><p>Source: <a href="https://habr.com/ru/post/242949/">https://habr.com/ru/post/242949/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242937/index.html">Windows Forms & Invoke from parallel threads</a></li>
<li><a href="../242939/index.html">Liskov Substitution Principle & Contracts</a></li>
<li><a href="../242943/index.html">Meteor. Developing a TODO List</a></li>
<li><a href="../242945/index.html">Contract Interfaces & Inheritance</a></li>
<li><a href="../242947/index.html">Arachnidium self-made framework for testing web and mobile applications. Get started!</a></li>
<li><a href="../242951/index.html">Who subscribed to Habrahabr?</a></li>
<li><a href="../242953/index.html">How and why "break" online shopping</a></li>
<li><a href="../242955/index.html">Dino Esposito to speak at .NEXT in Moscow</a></li>
<li><a href="../242957/index.html">Arduino, Nokia 5110 LCD and Cyrillic Module</a></li>
<li><a href="../242959/index.html">10 errors that I made when starting two online stores (and how to avoid these errors)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>