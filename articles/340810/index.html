<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dragging music from VK without public music API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="How it all began 
 It was evening, there was nothing to do ... More precisely, I just wanted to download an audiobook in front of couples and a surpri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dragging music from VK without public music API</h1><div class="post__text post__text-html js-mediator-article"><h2>  How it all began </h2><br>  It was evening, there was nothing to do ... More precisely, I just wanted to download an audiobook in front of couples and a surprise was waiting for me.  Cache in kate mobile disabled.  How so?  What to do?  Of course, write your application with cache and audio recordings.  But first you need to understand how VC turns links like audio% user_id% _% track_id% into direct links to mp3.  <s>I did not write</s> what came out of this <s>application</s> and how to download a specific playlist can be read under the cut. <br><a name="habracut"></a><br><h2>  Debasim js </h2><br>  We start with the obvious - open the audio recordings tab and look at the code.  We see onclick on the button for each audio recording: <br><br><pre><code class="javascript hljs">onclick=<span class="hljs-string"><span class="hljs-string">"return getAudioPlayer().toggleAudio(this, event)"</span></span></code> </pre> <br>  Open audioplayer.js, turn on Pretty print and look for the toggleAudio () function. <br><br><div class="spoiler">  <b class="spoiler_title">toggleAudio ()</b> <div class="spoiler_text"><pre> <code class="javascript hljs">AudioPlayer.prototype.toggleAudio = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vk &amp;&amp; vk.widget &amp;&amp; !vk.id &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.Widgets) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Widgets.oauth(), !<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (domClosest(<span class="hljs-string"><span class="hljs-string">"_audio_row__tt"</span></span>, e.target)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cancelEvent(e); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = domClosest(<span class="hljs-string"><span class="hljs-string">"_audio_row"</span></span>, t) , o = AudioUtils.getAudioFromEl(i, !<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.getSelection &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.getSelection().rangeCount) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.getSelection().getRangeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (a &amp;&amp; a.startOffset != a.endOffset) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !<span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e &amp;&amp; hasClass(e.target, <span class="hljs-string"><span class="hljs-string">"mem_link"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nav.go(attr(e.target, <span class="hljs-string"><span class="hljs-string">"href"</span></span>), e, { <span class="hljs-attr"><span class="hljs-attr">navigateToUploader</span></span>: !<span class="hljs-number"><span class="hljs-number">0</span></span> }), cancelEvent(e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hasClass(e.target, <span class="hljs-string"><span class="hljs-string">"_audio_row__title_inner"</span></span>) &amp;&amp; o.lyrics &amp;&amp; !o.isInAttach) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> AudioUtils.toggleAudioLyrics(i, o), cancelEvent(e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hasClass(e.target, <span class="hljs-string"><span class="hljs-string">"audio_row__performer"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> checkEvent(e) || vk.widget ? !<span class="hljs-number"><span class="hljs-number">0</span></span> : (AudioUtils.audioSearchPerformer(e.target, o.performer, e), cancelEvent(e)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = cur.cancelClick || e &amp;&amp; (hasClass(e.target, <span class="hljs-string"><span class="hljs-string">"audio_lyrics"</span></span>) || domClosest(<span class="hljs-string"><span class="hljs-string">"_audio_duration_wrap"</span></span>, e.target) || domClosest(<span class="hljs-string"><span class="hljs-string">"_audio_inline_player"</span></span>, e.target) || domClosest(<span class="hljs-string"><span class="hljs-string">"audio_performer"</span></span>, e.target)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cur._sliderMouseUpNowEl &amp;&amp; cur._sliderMouseUpNowEl == geByClass1(<span class="hljs-string"><span class="hljs-string">"audio_inline_player_progress"</span></span>, i) &amp;&amp; (s = !<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> cur.cancelClick, <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> cur._sliderMouseUpNowEl, s) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AudioUtils.isClaimedAudio(o) || o.isReplaceable) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = AudioUtils.getAudioExtra(o) , l = r.claim; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (l) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (hasClass(i, <span class="hljs-string"><span class="hljs-string">"no_actions"</span></span>) || o.isInEditBox || showAudioClaimWarning(o, l, AudioUtils.replaceWithOriginal.bind(AudioUtils, i, o))) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (o.isPlaying) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pause(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n = AudioUtils.getContextPlaylist(i); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.play(o.fullId, n.playlist, o.context || n.context), cur.audioPage &amp;&amp; cur.audioPage.onUserAction(o, n.playlist) } AudioUtils.onRowOver(i, !<span class="hljs-number"><span class="hljs-number">1</span></span>, !<span class="hljs-number"><span class="hljs-number">0</span></span>) }</code> </pre> <br></div></div><br>  We set a breakpoint on the first instruction and press the button.  Enter debug mode and begin to execute the code step by step. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We see that the variable o in a few steps contains a bunch of useful information: artist, name, hashes, all sorts of IDs.  But does not contain the main property - url. <br>  We go further, we leave from toggleAudio (), we get to the common.js file in the function working with events.  Yeah, then we get the link asynchronously, we should look at the network activity, well, we go further.  After n steps, we notice that an interesting query appears in the network tab: <br><br> <code>Request URL:https://vk.com/al_audio.php <br> Request Method:POST <br> <br> Form Data: <br> act:reload_audio <br> al:1 <br> ids:  id  %user_id%_%track_id%,   </code> <br> <br>  And no less interesting answer: <br><br> <code>4089188939145&lt;!&gt;&lt;!&gt;0&lt;!&gt;6854&lt;!&gt;0&lt;!&gt;&lt;!json&gt;[[456239119,%my_id%,"https:\/\/vk.com\/mp3\/audio_api_unavailable.mp3?extra=ofvLohaZvtDKnOPmEtHWl2rJCLLMrJiZy1i4D3blohn4AZLflLqZtMn3utbJmeTrCdq2Be1LyJ1HDvqTBKnUne8YrJfzzKrVENKXzL9JmMHgEgz3u3nbDwfuBMDiywLJBOrfl2fQwJDRmvrFzwDbwtGWvwThDxy6lxLHt1KOlvDODhbTAgjOzffOzdvTBOvOms9nvO9Ix1bxrNqUwgnfAfLWnwfLDLb0CLLxAvCVr2r4ExbHzhPTlKS2p3zcodu3yxm4Ea#CWS1mZi","   ",".. ",4705,0,0,"",0,2,"","[]","6adb4186ee0c1d3ad0\/5102a312745ae505a7\/08eb0e4bd407e74e76\/d313ec4b6051942649\/","",[]],[456239118,%my_id%,"https:\/\/vk.com\/mp3\/audio_api_unavailable.mp3?extra=AdbkuuLOywjuou0Zme1yrdzJsI9Tm2qYvIO2AJaWnMnIztKOzgLxmMfbu3rgyJ8Tme5MBNrKlMLpChPIBLLFngjvu3zZAxztuOXJztfgrK9vq1rznLCYDJznBMrMCMT4rO9PytD3oc5kAhyYm1jMmZeZlxqZsKfWyKO9DNGUmvfuBtfOudjXrvbmyZLVltvICvPIver5zg5Zm2jWmJvWsue5nuXWzgPnBZq6l2n3x30OCgCVC2SVmxjqzvD6Egrlnc1zyq#CWSYmdC","  "," ",359,0,0,"",0,18,"","[]","57c59cffa93d47effa\/836d457cff34e02fa0\/6374a8e457c763a8c6\/96db3ddc8c210b1fb0\/","",[]],[456239117,%my_id%,"https:\/\/vk.com\/mp3\/audio_api_unavailable.mp3?extra=AgDYnY1TmwmOm2vTos5Ylu9Juwzkugv4zMzZyJbVlKjcqI9LB2vdzhe6DufVqY9KA1uZy3bfnhm4AgDOAwHIzMDztMTxsLjHn2K9veXuttvKq2fxogTWxY1fzJvumJrADLDlCdnLAv8UAfPiB2zxEKTrttLTrtK2ntrLCLnOww5rtI1Rq2vzsgr2vMnYp1P5BeOOx3rIEs8WBI10yLntCNzOCKrLBtznBMzRC29ewMOOC3uTueuYl29OztnWDhCXoffz#CWSYntC","Sal s√©r hon standa (V√∂lusp√°, 64-66)","Nytt Land",272,0,0,"",0,82,"","[]","4881448c55978a3374\/40a707901f551a4572\/778fe59467e6a629a9\/02a308905303098496\/","https:\/\/pp.userapi.com\/c837628\/v837628453\/829d0\/kLoB-0G_r78.jpg,https:\/\/pp.userapi.com\/c837628\/v837628453\/829cf\/C39pJ5b-tw.jpg",80],[456239116,%my_id%,"https:\/\/vk.com\/mp3\/audio_api_unavailable.mp3?extra=l1yUmI1MCc8Vsxq2qxHYoM1Ku2i9C1y\/EdzWzZfADhrpDgGYrwvJwwTRtZzHDwL3A2HZqKXXrOfHtZDVDKzZn1zIrKLJD3PVBKqOzxLylKDjvZuYqKf5qLG3rhn4nJnHs1rlt1PUy29mCvLuuxD6DJHJAtGXvNfjrMzkt29Wme93mKuWze55x1PotO01lMqZnuHfzJLgBM1Jluzqogvkr3KYs1fNmtn6qODYyx0XnxDZDNnvvO9Lsgn0tdrKDc9Kowm2#CWSOmJy","After Dark "," Mr.Kitty",351,0,0,"",0,18,"","[]","353d934506a14abed5\/5745fb63e4e5f4abb4\/2ed8c9b81df35317d7\/01404a5db986cf16b8\/","",[]],[456239115,%my_id%,"https:\/\/vk.com\/mp3\/audio_api_unavailable.mp3?extra=mJfWyY1SBMm\/m1HYDc5YzgO5BwvdndC5nZDyvNzWyMvsEgfwyMvmsJzXm2fqEhq5mJvXvw50qIO4xZKTEefVsxq3yMfkltLpnJvWzfDrCZHgywiXEgzZqwntsJvMn21Nss9psKDkBKHKlY1LzI1vlJPyEuu3l3nyEhjsBNuWAhrlq3rezZfxmJn4A2zwtZbowhq3B1CWlZe4ytHZnhzhu19Lt29fvJDkCfLOzgvewI43rtjWmd1YBKLysOe2uMfKztbr#CWSZmJG","Storm","Godspeed You! Black Emperor",1352,0,0,"",0,34,"","[]","81b9d46c10d9df8d03\/5299d303c627944df7\/5ec696a0453d27253e\/ce7a1e0600cff40c53\/","",[]]]&lt;!&gt;&lt;!bool&gt;&lt;!&gt;7212f741260c90ab47</code> <br> <br>  We understand that it is json, we unpack <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d6/ea8/d43/0d6ea8d43b57a7a17330fff191bc5317.png" alt="JSON of one of the elements"><br><br>  Ok, now we have at least some link, but it looks not very working, what to do next? <br><br><h3>  Decipher link </h3><br>  We step on the script further and we understand that nothing comes out, at some stage the link simply turns from audio_api_unavailable into a link to mp3.  It means that something is happening somewhere! <br>  But where exactly?  In one of the setUrl () functions, a function is called with the speaker name audioUnmaskSource () <br><br><div class="spoiler">  <b class="spoiler_title">Function code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.wbopen &amp;&amp; ~(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.open + <span class="hljs-string"><span class="hljs-string">""</span></span>).indexOf(<span class="hljs-string"><span class="hljs-string">"wbopen"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">o</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!i() &amp;&amp; ~t.indexOf(<span class="hljs-string"><span class="hljs-string">"audio_api_unavailable"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e = t.split(<span class="hljs-string"><span class="hljs-string">"?extra="</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">"#"</span></span>) , o = <span class="hljs-string"><span class="hljs-string">""</span></span> === e[<span class="hljs-number"><span class="hljs-number">1</span></span>] ? <span class="hljs-string"><span class="hljs-string">""</span></span> : a(e[<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e = a(e[<span class="hljs-number"><span class="hljs-number">0</span></span>]), <span class="hljs-string"><span class="hljs-string">"string"</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> o || !e) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t; o = o ? o.split(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">9</span></span>)) : []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s, r, n = o.length; n--; ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r = o[n].split(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">11</span></span>)), s = r.splice(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, e)[<span class="hljs-number"><span class="hljs-number">0</span></span>], !l[s]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t; e = l[s].apply(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, r) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e &amp;&amp; <span class="hljs-string"><span class="hljs-string">"http"</span></span> === e.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!t || t.length % <span class="hljs-number"><span class="hljs-number">4</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> e, i, o = <span class="hljs-number"><span class="hljs-number">0</span></span>, a = <span class="hljs-number"><span class="hljs-number">0</span></span>, s = <span class="hljs-string"><span class="hljs-string">""</span></span>; i = t.charAt(a++); ) i = r.indexOf(i), ~i &amp;&amp; (e = o % <span class="hljs-number"><span class="hljs-number">4</span></span> ? <span class="hljs-number"><span class="hljs-number">64</span></span> * e + i : i, o++ % <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp;&amp; (s += <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(<span class="hljs-number"><span class="hljs-number">255</span></span> &amp; e &gt;&gt; (<span class="hljs-number"><span class="hljs-number">-2</span></span> * o &amp; <span class="hljs-number"><span class="hljs-number">6</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = t.length , o = []; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> a = i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (e = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.abs(e); a--; ) o[a] = (e += e * (a + i) / e) % i | <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> o } <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span>.defineProperty(e, <span class="hljs-string"><span class="hljs-string">"__esModule"</span></span>, { <span class="hljs-attr"><span class="hljs-attr">value</span></span>: !<span class="hljs-number"><span class="hljs-number">0</span></span> }), e.audioUnmaskSource = o; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = <span class="hljs-string"><span class="hljs-string">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMN0PQRSTUVWXYZO123456789+/="</span></span> , l = { <span class="hljs-attr"><span class="hljs-attr">v</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t.split(<span class="hljs-string"><span class="hljs-string">""</span></span>).reverse().join(<span class="hljs-string"><span class="hljs-string">""</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">r</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, e</span></span></span><span class="hljs-function">) </span></span>{ t = t.split(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i, o = r + r, a = t.length; a--; ) i = o.indexOf(t[a]), ~i &amp;&amp; (t[a] = o.substr(i - e, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t.join(<span class="hljs-string"><span class="hljs-string">""</span></span>) }, <span class="hljs-attr"><span class="hljs-attr">s</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = t.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o = s(t, e) , a = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (t = t.split(<span class="hljs-string"><span class="hljs-string">""</span></span>); ++a &lt; i; ) t[a] = t.splice(o[i - <span class="hljs-number"><span class="hljs-number">1</span></span> - a], <span class="hljs-number"><span class="hljs-number">1</span></span>, t[a])[<span class="hljs-number"><span class="hljs-number">0</span></span>]; t = t.join(<span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> t }, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e = e.charCodeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>), each(t.split(<span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t, o</span></span></span><span class="hljs-function">) </span></span>{ i.push(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.fromCharCode(o.charCodeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>) ^ e)) }), i.join(<span class="hljs-string"><span class="hljs-string">""</span></span>) } } }</code> </pre> <br></div></div><br>  We set a breakpoint on o (t) and see what comes and what goes.  t is our link of the form audio_api ...,? extra = contains two parameters.  As I understand it, one contains an encrypted link, and the second is something like a key.  You can override the algorithm, figure out exactly how it encrypts all this, or you can simply call o ('https: // ... audio_api _...').  So I decided to do it, and at the output I got a direct link to mp3 <br><br><h3>  We get encrypted links </h3><br>  We learned to decipher the links, we know the method for obtaining the encrypted link.  How do we now get the IDs that need to be passed to the method that returns the encrypted links?  We go to watch network activity.  As we understood earlier, interaction with the audio API takes place via al_audio.php.  Put a filter on this request, load the page with audio recordings again and see a new request <br><br> <code>Request URL:https://vk.com/al_audio.php <br> Request Method:POST <br> Status Code:200 <br> Form Data: <br> access_hash: <br> act:load_section <br> al:1 <br> claim:0 <br> offset:30 <br> owner_id:my_id <br> playlist_id:-1 <br> type:playlist</code> <br> <br>  And in response we get a big json in the same form as before, which contains data about the playlist.  The offset field is responsible for the offset from which we will receive data about the playlist.  In addition, the response contains useful data: the hasMore and nextOffset fields. <br><br><h2>  Putting it all together </h2><br>  We know how to get data about the playlist, how to get encrypted links and how to decrypt them.  It remains to collect all together.  <a href="">Here is an example of what happened with me.</a>  Checked performance on node.js v8.1.3. <br><br><h3>  UPD: </h3><br>  As <a href="https://habrahabr.ru/users/veber/" class="user_link">Veber</a> noted, with Opera VC it ‚Äã‚Äãworks somehow in a special way, therefore it is better to take cookies from chrome / firestone. <br><br><h3>  UPD 2: VC has updated the way of the masking of the link, now there is a code that rushes from the ID, more details in the committer of 12.17.17 </h3></div><p>Source: <a href="https://habr.com/ru/post/340810/">https://habr.com/ru/post/340810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340794/index.html">Workshops at FrontFest - cross-platform applications on Angular, 3D games on Canvas and backends on Node.js</a></li>
<li><a href="../340798/index.html">The best UX and web design by Behance users</a></li>
<li><a href="../340800/index.html">The release of OWASP Top 10 2017 RC 2</a></li>
<li><a href="../340806/index.html">‚ÄúThe main challenge is personnel shortage‚Äù is a panel discussion about the selection of data teams. Data Science Week 2017</a></li>
<li><a href="../340808/index.html">Fantastic processors and where they live - the juice from the new lines of HPE, Dell EMC and Lenovo</a></li>
<li><a href="../340816/index.html">The main legal errors of web studios</a></li>
<li><a href="../340818/index.html">VSHB Business Games Festival</a></li>
<li><a href="../340820/index.html">We configure Windows Server so that you have everything, while you had nothing for it</a></li>
<li><a href="../340822/index.html">SQL Server supports regular expressions when checking constraints, triggers are not always needed</a></li>
<li><a href="../340824/index.html">Kali Linux: package modification</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>