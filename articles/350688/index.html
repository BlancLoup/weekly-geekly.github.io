<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do you know where you can apply expression's in your project or optimize the creation of tests</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="0. Lyrics 
 Let's talk about unit testing. For large and age-related projects, the problem of ‚Äúfat‚Äù services is highly relevant. I'm talking about a l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do you know where you can apply expression's in your project or optimize the creation of tests</h1><div class="post__text post__text-html js-mediator-article"><h4>  0. Lyrics </h4><br>  Let's talk about unit testing.  For large and age-related projects, the problem of ‚Äúfat‚Äù services is highly relevant.  I'm talking about a large number of dependencies passed to the constructor.  If we add to this several dozens of methods that need to be tested, it becomes obvious that a lot of time is being spent on mocking unnecessary parts.  Automation will help solve the problem.  those.  creating an instance of the required type and mocking unused dependencies during execution. <br><br>  It turns out we need <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyService(A.Fake&lt;ISevice1&gt;(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sevice2(), A.Fake&lt;ISevice3&gt;(), A.Fake&lt;ISevice4&gt;(), A.Fake&lt;ISevice5&gt;(), A.Fake&lt;ISevice6&gt;())</code> </pre> <br>  replace with something similar.  Reminds pattern builder, is not it? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myService = GetInstance&lt;MyService&gt;().With(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sevice2()).Subject;</code> </pre><br>  The main thing is not to overdo it with automation.  Performance is also important, especially if the project has several tens of thousands of tests that will be run both locally and in a configured CI. <br><br>  Of course we can not do without reflection. <br><a name="habracut"></a><br><h4>  1. Get all the necessary information about the type </h4><br>  To begin with, we clarify that the mocks that we will use when creating an instance will be stored in the _overriddenTypes field using the following logic. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObjectBuilder&lt;T&gt; With&lt;TParam&gt;(TParam param) { _overriddenTypes.Add(typeof(TParam), param); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre> <br>  Next, consider the code that prepares the information for the creator.  Here we just need a reflection. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = typeof(T); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constructors = type.GetConstructors().Where(x =&gt; x.IsPublic).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameterizedConstructors = constructors.Where(x =&gt; x.GetParameters().Any()).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parameterizedConstructors.Any()) { <span class="hljs-comment"><span class="hljs-comment">//     } var constructor = parameterizedConstructors.Single(); var parametersType = constructor.GetParameters().Select(x =&gt; x.ParameterType).ToList(); var arguments = parametersType.Select(x =&gt; _overriddenTypes.ContainsKey(x) ? _overriddenTypes[x] : Create.Fake(x)).ToArray(); return GetObject(constructor, parametersType, arguments); }</span></span></code> </pre> <br>  In the above code, you can see that I used the FakeItEasy library for mocking. <br><br><h4>  2. Caching system </h4><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConstructorInfo constructor, List&lt;Type&gt; constructorParametersType, object[] arguments)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_objectCreatorCache != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _objectCreatorCache(arguments); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> creator = GetObjectCreator(constructor, constructorParametersType); _objectCreatorCache = creator; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> creator(arguments); }</code> </pre> <br>  Here it may not be entirely clear how this works, and for what reason I use a field in the same class for caching.  We take into account that the definition of a class is as follows: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectBuilder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{...}</code> </pre> <br>  A static field is also used for caching: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Func&lt;object[], T&gt; _objectCreatorCache;</code> </pre> <br>  Let me remind you that static fields in generic classes have one feature (not obvious at first glance): for each new generic object closed by a unique type there will be a static member. <br><br><h4>  3. Creating an instance in runtime </h4><br>  The first option that comes to mind (in fact, for some time it was the only one) is the use of the Activator class and its CreateInstance () method. <br><br><pre> <code class="java hljs">Activator.CreateInstance&lt;T&gt;();</code> </pre> <br>  From the point of view of performance, this is not an appropriate solution, and problems with caching may arise here.  It turns out this option does not suit us, because if we assume that in each new test we will need a mocking of service dependencies different from those used in the previous test. <br><br>  After introducing expression's into the platform, one more, perhaps more voluminous way of creating type instances in runtime appeared.  We will apply it. <br><br><h4>  3.1 Expression object creator </h4><br>  What is this approach good for?  Ultimately, we get a compiled lambda, not an object instance.  This will allow the use of caching.  I do not recommend using this approach; one-time receipt of an object instance is required; Activator is able to cope with this task much faster. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Func&lt;object[], T&gt; GetObjectCreator(ConstructorInfo constructor, List&lt;Type&gt; constructorParametersType) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> param = Expression.Parameter(typeof(object[]), <span class="hljs-string"><span class="hljs-string">"parameters"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> argsExpressions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Expression[constructorParametersType.Count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> index = <span class="hljs-number"><span class="hljs-number">0</span></span>; index &lt; constructorParametersType.Count; index++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constantIndex = Expression.Constant(index); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> paramAccessorExp = Expression.ArrayIndex(param, constantIndex); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> paramCastExp = Expression.Convert(paramAccessorExp, constructorParametersType[index]); argsExpressions[index] = paramCastExp; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newExpression = Expression.New(constructor, argsExpressions); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lambda = Expression.Lambda(typeof(Func&lt;object[], T&gt;), newExpression, param); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Func&lt;object[], T&gt;)lambda.Compile(); }</code> </pre> <br>  PS If it will be interesting, I can make a performance comparison, as well as describe in detail the work with expression's. <br><br>  PSS Below is the full code of this builder <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectBuilder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Func&lt;object[], T&gt; _objectCreatorCache; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly Dictionary&lt;Type, object&gt; _overriddenTypes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly Lazy&lt;T&gt; _subject; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectBuilder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ _overriddenTypes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Type, object&gt;(); _subject = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Lazy&lt;T&gt;(Build); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Subject =&gt; _subject.Value; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ObjectBuilder&lt;T&gt; With&lt;TParam&gt;(TParam param) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_subject.IsValueCreated) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Can't change builder options after first call to Object. Please create new one"</span></span>); } _overriddenTypes.Add(typeof(TParam), param); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = typeof(T); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constructors = type.GetConstructors().Where(x =&gt; x.IsPublic).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameterizedConstructors = constructors.Where(x =&gt; x.GetParameters().Any()).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!parameterizedConstructors.Any()) { <span class="hljs-comment"><span class="hljs-comment">//      } var constructor = parameterizedConstructors.Single(); var constructorParametersType = constructor.GetParameters().Select(x =&gt; x.ParameterType).ToList(); var arguments = constructorParametersType.Select(x =&gt; _overriddenTypes.ContainsKey(x) ? _overriddenTypes[x] : Create.Fake(x)).ToArray(); return GetObject(constructor, constructorParametersType, arguments); } private T GetObject(ConstructorInfo constructor, List&lt;Type&gt; constructorParametersType, object[] arguments) { if (_objectCreatorCache != null) { return _objectCreatorCache(arguments); } var creator = GetObjectCreator(constructor, constructorParametersType); _objectCreatorCache = creator; return creator(arguments); } private Func&lt;object[], T&gt; GetObjectCreator(ConstructorInfo constructor, List&lt;Type&gt; constructorParametersType) { var param = Expression.Parameter(typeof(object[]), "parameters"); var argsExpressions = new Expression[constructorParametersType.Count]; for (var index = 0; index &lt; constructorParametersType.Count; index++) { var constantIndex = Expression.Constant(index); var paramAccessorExp = Expression.ArrayIndex(param, constantIndex); var paramCastExp = Expression.Convert(paramAccessorExp, constructorParametersType[index]); argsExpressions[index] = paramCastExp; } var newExpression = Expression.New(constructor, argsExpressions); var lambda = Expression.Lambda(typeof(Func&lt;object[], T&gt;), newExpression, param); return (Func&lt;object[], T&gt;)lambda.Compile(); } }</span></span></code> </pre><br></div><p>Source: <a href="https://habr.com/ru/post/350688/">https://habr.com/ru/post/350688/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350676/index.html">Everything simple became complicated again</a></li>
<li><a href="../350678/index.html">Configuring a dynamic dhcp-pool with binding to specific ports of Cisco Catalyst</a></li>
<li><a href="../350682/index.html">Spring: job interview questions</a></li>
<li><a href="../350684/index.html">Moscow JS 40 - report, guest reviews and video</a></li>
<li><a href="../350686/index.html">Exhaustive benchmarks PHP 5.6, 7.0, 7.1, 7.2 and HHVM (2018)</a></li>
<li><a href="../350690/index.html">Cloud Application Development Guide with SAP Cloud Platform and Cloud Foundry</a></li>
<li><a href="../350692/index.html">A couple of obscure rakes when using web fonts</a></li>
<li><a href="../350694/index.html">New programming language framework</a></li>
<li><a href="../350696/index.html">Notes for the source editor (development environment)</a></li>
<li><a href="../350698/index.html">400 thousand servers may be subject to RCE attacks due to a vulnerability in the Exim mail agent</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>