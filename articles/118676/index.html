<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Instructions for setting up Ejabberd with J2J / ICQ transport (with correct encoding) on ‚Äã‚ÄãUbuntu Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 

 Today we will set up our own jabber server for example.org on Ubuntu Server Edition. 
 On this server there will be a transport in ICQ and j...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Instructions for setting up Ejabberd with J2J / ICQ transport (with correct encoding) on ‚Äã‚ÄãUbuntu Server</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br><br>  Today we will set up our own jabber server for example.org on Ubuntu Server Edition. <br>  On this server there will be a transport in ICQ and jabber.  Logs will be written to the example.org/logs directory.  Logs can be conveniently viewed from a mobile device (fancyindex + htpasswd + fail2ban). <br>  The implication is that at least in Linux you already know.  Also worth noting: the instruction is a guiding star, gives a general direction and does not call to carry it out 100% as it is written in it.  Also, it does not cover 100% of the settings, you need to be able to configure the web-server and work with mysql. <br><br>  Further for an example I will use Clodo.ru as a hoster.  Naturally, various pieces of instructions can be applied on any other distribution kit / hoster. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h5>  Stage 1. Preparation of the server environment. <br></h5><br>  We register at the hoster, create a scale-server with ubuntu lucid 10.04 LTS 32-bit, 512MB of memory, 5GB SAS. <br>  After receiving root access and other details go to the server. <br>  We are waiting until dpkg updates the system to the current state: <br><br> <code>ps uxa | egrep '(firstrun|local|apt|dpkg)'</code> <br> <br>  Replace /etc/apt/sources.list with: <br><br> <code><a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://ru.archive.ubuntu.com/ubuntu/"></a> <a href="http://archive.canonical.com/ubuntu"></a> <a href="http://security.ubuntu.com/ubuntu"></a> <a href="http://security.ubuntu.com/ubuntu"></a> <a href="http://security.ubuntu.com/ubuntu"></a> <a href="http://packages.spectrum.im/"></a> deb ru.archive.ubuntu.com/ubuntu lucid main restricted <br> deb ru.archive.ubuntu.com/ubuntu lucid-updates main restricted <br> deb ru.archive.ubuntu.com/ubuntu lucid universe <br> deb ru.archive.ubuntu.com/ubuntu lucid-updates universe <br> deb ru.archive.ubuntu.com/ubuntu lucid multiverse <br> deb ru.archive.ubuntu.com/ubuntu lucid-updates multiverse <br> deb ru.archive.ubuntu.com/ubuntu lucid-backports main restricted universe multiverse <br> deb archive.canonical.com/ubuntu lucid partner <br> deb security.ubuntu.com/ubuntu lucid-security main restricted <br> deb security.ubuntu.com/ubuntu lucid-security universe <br> deb security.ubuntu.com/ubuntu lucid-security multiverse <br> deb packages.spectrum.im lucid spectrum</code> <br> <br>  Create the file /etc/apt/apt.conf.d/03test with the contents: <br><br> <code>APT::Install-Recommends "false"; <br> APT::Install-Suggests "false";</code> <br> <br>  Add the Spectrum key (our future Jabber transport): <br><br> <code>sudo apt-key adv --recv-keys --keyserver keyserver.ubuntu.com 47A944AF1905866A</code> <br> <br>  Replace the hostname for convenience: <br><br> <code>fgrep -r $(uname -n) /etc</code> <br> <br>  We edit the files in the output, replacing the lines with the example.org we need, after which we change the hostname: <br><br> <code>hostname example.org</code> <br> <br>  Configure sudo for our user: <br><br> <code>visudo</code> <br> <br>  At the end of the file we enter: <br><br> <code>user ALL=(ALL) ALL</code> <br> <br>  Configuring access by key (google how it is done, the keywords ssh-agent, ssh-keygen -t rsa, ssh-copy-id) for the user user created by default. <br><br>  We try to log in as user, and also check the operation of sudo su.  After that, edit / etc / ssh / sshd_config. <br><br>  Necessary options: <br><br> <code>PermitRootLogin no <br> PasswordAuthentication no <br> RSAAuthentication yes <br> PubkeyAuthentication yes</code> <br> <br>  After that, we restart SSH (be careful here, we denied access by password, as well as root. You can fix the jambs here through VNC in the case of Clodo, or through KVM, in general, using physical access to the server console): <br><br> <code>service ssh restart</code> <br> <br>  Russify the system with UTF-8 support: <br><br>  Editing the file /var/lib/locales/supported.d/locale.gen <br> <code>ru_RU.UTF-8 UTF-8 <br> en_US.UTF-8 UTF-8</code> <br> <br>  and / etc / environment file <br><br> <code>LANGUAGE=ru_RU.UTF-8 <br> LANG=ru_RU.UTF-8</code> <br> <br>  We generate locales: <br><br> <code>dpkg-reconfigure locales</code> <br> <br>  At this stage, you can restart the server by specifying UTF-8 in the SSH client.  Russian language will appear. <br><br>  Add to /etc/rc.local: <br><br> <code>sysctl -w vm.swappiness=100 <br> su -c 'echo 0 &gt; /sys/devices/system/xenmgm/xenmgm0/memmin_bytes' <br> su -c 'echo 60000000 &gt; /sys/devices/system/xenmgm/xenmgm0/reserve_free_bytes'</code> <br> <br>  This will save money on the server (relevant for clodo). <br><br>  Install the necessary packages: <br> <code>apt-get install libpurple0-minimal htop strace apache2 mysql-server spectrum python python-twisted python-imaging postfix iptables fail2ban mailutils mpack subversion</code> <br> <br>  During the installation, the system will ask for the root password from MySQL, how the mail server will function (we select the Internet Site, the domain name example.org). <br><br>  In the zone for example.org we indicate: <br><br> <code>example.org. A 1.2.3.4 ( IP-) <br> example.org MX 10 example.org. <br> _xmpp-server._tcp.example.org. SRV 0 0 5269 example.org. <br> _xmpp-client._tcp.example.org. SRV 0 0 5222 example.org. <br> _jabber._tcp.example.org. SRV 0 0 5269 example.org. <br> example.org. TXT "v=spf1 a mx ~all" <br> * CNAME @</code> <br> <br>  Configuring aliases by editing the / etc / aliases file: <br><br> <code>root: myemail@gmail.com <br> user:: myemail@gmail.com</code> <br> <br>  Generate aliases for postfix: <br><br> <code>newaliases</code> <br> <br>  We send a test letter: <br><br> <code>mail -s test user [ enter] <br> CC: [ enter] <br> [ ctrl+d]</code> <br> <br>  We look at the logs /var/log/mail.info, as well as the presence of a letter in the box myemail@gmail.com. <br>  If everything is ok, let's go further! <br><br>  Set up reboot notifications by email. <br><br>  Under user we execute: <br><br> <code>crontab -e</code> <br> <br>  Write the string: <br> <code>@reboot echo "server rebooted at `date`" | mail -s "Server `uname -n` Rebooted!" user@example.org</code> <br> <br>  Attention, if the date specifies the modifier +%, we put an escaping before the percentage, for example: $ (date + \% m. \% D), or `date + \% m. \% D`, otherwise the crowns will be buried with incomprehensible errors . <br><br><h5>  Stage 2. Setting up our Jabber. <br></h5><br>  Download the ejabberd distribution. <br><br> <code><a href=""></a> cd /usr/src <br> wget www.process-one.net/downloads/ejabberd/2.1.6/ejabberd-2.1.6-linux-x86-installer.bin.gz <br> gunzip ejabberd-2.1.6-linux-x86-installer.bin.gz <br> chmod +x ejabberd-2.1.6-linux-x86-installer.bin <br> ./ejabberd-2.1.6-linux-x86-installer.bin</code> <br> <br>  Installation is simple. <br>  Choose a language, carefully read the entire license agreement, choose ‚Äúy‚Äù in response to the question: ‚ÄúDo you accept the terms of the license agreement?  [y / n]: ‚Äù, select the installation directory (we leave the default /opt/ejabberd-2.1.6), the domain name is example.org, the admin user name is admin, the administrator password.  We refuse cluster settings: <br> <code> [y/N]: N <br> <br> ---------------------------------------------------------------------------- <br>     ejabberd   . <br> <br>   ? [Y/n]: Y</code> <br> <br>  Ejabberd will install. <br><br>  Server management comes from the directory /opt/ejabberd-2.1.6/bin <br>  Read more in the ejabberd documentation. <br><br>  Now we are interested in /opt/ejabberd-2.1.6/conf/ejabberd.cfg, we edit it by adding the necessary lines: <br><br>  in the {modules,: section <br><br> <code>{mod_log_chat, [{path, "/opt/ejabberd-2.1.6/www"}, {format, html}]},</code> <br> <br>  in the {listen,: section <br><br> <code>{8888, ejabberd_service, [ <br> {access, all}, <br> {shaper_rule, fast}, <br> {ip, {127, 0, 0, 1}}, <br> {hosts, ["icq.example.org‚Äù, "sms.example.org"], <br> [{password, "iearhg98a3hg89h3498gha9"}] <br> } <br> ]}, <br> <br> {8883, ejabberd_service, [ <br> {access, all}, <br> {shaper_rule, fast}, <br> {ip, {127, 0, 0, 1}}, <br> {hosts, ["j2j.example.org"], <br> [{password, "ojer0jg0a9jg09j0gjreg0"}] <br> } <br> ]},</code> <br> <br>  We check that the /opt/ejabberd-2.1.6/www directory is created and has the rights 0755. <br><br>  Now you need to compile the mod_log_chat module and install it: <br><br> <code><a href="https://svn.process-one.net/ejabberd-modules"></a> cd /usr/src <br> svn co svn.process-one.net/ejabberd-modules <br> cp ejabberd-modules/mod_log_chat/trunk/src/mod_log_chat.erl /opt/ejabberd-2.1.6/ <br> cd /opt/ejabberd-2.1.6 <br> bin/erlc -I includes/ejabberd/include mod_log_chat.erl <br> mv mod_log_chat.beam lib/ejabberd-2.1.6/ebin/ <br> rm mod_log_chat.erl</code> <br> <br>  Now we run and test ejabberd, write someone a message, look at the logs.  Everything should work.  Stop the ejabberd. <br><br> <code>cd /opt/ejabberd-2.1.6/bin <br> ./start <br> ./stop</code> <br> <br>  Add to /etc/rc.local before exit 0: <br><br> <code>sleep 10 <br> su -c '/opt/ejabberd-2.1.6/bin/start'</code> <br> <br><h5>  Stage 3. We set up the transport on ICQ. <br></h5><br>  We will use pyicq-t. <br><br>  Add user jabber: <br><br> <code>useradd -m -s /bin/bash jabber <br> passwd jabber <br> su jabber <br> cd</code> <br> <br>  Download pyicqt from <a href="http://pyicqt.googlecode.com/">pyicqt.googlecode.com</a> to jabber and unpack the transport. <br><br> <code><a href=""></a> wget pyicqt.googlecode.com/files/pyicqt-0.8.1.5.tar.gz <br> tar zvxf pyicqt-0.8.1.5.tar.gz <br> mv pyicqt-0.8.1.5 pyicqt <br> cd pyicqt <br> cp config_example.xml config.xml</code> <br> <br>  We edit config.xml, set everything up as in the config above, server 127.0.0.1, port 8888, secret token ‚Äî password, encoding cp1251, login.icq.com, 5190, language ru ‚Äî the config speaks for itself. <br><br>  append to /etc/rc.local before exit 0: <br><br> <code>su -c 'python /home/jabber/pyicqt/PyICQt.py &gt; /home/jabber/pyicqt/log 2&gt;&amp;1 &amp;' - jabber</code> <br> <br><h5>  Stage 4. Configure j2j transport: </h5><br><br> <code><a href=""></a> cd /etc/spectrum/ <br> wget spectrum.im/attachments/download/14/mysql_schema.sql</code> <br>  Using mysql commands, create user j2j with password pass and database j2j. <br><br> <code>mysql -u j2j -p'pass' j2j &lt; mysql_schema.sql <br> mv spectrum.cfg.example spectrum.cfg</code> <br> <br>  Edit spectrum.cfg: <br><br> <code>jid=j2j.example.org <br> password=_ <br> port=8883 <br> filetransfer_cache=/var/lib/spectrum/filetransfer_cache <br> name=j2j <br> language=en <br> enable_public_registration=1 <br> <br> [logging] <br> log_file=/var/log/spectrum/$jid.log <br> log_areas= <br> [database] <br> type=mysql <br> host=localhost <br> user=j2j <br> password=pass <br> database=j2j <br> prefix=j2j_ <br></code> <br><br>  Pay attention to log_areas, it is better to leave the field empty, otherwise there will be a lot of garbage in the / var / log / spectrum log. <br><br>  Add to /etc/rc.local before exit 0: <br><br> <code>/etc/init.d/spectrum start</code> <br> <br><h5>  Step 5. Configuring viewing logs: </h5><br><br>  Let's say apache2 for working with example.org is configured in /home/user/www/example.org. <br><br>  Create a symlink: <br>  lrwxrwxrwx 1 root root 24 2011-03-04 13:24 chat -&gt; /opt/ejabberd-2.1.6/www/ <br><br>  Create /opt/ejabberd-2.1.6/www/.htaccess with the contents: <br><br> <code>Options +Indexes <br> IndexOptions FancyIndexing <br> IndexOptions +SuppressSize <br> IndexOrderDefault Descending Date <br> AuthType Basic <br> AuthName "wat" <br> AuthUserFile /opt/ejabberd-2.1.6/www/.htpasswd <br> Require valid-user</code> <br> <br>  You can generate the file /opt/ejabberd-2.1.6/www/.htpasswd, for example, with these: <br>  <a href="http://www.htaccesstools.com/htpasswd-generator/">www.htaccesstools.com/htpasswd-generator</a> <br><br>  We will fail2ban protect us from brute force.  Do not forget to add the necessary services to autoload: <br><br> <code>update-rc.d SERVICENAME defaults</code> <br> <br>  That's all.  After rebooting, if everything was done correctly, the server will work. <br><br>  For use, I recommend the PSI + client with options for automatic user authorization and automatic retrieval of user nicknames.  This is a hidden option, added to options / contactlist: <br><br> <code>bool options.contactlist.resolve-nicks-on-contact-add true</code> <br> <br>  For Android, I recommend Xabber. <br><br>  To test and configure in the process of reading the instructions you need to look and use: <br><br>  Logs ejabberd: /opt/ejabberd-2.1.6/logs <br>  These logs will tell you why the server did not start, what happens at all, where the problem is in the syntax, etc. <br><br>  Spectrum logs: / var / log / spectrum <br>  Similarly, when problems Spectrum will flood the log <br><br>  Ejabberctl: /opt/ejabberd-2.1.6/bin/ejabberdctl <br>  Used to create, delete, set user password.  Ultra-useful utility, until you figure out the roster, automatic user authorization and automatic nick reception. <br><br>  Documentation sites: <br>  <a href="http://ejabberd.im/">ejabberd.im</a> <br>  <a href="http://spectrum.im/">spectrum.im</a> <br>  <a href="http://code.google.com/p/pyicqt">code.google.com/p/pyicqt</a> <br>  <a href="http://google.com/">google.com</a> <br><br>  In touch with you, write about typos and errors in habraposhchta or comments, I will correct. </div><p>Source: <a href="https://habr.com/ru/post/118676/">https://habr.com/ru/post/118676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118671/index.html">Do you have experience creating illegal software? (Viruses, botnets, spies, etc.)</a></li>
<li><a href="../118672/index.html">VoiceCards.ru: happy Victory Day for free!</a></li>
<li><a href="../118673/index.html">ADD 2011 in the fight for efficiency</a></li>
<li><a href="../118674/index.html">Qt 4.7.3, Qt Mobility 1.1.1, Qt VS Addin 1.1.9</a></li>
<li><a href="../118675/index.html">SMP ON-Bank: We have created a financial conscience!</a></li>
<li><a href="../118678/index.html">We write the Firefox extension for integration with the Unity panel</a></li>
<li><a href="../118679/index.html">Qt SDK 1.1 release</a></li>
<li><a href="../118680/index.html">To change is to survive! Integration with Vkontakte</a></li>
<li><a href="../118681/index.html">YAPC :: Russia May 13‚Äì15 in Moscow</a></li>
<li><a href="../118683/index.html">The first set in the Computer Science Center (St. Petersburg)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>