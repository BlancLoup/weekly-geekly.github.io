<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Compilation. 5 and 1/2: llvm as back-end</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In a series of articles from tyomitch ‚ÄúCompilation‚Äù ( here , here , here , here , here and here ), the construction of a translator of the toy languag...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Compilation. 5 and 1/2: llvm as back-end</h1><div class="post__text post__text-html js-mediator-article">  In a series of articles from <a href="https://habrahabr.ru/users/tyomitch/" class="user_link">tyomitch</a> ‚ÄúCompilation‚Äù ( <a href="http://habrahabr.ru/blogs/programming/99162/">here</a> , <a href="http://habrahabr.ru/blogs/programming/99298/">here</a> , <a href="http://habrahabr.ru/blogs/programming/99366/">here</a> , <a href="http://habrahabr.ru/blogs/programming/99397/">here</a> , <a href="http://habrahabr.ru/blogs/programming/99466/">here</a> and <a href="http://habrahabr.ru/blogs/programming/99592/">here</a> ), the construction of a translator of the toy language jsk, described <a href="http://habrahabr.ru/blogs/programming/99397/">in 4 parts, was considered</a> . <br>  As a back-end for this compiler, <a href="https://habrahabr.ru/users/tyomitch/" class="user_link">tyomitch</a> proposed a bytecode implementation and interpreter of this bytecode. <br><br>  In my opinion, a more reasonable approach would be to use existing solutions for the backend, for example llvm, and following the principle of ‚ÄúCriticism without concrete proposals - criticism‚Äù, I propose an option for implementing this small jsk language with llvm. <br><br>  What will it give for jsk?  This compilation, that is, the result will be an executable file that does not depend on any runtime, the possibility of serious optimization, code profiling and automatically get documentation on the back-end (which will facilitate maintenance). <br><a name="habracut"></a><br><h5>  How does llvm work from a front-end developer's point of view? </h5><br>  For llvm to work, you need to create a context, using it to create a module.  Each module can have several functions.  Since jsk does not support functions, we will create one function - main (). <br>  In each function there can be several blocks of code. <br><h6>  What is a code block </h6><br>  Often, programs create the need to transfer control forward to a label that has not yet been defined.  libjit allows you to first create and use a label, and define it later, Gnu llightning allows you to write a transfer of control to the code, and later patch this code to substitute the desired address, and llvm uses a completely different approach - blocks of code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That is, llvm API does not know such a thing as a label at all.  If you need to transfer control, a link to the code block is passed to the command.  For example for <br><br> <code>if  then    else  endif <br></code> <br><br>  In the LLVM API, you need to create blocks of code for the then branch, a block of code for the else branches, and in the conditional branch command specify these blocks.  Something like <br><br> <code>BasicBlock *ThenBB = BasicBlock::Create(context, ""); <br> BasicBlock *ElseBB = BasicBlock::Create(context, ""); <br> BasicBlock *AfterIfBB = BasicBlock::Create(context, ""); <br> Builder.CreateCondBr(CondV, ThenBB, ElseBB); <br> <br>      ThenBB, ElseBB,         AfterIfBB. <br></code> <br><br>  For the actual code generation, IRBuilder is used, which contains (roughly speaking) methods for generating all LLVM commands. <br><br><h6>  After all the code was created, what next? </h6><br><br>  It is up to us.  We can simply print the received bytecode in a readable form using the dump () method of the llvm module, execute the code (that is, use llvm as the JIT compiler), or, best of all, save the bytecode in the file.  This will further optimize this byte code and convert it into an executable file using standard llvm tools. <br><br>  So, <br><br><h5>  Objectives are defined, tasks are set, comrades for the work (s) </h5><br><br>  I can‚Äôt put all the code here, if someone wants to play with the source code, the archive is posted <a href="http://ubuntuone.com/6wqTGTZytnQA1i6acWI70B">here</a> or <a href="http://narod.ru/disk/27865395001/jsk.tar.gz.html">here</a> . <br>  First of all, we need to include certain headers in the source code. <br><br><blockquote>  <font color="#339900">#include "llvm / DerivedTypes.h"</font> <br>  <font color="#339900">#include "llvm / LLVMContext.h"</font> <br>  <font color="#339900">#include "llvm / Module.h"</font> <br>  <font color="#339900">#include "llvm / Analysis / Verifier.h"</font> <br>  <font color="#339900">#include "llvm / Support / IRBuilder.h"</font> <br>  <font color="#339900">#include &lt;llvm / Support / raw_ostream.h&gt;</font> <br>  <font color="#339900">#include &lt;llvm / Bitcode / ReaderWriter.h&gt;</font> <br>  <font color="#0000ff">using</font> <font color="#0000ff">namespace</font> llvm <font color="#008080">;</font> <br></blockquote><br><br>  That should be enough.  Next, we initialize the context, module, create a function main and IRBuilder to add code to the function. <br><br>  In the declaration: <br><blockquote><br>  <font color="#0000ff">static</font> Module <font color="#000040">*</font> TheModule <font color="#008080">;</font> <br>  <font color="#0000ff">static</font> IRBuilder <font color="#000080">&lt;&gt;</font> Builder <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br></blockquote><br><br>  and to the top of the code the following: <br><br><blockquote>  LLVMContext <font color="#000040">&amp;</font> Context <font color="#000080">=</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  TheModule <font color="#000080">=</font> <font color="#0000dd">new</font> Module <font color="#008000">(</font> <font color="#FF0000">"jsk"</font> , Context <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">const</font> Type <font color="#000040">*</font> voidType <font color="#000080">=</font> Type <font color="#008080">::</font> <font color="#007788">getVoidTy</font> <font color="#008000">(</font> Context <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  func_main <font color="#000080">=</font> cast <font color="#000080">&lt;</font> Function <font color="#000080">&gt;</font> <font color="#008000">(</font> TheModule <font color="#000040">-</font> <font color="#000080">&gt;</font> getOrInsertFunction <font color="#008000">(</font> <font color="#FF0000">"main"</font> , voidType, <font color="#0000ff">NULL</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  func_main <font color="#000040">-</font> <font color="#000080">&gt;</font> setCallingConv <font color="#008000">(</font> CallingConv <font color="#008080">::</font> <font color="#007788">C</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  BasicBlock <font color="#000040">*</font> block <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"code"</font> , func_main <font color="#008000">)</font> <font color="#008080">;</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> block <font color="#008000">)</font> <font color="#008080">;</font> <br><br></blockquote><br><br>  After generating the code, we generate ret void to exit our dummy function and drop the bytecode into the a.out.bc file. <br><blockquote><br>  Builder.  <font color="#007788">CreateRetVoid</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  std <font color="#008080">::</font> <font color="#007788">string</font> ErrStr <font color="#008080">;</font> <br>  raw_fd_ostream bitcode <font color="#008000">(</font> <font color="#FF0000">"a.out.bc"</font> , ErrStr, <font color="#0000dd">0</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  WriteBitcodeToFile <font color="#008000">(</font> TheModule, bitcode <font color="#008000">)</font> <font color="#008080">;</font> <br>  bitcode.  <font color="#007788">close</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br></blockquote><br><br>  Now about generating code for the specific operation of our jsk language <br><br><h6>  Variables </h6><br><br>  For each variable, we reserve space on the stack using the instructions <br><br> <code>%varname = alloca i32</code> <br> <br>  Or, in terms of API <br><br> <code>Builder.CreateAlloca(IntegerType::get(context,32), 0, VarName.c_str());</code> <br> <br>  The problem is that we cannot allocate a place on the stack exactly where we met the variable for the first time.  Because if a variable occurs in the middle of a while loop, we will fill in the entire stack with copies of the variable. <br><br>  Therefore, we need to have a list of already defined variables, and when we encounter a variable in the text, check it, and if it met for the first time, place the memory allocation for it at the very top of the function code.  That is, from the current function, take the first block, and add the alloca command to the top of this block.  Luckily, llvm allows you to write commands not only at the end, but also at the beginning of a block.  How this is done, you can see in the source text - the function CreateEntryBlockAlloca (); <br><br>  Variable assignment <br><br> <code>Value *result = value-&gt;emit(); <br> Builder.CreateStore(result,varreference); <br> <br> .. <br> <br> store i32 %result, i32* %varreference <br></code> <br><br>  Accordingly, get the value of the variable <br><br> <code><br> return Builder.CreateLoad(varref); <br>   <br> %val = load i32* %varref <br></code> <br><br><h6>  Binary and unary operations. </h6><br><br>  It's simple <br><br><blockquote><br>  <font color="#0000ff">switch</font> <font color="#008000">(</font> op <font color="#008000">)</font> <font color="#008000">{</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'+'</font> <font color="#008080">:</font> <font color="#0000ff">return</font> Builder.  <font color="#007788">CreateAdd</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'-'</font> <font color="#008080">:</font> <font color="#0000ff">return</font> Builder.  <font color="#007788">CreateSub</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'*'</font> <font color="#008080">:</font> <font color="#0000ff">return</font> Builder.  <font color="#007788">CreateMul</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'/'</font> <font color="#008080">:</font> <font color="#0000ff">return</font> Builder.  <font color="#007788">CreateSDiv</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'&lt;'</font> <font color="#008080">:</font> tmp <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpSLT</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#0000ff">return</font> builder.  <font color="#007788">CreateZExt</font> <font color="#008000">(</font> tmp, IntegerType <font color="#008080">::</font> <font color="#007788">get</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">32</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'&gt;'</font> <font color="#008080">:</font> tmp <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpSGT</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#0000ff">return</font> builder.  <font color="#007788">CreateZExt</font> <font color="#008000">(</font> tmp, IntegerType <font color="#008080">::</font> <font color="#007788">get</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">32</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'L'</font> <font color="#008080">:</font> tmp <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpSLE</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#0000ff">return</font> builder.  <font color="#007788">CreateZExt</font> <font color="#008000">(</font> tmp, IntegerType <font color="#008080">::</font> <font color="#007788">get</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">32</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'G'</font> <font color="#008080">:</font> tmp <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpSGE</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#0000ff">return</font> builder.  <font color="#007788">CreateZExt</font> <font color="#008000">(</font> tmp, IntegerType <font color="#008080">::</font> <font color="#007788">get</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">32</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'N'</font> <font color="#008080">:</font> tmp <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpNE</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#0000ff">return</font> builder.  <font color="#007788">CreateZExt</font> <font color="#008000">(</font> tmp, IntegerType <font color="#008080">::</font> <font color="#007788">get</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">32</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">case</font> <font color="#FF0000">'='</font> <font color="#008080">:</font> tmp <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpEQ</font> <font color="#008000">(</font> L, R <font color="#008000">)</font> <font color="#008080">;</font>  <font color="#0000ff">return</font> builder.  <font color="#007788">CreateZExt</font> <font color="#008000">(</font> tmp, IntegerType <font color="#008080">::</font> <font color="#007788">get</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#0000dd">32</font> <font color="#008000">)</font> <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#0000ff">default</font> <font color="#008080">:</font> <font color="#0000ff">return</font> ErrorV <font color="#008000">(</font> <font color="#FF0000">"invalid binary operator"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#008000">}</font> <br></blockquote><br><br><h6>  IF and WHILE </h6><br><br>  As already described, we use code blocks.  For example for IF: <br><br><blockquote>  Value <font color="#000040">*</font> CondV <font color="#000080">=</font> cond <font color="#000040">-</font> <font color="#000080">&gt;</font> emit <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// Compare condition expression with 0</font> <br>  CondV <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpNE</font> <font color="#008000">(</font> CondV, zero, <font color="#FF0000">"ifcond"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// Code blocks for IF branches</font> <br>  BasicBlock <font color="#000040">*</font> ThenBB <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"thenblock"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  BasicBlock <font color="#000040">*</font> ElseBB <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"elseblock"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  BasicBlock <font color="#000040">*</font> MergeBB <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"afterifblock"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// Actually branching for IF</font> <br>  Builder.  <font color="#007788">CreateCondBr</font> <font color="#008000">(</font> CondV, ThenBB, ElseBB <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#666666">// Next, add the code to the THEN branch</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> ThenBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  this <font color="#000040">-</font> <font color="#000080">&gt;</font> thenops.  <font color="#007788">emit</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// At the end of THEN switch to "after IF"</font> <br>  Builder.  <font color="#007788">CreateBr</font> <font color="#008000">(</font> MergeBB <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  TheFunction <font color="#000040">-</font> <font color="#000080">&gt;</font> getBasicBlockList <font color="#008000">(</font> <font color="#008000">)</font> .  <font color="#007788">push_back</font> <font color="#008000">(</font> ElseBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// Next, add the code to the ELSE century</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> ElseBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  this <font color="#000040">-</font> <font color="#000080">&gt;</font> elseops.  <font color="#007788">emit</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// At the end of an else transition to "After IF"</font> <br>  Builder.  <font color="#007788">CreateBr</font> <font color="#008000">(</font> MergeBB <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  TheFunction <font color="#000040">-</font> <font color="#000080">&gt;</font> getBasicBlockList <font color="#008000">(</font> <font color="#008000">)</font> .  <font color="#007788">push_back</font> <font color="#008000">(</font> MergeBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#666666">// After IF code add only to MergeBB</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> MergeBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">return</font> zero <font color="#008080">;</font> <br></blockquote><br><br>  For while: <br><br><blockquote>  BasicBlock <font color="#000040">*</font> CondBB <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"whilexpr"</font> , TheFunction <font color="#008000">)</font> <font color="#008080">;</font> <br>  BasicBlock <font color="#000040">*</font> LoopBB <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"loop"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  BasicBlock <font color="#000040">*</font> AfterBB <font color="#000080">=</font> BasicBlock <font color="#008080">::</font> <font color="#007788">Create</font> <font color="#008000">(</font> getGlobalContext <font color="#008000">(</font> <font color="#008000">)</font> , <font color="#FF0000">"after"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  Builder.  <font color="#007788">CreateBr</font> <font color="#008000">(</font> CondBB <font color="#008000">)</font> <font color="#008080">;</font> <br><br>  <font color="#666666">// Condition block.</font>  <font color="#666666">Add the code here.</font>  <font color="#666666">We generate the condition code, Compare the result with 0</font> <br>  <font color="#666666">// And if the condition is not met - go to AfterBB</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> CondBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  Value <font color="#000040">*</font> CondV <font color="#000080">=</font> cond <font color="#000040">-</font> <font color="#000080">&gt;</font> emit <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  <font color="#0000ff">if</font> <font color="#008000">(</font> CondV <font color="#000080">==</font> <font color="#0000dd">0</font> <font color="#008000">)</font> <font color="#0000ff">return</font> <font color="#0000dd">0</font> <font color="#008080">;</font> <br>  <font color="#666666">// Convert condition to compose equal to 0.</font> <br>  CondV <font color="#000080">=</font> Builder.  <font color="#007788">CreateICmpNE</font> <font color="#008000">(</font> CondV, zero, <font color="#FF0000">"whilecond"</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  Builder.  <font color="#007788">CreateCondBr</font> <font color="#008000">(</font> CondV, LoopBB, AfterBB <font color="#008000">)</font> <font color="#008080">;</font> <br><br><br>  <font color="#666666">// Block while body.</font>  <font color="#666666">We write the body code here, then the transition to the condition WHILE</font> <br>  TheFunction <font color="#000040">-</font> <font color="#000080">&gt;</font> getBasicBlockList <font color="#008000">(</font> <font color="#008000">)</font> .  <font color="#007788">push_back</font> <font color="#008000">(</font> LoopBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> LoopBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  Value <font color="#000040">*</font> Ops <font color="#000080">=</font> this <font color="#000040">-</font> <font color="#000080">&gt;</font> ops.  <font color="#007788">emit</font> <font color="#008000">(</font> <font color="#008000">)</font> <font color="#008080">;</font> <br>  Builder.  <font color="#007788">CreateBr</font> <font color="#008000">(</font> CondBB <font color="#008000">)</font> <font color="#008080">;</font> <br><br><br>  <font color="#666666">// Block "After WHILE ', At the moment, just say</font> <br>  <font color="#666666">// That all the following code should be written in this block</font> <br>  TheFunction <font color="#000040">-</font> <font color="#000080">&gt;</font> getBasicBlockList <font color="#008000">(</font> <font color="#008000">)</font> .  <font color="#007788">push_back</font> <font color="#008000">(</font> AfterBB <font color="#008000">)</font> <font color="#008080">;</font> <br>  Builder.  <font color="#007788">SetInsertPoint</font> <font color="#008000">(</font> AfterBB <font color="#008000">)</font> <font color="#008080">;</font> <br></blockquote><br><br><h4>  Finally, we can try our compiler </h4><br><br> <code>#make <br> bison -d jsk.y <br> flex jsk.lex <br> g++ -O2 jsk.tab.c lex.yy.c `llvm-config --cxxflags --libs` -lrt -ldl -o jskc <br> jsk.tab.c: In function 'int yyparse()': <br> jsk.tab.c:2026: warning: deprecated conversion from string constant to 'char*' <br> jsk.tab.c:2141: warning: deprecated conversion from string constant to 'char*' <br> jsk.lex: In function 'int yylex()': <br> jsk.lex:34: warning: deprecated conversion from string constant to 'char*' <br> jsk.lex:35: warning: deprecated conversion from string constant to 'char*' <br> jsk.lex:39: warning: deprecated conversion from string constant to 'char*' <br></code> <br><br>  So.  The compiler is ready.  Let's try it on some test task.  For example on <br> <code>a=b=88; <br> b=b+1; <br> echo("test4=",a," ",b,"\n"); <br></code> <br><br>  We perform: <br><br>  ./jskc &lt;test3.jsk <br><br>  And we get a.out.bc in the current directory.  We can disassemble it: <br><br>  llvm-dis &lt;a.out.bc <br> <code><code>; ModuleID = '' <br> <br> @.format1 = internal constant [3 x i8] c"%d\00" ; &lt;[3 x i8]*&gt; [#uses=1] <br> @.format2 = internal constant [3 x i8] c"%s\00" ; &lt;[3 x i8]*&gt; [#uses=1] <br> @0 = internal constant [7 x i8] c"test4=\00" ; &lt;[7 x i8]*&gt; [#uses=1] <br> @1 = internal constant [2 x i8] c" \00" ; &lt;[2 x i8]*&gt; [#uses=1] <br> @2 = internal constant [2 x i8] c"\0A\00" ; &lt;[2 x i8]*&gt; [#uses=1] <br> <br> define void @main() { <br> code: <br> %a = alloca i32 ; &lt;i32*&gt; [#uses=2] <br> %b = alloca i32 ; &lt;i32*&gt; [#uses=4] <br> %int_for_scanf___ = alloca i32 ; &lt;i32*&gt; [#uses=0] <br> store i32 88, i32* %b <br> store i32 88, i32* %a <br> %0 = load i32* %b ; [#uses=1] <br> %1 = add i32 %0, 1 ; [#uses=1] <br> store i32 %1, i32* %b <br> call void (i8*, ...)* @printf(i8* getelementptr inbounds ([3 x i8]* @.format2, i32 0, i32 0), i8* getelementptr inbounds ([7 x i8]* @0, i32 0, i32 0)) <br> %2 = load i32* %a ; [#uses=1] <br> call void (i8*, ...)* @printf(i8* getelementptr inbounds ([3 x i8]* @.format1, i32 0, i32 0), i32 %2) <br> call void (i8*, ...)* @printf(i8* getelementptr inbounds ([3 x i8]* @.format2, i32 0, i32 0), i8* getelementptr inbounds ([2 x i8]* @1, i32 0, i32 0)) <br> %3 = load i32* %b ; [#uses=1] <br> call void (i8*, ...)* @printf(i8* getelementptr inbounds ([3 x i8]* @.format1, i32 0, i32 0), i32 %3) <br> call void (i8*, ...)* @printf(i8* getelementptr inbounds ([3 x i8]* @.format2, i32 0, i32 0), i8* getelementptr inbounds ([2 x i8]* @2, i32 0, i32 0)) <br> ret void <br> } <br> <br> declare void @printf(i8*, ...) <br> <br> declare void @scanf(i8*, ...) <br> <br> declare void @exit(i32) <br> <br> <br>      <i>lli</i> ,  (  ) -     : <br> <br> $ llvmc a.out.bc <br> <br>  (!) a.out, <b>   ,      JSK</b> : <br> <br> $ ls -al ./a.out <br> -rwxr-xr-x 1 walrus walrus 4639 2010-08-25 16:49 ./a.out <br> <br> $ file a.out <br> a.out: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.6.15, not stripped <br> <br> $ ldd a.out <br> linux-gate.so.1 =&gt; (0x00762000) <br> libc.so.6 =&gt; /lib/tls/i686/cmov/libc.so.6 (0x00456000) <br> /lib/ld-linux.so.2 (0x00ee4000) <br></code> <br> <br> , <br> <code>$ ./a.out <br> test4=88 89 <br></code> <br> <br>    .</code> </div><p>Source: <a href="https://habr.com/ru/post/102597/">https://habr.com/ru/post/102597/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102588/index.html">Inkscape 0.48 released</a></li>
<li><a href="../102593/index.html">Beta Firefox 4: new update released - how will it affect web developers?</a></li>
<li><a href="../102594/index.html">Today is the release of Miranda IM 0.9</a></li>
<li><a href="../102595/index.html">Catch up</a></li>
<li><a href="../102596/index.html">Teachers are asked to remove their students from friends on Facebook.</a></li>
<li><a href="../102598/index.html">Some other tips for PHP developers.</a></li>
<li><a href="../102599/index.html">Russian programmers made the world's first female calendar in the Albanian language</a></li>
<li><a href="../102601/index.html">Bing - routes in Russia</a></li>
<li><a href="../102602/index.html">Another scam, beware</a></li>
<li><a href="../102604/index.html">Delivery Club</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>