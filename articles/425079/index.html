<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Difficult IPSec with Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Developing IT infrastructure sooner or later comes the task of integrating with any services of a large organization. This may be, for example, a bank...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Difficult IPSec with Linux</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/9i/ar/ia/9iariac5i8g79f_qasyzcuf5tnc.png"><br><br>  Developing IT infrastructure sooner or later comes the task of integrating with any services of a large organization.  This may be, for example, a bank or carrier.  As a rule, in large organizations, well-established information security policies are in place, which in particular require the implementation of a service with an infrastructure external to them through encrypted channels - IPSec.  At the same time, in small <s>start</s> - <s>up</s> organizations there is no experience in organizing such schemes, and from the equipment there is only VDS with Linux on board.  Moreover, to my surprise, there are practically no materials in RuNet with a description of Linux troubleshooting tools.  Let's try to eliminate this gap and describe the practical part of the settings. <br><a name="habracut"></a><br>  The general scheme of the service is presented below.  As a rule, in large organizations everything is already standardized, put on stream, all possible encryption and other networking things are done on separate equipment (tsiski-junipery and others like them), and, more importantly, by <b>individual people</b> (perhaps every blue square on the diagram below serve different people).  You have one virtual machine with which the service will be launched and IPSec organized. <br><br><img src="https://habrastorage.org/webt/cw/1p/g0/cw1pg0gmvnixufv4anjqa2vgxrq.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Please note that IPSec itself is organized between the same IP addresses (in my example <code>10.0.255.1 &lt;-&gt; 10.0.1.1</code> ), and the service itself between the others ( <code>192.168.255.1&lt;-&gt; 192.168.1.1</code> ).  Such schemes are also called <i>IPSec Network-Network</i> . <br><br>  A simple example is that you work in a young, but very ambitious <i>SuperService</i> company, and you need to organize interaction with <i>MegaTelecom's</i> closed API.  Your infrastructure is one VDS server, the partner infrastructure is a bunch of network and server equipment.  The task is divided into two stages: <br><br><ol><li>  Arrange transportation (as will interconnection). </li><li>  Configure the service (run applications directly on the servers). </li></ol><br>  So, the <i>SuperService</i> manager decided to organize a connection to some large organization to solve a business problem.  He turned to <i>MegaTelecom</i> , for which he was sent <b>technical conditions</b> for connection.  One of these conditions is <b>IPSec</b> organization.  This condition came in the form of an <i>excel</i> tablet, an example of which I presented below.  In the picture I highlighted the technically significant parameters in yellow.  The format may be different, but the essence remains the same. <br><br><img src="https://habrastorage.org/webt/wi/jk/7t/wijk7treuikfegnmkk9sof2pnze.png"><br><br>  Initially, it comes not completed on your part, it must be completed and sent to the partner for approval.  After agreeing, you can sit down and try to customize your Linux machine. <br><br><h3>  IPSec concept </h3><br>  Next, I will give a bit of theory for people who are not at all familiar with technology.  Everything I describe further refers to pure Ethernet and IPv4.  I will not go into encryption algorithms, key exchange, instead focus on the network part. <br><br>  <b>IPSec</b> is a set of techniques and protocols for establishing a secure connection. <br><br>  Unlike other tunneling technologies (GRE, PPP, L2TP, even MPLS-TE) IPSec does not create explicit tunnel interfaces through which traffic can be routed.  Instead, IPSec provides the concept of so-called <b>Security Assotiations (SA)</b> .  <i>SA</i> is a tunnel from one network device to another.  But do not forget that <i>SA</i> is not a network interface in the normal sense of the word, classical routing does not work here.  Instead of the routing table, the concept of <b>Security Policy (SP)</b> works here.  We explicitly prescribe something like an access list (ACL) for passing traffic through a specific SA.  All these things are defined in the so-called <b>ISAKMP</b> framework. <br><blockquote>  <b>ISAKMP</b> is a description of IPSec procedures, referred to in the literature as its framework.  It describes the terms SA, SP, SAD (Security Assotiations Database), SPD (Security Policy Database), the need to install auxiliary tunnels ... ISAKMP is designed so as not to depend on tunneling technologies, authentication algorithms and encryption.  It simply introduces the necessary definitions. <br><br>  <b>IKE (v1 / 2)</b> is an authentication protocol itself.  It already implements key exchange algorithms and their application. <br><br>  Thanks to the Cisco concept, ISAKMP and IKE are now considered synonymous. </blockquote>  Before encrypting traffic, the parties must agree on the parameters (and keys) of this encryption.  For this, an auxiliary tunnel (also called the ISAKMP tunnel) rises between both sides, which operates all the time.  This bidirectional tunnel is a connection over UDP (by default on port 500).  To organize this auxiliary tunnel, the parties must verify each other's authenticity (the password must match).  This is done by the <b>IKEv1 / 2</b> protocol <b>(Internet Key Exchange)</b> .  And already through an <i>ISAKMP-</i> organized tunnel, the parties agree to encrypt user traffic directly. <br><br>  The organization of IPSec itself is divided into two phases: <br><br><ol><li>  Creating an auxiliary ISAKMP tunnel </li><li>  Creating a user data tunnel </li></ol><br>  As I wrote, in the concept of IPSec (and already correct to say, in the concept of <i>ISAKMP</i> ) tunnels are called <i>SA</i> . <br><br>  The first phase (organization of ISAKMP SA) can be carried out in two modes: <br><br><ol><li>  <b>main</b> - the parties alternately exchange the negotiation parameters.  It is considered more secure, used for permanent channels (our case). </li><li>  <b>aggressive</b> - the initiator in one message sends all the necessary negotiation parameters, used when connecting a remote user for a temporary session (in order to be faster). </li></ol><br>  It should be understood that the <b>main</b> SA-tunnels are <b>unidirectional</b> .  For two-way data transmission over an IPSec channel, there must be two tunnels: source (src) ‚Üí receiver (dst) and vice versa. <br><br>  In all encryption methods, additional headers are added to the original IP packet, encapsulation occurs.  There are two ways of this encapsulation - <b>AH (Authentication Header)</b> and <b>ESP (Encapsulation Security Payload)</b> .  AH only authenticates the packet (digitally signed by the sender), ESP and authenticates (signs), and encrypts.  To date, AH is almost never used, all are packaged in ESP. <br><br>  You can encrypt and authenticate the source IP packet without taking into account the IP header (transport mode) or with it (tunnel mode).  <b>Transport is</b> used when you plan to organize your tunnels using other technologies (not IPSec / ESP).  For example, GRE, l2tp, ppp.  For the purpose of connecting some service to the internal infrastructure of a large organization, it is practically not used.  I used such a scenario to combine several offices into one VPN through IPSec.  We are more interested in the <b>tunnel</b> mode.  As you can see from the picture, one additional IP header is added here. <br><br><img src="https://habrastorage.org/webt/kc/pl/qe/kcplqeh1wmwmwlsidaj7ckvsnh0.png"><br><blockquote>  By the way, there is a real example of using AH-encapsulation.  Suppose we have two networks connected to different routers.  Hosts must transmit information with an MTU of 1500 bytes without fragmentation, but we have an intermediate section that supports only 1380 bytes.  The whole trail is trusted.  We can take advantage of the fact that IPSec does not create tunnel interfaces, in the classical sense through which traffic is not routed.  We will create an <i>AH</i> type <i>SA</i> tunnel (we don‚Äôt need to encrypt it), then the traffic will go to it.  Only external IP packets will be fragmented in traffic (by external IP headers), internal ones will be reassembled without changes. <br><br><img src="https://habrastorage.org/webt/o9/ni/p6/o9nip6nargofgqz9_77nfrbcily.png"><br></blockquote><img width="60%" align="right" src="https://habrastorage.org/webt/ar/v1/w1/arv1w1hdlpdoosmczuno9o1prue.png"><br>  Note that the <i>ESP</i> header gets up <b>to TCP / UDP transport</b> .  Remember, in the header of the IP packet there is a Protocol field?  Based on this field, the network equipment (and the final hosts) correctly process IP packets.  So for ESP your number is 50. The full list of protocols for this field can be viewed on the <a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers">wiki</a> , it can be very useful. <br><br><img align="right" src="https://habrastorage.org/webt/aa/ha/cs/aahacsstzsqw1ljf1x1j7omrm4c.png">  The absence of a transport-level header (TCP / UDP / ICMP is already encrypted!) Imposes a restriction on technologies like NAT.  Remember, NAT with port translation (overload, PAT, MASQARADE, it has many names) works on the basis of transport protocol ports.  And in the IPSec encrypted tunnel there are none!  To overcome this problem, there is a technology such as <b>IPSec NAT-Traversal (NAT-T)</b> .  During the first phase, the parties agree on the possibility of using NAT-T.  If both parties support NAT-T (and even on the same UDP ports), then a UDP header is added to the final tunnels for traffic, with which the packets will already pass through routers with network address translation. <br><br>  By itself, the tunnel does not rise, you need to send traffic there.  As I wrote above, routing rules do not work here, you need to write <b>Security Policy (SP)</b> . <br><br>  Policies consist of the source address, destination address, direction (in, out, fwd) and user tunnel parameters (ESP is described here as either AH, tunnel variant or transport).  This is more like organizing rules for NATa.  NAT also has insufficient routing table entries.  And there, too, the rules indicate <i>where, where and how</i> , and not <i>where and through what</i> .  And it is also possible to overwhelm the entire connection on a remote server with an incorrect hand movement. <br><blockquote>  All IPSec manipulations add overhead headers.  At a minimum, they will eat another 40 bytes from the source packet.  Thus, for example, with a standard MTU for PPPoE of 1380 bytes of connections, the real MTU will be &lt;1340. </blockquote><h3>  Linux IPSec </h3><br>  Let's practice on the example of DEB-distributions.  I will consider only the case with authorization based on the <i>pre-shared-key (PSK)</i> , we will configure the scheme from the beginning of the article. <br><br>  IPSec itself is supported by the kernel, but this support is very limited.  In reality, core modules are only concerned with encryption and with the keys already received (transferred to the kernel) - packet processing.  And to transfer there the parameters and rules with which you need to handle traffic, you need separate software.  There are several solutions for such software: <br><br><ol><li>  KAME, migrated from BSD </li><li>  xSWAN (strongswan, freeswan, libreswan, etc) </li><li>  <a href="http://www.shorewall.net/IPSEC-2.6.html">shorewall</a> </li></ol><br>  It seemed to me the simplest (most predictable) version of KAME, and we will continue to turn it on. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># deb-       root@localhost: ~# apt-get install racoon ipsec-tools</span></span></code> </pre><br>  Traditionally KAME consisted of two components. <br><br><ol><li>  A <b>racoon daemon</b> to manage the <i>ISAKMP</i> tunnel. </li><li>  <b>Setkey</b> utilities for managing SA data tunnels. </li></ol><br>  Let's start with the first.  <i>Racoon</i> is responsible for authorization parameters for tunnels within IKE.  This is a daemon, it is configured by a single configuration file ( <code>/etc/racoon.conf</code> ), it is run by a regular init-script ( <code>/etc/init.d/racoon &lt;start|stop|restart&gt;</code> ). <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /etc/racoon.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      remote  sainfo     # #      PSK  path pre_shared_key "/etc/racoon/psk.txt"; log debug; listen { #  ,      ISAKMP  isakmp 10.0.1.1 [500]; strict_address; } #   remote      IPSec. #      tunnel-group  ASA. #   IP-   anonymous #          . #     user-network # remote anonymous remote 10.0.255.1 { nat_traversal off; exchange_mode main; my_identifier address 10.0.1.1; proposal { encryption_algorithm 3des; hash_algorithm sha1; authentication_method pre_shared_key; dh_group modp1024; lifetime time 86400 sec; } } #   IPSec.  transform-set  ASA. # # ,      #       . #         # sainfo address &lt;src&gt; address &lt;dst&gt; #      ,       # sainfo anonymous sainfo address 192.168.1.1 any address 192.168.255.1 any { pfs_group modp1024; lifetime time 28800 sec; encryption_algorithm 3des; authentication_algorithm hmac_sha1; compression_algorithm deflate; }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /etc/racoon/psk.txt</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   PSK- #  &lt;REMOTE IP ADDR&gt; &lt;PASSWORD&gt; #  -      ,     racoon 10.0.255.1 SUPERPASSWORD</span></span></code> </pre><br></div></div><br>  As always, details in <a href="http://manpages.ubuntu.com/manpages/xenial/man5/racoon.conf.5.html"><code>man 5 racoon.conf</code></a> <br><br>  Further we will be <i>engaged in the setkey</i> utility.  It also runs as a daemon ( <code>/etc/init.d/setkey &lt;start|stop|restart&gt;</code> ), but in fact it executes the <code>/etc/ipsec-tools.conf</code> script.  As I said, it already sets up creates tunnels for user traffic.  Namely sets <b>SA and SP</b> for them.  This is something like a <i>crypto-map</i> on ASA.  The easiest option for us is to add just SP.  Then SA will be built automatically based on the parameters of the second phase, specified in the <i>racoon</i> settings. <br><br>  But it is possible not to use the parameters of the second phase from <i>racoon at all</i> , but to set the SA through this utility.  Details and syntax can be found in <a href="http://manpages.ubuntu.com/manpages/trusty/man8/setkey.8.html"><code>man 8 setkey</code></a> .  And I will give you an example of the simplest configuration. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /etc/ipsec-tools.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">flush; spdflush; spdadd 192.168.1.1/32 192.168.255.1/32 any -P out ipsec esp/tunnel/10.0.1.1-10.0.255.1/require; spdadd 192.168.255.1/32 192.168.1.1/32 any -P <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ipsec esp/tunnel/10.0.255.1-10.0.1.1/require;</code> </pre><br></div></div><br>  Currently, the <i>setkey</i> utility <i>is</i> duplicated by the <i>iproute2</i> module. <br>  Within it, there are two record management teams, SA and SP. <br><br><ol><li>  ip xfrm <b>state</b> </li><li>  ip xfrm <b>policy</b> </li></ol><br>  In addition to managing the same utility, you can view the status of organized SAs and <i>SPs</i> applied to traffic.  Read more in <a href="http://man7.org/linux/man-pages/man8/ip-xfrm.8.html"><code>man 8 ip-xfrm</code></a> . <br><blockquote>  Take another look at the original label.  There are different IP addresses for IPSec and service.  The internal IP address is filtered inside the <i>Megatelecom</i> infrastructure.  But we have only one virtual machine.  It should somehow appear internal IP-address, and packets into the tunnel must leave with him.  There are several options to achieve this scenario: <br><br><ol><li>  A static route without a nextop, but with an explicit indication of the outgoing interface and IP address. </li><li>  Setting routes based on policy based routing (PBR in Linux aka <i>ip rule</i> ). </li><li>  Address Translation ( <i>NAT / MASQARADE</i> ). </li></ol><br>  From my point of view, the first option is appropriate here. <br><br>  We can add an additional (secondary) IP address to our interface, while it is better to make an <b>alias</b> for this interface <br> <code>root@localhost: ~# ip addr add 192.168.1.1/32 dev eth1 label eth1:1</code> <br>  and configure the route to the <i>Megatelecom</i> server from this IP address. <br> <code>root@localhost: ~# ip route add 192.168.255.1/32 dev eth1:1 src 192.168.1.1</code> <br>  But if you do this, nothing will start.  The fact is that when adding a route in this form, the Linux station will try to determine the MAC address of the recipient, it will do it through ARP ... The computer will send ARP requests <code>Who has IP 192.168.255.1</code> .  Since 192.168.255.1 is not on the same network as 192.168.1.1 (mask / 32!), There will be no answer to ARP.  But when trying to connect, it will return from the local IP address. <code>No route to host</code> will be returned.  To defeat this, we need to set a static ARP record: <br> <code>root@localhost: ~# arp -s 192.168.255.1 00:00:00:00:00:01 -i eth1:1</code> <br>  Such a life hack.  By the way, such manipulations can lead not quite to the correct operation of the Linux IP stack.  In one of the cases, the <code>ip route</code> commands did not lead to the desired result, we had to reload the network stack. <br></blockquote><h3>  Health check </h3><br><br>  Do not forget, the tunnel will rise only when the traffic goes into it!  You need to run ping from a specific interface (IP address) before assignment. <br> <code>root@localhost: ~# ping -I 192.168.1.1 192.168.255.1</code> <br>  With a slight delay, there should be answers from the reverse side (if of course ICMP is not closed anywhere on the site). <br><br>  We can see if the ISAKMP tunnel is up. <br><br><div class="spoiler">  <b class="spoiler_title">racoonctl show-sa isakmp</b> <div class="spoiler_text"><pre> <code class="bash hljs">root@localhost: ~<span class="hljs-comment"><span class="hljs-comment"># racoonctl show-sa isakmp Destination Cookies Created 10.0.1.1.500 356a7e11111a93f:367111530375c065 2018-10-02 09:18:28</span></span></code> </pre><br></div></div><br>  We can also see user data tunnels. <br><br><div class="spoiler">  <b class="spoiler_title">racoonctl show-sa esp</b> <div class="spoiler_text"><pre> <code class="bash hljs">10.0.1.1 10.0.255.1 esp mode=tunnel spi=2148175815(0x800a8fc7) reqid=0(0x00000000) E: 3des-cbc 799e587f 6a2b4b78 5590cc2a 3d3ee331 f7e7f472 01abcdef A: hmac-sha1 01c5161f 46679a36 5d07ee9d f159fc9a 01abcdef seq=0x00000000 replay=4 flags=0x00000000 state=mature created: Oct 2 09:22:44 2018 current: Oct 2 10:39:21 2018 diff: 4597(s) hard: 28800(s) soft: 23040(s) last: Oct 2 09:22:45 2018 hard: 0(s) soft: 0(s) current: 84(bytes) hard: 0(bytes) soft: 0(bytes) allocated: 1 hard: 0 soft: 0 sadb_seq=1 pid=3764 refcnt=0 10.0.255.1 10.0.1.1 esp mode=tunnel spi=45614328(0x02b804f8) reqid=0(0x00000000) E: 3des-cbc 97cedcf1 644e8bbb c22b4e2c fa08a874 01abcdef 211ad19e A: hmac-sha1 1ab3e79d 3fd924a0 01abcdef 6c9ac89a 01abcdef seq=0x00000000 replay=4 flags=0x00000000 state=mature created: Oct 2 09:22:44 2018 current: Oct 2 10:39:21 2018 diff: 4597(s) hard: 28800(s) soft: 23040(s) last: Oct 2 09:22:45 2018 hard: 0(s) soft: 0(s) current: 84(bytes) hard: 0(bytes) soft: 0(bytes) allocated: 1 hard: 0 soft: 0 sadb_seq=0 pid=3764 refcnt=0</code> </pre><br></div></div><br>  It can be useful in <i>tcpdump to</i> see the connection establishment logic.  Here you can also see the phases of the establishment of the connection and the traffic already <b>encrypted</b> in ESP.  Of course, there are techniques to decipher it, but usually this is already enough. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # tcpdump -i eth1 host 10.0.255.1</b> <div class="spoiler_text"><pre> <code class="bash hljs">18:01:06.409631 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 1 I ident 18:01:06.439276 IP 10.0.255.1.500 &gt; 10.0.1.1.500: isakmp: phase 1 R ident 18:01:06.440840 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 1 I ident 18:01:06.475244 IP 10.0.255.1.1.500 &gt; 10.0.1.1.500: isakmp: phase 1 R ident 18:01:06.477032 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 1 I ident[E] 18:01:06.487785 IP 10.0.255.1.500 &gt; 10.0.1.1.500: isakmp: phase 1 R ident[E] 18:01:06.488048 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 2/others I inf[E] 18:01:07.412451 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 2/others I oakley-quick[E] 18:01:07.465363 IP 10.0.255.1.500 &gt; 10.0.1.1.500: isakmp: phase 2/others R oakley-quick[E] 18:01:07.465940 IP 10.0.1.1.500 &gt; 10.0.255.1.500: isakmp: phase 2/others I oakley-quick[E] 18:01:08.467373 IP 10.0.1.1 &gt; 10.0.255.1: ESP(spi=0x7aabfa82,seq=0x1), length 116 18:01:08.480141 IP 10.0.255.1 &gt; 10.0.1.1: ESP(spi=0x0386f867,seq=0x1), length 116</code> </pre><br></div></div><br><blockquote>  When remotely connecting via SSH, in order not to produce a bunch of windows, it is convenient to run tcpdump in the background: <br><br> <code>root@localhost: ~# tcpdump -i eth1 -w ipsec.pcap esp &amp; <br></code> <br><br>  Starting ping, telnet, netcat ... <br><br> <code>root@localhost: ~# killall tcpdump <br> root@localhost: ~# tcpdump -vr ipsec.pcap <br></code> <br></blockquote>  Also in the logs you can see the successful status of the connection.  It shows the successful establishment of both phases of IPSec. <br><br><div class="spoiler">  <b class="spoiler_title">root @ localhost: ~ # cat /var/log/daemon.log</b> <div class="spoiler_text"><pre> <code class="bash hljs">Oct 3 17:53:26 vm22433 racoon: INFO: IPsec-SA request <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> 10.0.255.1 queued due to no phase1 found. Oct 3 17:53:26 vm22433 racoon: INFO: initiate new phase 1 negotiation: 10.0.1.1[500]&lt;=&gt;10.0.255.1[500] Oct 3 17:53:26 vm22433 racoon: INFO: begin Identity Protection mode. Oct 3 17:53:26 vm22433 racoon: INFO: received Vendor ID: CISCO-UNITY Oct 3 17:53:26 vm22433 racoon: INFO: received Vendor ID: DPD Oct 3 17:53:26 vm22433 racoon: INFO: received Vendor ID: draft-ietf-ipsra-isakmp-xauth-06.txt Oct 3 17:53:26 vm22433 racoon: INFO: ISAKMP-SA established 10.0.1.1[500]-10.0.255.1[500] spi:ebddc300af62ae42:abcdef0123 Oct 3 17:53:27 vm22433 racoon: INFO: initiate new phase 2 negotiation: 10.0.1.1[500]&lt;=&gt;10.0.255.1[500] Oct 3 17:53:27 vm22433 racoon: INFO: received RESPONDER-LIFETIME: 4608000 kbytes Oct 3 17:53:27 vm22433 racoon: WARNING: attribute has been modified. Oct 3 17:53:27 vm22433 racoon: INFO: IPsec-SA established: ESP/Tunnel 10.0.1.1[500]-&gt;10.0.255.1[500] spi=238677(0xe39eabc) Oct 3 17:53:27 vm22433 racoon: INFO: IPsec-SA established: ESP/Tunnel 10.0.1.1[500]-&gt;10.0.255.1500] spi=7204011111(0x44b4aaa)</code> </pre></div></div><br>  That's all.  It remains to add all the necessary manipulations to autoload, and you can begin integrating applications. <br><br>  PS: Request to report any errors or inaccuracies in the article by a personal message.  When I correct the article, the comments will look silly. </div><p>Source: <a href="https://habr.com/ru/post/425079/">https://habr.com/ru/post/425079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../425069/index.html">Testing presenter using PromiseKit</a></li>
<li><a href="../425071/index.html">How to protect against stack overflow (on Cortex M)?</a></li>
<li><a href="../425073/index.html">Easy creation of a git repository on OneDrive</a></li>
<li><a href="../425075/index.html">Machine vision: installing, configuring and using Google Cloud Vision in PHP</a></li>
<li><a href="../425077/index.html">Kotlin under the hood - look decompiled bytecode</a></li>
<li><a href="../425081/index.html">The state does not know how much it spends on IT. Proving by numbers</a></li>
<li><a href="../425083/index.html">Postgresovaya stat without nerves and straining</a></li>
<li><a href="../425085/index.html">7 best practices for the operation of containers according to Google</a></li>
<li><a href="../425087/index.html">Openspace Agility: we implement Agile throughout the company (now with the manual!)</a></li>
<li><a href="../425089/index.html">IT in the animal world: searching for food with ants and the TCP / IP protocol</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>