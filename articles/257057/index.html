<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing the ws2812b protocol on ATmega</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="LEDs ws2812b is a very interesting thing. I want to tell now about the implementation of the protocol of their work. As in the previous article , the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing the ws2812b protocol on ATmega</h1><div class="post__text post__text-html js-mediator-article"><img align="left" width="300" src="https://habrastorage.org/files/9ef/2f1/fb4/9ef2f1fb4ada4d2c94d2a1e1b07f9d4d.jpg">  LEDs ws2812b is a very interesting thing.  I want to tell now about the implementation of the protocol of their work.  As in the <a href="http://habrahabr.ru/post/257041/">previous article</a> , the code was written in the IAR environment under the ATmega32 microcontroller with 16 MHz quartz.  I want to clarify right away that less than 16 MHz quartz is most likely not enough, this protocol is designed for very tight timings.  A zero is set at a time interval of 0.4 ¬µs, a unit of 0.8 ¬µs. <br><br><a name="habracut"></a><br><br><img src="https://habrastorage.org/files/5aa/6e7/ee0/5aa6e7ee09a64de7bbc088ce40233720.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      First of all, let's write the functions of setting 0 and 1 into the line.  The number of nop'ov in functions is chosen experimentally through a logic analyzer.  Screenshots are attached a little lower. <br><br><pre><code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">ClearOutBit</span></span> <span class="hljs-type"><span class="hljs-type">PORTC</span></span> &amp;= ~(<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>) //<span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">SetOutBit</span></span> <span class="hljs-type"><span class="hljs-type">PORTC</span></span> |= <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span> //<span class="hljs-number"><span class="hljs-number">1</span></span>   void <span class="hljs-type"><span class="hljs-type">Set0</span></span>( void ) //     ~<span class="hljs-number"><span class="hljs-number">0.4</span></span>  { <span class="hljs-type"><span class="hljs-type">SetOutBit</span></span>; asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>); <span class="hljs-type"><span class="hljs-type">ClearOutBit</span></span>; //     ,     ,      } void <span class="hljs-type"><span class="hljs-type">Set1</span></span>( void ) //     ~<span class="hljs-number"><span class="hljs-number">0.85</span></span>  { <span class="hljs-type"><span class="hljs-type">SetOutBit</span></span>; asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>);asm(<span class="hljs-comment"><span class="hljs-comment">"nop"</span></span>); <span class="hljs-type"><span class="hljs-type">ClearOutBit</span></span>; //     ,     ,      }</code> </pre> <br>  Next we have an array of values.  I created a 32 bit array of 30 values ‚Äã‚Äã(yes, I understand that this is overkill, but it seemed to me this solution is valid).  For each LED, we need to load 24 bits, with the first value being unloaded to the line for green, then red and then blue. <br><br><img src="//habrastorage.org/files/bbe/631/d9c/bbe631d9c62a4ac3bf44d096a4f1a986.jpg"><br><br>  It takes no more than 4 ms for the controller to align values ‚Äã‚Äãfor all 30 LEDs, which is quite fast.  Of course, if you increase the clock frequency, you can gain some time between bits.  Ideally, if all time slots match, for 30 LEDs the load will last less than 1 ms. <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mas[<span class="hljs-number"><span class="hljs-number">30</span></span>]; <span class="hljs-comment"><span class="hljs-comment">//32    30  void setMas( void ) //     { unsigned long int a; unsigned int j,i; for (j=0; j&lt;30; j++) { //  30 a = 0x1000000; //  G (Hi-&gt;Low),  R  B for (i=0;i&lt;24;i++){ //  G,R,B a=a&gt;&gt;1; if ((mas[j]&amp;a)==0x00000000) { Set0(); // } else { Set1(); // } } } }</span></span></code> </pre><br>  In fact, it turns out that only ‚Äúhigh voltage time‚Äù time intervals of 0.4 and 0.8 ¬µs are maintained, while the ‚Äúlow voltage time‚Äù program is not controlled by the program - they are obtained by operating the microcontroller between setting values ‚Äã‚Äãin a line.  After all, he needs time to check the condition and scroll through the cycle.  But nevertheless, the LEDs catch the package regularly.  And of course this time should not exceed 50 ¬µs, otherwise the LED will perceive it as a Reset and load the received ‚Äúincomplete‚Äù value to itself on the display. <br><br><img src="//habrastorage.org/files/a50/43e/df0/a5043edf0a4a43a798361b3c686aa6fe.jpg"><br><img src="//habrastorage.org/files/1dc/2c0/bae/1dc2c0bae22a47eda833ccea737e1b08.jpg"><br><br>  At the end of the article there is a video of the work of these 30 LEDs with a circular shift of the original array by timer and controlled via an <a href="http://habrahabr.ru/post/257041/">IR remote control with the NEC protocol</a> .  It turned out fun. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/qaMcy-RixF8%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgeEvB10o4TtfJxP2BCqigbsexn0A" frameborder="0" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/257057/">https://habr.com/ru/post/257057/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../257047/index.html">How we participated in the opening of the world's largest store of children's toys</a></li>
<li><a href="../257049/index.html">Extend Selenium WebDriver. Writing a robot for the RSDN, not thinking about the context</a></li>
<li><a href="../257051/index.html">Html-maker - convenient and easy generation of html using coffeescript</a></li>
<li><a href="../257053/index.html">The progress of the heavy task in PHP</a></li>
<li><a href="../257055/index.html">SMART Life (cont.)</a></li>
<li><a href="../257063/index.html">How Aviasales Material Design Switched</a></li>
<li><a href="../257065/index.html">How we launched the weather probe in the Urals. Part 1</a></li>
<li><a href="../257067/index.html">Chips with subliminal operating supply voltages - a revolutionary approach to reducing current consumption</a></li>
<li><a href="../257069/index.html">Open accounting in the Ministry of Education and Science of Ukraine</a></li>
<li><a href="../257071/index.html">Mini-review of libraries for Reflection in C ++</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>