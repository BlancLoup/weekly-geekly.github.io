<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Perform clustering on the example of BitrixVM: simple and clear</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Providing fault tolerance is a guarantee of continuous work and, in general, complete satisfaction of both users and administrators. In our today's ma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Perform clustering on the example of BitrixVM: simple and clear</h1><div class="post__text post__text-html js-mediator-article">  Providing fault tolerance is a guarantee of continuous work and, in general, complete satisfaction of both users and administrators.  In our today's material, we will discuss how to clusterize BitrixVM using simple and affordable tools, so that everyone would be happy and nothing would interfere with quiet work. <a name="habracut"></a><br><br>  So, we have two servers with BitrixVM and Bitrix24 systems deployed on them.  The first thing to do is to maintain data homogeneity on both nodes to synchronize both between databases and between bitrix files. <br><br>  Bitrix1 - 172.16.10.1 <br>  Bitrix2 - 172.16.10.2 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Be sure to write in the files of the hosts line on both machines: <br><br><pre><code class="hljs css">172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bitrix1</span></span> 172<span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bitrix2</span></span></code> </pre> <br>  For the database, we will use replication of master-master data.  To do this, we need to correct the settings in the <b>/etc/my.cnf</b> files <b>.</b> <br><br>  Bitrix recommends to override your own settings to create the file <b>/etc/mysql/conf.d/z_bx_custom.cnf</b> , in which you should edit: <br><br><pre> <code class="hljs vhdl">[root@bitrix1 /]# cat /etc/my.cnf # # Basic mysql <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">Use</span></span> bvat <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> advanced settings. # Parameters set by bvat are stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/mysql/conf.d/bvat.cnf # <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> change any <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span>, you<span class="hljs-symbol"><span class="hljs-symbol">'ll</span></span> have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> redefine it <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> #/etc/mysql/conf.d/z_bx_custom.cnf #</code> </pre><br>  Create a file in accordance with the recommendation: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">touch</span></span> /etc/mysql/conf.d/z_bx_custom.cnf [root<span class="hljs-variable"><span class="hljs-variable">@bitrix1</span></span> /]<span class="hljs-comment"><span class="hljs-comment"># nano /etc/mysql/conf.d/z_bx_custom.cnf [mysqld]</span></span></code> </pre><br>  Unique identifier of the server among the replication participants: <br><br><pre> <code class="hljs objectivec">server-<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  Writing to the logs of the modified binary data.  Without this option, an error may occur both in the logs and when entering the bitrix-portal itself: <br><br><pre> <code class="hljs pgsql">Cannot <span class="hljs-keyword"><span class="hljs-keyword">execute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span>: impossible <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> binary <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> since BINLOG_FORMAT = <span class="hljs-keyword"><span class="hljs-keyword">STATEMENT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> at least one <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> uses a <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span> engine limited <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>-based logging. InnoDB <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> limited <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span>-logging <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">isolation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">COMMITTED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNCOMMITTED</span></span>. binlog_format=<span class="hljs-keyword"><span class="hljs-keyword">row</span></span></code> </pre><br>  Error logs: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">log</span></span>=/var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/mysqld.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> log_error = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/mysqld.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre><br>  Path to server transaction logs (binlog, which is maintained by the master): <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-bin = /var/lib/mysql/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-mysql-bin <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-bin-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = /var/lib/mysql/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-mysql-bin.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span></code> </pre><br>  Path to relay-logs slave (binlog, downloaded from the wizard): <br><br><pre> <code class="hljs pgsql">relay-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> = /var/lib/mysql/slave-mysql-relay-bin relay-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = /var/lib/mysql/slave-mysql-relay-bin.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span></code> </pre><br>  DBs that need or do not need to be replicated (we perform only replication for the standard bitrix database - <b>sitemanager0</b> ): <br><br><pre> <code class="hljs sql">replicate-<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-db = sitemanager0 <span class="hljs-keyword"><span class="hljs-keyword">replicate</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">ignore</span></span>-db=<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replicate</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">ignore</span></span>-db=information_schema <span class="hljs-keyword"><span class="hljs-keyword">replicate</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">ignore</span></span>-db=mysql <span class="hljs-keyword"><span class="hljs-keyword">replicate</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">ignore</span></span>-db=performance_schema</code> </pre><br>  Do not log binlog for database: <br><br><pre> <code class="hljs">binlog-ignore-db = information_schema binlog-ignore-db = mysql binlog-ignore-db = performance_schema</code> </pre><br>  To avoid autoincrement conflicts, we inform the server that ids are generated starting from the 3rd, adding 10 each, i.e.  13, 23, 33, 43 and further: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">auto_increment_increment</span></span> = <span class="hljs-number"><span class="hljs-number">10</span></span> auto_increment_offset = <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br>  Save logs from the wizard to your binlog to transfer to the slave: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-slave-updates</code> </pre><br>  After this, restart mysql: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix1 /</span></span>]<span class="hljs-meta"><span class="hljs-meta"># /etc/init.d/mysqld restart</span></span></code> </pre><br>  Next, you need to switch to the second BitrixVM, i.e.  bitrix2, and perform the same settings for mysql, also having previously created the <b>z_bx_custom.cnf</b> file in <b>/etc/mysql/conf.d/</b> , while changing the <b><i>server-id</i></b> and <b><i>auto_increment_offset</i></b> : <br><br><pre> <code class="hljs pgsql">[root@bitrix2 ~]# cat /etc/mysql/conf.d/z_bx_custom.cnf [mysqld] <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-id = <span class="hljs-number"><span class="hljs-number">2</span></span> binlog_format=<span class="hljs-keyword"><span class="hljs-keyword">row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>=/var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/mysqld.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> log_error = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/mysqld.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-bin = /var/lib/mysql/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-mysql-bin <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-bin-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = /var/lib/mysql/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-mysql-bin.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> relay-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> = /var/lib/mysql/slave-mysql-relay-bin relay-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> = /var/lib/mysql/slave-mysql-relay-bin.<span class="hljs-keyword"><span class="hljs-keyword">index</span></span> replicate-<span class="hljs-keyword"><span class="hljs-keyword">do</span></span>-db = sitemanager0 replicate-ignore-db=test replicate-ignore-db=information_schema replicate-ignore-db=mysql replicate-ignore-db=performance_schema binlog-ignore-db = information_schema binlog-ignore-db = mysql binlog-ignore-db = performance_schema auto_increment_increment = <span class="hljs-number"><span class="hljs-number">10</span></span> auto_increment_offset = <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-slave-updates</code> </pre><br>  Perform a restart of mysql on the second machine: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix2 ~</span></span>]<span class="hljs-meta"><span class="hljs-meta"># /etc/init.d/mysqld restart</span></span></code> </pre><br>  For replication, create a user replicator on both machines: <br><br><pre> <code class="hljs pgsql">root@bitrix1 /]# mysql -u root -p Enter <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-string"><span class="hljs-string">'replicator'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> identified <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'aGiV4uac'</span></span>; mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span> slave <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> *.* <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-string"><span class="hljs-string">'replicator'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span>; root@bitrix2 /]# mysql -u root -p Enter <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-string"><span class="hljs-string">'replicator'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span> identified <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-string"><span class="hljs-string">'aGiV4uac'</span></span>; mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">grant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">replication</span></span> slave <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> *.* <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-string"><span class="hljs-string">'replicator'</span></span>@<span class="hljs-string"><span class="hljs-string">'%'</span></span>;</code> </pre><br>  Go back to the first machine and start the replication.  To do this, you need to know the name <b><i>master_log</i></b> and <b><i>master_log_position of the</i></b> second machine bitrix2: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix2 /</span></span>]<span class="hljs-meta"><span class="hljs-meta"># mysql -u root -p -e 'show master status;' +-----------------------+--------+------------+-------------------------------------------+ | File |Position|Binlog_Do_DB| Binlog_Ignore_DB | +-----------------------+--------+------------+-------------------------------------------+ |server-mysql-bin.000029| 819 | |information_schema,mysql,performance_schema| +-----------------------+--------+------------+-------------------------------------------+</span></span></code> </pre><br>  From the resulting list, it follows that <b>MASTER_LOG_FILE = server-mysql-bin.000029</b> , and <b>MASTER_LOG_POS = 819</b> <br><br>  We use this data to configure replication on the first machine: <br><br><pre> <code class="hljs objectivec">[root@bitrix1 /]<span class="hljs-meta"><span class="hljs-meta"># root -p -e </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CHANGE MASTER TO MASTER_HOST = '172.16.10.2', MASTER_USER = 'replicator', MASTER_PASSWORD = 'aGiV4uac', MASTER_LOG_FILE = 'server-mysql-bin.000029', MASTER_LOG_POS = 819;"</span></span></span></span></code> </pre><br>  Run the slave: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix1 /</span></span>]<span class="hljs-meta"><span class="hljs-meta"># mysql -u root -p -e 'start slave;'</span></span></code> </pre><br>  Checking status: <br><br><pre> <code class="hljs markdown">[root@bitrix1 /]# mysql -u root -p -e 'show slave status \G;' <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">** 1. row **</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> Slave<span class="hljs-emphasis"><span class="hljs-emphasis">_IO_</span></span>State: Waiting for master to send event Master<span class="hljs-emphasis"><span class="hljs-emphasis">_Host: 172.16.10.2 Master_</span></span>User: replicator Master<span class="hljs-emphasis"><span class="hljs-emphasis">_Port: 3306 Connect_</span></span>Retry: 60 Master<span class="hljs-emphasis"><span class="hljs-emphasis">_Log_</span></span>File: server-mysql-bin.000029 Read<span class="hljs-emphasis"><span class="hljs-emphasis">_Master_</span></span>Log<span class="hljs-emphasis"><span class="hljs-emphasis">_Pos: 819 Relay_</span></span>Log<span class="hljs-emphasis"><span class="hljs-emphasis">_File: slave-mysql-relay-bin.000002 Relay_</span></span>Log<span class="hljs-emphasis"><span class="hljs-emphasis">_Pos: 72951 Relay_</span></span>Master<span class="hljs-emphasis"><span class="hljs-emphasis">_Log_</span></span>File: server-mysql-bin.000029 Slave<span class="hljs-emphasis"><span class="hljs-emphasis">_IO_</span></span>Running: Yes Slave<span class="hljs-emphasis"><span class="hljs-emphasis">_SQL_</span></span>Running: Yes Replicate<span class="hljs-emphasis"><span class="hljs-emphasis">_Do_</span></span>DB: sitemanager0 Replicate<span class="hljs-emphasis"><span class="hljs-emphasis">_Ignore_</span></span>DB: test,information<span class="hljs-emphasis"><span class="hljs-emphasis">_schema,mysql,performance_</span></span>schema Replicate<span class="hljs-emphasis"><span class="hljs-emphasis">_Do_</span></span>Table: Replicate<span class="hljs-emphasis"><span class="hljs-emphasis">_Ignore_</span></span>Table: Replicate<span class="hljs-emphasis"><span class="hljs-emphasis">_Wild_</span></span>Do<span class="hljs-emphasis"><span class="hljs-emphasis">_Table: Replicate_</span></span>Wild<span class="hljs-emphasis"><span class="hljs-emphasis">_Ignore_</span></span>Table: Last<span class="hljs-emphasis"><span class="hljs-emphasis">_Errno: 0 Last_</span></span>Error: Skip<span class="hljs-emphasis"><span class="hljs-emphasis">_Counter: 0 Exec_</span></span>Master<span class="hljs-emphasis"><span class="hljs-emphasis">_Log_</span></span>Pos: 819 Relay<span class="hljs-emphasis"><span class="hljs-emphasis">_Log_</span></span>Space: 73113 Until<span class="hljs-emphasis"><span class="hljs-emphasis">_Condition: None Until_</span></span>Log<span class="hljs-emphasis"><span class="hljs-emphasis">_File: Until_</span></span>Log<span class="hljs-emphasis"><span class="hljs-emphasis">_Pos: 0 Master_</span></span>SSL<span class="hljs-emphasis"><span class="hljs-emphasis">_Allowed: No Master_</span></span>SSL<span class="hljs-emphasis"><span class="hljs-emphasis">_CA_</span></span>File: Master<span class="hljs-emphasis"><span class="hljs-emphasis">_SSL_</span></span>CA<span class="hljs-emphasis"><span class="hljs-emphasis">_Path: Master_</span></span>SSL<span class="hljs-emphasis"><span class="hljs-emphasis">_Cert: Master_</span></span>SSL<span class="hljs-emphasis"><span class="hljs-emphasis">_Cipher: Master_</span></span>SSL<span class="hljs-emphasis"><span class="hljs-emphasis">_Key: Seconds_</span></span>Behind<span class="hljs-emphasis"><span class="hljs-emphasis">_Master: 0 Master_</span></span>SSL<span class="hljs-emphasis"><span class="hljs-emphasis">_Verify_</span></span>Server<span class="hljs-emphasis"><span class="hljs-emphasis">_Cert: No Last_</span></span>IO<span class="hljs-emphasis"><span class="hljs-emphasis">_Errno: 0 Last_</span></span>IO<span class="hljs-emphasis"><span class="hljs-emphasis">_Error: Last_</span></span>SQL<span class="hljs-emphasis"><span class="hljs-emphasis">_Errno: 0 Last_</span></span>SQL<span class="hljs-emphasis"><span class="hljs-emphasis">_Error: Replicate_</span></span>Ignore<span class="hljs-emphasis"><span class="hljs-emphasis">_Server_</span></span>Ids: Master<span class="hljs-emphasis"><span class="hljs-emphasis">_Server_</span></span>Id: 2</code> </pre><br>  The <b>Seconds_Behind_Master</b> parameter (the lag time of the replica from the master) must be zero: <br>  <b>Slave_IO_State</b> should report: <b>"Waiting for master to send even"</b> <br>  <b>Slave_IO_Running = Yes</b> <br>  <b>Slave_SQL_Running = Yes</b> <br><br>  If the value in the <b>Slave_IO_State</b> line <b>is</b> absent, and <b>Seconds_Behind_Master</b> is <b>NULL</b> , then replication has not begun. <br><br>  <b><i>Recognize the master_log</i></b> and <b><i>master_log_position of the</i></b> first bitrix1 machine: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix1 /</span></span>]<span class="hljs-meta"><span class="hljs-meta"># mysql -u root -p -e 'show master status;' +-----------------------+--------+------------+-------------------------------------------+ | File |Position|Binlog_Do_DB| Binlog_Ignore_DB | +-----------------------+--------+------------+-------------------------------------------+ |server-mysql-bin.000026| 2930 | |information_schema,mysql,performance_schema| +-----------------------+--------+------------+-------------------------------------------+</span></span></code> </pre><br>  On the second machine bitrix2 we set up replication: <br><br><pre> <code class="hljs scala">[root<span class="hljs-meta"><span class="hljs-meta">@bitrix</span></span>2 ~]# mysql -u root -p -e <span class="hljs-string"><span class="hljs-string">"CHANGE MASTER TO MASTER_HOST = '172.16.10.1', MASTER_USER = 'replicator', MASTER_PASSWORD = 'aGiV4uac', MASTER_LOG_FILE = 'server-mysql-bin.000026', MASTER_LOG_POS = 2930;"</span></span> [root<span class="hljs-meta"><span class="hljs-meta">@bitrix</span></span>2 ~]# mysql -u root -p -e <span class="hljs-symbol"><span class="hljs-symbol">'stop</span></span> slave;' [root<span class="hljs-meta"><span class="hljs-meta">@bitrix</span></span>2 ~]# mysql -u root -p -e <span class="hljs-symbol"><span class="hljs-symbol">'show</span></span> slave status \<span class="hljs-type"><span class="hljs-type">G</span></span>;'</code> </pre><br>  The following parameters should be displayed: <b>Seconds_Behind_Master</b> , <b>Slave_IO_State</b> , <b>Slave_IO_Running</b> , <b>Slave_SQL_Running</b> with the same parameters as in the case of setting up replication on the bitrix1 machine. <br><br>  Next - you need to go to synchronize the data itself between Bitrix24.  File synchronization will be performed via csync2. <br><br>  The csync installation must be performed on both machines: <br><br><pre> <code class="hljs ruby">[root@bitrix1 /]<span class="hljs-comment"><span class="hljs-comment"># yum install csync2 [root</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@bitrix</span></span></span><span class="hljs-comment">2 /]# yum install csync2</span></span></code> </pre><br>  We include on both machines: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">chkconfig</span></span> xinetd <span class="hljs-literal"><span class="hljs-literal">on</span></span> chkconfig csync2 <span class="hljs-literal"><span class="hljs-literal">on</span></span></code> </pre><br>  We generate certificates while on the first bitrix1 machine: <br><br><pre> <code class="hljs kotlin">[<span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>bitrix1 /]# openssl genrsa -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /etc/csync2/csync2_ssl_key.pem <span class="hljs-number"><span class="hljs-number">1024</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>bitrix1 /]# openssl req -new -key /etc/csync2/csync2_ssl_key.pem -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /etc/csync2/csync2_ssl_cert.csr [<span class="hljs-symbol"><span class="hljs-symbol">root@</span></span>bitrix1 /]# openssl x509 -req -days <span class="hljs-number"><span class="hljs-number">600</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /etc/csync2/csync2_ssl_cert.csr -signkey /etc/csync2/csync2_ssl_key.pem -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> /etc/csync2/csync2_ssl_cert.pem</code> </pre><br>  Generating csync2 key: <br><br><pre> <code class="hljs pgsql">csync2 -k /etc/csync2/csync2.<span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>.key</code> </pre><br>  After a rather long generation process, the <b>csync2.cluster.key</b> key will appear in the <b>/ etc / csync2 /</b> folder <br><br>  Configuring for csync looks like this: <br><br><pre> <code class="hljs pgsql">[root@bitrix1 /]# cat /etc/csync2/csync2.cfg <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> { host bitrix1 bitrix2; key /etc/csync2/csync2.<span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span>.key; <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> /home/bitrix/www;</code> </pre><br>  We exclude the database connection settings files, since we use different passwords on both machines.  Also exclude cache directories: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span> /home/bitrix/www/bitrix/php_interface/dbconn.php; <span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span> /home/bitrix/www/bitrix/.settings.php; <span class="hljs-keyword"><span class="hljs-keyword">exclude</span></span> /home/bitrix/www/bitrix/<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>; exclude /home/bitrix/www/bitrix/managed_cache;</code> </pre><br>  We set the file selection parameter: the one that is the newest remains: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">auto</span></span> younger; }</code> </pre><br>  Copy the generated keys together with the <b>csync2.cfg</b> configuration file from bitrix1 to bitrix2, for example, using scp: <br><br><pre> <code class="hljs ruby">scp /etc/csync2/csync2* root@172.<span class="hljs-number"><span class="hljs-number">16.10</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-symbol"><span class="hljs-symbol">:/test</span></span></code> </pre><br>  Let's build a local database of all project files with which csync2 will work. <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix1 csync2</span></span>]<span class="hljs-meta"><span class="hljs-meta"># csync2 -cr /</span></span></code> </pre><br>  After - run: <br><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">root@bitrix1 /</span></span>]<span class="hljs-meta"><span class="hljs-meta"># /usr/sbin/csync2 ‚Äìxv</span></span></code> </pre><br>  In case of errors, you can use <b>/ usr / sbin / csync2 ‚ÄìTv</b> <br><br>  If the command completed without errors, you can add an entry to <b>/ etc / crontab</b> on both machines to run csync every minute: <br><br><pre> <code class="hljs javascript">*<span class="hljs-regexp"><span class="hljs-regexp">/1 * * * * root /u</span></span>sr/sbin/csync2 -x &gt;<span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span><span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  It remains to make a check: having created, for example, a message in the portal itself, a bitrix24 chat, delete, create a file and make sure that the changes are transferred between the nodes. <br><br>  As one of the options for a single entry point, you can use HAProxy, located on an additional server.  An overview of installing and configuring HAProxy will not be discussed in this article, since  There are enough guides on this issue, but for an example we will give the config of the <b>/etc/haproxy/haproxy.cfg</b> file: <br><br><pre> <code class="hljs pgsql">[root@haproxy haproxy]# cat haproxy.cfg <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> local2 <span class="hljs-keyword"><span class="hljs-keyword">notice</span></span> chroot /var/lib/haproxy pidfile /var/run/haproxy.pid maxconn <span class="hljs-number"><span class="hljs-number">4000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> haproxy <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> haproxy daemon nbproc <span class="hljs-number"><span class="hljs-number">1</span></span> # Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> processing cores. ulimit-n <span class="hljs-number"><span class="hljs-number">65536</span></span> # turn <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> stats unix socket stats socket /var/lib/haproxy/stats defaults mode http <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> httplog <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> dontlognull <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> http-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> forwardfor <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> redispatch retries <span class="hljs-number"><span class="hljs-number">3</span></span> timeout http-request <span class="hljs-number"><span class="hljs-number">5000</span></span> timeout queue <span class="hljs-number"><span class="hljs-number">5000</span></span> timeout <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> timeout client <span class="hljs-number"><span class="hljs-number">5000</span></span> timeout <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">5000</span></span> timeout http-keep-alive <span class="hljs-number"><span class="hljs-number">30</span></span> timeout <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> # maxconn <span class="hljs-number"><span class="hljs-number">3000</span></span> frontend bitrix.<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> mode http bind :<span class="hljs-number"><span class="hljs-number">80</span></span> default_backend bitrix backend bitrix mode http balance roundrobin <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> httpchk <span class="hljs-keyword"><span class="hljs-keyword">option</span></span> httpclose <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> bitrix1 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> bitrix2 <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">check</span></span></code> </pre><br>  Cluster your servers for health and may the Force be with you! <br><br> <a href="https://www.sim-networks.com/protected-cloud%3Fpid%3D2449%26utm_source%3Dhabrahabr%26utm_campaign%3Dcontent%26utm_medium%3Dpostlink"><img src="https://habrastorage.org/files/c2e/22e/3bd/c2e22e3bd22c4a0985f83c601d0394f4.png"></a> <br><br><hr><br>  <a href="https://www.sim-networks.com/protected-cloud%3Fpid%3D2449%26utm_source%3Dhabrahabr%26utm_campaign%3Dcontent%26utm_medium%3Dpostlink">SIM-CLOUD - Fail-safe cloud in Germany</a> <br><br>  <a href="https://www.sim-networks.com/dedicated-custom%3Fpid%3D2449%26utm_source%3Dhabrahabr%26utm_campaign%3Dcontent%26utm_medium%3Dpostlink">Dedicated servers in reliable data centers in Germany!</a> <br>  Any configuration, quick build and free installation </div><p>Source: <a href="https://habr.com/ru/post/317094/">https://habr.com/ru/post/317094/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317084/index.html">On the eve of the birthday of the first female programmer: my story</a></li>
<li><a href="../317086/index.html">New service on My Circle - access to the resume database</a></li>
<li><a href="../317088/index.html">Your / my / our code</a></li>
<li><a href="../317090/index.html">Asterisk, Hangupcause Substitution</a></li>
<li><a href="../317092/index.html">The Stegano exploit kit is used by attackers to compromise users.</a></li>
<li><a href="../317096/index.html">How many stars shine? Habrainterview with players, developers and publisher of "Space Rangers"</a></li>
<li><a href="../317098/index.html">How many stars shine, part 2: Habrainterviews with players, developers and publisher of "Space Rangers"</a></li>
<li><a href="../317100/index.html">Elastix 5 beta</a></li>
<li><a href="../317102/index.html">Lingvo API: ABBYY Dictionaries in the Windows Azure Cloud</a></li>
<li><a href="../317110/index.html">Information on the threshold of immortality, part 2: DNA storage</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>