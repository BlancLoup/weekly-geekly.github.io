<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>3 Attacks on TACACS + from Cisco</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I would like to tell today the results of my small research related to the TACACS + protocol, moreover from the Pentester point of view. I did not hav...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>3 Attacks on TACACS + from Cisco</h1><div class="post__text post__text-html js-mediator-article">  I would like to tell today the results of my small research related to the TACACS + protocol, moreover from the Pentester point of view.  I did not have to use the protocol directly, so I can not mention any subtleties. <br><br><h4>  What is TACACS + </h4><br>  Terminal Access Controller Access-Control System Plus (TACACS +) is a special Cisco protocol for AAA (authentication, authorization, and accounting).  That is, this is a protocol for centralized access control - most often access to Cisco, but you can screw something else. <br><br>  So, usually one or two servers go up with a TACACS + service on port 49 of the TCP protocol, and on all devices it is configured to use it.  Thus, when a user wants to authenticate on a switch, router or other device, the device sends its authentication data to the TACACS + server, where they are checked, and the decision is made to allow access, which is reported in the response packets 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/a71/80b/696/a7180b696d3a4f0bbb89da8b007fdc2b.png" alt="image"><br><br>  Convenient, centralized.  You can configure different privileges for different users on different devices.  There is access and action logging on the server side.  You can tie on top of another access centralization, such as AD or LDAP.  There is an open source server implementation (Cisco once officially posted the code). <br><a name="habracut"></a><br><h4>  Attack # 1 </h4><br>  The first "attack" is more like a trick than a full-fledged attack, but it can be useful in certain situations. <br><br>  So, let us imagine that during pentest we received a config from a tsiska (for example, pulling it from a TFTP server).  This, of course, is good, but even if we successfully scroll the local account from the device, we will not be able to log in as the device will check the account on the TACACS + server. <br><br>  But here it is worth remembering the typical configuration when connecting to TACACS +. <br>  Imagine that something happened with the TACACS + server and it is not available for a Cisco device, but the admin may need to log in to the device, but he cannot do it.  For such purposes, Cisco devices support various ‚Äútypes‚Äù of authentication that the administrator must specify during configuration. <br><br>  So, the classic authentication configuration for Cisco with TACACS + looks like this: <br><br><pre><code class="hljs pgsql">aaa authentication <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> tacacs+ <span class="hljs-keyword"><span class="hljs-keyword">local</span></span></code> </pre> <br>  Here, the last two words are important to us, which indicate that the authentication will first be verified using TACACS +, and later - by searching the local user database.  Moreover, if the user is not found in TACACS +, then it will not be checked locally. <br><br>  The essence of the first attack lies in the fact that we, as attacking, doS server TACACS +, then connect to the desired Cisco device using a local account.  And DoS is meant in a wider sense - you can send a special packet (once found) and a large number of TCP connections ... <br><br><img src="https://habrastorage.org/files/b57/ca9/e79/b57ca9e79d3742edb6f9b8bde93ba413.png" alt="image"><br><br><h4>  Intros for attacks 2 and 3 </h4><br>  Before proceeding to attacks 2 and 3, you need to learn something else about the TACACS + protocol.  The data in the protocol is transmitted either by plain text, or you can enable encryption.  It is organized on the basis of PSK (Pre-Shared Key), i.e.  the administrator himself specifies one key on the TACACS + server and all clients connecting to it (devices).  Moreover, only user data is encrypted, TACACS + headers are not encrypted.  Encryption itself, as far as I know, happens as follows: <br>  Encrypted data (enc_data) is the result of a XOR operation with data (data) and a special string - pseudo_pad. <br><br><pre> <code class="hljs haskell"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">^pseudo_pad=enc_data</span></span></code> </pre><br>  pseudo_pad is a sequence of MD5 hashes. <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">pseudo_pad</span></span> = {<span class="hljs-attribute"><span class="hljs-attribute">MD5_1</span></span> [,MD5_2 [ ... ,MD5_n]]}</code> </pre><br>  MD5 hashes are created based on data from TACACS + -packets headers, plus a shared key (PSK), plus the previous hash (for the first MD5, respectively, it does not).  Those.: <br><br><pre> <code class="hljs">MD5_1 = MD5{session_id, key, version, seq_no} MD5_2 = MD5{session_id, key, version, seq_no, MD5_1} .... MD5_n = MD5{session_id, key, version, seq_no, MD5_n-1}</code> </pre><br>  Where session_id is a random session identifier;  version ‚Äî protocol version;  seq_no - incremental package number;  key - psk. <br><br><img src="https://habrastorage.org/files/90e/9ca/536/90e9ca536cd5496e823af08409a73d84.png" alt="image"><br><br>  And it seems like the data is encrypted ... <br><br><h4>  Attack # 2 </h4><br>  So, let's specify the task and clarify the situation.  We have a Cisco device and a TACACS + server.  And we can get encrypted TACACS + traffic between them (using Man-in-the-Middle, for example).  Our goal is to get PSK, and using it to decrypt traffic and get valid accounts. <br><br>  Now let's see what we can do.  To begin with, as we see, the MD5 value is created from several values, but we don‚Äôt know just one of them - the common key, while all the others can be obtained from the TACACS + -packet headers.  Thus, if one asks for the task, then it all comes down to brute-force (without this, nowhere :) pick up the key.  At the same time, MD5 can be offline offline very quickly.  But for this we need to get the value of MD5_1. <br><br>  Next, we must remember that XOR is a reversible operation.  Those.  if we had the operation ‚Äúdata ^ pseudo_pad = enc_data‚Äù, then ‚Äúpseudo_pad = data ^ enc_data‚Äù.  At the same time, XOR is the simplest operation and changing a part of a string does not entail changes in another part of the string.  We get MD5_1 - this is the initial part of the pseudo_pad.  More specifically, 128 bits or 16 bytes.  And so, to get MD5_1, we need to know the first 16 bytes of the encrypted data and 16 bytes of the original data.  And if we have encrypted data in any amount of traffic, then how do we get 16 bytes of the original data? <br><br>  It is important to note: the format is different for requests and responses, as well as for their various types (we must remember that TACACS + is AAA - Authentication, Authorization, Accounting). <br><br>  But the general pattern is preserved in them - random or unknown to us values ‚Äã‚Äãin the first 16 bytes are almost absent. <br><br>  I will not go into details and give only the most convenient example.  This is the first response from the TACACS + server.  It contains several fields with a single value and a welcome line from the Cisco device to the user.  And since we can get a greeting line when connecting, it turns out that we all know the values ‚Äã‚Äãfor sure. <br><br><img src="https://habrastorage.org/files/917/f85/155/917f851556314ce2b8431c8f7035acc4.png" alt="image"><br><br>  Thus, we almost exactly know what unencrypted data is in the package, which allows us to get MD5_1 and locally locate it.  If successful, we will be able to fully decipher the traffic. <br><br>  To simplify the task of parsing the package and extracting MD5_1, I sketched the toolbar: tac2cat.py (as part of the TacoTaco project, see below) <br><br><img src="https://habrastorage.org/files/0cd/b15/b23/0cdb15b2385948beadc293bf8caf0c65.png" alt="image"><br><br><h4>  Attack number 3 </h4><br>  I spoke about these two attacks at a recent meeting of Defcon Russia at CC'2015.  And in the good traditions of our group, during the discussion I was given a couple of practical advice.  One of them was to look at the possibility of bit flipping. <br><br>  So, the script of the last attack.  We have a Cisco device and a TACACS + server.  We can conduct an active Man-in-the-Middle attack (i.e., we can change traffic).  The goal is to ‚Äúbreak everything‚Äù <br><br>  Looking closely at the protocol, two more important features emerged.  The first was that the protocol lacked integrity checking.  Those.  if we changed some value of the encrypted traffic, it affected the decrypted traffic (XOR) and the server ‚Äúate‚Äù it, not noticing the changes. <br><br>  The second feature was in the package format.  For both authentication packets and authorization, when requesting permission, the primary response is transmitted in the first byte of the response.  For example, 0x01 - authentication is successful, 0x02 - not successful. <br><br><img src="https://habrastorage.org/files/700/516/ba0/700516ba075748a99fd417ad7b450ec7.png" alt="image"><br><br>  Total, you need to change only one byte!  In its simplest form, we must do the following: <br><ul><li>  Get the pseudo_pad of this byte, XOR'nuv encrypted byte and the value known to us (if we enter incorrect data during authentication, then we know that the authentication will be denied to us - that is, the value will be 0x02) </li><li>  Re-XOR'nut pseudo_pad of this byte with a successful authentication byte (0x01) </li><li>  Change the byte in the encrypted traffic. </li></ul><br>  Thus, in the MitM attack, we will give permission for any incorrect data for authorization or authentication.  Moreover, in the same way we bypass authentication for elevation of privileges on a Cisco device (enable password). <br><br>  As a result, to implement this attack was written tulza - tacflip.py (as part of the TacoTaco project) <br><br>  Its operation was tested (bypassing authentication and authorization) with 7200-ciska in GNS3 and open source implementation of TACACS + server - tac_plus. <br>  A piece of TACACS + config looks like this. <br><br><pre> <code class="hljs pgsql">aaa authentication <span class="hljs-keyword"><span class="hljs-keyword">login</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> tacacs+ <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> aaa authentication <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> tacacs+ aaa <span class="hljs-keyword"><span class="hljs-keyword">authorization</span></span> exec <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> tacacs+ <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> tacacs-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> host <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.182</span></span><span class="hljs-number"><span class="hljs-number">.136</span></span> tacacs-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> directed-request tacacs-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> key <span class="hljs-number"><span class="hljs-number">12345</span></span></code> </pre><br>  And here is a small demo video of the input to the device, privilege escalation and command execution. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/HdTib8wftHA%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgvtyzAK-9JrxzT9IYPvguFVb2E3g" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Situation‚Ä¶ </h4>  In 2000, Solar Designer made an interesting protocol <a href="http://goo.gl/E2IGnk">goo.gl/E2IGnk</a> .  For example, the possibility of replay attacks, or disclosure of the user's password length (due to the lack of padding), and something else (bit flipping) was discovered.  But I did not find the practical implementation of them in public ... <br><br>  But my ‚Äúresherch‚Äù of this protocol is just a list of random interactions with the protocol for a long time, and not a targeted study.  Because of what I forgot about the results of the Solar Designer, I rediscovered something. <br><br>  Perhaps the main result of my labors are working tools (while in the beta stage). <br>  Meet the <b>TacoTaco</b> Project <a href="https://github.com/GrrrDog/TacoTaco">github.com/GrrrDog/TacoTaco</a> <br><br><h4>  Total: </h4><br>  You can probably calculate that the TACACS + protocol with its implementation does not provide the necessary level of protection against MitM attacks. <br><br>  On the other hand, these attacks are somewhat difficult, as often TACACS + servers are located in VLANs, available only to administrators and network equipment (such as recommendations from Cisco).  But this is another task. </div><p>Source: <a href="https://habr.com/ru/post/267467/">https://habr.com/ru/post/267467/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../267455/index.html">Docker Recipes: Monkey patch, part three</a></li>
<li><a href="../267457/index.html">Imitate, repeat, apply! English grammar at the count of three</a></li>
<li><a href="../267459/index.html">Hackathon at school InterSystems 2015</a></li>
<li><a href="../267461/index.html">Another algorithm for determining the intersection of two segments</a></li>
<li><a href="../267465/index.html">Exploit a million</a></li>
<li><a href="../267469/index.html">Search tips from the inside</a></li>
<li><a href="../267471/index.html">gulpfile in 10 lines? Easy! - we simplify the creation of standard tasks</a></li>
<li><a href="../267473/index.html">Understand Open Source</a></li>
<li><a href="../267475/index.html">How to bypass the lock screen in iOS without knowing the password</a></li>
<li><a href="../267477/index.html">Create a REST service on PostgreSQL and Rust. Part 1: prototype</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>