<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developer in the camera. Video</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apple constantly keeps developers on their toes. 
 Front cameras on the iPad and iPhone have given birth to a new round of ideas from the creators of ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developer in the camera. Video</h1><div class="post__text post__text-html js-mediator-article">  Apple constantly keeps developers on their toes. <br>  Front cameras on the iPad and iPhone have given birth to a new round of ideas from the creators of short-term applications.  I also did a little research on two-cell phones and invite you to click on the button, who cares. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f23/1ab/55f/f231ab55f1d8c9f573440a855393f240.png" alt="image"><br><br>  Video capture in iOS 4.3+ has become as simple as an orange. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  Four calls - and you are the owner of the pixels received from any of the two cameras iPhone. <br><br><h4>  A bit of code, designers do not read </h4><br>  We get our HabrahabrView <br><div class="spoiler">  <b class="spoiler_title">class HabrahabrView</b> <div class="spoiler_text"><pre><code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CaptureSessionManager</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HabrahabrView</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIView</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVCaptureVideoDataOutputSampleBufferDelegate</span></span></span><span class="hljs-class">&gt; </span></span>{ CaptureSessionManager *captureFront; CaptureSessionManager *captureBack; <span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> *face; }</code> </pre> <br></div></div><br>  In the class body, we introduce the obligatory function captureOutput, which will receive pictures from a video camera 20 times a second. <br><div class="spoiler">  <b class="spoiler_title">captureOutput function</b> <div class="spoiler_text"><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)captureOutput:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureOutput</span></span> *)captureOutput didOutputSampleBuffer:(<span class="hljs-built_in"><span class="hljs-built_in">CMSampleBufferRef</span></span>)sampleBuffer fromConnection:(<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureConnection</span></span> *)connection { CVImageBufferRef imageBuffer = <span class="hljs-built_in"><span class="hljs-built_in">CMSampleBufferGetImageBuffer</span></span>(sampleBuffer); <span class="hljs-comment"><span class="hljs-comment">// Lock the base address of the pixel buffer CVPixelBufferLockBaseAddress(imageBuffer, 0); // Get the number of bytes per row for the pixel buffer // void *baseAddress = CVPixelBufferGetBaseAddress(imageBuffer); // Get the number of bytes per row for the pixel buffer size_t bytesPerRow = CVPixelBufferGetBytesPerRow(imageBuffer); // Get the pixel buffer width and height size_t width = CVPixelBufferGetWidth(imageBuffer); size_t height = CVPixelBufferGetHeight(imageBuffer); unsigned char* pixel = (unsigned char *)CVPixelBufferGetBaseAddress(imageBuffer); CGColorSpaceRef colorSpace=CGColorSpaceCreateDeviceRGB(); CGContextRef context=CGBitmapContextCreate(pixel, width, height, 8, bytesPerRow, colorSpace, kCGBitmapByteOrder32Little|kCGImageAlphaPremultipliedFirst); CGImageRef image=CGBitmapContextCreateImage(context); CGContextRelease(context); CGColorSpaceRelease(colorSpace); UIImage *resultUIImage=[UIImage imageWithCGImage:image]; CGImageRelease(image); CVPixelBufferUnlockBaseAddress(imageBuffer, 0); [resultUIImage retain]; [self performSelectorOnMainThread:@selector(cameraCaptureGotFrame:) withObject:resultUIImage waitUntilDone:NO]; } - (void) cameraCaptureGotFrame:(UIImage*)image { face.image = [self fixOrientation:image]; // decrement ref count [image release]; }</span></span></code> </pre><br></div></div><br>  Now that all the preliminary work is finished, we get a picture on the screen where our video will be displayed. <br><div class="spoiler">  <b class="spoiler_title">Small ImageView 58 by 70</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"> face = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithFrame:<span class="hljs-built_in"><span class="hljs-built_in">CGRectMake</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">58</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>)]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> addSubview:face];</code> </pre><br></div></div><br>  So we connect the rear camera <br><div class="spoiler">  <b class="spoiler_title">Back camera ready</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureBack:[[[CaptureSessionManager alloc] init] autorelease]]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureBack] addVideoInput:<span class="hljs-number"><span class="hljs-number">2</span></span> PView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureBack] addVideoPreviewLayer]; [[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureBack] captureSession] setSessionPreset:<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureSessionPresetLow</span></span>];</code> </pre><br></div></div><br>  And so the front <br><div class="spoiler">  <b class="spoiler_title">Front camera ready</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"> [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> setCaptureFront:[[[CaptureSessionManager alloc] init] autorelease]]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureFront] addVideoInput:<span class="hljs-number"><span class="hljs-number">1</span></span> PView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureFront] addVideoPreviewLayer]; [[[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> captureFront] captureSession] setSessionPreset:<span class="hljs-built_in"><span class="hljs-built_in">AVCaptureSessionPresetLow</span></span>];</code> </pre><br></div></div><br>  Let's arrange all the functions in a separate class. <br><div class="spoiler">  <b class="spoiler_title">Here is a boring code, do not read</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"CaptureSessionManager.h"</span></span></span><span class="hljs-meta"> @implementation CaptureSessionManager @synthesize captureSession; @synthesize previewLayer; - (id)init { if ((self = [super init])) { [self setCaptureSession:[[AVCaptureSession alloc] init]]; } return self; } - (void)addVideoPreviewLayer { [self setPreviewLayer:[[[AVCaptureVideoPreviewLayer alloc] initWithSession:[self captureSession]] autorelease]]; [[self previewLayer] setVideoGravity:AVLayerVideoGravityResizeAspectFill]; } - (void)addVideoInput:(int)camType PView:(HabrahabrView*) habraview { NSArray *videoDevices = [AVCaptureDevice devicesWithMediaType:AVMediaTypeVideo]; AVCaptureDevice *videoDevice = nil; NSInteger side = (camType==1) ? AVCaptureDevicePositionFront : AVCaptureDevicePositionBack; for (AVCaptureDevice *device in videoDevices) { if (device.position == side) { videoDevice = device; break; } } if (videoDevice == nil) { videoDevice = [AVCaptureDevice defaultDeviceWithMediaType:AVMediaTypeVideo]; } if (videoDevice) { NSError *error; AVCaptureDeviceInput *videoIn = [AVCaptureDeviceInput deviceInputWithDevice:videoDevice error:&amp;error]; if (!error) { if ([[self captureSession] canAddInput:videoIn]) [[self captureSession] addInput:videoIn]; else NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Couldn't add video input"</span></span></span><span class="hljs-meta">); // Set the output AVCaptureVideoDataOutput* videoOutput = [[AVCaptureVideoDataOutput alloc] init]; // create a queue to run the capture on dispatch_queue_t captureQueue=dispatch_queue_create(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"catpureQueue"</span></span></span><span class="hljs-meta">, NULL); // setup our delegate [videoOutput setSampleBufferDelegate:habraview queue:captureQueue]; // configure the pixel format videoOutput.videoSettings = [NSDictionary dictionaryWithObjectsAndKeys:[NSNumber numberWithUnsignedInt:kCVPixelFormatType_32BGRA], (id)kCVPixelBufferPixelFormatTypeKey, nil]; if ([[self captureSession] canAddOutput:videoOutput]) [[self captureSession] addOutput:videoOutput]; else NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Couldn't add video ouput"</span></span></span><span class="hljs-meta">); } else NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Couldn't create video input"</span></span></span><span class="hljs-meta">); } else NSLog(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Couldn't create video capture device"</span></span></span><span class="hljs-meta">); } - (void)dealloc { [[self captureSession] stopRunning]; [previewLayer release], previewLayer = nil; [captureSession release], captureSession = nil; [super dealloc]; } @end</span></span></code> </pre></div></div>  Is done. <br><br><h4>  Work with cameras </h4><br>  Turn on the front camera <br><pre> <code class="objectivec hljs"> [[captureFront captureSession] startRunning];</code> </pre><br><br>  Everything is working.  As you can see from the video code, you can pull in three resolutions.  I choose the smallest AVCaptureSessionPresetLow for speed (approximately 144 by 192 pixels).  For our needs, this is enough, at the same time and the picture filter is free. <br><br>  How to turn on the rear camera now?  Stop the front and turn on the back <br><pre> <code class="objectivec hljs"> [[captureFront captureSession] stopRunning]; [[captureBack captureSession] startRunning];</code> </pre><br><br>  Immediately I wanted to include both.  Alas.  Impossible.  I tried to quickly switch the camera, but there is a delay of about a third of a second, which causes nothing but irritation. <br><br>  The dream of imposing two images online had to be killed. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/dQksdezpKZA%3Ffeature%3Doembed&amp;xid=17259,15700002,15700023,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhh7GS3b4BOgzv_HpDp5N6C3cssWng" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Fruit figurine </h4><br>  But do not kill the dream of some stupid application.  I decided to quickly create a fruit moth - the image from the front camera is real, oranges are virtual. <br><br>  Oranges in turn fall on the screen.  They need to capture the mouth and eat.  Who quickly eat 7 oranges - the prize. <br><br>  It remains to write the procedure for recognizing the mouth. <br>  Recognizing a mouth is a primitive occupation, even I, a person who is depressed from the words OOP, OpenSiVi, made this function quickly.  Using neither OOP nor OpenSiVi. <br>  Hint - you know the position of the orange and dance from it. <br><br>  Aha, the attentive reader exclaims - the recognition procedure is debugged solely on the author when illuminating his workplace.  You are right, but judging by the photos of users, the application works successfully from China to Brazil, from offices to apartments. <br><br>  Of course, there was a great temptation to sneak a photo of a user when he eats the 7th orange.  I always succumb to the temptations, because they can not happen again.  Calm  For lovers of morality, I added a button - Allow to send my photo.  The default is off. <br><br>  I send a small picture of a player in the size of 58 by 70 and secretly admire.  Come across very funny pictures.  Rzhu sometimes minutes to 3. There are also pretty personages. <br>  For God's sake, do not talk about the photo, keep corporate secrets. <br><br>  I completely forgot.  My record is 12 seconds.  I'm getting ready for the Olympics. <br><br>  See you in London, friends. </div><p>Source: <a href="https://habr.com/ru/post/148609/">https://habr.com/ru/post/148609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148602/index.html">DPAPI on the fingers</a></li>
<li><a href="../148604/index.html">Script for comparing two Oracle databases</a></li>
<li><a href="../148605/index.html">What words are used most often in the names of mobile applications on iOS</a></li>
<li><a href="../148606/index.html">Happy System Administrator Day</a></li>
<li><a href="../148608/index.html">We invite you to test the only in Ukraine Oracle Database Appliance solution</a></li>
<li><a href="../148610/index.html">Ubuntu on air. Developer answers to user questions in G +</a></li>
<li><a href="../148611/index.html">How does the architecture of Skype</a></li>
<li><a href="../148612/index.html">Beautiful print to PDF from Django</a></li>
<li><a href="../148613/index.html">mashina.org is not available under Beeline</a></li>
<li><a href="../148615/index.html">Why Google is a great ISP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>