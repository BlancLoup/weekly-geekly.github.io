<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>StringBuffer, and how hard it is to get rid of the legacy of the old code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. This article is a free translation of the StringBuffer post , and get rid of the legacy code . Somehow he was very impressed with me, so I deci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>StringBuffer, and how hard it is to get rid of the legacy of the old code</h1><div class="post__text post__text-html js-mediator-article"> Hello.  This article is a free translation of the <a href="https://vanilla-java.github.io/2017/04/13/String-Buffer-and-how-hard-it-is-to-get-rid-of-legacy-code.html">StringBuffer</a> post <a href="https://vanilla-java.github.io/2017/04/13/String-Buffer-and-how-hard-it-is-to-get-rid-of-legacy-code.html">, and get rid of the legacy code</a> .  Somehow he was very impressed with me, so I decided to translate.  Go. <br><br>  In 2006, <code>StringBuilder</code> appeared in the 5th java.  More lightweight and reasonable alternative to <code>StringBuffer</code> .  Here is what the <a href="https://docs.oracle.com/javase/1.5.0/docs/api/java/lang/StringBuffer.html">official</a> <code>StringBuffer</code> <a href="https://docs.oracle.com/javase/1.5.0/docs/api/java/lang/StringBuffer.html">documentation</a> <code>StringBuffer</code> : <br><br><blockquote>  This class is supplemented by a similar class intended for use in one stream - StringBuilder.  In general, you should give preference to the StringBuilder class, since it supports all the same operations as this (StringBuffer), but faster, because it does not perform any synchronization. </blockquote><br>  Having <code>synchronized</code> in <code>StringBuffer</code> has never been a good idea at all.  The main problem is that one operation is never enough.  A single <code>.append(x)</code> concatenation is useless without other operations, such as <code>.append(y)</code> and <code>.toString()</code> .  At a time when each particular method is thread-safe, you cannot make multiple calls without contention between threads.  Your only option is external sync. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So that?  So, 10 years later, no one uses StringBuffer !?  Well, at least, definitely not for the new functionality!? <br><br><h3>  How many objects does this code create? </h3><br>  As I wrote earlier, the virtual machine creates many objects at the start or when loading the main libraries.  Much more than you could imagine by asking the question above: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... args)</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Hello "</span></span> + <span class="hljs-string"><span class="hljs-string">"world"</span></span>); } }</code> </pre><br>  Oracle JVM Version 8 creates approximately 10_000 objects to run this program. <br><a name="habracut"></a><br><h3>  How much does StringBuffers create? </h3><br>  So, to run a JVM you need to create a lot of objects, but the old classes that have a faster alternative that shouldn't be used for 10 years, right? <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Waiting"</span></span>); System.in.read(); } }</code> </pre> <br>  While the process is running, we can execute the following command: <br><br><pre> <code class="hljs perl">jmap -histo <span class="hljs-string"><span class="hljs-string">{pid}</span></span> | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> StringBuffer</code> </pre> <br>  and we get: <br><br><pre> <code class="hljs css"> 18: 129 3096 <span class="hljs-selector-tag"><span class="hljs-selector-tag">java</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lang</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.StringBuffer</span></span></code> </pre> <br>  129 is the number of <code>StringBuffer</code> objects that Java 8 Update 121 has created. This is less than the last time I checked, but still, a little surprising. <br><br>  (I checked Java 131 update 131, I got a total of 14 objects). <br><br>  And what about new features - lambdas and streams?  They were created explicitly in the last 10 years and use some third-party libraries, like Objectwebs ASM.  And these developers precisely know the insides of the virtual machine and should have designed the new features as lightweight as possible. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Main</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ IntStream.range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>).forEach(System.out::println); System.out.println(<span class="hljs-string"><span class="hljs-string">"Waiting"</span></span>); System.in.read(); } }</code> </pre> <br>  Run <code>jmap</code> again and what do we see? <br><br><pre> <code class="hljs css"> 17: 545 13080 <span class="hljs-selector-tag"><span class="hljs-selector-tag">java</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.lang</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.StringBuffer</span></span></code> </pre> <br>  Additional 416 objects for the simplest lambda and stream! <br><br>  (Again, I checked Java 8 update 131 and got 430 objects, that is, the difference in the same 416 objects. It seems that the stream and lambda were not cleaned up). <br><br>  By the way, the program above generally creates: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">Total</span></span> <span class="hljs-number"><span class="hljs-number">35486</span></span> <span class="hljs-number"><span class="hljs-number">4027224</span></span></code> </pre> <br>  or 35_486 objects! <br><br><h3>  findings </h3><br>  Of course, using the StringBuffer at the start of the application does not make much difference, but knowing that there is a suitable alternative and the StringBuffer is still used even in new features ‚Äî it shows how difficult it is to get rid of the legacy of the old code or change the way people use the best practices. <br><br>  <b>PS</b> <br>  In the original post they left a <a href="https://bugs.openjdk.java.net/browse/JDK-8041679">link</a> to the cleaning ticket from <code>StringBuffer</code> in 9-ke. <br>  So it is quite possible in 3 months we will be left without a legacy :), the truth is only about <code>StringBuffer</code> .  Do not forget about <code>Vector</code> , <code>Hashtable</code> and other amenities. </div><p>Source: <a href="https://habr.com/ru/post/329956/">https://habr.com/ru/post/329956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329946/index.html">How many technologies does Yandex need for a search to find fresh documents almost instantly</a></li>
<li><a href="../329948/index.html">Non-recursive algorithm for generating all partitions and compositions of an integer</a></li>
<li><a href="../329950/index.html">A day in the life of technical support</a></li>
<li><a href="../329952/index.html">Product design digest, May 2017</a></li>
<li><a href="../329954/index.html">How to worry less about your own lack of talent</a></li>
<li><a href="../329960/index.html">Marie Meeker report from the Code Conference: the main thing</a></li>
<li><a href="../329962/index.html">Safety Guide for Web Developers</a></li>
<li><a href="../329964/index.html">Identity-as-a-Service (IDaaS). What is it?</a></li>
<li><a href="../329966/index.html">Psychology of testing (of course, not exhaustive). Personal translation from the book ‚ÄúThe Art of Testing‚Äù by G. Myers</a></li>
<li><a href="../329968/index.html">‚ÄúPreparing for the transition to Angular 4‚Äù: Tinkoff.ru about JS-development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>