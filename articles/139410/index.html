<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MS Windows Server 2003, failover cluster</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 We got a real dinosaur, - HP ProLiant DL380 G4 Packaged Cluster with MSA500 G2 , this is a turnkey solution from Hewlett Packard, two s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MS Windows Server 2003, failover cluster</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  We got a real dinosaur, - <a href="http://h18004.www1.hp.com/solutions/enterprise/highavailability/dl380/benefits-g4.html">HP ProLiant DL380 G4 Packaged Cluster with MSA500 G2</a> , this is a turnkey solution from Hewlett Packard, two servers with external storage, which means building a cluster.  Well, the cluster is so cluster, it is said done.  Previously, the experience of creating such systems was not, so I will try to describe the process as detailed as possible with all the errors we made. <br><img src="https://habrastorage.org/storage2/d7c/65c/eaa/d7c65ceaa797f3fb37b20f25a715fe95.png"><br><a name="habracut"></a><br><h4>  A bit of theory </h4><br>  So why do we need a cluster?  Here roughly two options: either the creation of a fault-tolerant system, or a load distribution system.  In my case, this is a fault-tolerant system: initially one server is running, if a software or hardware failure occurs, the second server comes into play, and a certain service installed on these servers quickly enough resumes.  I will not go into the details of the service for which this is all done, even for an example, it will be a program that pings something and creates a report about it. <br><br>  To build a cluster, it is necessary to take into account several fundamental conditions: compatible equipment of cluster segments - there are no problems here, we have identical servers, we also have compatible software and shared disk space.  Also cluster segments must be in the same domain.  Since the system will be independent in our technological network, we will have to create a domain as well.  For good, you need to have a separate server as a domain controller, and since the system must be fault tolerant, there must be two domain controllers.  But in the absence of these servers, the cluster segments will be domain controllers.  Active Directory services do not lend themselves to clustering, well, to hell with them, cluster by cluster, and domain controllers by themselves. <br><br><h4>  Disk array </h4><br>  Let's start with the preparation of hard drives.  The <a href="http://h20000.www2.hp.com/bizsupport/TechSupport/Home.jsp%3Flang%3Dru%26cc%3Dru%26prodTypeId%3D12169%26prodSeriesId%3D420477%26submit.y%3D5%26submit.x%3D4%26lang%3Den%26cc%3Dus">HP StorageWorks 500 G2 Modular Smart Array</a> disk array got with nine SCSI disks of 146 gigabytes and two of 34 gigabytes each.  It is connected to the servers via the SCSI interface, and is controlled by the built-in RAID controller utility in the servers themselves.  For the total disk space we will use disks of 146 gigabytes, and combine them into a RAID array.  Of the possible options was selected <a href="http://ru.wikipedia.org/wiki/RAID">RAID 6</a> , of course, compared with the fifth, it is less efficient, which in principle is not critical for us, but it is also more reliable.  Also for the cluster, you need to create a technological cluster monitoring section - quorum.  He needs at least 50 megabytes of disk space, so for the quorum we will use a mirror ( <a href="http://ru.wikipedia.org/wiki/RAID">RAID 1</a> ) of the two remaining 34 gigabyte disks, of course, a bit too much but there are no fewer disks.  On board the servers themselves, two SCSI disks are installed, the same in RAID 1, and the server operating systems will be on them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we have three RAID 1 RAID arrays and one RAID 6, with only eight of the nine disks used and one disk as a backup, so in theory, RAID will work even if three disks fail. <br><br><img src="https://habrastorage.org/storage2/170/a49/914/170a4991450b4d7b64a883b4a0e69f67.png"><br><br><h4>  OS and Active Directory </h4><br>  We initially installed Windows Server 2008, but later it turned out that the HP ProLiant DL380 G4 uses parallel SCSI, and parallel SCSI support, as the type of shared storage device <a href="http://support.microsoft.com/kb/947710/ru">was removed</a> in a Windows Server 2008-based failover cluster. I had to use Windows Server 2003, and <a href="http://ru.wikipedia.org/wiki/Microsoft_Hyper-V">Hyper -V is</a> out of the question.  I also want to note that you need to use Windows 2003 Enterprise or Datacenter, since Windows Server 2003 Standard and Web Editon do not support clustering. <br><br>  Using the Active Directory installation wizard, create a new domain: <br><br><img src="https://habrastorage.org/storage2/aaf/88a/124/aaf88a124f55204874cdbbe2e060ff0b.jpg"><br><br><img src="https://habrastorage.org/storage2/698/483/b12/698483b12b79112b00584fe9ac3a4dc2.jpg"><br><br>  I don‚Äôt see all the stages of the wizard show, I‚Äôll not see, I‚Äôll only pay attention to some moments.  AD Setup Wizard alerts you to a missing DNS.  The role of the DNS server could of course be added before creating the Active Directory, but you can do it right here: <br><br><img src="https://habrastorage.org/storage2/17e/f34/33e/17ef3433e8fc1b1e1f067c06f054129b.jpg"><br><br>  So, when Active Directory is created, you need to add an account with domain administrator privileges for our future cluster, since the cluster is configured under the domain account. <br>  The record will be called Radioserver in the domain Radio.local: <br><br><img src="https://habrastorage.org/storage2/6e2/c70/508/6e2c70508206824c62d86ced6544d4fd.jpg"><br><br>  Then, we connect the second server as an additional domain controller using the same Active Directory Installation Wizard (dcpromo): <br><br><img src="https://habrastorage.org/storage2/230/393/74c/23039374c557e6ca379e9ac38e364168.jpg"><br><br>  An added controller has been added, we can see the controllers in the Active Directory management window: <br><br><img src="https://habrastorage.org/storage2/153/1ae/08a/1531ae08aa4bfd18bc1968327029ed07.jpg"><br><br>  Now you can start creating a cluster. <br><br><h4>  Cluster </h4><br>  To create a cluster, you need to finish preparing the servers.  We have a common disk space, Quorum, we need to create a fault-tolerant network for a fault-tolerant server.  The servers have two network adapters, one pair will be used for internal communication between the cluster segments, and the second for communication with the outside world, let's call them ‚ÄúCluster‚Äù and ‚ÄúLan‚Äù, respectively. <br><br><img src="https://habrastorage.org/storage2/ed7/225/2ba/ed72252ba09a809fe10bb1bd38e3df19.png"><br><br>  We start "administration of a cluster", action - "to create a new cluster".  The cluster creation wizard starts, there you need to specify the domain and assign a unique cluster name, because for the remaining devices on the network, our cluster will look like an independent server.  Then we specify the computer that will be the first node of the new cluster.  Next comes the configuration analysis: <br><br><img src="https://habrastorage.org/storage2/ae4/9e8/a87/ae49e8a87aaa44d336800796be7e4145.jpg"><br><br>  If our configuration does not satisfy the clustering, it is desirable to eliminate all comments, a description of the problem will be described in detail in the journal.  Well, if all the points are satisfied, enter the cluster IP address and the wizard suggests the configuration of the future cluster.  In the same window, you can change the automatically selected quorum section, by default the wizard selects the smallest public section. <br><br>  After the creation of the cluster is completed, we see that we have a cluster consisting of one node with two cluster groups and two networks: <br><br><img src="https://habrastorage.org/storage2/f45/f4a/1ee/f45f4a1ee86d8ab1f37f7883dcedbf4b.jpg"><br><br>  Cluster groups contain resources: Cluster name, IP address and quorum. <br><br>  Now, similarly to the first, we add the second node to the created cluster.  And finally, the cluster is ready, to test its performance, you can try to manually move the cluster groups from one node to another, also artificially provoke this transition, for example, by disconnecting the public network's network adapter - ‚ÄúLan‚Äù. <br><br>  So, the cluster is ready, but what to do next?  Our application, unfortunately, does not support clustering, which means you have to run it in a virtual machine. <br><br><h4>  Microsoft Virtual Server 2005 R2 </h4><br>  The virtual machine is selected - <a href="http://www.microsoft.com/download/en/details.aspx%3Fid%3D2994">Microsoft Virtual Server 2005 R2 SP1 - Enterprise Edition</a> .  Install the virtual machine on both sites, but before that you need to add the Windows component - ‚ÄúApplication Server‚Äù: <br><br><img src="https://habrastorage.org/storage2/811/227/2c5/8112272c5ee62609509e28822aa6847a.jpg"><br><br>  After installation, we will create a script that will be used by the cluster service on node 1 to move the virtual server to node 2. In addition, when the cluster service stops, the transition of all resources to node 2 is triggered. The script contains one line - ‚Äúnet stop clussvc‚Äù, save it under the name "C: \ Stop_cluss_script.cmd".  Go to the group policies (gpedit.msc), select "Shut down" and add our script: <br><br><img src="https://habrastorage.org/storage2/411/4d2/fe5/4114d2fe5b14d2d8cb79956698be1ade.jpg"><br><br>  This script needs to be added on both nodes.  Then on both nodes in the folder "% systemroot% \ Cluster" we add the script <a href="https://docs.google.com/file/d/0B7hUkNCPMwvSbHF3cU80eUlUQmFZbmlmN1J6MTFMQQ/edit">"Havm.vbs"</a> , which will start the virtual machine when the node is <a href="https://docs.google.com/file/d/0B7hUkNCPMwvSbHF3cU80eUlUQmFZbmlmN1J6MTFMQQ/edit">changed</a> . <br><br><img src="https://habrastorage.org/storage2/6a5/18c/b73/6a518cb7395f73a241e02a4fbdb5c9ac.jpg"><br><br>  In order for our virtual machine to run on both nodes, it must be placed on a shared disk - D (data).  To do this, you need to add a shared disk as a cluster resource.  We go to the Administration of the cluster and select the operation "New group", we indicate the preferred owners, these are our two nodes.  The group is called "SmartPTT".  Now in the created group we create the resource ‚ÄúDiskStorage‚Äù, we add the owners in the same way and select the physical disk from the drop-down disk. <br><br>  Using the Virtual Server Administration Website we create a virtual network.  As a virtual network adapter, select the adapter corresponding to the cluster's public network adapter - ‚ÄúLan‚Äù. <br><br><img src="https://habrastorage.org/storage2/df8/6f1/d00/df86f1d0075aeb7bf71b1594d639af7d.png"><br><br>  Now we need to transfer the configuration file to a shared disk, for this, we direct it to ‚ÄúVirtual Networks‚Äù in the navigation panel, click ‚ÄúConfigure‚Äù, then click ‚ÄúView All‚Äù.  We hover the mouse on the newly created network and select "Edit Configuration": <br><br><img src="https://habrastorage.org/storage2/ca5/7c7/63b/ca57c763b7d45331e0d00ba22c2973fd.png"><br><br><img src="https://habrastorage.org/storage2/527/d69/570/527d6957083b7bc0baf65029b498e6f4.png"><br><br>  So we will find out where the default configuration file is saved.  Now in the Virtual Server Administration Website we click ‚ÄúBack‚Äù, move the mouse pointer over our network and select ‚ÄúRemove‚Äù.  The goal of this step is not to cancel the creation of a virtual network, but to clear the Virtual Server system information in the event that the .vnc file is moved to the cluster storage.  If you skip this operation, the virtual network will not work correctly. <br><br>  On the shared storage disk we create the SmartPTT folder, there will be files of the virtual machine.  And we transfer here ClusterNetwork.vnc. <br><br><img src="https://habrastorage.org/storage2/506/5ae/b08/5065aeb08b684ffefd495653115c9fa4.png"><br><br>  Next in the Virtual Server Administration Website, we suggest ‚ÄúVirtual Networks‚Äù, click on ‚ÄúAdd‚Äù, indicate the new location of our .vnc file, and then click ‚ÄúAdd‚Äù.  Then, when creating a virtual machine in Virtual machine name, you need not just to enter a name, but to enter the storage path of the virtual machine configuration, specifying our folder in the repository, ‚ÄúD: \ SmartPTT \ ... vnc‚Äù. <br><br>  On the Master Status page, a sketch of the created machine.  If you are prompted to enable VMRC server, install ActiveX control, do it.  Click OK for any subsequent security dialogs.  Go to the configuration of the machine we created and select the CD / DVD section where we specify where to get the installation files.  Then we press Turn On of our machine and start the standard OS installation procedure.  Then, on site 2 through the Virtual Server Administration Website, you must manually specify the configuration files of our virtual server. <br><br>  Next, go to Cluster Administration and create a new resource in our previously created group.  Resource type "Universal Script": <br><br><img src="https://habrastorage.org/storage2/d9d/256/dec/d9d256decddcccf44be361671f425739.png"><br><br>  Specify the path to our script Havm.vbs -% systemroot% \ Cluster \ Havm.vbs, and add resource dependencies to ‚ÄúDiskStorage‚Äù, because if the shared disk is unavailable to the virtual machine, then there will not be any configuration files.  This completes the setup, installs the operating system and the service for which all this is done on the virtual machine. <br><br><h4>  Conclusion </h4><br>  Let me remind you that our service is, for example, a program that pings something and creates a report about it.  To view a report outside the virtual machine, the report should be saved to a disk accessible to the virtual machine and all other members of the network.  As a way out of this situation in the OS running on a virtual machine, a network drive was added - our Data storage.  The network drive was connected through the cluster IP address, and this caused a problem.  When the cluster resource ‚Äúcluster IP address‚Äù is moved, the rest of the network members, including the virtual machine, do not understand that the cluster has replaced the adapter, and continue to break on the inactive adapter of the failed node.  As a result, the cluster IP address is unavailable for 5-10 minutes, as a result, and our service all this time cannot save data to a network drive. <br><br><h4>  Halyards </h4><br>  <a href="https://docs.google.com/open%3Fid%3D0B7hUkNCPMwvSMnRrNVZnNURRQnFycnJfcUt5bjFjQQ">Stop_cluss_script.cmd</a> <br>  <a href="https://docs.google.com/file/d/0B7hUkNCPMwvSbHF3cU80eUlUQmFZbmlmN1J6MTFMQQ/edit">"Havm.vbs"</a> </div><p>Source: <a href="https://habr.com/ru/post/139410/">https://habr.com/ru/post/139410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139397/index.html">How to adapt the service for mobile platforms</a></li>
<li><a href="../139398/index.html">Enyo framework updated to Enyo 2.0b2</a></li>
<li><a href="../139399/index.html">Egor, stop hacking Github!</a></li>
<li><a href="../139407/index.html">Lightpack 6. Review backlight for the monitor</a></li>
<li><a href="../139409/index.html">Headphone amplifier, a little more complicated</a></li>
<li><a href="../139411/index.html">Notes Asterisker. Corporate - a holy thing ...</a></li>
<li><a href="../139412/index.html">Samsung AllShare and Linux</a></li>
<li><a href="../139415/index.html">CircuitLab: create schemes in the browser</a></li>
<li><a href="../139416/index.html">Droider Show # 30. Means war!</a></li>
<li><a href="../139417/index.html">Plotting on Android: sl4a, python and flot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>