<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux Data Encryption</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article describes one of the options for encrypting data in Linux. 

 The article does not claim to truism and does not reveal anything new. 
 Th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux Data Encryption</h1><div class="post__text post__text-html js-mediator-article"> This article describes one of the options for encrypting data in Linux. <br><a name="habracut"></a><br>  The article does not claim to truism and does not reveal anything new. <br>  The idea is described and an example of its implementation is shown. <br>  <b>Actually, the main idea:</b> <br>  When equipment is removed (thieves) (the hard drive, or the computer as a whole), the ability to obtain any information should be completely absent.  Ie, the attacker should not receive any information at all, any information carrier should be completely encrypted. <br>  Options with bootable flash drives were immediately rejected for ideological reasons, since it is not always possible to quickly disable it. <br>  As a result, the scheme was chosen with network boot. <br>  <b>Task:</b> <br>  Provide data encryption located on the Windows server. <br>  <b>Example of implementation:</b> <br>  1. We perform network booting (pxe + nfs) <br>  2. Run sshd and wait for the encrypted partitions to be mounted. <br>  3. Through ssh we mount cryptic partitions <br>  4. We start the VirtualBox virtual machine with Windows onboard <br>  <b>Initial data:</b> <br>  Network: 192.168.1.0/24 <br>  The main gateway: 192.168.1.1 <br>  DNS: 192.168.1.1 <br>  Remote boot server: 192.168.1.13 (boot server) <br>  Server with encrypted data: 192.168.1.14 (loadable server) <br><br>  Everything described below will happen on a server with Debian Lenny preinstalled. <br><br>  We set up and configure dhcp server for network boot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
     <code><font color="black">netboot:~# apt-get install dhcp3-server <br> netboot:~# mcedit /etc/dhcp3/dhcpd.conf <br> <br> option domain-name-servers 192.168.1.1; <br> default-lease-time 86400; <br> max-lease-time 604800; <br> authoritative; <br> subnet 192.168.1.0 netmask 255.255.255.0 { <br> range 192.168.1.20 192.168.1.60; <br> filename "pxelinux.0"; <br> next-server 192.168.1.13; <br> option subnet-mask 255.255.255.0; <br> option broadcast-address 192.168.1.255; <br> option routers 192.168.1.1; <br> }</font></code> <br> <br>  Next, install and configure the tftp server. <br><br> <code><font color="black">netboot:~# apt-get install tftpd-hpa <br> netboot:~# mcedit etc/default/tftpd-hpa <br> <br> RUN_DAEMON="yes" <br> OPTIONS="-l -s /opt/vcrypt/boot"</font></code> <br> <br>  For network booting we need the pxelinux.0 file from the syslinux package <br>  Install the syslinux package.  And customize pxe. <br><br> <code><font color="black">netboot:~# apt-get install syslinux <br> netboot:~# mkdir -p /opt/vcrypt/boot <br> netboot:~# cp /usr/lib/syslinux/pxelinux.0 /opt/vcrypt/boot/ <br> netboot:~# mkdir /opt/vcrypt/boot/pxelinux.cfg <br> netboot:~# touch /opt/vcrypt/boot/pxelinux.cfg/default <br> netboot:~# mcedit /opt/vcrypt/boot/pxelinux.cfg/default <br> <br> DEFAULT vcrypt <br> TIMEOUT 30 <br> PROMPT 1 <br> LABEL vcrypt <br> KERNEL vmlinuz <br> APPEND root=/dev/nfs nfsroot=192.168.1.13:/opt/vcrypt/ initrd=initrd.img ip=192.168.1.14::192.168.1.1:255.255.255.0:</font></code> <br> <br>  The meaning of this config: by default we load the vcrypt section, which indicates which kernel and ram disk to use, and that we have the root partition on the remote nfs server. <br><br>  With the tftp and pxe settings we finished, now we will install and configure the nfs server. <br><br> <code><font color="black">netboot:~# apt-get install nfs-kernel-server nfs-common portmap <br> netboot:~# mcedit /etc/exports <br> <br> /opt/vcrypt 192.168.1.14(rw,no_root_squash,async,no_subtree_check)</font></code> <br> <br>  We indicate which directory and for whom we open access. <br><br> <code><font color="black">netboot:~# invoke-rc.d nfs-kernel-server reload</font></code> <br> <br>  Reboot the nfs server so that it processes the new config. <br><br>  Now it remains to install the system, which we will remotely download.  The easiest option is to use the debootstrap utility. <br><br> <code><font color="black">netboot:~# apt-get install debootstrap</font></code> <br> <br>  The installation process is as simple as five cents, we specify the architecture, the distribution kit, where to install it and the mirror (where to get the packages from). <br><br><pre> <code class="hljs 1c"><font color="black">netboot:<span class="hljs-symbol"><span class="hljs-symbol">~#debootstrap --arch i386 lenny /opt/vcrypt/ http</span></span>:<span class="hljs-comment"><span class="hljs-comment">//ftp.us.debian.org/debian</span></span></font></code> </pre> <br><br>  When the debootstrap is completed, the system in the / opt / vcrypt / folder will be almost ready for work. <br><br>  Chroot the newly installed system <br> <code><font color="black">netboot:~# LANG=C chroot /opt/vcrypt/ /bin/bash</font></code> <br> <br>  Set up the time zone, network and resolv, set the hostname and update the apt cache <br><br> <code><font color="black">netboot:/# nano /etc/default/rcS <br> <br> TMPTIME=0 <br> SULOGIN=no <br> DELAYLOGIN=no <br> UTC=no <br> VERBOSE=no <br> FSCKFIX=no <br> RAMRUN=no <br> RAMLOCK=no <br> <br> netboot:/# dpkg-reconfigure tzdata <br> netboot:/# nano /etc/network/interfaces <br> <br> auto lo <br> iface lo inet loopback <br> auto eth0 <br> iface eth0 inet static <br> address 192.168.1.14 <br> netmask 255.255.255.0 <br> gateway 192.168.1.1 <br> <br> netboot:/# nano /etc/resolv.conf <br> <br> nameserver 192.168.1.1 <br> <br> netboot:/# echo cryptserv &gt; /etc/hostname <br> netboot:/# apt-get update</font></code> <br> <br>  Install and configure locales. <br>  I chose only en_US.UTF8 and ru_RU.UTF8.  For observance of full koshernost - default exhibited en_US.UTF8. <br><br> <code><font color="black">netboot:/# apt-get install locales <br> netboot:/# dpkg-reconfigure locales</font></code> <br> <br>  Create a kernel installation configuration file and install the kernel <br><br> <code><font color="black">netboot:/# touch /etc/kernel-img.conf <br> netboot:/# nano /etc/kernel-img.conf <br> <br> do_symlinks = yes <br> relative_links = yes <br> do_bootloader = no <br> do_bootfloppy = no <br> do_initrd = yes <br> link_in_boot = no <br> <br> netboot:/# apt-get install linux-image-2.6.26-2-686</font></code> <br> <br>  Configuring the initrd to boot over the network.  I want to note that we perform all manipulations exclusively in the chroot system. <br><br> <code><font color="black">netboot:/boot# nano /etc/initramfs-tools/initramfs.conf <br> <br> MODULES=netboot <br> BUSYBOX=y <br> KEYMAP=n <br> BOOT=nfs <br> DEVICE=eth0 <br> NFSROOT=auto</font></code> <br> <br>  We delete the old one and generate a new initrd, although it is possible to delete it in worker-peasant fashion: <br>  rm /boot/initrd.img-`uname -r` <br>  but since childhood I have disliked the rm command <br><br> <code><font color="black">netboot:/# update-initramfs -v -c -k `uname -r` -d <br> netboot:/# update-initramfs -v -c -k `uname -r`</font></code> <br> <br>  Making symbolic links to the kernel and ramdisk <br><br> <code><font color="black">netboot:/# cd /boot <br> netboot:/boot# ln -s vmlinuz-2.6.26-2-686 vmlinuz <br> netboot:/boot# ln -s initrd.img-2.6.26-2-686 initrd.img</font></code> <br> <br>  Install luks <br><br> <code><font color="black">netboot:/# apt-get install cryptsetup hashalot</font></code> <br> <br>  Set root password and install ssh server <br><br> <code><font color="black">netboot:/# passwd <br> netboot:/# apt-get install openssh-server</font></code> <br> <br>  After the above manipulation, the remote boot server is fully operational. <br><br>  If the download is successful, then at 192.168.1.14 you will have a fully working server running sshd. <br><br>  Login and encrypt encryption: <br><br> <code><font color="black">h1g@h1g-laptop:~$ ssh -l root 192.168.1.14</font></code> <br> <br>  Fill the disk with random data to make it difficult to detect encrypted data. <br>  You can also check for bad blocks, but this is up to you. <br><br> <code><font color="black">cryptserv:~# dd if=/dev/urandom of=/dev/sda</font></code> <br> <br>  Create an encrypted partition (hard disk, media) <br><br> <code><font color="black">cryptserv:~# cryptsetup --verbose --verify-passphrase luksFormat /dev/sda</font></code> <br> <br>  I hope you will use a pass phrase of at least 15 characters long, consisting of numbers and letters of different case. <br><br>  Open the encrypted device and associate it with the virtual device / dev / mapper / vcrypt.  Create a file system.  Create a mount point <br><br> <code><font color="black">cryptserv:~# cryptsetup luksOpen /dev/sda vcrypt <br> cryptserv:~# mkfs.ext3 -j -m 1 -O dir_index,filetype,sparse_super /dev/mapper/vcrypt <br> cryptserv:~# mkdir /home/crypt <br> cryptserv:~# mount /dev/mapper/vcrypt /home/crypt/</font></code> <br> <br>  Next, install VirtualBox.  To my deep regret, not Sun, Oracle VirtualBox <br><br><pre> <code class="hljs pgsql"><font color="black">cryptserv:~# echo "deb http://download.virtualbox.org/virtualbox/debian lenny non-free" &gt;&gt; /etc/apt/sources.list <br> cryptserv:~# wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.<span class="hljs-keyword"><span class="hljs-keyword">asc</span></span> -O- | apt-key <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> - <br> cryptserv:~# apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install virtualbox<span class="hljs-number"><span class="hljs-number">-3.2</span></span></font></code> </pre> <code><font color="black">cryptserv:~# echo "deb http://download.virtualbox.org/virtualbox/debian lenny non-free" &gt;&gt; /etc/apt/sources.list</font> <br> cryptserv:~# wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc -O- | apt-key add - <br> cryptserv:~# apt-get install virtualbox-3.2</code> <pre> <code class="hljs pgsql"><font color="black">cryptserv:~# echo "deb http://download.virtualbox.org/virtualbox/debian lenny non-free" &gt;&gt; /etc/apt/sources.list</font> <br> cryptserv:~# wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.<span class="hljs-keyword"><span class="hljs-keyword">asc</span></span> -O- | apt-key <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> - <br> cryptserv:~# apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install virtualbox<span class="hljs-number"><span class="hljs-number">-3.2</span></span></code> </pre> <code><font color="black">cryptserv:~# echo "deb http://download.virtualbox.org/virtualbox/debian lenny non-free" &gt;&gt; /etc/apt/sources.list</font> <br> cryptserv:~# wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc -O- | apt-key add - <br> cryptserv:~# apt-get install virtualbox-3.2</code> <br> <br>  Create a container for the virtual machine.  Let it be called Bender1 with a template for Win2k3 server <br><br> <code><font color="black">cryptserv:~# VBoxManage createvm --name bender1 --ostype Windows2003 ‚Äîregister</font></code> <br> <br>  We allocate 1 GB of RAM to the container, set access to the network via the network bridge, enable the virtual rdp server on port 3389 <br><br> <code><font color="black">cryptserv:~# VBoxManage modifyvm bender1 --memory 1024 --floppy disabled --audio none --nic1 bridged --bridgeadapter1 eth0 --vram 12 --accelerate3d off --boot1 disk --acpi on --cableconnected1 on --usb off --vrdp on --vrdpport 3389 --vtxvpid on</font></code> <br> <br>  Create an IDE controller for our virtual machine <br><br> <code><font color="black">cryptserv:~# VBoxManage storagectl bender1 --name "IDE Controller" --add ide</font></code> <br> <br>  Create a virtual hard disk of 20 GB and connect it to the controller <br><br> <code><font color="black">cryptserv:~# VBoxManage createhd --filename /home/crypt/bender1.vdi --size 20480 --register <br> cryptserv:~# VBoxManage storageattach bender1 --storagectl "IDE Controller" --port 0 --device 0 --type hdd --medium /home/crypt/bender1.vdi</font></code> <br> <br>  We connect the legal installation DVD image to the controller. <br><br> <code><font color="black">cryptserv:~# VBoxManage storageattach bender1 --storagectl "IDE Controller" --port 1 --device 0 --type dvddrive ‚Äîmedium /home/crypt/some_legal_windows_image.iso</font></code> <br> <br>  We expose the download from the legal DVD image <br><br> <code><font color="black">cryptserv:~# VBoxManage modifyvm bender1 --boot1 dvd</font></code> <br> <br>  Now everything is ready to launch "Bender" <br><br> <code><font color="black">cryptserv:~# VBoxManage startvm bender1 --type vrdp</font></code> <br> <br>  Connect to rdp server and enjoy the installation of a legal win2k3.  The process of installing and configuring the win2k3 server to describe does not see the point. <br><br> <code><font color="black">h1g@h1g-laptop:~$ rdesktop -k en-us 192.168.1.14:3389</font></code> <br> <br>  After a successful installation, we send a ‚Äúshutdown‚Äù signal to ‚ÄúBender‚Äù <br><br> <code><font color="black">cryptserv:~# VBoxManage controlvm bender1 acpipowerbutton</font></code> <br> <br>  Switch to boot disk <br><br> <code><font color="black">cryptserv:~# VBoxManage modifyvm bender1 --boot1 disk</font></code> <br> <br>  Sample scripts to enable and disable the virtual machine. <br><br> <code><font color="black">cryptserv:~# cat start_vm.sh</font></code> <br> <blockquote><ol><li>  <font color="#696969">#! / bin / bash</font> </li><li>  / sbin / cryptsetup luksOpen / dev / sda vcrypt &amp;&amp; <font color="#cc6633">mount</font> / dev / mapper / vcrypt / home / crypt &amp;&amp; / usr / bin / VBoxManage startvm bender1 - <font color="#0000ff">type</font> vrdp </li></ol></blockquote><br><br> <code><font color="black">cryptserv:~# cat shutdown_vm.sh</font></code> <br> <blockquote><ol><li>  <font color="#696969">#! / bin / bash</font> </li><li>  / usr / bin / VBoxManage controlvm bender1 acpipowerbutton </li><li>  <font color="#0000ff">while</font> [`ps aux | grep <font color="#008000">" bender1 --startvm "</font> | grep -v grep | wc -l` -ne <font color="#008000">0</font> ] </li><li>  <font color="#0000ff">do</font> </li><li>  <font color="#0000ff">echo</font> <font color="#008000">"VM is poweroff. Wait plz"</font> </li><li>  <font color="#cc6633">sleep</font> <font color="#008000">1</font> </li><li>  <font color="#0000ff">done</font> </li><li>  <font color="#cc6633">umount</font> / home / crypt &amp;&amp; / sbin / cryptsetup luksClose / dev / mapper / vcrype </li></ol></blockquote><br><br>  Again, I repeat, here is an example of a basic system setup.  No configuration of the firewall, binding of the tftp server to the mac of the server being loaded, sssh server, encryption of the ‚Äúbootable system‚Äù, etc. are described. <br>  Every administrator decides for himself. <br>  Nobody limits the flight of your <s>paranoia of</s> fantasy, but you need to remember that not all drugs are equally useful. </div><p>Source: <a href="https://habr.com/ru/post/88385/">https://habr.com/ru/post/88385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../88373/index.html">Gantt vs backlog</a></li>
<li><a href="../88375/index.html">Imagine Cup 2010 southern quarter finals</a></li>
<li><a href="../88378/index.html">.tm - a hundred years of solitude</a></li>
<li><a href="../88383/index.html">Alatau IT City</a></li>
<li><a href="../88384/index.html">Personal finance management without the exhausting logging of every purchase</a></li>
<li><a href="../88386/index.html">twitter2vk - from Twitter to VKontakte</a></li>
<li><a href="../88389/index.html">elFinder - file manager for the site. New taste</a></li>
<li><a href="../88392/index.html">Wow Mobile and other news from U'tel</a></li>
<li><a href="../88393/index.html">Design pattern "Fitter" / "Flyweight"</a></li>
<li><a href="../88394/index.html">LINQ to SQL and concurrent access conflicts</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>