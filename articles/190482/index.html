<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with data from related tables in ASP.NET MVC or developing a Lookup component</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The development of any business application is somehow related to processing a certain amount of data, building links between these data, as well as t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with data from related tables in ASP.NET MVC or developing a Lookup component</h1><div class="post__text post__text-html js-mediator-article">  The development of any business application is somehow related to processing a certain amount of data, building links between these data, as well as their convenient presentation.  In this article, we will look at working with intertable interaction in ASP.net MVC, as well as the possibilities for visualizing this interaction, we will try to develop our component, on the one hand allowing you to conveniently select the necessary data, on the other hand, it is easy to configure.  We will use JqGrid to search, sort, and select related data.  Let us touch upon the formation of dynamic predicates, let's see how metadata can be used in the html helper and finally consider the already existing components of this class. <br><a name="habracut"></a><br>  In the simplest example, which every reader probably knows, we can use a regular DropDownList to display data from related tables, but its use is rather limited and not always efficient.  In our case, there were clear requirements describing the component, with a built-in list, sorting, searching for related data, and since there were a lot of fields of this type, it was decided to develop the corresponding component. <br><br>  Consider an example of two related tables: "User" and "Group" <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserProfile</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UserName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? UserGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> UserGroup UserGroup { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserGroup</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">"Group Name"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GroupName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">"Group Description"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Description { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;UserProfile&gt; Users { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br>  We see that there can be an N-th number of users in a group, and a user in turn can correspond to a specific group.  Now let's look at the code that will allow us to get this data, as well as visualize it.  For a page issuing a list of entries, this is quite simple. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userProfiles = _db.UserProfiles.Include(c =&gt; c.UserGroup); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userProfiles.ToList()); }</code> </pre><br>  Actually, in the controller code presented above, in addition to the user profile data, we request a group associated with this profile.  Next, we will display it in our View using DisplayNameFor. <br><br><pre> <code class="cs hljs"> @Html.DisplayNameFor(model =&gt; model.UserGroup.GroupName)</code> </pre><br>  If we only need to display the associated data to the user, then this is quite enough.  For editing, as I said, you can use the DropDownList. However, in our case there is a need to create a more flexible control, and to make it as simple as possible to set up, such as the above query to the related table.  The first thing we will begin with is the development of the Html helper, which will allow us to describe in a convenient form the use of our component in the presentation and ensure its functioning. <br><br><h4>  1. Development of Html Helper for Lookup Component </h4><br>  What is Html Helper in ASP.net MVC?  For the most part, these are common extension methods that allow you to access your class parent in order to create HTML content.  To display our component, we will use the standard lookup control view, namely the text field and the button.  Record id will be stored in a hidden field. <br>  In addition to html content, html helper also allows you to access the metadata of the models and fields that are used, so the first thing we do is create an attribute that could highlight our field in the model, as well as provide it with additional information necessary for the correct operation of the component. <br><br>  So the LookupAttribute code is presented below. <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Property, AllowMultiple = false)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LookupAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type Model { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameField { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Everything is simple, we will save the field that we will use as a text description of the associated record, as well as the type of model we will refer to.  So the code of our model can be slightly transformed: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserProfile</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UserName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Lookup(Model = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UserGroup), NameField = <span class="hljs-string"><span class="hljs-string">"GroupName"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? UserGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> UserGroup UserGroup { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Now we can see that we will refer to the UserGroup model, the text field for the GroupName text view.  However, in order for this attribute to be used in our HTML Helper, we need to add it to the collection of view metadata.  To do this, we need to implement a class derived from DataAnnotationsModelMetadataProvider and register it accordingly. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LookupMetadataExtension</span></span> : <span class="hljs-title"><span class="hljs-title">DataAnnotationsModelMetadataProvider</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> ModelMetadata </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateMetadata</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IEnumerable&lt;Attribute&gt; attributes, Type containerType, Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; modelAccessor, Type modelType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> propertyName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> metadata = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.CreateMetadata(attributes, containerType, modelAccessor, modelType, propertyName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> additionalValues = attributes.OfType&lt;LookupAttribute&gt;().FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (additionalValues != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { metadata.AdditionalValues.Add(LookupConsts.LookupMetadata, additionalValues); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> metadata; } }</code> </pre><br>  In order to be able to extend the metadata of a field, you must inherit from the DataAnnotationsModelMetadataProvider class and override the CreateMetadata method.  The DataAnnotationsModelMetadataProvider class is implemented by the default metadata model provider for ASP.NET MVC. <br>  Everything is quite simple.  If there is ours in the collection of transferred attributes, then we should add it to the AdditionalValues ‚Äã‚Äãcollection of metadata, after which we return the modified collection.  For this class to work correctly, it must be registered.  Go to Global.asax.cs and add the line: <br><br><pre> <code class="cs hljs">ModelMetadataProviders.Current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LookupMetadataExtension();</code> </pre><br>  Now we are ready to continue developing our HTML helper.  In general, the HTML helper function will look like this. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MvcHtmlString LookupFor&lt;TModel, TProperty&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> HtmlHelper&lt;TModel&gt; htmlHelper, Expression&lt;Func&lt;TModel, TProperty&gt;&gt; expression, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> filterAction, Type modelType, String nameField, IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; htmlAttributes) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldName = ExpressionHelper.GetExpressionText(expression); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commonMetadata = PrepareLookupCommonMetadata( ModelMetadata.FromLambdaExpression(expression, htmlHelper.ViewData), htmlHelper.ViewData.ModelMetadata, modelType, nameField); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lookupAttribute = commonMetadata.AdditionalValues[LookupConsts.LookupMetadata] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LookupAttribute; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupHtmlInternal(htmlHelper, commonMetadata, lookupAttribute, fieldName, filterAction, htmlAttributes); }</code> </pre><br>  I note that we also give the user the opportunity to specify the type of model directly from the view.  In the first line we get the name of our field, then we call the function PrepareLookupCommonMetadata.  This function will be discussed later, I will only say that it is used to process the metadata and access the data of the related table through this metadata.  The line ModelMetadata.FromLambdaExpression (expression, htmlHelper.ViewData) using the expression receives the metadata of the current field, actually our AdditionalValues.  Next, from the returned commonMetadata object, we get our lookupAttribute and call the HTML code generation function. <br><br>  Now let's turn to the PrepareLookupCommonMetadata metadata processing function. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ModelMetadata </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrepareLookupCommonMetadata</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelMetadata fieldMetadata, ModelMetadata modelMetadata , Type modelType, String nameField</span></span></span><span class="hljs-function">)</span></span> { LookupAttribute lookupMetadata; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modelType != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; nameField != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { lookupMetadata = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LookupAttribute { Model = modelType, NameField = nameField }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldMetadata.AdditionalValues.ContainsKey(LookupConsts.LookupMetadata)) fieldMetadata.AdditionalValues.Remove(LookupConsts.LookupMetadata); fieldMetadata.AdditionalValues.Add(LookupConsts.LookupMetadata, lookupMetadata); }</code> </pre><br>  First, we look whether the user has set the type and model in the view, if so, then update the data in AdditionalValues.  Go ahead <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldMetadata.AdditionalValues != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; fieldMetadata.AdditionalValues.ContainsKey(LookupConsts.LookupMetadata)) { lookupMetadata = fieldMetadata.AdditionalValues[LookupConsts.LookupMetadata] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> LookupAttribute; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lookupMetadata != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prop = lookupMetadata.Model.GetPropertyWithAttribute(<span class="hljs-string"><span class="hljs-string">"KeyAttribute"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> releatedTableKey = prop != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? prop.Name : String.Format(<span class="hljs-string"><span class="hljs-string">"{0}Id"</span></span>, lookupMetadata.Model.Name); fieldMetadata.AdditionalValues.Add(<span class="hljs-string"><span class="hljs-string">"idField"</span></span>, releatedTableKey); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> releatedTableMetadata = modelMetadata.Properties.FirstOrDefault(proper =&gt; proper.PropertyName == lookupMetadata.Model.Name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (releatedTableMetadata != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { UpdateLookupColumnsInfo(releatedTableMetadata, fieldMetadata); UpdateNameFieldInfo(lookupMetadata.NameField, releatedTableMetadata, fieldMetadata); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelValidationException(String.Format( <span class="hljs-string"><span class="hljs-string">"Couldn't find data from releated table. Lookup failed for model {0}"</span></span>, lookupMetadata.Model.Name)); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelValidationException(String.Format(<span class="hljs-string"><span class="hljs-string">"Couldn't find releated model type. Lookup field"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldMetadata; }</code> </pre><br>  We check that AdditionalValues ‚Äã‚Äãtakes place, then we extract it from the metadata collection.  Then, using the GetPropertyWithAttribute Type extension method, we get a field with the Key attribute from the associated Model.  This field will be used to identify our connection, that is, this field is the primary key of the associated table.  If we do not find it, then we try to form it ourselves using the rule - Model name + Id = primary key.  Add this value to AdditionalValues ‚Äã‚Äãas idField.  Next, we try to get the related table metadata by its name. <br>  If received, we will get information about the columns and the text definition of the related table. <br>  Now we‚Äôll take a closer look at getting information about the columns.  This list of fields will be used to display records in a JqGrid.  To configure this list, create another attribute. <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">AttributeUsage(AttributeTargets.Class, AllowMultiple = false)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LookupGridColumnsAttribute</span></span> : <span class="hljs-title"><span class="hljs-title">Attribute</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] LookupColumns { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupGridColumnsAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values</span></span></span><span class="hljs-function">)</span></span> { LookupColumns = values; } }</code> </pre><br>  Now let's look at the modified view of the related table.  You do not need to register the LookupGridColumnsAttribute, access to this type will be possible via the LookupAttribute using the Model field, which describes the type of the model. <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">LookupGridColumns(new[</span></span>] { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> })] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserGroup</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">"Group Name"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GroupName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">"Group Description"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Description { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;UserProfile&gt; Users { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  In the list of columns, in addition to the GroupName already present there by default, we add Description.  Now we return to the consideration of the function preparing the metadata in columns. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLookupColumnsInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelMetadata releatedTableMetadata, ModelMetadata metadata</span></span></span><span class="hljs-function">)</span></span> { IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; columns = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gridColumns = releatedTableMetadata.ModelType.GetCustomAttributeByType&lt;LookupGridColumnsAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gridColumns != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> column <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gridColumns.LookupColumns) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> metadataField = releatedTableMetadata.Properties.FirstOrDefault( propt =&gt; propt.PropertyName == column); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (metadataField != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { columns.Add(column, metadataField.DisplayName); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelValidationException( String.Format(<span class="hljs-string"><span class="hljs-string">"Couldn't find column in releated table {0}"</span></span>, releatedTableMetadata.GetDisplayName())); } } metadata.AdditionalValues.Add(<span class="hljs-string"><span class="hljs-string">"lookupColumns"</span></span>, columns); } }</code> </pre><br>  The function takes as arguments the metadata of the related table, as well as the metadata of our field.  In the metadata of the associated table, we try to find the specified LookupGridColumnsAttribute attribute.  We look that it is not null and go through the list of columns along the way, requesting their metadata to get the corresponding column for displaying the DisplayName.  If metadata is not detected, throw an exception, otherwise add the data to the columns collection.  After the collection of columns is formed, we add it to the field metadata in the form of AdditionalValues, they will be useful to us further. <br><br>  Now it's time to go back to our PrepareLookupCommonMetadata function and consider the last call, namely UpdateNameFieldInfo. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateNameFieldInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nameField, ModelMetadata releatedTableMetadata, ModelMetadata commonMetadata</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nameFieldMetedata = releatedTableMetadata.Properties.FirstOrDefault(propt =&gt; propt.PropertyName == nameField); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nameFieldMetedata != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { commonMetadata.AdditionalValues.Add(<span class="hljs-string"><span class="hljs-string">"lookupFieldValue"</span></span>, nameFieldMetedata.SimpleDisplayText); commonMetadata.AdditionalValues.Add(<span class="hljs-string"><span class="hljs-string">"lookupFieldDisplayValue"</span></span>, nameFieldMetedata.DisplayName); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModelValidationException(String.Format(<span class="hljs-string"><span class="hljs-string">"Couldn't find name field in releated table {0}"</span></span>, releatedTableMetadata.GetDisplayName())); } }</code> </pre><br>  This function receives all the information regarding the textual representation of our connection, namely, the very field that we specified in the form ‚ÄúNameField =‚Äú GroupName ‚Äù‚Äù in the Lookup attribute and adds this information to the AdditionalValues ‚Äã‚Äãof the metadata of our field.  nameFieldMetedata.SimpleDisplayText is the value of the GroupName field from the related table.  nameFieldMetedata.DisplayName - The name of the GroupName field from the related table. <br><br>  On this we can say that we have all the information we need in order to create the corresponding Html code.  Consider how it works, and what the LookupHtmlInternal function takes.  I recall that its call comes from the LookupFor function, discussed at the very beginning of the section on HtmlHelper. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MvcHtmlString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupHtmlInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HtmlHelper htmlHelper, ModelMetadata metadata, LookupAttribute lookupMetadata, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> action, IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; htmlAttributes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(name)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>, <span class="hljs-string"><span class="hljs-string">"htmlHelper"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> divBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagBuilder(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, String.Format(<span class="hljs-string"><span class="hljs-string">"{0}_{1}"</span></span>, name, <span class="hljs-string"><span class="hljs-string">"div"</span></span>)); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"form-wrapper cf"</span></span>); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, lookupMetadata.Model.FullName); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"nameField"</span></span>, lookupMetadata.NameField); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"idField"</span></span>, metadata.AdditionalValues[<span class="hljs-string"><span class="hljs-string">"idField"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"nameFieldDisplay"</span></span>, metadata.AdditionalValues[<span class="hljs-string"><span class="hljs-string">"lookupFieldDisplayValue"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>); divBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, action);</code> </pre><br>  Accept the following arguments.  1. htmlHelper - allows us to generate html code, 2. metadata - In fact, these are metadata fields containing all the extras.  Metadata obtained during the collection of information.  3. Dedicated lookupMetadata separately.  4. name - The name of our field, as in the view.  5 action - Specify the controller and method that will be used to request data.  5 htmlAttributes - ext.  html attributes defined by the programmer. <br>  Next, we look that the field name is not null and build a div containing the main parameters of our field.  Let us dwell on the main parameters: type - the type of the model to which we refer, nameField is the name of the text field from the linked table that identifies the link (in our case, the group name), idField is the primary key of the linked table, nameFieldDisplay is the value of the text field from the linked table, which identifies the connection as well as the action - as I said before, this is the controller and method that will be used to request data. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> columnsDivBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagBuilder(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); columnsDivBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, String.Format(<span class="hljs-string"><span class="hljs-string">"{0}_{1}"</span></span>, name, <span class="hljs-string"><span class="hljs-string">"columns"</span></span>)); columnsDivBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"style"</span></span>, <span class="hljs-string"><span class="hljs-string">"display:none"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (metadata.AdditionalValues.ContainsKey(<span class="hljs-string"><span class="hljs-string">"lookupColumns"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> columns = ((IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;)metadata.AdditionalValues[<span class="hljs-string"><span class="hljs-string">"lookupColumns"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> columnString = String.Empty; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> column <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> columns.Keys) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> columnDiv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagBuilder(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); columnDiv.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"colName"</span></span>, column); columnDiv.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"displayName"</span></span>, columns[column]); columnString += columnDiv.ToString(TagRenderMode.SelfClosing); } columnsDivBuilder.InnerHtml = columnString; }</code> </pre><br>  Further, in the same way, we set the div to contain all the columns from the related table that will be used to build the view for the JqGrid. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagBuilder(<span class="hljs-string"><span class="hljs-string">"input"</span></span>); inputBuilder.MergeAttributes(htmlAttributes); inputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>); inputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"lookup"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); inputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, String.Format(<span class="hljs-string"><span class="hljs-string">"{0}_{1}"</span></span>, name, <span class="hljs-string"><span class="hljs-string">"lookup"</span></span>), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); inputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, metadata.AdditionalValues[<span class="hljs-string"><span class="hljs-string">"lookupFieldValue"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hiddenInputBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagBuilder(<span class="hljs-string"><span class="hljs-string">"input"</span></span>); hiddenInputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"hidden"</span></span>); hiddenInputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>, name, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); hiddenInputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, name, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); hiddenInputBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, metadata.SimpleDisplayText, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> buttonBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagBuilder(<span class="hljs-string"><span class="hljs-string">"input"</span></span>); buttonBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"button"</span></span>); buttonBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Lookup"</span></span>); buttonBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"class"</span></span>, <span class="hljs-string"><span class="hljs-string">"lookupbutton"</span></span>); buttonBuilder.MergeAttribute(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, String.Format(<span class="hljs-string"><span class="hljs-string">"{0}_{1}"</span></span>, name, <span class="hljs-string"><span class="hljs-string">"lookupbtn"</span></span>), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  We form the rest of the attributes, namely the field containing the textual representation of our connection (nameField), the hidden field containing the id of our connection, the button on which we will open the JqGrid with the data from the related table. <br>  I note that we get the id of the currently selected record from the field metadata using the following call to metadata.SimpleDisplayText. <br><br><pre> <code class="cs hljs"> divBuilder.InnerHtml = String.Format(<span class="hljs-string"><span class="hljs-string">@"{0}{1}{2}{3}"</span></span>, inputBuilder.ToString(TagRenderMode.SelfClosing), hiddenInputBuilder.ToString(TagRenderMode.SelfClosing), buttonBuilder.ToString(TagRenderMode.SelfClosing), columnsDivBuilder.ToString(TagRenderMode.Normal) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MvcHtmlString(divBuilder.ToString(TagRenderMode.Normal)); }</code> </pre><br>  All that generated is packed into the root div and we return the html string to the browser for display. <br><br>  In order to use our html helper it was easy, we also implement the overloading of the LookupFor method <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MvcHtmlString LookupFor&lt;TModel, TProperty&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> HtmlHelper&lt;TModel&gt; htmlHelper, Expression&lt;Func&lt;TModel, TProperty&gt;&gt; expression) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> urlHelper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UrlHelper(htmlHelper.ViewContext.RequestContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupFor(htmlHelper, expression, urlHelper.Action(<span class="hljs-string"><span class="hljs-string">"LookupData"</span></span>), <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MvcHtmlString LookupFor&lt;TModel, TProperty&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> HtmlHelper&lt;TModel&gt; htmlHelper, Expression&lt;Func&lt;TModel, TProperty&gt;&gt; expression, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> filterAction) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupFor(htmlHelper, expression, filterAction, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> </pre><br>  To use our html helper it is enough to call Html.LookupFor (model =&gt; model.UserGroupId) in the view. <br>  In order for the view to work intellisense, you need to add a namespace in the web.config section of the system.web -&gt; pages -&gt; namespaces, which contains the class that implements your Html Helper, or simply place this class in one of the already defined namespaces, let's say in System.Web.Helpers.  Or directly in the submission specify &lt;@using your.namespace&gt;. <br><br>  On this we can say that the development of our HtmlHelper came to an end and we turn to the second part. <br><br><h4>  2. Expression and the formation of dynamic predicates. </h4><br>  In order to create a set of basic queries that allow the developer to easily start using our component in the "default" mode, we need to prepare predicates that allow us to form a query tree during the execution of our application.  Consider the LinqExtensions class, which contains several methods that allow us to ultimately form dynamic Linq.  Let's start with the implementation of the Where method. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; Where&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fieldName, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> searchString, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> compareFunction) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (searchString == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) searchString = String.Empty; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> param = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prop = Expression.Property(param, fieldName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodcall = Expression.Call(prop, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(String).GetMethod(compareFunction, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>) }), Expression.Constant(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: searchString)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lambda = Expression.Lambda&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(methodcall, param); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = source.Where(lambda); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; }</code> </pre><br>  So fieldName is the field from which we will compare, searchString is the string to compare, and the function from the String class that will be used to implement the comparison.  Further we will sort everything in detail.  We see that the string that was passed to us is not null.  If everything is good, then we define the type Expression.Parameter (typeof (T));  which will be addressed, in fact it will be a type of model.  The next line defines the type property, the field from the model that we will use for comparison.  Then we form a call to the compareFunction function from the string class with arguments of the searchString and the previously formed "property pointer".  Next, we form a lambda and use the IQueryable context to apply to it Where with the newly formed predicate.  We return the generated IQueryable. <br><br>  We implement several functions with a predefined string comparison function. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; WhereStartsWith&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fieldName, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> searchString) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Where(source, fieldName, searchString, <span class="hljs-string"><span class="hljs-string">"StartsWith"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; WhereContains&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fieldName, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> searchString) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Where(source, fieldName, searchString, <span class="hljs-string"><span class="hljs-string">"Contains"</span></span>); }</code> </pre><br>  In the image and likeness we implement the methods Equal and NotEqual <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; Equal&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fieldName, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> searchString) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (searchString == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) searchString = String.Empty; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> param = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prop = Expression.Property(param, fieldName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodcall = Expression.Equal(prop, Expression.Constant(searchString)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lambda = Expression.Lambda&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(methodcall, param); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = source.Where(lambda); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IQueryable&lt;T&gt; NotEqual&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fieldName, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> searchString) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (searchString == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) searchString = String.Empty; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> param = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prop = Expression.Property(param, fieldName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodcall = Expression.NotEqual(prop, Expression.Constant(searchString)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lambda = Expression.Lambda&lt;Func&lt;T, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;(methodcall, param); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = source.Where(lambda); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request; }</code> </pre><br>  Here everything by analogy will not stop in detail. <br><br>  We also need to be able to dynamically sort, so implement the ApplyOrder method. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IOrderedQueryable&lt;T&gt; ApplyOrder&lt;T&gt;(IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> property, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> methodName) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> param = Expression.Parameter(type); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pr = type.GetProperty(prop); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> expr = Expression.Property(param, type.GetProperty(prop)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ptype = pr.PropertyType; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delegateType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Func&lt;,&gt;).MakeGenericType(type, ptype); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lambda = Expression.Lambda(delegateType, expr, param); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Queryable).GetMethods().Single( method =&gt; method.Name == methodName &amp;&amp; method.IsGenericMethodDefinition &amp;&amp; method.GetGenericArguments().Length == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; method.GetParameters().Length == <span class="hljs-number"><span class="hljs-number">2</span></span>) .MakeGenericMethod(type, ptype) .Invoke(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] { source, lambda }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (IOrderedQueryable&lt;T&gt;)result; }</code> </pre><br>  By arguments: 1. Property - the field by which we will sort;  2.methodName - The method that we will use for sorting.  Next, we form a set of parameters.  MakeGenericType in our case will form the delegate Func &lt;T, string&gt;, then use it to create a lambda, which we pass as an argument to the method defined as methodName and call all this with the help of reflection. <br><br>  Thus, we are now able to define dynamic calls to sorting methods from Queryable. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IOrderedQueryable&lt;T&gt; OrderBy&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> desc , <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> property) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApplyOrder(source, property, desc ? <span class="hljs-string"><span class="hljs-string">"OrderByDescending"</span></span> : <span class="hljs-string"><span class="hljs-string">"OrderBy"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IOrderedQueryable&lt;T&gt; OrderBy&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> property) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApplyOrder(source, property, <span class="hljs-string"><span class="hljs-string">"OrderBy"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IOrderedQueryable&lt;T&gt; OrderByDescending&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> property) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApplyOrder(source, property, <span class="hljs-string"><span class="hljs-string">"OrderByDescending"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IOrderedQueryable&lt;T&gt; ThenBy&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IOrderedQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> property) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApplyOrder(source, property, <span class="hljs-string"><span class="hljs-string">"ThenBy"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IOrderedQueryable&lt;T&gt; ThenByDescending&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IOrderedQueryable&lt;T&gt; source, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> property) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ApplyOrder(source, property, <span class="hljs-string"><span class="hljs-string">"ThenByDescending"</span></span>); }</code> </pre><br>  This completes the implementation of the Linq auxiliary class and proceeds to the next step. <br><br><h4>  3. ModelBinder and the configuration of our component. </h4><br>  Due to the fact that the amount of configuration data transmitted to us is large enough, it would be nice to structure it and place it in an object that provides easy and understandable access to any settings.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let me remind you that we use jqgrid, which will provide us with data regarding sorting, searching, pagination and additional parameters, which, if necessary, we will define ourselves. </font><font style="vertical-align: inherit;">And so go to the model:</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> SearchOperator { Equal, NotEqual, Contains } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FilterSettings</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SearchString; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SearchField; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SearchOperator Operator; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GridSettings</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsSearch { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PageSize { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PageIndex { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SortColumn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Asc { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LookupSettings</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type Model { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> FilterSettings Filter { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GridSettings GridSettings { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> IdField { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameField { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I will not dwell on the description of classes. </font><font style="vertical-align: inherit;">Next, we consider a section of code that allows the data received from a jqGrid or lukap to convert to the corresponding class instance.</font></font><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LookupModelBinder</span></span> : <span class="hljs-title"><span class="hljs-title">IModelBinder</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BindModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ControllerContext controllerContext, ModelBindingContext bindingContext</span></span></span><span class="hljs-function">)</span></span> { HttpRequestBase request = controllerContext.HttpContext.Request; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lookupSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LookupSettings { Model = Type.GetType(request[<span class="hljs-string"><span class="hljs-string">"modelType"</span></span>]), IdField = request[<span class="hljs-string"><span class="hljs-string">"IdField"</span></span>], NameField = request[<span class="hljs-string"><span class="hljs-string">"NameField"</span></span>], Filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FilterSettings { SearchString = request[<span class="hljs-string"><span class="hljs-string">"searchString"</span></span>] ?? String.Empty, SearchField = request[<span class="hljs-string"><span class="hljs-string">"searchField"</span></span>] } }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(request[<span class="hljs-string"><span class="hljs-string">"searchOper"</span></span>] != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (request[<span class="hljs-string"><span class="hljs-string">"searchOper"</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"eq"</span></span>: lookupSettings.Filter.Operator = SearchOperator.Equal; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"ne"</span></span>: lookupSettings.Filter.Operator = SearchOperator.NotEqual; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"cn"</span></span>: lookupSettings.Filter.Operator = SearchOperator.Contains; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } lookupSettings.GridSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GridSettings {Asc = request[<span class="hljs-string"><span class="hljs-string">"sord"</span></span>] == <span class="hljs-string"><span class="hljs-string">"asc"</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request[<span class="hljs-string"><span class="hljs-string">"_search"</span></span>] != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) lookupSettings.GridSettings.IsSearch = Convert.ToBoolean(request[<span class="hljs-string"><span class="hljs-string">"_search"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request[<span class="hljs-string"><span class="hljs-string">"page"</span></span>] != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) lookupSettings.GridSettings.PageIndex = Convert.ToInt32(request[<span class="hljs-string"><span class="hljs-string">"page"</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request[<span class="hljs-string"><span class="hljs-string">"rows"</span></span>] != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) lookupSettings.GridSettings.PageSize = Convert.ToInt32(request[<span class="hljs-string"><span class="hljs-string">"rows"</span></span>]); lookupSettings.GridSettings.SortColumn = request[<span class="hljs-string"><span class="hljs-string">"sidx"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lookupSettings.Filter.SearchField == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { lookupSettings.Filter.SearchField = request[<span class="hljs-string"><span class="hljs-string">"NameField"</span></span>]; lookupSettings.Filter.Operator = SearchOperator.Contains; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lookupSettings; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To implement the binding, we need to inherit from the IModelBinder class and implement the BindModel function, where the controllerContext is the Context in which the controller operates. </font><font style="vertical-align: inherit;">Context information includes information about the controller, HTTP content, request context, and route data. </font><font style="vertical-align: inherit;">bindingContext - The context in which the model is bound. </font><font style="vertical-align: inherit;">The context contains information such as the model object, model name, model type, property filter, and value provider. </font><font style="vertical-align: inherit;">We get HttpRequestBase and use this object to get the data sent in the request. </font><font style="vertical-align: inherit;">Next, we form the structure of the settings model and return the resulting class. </font><font style="vertical-align: inherit;">In order for the binding to start working, you need to register it, so go to Global.asax.cs and add the appropriate call.</font></font><br><br><pre> <code class="cs hljs"> ModelBinders.Binders.Add(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LookupSettings), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LookupModelBinder());</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As a result, after all registrations, my Global.asax.cs looks like this: </font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Application_Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AreaRegistration.RegisterAllAreas(); ModelMetadataProviders.Current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LookupMetadataExtension(); ModelBinders.Binders.Add(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LookupSettings), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LookupModelBinder()); WebApiConfig.Register(GlobalConfiguration.Configuration); FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters); RouteConfig.RegisterRoutes(RouteTable.Routes); BundleConfig.RegisterBundles(BundleTable.Bundles); AuthConfig.RegisterAuth(); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now in the controller, we can use the following entry to refer to the arguments that came from the lukap. </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ModelBinder(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params">(LookupModelBinder</span></span></span><span class="hljs-function">))] LookupSettings settings)</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> This concludes the work with the configuration object and proceeds to the next step: </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Implementing a common MVC controller for Lookup Control. </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For most of the lookups that we use in our application, there is no need for any complex configuration, filtering or sorting, so we will develop an object that implements the basic sorting and search regardless of the type of component coming from the component, as well as the controller using this object to organize data access in the "default" mode. Let's start with the LookupDataResolver class. This class will be responsible for search operations, sorting in the "default" mode. I note that our component, in addition to selecting an element from the grid, must ensure the resolution of the element by the text value entered in the appropriate field.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In view of the fact that the type is defined only in the execution mode, we implement a function that will typify our model as a generic argument and call the function corresponding to the query. So we can use the following code dbContext.Set (). AsQueryable (); to form a basic query. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider the function LookupMethodCall.</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupMethodCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> methodName, LookupSettings settings, DbContext dbContext, OnAfterQueryPrepared onAfterQueryPrepared</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodLookupCall = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LookupDataResolver). GetMethod(methodName, BindingFlags.NonPublic | BindingFlags.Static); methodLookupCall = methodLookupCall.MakeGenericMethod(settings.Model); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lookupSettings = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LookupSettings), <span class="hljs-string"><span class="hljs-string">"settings"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbCtx = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(DbContext), <span class="hljs-string"><span class="hljs-string">"dbContext"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> funct = Expression.Parameter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(OnAfterQueryPrepared), <span class="hljs-string"><span class="hljs-string">"onAfterQueryPrepared"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lookupSearch = Expression.Lambda( Expression.Call( <span class="hljs-literal"><span class="hljs-literal">null</span></span>, methodLookupCall, lookupSettings, dbCtx, funct), lookupSettings, dbCtx, funct); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lookupSearchDelegate = (Func&lt;LookupSettings, DbContext, OnAfterQueryPrepared, JsonResult&gt;) lookupSearch.Compile(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lookupSearchDelegate(settings, dbContext, onAfterQueryPrepared); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First we search for the method type methodName in the current type. After that, using the MakeGenericMethod function, we prepare our model for use as a generic argument. We form the parameters: settings (the entity of the settings obtained from the lukapa), dbContext (the context for accessing the database), onAfterQueryPrepared (the delegate that will be called immediately after the basic query to the database is created. It is needed to add additional filters if they are necessary). Next, create the appropriate lambda that will call our method, then compile it and call it.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We implement functions that call the method corresponding to the request, using the LookupMethodCall function. </font><font style="vertical-align: inherit;">BasicLookup for resolving the text entered by the user in the lookup will refer to the generic LookupSearch function. </font><font style="vertical-align: inherit;">BasicGrid will provide sorting and search in the grid, calling the generic function LookupDataForGrid.</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicLookup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LookupSettings settings, DbContext dbContext, OnAfterQueryPrepared onAfterQueryPrepared</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupMethodCall(<span class="hljs-string"><span class="hljs-string">"LookupSearch"</span></span>, settings, dbContext, onAfterQueryPrepared); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BasicGrid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LookupSettings settings, DbContext dbContext, OnAfterQueryPrepared onAfterQueryPrepared</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupMethodCall(<span class="hljs-string"><span class="hljs-string">"LookupDataForGrid"</span></span>, settings, dbContext, onAfterQueryPrepared); }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We implement functions that perform database operations and generate the resulting data sets. </font><font style="vertical-align: inherit;">These are two generic functions whose calls are described above.</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> JsonResult LookupSearch&lt;T&gt;(LookupSettings settings, DbContext dbContext, OnAfterQueryPrepared onAfterQueryPrepared) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modelType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = dbContext.Set&lt;T&gt;().AsQueryable(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (onAfterQueryPrepared != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = onAfterQueryPrepared(request, settings); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (query != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) request = query.Cast&lt;T&gt;(); } request = request.WhereStartsWith(settings.Filter.SearchField, settings.Filter.SearchString); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResult { Data = request.ToList().Select(t =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { label = modelType.GetProperty(settings.NameField).GetValue(t).ToString(), id = modelType.GetProperty(settings.IdField).GetValue(t).ToString() }).ToList(), ContentType = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, ContentEncoding = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, JsonRequestBehavior = JsonRequestBehavior.AllowGet }; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we get a typed Queryable from dbContext for the corresponding model, whether we look for a delegate, if so, call it and use the query returned by it to further form the query. Then everything is simple, use WhereStartsWith to form a request. We use the values ‚Äã‚Äãfrom the settings entity settings.Filter.SearchField, settings.Filter.SearchString, respectively, to determine the field and the string on which the filtering is performed. In conclusion, we create the resulting array using reflection to obtain data from the fields of the instance t according to the modelType model type. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We return only two columns: label is the textual representation of the associated entry and id is the primary key.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If there are more than one value, the text in the control will be gray, this will indicate that the recording resolution failed and you need to refer to a more detailed presentation. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, we proceed to the implementation of the LookupDataForGrid function, which will provide filtering and search capabilities by associated data.</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> JsonResult LookupDataForGrid&lt;T&gt;(LookupSettings settings, DbContext dbContext, OnAfterQueryPrepared onAfterQueryPrepared) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> modelType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pageIndex = settings.GridSettings.PageIndex - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pageSize = settings.GridSettings.PageSize; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = dbContext.Set&lt;T&gt;().AsQueryable(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (onAfterQueryPrepared != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = onAfterQueryPrepared(request, settings); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (query != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) request = query.Cast&lt;T&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (settings.GridSettings.IsSearch) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (settings.Filter.Operator) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SearchOperator.Equal: request = request.Equal(settings.Filter.SearchField, settings.Filter.SearchString); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SearchOperator.NotEqual: request = request.NotEqual(settings.Filter.SearchField, settings.Filter.SearchString); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> SearchOperator.Contains: request = request.WhereContains(settings.Filter.SearchField, settings.Filter.SearchString); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> totalRecords = request.Count(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> totalPages = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)Math.Ceiling(totalRecords / (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)pageSize); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userGroups = request .OrderBy(!settings.GridSettings.Asc, settings.GridSettings.SortColumn) .Skip(pageIndex * pageSize) .Take(pageSize); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonResult { Data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { total = totalPages, settings.GridSettings.PageIndex, records = totalRecords, rows = ( userGroups.AsEnumerable().Select(t =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { id = modelType.GetProperty(settings.IdField).GetValue(t).ToString(), cell = GetDataFromColumns(modelType, settings, t) }).ToList()) }, ContentType = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, ContentEncoding = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, JsonRequestBehavior = JsonRequestBehavior.AllowGet }; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The function is implemented by analogy with LookupSearch, here we add the processing of page-by-page partitioning, basic sorting and search. </font><font style="vertical-align: inherit;">The list of values ‚Äã‚Äãby columns is obtained using the function GetDataFromColumns. </font><font style="vertical-align: inherit;">This function uses the attribute LookupGridColumnsAttribute to determine the list of columns that our grid expects. </font><font style="vertical-align: inherit;">Below is its code:</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDataFromColumns</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type model, LookupSettings settings, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> instance</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { model.GetProperty(settings.IdField).GetValue(instance).ToString(), model.GetProperty(settings.NameField).GetValue(instance).ToString() }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gridColumns = model.GetCustomAttributeByType&lt;LookupGridColumnsAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gridColumns != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { dataArray.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> column <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gridColumns.LookupColumns <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> model.GetProperty(column).GetValue(instance) <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> val != <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> val.ToString()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataArray; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The resulting array includes, by default, a primary key and a field containing the value of the textual description of the connection. Next, from the model type, we obtain the attribute LookupGridColumnsAttribute and using the instance, using reflection, we pull out the values ‚Äã‚Äãof the columns. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now it is time to implement the base controller, which will ensure the functioning of all the lookup controls on the form in the "default" mode</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LookupBasicController</span></span> : <span class="hljs-title"><span class="hljs-title">Controller</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> DbContext GetDbContext { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(<span class="hljs-string"><span class="hljs-string">"You have to implement this method to return correct db context"</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> IQueryable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupBaseQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IQueryable query, LookupSettings settings</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ModelBinder(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params">(LookupModelBinder</span></span></span><span class="hljs-function">))] LookupSettings settings)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupDataResolver.BasicLookup(settings, GetDbContext, LookupBaseQuery); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LookupDataGrid</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[ModelBinder(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-function"><span class="hljs-params">(LookupModelBinder</span></span></span><span class="hljs-function">))] LookupSettings settings)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LookupDataResolver.BasicGrid(settings, GetDbContext, LookupBaseQuery); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To work correctly in the inheritor class, you must override the database context, and if you plan to expand the default queries, then the LookupBaseQuery function. This function is used to call from LookupSearch and LookupDataForGrid when forming the base query. I also note that the names of functions in the controller that are accessed by JS for receiving data can be defined during the configuration of the html helper. However, the name of the function that performs data retrieval for jqGrid is formed according to the following pattern: The name specified when configuring html helper + Grid. By default, JS will refer to the LookupData and LookupDataGrid functions.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this we can say that the development of the basic elements of the component is completed. </font><font style="vertical-align: inherit;">In addition to the source code, you can also find the lookup.js file, which is responsible for the client part of the work of our component, I did not consider it here, since it does not represent much interest.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5. Example of use </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Consider the models that were described at the beginning of the article. </font><font style="vertical-align: inherit;">Let's apply our component to the connection.</font></font><br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Table(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UserProfile"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserProfile</span></span> { [Key] [DatabaseGeneratedAttribute(DatabaseGeneratedOption.Identity)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UserName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Lookup(Model = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UserGroup), NameField = <span class="hljs-string"><span class="hljs-string">"GroupName"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>? UserGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> UserGroup UserGroup { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } [LookupGridColumns(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Description"</span></span> })] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserGroup</span></span> { [Key] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> UserGroupId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">"Group Name"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GroupName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [DisplayName(<span class="hljs-string"><span class="hljs-string">"Group Description"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Description { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;UserProfile&gt; Users { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, we have a UserProfile in which we add a Lookup link to the UserGroup and determine which field we will use for the textual representation of this record. </font><font style="vertical-align: inherit;">In the UserGroud table, add the LookupGridColumns attribute in which we specify the add. </font><font style="vertical-align: inherit;">columns that you would like to see in the presentation. </font><font style="vertical-align: inherit;">Actually this is all, now go to the controller.</font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserListController</span></span> : <span class="hljs-title"><span class="hljs-title">LookupBasicController</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DataBaseContext _db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataBaseContext(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> DbContext GetDbContext { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _db; } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inherit from the LookupBasicController and override GetDbContext in order to give the LookupBasicController access to the database context. </font></font><br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Edit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { UserProfile userprofile = _db.UserProfiles.Include(c =&gt; c.UserGroup) .SingleOrDefault(x =&gt; x.UserId == id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userprofile == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpNotFound(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(userprofile); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Added a query to related data from the UserGroup table. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This completes the controller setup and we proceed to the view.</font></font><br><br><pre> <code class="cs hljs">@<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> TestApp.Models @model UserProfile @{ ViewBag.Title = <span class="hljs-string"><span class="hljs-string">"Edit"</span></span>; } @Styles.Render(<span class="hljs-string"><span class="hljs-string">"~/Content/JqGrid"</span></span>) &lt;h2&gt;Edit&lt;/h2&gt; @<span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (Html.BeginForm()) { @Html.ValidationSummary(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) &lt;fieldset&gt; &lt;legend&gt;UserProfile&lt;/legend&gt; @Html.HiddenFor(model =&gt; model.UserId) &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"editor-label"</span></span>&gt; @Html.LabelFor(model =&gt; model.UserName) &lt;/div&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"editor-field"</span></span>&gt; @Html.EditorFor(model =&gt; model.UserName) @Html.ValidationMessageFor(model =&gt; model.UserName) &lt;/div&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"editor-label"</span></span>&gt; @Html.LabelFor(model =&gt; model.UserGroupId) &lt;/div&gt; &lt;div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>=<span class="hljs-string"><span class="hljs-string">"editor-field"</span></span>&gt; @Html.LookupFor(model =&gt; model.UserGroupId) @Html.ValidationMessageFor(model =&gt; model.UserGroupId ) &lt;/div&gt; &lt;p&gt; &lt;input type=<span class="hljs-string"><span class="hljs-string">"submit"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>=<span class="hljs-string"><span class="hljs-string">"Save"</span></span> /&gt; &lt;/p&gt; &lt;/fieldset&gt; } &lt;div&gt; @Html.ActionLink(<span class="hljs-string"><span class="hljs-string">"Back to List"</span></span>, <span class="hljs-string"><span class="hljs-string">"Index"</span></span>) &lt;/div&gt; @section Scripts { @Scripts.Render(<span class="hljs-string"><span class="hljs-string">"~/bundles/lookup"</span></span>) @Scripts.Render(<span class="hljs-string"><span class="hljs-string">"~/bundles/jqueryval"</span></span>) @Scripts.Render(<span class="hljs-string"><span class="hljs-string">"~/bundles/jqueryui"</span></span>) @Scripts.Render(<span class="hljs-string"><span class="hljs-string">"~/bundles/jqgrid"</span></span>) }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here you need to remember to add extra. scripts like jqgrid, lookup, etc. You can view the presentation in more detail by using the source code attached to the article. </font></font><br><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a result, you get a field with a button that allows you to conveniently search and sort the data in related tables. Selecting an item in the table is done by double-clicking on the desired item. It is too early to talk about some kind of complete control, there is still much to be done. The code needs refactoring and optimization, however, in general, it functions and implements the main functions set at the design stage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It all looks like this:</font></font><br><img src="https://habrastorage.org/storage3/a0b/0f9/451/a0b0f94516aa5f3d629fcba656d72f48.png"><br><br><h4>  6. Conclusion </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In conclusion, I want to say that we spent some time searching for a component that corresponds to our needs, and finally settled on the ASP.net MVC Awesome 3.5 product. </font><font style="vertical-align: inherit;">I note that the MVC Awesome Lookup component is quite flexible, and allows you to perform various types of settings, but since the decision was made to develop everything from scratch, I cannot recommend it, since I did not use it. </font><font style="vertical-align: inherit;">See the sample usage and code here: </font></font><a href="http://demo.aspnetawesome.com/LookupDemo"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Awe Lookup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">They also have support for multiple selections. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The source code of the component and the test application discussed in the article can be downloaded here: </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TestApp.zip</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope the material was interesting to you!</font></font><br><br></div><p>Source: <a href="https://habr.com/ru/post/190482/">https://habr.com/ru/post/190482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190468/index.html">Crossed the border - lost e-books</a></li>
<li><a href="../190472/index.html">The most popular article in a scientific journal</a></li>
<li><a href="../190474/index.html">Data structures, PHP. Part two</a></li>
<li><a href="../190478/index.html">The developer reported a bug in Facebook on the page Zuckerberg</a></li>
<li><a href="../190480/index.html">How to close the Internet in Russia</a></li>
<li><a href="../190484/index.html">Creating a browser igrulki in the social network from and to</a></li>
<li><a href="../190488/index.html">Cookie without cookies</a></li>
<li><a href="../190490/index.html">Nokia Sensing XCHALLENGE 2013</a></li>
<li><a href="../190492/index.html">Ten reasons not to use a statically typed functional programming language</a></li>
<li><a href="../190494/index.html">Improved CoffeeScript Inheritance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>