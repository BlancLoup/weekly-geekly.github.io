<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Happy new year with new MQTT / UDP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. 

 As I wrote recently (the first short article on MQTT / UDP ), MQTT / UDP is an MQTT based protocol, but: 



- Goes over UDP broadcast (no bro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Happy new year with new MQTT / UDP</h1><div class="post__text post__text-html js-mediator-article">  Hey. <br><br>  As I wrote recently (the <a href="https://habr.com/post/429714/">first short article on MQTT / UDP</a> ), MQTT / UDP is an MQTT based protocol, but: <br><br><ul><li>  Goes over UDP broadcast (no broker needed, almost no configuration needed) </li><li>  Up to indecent simple to implement (10 lines on C + UDP / IP stack - and you send data from the sensor) </li><li>  Everyone hears everyone </li></ul><br>  In a sense, this is CAN, but on top of Ethernet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What for. <br><a name="habracut"></a><br>  My apartment has been living for several years under the control of a system like ‚Äúthe house is not quite oligophrenic‚Äù.  Mind it would be redundant to call it, but - light and climate are automated.  To imagine the scale of the disaster - the system occupies a full jam-packed rack about 19 inches wide and two meters high.  Two walls of the rack are occupied almost to the floor. <br><br>  When I designed all this, the issue of fault tolerance came first.  Several years of operation have shown: it is true.  Denies everything.  Sooner or later.  Here are just electromechanical relays have not yet refused, namely, the last echelon of protection against failure. <br><br>  The next problem after fault tolerance is a zoo.  Due to the natural flow of life, my curiosity and urgent needs, the system is inhabited by a normal Unix on a standard PC, ALC PLC, Raspberr + Orange PI, modules on Atmega, modules based on NodeMCU (ESP8266), and all this goes to each other through modbus 485, modbus TCP, http, and on the side hangs restless MQTT broker, as a legacy of an unsuccessful attempt to switch to it with the entire camp. <br><br>  Why the attempt to switch to MQTT failed.  Firstly, for a part of the iron it is too heavy or complicated.  On that fragment of Pascal, who is hiding in the CodeSys PLC, only a masochist can write an MQTT.  But then it is necessary and debug.  Similarly, atmega: you can cram, but closely.  But this is not the whole trouble. <br><br>  The MQTT as it is (and it is 3.1.1 everywhere) insists on sending the PUBLISH packet (that is, our message to the broker) to all recipients, including the sender.  The effect of this insanity is enchanting - the same OpenHAB cannot send and receive data to the MQTT under the same name.  This means that it is impossible to organize a bus on the basis of MQTT (several modules that update the value of the same object and use it).  Namely, this is how the PLC communication should be organized, in which the main control of the light lives, OpenHAB, which controls the light from the web interface and the mobile application, and smart switches, which I would like to be able to add here and there.  That is, of course, this problem can be circumvented, but in fact it means to build your own protocol OVER MQTT, and this already seems like a brute force. <br><br>  At the same time, what do I need?  Send an update of the parameter value and get it on all interested points.  For what, actually, grandfathers and made UDP on the broadcast address. <br><br>  After the last post on Habr√©, one of the readers for a long time reproached me with the unreliability of the UDP protocol.  I responded to it speculatively that for IoT this UDP is MORE reliable than TCP: with 50% packet loss on the TCP network, it will not just lie down, but will lie ALL OVER, and the temperature sensor that sends measurements via UDP will simply lose half of the samples, which will affect the system works about nothing.  At all. <br><br>  But it was speculative.  However, the New Year holidays are given to the person in order to finish the champagne to ask themselves: shall we put home lokalka on the shoulder blades today?  And what would not. <br><br>  I took MQTT / UDP and wrote a primitive test.  One side sends consecutive packets without a pause between packets as much as they can.  The second one considers speed and packet loss.  The experiment was simple: we start this mockery, and in parallel two HD TVs show movies from the Internet, and the desktop computer writes a huge file on the NAS. <br><br>  Rate the result.  I was waiting for everything, but ... the maximum loss on UDP reached a full half percent, and both TVs stopped the show.  So I was still a pessimist.  In a real home network, UDP delivery reliability is close to absolute.  However, the version with confirmations and resend packages I, apparently, will do.  Difficulties a bit, but the question removes completely. <br><br>  The second question is security, but, really, if the home network is hacked to me, the loss of data from the temperature sensors is the last thing I‚Äôll grieve about.  However, again, the task of digitally signing packages is present in the issue tracker, and I already understand how to extend MQTT packets for its implementation. <br><br>  In general, I plan on switching to MQTT / UDP on the first pair of devices in my home network just a few days ago. <br><br>  And I suggest you try it in your programs and devices: <a href="https://github.com/dzavalishin/mqtt_udp">Repository</a> and <a href="https://mqtt-udp.readthedocs.io/en/latest/">documentation in English</a> . <br><br>  What is available: <br><br>  Pretty complete implementations on Java, Python and Si.  Basic implementation on Lua.  So far, only sending for Arduino and CodeSys PLC (tested and works on Aries, but should go on anything). <br><br>  GUI tool to look at what is happening and intervene: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f04/333/9c9/f043339c94a34a24a3887043f095baae.png" alt="image"><br><br>  Programs for sending and receiving data in Python, Lua and Java. <br><br>  Python connectors for integration with regular MQTT and directly with OpenHAB.  They practice loop protection by preventing the message from being broadcast back 5 seconds after passing in the forward direction.  In addition, there is a library for limiting the flow of repeated data.  It checks if the update has already been updated for the specified time, and if it has, then skips the new update only if the data has changed. <br><br>  I plan to gradually move to this protocol completely, and here is one example of what I want with sensors: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3dc/6ed/528/3dc6ed528bb36067f12038fad62857c7.png"><br><br>  There are three sensors in one room (well, or on the street, it does not matter).  They send samples via MQTT / UDP.  These counts are simultaneously obtained by the main system of the smart home (OpenHAB), a historical database and a wall monitor that shows the temperature to the residents. <br><br>  The beauty of MQTT / UDP is that in such a scheme, the failure of any block does not create any problems for everyone else.  And this is with the enchanting simplicity of the protocol. <br><br>  Moreover, redundant control schemes with redundancy are easily implemented in the same scheme.  The database server can be duplicated without any problems.  Cunning will duplicate the modules that are involved in management.  For example, listening to the temperature give out the control effect on the radiators.  But, probably, this is the next story.  Today I plan to stay on collecting signals from the sensors and the exchange between modules of the smart home. </div><p>Source: <a href="https://habr.com/ru/post/435450/">https://habr.com/ru/post/435450/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../435434/index.html">We use annotations in PHP to the maximum</a></li>
<li><a href="../435436/index.html">5 IT infrastructure trends: forecast for 2019</a></li>
<li><a href="../435442/index.html">Funnel change</a></li>
<li><a href="../435446/index.html">Verkhuffa algorithm for an arbitrary even number system</a></li>
<li><a href="../435448/index.html">About the experience of communicating with the signal generator through QTcpSocket and SCPI</a></li>
<li><a href="../435452/index.html">End-to-end testing of microservices with Catcher</a></li>
<li><a href="../435454/index.html">AOP vs Functions</a></li>
<li><a href="../435462/index.html">Testing Node.js projects. Part 1. Anatomy of tests and types of tests</a></li>
<li><a href="../435464/index.html">Testing Node.js projects. Part 2. Evaluation of the effectiveness of tests, continuous integration and analysis of code quality</a></li>
<li><a href="../435466/index.html">React Tutorial, Part 6: Some Course, JSX, and JavaScript Features</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>