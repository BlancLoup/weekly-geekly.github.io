<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using WordPress AJAX Handler</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="WordPress, being one of the most popular CMS in the world, is provided with detailed documentation, or rather, even two . In this connection, in no ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using WordPress AJAX Handler</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/47b/b7d/c87/47bb7dc872ab4e68b6b88937c08659fc.jpg"></div><br><br>  WordPress, being one of the most popular CMS in the world, is provided with detailed documentation, or rather, even <em>two</em> .  In this connection, in no case should this text be perceived as a description of some ‚Äúbest practices‚Äù and certainly no one is blindly following what has been described.  The article is just a quick answer to the question ‚Äúhow ?!‚Äù (next paragraph) and a detailed description of everything you need to know in order to get WordPress to respond to AJAX requests (the rest of the article). <br><br><h1>  Briefly </h1><br>  Traditionally, AJAX requests require two things: a script on the server (backend), which will respond to requests, and a script on the client (frontend), which will do these requests.  WordPress allows you to delegate functions to refer to a special URL where the request handler is located. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, it works, "WordPress-way", like this: <br><br><ol><li> On the backend, using the <code>admin_url</code> function, <code>admin_url</code> get a link to the AJAX request handler and pass it to the frontend in one of the ways.  It is to this link that we will make our requests. </li><li>  On the backend, a hook is registered with a function to handle some kind of action.  Let's call this action, for example, get_posts. </li><li>  Front-end makes requests to the URL from point 1, passing the name of the action.  For example <code>?action=get_posts</code> . <br>  On the back end, if a hook is registered on an action, the function we set is executed. </li></ol><br><br>  This is how simple it is.  Now more. <br><a name="habracut"></a><br><h1>  In detail </h1><br><h2>  AJAX handler on backend </h2><br>  Some people do an AJAX handler manually by including the wp_load file.  This is considered a very, very bad practice for a whole bunch of reasons.  WordPress has its own handler.  Be good and use it. <br><br>  After the front-end ‚Äúfound out‚Äù where to send requests, you need to add a hook to the backend to handle these requests.  The required parameter in these requests is <code>action</code> : this parameter determines what exactly we want from the backend. <br><br>  In order to create a new AJAX handler method, you need to hang two hooks: <code>wp_ajax_&lt; &gt;</code> and <code>wp_ajax_nopriv_&lt; &gt;</code> .  For example, like this: <br><br><pre> <code class="php hljs">add_action(<span class="hljs-string"><span class="hljs-string">'wp_ajax_get_posts'</span></span> , <span class="hljs-string"><span class="hljs-string">'get_posts_callback'</span></span>); add_action(<span class="hljs-string"><span class="hljs-string">'wp_ajax_nopriv_get_posts'</span></span>, <span class="hljs-string"><span class="hljs-string">'get_posts_callback'</span></span>);</code> </pre><br>  The <code>wp_ajax_</code> prefix at the beginning of the hook name will make WordPress understand that we are trying to create an AJAX request handler.  The <code>wp_ajax_nopriv</code> prefix allows <code>wp_ajax_nopriv</code> to register a hook for non-logged users.  Thus, you can register different handlers for logged in and unlocked users, which can be convenient.  At the same time, if you need an ajax request to be executed for both, you have to hang one function on both hooks. <br><br>  These hooks are the most common, the same as all other WP hooks.  As a result of the registration of such hooks, when accessing an URL by <code>wp-admin/admin-ajax.php?action=get_posts</code> function should be <code>get_posts_callback</code> . <br><br><pre> <code class="php hljs">add_action( <span class="hljs-string"><span class="hljs-string">'wp_ajax_do_something'</span></span>, <span class="hljs-string"><span class="hljs-string">'get_posts_callback'</span></span> ); <span class="hljs-comment"><span class="hljs-comment">// For logged in users add_action( 'wp_ajax_nopriv_do_something', 'get_posts_callback' ); // For anonymous users function do_something_callback(){ echo(json_encode( array('status'=&gt;'ok','request_vars'=&gt;$_REQUEST) )); wp_die(); }</span></span></code> </pre><br>  As a result of executing this code, a link like <code>wp-admin/admin-ajax.php?action=do_something</code> should display a piece of JSON. <br><br><h2>  Some features on the backend </h2><br>  It probably makes sense to notice that the hooks in WordPress are hung every time.  That is, the handler needs to be registered every time, preferably in a file that is included every time (in the case of a theme, this is the functions.php file) If you try to register an AJAX hook, for example, in the page.php or index.php files, the themes will not work, because when you access the handler, these files, of course, will not be executed. <br><br>  It is recommended that all functions hung on AJAX handler <code>wp_die</code> ended by calling <code>wp_die</code> or the <code>wp_send_json_success</code> functions and the like.  Or simple <code>die</code> , at worst, cause. <br><br>  In case of an error, the request handler returns the code 0 or -1, depending on the cause of the error.  In particular, in the event that such a hook does not exist (that is, it was not registered for some reason), 0 is returned. <br><br>  The <code>is_admin</code> function, which returns true, if the user is in the site <code>is_admin</code> , being called from an AJAX handler, always returns true. <br><br>  There is a function <code>check_ajax_referer</code> , which checks the referrer (checks where the request originated from) and interrupts the execution if the referrer is some kind of ‚Äúnot such‚Äù.  This function can also check <br>  nonce.  You can read more in the relevant article of the <a href="https://codex.wordpress.org/Function_Reference/check_ajax_referer">code</a> . <br><br><h2>  Link to frontend </h2><br>  The address of the request handler is something like <code>wp-admin/admin-ajax.php</code> .  The trick is that our frontend "does not know" the addresses of this link.  Therefore, if we want our theme or plugin to be as versatile and portable as possible - we need to get to WordPress and send to the front-end the actual address of this link: <br><br><pre> <code class="php hljs">$ajax_url = admin_url(<span class="hljs-string"><span class="hljs-string">'admin-ajax.php'</span></span>);</code> </pre> <br>  It can be transmitted to the frontend in many different ways  Often this link is not the only thing that needs to be sent to the frontend, so I prefer to insert it with the help of the corresponding hook in wp_head in the <code>&lt;script&gt;</code> : <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// -  functions.php function js_variables(){ $variables = array ( 'ajax_url' =&gt; admin_url('admin-ajax.php'), 'is_mobile' =&gt; wp_is_mobile() //   -   ); echo( '&lt;script type="text/javascript"&gt;window.wp_data = ', json_encode($variables), ';&lt;/script&gt;' ); } add_action('wp_head','js_variables');</span></span></code> </pre><br>  This hook will output the <code>&lt;script&gt;</code> with the registration of global JS variables with reference to the handler in the <code>&lt;head&gt;</code> section of the theme (of course, for this you need to call the <code>wp_head</code> function in it, which is anyway recommended for any topic) <br><br>  The tag will be inserted immediately after all connected assets (scripts and style sheets registered through the WordPress asset system) <br><br>  You can also send a link to the frontend using the <code>localize_script</code> function.  I find such an approach a bit dreary: de facto, we send to the frontend not our javascript from the assets folder of the theme or from some CDN, but its modified version, without leaving the end user the choice (which he has, for example, the case with plugins that glue all the scripts together into one is whether to use these plugins for it or not).  If anything - more about the approach with <code>localize_script</code> - in the WordPress codex, in the article <a href="https://codex.wordpress.org/AJAX_in_Plugins">AJAX In Plugins</a> . <br><br>  And, of course, you can NOT transfer this link to the frontend, but simply scramble it or her part directly into the JS file.  But no one guarantees that in the next version of WordPress or simply on some other specific environment the handler URI will be 'wp-admin / admin-ajax.php'.  For universality and compatibility, it is recommended to always use the admin_url function to get the actual reference to the handler and transfer it to the frontend manually. <br><br>  By the way, on all admin pages this link is already forwarded to the ajaxurl global variable in JS.  Some plugins also post this link for the site pages, but you shouldn‚Äôt count on it (we don‚Äôt want any extra dependencies for our plugin / theme, right?) <br><br><h2>  On the front end </h2><br>  Now we can quite easily make web requests to the backend from our front end.  For example, if we link the link to the wp_data.ajax_url variable and jQuery is connected, it will look something like this: <br><br><pre> <code class="javascript hljs">jQuery(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$</span></span></span><span class="hljs-function">)</span></span>{ $.ajax({ <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.wp_data.ajax_url, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: { <span class="hljs-attr"><span class="hljs-attr">action</span></span> : <span class="hljs-string"><span class="hljs-string">'do_something'</span></span> }, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'AJAX response : '</span></span>,response); } }); });</code> </pre><br>  If everything is done correctly, at startup, the web request to the backend will be executed, which will respond with a piece of JSON, which will then be received by the frontend and output to the console. <br><br><h2>  OOP lovers </h2><br>  If you are trying to build your own theme architecture, with autoloader and OOP, you can define an abstract class of this type: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AJAX_Handler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action_name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;init_hooks($action_name); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_hooks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action_name)</span></span></span><span class="hljs-function"> </span></span>{ add_action(<span class="hljs-string"><span class="hljs-string">'wp_ajax_'</span></span>.$action_name , <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>,<span class="hljs-string"><span class="hljs-string">'callback'</span></span>)); add_action(<span class="hljs-string"><span class="hljs-string">'wp_ajax_nopriv_'</span></span>.$action_name, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>,<span class="hljs-string"><span class="hljs-string">'callback_nopriv'</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback_nopriv</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;callback(); } <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  Now it is enough to create for each action its successor of this class, in which you define the callback method, then create a new object of the successor class, passing the name of the action to the constructor: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Something</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AJAX_Handler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ wp_send_json_success(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'test'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'Works!'</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Something(<span class="hljs-string"><span class="hljs-string">'do_something'</span></span>);</code> </pre><br>  On the wp_ajax_nopriv_XXX hook, the <code>callback_nopriv</code> method hangs up, which in the parent class simply calls the <code>callback</code> method, but in its successor, of course, it could be overridden.  As a result of this, when accessing the URL of the form <code>/wp-admin/admin-ajax.php?action=do_something</code> we get an answer of the form <code>{"success":true,"data":{"test":"Works!"}}</code> . <br><br><h2>  CORS and possible trouble with the protocol (HTTP / HTTPS) </h2><br>  For security reasons, web browsers limit the ability of HTTP requests to resources whose domain is different from the domain on which the script that runs these requests is running.  <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS">CORS (‚Äúcross-origin resource sharing‚Äù)</a> is a W3C-recommended mechanism for allowing cross-domain requests to the server (from the server side).  If you want to make some kind of API for accessing from third-party resources from an AJAX request handler (no matter how awful this idea may seem, this can be used) - you have to either allow cross-domain requests to the handler by adding the <code>Access-Control-Allow-Origin</code> , or implement an API using JSONp. <br><br>  If your site is configured to work in HTTPS, the admin_url function will return a link with https.  But if the site has the wrong / expired SSL certificate, it will redirect to the http version of the site and the site will be viewed using the http protocol.  As a result, the frontend will get a link to the handler in another protocol, which is likely to cause problems.  In particular, the Firefox browser will most likely not be happy about this, having decided that you are trying to make a cross-domain query. <br><br>  Therefore, if you are using HTTPS, you are not sure that the certificate will always and everything is in order and you want to be sure that even if it falls off, the site will work fine, it makes sense to check on the frontend whether the handler reference protocol matches the page protocol on which the script is running. <br><br>  Author: Ilya Andrienko, DataArt web developer. </div><p>Source: <a href="https://habr.com/ru/post/271189/">https://habr.com/ru/post/271189/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271173/index.html">Preparing ASP.NET 5, Release 6: Continuous Deployment with Visual Studio Team Services - Complete Guide</a></li>
<li><a href="../271179/index.html">Results of the Russian Developers Cup 2015</a></li>
<li><a href="../271181/index.html">My PHP 7 migration experience</a></li>
<li><a href="../271183/index.html">The Chrome Dev Summit live, second day</a></li>
<li><a href="../271185/index.html">Upsource 2.5: smart email notification, new Review page design, improvements in IDE plugin and much more</a></li>
<li><a href="../271191/index.html">How to analyze a file for malware?</a></li>
<li><a href="../271193/index.html">"Red Card": what is behind the warning of malware?</a></li>
<li><a href="../271195/index.html">Flexbox for interfaces in all its glory: Implementing Tracks (Part 1)</a></li>
<li><a href="../271197/index.html">Nim Tutorial (Part 1)</a></li>
<li><a href="../271199/index.html">Main announcements of the Microsoft Connect conference () and the virtual conference Visual Studio Connect 2015 in Russia on December 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>