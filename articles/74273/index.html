<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MongoDB - make good coffee</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Friends, first of all I want to thank you for the appreciation of my work, it is pleasant, and motivates me to continue. So, why we sho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MongoDB - make good coffee</h1><div class="post__text post__text-html js-mediator-article"><h5>  Introduction </h5><br>  Friends, first of all I want to thank you for the appreciation of my work, it is pleasant, and motivates me to continue.  So, why we should buy our elephants, I think you already understood from the <a href="http://habrahabr.ru/blogs/webdev/74144/">first article</a> , someone has already downloaded and tasted, and someone is just going.  Anyway, let's begin. <br><br>  Today we will put MongoDB, below we will consider the newly baked <a href="http://root.loopback.su/habralogger/">HabraLogger</a> and <a href="http%253A%252F%252Fhabrahabr.ru%252F">spy</a> on the main page of Habr in real time. <br><a name="habracut"></a><br><h5>  Fall asleep coffee and pour boiling water </h5><br>  First, choose your release like and download - <a href="http://mongodb.org/display/DOCS/Downloads">Downloads</a> . <br>  You can choose any release, I use 1.1.1.  If you are not afraid of falls, put the last one - 1.1.2 (I don‚Äôt promise at all that it will fall, it's just possible). <br><br>  If there is an assembly for your OS, I advise you to install the assembly, but if not, you will have to build from the sources.  The simplest installation of the assembly is well given here - <a href="http://www.mongodb.org/display/DOCS/Quickstart">Quickstart</a> .  When building from source, you will have to work with Scons, and under FreeBSD, the error "shell / dbshell.cpp: 77: error: 'sigrelse' will not be declared in this scope" will arise - just comment out this line. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we assume that they have set.  If replication is planned, I advise you to run `mongod --master`, with this key, MongoDB keeps a log of operations (oplog).  You can play now using `mongo test` (test is the name of the database): <br><br> <code>&gt; db.habratest.save({abra: "foo", ka: true, da: 123, bra: {foo: "bar"}}); #       . <br> &gt; db.habratest.find({ka: true}); #    ka == true,     <br> {"_id" : ObjectId( "4af18c86977fd21033ca67f8") , "abra" : "foo" , "ka" : true , "da" : 123 , "bra" : {"foo ar"}} <br></code> <br>  And now let's create an index - or rather make sure it is available: <br><br> <code>&gt; db.habratest.ensureIndex({"da": 1}); <br> true <br> &gt; db.habratest.find({da: 123}); #     . <br> {"_id" : ObjectId( "4af18c86977fd21033ca67f8") , "abra" : "foo" , "ka" : true , "da" : 123 , "bra" : {"foo" : "bar"}} <br> &gt; db.habratest.update({da: 123},{"$set": {pi: 3.14159265}}); #     <br> &gt; db.habratest.find({da: 123}); <br> {"_id" : ObjectId( "4af18c86977fd21033ca67f8") , "abra" : "foo" , "ka" : true , "da" : 123 , "bra" : {"foo" : "bar"} , "pi" : 3.14159265} <br> &gt; db.habratest.update({da: 123},{"$set": {"bra.pi": 3.14159265}}); #    <br> &gt; db.habratest.find(); <br> {"_id" : ObjectId( "4af190176ca438316825ddef") , "abra" : "foo" , "ka" : true , "da" : 123 , "pi" : 3.14159265 , "bra" : {"foo" : "bar" , "pi" : 3.14159265}} <br> &gt; db.habratest.remove({ka: true}); <br> &gt; db.habratest.find(); <br> &gt; db.habratest.drop(); <br> {"nIndexesWas" : 2 , "msg" : "all indexes deleted for collection" , "ns" : "test.habratest" , "ok" : 1} <br></code> <br>  The _id property is generated by the client automatically, and is inherent in each object, if desired, the ID can be formed independently, putting into it useful data. <br><br>  I think everything is clear.  For piquant details of the functions I advise you to refer to the documentation. <br><br>  Now let's connect the driver to our development tool, the list of available drivers is <a href="http://mongodb.org/display/DOCS/Drivers">mongodb.org/display/DOCS/Drivers</a> .  In this article I will be guided by PHP, but with any other language everything will be quite similar.  In PHP, the driver is represented by the 'mongo' extension in PECL. <br><br><h5>  We drink the first cup </h5><br>  I have prepared a small sample application - <a href="http://root.loopback.su/habralogger/">HabraLogger</a> . <br><br>  I think everything is clear from the code and comments to it, if not, I will be happy to answer questions.  You may have noticed that at the beginning of the script a couple of classes are inherited from the originals, this is not necessary and only gives syntactic sugar in the form of $ mongo-&gt; mydb-&gt; mycollection.  The execution time motivates (0.411 milliseconds). <br><br>  Surely some of you noticed the group () operation in a piece of code: <br><br> <code>$stat['hostsHours'] = $db-&gt;hosts-&gt;group( <br> array('hour' =&gt; true) // keys <br> ,array('count' =&gt; 0) // initial object <br> ,'function (obj, prev) {++prev.count;}' // reduce function <br> ,array('url' =&gt; $url) // condition <br> ); <br></code> <br>  The first argument specifies the keys (fields) for grouping - GROUP BY hour. <br>  In the second - the initial state of the object, which will be before the first iteration. <br>  In the third - the function that is used to reduce (reduce) the set. <br>  Well, in the fourth - the filter on the basis of which the set will be formed to reduce. <br>  The SQL analogue of this action is SELECT hour, COUNT (*) count FROM hosts GROUP BY hour. <br><br>  The HabraLogger algorithm is quite simple, the log is written to the hits and hosts collection, the hosts contain a unique index by IP and day, so only unique ones get there within a day, and when displaying the graph, a simple grouping is carried out. <br><br>  I emphasize that this is only an example, and of course, a more optimal solution would be to rotate the log and perform aggregation once every n minutes.  But we will consider optimization next time. <br><br><h5>  Clustering?  I was waiting for this question! </h5>  To begin with, we define the terms: <br>  Sharding - splitting a database into several shards. <br>  Shard - one or more equivalent servers that store the same piece of data. <br>  Config-server is a server that stores meta-information primarily about which shard'e which chunk lies. <br>  Chunk - a range of documents by index, for example, the hosts collection can be broken by index on the url property. <br>  mongos is a daemon that accepts requests from clients, interacts with the necessary shard'ami and config-servers, and sends a ready response to the client. <br><br>  It looks like this: <br><br><img src="http://root.loopback.su/files/sharding.png"><br><br>  I will not go into the retelling of the documentation, and the description of the behavior of mongos on each type of request.  Sharding is described in detail in the official English-language documentation - <a href="http://www.mongodb.org/display/DOCS/Sharding%2520Introduction">Sharding Introduction</a> . <br>  Let me just say - Google dad uses a similar scheme. <br><br><h5>  We extinguish the light, let the water down </h5><br>  That's all for today.  Note that the topic of the next article will be at the request of radio listeners.  I can tell about GridFS (file system on MongoDB) and consider other examples. <br><br>  Thank you for your attention, friends!  Waiting for your feedback. <br><br>  PS The statistics of visits to this article can be found <a href="http://habrahabr.ru/blogs/webdev/74273/">here</a> , and the statistics of another article that has been spied since the night is <a href="http://habrahabr.ru/blogs/android/74298/">here</a> . <br><br>  <strong>UPD:</strong> <a href="http%253A%252F%252Fhabrahabr.ru%252F">We spy</a> on the main page of Habr in real time. </div><p>Source: <a href="https://habr.com/ru/post/74273/">https://habr.com/ru/post/74273/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../74263/index.html">How to take my money from the Yandex wallet. Part 1</a></li>
<li><a href="../74264/index.html">Give invites to Google Wave</a></li>
<li><a href="../74267/index.html">How I built my data center - part two, construction. Many pictures</a></li>
<li><a href="../74268/index.html">Invites to Animuksia</a></li>
<li><a href="../74270/index.html">Rip str0ke</a></li>
<li><a href="../74275/index.html">Co-working in Minsk!</a></li>
<li><a href="../74277/index.html">re: sad statistics</a></li>
<li><a href="../74278/index.html">Project Note</a></li>
<li><a href="../74279/index.html">Alltopnews.ru - blog ranking based on the Yandex. Blogs API</a></li>
<li><a href="../74280/index.html">Recursive LISP programming - formula solver</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>