<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interactive telegram bot in PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On this topic, many articles are written on Habr√© and just on the Internet. And I will tell you about my experience of working with a telegram bot and...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interactive telegram bot in PHP</h1><div class="post__text post__text-html js-mediator-article">  On this topic, many articles are written on <a href="https://habrahabr.ru/search/%3Fq%3Dtelegram%2Bbot">Habr√©</a> and just on the Internet.  And I will tell you about my experience of working with a telegram bot and moments that I couldn‚Äôt solve on the forehead. <br><a name="habracut"></a><br><h3>  Create bot </h3><br>  The first thing to start with is creating a bot.  There is <a href="https://core.telegram.org/bots">official documentation</a> and steps are detailed there. <br><br><div class="spoiler">  <b class="spoiler_title">If the described instructions do not understand anything, then here is a step by step instruction.</b> <div class="spoiler_text"><ol><li>  find <a href="https://telegram.me/BotFather">BotFather</a> in telegram bot and add a contact list to yourself </li><li>  see available bot commands with / help <br><br><img src="https://habrastorage.org/webt/m2/na/vy/m2navy2g_t53mymh3zfhl7uoufy.png"><br></li><li>  choose / newbot and further, following the instructions, perform the necessary actions (the following image is taken from google) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/b-/f1/mg/b-f1mgtdvjtfelkbysbphaxqh4i.png"><br></li></ol><br></div></div><br>  After creating the bot, you will receive a token, which you will need to use in the code of your bot, so the message with the token must be saved. <br><br><h3>  We associate the bot with the application \ website </h3><br>  The most interesting begins, and also here I faced the first problem. <br>  First of all, choose a library in php to create a bot.  I stopped my choice on <a href="https://github.com/TelegramBot/Api">this library</a> , since it seemed to me the most convenient. <br><br>  After connecting the library, you need to organize the interaction of the bot with your site \ application.  You can organize this interaction using <a href="https://core.telegram.org/bots/api">webhukov</a> . <br><br>  A webhook is a kind of repeater that will send all requests from the bot to the address specified when registering the webhook.  It is very simple to register a webhuk, you just need to send a request like <b>https: //api.telegram.org/bot~token~/setWebhook?url=https: //example.com/path</b> , where <br>  <b>https: //example.ru/</b> - this is a link to your website where the bot will be redirected to. <br>  <b>~ token ~</b> is the token you received when registering your bot. <br>  <b>The path</b> is the part of the url that calls will be sent to. <br><br>  And this is where the problem arises.  It turns out that the webbook can only be registered if the site is on https.  If your site is on http, then you will not be able to register a webhost. <br><br><div class="spoiler">  <b class="spoiler_title">But there is a solution if you do not want to buy a certificate</b> <div class="spoiler_text">  You can use the service <a href="https://letsencrypt.org/">Let's Encrypt</a> <br>  Go to the section <a href="https://letsencrypt.org/getting-started/">getting startted</a> and follow the instructions. <br></div></div><br><h3>  Writing bot code </h3><br>  Now we start programming.  Once the relationship is organized, you can begin to write the logic of our bot. <br><br>  The telegram developers, in order to make it easier for users to work with bots, ask all developers to implement support for the following commands: <br><br>  / start - starts communication with the user (for example, sends a greeting message).  You can also pass additional arguments to this command. <br>  / help - displays a message using the command.  It can be a short message about your bot and a list of available commands. <br><br>  All we need to do is to write the following code in the controller of your application \ site: <br><br><pre><code class="php hljs">$token = <span class="hljs-string"><span class="hljs-string">""</span></span>; $bot = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \TelegramBot\Api\Client($token); <span class="hljs-comment"><span class="hljs-comment">//   start $bot-&gt;command('start', function ($message) use ($bot) { $answer = ' !'; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //    $bot-&gt;command('help', function ($message) use ($bot) { $answer = ': /help -  '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); $bot-&gt;run();</span></span></code> </pre> <br>  Now if in the window of the telegrams of the bot write / help, the text will be displayed: <br><br>  <i>Commands:</i> <i><br></i>  <i>/ help - help output</i> <br><br>  Well, we wrote a list of recommended commands.  Next, we can implement the commands we need. <br><br>  Since teams can take arguments, we use this opportunity.  For example, we will make our bot, Vasya's hello command, respond with the message: Hi Vasya. <br><br>  To do this, write the following code: <br><br><pre> <code class="php hljs">$bot-&gt;command(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($message)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($bot)</span></span></span><span class="hljs-function"> </span></span>{ $text = $message-&gt;getText(); $param = str_replace(<span class="hljs-string"><span class="hljs-string">'/hello '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, $text); $answer = <span class="hljs-string"><span class="hljs-string">' '</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($param)) { $answer = <span class="hljs-string"><span class="hljs-string">', '</span></span> . $param; } $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); });</code> </pre> <br>  Everything turns out very simple and fast. <br><br><h3>  List the bot commands </h3><br>  To enable the bot to issue online help <br><br><img src="https://habrastorage.org/webt/ss/mo/b8/ssmob8al3b7ll8aksdoustq1ti4.png"><br><br>  BotFather bot needs to report a list of commands. <br>  You can do this with his / setcommands command. <br><br><h3>  Bike </h3><br>  The above option is not very convenient, because I do not want to drive the text after the command, because if you use the tips from the bot, it is completely unrealistic. <br><br>  So you need to make sure that the bot remembers the command that you enter.  This can be done using any storage (MySQL, memcached, redis, tarantool, Postgres, etc) <br>  All you need is to remember the previous user input. <br><br>  To do this, before sending the message to the user, put it in your repository, and before accepting the message - check if there is data in the repository.  And if there is, then on the basis of these data to build further logic. <br><br>  It was at this stage that I again had a difficulty, since I did not find an opportunity in the library to receive a command before calling the command method.  Also, I didn‚Äôt like the fact that all the logic would be locked in one application controller. <br><br>  It was decided to write its own data handler, with the ability to move each command to a separate application controller. <br><br>  First, we describe the entry point to the controller. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $telegram = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Telegram(); <span class="hljs-comment"><span class="hljs-comment">//   $storage = new Storage(); //    $message = $telegram-&gt;getMessage(); //  ,    $command = $message-&gt;getCommand(); //  ,    (  ,    ) $text = $message-&gt;getParams($command); //   ,   ,             if (empty($command)) { $command = $storage-&gt;restoreCommand($message-&gt;getChat()-&gt;getId()); } //  ,    $storage-&gt;storeCommand( $message-&gt;getChat()-&gt;getId(), $command ); //       $this-&gt;chooseMethod($command, $message, $text); }</span></span></code> </pre> <br>  Now consider one of the methods. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getnewtext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message $telegram, $text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ,      if (empty($text)) { $answer = "      .       5  ."; $telegram-&gt;sendMessage($telegram-&gt;getChat()-&gt;getId(), $answer); } else { //   $tgNews = new TelegramNews(); $arData = $tgNews-&gt;getByWord($text, 'new'); if (empty($arData)) { $answer = '  '; } else { $answer = common_setViewGetContent('telegram/get', [ 'data' =&gt; $arData ]); } $telegram-&gt;sendMessage($telegram-&gt;getChat()-&gt;getId(), $answer); } }</span></span></code> </pre> <br>  So it all became more pleasant, more interactive and more convenient. <br><br><img src="https://habrastorage.org/webt/ox/7x/q1/ox7xq11_wyggboctz6qbw2rssbg.png"><br><br>  Thank you for reading the article to the end.  You can play with a live bot that works in a dialogue mode <a href="https://telegram.me/WebInNewsBot">here</a> . <br><br>  UPD: bot added the ability to give photos to some types of requests.  For example on <br>  / gettable - returns the resulting table of sports events <br>  / getevents - returns sport events </div><p>Source: <a href="https://habr.com/ru/post/347482/">https://habr.com/ru/post/347482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347472/index.html">Satisfaction JET or how we manage customer satisfaction</a></li>
<li><a href="../347474/index.html">Cost of games</a></li>
<li><a href="../347476/index.html">Video recordings of speeches from the lecture day on the gaming industry at VSBI</a></li>
<li><a href="../347478/index.html">How to make a website accessible to the blind and visually impaired?</a></li>
<li><a href="../347480/index.html">Object in a case or Optional in Java 8 and Java 9. Part 1: ‚ÄúHow to live without it?‚Äù</a></li>
<li><a href="../347488/index.html">Incident management in IT can be not only about IT</a></li>
<li><a href="../347490/index.html">Method of progressive Heisenbag</a></li>
<li><a href="../347492/index.html">How to bargain about wages in the United States. American Conversation Etiquette</a></li>
<li><a href="../347494/index.html">The first user with a million on stack overflow</a></li>
<li><a href="../347496/index.html">Translation from human to botsky</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>