<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ZoG on steroids</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When I wrote about the development of the game " Thud! ", I already complained about some redundancy of the description received. The simplicity of th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ZoG on steroids</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/3b0/c70/243/3b0c7024373782fd04ee4cba3d51693d.jpg">  When I <a href="http://habrahabr.ru/post/212237/">wrote</a> about the development of the game " <a href="">Thud!</a> ", I already complained about some redundancy of the description received.  The simplicity of the ZRF language has its downside - in order to write something more or less complicated on it, it is often necessary to duplicate significant code fragments.  Such redundancy, as is known, leads not only to an increase in the amount of manual work, but also significantly increases the risk of various errors appearing in the code (since the process of debugging ZoG applications is not trivial, this is an essential point). <br><br>  How can you deal with such redundancy? <br><br>  Of course, with the help of macros!  The problem is that the ZRF macros are not expressive enough for this.  Adrian King, in the process of developing <a href="http://www.zillions-of-games.com/cgi-bin/zilligames/submissions.cgi%3Fdo%3Dshow%3Bid%3D848">Scirocco</a> and <a href="http://www.zillions-of-games.com/cgi-bin/zilligames/submissions.cgi%3Fdo%3Dshow%3Bid%3D1669">Typhoon</a> games, came to a similar conclusion and developed his own, advanced macro language, working as an external <a href="http://www.zillions-of-games.com/cgi-bin/zilligames/submissions.cgi%3Fdo%3Dshow%3Bid%3D1663">preprocessor</a> .  Today, I will talk about the possibilities of this language and try, using the example of Thud !, to show its use in the development of ZRF applications. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  As I said above, this is an external preprocessor that converts the source files (with the extension .prezrf) into ordinary zrf files.  The preprocessor itself is developed in the Java language and is a jar file.  To process a prezrf file, just run the following command (provided that Java is installed on your computer): <br><br><pre><code class="bash hljs">java -jar prezrf.jar MyFile.prezrf</code> </pre> <br>  If processing passes without errors, the resulting zrf file will be generated in the same directory. <br><br>  What opportunities does the new language offer us?  First, it introduces a new type of macro.  To define the macro prezrf, the <b>define!</b> Keyword is used <b>.</b>  (to all new keywords, at the end, added an exclamation mark).  The original <b>define</b> ZRF macros are ignored by the preprocessor and are simply copied to the output.  The definition of new sample macros can be canceled with the <b>undefine</b> command <b>!</b>  .  This feature can be useful, since new macros can be defined locally, in other macros (ZRF doesn‚Äôt allow doing this). <br><br>  Keyword <b>expand!</b>  leads to the "deployment" of a previously defined macro in the place of the code indicated by it.  Since this action is performed very often, the abbreviation ' <b>!</b>  '.  Thus, processing the following code: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> swap ($<span class="hljs-number"><span class="hljs-number">2</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) ) (! swap ab)</code> </pre><br>  ... we get the output: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">ba</span></span>)</code> </pre><br>  This macro would have been expanded without an exclamation mark, using the (swap ab) command, but using <b>expand!</b>  saves us from possible typos.  For example, if we, for some reason, forgot to add an exclamation mark to <b>define</b> in the definition of swap, the construction (swap ab) would simply be duplicated in the output, and the macro call with the expansion <b>expand!</b>  , would lead to the formation of an error: <i><b>expand !: undefined macro "swap"</b></i> . <br><br>  All this, perhaps, would not be very interesting if it were not for the new features provided by prezrf.  In macros of the new type, we can use list arguments!  In addition, for our convenience, added the ability to reference several arguments passed to the macro, as in the list.  The construction of <b>$ 2 * 4</b> sequentially displays the values ‚Äã‚Äãof the 2nd, 3rd, and 4th arguments passed to the macro (provided that at least four arguments are passed).  Also, abbreviated constructions <b>$ n *</b> and <b>$ * m</b> with obvious semantics are defined.  Using this feature, we can, for example, count the number of arguments passed to the macro: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> count (<span class="hljs-name"><span class="hljs-name">length!</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>*)) ) (! count abc) ; =&gt; 3</code> </pre><br>  I draw your attention to the fact that the brackets around <b>$ 1 *</b> , in this example are mandatory - we form a list in which we list the values ‚Äã‚Äãof all the arguments of the macro, starting with the first one.  The absence of brackets will lead to a processing error, since <b>length!</b>  accepts only one list argument.  However, our macro is not sufficiently protected from input errors.  Calling <b>(count)</b> with no arguments will result in an error.  We can fix this as follows: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> count ($?<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">length!</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>*)) ) ($!1 0) )</code> </pre><br>  Here <b>$? 1</b> is executed if one or more arguments are passed to the macro, and <b>$! 1</b> otherwise.  In addition, it is possible to number elements from the end of the list using the <b>$ -n</b> construct.  All these features will be very useful to us in the future. <br><br>  Like any self-respecting programming language, prezrf provides us with conditional execution constructs ( <b>if-less!,</b> <b>If-less-or-equal!</b> ) And a loop ( <b>for!</b> ).  If-constructs (and there are several more of them in the language listed above), unlike the similar ZRF construct, do not define the <b>else</b> branch, but <b>for!</b>  can only be used to crawl list items.  For example, we can repeat the execution of some action for all directions defined in the game (this is required very often): <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> -all-directions (<span class="hljs-name"><span class="hljs-name">n</span></span> ne e se s sw w nw)) (<span class="hljs-name"><span class="hljs-name">define!</span></span> shift-all (<span class="hljs-name"><span class="hljs-name">for!</span></span> $d ($ -all-directions) (<span class="hljs-name"><span class="hljs-name">shift</span></span> $d) ) ) (! shift-all)</code> </pre><br>  In this code, the control construct ' <b>$</b> ' is used, which I have not yet had time to talk about.  What she does?  In fact, this is an abbreviation for a very often used construction: <br><br><pre> <code class="lisp hljs">(!! (! macro))</code> </pre><br>  <b>expand!</b>  here we already know, but that means' <b>!!</b>  '?  This command ( <b>expand-first!</b> ) Tells the preprocessor to use the value of the element, not the element itself in the parent construct ( <b>for!</b> In our example).  This point may not be very clear, but it is very important for understanding the language.  Here's what the output will look like if you use just <b>(! -All-directions)</b> : <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">shift</span></span> !) (<span class="hljs-name"><span class="hljs-name">shift</span></span> -all-directions)</code> </pre><br>  This is clearly not what we wanted.  Unfortunately <b>for!</b>  It works only with lists and cannot help us in optimizing the following outrage: <br><br><div class="spoiler">  <b class="spoiler_title">So Trolls go</b> <div class="spoiler_text"><pre> <code class="lisp hljs">( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-1 ( $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) ) ( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-2 ( <span class="hljs-name"><span class="hljs-name">mark</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) back $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) ) ( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-3 ( <span class="hljs-name"><span class="hljs-name">mark</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) back $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) ) ( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-4 ( <span class="hljs-name"><span class="hljs-name">mark</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) back $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) ) ( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-5 ( <span class="hljs-name"><span class="hljs-name">mark</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) back $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) ) ( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-6 ( <span class="hljs-name"><span class="hljs-name">mark</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) back $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) ) ( <span class="hljs-name"><span class="hljs-name">define</span></span> troll-7 ( <span class="hljs-name"><span class="hljs-name">mark</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) back $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se))) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? n) (<span class="hljs-name"><span class="hljs-name">capture</span></span> n)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? nw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> nw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? s) (<span class="hljs-name"><span class="hljs-name">capture</span></span> s)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? ne) (<span class="hljs-name"><span class="hljs-name">capture</span></span> ne)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? w) (<span class="hljs-name"><span class="hljs-name">capture</span></span> w)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? sw) (<span class="hljs-name"><span class="hljs-name">capture</span></span> sw)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? e) (<span class="hljs-name"><span class="hljs-name">capture</span></span> e)) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? se) (<span class="hljs-name"><span class="hljs-name">capture</span></span> se)) add ) )</code> </pre><br></div></div><br>  But where cycles pass, recursion will come to our rescue: <br><br><div class="spoiler">  <b class="spoiler_title">Recursion, as was said</b> <div class="spoiler_text"><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> repeat (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>* (! repeat (!! (sum! $1 -1)) $2*) ) ) (<span class="hljs-name"><span class="hljs-name">define!</span></span> troll-n (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">for!</span></span> $d ($ -all-directions) ( (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> mark (<span class="hljs-name"><span class="hljs-name">repeat</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">opposite</span></span> $d) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) ) back ) (<span class="hljs-name"><span class="hljs-name">repeat</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $d (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) ) (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">for!</span></span> $dd ($ -all-directions) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? $dd) ) ) ) ) (<span class="hljs-name"><span class="hljs-name">for!</span></span> $dd ($ -all-directions) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? $dd) (<span class="hljs-name"><span class="hljs-name">capture</span></span> $dd) ) ) add ) ) (! troll-n (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>))) ) ) ... (! troll-n <span class="hljs-number"><span class="hljs-number">7</span></span>)</code> </pre><br></div></div><br>  This is somewhat more difficult to understand than the original version, but no copy-paste.  Please pay special attention to the implementation of <b>repeat</b> .  This macro is very useful and will be used repeatedly in the future. <br><br><pre> <code class="lisp hljs">(! repeat <span class="hljs-number"><span class="hljs-number">3</span></span> abc) <span class="hljs-comment"><span class="hljs-comment">; =&gt; abcabcabc</span></span></code> </pre><br>  In the original implementation of Thud!  There is another place that I would like to optimize: <br><br><pre> <code class="lisp hljs">( <span class="hljs-name"><span class="hljs-name">define</span></span> check-rock ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> n ne e se s sw w nw) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> ne e se s sw w nw n) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> e se s sw w nw n ne) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> se s sw w nw n ne e) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> s sw w nw n ne e se) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> sw w nw n ne e se s) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> w nw n ne e se s sw) ( <span class="hljs-name"><span class="hljs-name">check-rock-direction</span></span> nw n ne e se s sw w) )</code> </pre><br>  Listing manually all cyclic permutations of a set of eight elements is easy to make mistakes.  First of all, let's define a macro, which allows us to ‚Äúcut out‚Äù a piece of the list: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> range (<span class="hljs-name"><span class="hljs-name">if-less-or-equal!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-name"><span class="hljs-name">nth!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">3</span></span>) (! range (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)) $<span class="hljs-number"><span class="hljs-number">2</span></span>*) ) ) (! range 3 4 (abcde)) ; =&gt; cd</code> </pre><br>  The function <b>(nth! N list)</b> , here, allows you to get the n-th element of the list.  Let's try to "turn" the list: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> rotate (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> (! rotate (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>)) ((<span class="hljs-name"><span class="hljs-name">splice!</span></span> ((! range <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>)) ((<span class="hljs-name"><span class="hljs-name">nth!</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>))))) ) ) (! rotate <span class="hljs-number"><span class="hljs-number">2</span></span> (<span class="hljs-name"><span class="hljs-name">abcdefgh</span></span>)) <span class="hljs-comment"><span class="hljs-comment">; =&gt; (abcdefgh) (bcdefgha)</span></span></code> </pre><br>  It seems to be normal, but already <b>(! Rotate 3 (abcdefgh))</b> gives an error: <br><br><div class="spoiler">  <b class="spoiler_title">Error message</b> <div class="spoiler_text">  Expanding [list "(nth! 2 ((splice! ((! Range 2 8 (abc" ... at the argument substitution in [list "(nth! $ 1 $ 3)" at t.prezrf, line 3] for [list "(range 2 8 ((splice! ((! Range 2 8 (ab "... at expand! Of [list" (! Range 2 8 ((splice! ((! Range 2 8 (a "... at the substitution in [list" ( ! range 2 8 $ 2) "at t.prezrf, line 11] for [list" (rotate 2 ((splice! ((! range 2 8 (ab "... at expand! of [list" (! rotate 2 ((splice ! ((! range 2 8 (a "... at argument substitution in [list" (! rotate (!!! (sum! $ 1 -1))) ((splice! ("... at t.prezrf, line 11] for [ list "(rotate 3 (abcdefgh))" at expand! of [list "(! rotate 3 (abcdefgh))" at t.prezrf, line 15]]]]]]]: <br>  In [list "(nth! 2 ((splice! ((! Range 2 8 (abc" ... at the argument substitution in [list "(nth! $ 1 $ 3)" at t.prezrf, line 3] for [list "(range 2 8 ((splice! ((! Range 2 8 (ab "... at expand! Of [list" (! Range 2 8 ((splice! ((! Range 2 8 (a "... at the substitution in [list" ( ! range 2 8 $ 2) "at t.prezrf, line 11] for [list" (rotate 2 ((splice! ((! range 2 8 (ab "... at expand! of [list" (! rotate 2 ((splice ! ((! range 2 8 (a "... at argument substitution in [list" (! rotate (!!! (sum! $ 1 -1))) ((splice! ("... at t.prezrf, line 11] for [ list "(rotate 3 (abcdefgh))" at expand! of [list "(! rotate 3 (abcdefgh))" at t.prezrf, line 15]]]]]]]: <br>  Trying to get item # 2 of list with 1 items <br></div></div><br>  As you can see, it is not as extensive as error messages when compiling C ++ templates, but not much clearer.  I have been fiddling with prezrf for quite a long time and brought out two rules of thumb for myself in terms of relatively painless work with him: <br><br><ol><li>  Do not pass mutable lists as arguments to recursive macros. </li><li>  Limit the use of <b>for!</b>  most simple cases </li></ol><br>  Any deviation from these rules, at times, threatens to blow my brain, in vain attempts to understand the essence of what happened.  Let's try to rephrase our <b>rotate</b> in the spirit of the first rule: <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> rotate (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> ((<span class="hljs-name"><span class="hljs-name">splice!</span></span> ((! range (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>)) (!! (<span class="hljs-name"><span class="hljs-name">length!</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>)) $<span class="hljs-number"><span class="hljs-number">2</span></span>)) ((! range <span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>)) )) (! rotate (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>)) $<span class="hljs-number"><span class="hljs-number">2</span></span>) ) (<span class="hljs-name"><span class="hljs-name">if-equal!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> ) )</code> </pre><br>  He began to look worse, but it works!  What should we do with him now?  Permutations we need for a reason, we must pass these arguments in the <b>check-rock-direction</b> .  Of course, it would be possible to make the appropriate changes to the <b>rotate</b> , causing a macro from it, but this would make the <b>rotate</b> not universal.  Apparently, the time has come to uncover the secret weapon of functional programming ‚Äî <a href="http://ru.wikipedia.org/wiki/%25D0%25A4%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D1%258F_%25D0%25B2%25D1%258B%25D1%2581%25D1%2588%25D0%25B5%25D0%25B3%25D0%25BE_%25D0%25BF%25D0%25BE%25D1%2580%25D1%258F%25D0%25B4%25D0%25BA%25D0%25B0">functions of a higher order</a> : <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> map ($!<span class="hljs-number"><span class="hljs-number">3</span></span> (! map $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> (!! (<span class="hljs-name"><span class="hljs-name">length!</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>))) ) ($?<span class="hljs-number"><span class="hljs-number">3</span></span> (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">3</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span> (!! (<span class="hljs-name"><span class="hljs-name">nth!</span></span> $<span class="hljs-number"><span class="hljs-number">3</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span>))) (! map $<span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>))) ) ) ) (<span class="hljs-name"><span class="hljs-name">define</span></span> check-rock (! map check-rock-direction (!! ((! rotate (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> (!! (<span class="hljs-name"><span class="hljs-name">length!</span></span> ($ -all-directions))))) ($ -all-directions) ))) ) )</code> </pre><br>  I had to tinker with this, but it was worth it.  The main place in all this code is here: <b>($ 1 ...)</b> .  It also works, which can not but rejoice.  Actually, it would be possible to stop on <a href="https://github.com/GlukKazan/ZoG/tree/25c2bc9b374312d1706c0525f2570ffb49d9faa6/Prezrf">this variant</a> , if not the size of the resulting ZRF-file.  Deploying all the macros from the 14-kilobyte source, the preprocessor receives at the output of more than a megabyte description file!  Whether it is worth saying that ZoG loads this ZRF-ku quite slowly. <br><br>  How to beat this trouble?  Yes, with the help of macros (we have nothing else): <br><br><div class="spoiler">  <b class="spoiler_title">Macros create macros</b> <div class="spoiler_text"><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">define!</span></span> troll-n (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">define</span></span> (<span class="hljs-name"><span class="hljs-name">concat!</span></span> troll - $<span class="hljs-number"><span class="hljs-number">1</span></span>) ( (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> mark (<span class="hljs-name"><span class="hljs-name">repeat</span></span> (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>)) (<span class="hljs-name"><span class="hljs-name">opposite</span></span> (<span class="hljs-name"><span class="hljs-name">concat!</span></span> $ <span class="hljs-number"><span class="hljs-number">1</span></span>)) (<span class="hljs-name"><span class="hljs-name">verify</span></span> friend?) ) back ) (<span class="hljs-name"><span class="hljs-name">repeat</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">concat!</span></span> $ <span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-name"><span class="hljs-name">verify</span></span> empty?) ) (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">verify</span></span> (<span class="hljs-name"><span class="hljs-name">or</span></span> (<span class="hljs-name"><span class="hljs-name">for!</span></span> $dd ($ -all-directions) (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? $dd) ) ) ) ) (<span class="hljs-name"><span class="hljs-name">for!</span></span> $dd ($ -all-directions) (<span class="hljs-name"><span class="hljs-name">if</span></span> (<span class="hljs-name"><span class="hljs-name">enemy</span></span>? $dd) (<span class="hljs-name"><span class="hljs-name">capture</span></span> $dd) ) ) add ) ) (! troll-n (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>))) ) ) (! troll-n <span class="hljs-number"><span class="hljs-number">7</span></span>) (<span class="hljs-name"><span class="hljs-name">define!</span></span> troll-all (<span class="hljs-name"><span class="hljs-name">if-less!</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> (<span class="hljs-name"><span class="hljs-name">for!</span></span> $d ($ -all-directions) ( (<span class="hljs-name"><span class="hljs-name">concat!</span></span> troll - $<span class="hljs-number"><span class="hljs-number">1</span></span>) $d ) ) (! troll-all (!! (<span class="hljs-name"><span class="hljs-name">sum!</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>))) ) )</code> </pre><br></div></div><br>  The construction <b>(! Troll-n 7)</b> sequentially creates definitions of the ZRF macros troll-1, troll-2, ... troll-7 (their order is not important for us), but <b>(! Troll-all)</b> , being called in the right place, will list their calls.  Here you should pay attention to the design <b>(concat! $ 1)</b> .  In such an intricate way, we form <b>$ 1</b> in the body of the ZRF macro.  If we just say <b>$ 1</b> , it‚Äôs not very good. <br><br>  <a href="https://github.com/GlukKazan/ZoG/tree/master/Prezrf">The result is</a> not slow to affect.  The size of the resulting ZRF file is reduced to 28 kilobytes.  It could have been made even less, but I didn‚Äôt see much sense in it.  It works in the same way as the original, which means that we did not make mistakes on our long journey. <br><br>  I want to note that the <a href="http://www.zillions-of-games.com/cgi-bin/zilligames/submissions.cgi%3Fdo%3Dshow%3Bid%3D1663">preprocessor</a> described by me <a href="http://www.zillions-of-games.com/cgi-bin/zilligames/submissions.cgi%3Fdo%3Dshow%3Bid%3D1663">is</a> completely free to use and cross-platform.  Every happy owner of installed Java can experiment with it.  Of course, the results of his labors will not be able to run in the demo version of ZoG, but we are not doing abnormal programming here? <br><br><div class="spoiler">  <b class="spoiler_title">Note</b> <div class="spoiler_text">  As an illustration of the article, the work of famous painter <a href="http://ru.wikipedia.org/wiki/%25D0%25AD%25D1%2588%25D0%25B5%25D1%2580,_%25D0%259C%25D0%25B0%25D1%2583%25D1%2580%25D0%25B8%25D1%2586_%25D0%259A%25D0%25BE%25D1%2580%25D0%25BD%25D0%25B5%25D0%25BB%25D0%25B8%25D1%2581">Maurice Escher was used</a> . <br></div></div><br></div><p>Source: <a href="https://habr.com/ru/post/214713/">https://habr.com/ru/post/214713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214703/index.html">New free courses of virtual academy Microsoft Virtual Academy, February 2014</a></li>
<li><a href="../214705/index.html">Intel 730 - SSD, overclocked to the limit</a></li>
<li><a href="../214707/index.html">Another do-it-yourself NAS, part 1: from what was</a></li>
<li><a href="../214709/index.html">Monitoring system via jabber</a></li>
<li><a href="../214711/index.html">Now in WebStorm there is a multi-persistence, it‚Äôs a multiple selection</a></li>
<li><a href="../214719/index.html">Evernote Windows Update: Accelerated Sync and Image Editing</a></li>
<li><a href="../214725/index.html">Scala Moscow User Group, meeting on March 14, 2014</a></li>
<li><a href="../214729/index.html">The Chinese lunar rover enters the third "moonlit night" with the same failure of the drive unit</a></li>
<li><a href="../214731/index.html">REG.RU rebranding: easier, more convenient, more efficient</a></li>
<li><a href="../214733/index.html">Detailed analysis of the Linux / Ebury backdoor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>