<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the integrity of the roulette game on the Ethereum smart contract</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Few have now heard about cryptocurrencies and, in particular, Bitcoin. In 2014, on the wave of interest in Bitcoin, a new cryptocurrency appeared - Et...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the integrity of the roulette game on the Ethereum smart contract</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d29/110/fbb/d29110fbb5884dc98cc1c8b4a1426072.png"><br><br>  Few have now heard about cryptocurrencies and, in particular, Bitcoin.  In 2014, on the wave of interest in Bitcoin, a new cryptocurrency appeared - Ethereum.  Today, in 2017, it <a href="https://coinmarketcap.com/">is the</a> second largest by capitalization after Bitcoin.  One of its most important differences from bitcoin is the use of a turing-complete virtual machine - EVM.  More information about the broadcast can be found in his <a href="https://ethereum.github.io/yellowpaper/paper.pdf">Yellow Paper</a> . <br><br>  Ethereum smart contracts are usually written in the <a href="https://solidity.readthedocs.io/">Solidity</a> language.  On Habr√© there were already articles about writing and testing smart contracts, for example <a href="https://habrahabr.ru/post/312008/">1</a> , <a href="https://habrahabr.ru/post/321362/">2</a> , <a href="https://habrahabr.ru/company/neobit/blog/324456/">3</a> .  And about the connection of a smart contract with the site, you can read, for example, <a href="https://blog.ethereum.org/2016/07/12/build-server-less-applications-mist/">an article about creating the simplest voting ballot on a smart contract</a> .  This article uses the browser built into the Mist wallet, but the same can be done using a Chrome plugin, such as <a href="https://metamask.io/">MetaMask</a> .  This is exactly how, through MetaMask, the game that we will explore works. <br><a name="habracut"></a><br>  The game is a realization of <a href="https://ru.wikipedia.org/wiki/%25D0%25A0%25D1%2583%25D0%25BB%25D0%25B5%25D1%2582%25D0%25BA%25D0%25B0">European roulette</a> : there are 37 cells in the field, numbered from 0 to 36. You can bet on a specific number or on a set of numbers: even / odd, red / black, 1-12, 1-18, etc.  In each round, you can make several bets by adding a token (costing 0.01 ETH ‚âà $ 0.5) to the corresponding field of the game table.  Each field corresponds to the odds.  For example, the rate of "red" corresponds to the coefficient 2 - that is, paying 0.01 ETH you, in case of winning, get 0.02 ETH.  And if you bet on zero, the coefficient will be 36: if you pay the same 0.01 ETH for the bet, you will receive 0.36 if you win. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Developers, however, use a different designation: 35: 1</b> <div class="spoiler_text">  In the contract code, the coefficient for this bet is also indicated as 35, and the amount of the bet is added to the amount won before payment.  It is possible that such a designation has been adopted in the game world, but it is more logical for me to immediately use 36. <br></div></div><br>  When all bets are made, the player presses the ‚ÄúPlay‚Äù button and, via MetaMask, sends a wager * to the Ethereum-blockchain, to the address of the smart contract of the game.  The contract determines the dropped out number, calculates the results of the bets and, if necessary, sends the winnings to the player. <br>  <sub>* - I will use the <i>wager</i> term to refer to a set of bets (i.e., a bet type pair - the number of bet tokens) that a player makes in one round.</sub>  <sub>If you know a more correct term, please write me, I will correct.</sub> <br><br>  In order to understand whether the game works honestly (that is, whether the casino does not manipulate the definition of the number dropped in its favor) let us analyze the operation of the smart contract. <br><br>  His address is listed on the site of the game.  In addition, before confirming payment, you can check to which address the wager will be sent.  I will analyze the contract at <a href="https://etherscan.io/address/0xDfC328c19C8De45ac0117f836646378c10e0CdA3">0xDfC328c19C8De45ac0117f836646378c10e0CdA3</a> .  Etherscan shows its code, and for easy viewing you can use the <a href="https://ethereum.github.io/browser-solidity/">Solidity Browser</a> . <br><br>  A contract starts with a call to the <i>placeBet ()</i> function: <br><br><div class="spoiler">  <b class="spoiler_title">Bed sheet code</b> <div class="spoiler_text"><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">placeBet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint256 bets, bytes32 values1,bytes32 values2</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> payable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ContractState == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"ContractDisabled"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gamblesLength = gambles.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gamblesLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { uint8 gamblesCountInCurrentBlock = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = gamblesLength - <span class="hljs-number"><span class="hljs-number">1</span></span>;i &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gambles[i].blockNumber == block.number) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gambles[i].player == msg.sender) { ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"Play twice the same block"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } gamblesCountInCurrentBlock++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gamblesCountInCurrentBlock &gt;= maxGamblesPerBlock) { ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"maxGamblesPerBlock"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _currentMaxBet = currentMaxBet; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &lt; _currentMaxBet/<span class="hljs-number"><span class="hljs-number">256</span></span> || bets == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"Wrong bet value"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> &gt; _currentMaxBet) { ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"Limit for table"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } GameInfo memory g = GameInfo(msg.sender, block.number, <span class="hljs-number"><span class="hljs-number">37</span></span>, bets, values1,values2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (totalBetValue(g) != msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) { ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"Wrong bet value"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } address affiliate = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint16 coef_affiliate = <span class="hljs-number"><span class="hljs-number">0</span></span>; uint16 coef_player; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address(smartAffiliateContract) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { (affiliate, coef_affiliate, coef_player) = smartAffiliateContract.getAffiliateInfo(msg.sender); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { coef_player = CoefPlayerEmission; } uint256 playerTokens; uint8 errorCodeEmission; (playerTokens, errorCodeEmission) = smartToken.emission(msg.sender, affiliate, msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, coef_player, coef_affiliate); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCodeEmission != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCodeEmission == <span class="hljs-number"><span class="hljs-number">1</span></span>) ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"token operations stopped"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCodeEmission == <span class="hljs-number"><span class="hljs-number">2</span></span>) ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"contract is not in a games list"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCodeEmission == <span class="hljs-number"><span class="hljs-number">3</span></span>) ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"incorect player address"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCodeEmission == <span class="hljs-number"><span class="hljs-number">4</span></span>) ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"incorect value bet"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (errorCodeEmission == <span class="hljs-number"><span class="hljs-number">5</span></span>) ErrorLog(msg.sender, <span class="hljs-string"><span class="hljs-string">"incorect Coefficient emissions"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.sender.send(msg.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) == <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } gambles.push(g); PlayerBet(gamblesLength, playerTokens); }</code> </pre> </div></div><br>  For newcomers to Solidity, I‚Äôll explain that the public and payable modifiers mean that the function is part of the contract API and that when you call it, you can send air.  At the same time information about the sender and the amount of the broadcast sent will be available through the variable msg. <br><br>  The call parameters are the bit mask of the bet types and two 32-byte arrays with the number of tokens for each of the types.  You can guess this by looking at the definition of the <i>GameInfo</i> type and the functions <i>getBetValueByGamble ()</i> , <i>getBetValue ()</i> . <br><br><div class="spoiler">  <b class="spoiler_title">Another code sheet, smaller</b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">struct</span></span> GameInfo { <span class="hljs-attribute"><span class="hljs-attribute">address</span></span> player; <span class="hljs-attribute"><span class="hljs-attribute">uint256</span></span> blockNumber; <span class="hljs-attribute"><span class="hljs-attribute">uint8</span></span> wheelResult; <span class="hljs-attribute"><span class="hljs-attribute">uint256</span></span> bets; <span class="hljs-attribute"><span class="hljs-attribute">bytes32</span></span> values; <span class="hljs-attribute"><span class="hljs-attribute">bytes32</span></span> values2; }</code> </pre><br><pre> <code class="hljs pgsql">// n - number player bet // nBit - betIndex <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getBetValueByGamble(GameInfo memory gamble, uint8 n, uint8 nBit) private <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (uint256) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getBetValue(gamble.<span class="hljs-keyword"><span class="hljs-keyword">values</span></span> , n, nBit); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt;= <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getBetValue(gamble.values2, n - <span class="hljs-number"><span class="hljs-number">32</span></span>, nBit); // there are <span class="hljs-number"><span class="hljs-number">64</span></span> maximum <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> bets (positions) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> one game throw; }</code> </pre><pre> <code class="hljs pgsql">// n form <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;= <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getBetValue(bytes32 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>, uint8 n, uint8 nBit) private <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (uint256) { // bet <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> credits (<span class="hljs-number"><span class="hljs-number">1.</span></span><span class="hljs-number"><span class="hljs-number">.256</span></span>) uint256 bet = uint256(<span class="hljs-keyword"><span class="hljs-keyword">values</span></span>[<span class="hljs-number"><span class="hljs-number">32</span></span> - n]) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bet &lt; uint256(minCreditsOnBet[nBit]+<span class="hljs-number"><span class="hljs-number">1</span></span>)) throw; //<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: bet &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bet &gt; uint256(<span class="hljs-number"><span class="hljs-number">256</span></span>-maxCreditsOnBet[nBit])) throw; //<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: bet &gt; <span class="hljs-number"><span class="hljs-number">256</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentMaxBet * bet / <span class="hljs-number"><span class="hljs-number">256</span></span>; }</code> </pre></div></div><br>  Note that getBetValue () returns the amount of the bet, not in tokens, but in wei. <br><br>  First of all, <i>placeBet ()</i> checks that the contract is not turned off and then the betting checks begin. <br>  The <i>gambles</i> array is the repository of all wagers played in this contract.  <i>placeBet ()</i> finds all the bets in its block and checks whether the player has sent another bet in this block and whether the allowed number of bets per block has been exceeded.  Then limits on the minimum and maximum amount of the bet are checked. <br><br>  In case of any error, the execution of the contract is interrupted by the throw command, which rolls back the transaction, returning the broadcast to the player. <br><br>  Further, the parameters passed to the function are stored in the <i>GameInfo</i> structure. Here it is important for us that the <i>wheelResult</i> field <i>is</i> initialized with the number 37. <br><br>  After another check that the amount of bets coincides with the amount of air sent, RLT tokens are distributed, the referral program is processed, the bet information is saved in <i>gambles</i> and the PlayerBet event is created with the number and the bet amount, which is then visible in the game's web part. <br><br><div class="spoiler">  <b class="spoiler_title">About tokens</b> <div class="spoiler_text">  At each bet, the player is given a certain amount of RLT, Ethereum-tokens, which determine the right of the owner of the tokens to receive dividends from the profits received by the authors of the game.  Read more about this - read <a href="https://smartplay.tech/white-paper">White Paper.</a> <br></div></div><br>  Further betting life begins with a call to the <i>ProcessGames ()</i> function, which, after the appearance of a new bid, is executed, at present, from the address <a href="https://etherscan.io/address/0xa92d36dc1ca4f505f1886503a0626c4aa8106497">0xa92d36dc1ca4f505f1886503a0626c4aa8106497</a> .  Such calls are well visible when viewing the <a href="https://etherscan.io/address/0xDfC328c19C8De45ac0117f836646378c10e0CdA3">list of transactions of the contract of the game</a> : they have Value = 0. <br><div class="spoiler">  <b class="spoiler_title">ProcessGames code</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessGames</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">uint256[] gameIndexes, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> simulate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!simulate) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastBlockGamesProcessed == block.number) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; lastBlockGamesProcessed = block.number; } uint8 delay = BlockDelay; uint256 length = gameIndexes.length; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> success = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(uint256 i = <span class="hljs-number"><span class="hljs-number">0</span></span>;i &lt; length;i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ProcessGame(gameIndexes[i], delay) == GameStatus.Success) success = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (simulate &amp;&amp; !success) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; }</code> </pre></div></div>  In the call parameters, an array is transmitted with betting numbers that need to be calculated, and <i>ProcessGame</i> is called for each. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> ProcessGame(uint256 <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>, uint256 delay) private <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (GameStatus) { GameInfo memory g = gambles[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (block.number - g.blockNumber &gt;= <span class="hljs-number"><span class="hljs-number">256</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GameStatus.Stop; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (g.wheelResult == <span class="hljs-number"><span class="hljs-number">37</span></span> &amp;&amp; block.number &gt; g.blockNumber + delay) { gambles[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>].wheelResult = getRandomNumber(g.player, g.blockNumber); uint256 playerWinnings = getGameResult(gambles[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (playerWinnings &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (g.player.send(playerWinnings) == <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) throw; } EndGame(g.player, gambles[<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>].wheelResult, <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GameStatus.Success; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GameStatus.Skipped; }</code> </pre><br>  The call parameters are the number of the bet and the number of blocks that must pass between the bet and its processing.  When calling from <i>ProcessGames ()</i> or <i>ProcessGameExt (),</i> this parameter is currently equal to 1, you can find out this value from the result of the <i>getSettings ()</i> call. <br><br>  If the block number in which processing takes place is more than 255 blocks away from the bet block, it cannot be processed: the <a href="http://solidity.readthedocs.io/en/develop/units-and-global-variables.html">block hash is available only for the last 256 blocks</a> , and it is needed to determine the dropped out number. <br><br>  Next, it checks whether the result of the game has already been calculated (remember, wheelResult was initialized by the number 37, which cannot fall?) And the required number of blocks have passed. <br><br>  If the conditions are met, <i>getRandomNumber () is</i> called to determine the number that has fallen out, and the getGameResult () call calculates the win.  If it is not null, the broadcast is sent to the player: <i>g.player.send (playerWinnings)</i> .  Then an EndGame event is created that can be read from the game's web part. <br><br>  Let's look at the most interesting, how the fallen out number is determined: the getRandomNumber () function. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getRandomNumber(address player, uint256 playerblock) private <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span>(uint8 wheelResult) { // block.blockhash - hash <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the given block - <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> works <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> most recent blocks excluding <span class="hljs-keyword"><span class="hljs-keyword">current</span></span> bytes32 blockHash = block.blockhash(playerblock+BlockDelay); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (blockHash==<span class="hljs-number"><span class="hljs-number">0</span></span>) { ErrorLog(msg.sender, "Cannot generate random number"); wheelResult = <span class="hljs-number"><span class="hljs-number">200</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { bytes32 shaPlayer = sha3(player, blockHash); wheelResult = uint8(uint256(shaPlayer)%<span class="hljs-number"><span class="hljs-number">37</span></span>); } }</code> </pre><br>  Her arguments are the address of the player and the block number in which the bet was made.  First of all, the function receives a hash of the block, which is separated from the block of the bet on BlockDelay blocks into the future. <br><br>  This is an important point, because if a player can somehow find out the hash of this block in advance, he can form a bet that is guaranteed to win.  If we recall that there are Uncle-blocks in Ethereum, there may be a problem and further analysis is required. <br><br>  Next, the SHA-3 is calculated from the gluing of the player‚Äôs address and the resulting block hash.  The number dropped out is calculated by taking the remainder of dividing the result of SHA-3 by 37. <br><br>  <b>From my point of view, the algorithm is quite honest and the casino has no advantage over the player.</b> <br><div class="spoiler">  <b class="spoiler_title">Why do casinos bring owners profit?</b> <div class="spoiler_text">  On the field of 37 cells.  Suppose I want to make 100,000 bets, one token for one specific field. <br>  Probably about 2703 times I win, and all the other times I lose.  In this case, for winnings from the casino, I will receive 2703 * 36 = 97 308 tokens.  And 2692 tokens spent by me on bets will remain at the casino. <br>  Similar calculations can be made for all other types of bets. <br></div></div><br><br>  It is also interesting to see how the win is calculated.  As we have seen, this is what the <i>getGameResult ()</i> function <i>does</i> . <br><br><pre> <code class="hljs matlab"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGameResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GameInfo memory game)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">constant</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint256 totalWin)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalWin</span></span></span><span class="hljs-function"> = 0; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint8</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nPlayerBetNo</span></span></span><span class="hljs-function"> = 0; // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">we</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sent</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">count</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bets</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">at</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">last</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">byte</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint8</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">betsCount</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint8</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bytes32(game.bets)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[0]</span></span></span><span class="hljs-function">); </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint8 i=0; i&lt;maxTypeBets; i++)</span></span></span><span class="hljs-function"> { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(isBitSet(game.bets, i)</span></span></span><span class="hljs-function">) { </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">var</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">winMul</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">winMatrix</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCoeff</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(getIndex(i, game.wheelResult)</span></span></span><span class="hljs-function">); // </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">win</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">coef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(winMul &gt; 0)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">winMul</span></span></span><span class="hljs-function">++; // + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">player</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bet</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">totalWin</span></span></span><span class="hljs-function"> += </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">winMul</span></span></span><span class="hljs-function"> * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBetValueByGamble</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(game, nPlayerBetNo+1,i)</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nPlayerBetNo</span></span></span><span class="hljs-function">++; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(betsCount == 1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">break</span></span></span><span class="hljs-function">; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">betsCount</span></span></span><span class="hljs-function">--; } } }</span></span></code> </pre><br>  The parameter here is the <i>GameInfo</i> structure with data about the bet being calculated.  And its wheelResult field is already filled in with the number drawn. <br><br>  We see a cycle for all types of bets, in which the bit mask of game.bets is checked and if the bit of the type being checked is set, then <i>winMatrix.getCoeff () is</i> requested.  <i>winMatrix</i> is a contract at <a href="https://etherscan.io/address/0x073D6621E9150bFf9d1D450caAd3c790b6F071F2">0x073D6621E9150bFf9d1D450caAd3c790b6F071F2</a> , loaded in the <i>SmartRoulettee ()</i> constructor. <br><br>  As a parameter of this function, a combination of the type of the bet and the number drawn is passed: <br><br><pre> <code class="hljs pgsql">// <span class="hljs-keyword"><span class="hljs-keyword">unique</span></span> combination <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> bet <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> wheelResult, used <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">access</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> WinMatrix <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getIndex(uint16 bet, uint16 wheelResult) private <span class="hljs-keyword"><span class="hljs-keyword">constant</span></span> <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (uint16) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (bet+<span class="hljs-number"><span class="hljs-number">1</span></span>)*<span class="hljs-number"><span class="hljs-number">256</span></span> + (wheelResult+<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  I will leave you the analysis of the <i>WinMatrix</i> contract code as homework, but there is nothing unexpected there: a matrix of coefficients is generated and the required one is returned when you call <i>getCoeff ()</i> .  If desired, it is easy to check it manually <a href="https://etherscan.io/address/0x073D6621E9150bFf9d1D450caAd3c790b6F071F2">by</a> calling this function <a href="https://etherscan.io/address/0x073D6621E9150bFf9d1D450caAd3c790b6F071F2">on the contract page</a> . </div><p>Source: <a href="https://habr.com/ru/post/325988/">https://habr.com/ru/post/325988/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325976/index.html">How an IaaS provider can make payment for services more convenient: 2 simple rules</a></li>
<li><a href="../325978/index.html">WebRTC, Safari</a></li>
<li><a href="../325980/index.html">Using IMS QTI in ePUB e-learning courses</a></li>
<li><a href="../325982/index.html">Photo-realistic graphics in a mobile game or the world's first "video" game (mobile)</a></li>
<li><a href="../325986/index.html">EGaaS Digital Ecosystem</a></li>
<li><a href="../325990/index.html">Character Design 2B for Nier: Automata</a></li>
<li><a href="../325992/index.html">VAT and freelancers working with Upwork</a></li>
<li><a href="../325994/index.html">6 fresh examples of parsing and design improvements in simple ways</a></li>
<li><a href="../325996/index.html">e-Government of the future</a></li>
<li><a href="../325998/index.html">Parse the qualified X.509 certificates in the search for TIN, SNILS and OGRN</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>