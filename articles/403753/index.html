<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Connect gamepad from PS1 / PS2 to Raspberry pi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="May holidays in the yard. So time to eat kebabs and use a variety of draft and bottled beverages. And I do all nonsense. The idea of ‚Äã‚Äãthis project ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Connect gamepad from PS1 / PS2 to Raspberry pi</h1><div class="post__text post__text-html js-mediator-article">  May holidays in the yard.  So time to eat kebabs and use a variety of draft and bottled beverages.  And I do all nonsense.  The idea of ‚Äã‚Äãthis project came, even before the new year.  But for a long time I could not implement it.  Having bought the first gamepad (which I threw out afterwards), and having tried to interrogate it, I realized that there is no longer enough to do by simply reading the manuals, although there is enough information.  Fortunately, on this February 23, I received as a gift not shaving foam, packed in socks, but 600 p.  With the wish not to deny yourself anything on Aliexpress.  Where the Chinese copy of the Saleae Logic logic analyzer was purchased.  Those who are interested in what came out of it can click on the button below.  And those who are too lazy to read can immediately see the result <a href="https://youtu.be/dnxAFUJQdhY">here</a> . <br><br><img src="https://habrastorage.org/web/079/966/3bb/0799663bb6154ee49ee69e0583654ac3.jpg"><br><a name="habracut"></a><br>  Having screwed the logic analyzer to a plain construction, I saw that a candid slag was being sent to the gamepad. <br><br>  Minute theory. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The fact is that the console with the gamepad communicate on the SPI interface.  And there are regulated modes of operation of this interface.  In this case, there should be MODE 3, transmission of the low-order bit forward, and the logic level on the Chip enable line or Select slave when accessing the ‚Äú0‚Äù gamepad.  The frequency on the line is clk 250 kHz.  But I did 100 kHz, and it works fine.  Everything in principle is clearly described <a href="http://blog.nearfuturelaboratory.com/2008/06/19/playstation2-logic-analysis/">here</a> .  A system of commands gamepad, and decoding the answers <a href="http://store.curiousinventor.com/guides/PS2/">here</a> .  Also on the portal "Radiokot", there is a publication, but there are errors in the teams.  Simply put, to poll a standard gamepad, you need to give it a command: <br><br><pre><code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">0x1</span></span> <span class="hljs-number"><span class="hljs-number">0x42</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span> <span class="hljs-number"><span class="hljs-number">0x0</span></span>   , -  <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0x41</span></span> <span class="hljs-number"><span class="hljs-number">0x5a</span></span> <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0xff</span></span></code> </pre> <br>  Where 0x41 is the type of gamepad, and the last 2 bytes is the state of the buttons.  With analog, everything is the same, only you need to add 4 more bytes to the package. <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">0x1</span></span>, <span class="hljs-number"><span class="hljs-number">0x42</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>   , -  <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0x73</span></span> <span class="hljs-number"><span class="hljs-number">0x5a</span></span> <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span> <span class="hljs-number"><span class="hljs-number">0x80</span></span></code> </pre><br>  Here 0x73 this means that the gamepad is analog, the last 4 bytes are the state of the analogs. <br><br>  It is important that the gamepad works from 3.3 V., which allows it to be powered directly from the Raspberry pi.  In the standard mode (only the buttons work), the consumption is about 2 mA, in the analog mode 12 mA.  And then these 10 mA adds a LED on the gamepad.  And on the line 3.3 In the Raspberry pi you can put the load up to 50 mA. <br><br>  Actually, to connect the gamepad, you will need any 4 GPIO ports and power.  Only 6 wires. <br><br>  So here.  I realized that the libraries for working with GPIO, that bcm2835, that wiringPi, work very poorly with SPI.  In principle, they do not know how to send parcels with the least significant bit forward.  In the docks of one of them, this is honestly described, but somewhere very deep.  And the regimes they really do not know how to comply. <br><br>  But nothing prevents to reproduce the parcel itself, and read the data from the gamepad.  No sooner said than done.  Take the library wiringPi and write: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;wiringPi.h&gt; #define mosi 12 #define miso 13 #define clk 14 #define ce 5 unsigned char i, b; unsigned char cmd[9] = {0x1, 0x42, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}; int main() { wiringPiSetup () ; //  pinMode (mosi, OUTPUT); pinMode (clk, OUTPUT); pinMode (ce, OUTPUT); pinMode (miso, INPUT); digitalWrite (clk, HIGH); digitalWrite (mosi, LOW); digitalWrite (ce, HIGH); while(1) { unsigned char data[9] = {0}; digitalWrite (ce, LOW); delayMicroseconds(20); for (i = 0; i &lt; 9; i++) { for (b = 0; b &lt; 8; b++) { if (((cmd[i] &gt;&gt; b)&amp;1) == 1) { digitalWrite (mosi, HIGH); digitalWrite (clk, LOW); delayMicroseconds(5); digitalWrite (clk, HIGH); data[i] ^= digitalRead(miso) &lt;&lt; b; delayMicroseconds(5); digitalWrite (mosi, LOW); } else { digitalWrite (clk, LOW); delayMicroseconds(5); digitalWrite (clk, HIGH); data[i] ^= digitalRead(miso) &lt;&lt; b; delayMicroseconds(5); } } delayMicroseconds(40); } digitalWrite (ce, HIGH); printf("%x %x %x %x %x %x\n", data[3], data[4], data[5], data[6], data[7], data[8]); delayMicroseconds(100); } }</span></span></span></span></code> </pre><br>  Everything is classic, we declare GPIO ports, variables and an array of commands.  Next, the port operation modes are configured, and the clk, mosi and ce (chip enable) lines are reset to the initial state.  Then 2 cycles are formed.  In the first, the command bytes are scrolled, and in the second, the bytes themselves are scored bit-wise, in order to apply a logical one or zero to the mosi line, depending on the value of the bit.  And at the same time read the answer.  When I saw in return the cherished: <br><br><pre> <code class="cpp hljs"><span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0x41</span></span> <span class="hljs-number"><span class="hljs-number">0x5a</span></span> <span class="hljs-number"><span class="hljs-number">0xff</span></span> <span class="hljs-number"><span class="hljs-number">0xff</span></span></code> </pre><br>  I almost jumped to the ceiling.  Here is an example of the output of the program, in this case, I was playing with the left analog. <br><br><pre> <code class="cpp hljs">ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">80</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">80</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">80</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">80</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">80</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">80</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">40</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">4b</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">4b</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">4b</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">4b</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">4b</span></span> ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">1</span></span>a ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">1</span></span>a ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">1</span></span>a ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">1</span></span>a ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">1</span></span>a ff ff <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> ff <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Well, then had to integrate this code into the emulator.  In this case, the issue with the choice of the emulator was not.  Uniquely <a href="https://github.com/notaz/pcsx_rearmed">pcsx_rearmed</a> .  Just as in the previous time, it was necessary to find a function that is one of the first to be launched in order to initialize the library into it.  This function turned out to be psxInit, it is located in the r3000a.c file, which emulates the operation of the central processor.  This file also added a library header file and announced GPIO ports.  In the psxInit function, I initialize the library and set the initial levels on the GPIO ports.  Below are the first lines of this file with the changes. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r3000a.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cdrom.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"mdec.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"gte.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;wiringPi.h&gt; #define mosi 12 #define miso 13 #define clk 14 #define ce 5 R3000Acpu *psxCpu = NULL; psxRegisters psxRegs; int psxInit() { SysPrintf(_("Running PCSX Version %s (%s).\n"), PACKAGE_VERSION, __DATE__); wiringPiSetup () ; //  pinMode (mosi, OUTPUT); pinMode (clk, OUTPUT); pinMode (ce, OUTPUT); pinMode (miso, INPUT); digitalWrite (clk, HIGH); digitalWrite (mosi, LOW); digitalWrite (ce, HIGH); #ifdef PSXREC if (Config.Cpu == CPU_INTERPRETER) { psxCpu = &amp;psxInt; } else psxCpu = &amp;psxRec; #else psxCpu = &amp;psxInt; #endif Log = 0; if (psxMemInit() == -1) return -1; return psxCpu-&gt;Init(); }</span></span></span></span></code> </pre><br>  Next, it was necessary to figure out how the emulator imitates the work of the gamepad.  There is a header file psemu_plugin_defs.h, it is located in the include directory, here it has a structure that defines the variables in which it is stored - the type of gamepad - standard, analog, the state of the buttons, the variable states of analogs, and the vibration control variables. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">// controler type - fill it withe predefined values above unsigned char controllerType; // status of buttons - every controller fills this field unsigned short buttonStatus; // for analog pad fill those next 4 bytes // values are analog in range 0-255 where 127 is center position unsigned char rightJoyX, rightJoyY, leftJoyX, leftJoyY; // for mouse fill those next 2 bytes // values are in range -128 - 127 unsigned char moveX, moveY; unsigned char Vib[2]; unsigned char VibF[2]; unsigned char reserved[87]; } PadDataS;</span></span></code> </pre><br>  So, the main task is to write the data in these variables.  This emulator has plugins.  Including the gamepad plugin, in the plugins directory there is a dfinput subdirectory in which the pad.c file is located, in which the state of the gamepad is read, as well as its settings.  This is where the code from the test program was transferred.  Also, the ports, and the library header file are declared.  Also in it there are variables that store the code of the commands sent to the gamepad.  These variables are used in the functions for accessing the gamepad.  Below is this piece of code: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; #include "../include/psemu_plugin_defs.h" #include "main.h" #include &lt;wiringPi.h&gt; #define mosi 12 #define miso 13 #define clk 14 #define ce 5 unsigned char a, b; unsigned char cmd[9] = {0x1, 0x42, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0}; enum { ANALOG_LEFT = 0, ANALOG_RIGHT, ANALOG_TOTAL }; enum { CMD_READ_DATA_AND_VIBRATE = 0x42, CMD_CONFIG_MODE = 0x43, CMD_SET_MODE_AND_LOCK = 0x44, CMD_QUERY_MODEL_AND_MODE = 0x45, CMD_QUERY_ACT = 0x46, // ?? CMD_QUERY_COMB = 0x47, // ?? CMD_QUERY_MODE = 0x4C, // QUERY_MODE ?? CMD_VIBRATION_TOGGLE = 0x4D, };</span></span></span></span></code> </pre><br>  We are interested in the very first one, which has a value of 42. That‚Äôs when calling this variable the code will be executed.  Especially because in the original file it is empty.  And in the brute force function do_cmd, I inserted the main code: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint8_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_cmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ PadDataS *pad = &amp;padstate[CurPad].pad; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pad_num = CurPad; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> data[<span class="hljs-number"><span class="hljs-number">9</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; CmdLen = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (CurCmd) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_SET_MODE_AND_LOCK: buf = stdmode[pad_num]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_QUERY_MODEL_AND_MODE: buf = stdmodel[pad_num]; buf[<span class="hljs-number"><span class="hljs-number">4</span></span>] = padstate[pad_num].PadMode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_QUERY_ACT: buf = unk46[pad_num]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_QUERY_COMB: buf = unk47[pad_num]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_QUERY_MODE: buf = unk4c[pad_num]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_VIBRATION_TOGGLE: buf = unk4d[pad_num]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CMD_CONFIG_MODE: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (padstate[pad_num].ConfigMode) { buf = stdcfg[pad_num]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0xF3</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// else FALLTHROUGH case CMD_READ_DATA_AND_VIBRATE: digitalWrite (ce, LOW); delayMicroseconds(20); for (a = 0; a &lt; 9; a++) { for (b = 0; b &lt; 8; b++) { if (((cmd[a] &gt;&gt; b)&amp;1) == 1) { digitalWrite (mosi, HIGH); digitalWrite (clk, LOW); delayMicroseconds(5); digitalWrite (clk, HIGH); data[a] ^= digitalRead(miso) &lt;&lt; b; delayMicroseconds(5); digitalWrite (mosi, LOW); } else { digitalWrite (clk, LOW); delayMicroseconds(5); digitalWrite (clk, HIGH); data[a] ^= digitalRead(miso) &lt;&lt; b; delayMicroseconds(5); } } delayMicroseconds(40); } digitalWrite (ce, HIGH); pad-&gt;buttonStatus = data[4]; pad-&gt;buttonStatus = pad-&gt;buttonStatus &lt;&lt; 8; pad-&gt;buttonStatus |= data[3]; pad-&gt;rightJoyX = data[5]; pad-&gt;rightJoyY = data[6]; pad-&gt;leftJoyX = data[7]; pad-&gt;leftJoyY = data[8]; default: buf = stdpar[pad_num]; buf[2] = pad-&gt;buttonStatus; buf[3] = pad-&gt;buttonStatus &gt;&gt; 8; if (padstate[pad_num].PadMode == 1) { buf[4] = pad-&gt;rightJoyX; buf[5] = pad-&gt;rightJoyY; buf[6] = pad-&gt;leftJoyX; buf[7] = pad-&gt;leftJoyY; } else { CmdLen = 4; } return padstate[pad_num].PadID; } }</span></span></code> </pre><br>  Then, when the current command is reading, the gamepad is polled and data is written to variables, and then the emulator itself takes it. <br><br>  Well and everything, it was necessary only to compile the project.  In order for the compiler to pick up the wirigPi library, you need to insert a link to it in the project's Makefile.  It is enough to do at the beginning. <br><br><pre> <code class="cpp hljs"># Makefile <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> PCSX ReARMed <span class="hljs-meta"><span class="hljs-meta"># default stuff goes here, so that config can override TARGET ?= pcsx CFLAGS += -Wall -ggdb -Ifrontend -ffast-math -I/usr/</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> -I/usr/</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta">/SDL LDLIBS += -lpthread -lSDL -lpng -lwiringPi </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> DEBUG CFLAGS += -DNDEBUG -g </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> CXXFLAGS += $(CFLAGS) #DRC_DBG = 1 #PCNT = 1</span></span></code> </pre><br>  And important.  In order to use an analog gamepad, the emulator in the settings you must specify that it is used. <br><br>  I do not have so many games for PS1, I checked 7 pieces somewhere. It did not work on Tomb Raider2 and Nuclear strike, but this is probably because these games do not know what an analog gamepad is.  Probably you need to choose a standard in the settings and try. <br><br>  PS The emulator itself is best collected with optimization flags.  This is well described <a href="https://www.raspberrypi.org/forums/viewtopic.php%3Ff%3D35%26t%3D13349">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/403753/">https://habr.com/ru/post/403753/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../403743/index.html">Google AIY: Maker Kit for Voice-activated Gadgets</a></li>
<li><a href="../403745/index.html">Competition for replacing the RD ‚Äì 180: passions</a></li>
<li><a href="../403747/index.html">Amazon's digital assistant Alexa was turned into an assistant in a science lab.</a></li>
<li><a href="../403749/index.html">Tax preparation in 1950: IBM 403 "programming" with a plug-in panel</a></li>
<li><a href="../403751/index.html">Life in the ocean of air. What happens at 326 meters above Petersburg</a></li>
<li><a href="../403755/index.html">Paper computer</a></li>
<li><a href="../403757/index.html">Magical gestures as a challenge for an electronic engineer</a></li>
<li><a href="../403759/index.html">Chinese scientists have taught the neural network to understand what a person sees through scans of brain activity</a></li>
<li><a href="../403761/index.html">Bitcoin: let's go back to the beginning?</a></li>
<li><a href="../403763/index.html">Plotting with two independent axes in Matlab</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>