<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CRIU - an ambitious new project to preserve and restore the state of processes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CRIU (application Checkpoint / Restore In Userspace) is an ambitious, fast-paced project that allows you to save the program state as a control point,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CRIU - an ambitious new project to preserve and restore the state of processes</h1><div class="post__text post__text-html js-mediator-article">  CRIU (application Checkpoint / Restore In Userspace) is an ambitious, fast-paced project that allows you to save the program state as a control point, and subsequently restart the application from this point. <br>  The possibilities of using software for creating control points are quite varied.  For example, OpenVZ uses a similar mechanism for live migration.  Parallels Virtuozzo uses a similar mechanism to quickly resume containers after a kernel upgrade.  CRIU is already used in high-performance clusters to save intermediate results of computational processes used to resume application operation in the event of a failure. <br>  <b>This article describes how CRIU saves and restores the state of the program, and why this project can be more successful than its predecessors.</b> <br><a name="habracut"></a><br><br><h1>  A bit of history </h1><br>  CRIU is not the first attempt to implement a mechanism for saving and restoring programs in Linux.  There are at least two working C / R implementations: OpenVZ and the linux-cr project, led by Oren Laadan. <br>  The problem with both projects is that they implement the entire C / R almost completely in kernel space.  However, these projects did not become part of the main Linux kernel due to the large size and complex code. <br>  The leader of the OpenVZ development team, Pavel Emelyanov, proposed to change the approach to C / R itself and to transfer the main work to user space.  The community accepted this idea well and the CRIU project appeared. <br><br><h1>  Saving Application State </h1><br>  An application can consist of both one and many running processes.  CRIU supports both types. <br>  For information about the state of the process, the first thing that comes to mind is the use of the mechanism that the debugger uses (ptrace).  But he does not provide all the information.  Part of the process state can be gleaned from the procfs file system and the prctl system call, but this is not enough. <br>  To obtain the missing information in the CRIU project, the mechanism for implementing the executable code into the process (the so-called parasitic code) was used, which was developed and kindly provided by Tejun Heo, one of the main developers of the Linux kernel today. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Restore application state </h1><br>  To restore an application from a checkpoint, you must first create a tree of its processes.  To do this, a separate mechanism was developed in the Linux kernel for creating processes with specified identifiers.  After the start, each process recovers its memory, open files, sockets, pipes, IPC, etc. <br>  However, in fact, everything is not so simple, because resources may be common to several processes. <br>  Regions of the address space of a process can be unique (MAP_PRIVATE) or accessible simultaneously by several processes (MAP_SHARED).  The first type is restored quite simply (if you do not think about the technology ‚Äúcopy on write‚Äù - it remains outside the brackets of this article). <br>  What is the problem in the second version?  If we have the region of the address space mapped to a file, then everything is fine - to restore such a piece of address space, you can use standard Linux mechanisms. <br>  But what to do if the region is anonymous (MAP_ANONYMOUS), i.e.  displayed in RAM?  To support the recovery of such a region, we had to flatten the kernel again with a file, namely, to map each in the procfs file system ‚Äî the kernel creates a file in / proc / self / map_files / &lt;start_addr&gt; - &lt;end_addr&gt; for each distributed memory region.  Thanks to these files, anonymous regions of distributed memory can be recovered as file. <br>  The next problem on the queue was open files.  They can also be shared by several processes.  Here the ability to transfer file descriptors via Unix sockets came in handy.  One of the user processes opens the file and forwards it to the others. <br>  So, the memory is restored, the files are open.  How is process control transferred?  The transfer of control is based on the sigreturn () system call: when a signal arrives, the kernel saves the state of the process and transfers control to the signal handler, which at the end calls sigreturn ().  Thus, in order to start the process from the desired point, it is enough to restore the state of the process in the required format and call sigreturn (). <br>  And the process is restored and continues to work. <br><br><h1>  Interesting </h1><br>  CRIU can save and restore TCP connections.  It can be used for live migration.  The user will notice only a slight delay in network activity when the application is moved with all its connections to another server. <br>  CRIU saves process data to disk using Google's Protocol Buffers format.  Software libraries for working with this protocol exist for most popular languages. <br>  During development, all CRIU capabilities are constantly monitored by an embedded test system.  To do this, use the revised and improved framework, borrowed from projects to develop OpenVZ and Virtuozzo. <br>  CRIU is being developed by Parallels as part of a project to port OpenVZ code to the main Linux kernel. <br><br><h1>  Goals </h1><br>  The main goal of the project for the near future is to learn how to save and restore the state of Linux Containers (LXC).  To do this, save and restore terminals, received but not yet processed signals, network environment namespaces (network namespace) and file hierarchy (mount namespace; under development). <br><br><h1>  Links </h1><br>  <a href="http://ru.wikipedia.org/wiki/CRIU">ru.wikipedia.org/wiki/CRIU</a> <br>  <a href="https://ckpt.wiki.kernel.org/index.php/Main_Page">ckpt.wiki.kernel.org/index.php/Main_Page</a> <br>  <a href="http://wiki.openvz.org/Checkpointing_and_live_migration">wiki.openvz.org/Checkpointing_and_live_migration</a> <br>  <a href="http://www.parallels.com/">www.parallels.com</a> <br>  <a href="http://code.google.com/p/protobuf/">code.google.com/p/protobuf</a> <br></div><p>Source: <a href="https://habr.com/ru/post/148413/">https://habr.com/ru/post/148413/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148406/index.html">New standoff between WHATWG and W3C: in whose hands is the future of HTML5?</a></li>
<li><a href="../148407/index.html">PyBrain work with neural networks in Python</a></li>
<li><a href="../148409/index.html">OS X, Dual Stack and VK API problem</a></li>
<li><a href="../148410/index.html">How to create a simple tower defense game on Unity3D, part one</a></li>
<li><a href="../148411/index.html">System approach to requirements management</a></li>
<li><a href="../148415/index.html">IOS Application Testing Systems</a></li>
<li><a href="../148416/index.html">JScriptInclude Gear v 0.1.0 is a mechanism for cascading import of scripts / libraries. (Revenge)</a></li>
<li><a href="../148417/index.html">Google Earth Engine - a platform for monitoring the state of the Earth</a></li>
<li><a href="../148420/index.html">Mirrorless revolution</a></li>
<li><a href="../148421/index.html">Scientists have created artificial jellyfish</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>