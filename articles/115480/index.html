<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>TransactionScope - tempting, but treacherous</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, ADO.NET 2.0 was released, and along with it was the System.Transactions assembly, which contains the TransactionScope class - a guide...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>TransactionScope - tempting, but treacherous</h1><div class="post__text post__text-html js-mediator-article">  A long time ago, ADO.NET 2.0 was released, and along with it was the System.Transactions assembly, which contains the TransactionScope class - a guide to the world of easy and unconstrained use of transactions.  In today's article I will discuss some of the nuances that arise when using this leaky, but such a pretty abstraction. <br><br><a name="habracut"></a><br><br>  So, starting with ADO.NET 2.0, in order to enclose your code in a transaction, the developer only needs to locate it inside the TransactionScope block: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionScope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope(TransactionScopeOption.Suppress, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionOptions() { IsolationLevel = IsolationLevel.Serializable }) { <span class="hljs-comment"><span class="hljs-comment">//   transactionScope.Complete(); }</span></span></code> </pre> <br><br>  I used the most important parameters in the constructor - let's consider them (in reverse order). <br><br><h5>  IsolationLevel </h5><br><br>  Good old <a href="http://en.wikipedia.org/wiki/Isolation_(database_systems)">IsolationLevel</a> .  Enum IsolationLevel includes as many as 7 levels of isolation, but do not flatter yourself - these values ‚Äã‚Äãare interpreted only as recommendations of the ADO.NET provider, and you can use only those levels that are supported by your DBMS. <br><br>  By default, the highest isolation level is used - Serializable, and I even came across criticism on this score: they say, not <s>in a patsan way,</s> according to the standard, it is recommended to use Read Committed as the default.  I prefer the opposite solution: the default is the most reliable mode, and if you need to improve performance or overcome deadlock, you can always switch to a softer mode. <br><br>  By the way, you cannot change the Isolation Level during a transaction. <br><br><h5>  TransactionScopeOption </h5><br><br>  Enum TransactionScopeOption contains three values: Requires, RequiresNew, Suppress, which define the behavior when entering the TransactionScope block.  The behavior in all possible cases of TransactionScopeOption is perfectly described in <a href="http://msdn.microsoft.com/en-us/library/ms172152(v%3Dvs.90).aspx">msdn</a> , and I will only summarize: <br><ol><li>  Requires (default) requires a transaction.  When entering the block, either the transaction of the parent TransactionScope will be used (if any), or a new transaction will be created. </li><li>  RequiresNew always requires creating a new transaction </li><li>  Suppress executes block code outside transaction </li></ol><br><br>  Note that in the RequiresNew and Suppress modes, any TransactionScope is rudimentary, whereas in the Requires mode, you can use nested TransactionScope.  Nested TransactionScope is visually very similar to classic nested transactions (known to MySQL fans as Savepoints).  But this is a false analogy, and the following example explains why: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionScope1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope(TransactionScopeOption.Requires)) { Method2(); transactionScope1.Complete(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionScope2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope(TransactionScopeOption.Requires)) { <span class="hljs-comment"><span class="hljs-comment">//some code } }</span></span></code> </pre><br><br>  Notice that in Method2 we did not call transactionScope2.Complete, which means transactionScope2 will be rolled back.  In the case of classic nested transactions, we can roll back the internal transaction without rolling back the transaction.  Here, both TransactionScope work within the same transaction, which means if at least one of the internal transactionScope does not call Complete, the transaction will be marked for rollback, and when you exit the root TransactionScope, a rollback will occur (commit / rollback transactions always happen when you exit the root TransactionScope ).  Moreover, if you try to call Complete (as in Method1) in a transactional TransactionScope, and the transaction has already been marked for rollback, a TransactionAbortedException will be thrown out. <br><br>  Regarding the nested TransactionScope there is one unpleasant feature: at the time of writing the code, we do not know whether the Complete of the current TransactionScope will mean a commit transaction.  Suppose we have the following method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TransactionMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TransactionScopeOption.Requires</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionScope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope(TransactionScopeOptions.Requires)) { ... transactionScope.Complete(); } <span class="hljs-comment"><span class="hljs-comment">//,   ,     }</span></span></code> </pre><br><br>  and the method that calls it: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallingMethod1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... TransactionMethod(); //... }</span></span></code> </pre><br><br>  And everything would be fine, but over time, a higher-level service appears that calls TransactionMethod from its internal TransactionScope: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallingMethod1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... using (var transactionScope = new TransactionScope(TransactionScopeOptions.Requires)) { //... TransactionMethod(); //... transactionScope.Complete(); } //... }</span></span></code> </pre><br><br>  And here the transactionScope.Complete () call inside the TransactionMethod no longer leads to a transaction commit, which means that the underlying logic associated with the fact that the commit commit has already occurred will fail. <br><br>  Although, in fairness, it is worth noting that the situation described is quite specific, and, as a rule, the developer doesn‚Äôt care whether the commit will occur when exiting the current transactionScope or one of the overlying ones. <br><br>  Now it's time to pay attention to the two other values ‚Äã‚Äãof TransactionScopeOption: RequiresNew and Suppress.  I rarely had to use these modes.  Moreover, if I am not mistaken, I did it only once, and just when solving the problem described in the previous <a href="http://habrahabr.ru/blogs/net/115156/">article</a> . <br><br>  The question of the use or non-use of RequiresNew and Suppress is certainly determined by the requirements of the algorithm, but I have some biases about this.  The fact is that TransactionScope in the RequiresNew and Suppress modes in the presence of operations modifying the database state makes it impossible to use the old trick when the integration test code is in a transaction that rolls back after the test, thereby restoring the database state: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntegrationTest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionScope()) { <span class="hljs-comment"><span class="hljs-comment">//  //  Complete } }</span></span></code> </pre><br><br>  If TransactionScope in the Requires mode is created in the test code, they will be hooked to the test TransactionScope, which means we can roll back all changes.  If the code has TransactionScope in the RequiresNew or Suppress mode, then we cannot roll back the result of their work from the test TransactionScope.  It is worth noting that the presence of logic, tied at the time of the commit transaction (as in the previous example), also makes it impossible to use this technique. <br><br>  Finally, I note that TransactionScope is local to the stream (because its implementation is based on a ThreadStatic variable).  If you need to use one transaction from several threads, use the <a href="http://msdn.microsoft.com/en-us/library/system.transactions.dependenttransaction%2528v%3DVS.90%2529.aspx">DependentTransaction</a> class. <br><br>  Here, perhaps, that's all.  TransactionScope is beautiful, but cunning - don't forget about it :) </div><p>Source: <a href="https://habr.com/ru/post/115480/">https://habr.com/ru/post/115480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115467/index.html">Peter Mitrichev - Facebook Hacker Cup winner</a></li>
<li><a href="../115470/index.html">Suicidal arithmetic</a></li>
<li><a href="../115471/index.html">Yandex.Money - now without borders</a></li>
<li><a href="../115474/index.html">Set in the magistracy of the Academic University (St. Petersburg)</a></li>
<li><a href="../115476/index.html">Answers ABBYY CEO Sergey Andreev to questions from readers Habr. Part 3</a></li>
<li><a href="../115481/index.html">Lost in static</a></li>
<li><a href="../115482/index.html">Web development issues in the middle lane</a></li>
<li><a href="../115483/index.html">Droider Chart 43. Hit parade of Android applications</a></li>
<li><a href="../115485/index.html">JavaScript Augmented Reality - JSARToolkit test</a></li>
<li><a href="../115486/index.html">Iran has created a special unit that carries out attacks against "enemy sites"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>