<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We work with the registry of prohibited resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Automation of the registry of prohibited resources using C # , OpenSSL and filtering using RouterOS based on MikroTik equipment 



 Attention! Articl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We work with the registry of prohibited resources</h1><div class="post__text post__text-html js-mediator-article">  Automation of the registry of prohibited resources using <b>C #</b> , <b>OpenSSL</b> and filtering using <b>RouterOS</b> based on <b>MikroTik</b> equipment <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f7/bc7/eee/8f7bc7eeeed8fe85a3fd34029b81e5d9.png" alt="image"><br><br>  <u><b>Attention!</b></u>  <u><i>Article amended according to recent changes on 19/03/2014</i></u> <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Introductory </h4><br><br>  In our work we will be guided by the <a href="http://vigruzki.rkn.gov.ru/docs/description_for_operators_actual.pdf">operator's memo</a> <br>  The work consists of the following items: <br><ol><li>  <a href="https://habr.com/ru/post/187574/">Create request</a> </li><li>  <a href="https://habr.com/ru/post/187574/">Installing and configuring <b>OpenSSL</b></a> </li><li>  <a href="https://habr.com/ru/post/187574/">Request Signature</a> </li><li>  <a href="https://habr.com/ru/post/187574/">Submitting a request and getting the result of processing the request</a> </li><li>  <a href="https://habr.com/ru/post/187574/">Result processing</a> </li><li>  <a href="https://habr.com/ru/post/187574/">Adding to the filter on MikroTik ªe</a> </li></ol><br><br><a name="1"></a><h4>  Create request </h4><br><br>  To submit a request for receiving an unloading from the registry, you must attach the request file in <b>XML format</b> .  The file has the following form: <br><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="windows-1251"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">request</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestTime</span></span></span><span class="hljs-tag">&gt;</span></span>2012-01-01T01:01:01.000+04:00<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">requestTime</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">operatorName</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[ ]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">operatorName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">inn</span></span></span><span class="hljs-tag">&gt;</span></span>1234567890<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">inn</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ogrn</span></span></span><span class="hljs-tag">&gt;</span></span>1234567890123<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ogrn</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email</span></span></span><span class="hljs-tag">&gt;</span></span>email@email.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">request</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br><ul><li>  <b>requestTime</b> - the date and time of the request with the time zone; </li><li>  <b>operatorName</b> - full name of the carrier; </li><li>  <b>inn</b> - operator's TIN (10 digits for legal entities, 12 digits for individual entrepreneurs); </li><li>  <b>ogrn</b> - operator's OGRN (13 digits for legal entities, 15 digits for individual entrepreneurs); </li><li>  <b>email</b> - the email address of the technician responsible for using the unloading receipt mechanism;  can <br>  be used for prompt feedback in case of technical issues or problems.  Optional parameter. </li></ul><br><br>  The main <b>thing is</b> to get time in the format <b>2012-01-01T01: 01: 01.000 + 04: 00</b> and save the file with <b>windows-1251</b> encoding. <br><br>  <b>C #</b> request generation function code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GeneratingRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String operatorName, String inn, String ogrn, String email</span></span></span><span class="hljs-function">)</span></span> { String result = <span class="hljs-string"><span class="hljs-string">"&lt;?xml version=\"1.0\" encoding=\"windows-1251\"?&gt;"</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;request&gt;&lt;requestTime&gt;"</span></span>; result += DateTime.Now.ToString(<span class="hljs-string"><span class="hljs-string">"yyyy-MM-ddTHH:mm:ss.fffzzz"</span></span>); result += <span class="hljs-string"><span class="hljs-string">"&lt;/requestTime&gt;&lt;operatorName&gt;"</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;![CDATA["</span></span> + operatorName + <span class="hljs-string"><span class="hljs-string">"]]&gt;"</span></span>; result += <span class="hljs-string"><span class="hljs-string">"&lt;/operatorName&gt;&lt;inn&gt;"</span></span>; result += inn; result += <span class="hljs-string"><span class="hljs-string">"&lt;/inn&gt;&lt;ogrn&gt;"</span></span>; result += ogrn; result += <span class="hljs-string"><span class="hljs-string">"&lt;/ogrn&gt;&lt;email&gt;"</span></span>; result += email; result += <span class="hljs-string"><span class="hljs-string">"&lt;/email&gt;&lt;/request&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br><br>  Now save the file in <b>windows-1251</b> encoding: <br><pre> <code class="cs hljs">String Request = GeneratingRequest(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"1234567890"</span></span>, <span class="hljs-string"><span class="hljs-string">"1234567890123"</span></span>, <span class="hljs-string"><span class="hljs-string">"email@email.ru"</span></span>) StreamWriter swRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamWriter(<span class="hljs-string"><span class="hljs-string">@"C:\request.xml"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, Encoding.GetEncoding(<span class="hljs-string"><span class="hljs-string">"Windows-1251"</span></span>)); swRequest.Write(Request); swRequest.Close();</code> </pre><br><br>  After creating the request, we need to sign it.  To do this, we use the open source cryptographic package for working with <b>SSL / TLS</b> - <b><a href="http://ru.wikipedia.org/wiki/OpenSSL">OpenSSL</a></b> .  Install and configure. <br><br><a name="2"></a><h4>  Openssl </h4><br>  Download the package from this site - <a href="http://slproweb.com/products/Win32OpenSSL.html">slproweb.com</a> .  In my case, it was <b>Win64 OpenSSL v1.0.1g</b> . <br><br>  Yes, this assembly requires the installed <b>Visual C ++ 2008 Redistributables to work</b> , which can be downloaded there. <br>  Install.  When installing, select the <b>‚ÄúThe OpenSSL‚Äù binaries (/ bin) directory ‚Äù</b> in the <b>‚Äú Select Additional Tasks ‚Äù</b> dialog <b>and</b> there are no more tricks. <br>  Next, go to the folder where you installed: <b>C: / OpenSSL / bin</b> and edit the file <b>openssl.cfg</b> .  To the top of the file, add: <br><br> <code>openssl_conf = openssl_def</code> <br> <br>  In the end: <br> <code>[openssl_def]</code> <br> <code>engines=engine_section</code> <br> <br> <code>[engine_section]</code> <br> <code>gost=gost_section</code> <br> <br> <code>[gost_section]</code> <br> <code>engine_id=gost</code> <br> <code>dynamic_path = C:/OpenSSL/bin/gost.dll</code> <br> <code>default_algorithms=ALL</code> <br> <br>  Everything is almost working now. It remains to set up the environment variables: <br>  <b>OPENSSL_CONF = C: /OpenSSL/bin/openssl.cfg</b> - full path to <b>openssl.cfg</b> <br>  well, in <b>PATH + = C: / OpenSSL / bin;</b> <br><br>  Now we need an EDS.  You can purchase it in a <a href="http://www.reestr-pki.ru/tsl.html">trusted certification center</a> .  The key must be exported in <b>PKCS # 12</b> format from a cryptocontainer to Windows using the utility <a href="http://soft.lissi.ru/products/utils/p12fromcsp/"><b>P12FromGostCSP</b></a> <br><br><div class="spoiler">  <b class="spoiler_title">Why P12FromGostCSP</b> <div class="spoiler_text">  I <a href="https://habrahabr.ru/users/xtron/" class="user_link">quote a</a> comment <a href="https://habrahabr.ru/users/xtron/" class="user_link">xtron</a> from the article <a href="http://habrahabr.ru/post/189352/">Interaction of php-soap on linux with certificate authorization using GOST algorithms</a> <br><br><blockquote>  Not everything is as simple as it seems at first glance.  In fact, the certificate exported through the standard certificate viewing dialog is not recognized by openssl.  It turns out this error: <br>  MAC verified OK <br>  Bag attributes <br>  localKeyID: 01 00 00 00 <br>  friendlyName: REGISTRY \\ mstaff <br>  Microsoft CSP Name: Crypto-Pro GOST R 34.10-2001 Cryptographic Service Provider <br>  Error outputting keys and certificates <br>  140017040754368: error: 06074079: digital envelope routines: EVP_PBE_CipherInit: unknown pbe algorithm: evp_pbe.c: 167: TYPE = 1.2.840.113549.1.12.1.80 <br>  140017040754368: error: 23077073: PKCS12 routines: PKCS12_pbe_crypt: pkcs12 algor cipherinit error: p12_decr.c: 83: <br>  140017040754368: error: 2306A075: PKCS12 routines: PKCS12_item_decrypt_d2i: pkcs12 pbe crypt error: p12_decr.c: 130: <br><br>  That's just this utility and allows you to avoid such an error.  I quote the developers of this utility: <br><br>  The PKCS # 12 container created by the P12FromGostCSP utility is fully compatible with similar containers created by CryptoCom LLC (as part of the openssl project) and Top Cross LLC, which unfortunately cannot be said about the container created by the CryptoPro software CSP (starting with version R3). <br><br>  It is convenient to use the following openssl or lirssl utilities to view the ASN1 structures of a PKCS # 12 container created by means of CryptoPro CSP R3 and containers created by other means: <br><br>  #openssl asn1parse ‚Äìinform DER ‚Äìin &lt;PKCS # 12 container&gt; <br><br>  If you compare these structures, you will immediately notice that, for example, SHA1 is used instead of the hash algorithm of GOST R 34.11-94 in the container from CryptoPro.  You will get an even more interesting result if you try to view the contents of the container by running the following command: <br><br>  #openssl pkcs12 ‚Äìin &lt;PKCS # 12 Container&gt; <br></blockquote><br></div></div><br><br>  The <b>PKCS # 12</b> file must contain a certificate and a private key!  You can check this with the command: <br><br><pre> <code class="bash hljs">openssl.exe pkcs12 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C:/key.pfx -nodes</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/87e/591/0bc/87e5910bc7960bf04594572d711ea23e.png" alt="image"><br><br>  Next, convert it to <b>PEM</b> .  In <b>OpenSSL,</b> this is done like this (via the command line ‚Äî it can request a password that protects the <b>PKCS # 12</b> Key): <br><br><pre> <code class="bash hljs">openssl.exe pkcs12 -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C:/key.pfx -out C:/key.pem -nodes -clcerts</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a0/d8d/bb2/5a0d8dbb2710c49d83f79ac208978a59.png" alt="image"><br><br>  All now we are able to sign our request. <br><br><a name="3"></a><h4>  Request Signature </h4><br><br>  You can sign the request via OpenSSL with the following command: <br><br><pre> <code class="bash hljs">openssl.exe smime -sign -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C:/request.xml -out C:/request.xml.sign -signer C:/key.pem -outform DER</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c77/f7f/a90/c77f7fa90a2ce5e7c9a303964b96d357.png" alt="image"><br><br>  Implementing the C # file signature feature: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Boolean ret = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; String OpenSSLPath = <span class="hljs-string"><span class="hljs-string">@"C:\OpenSSL\bin"</span></span>; String RequestPath = <span class="hljs-string"><span class="hljs-string">@"C:\request.xml"</span></span>; String SignRequestPath = <span class="hljs-string"><span class="hljs-string">@"C:\request.xml.sign"</span></span>; String KeyPEMPath = <span class="hljs-string"><span class="hljs-string">@"C:\key.pem"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Process cmdProcess = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process(); <span class="hljs-comment"><span class="hljs-comment">/* *     *    PATH *    OpenSSL */</span></span> cmdProcess.StartInfo.WorkingDirectory = OpenSSLPath; cmdProcess.StartInfo.FileName = <span class="hljs-string"><span class="hljs-string">"openssl.exe"</span></span>; cmdProcess.StartInfo.Arguments = String.Format(<span class="hljs-string"><span class="hljs-string">"smime -sign -in {0} -out {1} -signer {2} -outform DER"</span></span>, RequestPath, SignRequestPath, KeyPEMPath); cmdProcess.StartInfo.CreateNoWindow = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; cmdProcess.StartInfo.WindowStyle = ProcessWindowStyle.Hidden; cmdProcess.Start(); <span class="hljs-comment"><span class="hljs-comment">// dimzon541 if (!cmdProcess.WaitForExit(5000)) { cmdProcess.Kill(); ret = false; } } catch (Exception) { ret = false; } return ret; }</span></span></code> </pre><br><br>  Now check out our work.  Confirmation of authenticity of <a href="http://www.gosuslugi.ru/pgu/eds/">electronic signature</a> : <a href="http://www.gosuslugi.ru/pgu/eds/">gosuslugi.ru</a> , choose - <b>Confirmation of authenticity of an electronic document.</b>  <b>EA - disconnected, in PKCS # 7 format</b> <br><br>  You can check it using OpenSSL tools, but for this you need to extract the certificate of the publisher, which provided the EDS and convert it to the PEM format (you can also take the certificate <a href="http://e-trust.gosuslugi.ru/UFOCerts">here</a> ): <br><pre> <code class="bash hljs">openssl x509 -inform der -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C:/most.cer -out C:/most.pem</code> </pre> <br><br>  And check our signature: <br><pre> <code class="bash hljs">openssl.exe smime -verify -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C:/request.xml.sign -content C:/request.xml -CAfile C:/most.pem -inform DER -out C:/validrequest.xml</code> </pre> <br><br>  As a result, we will see the line: <br><pre> <code class="bash hljs">Verification successful</code> </pre> <br>  and in the <b>validrequest.xml</b> file will be the contents of <b>request.xml</b> . <br><br>  We proceed directly to the request to dump the registry of prohibited resources. <br><br><a name="4"></a><h4>  Filing and unloading the registry </h4><br><br>  Everything is simple in manual: <a href="http://vigruzki.rkn.gov.ru/tooperators_form/">Request submission form</a> , we send the request file and its signature ( <b>C: /request.xml</b> and <b>C: /request.xml.sign</b> ) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/54f/13e/635/54f13e635ec5725fb52ca6b5d6583774.png" alt="image"><br><br>  If everything is normal, the result will be - the identifier of the request, with the help of it you can check the result of processing the request.  As a rule, if everything is normal, then the registry will be unloaded in about 5 minutes in a <b>ZIP</b> format in the archive there will be two <b>dump.xml files</b> - a registry dump and its digital signature. <br><br>  You can check the file using OpenSSL or <a href="http://www.gosuslugi.ru/pgu/eds/">gosuslugi.ru</a> : <br><pre> <code class="bash hljs">openssl.exe smime -verify -<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> C:/dump.xml.sig -content C:/dump.xml -CAfile C:/cartk.pem -inform DER -out C:/validdump.xml</code> </pre> <br><br>  As a result, we will see the line: <br><pre> <code class="bash hljs">Verification successful</code> </pre> <br>  and in the <b>validdump.xml</b> file will be the contents of <b>dump.xml</b> . <br><br>  Now we automate this process.  For unloading there is a service working under the <b><a href="http://ru.wikipedia.org/wiki/SOAP">SOAP</a></b> access <b><a href="http://ru.wikipedia.org/wiki/SOAP">protocol</a></b> , the address: the <a href="http://vigruzki.rkn.gov.ru/services/OperatorRequest/">service</a> .  <b>WSDL Schema</b> is available at: <b><a href="http://vigruzki.rkn.gov.ru/services/OperatorRequest/%3Fwsdl">WSDL Schema</a></b> . <br><br>  The service consists of 4 methods: <br><br><ul><li>  <b>getLastDumpDateEx</b> <br>  The method is designed to get the timestamp of the last update of the download from the registry.  In response, it sends the <b>lastDumpDate</b> - a <b>long</b> date comes in the <b>UNIX Timestamp</b> format, but not in seconds, but in milliseconds, as well as the <b>lastDumpDateUrgently</b> - The time when the last change was made to the unloading requiring immediate response , but not in seconds, but in milliseconds). </li><li>  <b>getLastDumpDate</b> <br>  Reserved for compatibility.  Similar to getLastDumpDateEx, but returns only one <b>lastDumpDate</b> parameter., A <b>long</b> date comes in the <b>UNIX Timestamp</b> format, not in seconds, but in milliseconds. </li><li>  <b>sendRequest</b> <br>  The method is designed to send a request for receiving an unloading from the registry. Accepts <b>requestFile</b> and <b>signatureFile</b> in <b>base64Binary</b> format ‚Äî the request file and its signature ( <b>C: /request.xml</b> and <b>C: /request.xml.sign</b> ). <b>boolean</b> format and if all is successful, then <b>code</b> - Request identifier, the string by which you need to get the unloading from the registry in the format <b>string</b> .  Also <b>resultComment</b> - Comment to the result of processing the query in the format of <b>string</b> . </li><li>  <b>getResult</b> <br>  The method is designed to get the result of processing the request - unloading from the registry, accepts <b>code</b> - Request identifier, the string by which you need to get the unloading from the registry in <b>string</b> format.  In response, it sends <b>result</b> - The result of processing the request in a <b>boolean</b> format, and if everything is successful, then <b>registerZipArchive</b> - A <b>zip-file</b> with downloading from the registry in <b>base64Binary</b> format.  Also <b>resultComment</b> - Comment to the result of processing the query in the format of <b>string</b> . </li></ul><br><br>  Possible values ‚Äã‚Äãof the <b>resultComment</b> tag: <br><ul><li>  request is being processed </li><li>  invalid EP algorithm </li><li>  Wrong format of ES </li><li>  Invalid ES Certificate </li><li>  incorrect value of ES </li><li>  certificate verification error </li><li>  the applicant does not have a license giving the right to provide services for providing access to the information and telecommunication Internet </li></ul><br><br>  Feedback information for resolving issues is provided in the Reminder to the carrier in <a href="http://eais.rkn.gov.ru/tooperators/">this</a> section. <br><br>  The logic of working with the service: <br><ol><li>  Check whether the download is updated from the registry.  To do this, call the <b>getLastDumpDateEx</b> method and compare the obtained value with the value obtained at the previous iteration.  In case the <b>lastDumpDateUrgently</b> value <b>has</b> changed, then immediately request the updated unloading.  In other cases, update the upload at your discretion, <u>but at least once a day</u> . </li><li>  In case the upload is updated, send a request to receive the upload using the <b>sendRequest</b> method. </li><li>  After a few minutes, call the <b>getResult</b> method to get the result of processing the request.  If the request has not been processed yet (see the contents of the <b>resultComment</b> field), repeat step 3 in a few minutes. </li></ol><br><br>  We add a service to the resources, passing the address of the WSDL scheme. <br>  Function code <b>getLastDumpDate</b> , <b>sendRequest</b> , <b>getResult</b> <br><br><div class="spoiler">  <b class="spoiler_title">MaxReceivedMessageSize</b> <div class="spoiler_text">  Recently, errors like the following have begun to appear: The maximum message size quota for incoming messages ( <b>65536</b> ) has been exceeded.  To increase the quota, use the <b>MaxReceivedMessageSize</b> property of the corresponding binding element. <br><br>  Therefore, we had to increase the <b>MaxReceivedMessageSize</b> property. <br>  Support Service Comment: <br><blockquote>  At the moment, the response of the getResult method contains an xml data block, which is slightly larger than 65536 bytes. </blockquote><br></div></div><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Int64 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LastDumpDate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Int64 lastDumpDate = <span class="hljs-number"><span class="hljs-number">0</span></span>; BasicHttpBinding HttpBinding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicHttpBinding(); HttpBinding.MaxReceivedMessageSize = <span class="hljs-number"><span class="hljs-number">1</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-comment"><span class="hljs-comment">//1Gb using (ChannelFactory&lt;ServiceReference.OperatorRequestPortType&gt; scf = new ChannelFactory&lt;ServiceReference.OperatorRequestPortType&gt;( HttpBinding, new EndpointAddress("http://vigruzki.rkn.gov.ru/services/OperatorRequest/"))) { ServiceReference.OperatorRequestPortType channel = scf.CreateChannel(); ServiceReference.getLastDumpDateResponse glddr = channel.getLastDumpDate(new ServiceReference.getLastDumpDateRequest()); lastDumpDate = glddr.lastDumpDate; } return lastDumpDate; } public static Boolean SendRequest(out String resultComment, out String code, Byte[] requestFile, Byte[] signatureFile) { Boolean result = false; code = null; BasicHttpBinding HttpBinding = new BasicHttpBinding(); HttpBinding.MaxReceivedMessageSize = 1*1024*1024*1024; //1Gb using (ChannelFactory&lt;ServiceReference.OperatorRequestPortType&gt; scf = new ChannelFactory&lt;ServiceReference.OperatorRequestPortType&gt;( HttpBinding, new EndpointAddress("http://vigruzki.rkn.gov.ru/services/OperatorRequest/"))) { ServiceReference.OperatorRequestPortType channel = scf.CreateChannel(); ServiceReference.sendRequestRequestBody srrb = new ServiceReference.sendRequestRequestBody(); srrb.requestFile = requestFile; srrb.signatureFile = signatureFile; ServiceReference.sendRequestResponse srr = channel.sendRequest(new ServiceReference.sendRequestRequest(srrb)); resultComment = srr.Body.resultComment; if (result = srr.Body.result) { code = srr.Body.code; } } return result; } public static Boolean GetResult(out String resultComment, out Byte[] registerZipArchive, String code) { Boolean result = false; registerZipArchive = null; BasicHttpBinding HttpBinding = new BasicHttpBinding(); HttpBinding.MaxReceivedMessageSize = 1*1024*1024*1024; //1Gb using (ChannelFactory&lt;ServiceReference.OperatorRequestPortType&gt; scf = new ChannelFactory&lt;ServiceReference.OperatorRequestPortType&gt;( HttpBinding, new EndpointAddress("http://vigruzki.rkn.gov.ru/services/OperatorRequest/"))) { ServiceReference.OperatorRequestPortType channel = scf.CreateChannel(); ServiceReference.getResultRequestBody grrb = new ServiceReference.getResultRequestBody(); grrb.code = code; ServiceReference.getResultResponse grr = channel.getResult(new ServiceReference.getResultRequest(grrb)); resultComment = grr.Body.resultComment; if (result = grr.Body.result) { registerZipArchive = grr.Body.registerZipArchive; } } return result; }</span></span></code> </pre><br><br>  For example, send a request: <br><br><pre> <code class="cs hljs">String resultComment, code; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(SendRequest(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> resultComment, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> code, File.ReadAllBytes(<span class="hljs-string"><span class="hljs-string">@"C:/request.xml"</span></span>), File.ReadAllBytes(<span class="hljs-string"><span class="hljs-string">@"C:/request.xml.sign"</span></span>))) { <span class="hljs-comment"><span class="hljs-comment">//...   }</span></span></code> </pre><br><br>  The timestamp of the last update of the download from the registry can be converted from UNIX Timestamp to DateTime like this: <br><pre> <code class="cs hljs">DateTime LastDumpDate = (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)).AddSeconds(LastDumpDate()/<span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre><br><br><a name="5"></a><h4>  Parse registry dump </h4><br><br>  It is necessary to unpack the archive: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Byte[] registerZipArchive -     GetResult(); File.WriteAllBytes(@"C:/register.zip", registerZipArchive); ZipFile.ExtractToDirectory(@"C:/register.zip", @"C:/register");</span></span></code> </pre><br><br>  As a result, we get a dump of the registry <b>C: /register/dump.xml</b> <br>  Sample dump content: <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="windows-1251"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reg:register</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">updateTime</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014-02-02T12:00:00+04:00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:reg</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://rsoc.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:tns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://rsoc.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">updateTimeUrgently</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014-02-01T11:00:00"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">includeTime</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-12-01T10:00:05"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">decision</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">date</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-12-01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"9"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">org</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[http://site1.com/index.php]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[site1.com]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>1.1.1.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"68"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">includeTime</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-12-01T10:00:05"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">decision</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">date</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-12-01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"9"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">org</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[http://site2.com/page1.php]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[http://site2.com/page2.php]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[http://site2.com/page3.php]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[site2.com]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>1.1.1.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>1.1.1.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"9999"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">includeTime</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014-02-01T15:17:51"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">urgencyType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">decision</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">date</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2014-02-01"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">number</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">org</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[http://site3.com/page1.html]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span>&lt;![CDATA[site3.com]]&gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">domain</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>1.2.3.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reg:register</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h5>  Parsim XML </h5><br>  To do this, create two classes: the first <b>RegisterDump</b> will contain the <b>UpdateTime</b> field and a list of <b>content</b> objects, the Second <b>ItemRegisterDump</b> represents one <b>content</b> object with all fields. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RegisterDump</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* * &lt;reg:register updateTime="2013-07-15T10:05:00+04:00" xmlns:reg="http://rsoc.ru" xmlns:tns="http://rsoc.ru"&gt; * &lt;content&gt;&lt;/content&gt; * &lt;content&gt;&lt;/content&gt; * ... * &lt;content&gt;&lt;/content&gt; * &lt;/reg:register&gt; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;ItemRegisterDump&gt; Items { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String UpdateTime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterDump</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Items = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ItemRegisterDump&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.UpdateTime = String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterDump</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String UpdateTime, List&lt;ItemRegisterDump&gt; Items</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Items = Items; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.UpdateTime = UpdateTime; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ItemRegisterDump</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* * &lt;content id="60" includeTime="2013-01-12T16:33:38"&gt; * &lt;decision date="2013-11-03" number="-6" org=""/&gt; * &lt;url&gt;&lt;![CDATA[http://habrahabr.ru/post/187574/]]&gt;&lt;/url&gt; * &lt;ip&gt;123.45.67.89&lt;/ip&gt; * &lt;/content&gt; * &lt;content id="69" includeTime="2013-05-12T12:43:34"&gt; * &lt;decision date="2013-10-02" number="" org=""/&gt; * &lt;domain&gt;&lt;![CDATA[chelaxe.ru]]&gt;&lt;/domain&gt; * &lt;ip&gt;123.45.67.89&lt;/ip&gt; * &lt;ip&gt;87.65.43.210&lt;/ip&gt; * &lt;/content&gt; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String includeTime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String number { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> String org { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;String&gt; url { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;String&gt; domain { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;String&gt; ip { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ItemRegisterDump</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { id = String.Empty; includeTime = String.Empty; date = String.Empty; number = String.Empty; org = String.Empty; url = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;String&gt;(); domain = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;String&gt;(); ip = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;String&gt;(); } }</code> </pre><br><br>  Parsim: <br><br><pre> <code class="cs hljs">RegisterDump Register = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RegisterDump(); String dumpfile = <span class="hljs-string"><span class="hljs-string">@"C:/register/dump.xml"</span></span>; XmlDocument xmlDoc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlDocument(); xmlDoc.Load(dumpfile); Register.UpdateTime = xmlDoc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"reg:register"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].Attributes.GetNamedItem(<span class="hljs-string"><span class="hljs-string">"updateTime"</span></span>).InnerText; XmlNodeList content = xmlDoc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"content"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; content.Count; i++) { ItemRegisterDump item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ItemRegisterDump(); item.id = content[i].Attributes.GetNamedItem(<span class="hljs-string"><span class="hljs-string">"id"</span></span>).InnerText; item.includeTime = content[i].Attributes.GetNamedItem(<span class="hljs-string"><span class="hljs-string">"includeTime"</span></span>).InnerText; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (XmlNode node <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> content[i].ChildNodes) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(node.Name) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"decision"</span></span>: item.date = node.Attributes.GetNamedItem(<span class="hljs-string"><span class="hljs-string">"date"</span></span>).InnerText; item.number = node.Attributes.GetNamedItem(<span class="hljs-string"><span class="hljs-string">"number"</span></span>).InnerText; item.org = node.Attributes.GetNamedItem(<span class="hljs-string"><span class="hljs-string">"org"</span></span>).InnerText; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"url"</span></span>: item.url.Add(node.InnerText); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"domain"</span></span>: item.domain.Add(node.InnerText); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"ip"</span></span>: item.ip.Add(node.InnerText); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } Register.Items.Add(item); }</code> </pre><br><br>  Now we block all this stuff on our MikroTik. <br><br><a name="6"></a><h4>  Blocked with MikroTik </h4><br>  We do this with the help of a <a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/L7"><b>layer7-protocol</b></a> and add them to the <a href="http://wiki.mikrotik.com/wiki/Manual:IP/Firewall/Filter">filters</a> . <br><br>  Here is an example: <br> <code>/ip firewall layer7-protocol add name=12 comment=register regexp=^.+(chelaxe.ru).*$</code> <br> <code>/ip firewall filter add action=drop chain=forward disabled=no dst-port=80 layer7-protocol=12 protocol=tcp src-address=192.168.0.0/24 comment=register</code> <br> <br><img src="http://habrastorage.org/storage2/9cf/c97/26c/9cfc9726ce505db15ab4ea1d7bee9305.png" alt="image"><br><img src="http://habrastorage.org/storage2/1aa/175/515/1aa1755151bee6188e7732ae86d88771.png" alt="image"><br><img src="http://habrastorage.org/storage2/95a/b6f/834/95ab6f8345d8535f0cabc10744298769.png" alt="image"><br><img src="http://habrastorage.org/storage2/c56/8a8/1df/c568a81dfe6b9ee07974f9fcdfa3034d.png" alt="image"><br><br>  All now all packets for the subnet <b>192.168.0.0/24</b> coming over <b>TCP</b> on port <b>80</b> with the contents of the <b>chelaxe.ru</b> substrings <b>are</b> discarded. <br>  In the comments, the inscription <b>register</b> is not added with a simple.  We will need it to delete all the rules before adding the updated ones. <br><br>  Here is the script that will remove all entries: <br><br> <code>/ip firewall layer7-protocol remove [find comment=register]</code> <br> <code>/ip firewall filter remove [find comment=register]</code> <br> <br><img src="http://habrastorage.org/storage2/723/14a/51b/72314a51b2064c7b6aa6dd34e8efff83.png" alt="image"><br><br>  Communication with MikroTik router will be through the <a href="http://wiki.mikrotik.com/wiki/Manual:API">API</a> , the necessary library with examples we have already written: <a href="http://wiki.mikrotik.com/wiki/API_in_C_Sharp">wiki / API C #</a> <br><br>  Using this library (class) and the principle of content blocking, which we have analyzed above, we implement all this in C # <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Boolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddFilterL7</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String ip, String username, String password, RegisterDump dump, String SRCAddress</span></span></span><span class="hljs-function">)</span></span> { Boolean ret = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// MK   http://wiki.mikrotik.com/wiki/API_in_C_Sharp MK mikrotik = new MK(IPAddress.Parse(ip).ToString()); if (mikrotik.Login(username, password)) { mikrotik.Send("/system/script/add"); mikrotik.Send("=name=cleaner"); mikrotik.Send("=source=/ip firewall layer7-protocol remove [find comment=register]\n/ip firewall filter remove [find comment=register]", true); mikrotik.Read(); mikrotik.Send("/system/script/run"); mikrotik.Send("=number=cleaner", true); mikrotik.Read(); /* Cleaner * /ip firewall layer7-protocol remove [find comment=register] * /ip firewall filter remove [find comment=register] */ foreach (ItemRegisterDump item in dump.Items) { for (Int32 i = 0; i &lt; item.domain.Count; i++ ) { mikrotik.Send("/ip/firewall/layer7-protocol/add"); mikrotik.Send("=name=" + item.id + "_" + i); mikrotik.Send("=comment=register"); mikrotik.Send("=regexp=^.+(" + item.domain[i] + ").*$", true); mikrotik.Read(); mikrotik.Send("/ip/firewall/filter/add"); mikrotik.Send("=action=drop"); mikrotik.Send("=chain=forward"); mikrotik.Send("=disabled=no"); mikrotik.Send("=dst-port=80"); mikrotik.Send("=layer7-protocol=" + item.id + "_" + i); mikrotik.Send("=protocol=tcp"); mikrotik.Send("=src-address=" + SRCAddress); mikrotik.Send("=comment=register", true); mikrotik.Read(); } } } } catch (Exception) { ret = false; } return ret; }</span></span></code> </pre><br><br>  In the example, I used domain locking, but this is not entirely true.  For blocking by URL, you can use the following regular expression for <b>layer7-protocol</b> : <br><br> <code>^.*(/summary).*(chelaxe.ru).*$</code> <br> <br>  Moreover, the expression should be in lower case when using versions of RouterOS from 5 branches, as a consequence of the <a href="http://habrahabr.ru/post/193118/">error MikroTik</a> . <br><br>  Sources are available <a href="https://github.com/chelaxe/BlackList">here</a> . <br><br>  When creating guided: <br>  <a href="http://vigruzki.rkn.gov.ru/docs/description_for_operators_2013-07-16v2.0.pdf">Memo operator</a> <br>  <a href="https://www.evernote.com/shard/s185/sh/ceb0b021-47e7-4c61-ab43-bc6db27fe919/c535b6e5047ec69d304519fe81c2c9ac%3FnoteKey%3Dc535b6e5047ec69d304519fe81c2c9ac">OpenSSL 1.0.1c + libGOST.so + CryptoPRO + key from ruToken</a> <br>  <a href="http://habrahabr.ru/company/netangels/blog/158891/">How we got access to the database of the registry of prohibited resources</a> <br>  <a href="http://habrahabr.ru/post/188590/">Roskomnadzor announced the introduction of the registry of sites with "pirated" movies</a> <br>  <a href="http://gskinner.com/RegExr/">RegExr intuitive tool for learning, writing, and testing Regular Expressions</a> </div><p>Source: <a href="https://habr.com/ru/post/187574/">https://habr.com/ru/post/187574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../187560/index.html">Xen 4.3 released</a></li>
<li><a href="../187562/index.html">Tough Guy - Sony Xperia ZR Security Smartphone Review</a></li>
<li><a href="../187564/index.html">Tiny Tiny RSS on free hosting</a></li>
<li><a href="../187566/index.html">12 rules of a bad manager</a></li>
<li><a href="../187568/index.html">Programmers and the human factor</a></li>
<li><a href="../187578/index.html">RWpod. 20th edition 01 of the season. Plans for Rspec 3, Webservice Object, Backbone.Giraffe, Slimer.JS, etc.</a></li>
<li><a href="../187580/index.html">Easy way to play old games with 3dfx emulation</a></li>
<li><a href="../187582/index.html">Using Drag & Drop in HTML 5</a></li>
<li><a href="../187584/index.html">Nitrous.IO - online IDE with SSH access and desktop synchronization application</a></li>
<li><a href="../187586/index.html">Public development "More than a reader": functional design</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>