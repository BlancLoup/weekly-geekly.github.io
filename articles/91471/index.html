<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write functional / integration tests for the project on django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this exciting article I will talk about the tools with which you can write functional tests for a django project. There are a lot of different othe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write functional / integration tests for the project on django</h1><div class="post__text post__text-html js-mediator-article">  In this exciting article I will talk about the tools with which you can write functional tests for a django project.  There are a lot of different other ways to do it, but I will describe one - the one that, in my opinion, is the simplest.  In the meantime, we will create a beautiful report on code coverage (subjectively - nicer than those that coverage.py does).  And also, as a seasoning, there will be a little talk about testing. <br><br><a name="habracut"></a><br><br>  Right off the bat. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  1. Install the necessary packages </h4><br><pre> $ pip install coverage&gt; = 3.0
 $ pip install -e hg + http: //bitbucket.org/kmike/webtest
 $ pip install django-webtest
 $ pip install django-coverage
</pre><br>  <a href="http://pythonpaste.org/webtest/">WebTest</a> is a library for functional testing wsgi-applications from Ian Bicking (author pip and virtualenv).  I recently added Unicode support there (which is very important for us, isn't it?), This has not yet been included in the main repository, so we install from mine so far (an installed mercurial is required, but without it you can download the zip- archive, unpack and run setup.py install).  Then, I think, it will be possible to put c pypi.  You can still install from there (pip install webtest), only Unicode in forms and links will not work.  ( <i>UPD: everything has been included for a long time, you can put everything with pypi quietly</i> ) <br><br>  Why WebTest, not twill?  Twill also does not support unicode (only there is worse, not only unicode, but even non-Latin letters in utf8, as far as I can tell - <i>UPD comments <a href="https://habrahabr.ru/users/meako/" class="user_link">meako</a> that simply strings work, at least in conjunction with tddspry</i> ), the latest release It was in 2007, there is a lot of code, outdated versions of the libraries in the delivery, and it seemed that it would take more effort to screw something in there.  In general, twill is good, and html parsing is better there, so if anything - keep it in mind too (and the django-test-utils package ( <i>or tddspry?</i> ) Then too). <br><br>  Why not the built-in jung test client?  WebTest has a much more powerful API, it is easier to write functional tests with its help.  Read the docstring to django.test.client.Client: <br><br><blockquote>  It is not intended to use it, but it is not so HTML rendered to the end-user. </blockquote><br>  Why not Selenium / windmill / ..?  It does not interfere.  They test another after all.  For what you can use twill / WebTest, it is better to use twill / WebTest, since  this will work much faster, have better integration with other code and easier setup. <br><br><h4>  2. Configure the project </h4><br>  A small setup is required for django-coverage.  Do not be scared, not big) It should: <br><br>  1. add 'django_coverage' to INSTALLED_APPS and <br>  2. in settings.py specify where to save the html-reports.  It is good to create a folder for this business. <br><br> <code>COVERAGE_REPORT_HTML_OUTPUT_DIR = os.path.join(PROJECT_PATH, 'cover')</code> <br> <br><h4>  3. We write tests </h4><br>  Here, for example, is a functional test for registration / authorization: <br><br> <code><code><a href="http://s-c.me/6888/s"></a> <a href="http://s-c.me/6888/h"></a> <font color="black">Copy Source | Copy HTML&lt;br/&gt; <font color="#696969"># coding: utf-8</font> &lt;br/&gt; <font color="#0000ff">import</font> re&lt;br/&gt; <font color="#0000ff">from</font> django.core <font color="#0000ff">import</font> mail&lt;br/&gt; <font color="#0000ff">from</font> django_webtest <font color="#0000ff">import</font> WebTest&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">class</font> <font color="#cc6633">AuthTest</font> (WebTest):&lt;br/&gt;    fixtures = [ <font color="#008000">'users.json'</font> ]&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">testLogoutAndLogin</font> (self): &lt;br/&gt;        page = <b>self</b> .app.get( <font color="#008000">'/'</font> , user= <font color="#008000">'kmike'</font> )&lt;br/&gt;        page = page.click(u <font color="#008000">''</font> ).follow()&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">''</font> <font color="#0000ff">not in</font> page&lt;br/&gt;        login_form = page.click(u <font color="#008000">''</font> , index= <font color="#008000">0</font> ).form&lt;br/&gt;        login_form[ <font color="#008000">'email'</font> ] = <font color="#008000">'example@example.com'</font> &lt;br/&gt;        login_form[ <font color="#008000">'password'</font> ] = <font color="#008000">'123'</font> &lt;br/&gt;        result_page = login_form.submit().follow()&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">''</font> <font color="#0000ff">not in</font> result_page&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">''</font> <font color="#0000ff">in</font> result_page&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">testEmailRegister</font> (self):&lt;br/&gt;        register_form = <b>self</b> .app.get( <font color="#008000">'/'</font> ).click(u <font color="#008000">''</font> ).form&lt;br/&gt; <b>self</b> .assertEqual( <b>len</b> (mail.outbox), <font color="#008000">0</font> )&lt;br/&gt;        register_form[ <font color="#008000">'email'</font> ] = <font color="#008000">'example2@example.com'</font> &lt;br/&gt;        register_form[ <font color="#008000">'password'</font> ] = <font color="#008000">'123'</font> &lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">' '</font> <font color="#0000ff">in</font> register_form.submit().follow()&lt;br/&gt; <b>self</b> .assertEqual( <b>len</b> (mail.outbox), <font color="#008000">1</font> )&lt;br/&gt; &lt;br/&gt; <font color="#696969">#    ,   </font> &lt;br/&gt; <font color="#696969">#     </font> &lt;br/&gt;        mail_body = <b>unicode</b> (mail.outbox[ <font color="#008000">0</font> ].body)&lt;br/&gt;        activate_link = <b>re</b> .search( <font color="#008000">'(/activate/.*/)'</font> , mail_body).group( <font color="#008000">1</font> )&lt;br/&gt;        activated_page = <b>self</b> .app.get(activate_link).follow()&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">'&lt;h1&gt; &lt;/h1&gt;'</font> <font color="#0000ff">in</font> activated_page&lt;br/&gt; &lt;br/&gt;</font></code></code> <blockquote> <code><code><font color="black"><a href="http://s-c.me/6888/s"></a> <a href="http://s-c.me/6888/h"></a> Copy Source | Copy HTML&lt;br/&gt; <font color="#696969"># coding: utf-8</font> &lt;br/&gt; <font color="#0000ff">import</font> re&lt;br/&gt; <font color="#0000ff">from</font> django.core <font color="#0000ff">import</font> mail&lt;br/&gt; <font color="#0000ff">from</font> django_webtest <font color="#0000ff">import</font> WebTest&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">class</font> <font color="#cc6633">AuthTest</font> (WebTest):&lt;br/&gt;    fixtures = [ <font color="#008000">'users.json'</font> ]&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">testLogoutAndLogin</font> (self): &lt;br/&gt;        page = <b>self</b> .app.get( <font color="#008000">'/'</font> , user= <font color="#008000">'kmike'</font> )&lt;br/&gt;        page = page.click(u <font color="#008000">''</font> ).follow()&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">''</font> <font color="#0000ff">not in</font> page&lt;br/&gt;        login_form = page.click(u <font color="#008000">''</font> , index= <font color="#008000">0</font> ).form&lt;br/&gt;        login_form[ <font color="#008000">'email'</font> ] = <font color="#008000">'example@example.com'</font> &lt;br/&gt;        login_form[ <font color="#008000">'password'</font> ] = <font color="#008000">'123'</font> &lt;br/&gt;        result_page = login_form.submit().follow()&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">''</font> <font color="#0000ff">not in</font> result_page&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">''</font> <font color="#0000ff">in</font> result_page&lt;br/&gt; &lt;br/&gt; <font color="#0000ff">def</font> <font color="#cc6633">testEmailRegister</font> (self):&lt;br/&gt;        register_form = <b>self</b> .app.get( <font color="#008000">'/'</font> ).click(u <font color="#008000">''</font> ).form&lt;br/&gt; <b>self</b> .assertEqual( <b>len</b> (mail.outbox), <font color="#008000">0</font> )&lt;br/&gt;        register_form[ <font color="#008000">'email'</font> ] = <font color="#008000">'example2@example.com'</font> &lt;br/&gt;        register_form[ <font color="#008000">'password'</font> ] = <font color="#008000">'123'</font> &lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">' '</font> <font color="#0000ff">in</font> register_form.submit().follow()&lt;br/&gt; <b>self</b> .assertEqual( <b>len</b> (mail.outbox), <font color="#008000">1</font> )&lt;br/&gt; &lt;br/&gt; <font color="#696969">#    ,   </font> &lt;br/&gt; <font color="#696969">#     </font> &lt;br/&gt;        mail_body = <b>unicode</b> (mail.outbox[ <font color="#008000">0</font> ].body)&lt;br/&gt;        activate_link = <b>re</b> .search( <font color="#008000">'(/activate/.*/)'</font> , mail_body).group( <font color="#008000">1</font> )&lt;br/&gt;        activated_page = <b>self</b> .app.get(activate_link).follow()&lt;br/&gt; <font color="#0000ff">assert</font> u <font color="#008000">'&lt;h1&gt; &lt;/h1&gt;'</font> <font color="#0000ff">in</font> activated_page&lt;br/&gt; &lt;br/&gt;</font></code></code> </blockquote> <br><br>  We save it in the file tests.py of the desired application in the project.  It seems everything is clear there should be.  We check if a registered person can leave the site, then go to it (by entering their email and password), can they register (will the letter receive? Is the activation link correct?) And does it get to the page you need after activating the account.  For convenience, a fixture was also used, in which the kmike user with email=example@example.com was already prepared (and which is used in other tests).  It was possible to create this user directly in the test, this is not the point. <br><br>  Pay attention to the API: we follow the links, indicating their name (.click (u'Registration '), for example), i.e.  what the user actually presses on (there are other possibilities).  At each transition WebTest automatically checks that code 200 or 302 has returned to us (this is configurable).  To submit the forms, you do not need to construct POST requests manually, the forms are picked up from the html response code, it is enough to assign values ‚Äã‚Äãto the required fields and execute the submit () method.  Redirects after POST requests are made by hand (and this is useful, because if there is no redirect - for example, an error while filling in the form, then the test will show it). <br><br>  django_webtest.WebTest is the heir from Jung TestCase, it can do the same.  But the main thing is that the self.app variable of the DjangoTestApp type is available (it is the heir of the webtest.TestApp) through which you can access the WebTest API.  More information about what WebTest can do is better to read on their <a href="http://pythonpaste.org/webtest/">site</a> .  There is a simple and pleasant API, you can follow the links, submit forms, upload files, parse the answer (much higher level and concise than the jung test client).  <a href="http://bitbucket.org/kmike/django-webtest/">django_webtest</a> adds one janga-specific feature to the API: the self.app.get and self.app.post methods accept the optional <code>user</code> parameter.  If the user is submitted, the request (well, all subsequent clicks on links, form submissions, etc.) will be executed on behalf of the jung user with this username. <br><br>  It is clear that here it was possible to test the most, and it was possible less, and here it is good to observe some kind of balance: so that tests are easy to write and maintain, so that they check everything that is needed, but do not check what is not needed.  Sometimes it will be wrong to click on the link through its name, sometimes it will not be enough to simply check whether there is text on the page, sometimes even this check will be superfluous.  This, I think, is called experience, when you understand how best.  The way I wrote these tests is not necessarily the best way in this situation (although imho is quite adequate), consider just an example, not an example to follow, think about what you write.  One of the advantages of simple API is that the programmer begins to think what to write and how best to write, and not ‚Äúhow to finish adding something at last ..‚Äù. <br><br><h4>  4. Run the tests </h4><br>  Create a file test_settings.py (at the root of the project) of approximately the same content (syntax for django 1.1): <br><br> <code>from settings import * <br> DATABASE_ENGINE = 'sqlite3' <br> DATABASE_NAME = 'testdb.sqlite' <br></code> <br>  And then we run the tests: <br><br><pre>  $ python manage.py test_coverage myapp1 myapp2 myapp3 --setting = test_settings </pre><br>  You can do without test_settings (just run <code>$ python manage.py test_coverage myapp</code> and do not create any additional files), it's just more convenient with it: you can write any test-specific settings there, for example, use another DBMS to run tests faster or replace URLOpener for urllib2, so that tests do not climb on the Internet.  It is convenient to wrap the command to start tests in a shell script (or a bat file if someone has the misfortune of writing on python under windows) <br><br><h4>  5. We look pictures </h4><br>  The report on code coverage was saved in the folder specified earlier.  Open it (file cover / index.html) and see something like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/399/735/77e/39973577e1e01f51ad1bc49ae01b8bf3.png"><br><br>  We follow some link and see which code we executed during the tests, but which code did not (and, therefore, could not be tested): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e0d/0e0/205/e0d0e0205adb88c738b7530400a941d7.png"><br>  ... many lines ... <br><img src="https://habrastorage.org/getpro/habr/post_images/781/b26/cd8/781b26cd85cfcd04465bd9a7c5235c1e.png"><br>  ... many lines ... <br><br>  Aha  It is immediately obvious that we didn‚Äôt check the situation when a person entered the email of an already registered user. <br><br>  It is important to remember that functional / integration tests are <b>not a replacement for unit tests</b> , but an addition to them, and that 100% coverage does not guarantee the absence of errors.  Unit tests are accurate, they say THAT is broken, they are extremely useful in refactoring and in difficult places of the project.  Functional - rude, they say only "it seems that something has broken somewhere" and save from foolish mistakes.  But even if the tests just click on all the links on the site and check if there is an exception, then these will already be very useful tests that can save you from a lot of trouble. <br><br>  To illustrate the difference: in the unit test for the registration form, we would create an object of the EmailRegistrationForm class, pass different data dictionaries to it and look at what exceptions are thrown, for example.  Or would check the individual methods of this form.  Unit tests are as close as possible to the code (although it makes sense not to let them out of the public API), test a separate piece of it, and allow you to check that all parts of the system are working correctly.  Functional / integration tests help to verify that together they also work correctly. <br><br><h4>  6. All links </h4><br>  <a href="http://docs.djangoproject.com/en/dev/topics/testing/">docs.djangoproject.com/en/dev/topics/testing</a> <br>  <a href="http://pythonpaste.org/webtest/">pythonpaste.org/webtest</a> <br>  <a href="http://bitbucket.org/ianb/webtest">bitbucket.org/ianb/webtest</a> <br>  <a href="http://bitbucket.org/kmike/webtest">bitbucket.org/kmike/webtest</a> <br>  <a href="http://bitbucket.org/kmike/django-webtest/">bitbucket.org/kmike/django-webtest</a> <br>  <a href="http://bitbucket.org/kmike/django-coverage">bitbucket.org/kmike/django-coverage</a> <br>  <a href="http://github.com/ericholscher/django-test-utils">github.com/ericholscher/django-test-utils</a> <br>  <a href="http://twill.idyll.org/">twill.idyll.org</a> <br>  <a href="http://nedbatchelder.com/code/coverage/">nedbatchelder.com/code/coverage</a> <br><br>  Yes, all this can be just as easily used without django, WebTest is very easily screwed to any framework that supports wsgi (and supported by ‚Äúall frameworks worthy of attention‚Äù), coverage.py works great for any tests.  All these django -... applications - just to make installation and configuration as easy as possible.  Well, django-coverage, if anything, has nothing to do with the webtest, it‚Äôs just like that, hell. <br><br><h4>  7. Brief instructions </h4><br>  1. install packages <br>  2. add 'django_coverage' to INSTALLED_APPS <br>  3. in settings.py specify where to save the html-reports.  It is good to create a folder for this business. <br> <code>COVERAGE_REPORT_HTML_OUTPUT_DIR = os.path.join(PROJECT_PATH, 'cover')</code> <br>  4. writing tests, inheriting our test case from django_webtest.WebTest and using self.app <br>  5. run them: <code>$ python manage.py test_coverage myapp1 myapp2 myapp3 --settings=test_settings</code> <br><br>  If something does not work in the webtest, django-webtest and django-coverage - write in Issues on bitbucket, I will try to help. </div><p>Source: <a href="https://habr.com/ru/post/91471/">https://habr.com/ru/post/91471/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91462/index.html">Xbox 360 Modding</a></li>
<li><a href="../91464/index.html">Trouble with SQL Server Express 2008 on VPS</a></li>
<li><a href="../91465/index.html">How SkyLink tried to take all my money and how I managed to get every penny</a></li>
<li><a href="../91466/index.html">100% Uptime, 24/7 Support, Unmetered Gigabit, ‚Äúhelp us abroad‚Äù or not to get caught as a startup</a></li>
<li><a href="../91468/index.html">We attach Flex-components to the project on a clean Actionscript</a></li>
<li><a href="../91472/index.html">MonoMac - Mono Project for MacOSX</a></li>
<li><a href="../91473/index.html">Installing jira on ubuntu</a></li>
<li><a href="../91474/index.html">Summary on Habr√©</a></li>
<li><a href="../91475/index.html">seedJS - CommonJS Package Manager</a></li>
<li><a href="../91476/index.html">Implementation of services in MSWin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>