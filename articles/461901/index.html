<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Three years of autotests: how to increase speed and not only</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, I'm Alexey, a full-stack developer of the Vimbox platform. When I came to Skyeng, they decided here whether it was worth the time to spend on the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Three years of autotests: how to increase speed and not only</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/r9/8a/gw/r98agw-4lkilwp2xud43xg5jjcm.png"></p><br><p>  Hi, I'm Alexey, a full-stack developer of the Vimbox platform.  When I came to Skyeng, they decided here whether it was worth the time to spend on the autotest system and asked me to share my experience from the previous work.  And I had such experience: by the time of leaving the previous place we wrote in php and twisted more than 3 thousand tests.  As a result, I made a small internal presentation telling about the rake that I managed to tread in a few years of developing these auto-tests, struggling for their speed, code readability and overall efficiency.  The presentation seemed to colleagues useful, so I put it in the text to be useful also to a wider audience. </p><br><p>  To begin with, the terms that will be discussed in the article: </p><br><ul><li>  <strong>Acceptance test</strong> - end-to-end test: here the browser or browser emulator executes the script </li><li>  <strong>Unit test</strong> (unit test) - method test </li><li>  <strong>Functional test</strong> - a test of a controller or component, when it comes to frontend </li><li>  <strong>Fixture</strong> - the state of the test environment necessary for the test to work (global variables, data in the database and other participants in the test script) </li></ul><a name="habracut"></a><br><h2 id="plyusy-i-minusy-raznyh-vidov-testov">  Pros and cons of different types of tests </h2><br><p><img src="https://habrastorage.org/webt/hp/kt/ls/hpktlsxmbac5itjhdn_wludojeo.png"></p><br><p>  <em>Acceptance tests</em> </p><br><ul><li>  Pros: obvious from the name, such tests cover the entire system from top to bottom, make sure that everything works as it should. </li><li>  Cons: the feedback from these tests is very slow, they work for a long time, they are not very reliable, there are a lot of false positives.  At a previous job, we were also faced with the fact that web drivers did not detect some elements that we saw with our eyes.  Now this has probably been fixed, but then I had to abandon them. </li></ul><br><p>  <em>Unit tests</em> </p><br><ul><li>  Pros: easy to write, work quickly.  They cover a small piece of code, you do not need many states, therefore, you do not need a large fixture either. </li><li>  Cons: unstable to changes in the architecture or internal structure of the code.  If you need to merge two methods into one or separate, select a class, delete a method, you have to rewrite the tests. </li></ul><br><p>  <em>Functional tests</em> are an intermediate solution. </p><br><ul><li>  Pros: more reliable acceptance, more resistant to changes in the structure of the code than modular. </li><li>  Cons: slower than modular, more difficult to write, because  need to prepare a big fixture. </li></ul><br><h2 id="borba-za-skorost">  The fight for speed </h2><br><p>  At the old work, we wrote a lot of functional tests, and the main challenge was the response speed.  I had to wait a long time for the result, even with a local launch on the developer's computer.  The speed was so low that it was not possible to apply the ‚Äúdevelopment through testing‚Äù approach, since it involves running autotests several times per hour.  Found a bottleneck - working with the database.  How to deal with this? </p><br><h4 id="opyt-peryy-moki">  Experience first: moki </h4><br><p>  <em>Mock in PhpUnit is a dynamically created object whose class is dynamically inherited from the parodied class.</em>  <em>You can configure what the methods of the moq will return, you can check which methods of the moq how many times with which parameters were called</em> </p><br><p>  The main <strong>plus of</strong> moki - they allow you to cut off whole pieces of functionality.  Replacing the service with moch, we get rid of the need to think what is happening there, to develop additional scenarios and fixtures so that everything works correctly.  As a result: fewer fixtures, and the response speed is higher due to the fact that we cut off the extra code that executes queries to the database. </p><br><p>  The implicit plus of mobs is that they make them better organize dependencies.  When you write a code, knowing that it will be necessary to write a test on it, where something is replaced by mokami, you immediately think about dependencies. </p><br><p>  <strong>Minus</strong> : the test code is too attached to implementation.  During the test, we must create a mock object and think about what methods should be called on it. </p><br><p>  The second minus found is that the tests have become less reliable.  They ‚Äúdo not notice‚Äù even changes in the interface, not to mention the implementation.  Those.  we deleted the method somewhere and after a long time found that the tests covering it still work as if nothing had happened, because we saw its mock, and he pretended that everything was fine. </p><br><p>  I consider the experience with mokas unsuccessful in terms of speeding up the tests. </p><br><h4 id="opyt-vtoroy-sqlite">  Experience Two: SQLite </h4><br><p>  The next option is <a href="https://www.sqlite.org/">SQLite DBMS</a> , it can create a database in RAM.  I had to write a PostgreSQL translator schema in SQLite, after each migration a new SQLite schema was generated.  Tests from this circuit created an empty database in RAM.  This approach increased the speed of tests on local machines by two to four times.  It became realistically to run the entire test suite several times per hour. </p><br><p>  But there were also disadvantages.  We have lost many of the native PostgreSQL features (json, some handy aggregate functions, and more).  Queries had to be written so that they worked on both PostgreSQL and SQLite. </p><br><h4 id="opyt-tretiy-optimizaciya-postgresql">  Experience Three: PostgreSQL Optimization </h4><br><p>  This solution was working, but it caused some pain.  At some point, we <a href="https://stackoverflow.com/questions/9407442/optimise-postgresql-for-fast-testing">learned</a> that PostgreSQL can be optimized for autotests, which reduces the response time by about four times.  To do this, add a few settings to postgresql.conf: </p><br><pre><code class="plaintext hljs">fsync=off synchronous_commit=off full_page_writes=off</code> </pre> <br><p>  These are reliability settings, they guarantee that if the server dies in the middle of a transaction, it will complete correctly when everything starts working again.  It is clear that such settings cannot be made on production, but it was convenient on automatic tests. </p><br><p>  This setting is applied to the entire cluster, affects all databases, it cannot be applied to any one database.  If you manage to localize the databases in a separate cluster and disable fsync in it, this is very convenient. </p><br><h2 id="nemnogo-o-new">  A bit about <code>new</code> </h2><br><p>  I would also like to mention the danger of the <code>new</code> operator.  Services created with its help cannot be replaced by mokas and stubs.  Conclusion: </p><br><ul><li>  Do not use <code>new</code> to create objects that are essentially services. </li><li>  It can be used in factories, because they can be replaced.  But factories themselves should not be created through <code>new</code> . </li><li>  It can be used to create models, entities, DTO (data transfer object), value-objects. </li></ul><br><h2 id="vyvody-iz-trehletnego-opyta">  Conclusions from three years of experience </h2><br><ul><li>  At the previous work, we refused acceptance tests, but now I would try them again: most likely many bugs were fixed in web drivers. </li><li>  If you need to cover <strong>new functionality with</strong> tests, you need to write only <em>functional</em> tests of controllers / components.  In this situation, we have a high risk of structural changes, unit tests are unstable to them. </li><li>  There should not be many such tests, because many == slowly, they do not work as fast as modular ones.  It is worth covering only those cases that can ‚Äúshoot‚Äù (they have the likelihood of an error in the future). </li><li>  Unit tests are written on algorithm-rich methods (complex logic that needs to be tested) or on methods with little risk of structural changes in the future. </li><li>  Cons of mokas in general exceed pluses.  It makes sense to use them only as a substitution of gateways into external APIs, and sometimes services from legacy code, which are very difficult to test. </li><li>  If you decide to write code without a test, it is advisable to think, ‚Äúwhen you create it, what if in the future we still want to write a test for it?‚Äù </li><li>  Tests should be easy and pleasant to write, they give reliability, confidence, help to better understand the code, manage dependencies. </li><li>  Pay attention to the readability of the tests.  It is necessary to relate to the test code in the same way as to the code that it covers. </li><li>  DB fixtures - part of the test, must also be readable </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/461901/">https://habr.com/ru/post/461901/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461891/index.html">How we made friends in bank infrastructure using ManageIQ</a></li>
<li><a href="../461895/index.html">Learn While Travel - how we drove on 1st European Business Analysis Day</a></li>
<li><a href="../461899/index.html">Event Generation, CQRS and Laravel</a></li>
<li><a href="../4619/index.html">Public key cryptography is 30 years old</a></li>
<li><a href="../46190/index.html">Photos of paper "AMERO" which will replace the dollar with the spring!</a></li>
<li><a href="../461903/index.html">Mysterious adversary: ‚Äã‚Äãfuzzy borrowing</a></li>
<li><a href="../461905/index.html">Tic Tac Toe, part 7: pytest and Travis CI</a></li>
<li><a href="../461909/index.html">How interesting have you lived? Compare with the average reader Habr. Evil test by vdsina</a></li>
<li><a href="../461913/index.html">Mobile usability in e-Commerce: analysis of the TOP-20 online stores in Russia</a></li>
<li><a href="../461919/index.html">Reusing forms on React</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>