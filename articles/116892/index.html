<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-threaded application under Tornado</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The documentation for a non-blocking web server Tornado beautifully describes how great it is to cope with the load, and in general is the crown of hu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-threaded application under Tornado</h1><div class="post__text post__text-html js-mediator-article"><img src="http://www.tornadoweb.org/static/tornado.png"><br><br>  The documentation for a non-blocking web server <a href="http://www.tornadoweb.org/documentation">Tornado</a> beautifully describes how great it is to cope with the load, and in general is the crown of human creation in the field of non-blocking servers.  This is partly true.  But when building complex applications beyond the framework of ‚Äúone more chat,‚Äù many unobvious and subtle points come to light, which we should know about before the trip to the rake.  Under the "cut" the developers of the club of intellectual games <a href="http://trellis-club.com/ru/">Trellis</a> are ready to share their thoughts about the pitfalls. <br><a name="habracut"></a><br>  Immediately make a reservation that we are talking about the second branch of python, the latest version of tornado 1.2.1, and postgresql, connected via psycopg2. <br><br><h2>  Application instance </h2><br>  Many programmers love to use the antiton singleton pattern for quick access. <br>  to the instance class of the application.  If we think of further horizontal scaling, <br>  This is not recommended.  The request object will bring you thread-safe <br>  application on a platter that can be used without the risk of shooting yourself a leg in <br>  unexpected place. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Websockets </h2><br>  Alas and ah.  Everyone's favorite nginx does not know how to proxy the websocket protocol.  For fans of ‚Äúlaiti‚Äù, there is also little good news in this regard.  Many praise ha-proxy, but in our case it turned out to be more convenient to move all the static to another node with honest nginx, and to give all dynamic content to the tornado-server itself.  Six months of life under, sometimes stressful loads, have shown that this solution is quite viable.  If a flash strip is used for emulating the ws protocol, then it should be sent from the same domain to avoid switching to the insecure version.  The solution with a gasket also requires flash policy xml, which can be given from port 843 by the same nginx. <br><br><h2>  Connect to database </h2><br>  Obviously, on loaded services, there can be no talk about terribly expensive connection operations with a base for every other person.  It is quite possible to use the simplest pool of connections from psycopg2.  We immediately take a thread-safe ThreadedConnectionPool from which we choose connections as necessary, and after the end of the requests we do not forget to return them back.  By "do not forget to return" means never forget.  Whatever the exception we have happened inside.  Using python finally constructs is more than appropriate. <br><br><h2>  Asynchronous requests </h2><br>  In single-threaded non-blocking servers, everything looks beautiful, exactly as long as you do not have to perform some kind of relatively long action.  Send a letter, make a selection from the database, send a request to an external web service, etc. In this case, all other connected clients will dutifully wait for the handler's turn to reach them. <br><br>  If all you need in the request handler is to simply jerk the base and output something, then you can use the asynchronous wrapper <a href="https://github.com/FSX/momoko">momoko</a> .  Then the simplest query will look something like this: <br><br><pre> <code class="hljs python"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseHandler)</span></span></span><span class="hljs-class">:</span></span> @tornado.web.asynchronous <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.db.execute(<span class="hljs-string"><span class="hljs-string">'SELECT 4, 8, 15, 16, 23, 42;'</span></span>, callback=self._on_response) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_on_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cursor)</span></span></span><span class="hljs-function">:</span></span> self.write(<span class="hljs-string"><span class="hljs-string">'Query results: %s'</span></span> % cursor.fetchall()) self.finish()</code> </pre><br><br><h2>  Secure multithreading </h2><br>  So, for the base and for external web services there are asynchronous means.  But what to do if you need to perform a large piece of work from many sql queries, something to count the cumbersome in the depths of the server, and even load the disk i / o subsystem?  Of course, we can concoct bunches of asynchronous callback functions in the worst twisted traditions, but this is exactly what I would like to get away from. <br><br>  Here, it seemed, would be the use of standard threading.  But the use of regular python threads will lead to monstrous glitches and catastrophic results on production under load.  Yes Yes.  On the development machines, everything will work fine.  Usually in such cases, programmers begin to pray for GIL, and frantically wrapping all that is possible and what is impossible with locks.  But the problem is that not all of the tornado is thread-safe.  In order to get around this neatly, you need to process the http request in several stages. <br><br><ol><li>  Decorate your get / post function via <a href="https://habrahabr.ru/users/tornado/" class="user_link">tornado</a> .web.asynchronous </li><li>  Accept the request, check the input parameters if any, and store them in the request instance. </li><li>  Run the stream from the query class member function </li><li>  Do all the work inside this function by carefully applying locks when the shared data changes </li><li>  Call a callback that will do the final _finish () process with the data already prepared. </li></ol><br>  For these purposes, you can write a small mixin: <br><br><pre> <code class="hljs rust">class ThreadableMixin: def start_worker(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>): threading.Thread(target=<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.worker).start() def worker(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>): try: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>._worker() except tornado.web.HTTPError, e: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_status(e.status_code) except: logging.error(<span class="hljs-string"><span class="hljs-string">"_worker problem"</span></span>, exc_info=True) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.set_status(<span class="hljs-number"><span class="hljs-number">500</span></span>) tornado.ioloop.IOLoop.instance().add_callback(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.async_callback(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.results)) def results(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.get_status()!=<span class="hljs-number"><span class="hljs-number">200</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.send_error(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.get_status()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hasattr(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'res</span></span>'): <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.finish(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.res) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hasattr(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">'redir</span></span>'): <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.redirect(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.redir) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.send_error(<span class="hljs-number"><span class="hljs-number">500</span></span>)</code> </pre><br><br>  And in this case safe multi-threaded request processing will look simple and elegant: <br><br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Handler(tornado.web.RequestHandler, ThreadableMixin): def _worker(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.res = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.render_string(<span class="hljs-string"><span class="hljs-string">"template.html"</span></span>, title = _(<span class="hljs-string"><span class="hljs-string">"Title"</span></span>), data = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.application.db.query(<span class="hljs-string"><span class="hljs-string">"select ... where object_id=%s"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object_id) ) @tornado.web.asynchronous def get(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, object_id): <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.object_id = object_id <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.start_worker()</code> </pre><br><br>  If we need a redirect, then in _worker () we set the self.redir variable to the desired url.  If you need json for ajax request, then in self.res instead of the generated page we assign the generated dict with the data. <br><br>  Another point is related to python C extensions.  When using any external libraries in call flows, be sure to verify their thread-safe status. <br><br><h2>  Batch processes </h2><br>  Often it is necessary to start a function after a specific time  This includes user timeouts, game process implementation, system maintenance procedures, and much more.  For these purposes, so-called "periodic processes" are used. <br><br>  Traditionally, regular threading.Timer is used to organize periodic processes in python.  If we try to use it, then again we will get a certain number of subtle problems.  For these purposes, ioloop.PeriodicCallback is provided in the tornado.  Please use it always instead of regular timers.  This will save a lot of time and nerves for the above reasons. <br><br><h2>  Localization and other </h2><br>  In conclusion, let me give you some tips that are not related to multi-threaded processing, but sometimes sometimes significantly improve the performance of a spread application. <br><br><ol><li>  Do not use the built-in tornado stub for localization.  Tornado perfectly knows how to make a standard gettext and gives with it much better results on large amounts of translations. </li><li>  Cache in memory all that is possible.  Forget memcached &amp; co.  You do not need it.  Already in the design process, you need to know on which hardware platform your application will run.  The extra couple of gigabytes of memory in the server can fundamentally change the approach to a particular caching strategy. </li><li>  If the time of page generation is entirely dependent on the data in the system and you cannot know its limits in advance - always postpone the new stream for this request. </li><li>  Despite the fact that the Tornado is very fast, always give static by means intended for this.  For example nginx.  You just can‚Äôt imagine what the i7 / 16Gb / SAS server with FreeBSD / amd64 and nginx onboard is capable of in static sharing.  Faster nothing can be just physically. </li></ol><br><br><h2>  Result </h2><br>  With load testing, 5000 simultaneous connections that are actively playing on the site (and this is thousands of websocket messages per second) server pulls without problems (LA ~ = 0.2, the server process eats up about 400Mb of memory with free 8Gb).  150 real players online, having fun writing bullets, the server doesn‚Äôt notice at all (zero load and huge power margin). <br><br>  At the front, it looks like this: <br><br> <a href="http://trellis-club.com/ru/"><img src="https://habrastorage.org/getpro/habr/post_images/fd0/e83/888/fd0e838888cf8c929290c70bb182cdd1.jpg"></a> <br><br>  And may the force be with you! </div><p>Source: <a href="https://habr.com/ru/post/116892/">https://habr.com/ru/post/116892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116886/index.html">Work with monitors via WinAPI</a></li>
<li><a href="../116887/index.html">Current state of high technology</a></li>
<li><a href="../116889/index.html">[Translation] Theft of data due to the latest features of Windows and Mac OS X</a></li>
<li><a href="../116890/index.html">Acoustics. Orthodynamic Emitters</a></li>
<li><a href="../116891/index.html">Boodler Sound Landscape Generator</a></li>
<li><a href="../116893/index.html">Mangrove, Ventech Capital and ABRT have invested in oktogo.ru</a></li>
<li><a href="../116894/index.html">Nginx + uWSGI + Django, one of the launch options</a></li>
<li><a href="../116895/index.html">Service development: Classmates, VKontakte, ethics vs. aesthetics</a></li>
<li><a href="../116896/index.html">PHPUnit && ordered tests</a></li>
<li><a href="../116898/index.html">Run third-party code in the sandbox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>