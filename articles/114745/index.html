<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Continuous Python Test Testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The programmer is a lazy beast, so everything that will be done more than once must be scripted. 

 I have been picking TDD for some time and the task...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Continuous Python Test Testing</h1><div class="post__text post__text-html js-mediator-article"> The programmer is a lazy beast, so everything that will be done more than once must be scripted. <br><br>  I have been picking <a href="http://welinux.ru/tag/tdd">TDD</a> for some time and the task of constant quality control becomes more and more important for me.  Especially when adding new developers to the team. <br><br>  First, I ran the tests with my hands: save, switch, $ nosetests.  Then code quality checks were added to the tests and I had to put everything into the script: <br> <code>pyflakes *.py <br> pep8 *.py <br> pylint *.py <br> nosetests</code> <br> <br>  It‚Äôs terribly lazy to run the script every time, so a small shell on inotifywait started running tests and checks after each save: <br> <code>while true; do <br> inotifywait -e modify project/*.py -qq; clear <br> ./do_tests <br> done</code> <br> <br>  Then I became more or less pleased with what was happening and even relaxed for a while.  But after all, the programmer, besides being lazy, is also proud, so I want to show the results to someone.  To keep a history of what is happening (which helps a lot when the boss comes in and asks, ‚Äúwell, what have you been doing for the last month?‚Äù) There is already a version control system.  But it only shows what has been done and does not give an overview of the success of each revision.  It turns out that the code is lying, but it is not clear in what condition it is and what else it is necessary to do. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition, it is rather difficult to follow colleagues who can also do something and forget to run tests, as a result, the repository contains broken code that did not pass code review, and during the next pull, clusterfuck can suddenly start. <br><br>  And here, very soon, kmmbvnr @ lj released a <a href="http://narod.ru/disk/6361429001/out.ogv.html">screencast</a> in which he demonstrated test integration for django-projects with the Jenkins (formerly Hudson) subject.  I looked at all these beauties, charts and reports and also wanted everything to sing and play.  But he has django-jenkins, as the name implies, embedded in jungle and generate reports using a clever system.  My project is not old enough, and most likely it will not grow - this is a rather trivial WSGI application that is growing rapidly.  I had to lift everything from scratch. <br><br>  Sunday I killed it, but on the whole, everything is pretty straightforward, and now I have pretty reports: <br><br> <a href="http://imgur.com/LinZT" title="Hosted by imgur.com"><img src="https://habrastorage.org/getpro/habr/post_images/db2/157/b1a/db2157b1a247bee32884e085b6dabe14.jpg" title="Hosted by imgur.com"></a> <br><br>  <b>What's inside?</b> <br><a name="habracut"></a><br>  0) Automatic getting fresh versions of turnips.  The system is very tightly integrated with the mercurial, so all edits and commit messages are visible and accessible there. <br><br>  1) Build a project from scratch, as if it were rolled out to a combat server.  The environment is created, modules are pumped out and put in, and so on.  The system itself is located on the server of the developers in the conditions close to the battle ones: frya, isolation of Python projects, hemorrhage with installation. <br><br>  2) Run the tests.  Together with them, verification of the test coverage of the code occurs immediately.  As a result, files of reports about swamped tests and coverage are created.  The green chart on top - the number of test scores is shown in the same red.  The bottom chart shows the coverage.  Coverage can be viewed directly in the files with backlit unchecked lines. <br><br>  3) A quality check is performed: pep8 and pylint carefully put pressure on the developer‚Äôs brains, seeking order in code, variable names and other things.  Red broken line, which will always be like hinting that it would be time to take out the garbage. <br><br>  4) The developer who commits the broken code will be automatically spoiled by the system in email and jabber (personally and in MUC), and then by the lead programmer, who will also receive a similar complaint.  Because no one expects the Spanish Inquisition! <br><br>  As a result, we have a system that takes on a large part of the routine with several people at once. <br><br>  <b>Give two!</b> <br><br>  The system itself comes in the form of a <a href="http://mirrors.jenkins-ci.org/war/latest/">java / war package</a> .  You do not need to install anything, but you will need a JRE (under Frew, I installed Diablo-1.6).  On the <a href="http://jenkins-ci.org/">site,</a> you can poke a link and immediately run it at home.  It starts simply: java -jar jenkins.war.  There are still options for specifying ports and all that.  I recommend to bind on lokalkhost and wrap in nginx.  Who knows what?  From the root to run strongly advise not. <br><br>  On the fra, it refused to demonize me, so I wrapped it in <a href="http://supervisord.org/">supervisor</a> .  Then he was still useful.  Installing is simple - pip install supervisord. <br><br>  All settings are made already from the browser after starting the Manage Jenkins menu. <br><br>  The first step is to plug in the plugins.  They swing and put themselves, you just need to place a tick. <br><ul><li>  Jenkins Cobertura Plugin - test coverage reports </li><li>  Hudson instant-messaging plugin - notifications.  Need for jabber.  Well, or not needed, if you do not put it. </li><li>  Hudson Jabber notifier plugin - the gill itself. </li><li>  Hudson Mercurial plugin - integration with the repository. </li><li>  Hudson Violations plugin - pylint handler </li></ul><br>  I have disabled the rest of the ones already installed, for nefig. <br><br>  Some plugins without restarting will not appear in the settings. <br><br>  <b>Settings</b> <br><br>  Immediately it is worth doing enable security, and choose the appropriate authorization method.  I took the "Project-based Matrix Authorization Strategy".  You do not need to create a user, but you need to restart.  When you re-enter, you will be prompted to admin immediately.  It‚Äôs better to call it admin.  Otherwise, then you can get confused as to who is who, because it keeps a list of project participants looking at the commits. <br><br>  ‚ÄúPrevent Cross Site Request Forgery exploits‚Äù is a good thing, but it didn‚Äôt work for me, I had to turn it on. <br><br>  JDK and other ‚Äúinstallations‚Äù do not need to be configured, everything works as it is. <br><br>  Shell executable should be set to / usr / local / bash or / usr / bin / bash.  In short, the full path to the shell, and then you never know what it will run there ... With a strong desire, you can even assign a python, but this is inconvenient. <br><br>  Jabber and Email section will help you configure the Cap and the Advanced button. <br><br>  <b>Project Setup</b> <br><br>  Which here are called Job.  Specify the job name and mark ¬´free-style¬ª.  Then the most delicious, to which I killed half the weekend. <br><br>  I have a lot of builds and I do them often, so it seemed logical to set a storage limit of 10 pieces / 30 days.  If that - you can always click Build Now. <br><br>  I put the code on a private turnip in <a href="http://bitbucket.org/">bitbucket</a> because they are free and pretty fachasty at the same time.  Git I dislike  a pythonist on his head and githab does not have free private rap. <br><br>  The Repository URL will be like this (yes, it is necessary to pass authorization in it, which is why your installation of jenkins should be immediately password-protected): [code] https: // username: password@bitbucket.org/username/uniproxy [/ code] <br><br>  Repository Browser - bitbucket. <br><br>  Build triggers - poll SCM.  Schedule in cron format: [code] * / 5 * * * * [/ code] <br>  Probably one could still do the trigger remotely, but I'm too lazy.  Well, then every developer needs to later carry configs with this trigger ... And the basket is always in the same place and is accessible everywhere. <br><br>  <b>Steps of the <s>Inquisition</s> Execution</b> <br><br>  Project files are organized as follows: <br> <code>. <br> buildenv.sh <br> pip-reqs.txt <br> pylint.rc <br> project/*.py <br> reports/* <br> venv/*</code> <br>  The last two are created by the script.  I laid out the main ones <a href="https://gist.github.com/847813">on the githaba</a> . <br><br>  In the screencast, I saw that everything was in one step, but I decided to break it down into three logical ones: build, check, test. <br><br>  The first one is quite simple: ‚Äú./buildenv.sh‚Äù is the one that lies in the project and prepares virtualenv.  It would be possible to copy it here, but this is not a trude DRY.  would have to keep duplicates of the same. <br><br>  The second is more complicated: <br> <code>#!/usr/local/bin/bash <br> venv/bin/pep8 --repeat --ignore=E501,W391 project | perl -ple 's/: ([WE]\d+)/: [$1]/' &gt; reports/pylint.report <br> venv/bin/pylint --rcfile pylint.rc project/*.py &gt;&gt; reports/pylint.report <br> echo "pylint complete"</code> <br> <br>  The first and last lines are connected with the fact that if pylint finds something to complain about, then the whole step will be considered overwhelmed.  And pylint is worse than the most evil teacher, ALWAYS will find something to complain about.  In the config to it I registered that some errors are not interesting to me.  pep8 complements pylint, but pays more attention to design.  Some warnings are disabled (the length of the lines checks pylint and there it is set in the config). <br><br>  Please note that all scripts run from venv, which were installed in the previous step.  If something falls apart there, everything else will collapse and a big red ball will hang on the board of shame. <br><br>  The third one runs the tests and collects the coverage: <br> <code>venv/bin/coverage run --include 'project/*.py' project/tests.py --with-xunit --xunit-file=reports/tests.xml --where=project <br> venv/bin/coverage xml -o reports/coverage.xml</code> <br> <br>  Here you have to be very careful with the paths.  If they are not from the repository root, but from the project, the display of the line coverage will not work.  can not find the source.  After thoughtful smoking options, googling and commenting, I still picked up the working version. <br><br>  <b>Reports</b> <br><br>  Metrics are collected, now they need to download and show.  It can still do a lot of useful things there, but now we are simply abusing it on the subject of beautiful graphs.  Before the first build, it will say that there are no such report files, but this is not a problem. <br><br>  We include the ‚ÄúPublish JUnit test result report‚Äù and, although they are not any JUnit, we specify the nosetests ** / reports / tests.xml, which means ‚Äúfrom the turnip / task root in the reports catalog. <br><br>  The next item is ‚ÄúReport Violations‚Äù and there is pylint.  Despite the fact that the name of the field is ‚ÄúXML filename pattern‚Äù, and pylint does not produce any xml, we also indicate the file ** / reports / pylint.report where they pair the pep8 developers in every possible way criticize the sloppy developers‚Äôs code .  This is very helpful in the morning to get involved in the work: he came, looked at the schedule of violations and while he corrected, even though he remembered what he wrote yesterday. <br><br>  Well, the last.  The Publish Cobertura Coverage Report is in ** / reports / coverage.xml.  I have no idea what Cobertura is, but it understands the Python coverage format correctly. <br><br>  With pylint and coverage, you can set the boundaries of "weather", which will affect the overall state of the project.  Default values ‚Äã‚Äãseem to fit. <br><br>  <b>Koder bird proud - do not kick, do not fly</b> <br><br>  At the very end there are notifications via email and jabber, you can customize to taste.  The only thing is that they must first be configured in the main integration server config, otherwise it will not work. <br><br>  <b>Let's go and waved his hand</b> <br><br>  Settings are recorded, you can send to the assembly.  Either manually through the Build Now button, or by committing and pushing something into the turnip.  At the bottom of the sidebar, a new task and a progress slider will appear in the Build History by clicking on which you can go to the ‚ÄúConsole Output‚Äù section of the current build and watch it live.  When everything is finished, in the Status there will be all sorts of things on which you can climb and see how what is where. <br><br>  <b>Bonus!</b> <br><br>  Each time recreating the venv it pumps all the modules with pypi and does it for a very long time.  In addition, it is traffic.  With a bit of searching, I found in pypi <a href="http://pypi.python.org/pypi/collective.eggproxy">collective.eggproxy</a> , which caches the proxy repository that mimics pypi.python.org/simple.  Runs simply as `eggproxy_run`.  It has no help and by default it puts everything in / var / www, which is not good.  After reading its docks on the site, you can learn how to make a config file to configure the paths and ports.  It also did not want to be demonized, so after Jenkins the supervisord was sent into the arms. <br><br>  buildenv.sh is already trained to adapt to the presence / absence of this proxy, everything is simple. <br><br>  <b>Credits</b> <br><br>  <a href="http://kmmbvnr.livejournal.com/75183.html">kmmbvnr @ lj: How to start testing and getting pleasure from it</a> .  In addition to integration with Jenkins, <a href="https://github.com/kmmbvnr/django-any">django-any</a> is also described.  All dzhangistam strongly recommend to read and use. <br><br>  <a href="http://www.rhonabwy.com/wp/2009/11/04/setting-up-a-python-ci-server-with-hudson/">Setting up a python CI server with Hudson</a> , a still up-to-date post with the right advice, based on which this interpretation of mine was made. <br><br>  Even for testing the project, a <a href="http://pythonpaste.org/webtest/">simple wrapper over WSGI applications was used</a> , which allows you to test and debug without wsgi-containers and manual work in a browser without too much hemorrhoids. </div><p>Source: <a href="https://habr.com/ru/post/114745/">https://habr.com/ru/post/114745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../114733/index.html">SeekBar in the application settings</a></li>
<li><a href="../114735/index.html">Yaber.ru - another e-commerce model</a></li>
<li><a href="../114736/index.html">Natalie Portman - a scientist</a></li>
<li><a href="../114737/index.html">Dangers of optional javascript arguments</a></li>
<li><a href="../114740/index.html">Manual control</a></li>
<li><a href="../114746/index.html">How VKontakte takes domains from users</a></li>
<li><a href="../114749/index.html">Introduction to Cappuccino</a></li>
<li><a href="../114750/index.html">Congratulate your friend hoster!</a></li>
<li><a href="../114751/index.html">How the payment reception companies in Ukraine work</a></li>
<li><a href="../114752/index.html">Apple Magic Trackpad in the office and at home</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>