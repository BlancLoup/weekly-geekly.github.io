<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two giants in one program - Nvidia CUDA and MPI</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello habrovchane, in this article I want to talk about the interaction of the two technologies MPI (mpich2) and NVIDIA CUDA. I want to focus on the v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two giants in one program - Nvidia CUDA and MPI</h1><div class="post__text post__text-html js-mediator-article">  Hello habrovchane, in this article I want to talk about the interaction of the two technologies MPI (mpich2) and NVIDIA CUDA.  I want to focus on the very structure of the program and the configuration of the above-described technologies for working in one program.  And so it went ... <br><img src="https://habrastorage.org/storage2/21d/62a/17c/21d62a17c1c919f3c3fa5e76046739fc.jpg"><br><a name="habracut"></a><br>  For convenience, I wrote a small plan for which we will move: <br>  1) Preparing the system for work. <br>  2) Install the mpich2 library. <br>  3) Installing NVIDIA CUDA. <br>  4) Writing program code (program structure) <br>  5) Setting the compiler. <br>  6) Compiling and running the executable file. <br><br><h5>  Paragraph 1 </h5>  Perhaps it was worth calling him something different, but nonetheless.  I use the Ubuntu 12.04 operating system and theoretically enough package manager is enough for the whole setup - synaptic <br> <code>sudo apt-get install synaptic</code> <br>  Or, if you wish, you can put everything directly from the terminal. <br><br><h5>  Point 2 </h5>  And so begin.  What is MPI?  I paraphrase <a href="http://ru.wikipedia.org/wiki/MPICH">Wikipedia a</a> bit - it is a kind of API that allows you to exchange data between processes that perform one task.  Simply put, this is one of several parallel programming technologies.  More details can be read on Wikipedia.  We will use MPICH2 - the library in which the MPI standard is implemented, since this library is the most common.  To install it, you need to register in the terminal: <br> <code>sudo apt-get install mpi-default-dev</code> <br> <code>sudo apt-get install mpich2</code> <br> <code>sudo apt-get install libmpich2-dev</code> <br> <br>  Or Alt + f2: <br> <code>gksu synaptic <br></code> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      and register in the search: <br> <code>mpi-default-dev</code> <br> <code>mpich2</code> <br> <code>libmpich2-dev</code> <br> <br><img src="https://habrastorage.org/storage2/092/319/a51/092319a519cf7c7a90917105c97ff5e2.png"><br><br>  Select the found package and install it.  Also, if you wish, you can install other useful packages related to mpi or mpich2 from your point of view.  It is advisable to install the documentation.  Next, we check that we succeeded, create a file test.cpp and add the following code to it: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;mpi.h&gt; #include &lt;iostream&gt; int main (int argc, char* argv[]) { int rank, size; MPI_Init (&amp;argc, &amp;argv); MPI_Comm_rank (MPI_COMM_WORLD, &amp;rank); MPI_Comm_size (MPI_COMM_WORLD, &amp;size); std::cout&lt;&lt;"\nHello Habrahabr!!"&lt;&lt;std::endl; MPI_Finalize(); return 0; }</span></span></span></span></code> </pre><br>  Compile it: <br> <code>mpic++ test.cpp -o test</code> <br> <br>  Run: <br> <code>mpirun.mpich2 -l -n 8 ./test <br></code> <br><br>  It should end up with something like this: <br><img src="http://habrastorage.org/storage2/f85/b6d/715/f85b6d715ce3e1ca8f2a6021666f158b.png"><br><br><h5>  Point 3 </h5>  I described this process in my last <a href="http://habrahabr.ru/post/146541/">post</a> . <br><br><h5>  Point 4 </h5>  Suppose we have a habr folder, create the following files in it: <br>  main.cu <br>  head.h // here will be header files. <br>  GPU.cu // code intended for gpu. <br>  CPU.cpp // code intended for the processor. <br><br>  main.cu - here we will write the simplest mpi code that will serve to run the program on several cores.  In the functions of gpu and cpu, the usual multiplication occurs, with the only difference that in the function gpu multiplication occurs on the video map. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"head.h"</span></span></span><span class="hljs-meta"> int main(int argc, char* argv[]){ int rank, size; int x = 9999; int y = 9999; MPI_Init (&amp;argc, &amp;argv); MPI_Comm_rank (MPI_COMM_WORLD, &amp;rank);</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   MPI_Comm_size (MPI_COMM_WORLD, &amp;size);//  int res_gpu = gpu(x, y); int res_cpu = cpu(x, y); std::cout&lt;&lt;"res_gpu = "&lt;&lt;res_gpu&lt;&lt;std::endl; std::cout&lt;&lt;"res_cpu = "&lt;&lt;res_cpu&lt;&lt;std::endl; MPI_Finalize(); return 0; }</span></span></span></span></code> </pre><br><br>  head.h - here we will describe the necessary inclusions. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include &lt;mpi.h&gt; #include &lt;cuda.h&gt; #include "CPU.cpp" #include "GPU.cu"</span></span></span></span></code> </pre><br><br>  GPU.cu - directly a code that multiplies two numbers on a video card. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cuda.h&gt; #include &lt;iostream&gt; #include &lt;stdio.h&gt; __global__ void mult(int x, int y, int *res) { *res = x * y; } int gpu(int x, int y){ int *dev_res; int res = 0; cudaMalloc((void**)&amp;dev_res, sizeof(int)); mult&lt;&lt;&lt;1,1&gt;&gt;&gt;(x, y, dev_res); cudaMemcpy(&amp;res, dev_res, sizeof(int), cudaMemcpyDeviceToHost); cudaFree(dev_res); return res; }</span></span></span></span></code> </pre><br><br>  CPU.cpp - this code is more likely to check the multiplication of what is happening by the GPU and, in principle, it does not carry any more utility. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> res; res = x * y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; }</code> </pre><br>  The created files are put in the ../src folder.  The result should be something like this: <br><img src="http://habrastorage.org/storage2/5bf/ee4/348/5bfee4348541a3ee43088e81ec1e2d46.png"><br><br><h5>  Point 5 </h5>  The most interesting thing here is that you need to configure the nvcc compiler to compile not only CUDA code, but also MPI code, for this we will write a small make file: <br><pre> <code class="cmake hljs">CXX = nvcc LD = $(CXX) LIBS_PATH = -L/usr/lib LIBS = -lmpi -lopa -lmpl -lrt -lcr -lpthread INCLUDE_PATH = -I/usr/lib/mpich2/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>/ FLAGS = -g <span class="hljs-keyword"><span class="hljs-keyword">TARGET</span></span> = <span class="hljs-string"><span class="hljs-string">"/home/relaps/habr/src/main.cu"</span></span> OBIN = <span class="hljs-string"><span class="hljs-string">"/home/relaps/habr/bin/cuda&amp;mpi"</span></span> all: $(<span class="hljs-keyword"><span class="hljs-keyword">TARGET</span></span>) $(<span class="hljs-keyword"><span class="hljs-keyword">TARGET</span></span>): $(LD) $(INCLUDE_PATH) $(FLAGS) $(<span class="hljs-keyword"><span class="hljs-keyword">TARGET</span></span>) -o $(OBIN) $(LIBS_PATH) $(LIBS)</code> </pre><br>  And so now you just need to go to the folder with the project and collect it. <br><br><h5>  Item 6 </h5>  Here I think the comments are superfluous in the screenshot. <br>  We collect: <br><img src="http://habrastorage.org/storage2/54b/944/a50/54b944a50d845cef0176afea5bedcc38.png"><br><br>  Run, it turns out something like this: <br><img src="http://habrastorage.org/storage2/c8f/642/6ee/c8f6426ee4df69f340370d03d2d151cd.png"><br><br>  Well, actually this is the end of the work, in the end we got a program that involved both a video card and several processor cores.  Of course, the example of multiplying two numbers presented in this context is completely irrelevant for these technologies, but I repeat - I set myself the task of showing that mpi and cuda can coexist in one program (I think that the code is elementary except for the cuda and mpi directives therefore, I didn‚Äôt explain it much).  Naturally, if you take a more complex program, then there are many nuances at once, ranging from cluster structure, etc., you can continue for a long time, each such program requires individual consideration.  But in the end it's worth it. <br><br>  ps In the next post, most likely, I will try to tell you about the basics of nvidia cuda. </div><p>Source: <a href="https://habr.com/ru/post/150701/">https://habr.com/ru/post/150701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../150693/index.html">"Custom scripts can only be added from the Chrome Web Store"? No, not only</a></li>
<li><a href="../150695/index.html">Tracking changes in the properties of the Js object using dirtyFlag from the KoLite package</a></li>
<li><a href="../150697/index.html">Workflow Optimization in Adobe Fireworks using Extensions</a></li>
<li><a href="../150698/index.html">Release Ubuntu 12.04.1</a></li>
<li><a href="../150700/index.html">How does sorting work with Reddit</a></li>
<li><a href="../150702/index.html">What is hidden under the ranking algorithm in the Apple App Store? Habra Quest</a></li>
<li><a href="../150703/index.html">Philips at IFA 2012</a></li>
<li><a href="../150704/index.html">The founder of The Pirate Bay was arrested in Cambodia</a></li>
<li><a href="../150705/index.html">Future in event organization</a></li>
<li><a href="../150706/index.html">Comet server on Erlang</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>