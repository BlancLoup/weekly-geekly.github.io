<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Our recipe for a fault-tolerant VPN-server based on tinc, OpenVPN, Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of our clients asked us to develop a fail-safe solution for organizing secure access to its corporate services. The decision was to: 



- provide...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Our recipe for a fault-tolerant VPN-server based on tinc, OpenVPN, Linux</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/f3a/851/a68/f3a851a68dfd4f228fa3a204ded89173.png"><br><br>  One of our clients asked us to develop a fail-safe solution for organizing secure access to its corporate services.  The decision was to: <br><br><ul><li>  provide fault tolerance and redundancy; </li><li>  easy to scale; </li><li>  easily and quickly solve the problem of adding and blocking VPN users; </li><li>  balance the load between the input nodes; </li><li>  work equally well for clients on GNU / Linux, Mac OS X and Windows; </li><li>  support clients that are behind NAT. </li></ul><br>  There were no ready-made solutions satisfying all the set conditions.  Therefore, we collected it on the basis of popular Open Source-products, and now we are happy to share the result obtained in this article. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Concept development </h2><br>  On the client side, we chose OpenVPN as the base VPN technology: it works perfectly through NAT and supports all the required platforms. <br><br>  It was decided to deploy OpenVPN in the TLS server mode, and add and block users in it using the <a href="https://github.com/OpenVPN/easy-rsa">easy-rsa</a> package, which allows you to create a key and a certificate, and then revoke them if necessary. <br><br>  The hardest thing was to solve the issue of scaling, redundancy and fault tolerance. <br><br>  The final solution was simple and elegant.  We decided to use N input nodes whose addresses using round-robin DNS are given to clients.  All nodes and customer service nodes are included in a single <a href="https://www.tinc-vpn.org/">tinc VPN</a> L2 space.  Client connections (also L2) are combined with a tinc-interface into the bridge.  Thus, it turns out that when connecting via OpenVPN, the client gets to a random node and ends up in a single L2 network with all other clients, nodes and client services. <br><br><img src="https://habrastorage.org/web/ca1/7be/2fe/ca17be2fe165454a9863679695398336.png"><br><br>  To implement this scheme, 3 VPS were allocated in various data centers, where it was required to deploy "entry points" to the network ( <code>ep1</code> , <code>ep2</code> and <code>ep3</code> ).  In addition, a hypervisor with client services ( <code>hpv1</code> ) was present on the network.  Ubuntu Server 16.04 installed on all machines. <br><br><h2>  We build tinc VPN </h2><br>  First, install the packages: <br><br><pre> <code class="bash hljs">$ sudo apt-get update &amp;&amp; sudo apt-get install tin</code> </pre> <br>  At this stage, we need to decide on the name of the network - let it be <code>l2vpnnet</code> .  Create a directory structure: <br><br><pre> <code class="bash hljs">$ sudo mkdir -p /etc/tinc/l2vpnnet/hosts</code> </pre> <br>  Create the <code>tinc.conf</code> file in the <code>/etc/tinc/l2vpnnet</code> <code>tinc.conf</code> and fill it with the following contents: <br><br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#    Name = ep1 #  ,    ‚Äî L2 Mode = switch # ,     Interface = tap0 # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">    UDP Port = 655 #     ,      ConnectTo = ep2 ConnectTo = ep3 ConnectTo = hpv1</span></span></code> </pre> <br>  Create the <code>/etc/tinc/l2vpnnet/ep1</code> and <code>/etc/tinc/l2vpnnet/ep1</code> parameters into it: <br><br><pre> <code class="hljs 1c"><span class="hljs-meta"><span class="hljs-meta">#     Address = 100.101.102.103 655 #      Cipher = aes-128-cbc Digest = sha1 # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">       Compression = 0</span></span></code> </pre> <br>  Produce key generation.  Traditionally, we use keys of 2 kilobits long: this key length provides a good balance between the level of privacy and delays (due to the overhead of encryption). <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/tinc/l2vpnnet &amp;&amp; sudo tincd -n l2vpnnet -K2048 Generating 2048 bits keys: ............................................+++ p .................................+++ q Done. Please enter a file to save private RSA key to [/etc/tinc/l2vpnnet/rsa_key.priv]: Please enter a file to save public RSA key to [/etc/tinc/l2vpnnet/hosts/ep1]:</code> </pre> <br>  On the rest of the machines doing the same thing.  Files with a public key and connection parameters ( <code>/etc/tinc/l2vpnnet/hosts/ep1|ep2|ep3|hpv1</code> ) should be placed with all members of the network in the <code>/etc/tinc/l2vpnnet/hosts</code> . <br><br>  The name of the network must be entered into the <code>/etc/tinc/nets.boot</code> file in order for tinc to start the VPN to our network automatically upon boot: <br><br><pre> <code class="bash hljs">$ sudo cat nets.boot <span class="hljs-comment"><span class="hljs-comment">#This file contains all names of the networks to be started #on system startup. l2vpnnet</span></span></code> </pre> <br>  When setting up both tinc VPN and OpenVPN in our company, it is customary to use standard Ubuntu network management mechanisms.  Add a description of <code>tap0</code> device parameters to <code>/etc/network/interfaces</code> : <br><br><pre> <code class="hljs dos">#       auto tap0 #    manual,   IP     bridge iface tap0 inet manual #     tinc pre-up ip tuntap add dev $IFACE <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> tap # ...      post-down ip tuntap <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> dev $IFACE <span class="hljs-built_in"><span class="hljs-built_in">mode</span></span> tap # ,  tinc     tinc-<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> l2vpnnet</code> </pre> <br>  This setting will allow us to manage tinc using ifup / ifdown scripts. <br><br>  For a single L2-space, one must also choose an L3-space.  For example, we will use the network <code>10.10.10.0/24</code> .  We will configure the bridge interface and assign it an IP - for this we enter in <code>/etc/network/interfaces</code> such information: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">auto</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">br0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">br0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inet</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">static</span></span> # , <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span>      <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> # ,      <span class="hljs-selector-tag"><span class="hljs-selector-tag">tinc</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_ports</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tap0</span></span> #   <span class="hljs-selector-tag"><span class="hljs-selector-tag">spanning</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tree</span></span>  <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_stp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">off</span></span> #      <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_maxwait</span></span> 5 #     <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_fd</span></span> 0</code> </pre> <br>  After that, we start both devices on all servers and check connectivity with any diagnostic tool (ping, mtr, etc.): <br><br><pre> <code class="bash hljs">$ sudo ifup tap0 &amp;&amp; sudo ifup br0 $ ping -c3 10.10.10.2 PING 10.10.10.2 (10.10.10.2) 56(84) bytes of data. 64 bytes from 10.10.10.2: icmp_seq=1 ttl=64 time=3.99 ms 64 bytes from 10.10.10.2: icmp_seq=2 ttl=64 time=1.19 ms 64 bytes from 10.10.10.2: icmp_seq=3 ttl=64 time=1.07 ms --- 10.10.10.2 ping statistics --- 3 packets transmitted, 3 received, 0% packet loss, time 2002ms rtt min/avg/max/mdev = 1.075/2.087/3.994/1.349 ms</code> </pre> <br>  Excellent: L2 space for input nodes and target server is built.  Now you need to add remote clients to it. <br><br><h2>  Configuring OpenVPN </h2><br>  First, install the necessary packages on all servers: <br><br><pre> <code class="bash hljs">$ sudo apt-get update &amp;&amp; sudo apt-get install openvpn easy-rsa</code> </pre> <br>  Configure the DNS zone, add 3 A-records with the same name of the VPN service: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ny</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">IN</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 100<span class="hljs-selector-class"><span class="hljs-selector-class">.101</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.102</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.103</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ny</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">IN</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.51</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.52</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vpn</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.compa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ny</span></span>. <span class="hljs-selector-tag"><span class="hljs-selector-tag">IN</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">A</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> <br>  DNS will be the first load balancing mechanism in our system.  According to the documentation, OpenVPN resolves the name of the connection point and will consistently make attempts to connect to all IPs to which the name resolves.  DNS will then give a list of IP in random order. <br><br>  The second load balancing mechanism will be the limit on the maximum number of connections per server.  Suppose we have about 50 users.  Taking redundancy into account, we will put a limit of 30 users on the server and distribute the pools of IP addresses as follows: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Node</span></span> 1 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.100-10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.129</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Node</span></span> 2 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.130-10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.159</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Node</span></span> 2 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.160-10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.189</span></span></code> </pre> <br>  Create an environment for CA: <br><br><pre> <code class="hljs dos">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/openvpn $ sudo -s # make-cadir ca # <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> keys # chmod <span class="hljs-number"><span class="hljs-number">700</span></span> keys # <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> <br>  Now edit the file with <code>vars</code> variables, setting the following values: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   easy-rsa export EASY_RSA="`pwd`" #   openssl, pkcs11-tool, grep export OPENSSL="openssl" export PKCS11TOOL="pkcs11-tool" export GREP="grep" #  openssl export KEY_CONFIG=`$EASY_RSA/whichopensslcnf $EASY_RSA` #    export KEY_DIR="$EASY_RSA/keys" export PKCS11_MODULE_PATH="dummy" export PKCS11_PIN="dummy" #   export KEY_SIZE=2048 # CA-   10  export CA_EXPIRE=3650 #   : , , # , , e-mail   export KEY_COUNTRY="RU" export KEY_PROVINCE="Magadan region" export KEY_CITY="Susuman" export KEY_ORG="Company" export KEY_EMAIL="info@compa.ny" export KEY_OU="IT" export KEY_NAME="UnbreakableVPN"</span></span></code> </pre> <br>  Save and start generating keys: <br><br><pre> <code class="hljs vhdl"># . vars # ./clean-<span class="hljs-keyword"><span class="hljs-keyword">all</span></span> # ./build-ca Generating a <span class="hljs-number"><span class="hljs-number">2048</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bit</span></span> RSA private key ..........................+++ .+++ writing <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> private key <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-symbol"><span class="hljs-symbol">'ca</span></span>.key' <span class="hljs-comment"><span class="hljs-comment">----- You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [RU]: State or Province Name (full name) [Magadan region]: Locality Name (eg, city) [Susuman]: Organization Name (eg, company) [Company]: Organizational Unit Name (eg, section) [IT]: Common Name (eg, your name or your server's hostname) [Company CA]: Name [UnbreakableVPN]: Email Address [info@compa.ny]: # ./build-dh Generating DH parameters, 2048 bit long safe prime, generator 2 This is going to take a long time ‚Ä¶ # ./build-key-server server # openvpn --genkey --secret keys/ta.key</span></span></code> </pre> <br>  Create a test user and immediately revoke his certificate to create a revocation list: <br><br><pre> <code class="hljs pgsql"># ./build-key testuser # ./<span class="hljs-keyword"><span class="hljs-keyword">revoke</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">full</span></span> testuser</code> </pre> <br>  Copy all the keys needed to configure the server to a directory with OpenVPN key information: <br><br><pre> <code class="hljs pgsql"># cd keys # mkdir /etc/openvpn/.keys # cp ca.crt <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.crt <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.key dh2048.pem ta.key crl.pem /etc/openvpn/.keys # <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> <br>  Prepare the OpenVPN server configuration, for which we will create the <code>/etc/openvpn/server.conf</code> file: <br><br><pre> <code class="hljs pgsql">#     verb <span class="hljs-number"><span class="hljs-number">4</span></span> #     port <span class="hljs-number"><span class="hljs-number">1194</span></span> proto tcp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> #     mode <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> tls-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> #  MTU tun-mtu <span class="hljs-number"><span class="hljs-number">1500</span></span> #     ,     dev ovpn-clients dev-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> tap # ,  TA-     key-direction <span class="hljs-number"><span class="hljs-number">0</span></span> #    cert /etc/openvpn/.keys/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.crt key /etc/openvpn/.keys/<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.key dh /etc/openvpn/.keys/dh2048.pem tls-auth /etc/openvpn/.keys/ta.key crl-verify /etc/openvpn/.keys/crl.pem #      auth sha1 cipher AES<span class="hljs-number"><span class="hljs-number">-128</span></span>-CBC # , ,      #      persist-tun #      topology subnet <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>-bridge <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.100</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.129</span></span> #         #  DNS push "redirect-gateway autolocal" push "dhcp-option DNS 10.10.10.200" push "dhcp-option DNS 10.20.20.200" #       <span class="hljs-number"><span class="hljs-number">10</span></span> , #   ‚Äî <span class="hljs-number"><span class="hljs-number">2</span></span>  keepalive <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">120</span></span> #     <span class="hljs-number"><span class="hljs-number">30</span></span>  max-clients <span class="hljs-number"><span class="hljs-number">30</span></span> #    openvpn <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> nobody <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> nogroup #       IP   <span class="hljs-type"><span class="hljs-type">float</span></span> #     <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/openvpn-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre> <br>  For the second and third servers we will use the same set of key information - the configuration files will differ only in the pool of issued IP addresses. <br><br>  By analogy with tinc, we will configure OpenVPN control via standard ifup / ifdown scripts, adding a device description to <code>/etc/network/interfaces</code> : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">auto</span></span> ovpn-clients iface ovpn-clients inet manual pre-up ip tuntap add dev <span class="hljs-variable"><span class="hljs-variable">$IFACE</span></span> mode tap post-up systemctl start openvpn<span class="hljs-variable"><span class="hljs-variable">@server</span></span>.service pre-down systemctl stop openvpn<span class="hljs-variable"><span class="hljs-variable">@server</span></span>.service post-down ip tuntap del dev <span class="hljs-variable"><span class="hljs-variable">$IFACE</span></span> mode tap</code> </pre> <br>  We will enable the interface with the tinc bridge by changing the <code>br0</code> interface settings: <br><br><pre> <code class="hljs css"> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_ports</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tap0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_ports</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ovpn_clients</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bridge_stp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">off</span></span> ...</code> </pre> <br>  We give everything in working condition: <br><br><pre> <code class="bash hljs">$ sudo ifup ovpn-clients &amp;&amp; sudo ifdown br0 &amp;&amp; sudo ifup br0</code> </pre> <br>  Server configuration is ready.  Now we will create client keys and ovpn-file: <br><br><pre> <code class="hljs dos">$ sudo -s # <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/openvpn/ca # ./build-key PetrovIvan # <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> <br>  To simplify use, we will create a client ovpn-file with key information INLINE: <br><br><pre> <code class="bash hljs">$ vim PetrovInan.ovpn <span class="hljs-comment"><span class="hljs-comment">#   ,     client dev tap proto tcp #  MTU  ,     tun-mtu 1500 #      remote vpn.compa.ny 1194 #      nobind # ,         persist-key persist-tun #  MSS mssfix # ,    TA  TLS- key-direction 1 ns-cert-type server remote-cert-tls server auth sha1 cipher AES-128-CBC verb 4 keepalive 10 40 &lt;ca&gt; ###    ca.crt &lt;/ca&gt; &lt;tls-auth&gt; ###    ta.key &lt;/tls-auth&gt; &lt;cert&gt; ###    PetrovIvan.crt &lt;/cert&gt; &lt;key&gt; ###    PetrovIvan.key &lt;/key&gt;</span></span></code> </pre> <br>  We save and give to the client, which simply connects to the VPN, using the ovpn-file.  This completes the OpenVPN configuration. <br><br><h2>  Client lock </h2><br>  In the case when we need to deny connecting to a VPN to one of the clients (for example, when an employee leaves), we simply revoke the certificate: <br><br><pre> <code class="bash hljs">$ ./revoke-all PetrovIvan</code> </pre> <br>  After the revocation, we update <code>crl.pem</code> on all servers and execute: <br><br><pre> <code class="bash hljs">$ sudo service openvpn reload</code> </pre> <br>  Please note that the <code>server.conf</code> missing the <code>persist-key</code> option.  This allows you to update key information during the execution of a <code>reload</code> - otherwise it would require a restart of the daemon. <br><br>  To distribute the revocation list and perform the <code>reload</code> action for OpenVPN, we use Chef.  Obviously, any other means of automatic deployment of configurations (Ansible, Puppet ...) or even a simple shell script are suitable for this purpose. <br><br>  In addition, we placed a directory with CA in Git, which allowed both us and the client to work with key information, avoiding collisions. <br><br><h2>  Conclusion </h2><br>  Of course, the described solution develops during operation.  In particular, we added simple scripts that automatically create client ovpn files during key generation, as well as working on a VPN monitoring system. <br><br>  If you have thoughts about weak points in this decision or ideas / questions on the further development of the configuration, I will be glad to see their comments! <br><br><h2>  PS </h2><br>  Read also in our blog: <br><br><ul><li>  " <a href="https://habrahabr.ru/company/flant/blog/331128/">Our recipe for a fail-safe Linux router</a> "; </li><li>  " <a href="https://habrahabr.ru/company/flant/blog/335030/">Setting up the main and two backup operators on a Linux-router with NetGWM</a> ". </li></ul></div><p>Source: <a href="https://habr.com/ru/post/338628/">https://habr.com/ru/post/338628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338618/index.html">Supercomputer Cray XC40 will build a map of neurons</a></li>
<li><a href="../338620/index.html">Cisco unveiled features of the 400-gigabit NPU</a></li>
<li><a href="../338622/index.html">Marea 160-terabit trans-Atlantic cable finished</a></li>
<li><a href="../338624/index.html">Weekend reading: 17 independent blogs on math, algorithms, and programming languages</a></li>
<li><a href="../338626/index.html">New Cisco Intersight Platform Simplifies Cisco UCS and HyperFlex Management</a></li>
<li><a href="../338632/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ281 (September 18 - 24, 2017)</a></li>
<li><a href="../338634/index.html">We write for UEFI BIOS in Visual Studio. Part 3 - Russify Front Page</a></li>
<li><a href="../338636/index.html">PHP Digest number 117 - the latest news, materials and tools (September 10 - 24, 2017)</a></li>
<li><a href="../338638/index.html">Overview of Cryptoeconomics. Article translation</a></li>
<li><a href="../338642/index.html">Facebook changed React license to standard MIT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>