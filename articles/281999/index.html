<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The experience of automating difficult correspondence (Part 2. Outgoing)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to continue the description of my experience in improving the process of managing official correspondences in the project organization, begun i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The experience of automating difficult correspondence (Part 2. Outgoing)</h1><div class="post__text post__text-html js-mediator-article">  I want to continue the description of my experience in improving the process of managing official correspondences in the project organization, begun in the <a href="https://habrahabr.ru/company/easla/blog/281839/">previous article</a> .  Let me remind you that instead of elma, the easla.com system was chosen and it already described the behavior of the incoming document. <br><img src="https://habrastorage.org/files/231/b6c/dc6/231b6cdc68f040ff9e6897ae3d3c62a4.png"><br>  The next step to the goal is to describe the behavior of the outgoing document.  Those were flowers ... under the cut even more text and code. <br><a name="habracut"></a><br>  The requirements for the outgoing document were several times more serious than for the incoming one.  If you collect only the main ones in a separate summary list, you get: <br><ul><li>  Registration of outgoing document by any employee of the organization </li><li>  Joint development of a cover letter (of course, not simultaneously, but in one file) </li><li>  Saving intermediate versions of the cover letter </li><li>  Storage of a large number of applications in different formats </li><li>  Storing archived ( <a href="https://ru.wikipedia.org/wiki/ZIP">zip</a> ) files with project documentation (with loading from <a href="http://www.tdms.ru/">TDMS</a> and storing additional information on communication with objects) </li><li>  Sending an outgoing document in various ways (by email as it is, in one archive, multivolume archive, sharing, uploading to <a href="https://ru.wikipedia.org/wiki/FTP">ftp</a> , etc.) </li></ul><br>  As you can see, the requirements are not simple.  That is why I was so attentive to the choice of the new system and stopped at <a href="http://easla.com/">easla.com</a> .  But let's tell in order. <br>  I began by creating the ‚ÄúOutgoing Document‚Äù object in the ‚ÄúCorrespondence‚Äù process and moving on to filling it with attributes.  They are even more than in the incoming! <br><h4>  Attributes </h4><br><h5>  Counterparty </h5><br>  Link to the ‚ÄúCounterparty‚Äù object from the ‚ÄúCustomers‚Äù process.  Initialization of valid attribute values ‚Äã‚Äãis performed in the ‚ÄúAfter object initialization‚Äù script: <br><pre><code class="php hljs">cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;values = prepareOutgoingContragents();</code> </pre> <br>  The auxiliary function prepareOutgoingContragents is declared in the script ‚ÄúBefore the object is initialized‚Äù: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareOutgoingContragents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $src_contragents = selectAll( <span class="hljs-string"><span class="hljs-string">'crm_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crm_management_contragent'</span></span> ); $end_contragents = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($src_contragents <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $s) $end_contragents += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($s[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] =&gt; $s[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]); asort($end_contragents); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $end_contragents; }</code> </pre><br>  Depending on the chosen contractor, the list of available contacts and the recommended rule for sending a letter depend.  And if the behavior with contacts is clear to everyone, then with the rule of sending - not everyone.  The fact is that our contractors, especially customers, are very capricious in terms of receiving email.  mail.  I find it difficult to explain the reasons for this behavior, but, for example, some customers accept email.  letters with a maximum capacity of 3MB and at the same time require that all documentation, which may be 100MB in size, be sent to them exclusively by email.  mail.  Others allow the transfer of large investments in email.  Letters, say, about 10-15 MB, but require that all applications come only in zip format and in no case a multi-volume archive.  Still others insist that the cover letter be sent an email.  mail to their corporate address, and all applications were transferred in a different way to other recipients.  The fourth asked to upload attachments to letters on the private "ball" so that they can download everything from there.  A couple of weeks ago, one customer asked to transfer all applications to secure <a href="https://ru.wikipedia.org/wiki/FTP">FTP</a> when sending a letter, and another demanded that all applications and a cover letter be uploaded to them on the portal raised on FrontPage and placed in certain folders. <br>  It was obvious that during intensive correspondence, manually meeting the requirements of all customers for sending letters would be difficult.  Perhaps, but very difficult.  It will be necessary for both the clerk and the GUIs to remember exactly how to send a letter to a specific customer.  Bullying, not work! <br>  I had to break my head a little, as if to save all these requirements in <a href="http://easla.com/">easla.com</a> , in order to facilitate the work of all participants in the process.  As a result, I modified the Counterparty object in the Customers process by adding two attributes to it: one to store the recommended sending rule (more about it below), the second for the list of additional contacts (it will also be more detailed about it). <br>  In short, the ‚ÄúAt Change‚Äù attribute script allows you to redefine the attribute values ‚Äã‚Äãin accordance with the selected counterparty: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cattributeref()-&gt;value)) { $contacts = cobjectref()-&gt;prepareOutgoingContacts(cattributeref()-&gt;value); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contact'</span></span>)-&gt;values = $contacts; $contracts = cobjectref()-&gt;prepareContracts(cattributeref()-&gt;value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contracts)) $contracts = cobjectref()-&gt;prepareContracts(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contract'</span></span>)-&gt;values = $contracts; $default_rule = cobjectref()-&gt;calcContragentOutgoingRule(cattributeref()-&gt;value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($default_rule)) cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_rule'</span></span>)-&gt;value = $default_rule; $default_notifiers = cobjectref()-&gt;calcContragentOutgoingNotifiers(cattributeref()-&gt;value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($default_notifiers)) cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_notifiers'</span></span>)-&gt;value = $default_notifiers; <span class="hljs-comment"><span class="hljs-comment">//if (cobjectref()-&gt;attributeref('crs_management_outgoing_contragent')-&gt;value == 45410) } cobjectref()-&gt;attributeref('crs_management_outgoing_cntnum')-&gt;value = cobjectref()-&gt;updateDocumentCntNum(); cobjectref()-&gt;attributeref('crs_management_outgoing_regnum')-&gt;value = cobjectref()-&gt;calcOutgoingCode();</span></span></code> </pre><br>  By the way, the last two lines of the script have also been added recently.  Due to the fact that one customer demanded that we use to identify outgoing documents, their designations that are different from ours.  Here they are - customers! <br><br><h5>  Contact </h5><br>  Reference to the object "Contact" in the process "Customers".  Like the list of contractors, the contact list is initialized in the ‚ÄúAfter object initialization‚Äù script: <br><pre> <code class="php hljs">$contacts = prepareOutgoingContacts(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contact'</span></span>)-&gt;values = $contacts;</code> </pre><br>  At the same time, the auxiliary function prepareOutgoingContacts is also declared in the script ‚ÄúBefore an object is initialized‚Äù: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareOutgoingContacts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($contragent = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contragent)) $src_contacts = selectAll( <span class="hljs-string"><span class="hljs-string">'crm_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crm_management_contact'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent.description'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $src_contacts = selectAll( <span class="hljs-string"><span class="hljs-string">'crm_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crm_management_contact'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent.description'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent'</span></span>=&gt;$contragent) ); $end_contacts = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $processed_contact = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $processed_description = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($src_contacts <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $s) { $e = array_search($s[<span class="hljs-string"><span class="hljs-string">'description'</span></span>], $processed_description); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($e === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { $processed_contact += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($s[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] =&gt; $s); $processed_description += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($s[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] =&gt; $s[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]); $end_contacts += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($s[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] =&gt; $s[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $end_contacts[$e] = $processed_contact[$e][<span class="hljs-string"><span class="hljs-string">'description'</span></span>].<span class="hljs-string"><span class="hljs-string">' ['</span></span>.trim($processed_contact[$e][<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent.description'</span></span>]).<span class="hljs-string"><span class="hljs-string">']'</span></span>; $end_contacts += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($s[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] =&gt; $s[<span class="hljs-string"><span class="hljs-string">'description'</span></span>].<span class="hljs-string"><span class="hljs-string">' ['</span></span>.trim($s[<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent.description'</span></span>]).<span class="hljs-string"><span class="hljs-string">']'</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($processed_contact,$processed_description); asort($end_contacts); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $end_contacts; }</code> </pre><br>  The function, like its ‚Äúsister‚Äù in the ‚ÄúIncoming Document‚Äù object, adds to all complete namesake the name of the organization in which they work so that they can be distinguished. <br>  For the sake of additional convenience, the ‚ÄúOn Change‚Äù contact script and the unspecified counterparty substitutes the required counterparty and updates the values ‚Äã‚Äãof the attributes dependent on it: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contact'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value)) { $contact = select(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contact'</span></span>)-&gt;value); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contact)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $contragent_id = $contact-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent'</span></span>)-&gt;value; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value = $contragent_id; $contracts = cobjectref()-&gt;prepareContracts($contragent_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contracts)) $contracts = cobjectref()-&gt;prepareContracts(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contract'</span></span>)-&gt;values = $contracts; $default_rule = cobjectref()-&gt;calcContragentOutgoingRule($contragent_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($default_rule)) cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_rule'</span></span>)-&gt;value = $default_rule; $default_notifiers = cobjectref()-&gt;calcContragentOutgoingNotifiers($contragent_id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($default_notifiers)) cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_notifiers'</span></span>)-&gt;value = $default_notifiers; } cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value = cobjectref()-&gt;updateDocumentCntNum(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = cobjectref()-&gt;calcOutgoingCode();</code> </pre><br>  The result looks like this: <br><img src="https://habrastorage.org/files/860/b3e/f05/860b3ef051984c978cd3c095efed9246.png"><br><br><h5>  Add.  contacts </h5><br>  Reference to the object "Contact" in the process "Customers".  It is a list of additional contacts that will be put in a copy when sending a letter to the main recipients.  This attribute records contacts indicated in the ‚ÄúCounterparty‚Äù object, to which they need to send copies of the letter, if it is sent to a specific counterparty. <br>  The implementation was very convenient, because  Previously, a clerk and screening officer stuck their monitors with sticky papers, on which were written the names of the customer and the list of persons to whom to send copies of letters.  Instead of <a href="http://easla.com/">paperwork</a> , <a href="http://easla.com/">easla.com</a> is now used <a href="http://easla.com/">,</a> and no one forgets to indicate contacts in a copy. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Add.  notify by email  mail </h5><br>  Reference to the object "Contact" in the process "Customers".  Another list of additional.  contacts, which must be separately notified by a copy of the letter.  Often it may not even be employees of the customer, but, say, employees of the parent organization or supervisory authority. <br><br><h5>  Send rule </h5><br>  Classifier that allows you to determine how to send letters to the addressee.  Today, we use 16 rules of dispatch.  Some differ only in numbers, for example: <br><ul><li>  All send to all (letter no more than 3MB) </li><li>  Document DOS.  contact, everything else (more than 5M, archives for 4.5M) </li><li>  All send a link to the archive with the letter and attachments </li><li>  Document DOS.  contact, the rest of the link to the archive with the letter and attachments </li><li>  All send to all (more than 3M, archives of 2.5M) </li><li>  All shift to ftp.sngp.ru for LLC "Customer" </li><li>  All send as links to the portal pro.blablabla.ru </li></ul><br>  The list of valid values ‚Äã‚Äãis formed in the ‚ÄúAt Initialization‚Äù attribute script: <br><pre> <code class="php hljs">$src_classificators = classificatorChilds(<span class="hljs-string"><span class="hljs-string">'crs_outgoing_rule'</span></span>); $end_classificators = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); $default = <span class="hljs-string"><span class="hljs-string">'crs_outgoing_rule_asis_max5'</span></span>; $default_index = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($src_classificators <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $c) { $end_classificators += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($c[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]=&gt;$c[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($c[<span class="hljs-string"><span class="hljs-string">'code'</span></span>] == $default) $default_index = $c[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($end_classificators) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { cattributeref()-&gt;values=$end_classificators; cattributeref()-&gt;value = is_null($default_index) ? key($end_classificators) : $default_index; }</code> </pre><br>  A useful classificatorChilds function returns the direct descendants of the specified classifier.  It remains only to iterate over the values, form an array and assign to the attribute. <br>  The sending rule is used in the action ‚ÄúSend by email.  mail, which will be described below. <br><br><h5>  Registration date </h5><br>  Obviously from the name that stores the date of registration of the outgoing document.  The initial value corresponds to the current date and is initialized in the ‚ÄúAt Initialization‚Äù attribute script: <br><pre> <code class="php hljs">cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regdate'</span></span>)-&gt;value = currentDateTime();</code> </pre><br><br><h5>  departure date </h5><br>  It is also clear from the name that the attribute stores the date of dispatch.  It is read only, i.e.  The user himself can not fill it.  In the read-only mode, the attribute is translated in the ‚ÄúAt Initialization‚Äù script: <br><pre> <code class="php hljs">cattributeref()-&gt;readonly = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;</code> </pre><br><br><h5>  Performers </h5><br>  Users (employees) organizations involved in the development of the letter.  The attribute is multiple, since several employees can participate in the development of a letter.  During the registration (creation) of a letter, the current user is identified and, if he does not belong to a narrow circle of persons delineated by the groups specified in the code, then it is written into the attribute value.  Each subsequent employee must add himself to the list of performers if he wants to receive information about sending a letter.  By the way, the performers are also indicated at the end of the outgoing letter form indicating their telephone numbers for feedback. <br>  Initialization of valid attribute values ‚Äã‚Äãoccurs in the "At Initialization" script: <br><pre> <code class="php hljs">$src_users = corganization()-&gt;allUsers(); $end_users = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($src_users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $u) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($u[<span class="hljs-string"><span class="hljs-string">'islocked'</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>) $end_users += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($u[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]=&gt;$u[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]); asort($end_users); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_performers'</span></span>)-&gt;values = $end_users; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cuser())) { $rsp_users = corganization()-&gt;allUsersByGroups(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'group_general_manager'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_general_engineer'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_general_manager_operations'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_general_manager_economics'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_gip'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_hr'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_dp'</span></span> ), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); $f = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($rsp_users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $u) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($u[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] == cuser()-&gt;id) { $f = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($f) { cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_performers'</span></span>)-&gt;value = cuser()-&gt;id; cobjectref()-&gt;updateResponsibleGroup(); } }</code> </pre><br>  The updateResponsibleGroup helper function is designed to update the value of the attribute ‚ÄúReply.  subdivision "and declared in the script" Before the object is initialized ": <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateResponsibleGroup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_performers'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsiblegroup'</span></span>)-&gt;value)) { $performers = cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_performers'</span></span>)-&gt;value; $user = corganization()-&gt;user($performers[<span class="hljs-number"><span class="hljs-number">0</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($user)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $groups = $user-&gt;groups(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($groups <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $group) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($group[<span class="hljs-string"><span class="hljs-string">'data_one'</span></span>])) { cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsiblegroup'</span></span>)-&gt;value = $group[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  If the attribute value changes, the ‚ÄúOn Change‚Äù script is triggered, which updates the responsible department in the form of an outgoing document: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_performers'</span></span>)-&gt;value) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsiblegroup'</span></span>)-&gt;value)) cobjectref()-&gt;updateResponsibleGroup();</code> </pre><br><br><h5>  Ed.  employee </h5><br>  Users (employees) of the organization that will sign the outgoing letter.  In our case, official letters are signed only by senior managers, the head of the personnel department and the GUIs.  The list of eligible employees is formed in the "At Initialization" script: <br><pre> <code class="php hljs">$src_users = corganization()-&gt;allUsersByGroups(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'group_general_manager'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_general_engineer'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_general_manager_operations'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_general_manager_economics'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_gip_only'</span></span>, <span class="hljs-string"><span class="hljs-string">'group_hr'</span></span> ), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); $end_users = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($src_users <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $u) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($u[<span class="hljs-string"><span class="hljs-string">'islocked'</span></span>] == <span class="hljs-number"><span class="hljs-number">0</span></span>) $end_users += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($u[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]=&gt;$u[<span class="hljs-string"><span class="hljs-string">'description'</span></span>]); asort($end_users); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsibleuser'</span></span>)-&gt;values = $end_users;</code> </pre><br>  The allUsersByGroups function is simply a ‚Äúmagic wand‚Äù when you need to get a list of users in certain groups or vice versa. <br>  When an attribute is changed, a value is checked in the attribute ‚ÄúReply.  subdivision".  In the event that it is absent, i.e.  the letter does not specify the performer, it records the unit to which the responsible person belongs.  employee: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cattributeref()-&gt;value) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsiblegroup'</span></span>)-&gt;value)) { $user = corganization()-&gt;user(cattributeref()-&gt;value); $groups = $user-&gt;groups(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($groups <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $group) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_numeric($group-&gt;data_one)) { cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsiblegroup'</span></span>)-&gt;value = $group-&gt;id; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = cobjectref()-&gt;calcOutgoingCode();</code> </pre><br>  Very pleased with the opportunity to create such dynamic forms in easla.com.  By changing the values ‚Äã‚Äãof some attributes, I can change the values ‚Äã‚Äãof others in any sequence!  Try to do the same, for example, in Sharepoint. <br><br><h5>  Ed.  subdivision </h5><br>  A group of users, in our case - a division of the organization that is responsible for developing the outgoing document. <br>  All units in our organization have their own numerical (fractional) identifiers assigned by the personnel department.  Probably, they are used somewhere else, but in my case, they are used to identify the outgoing letter.  Therefore, when I created groups for users in easla.com, I added these identifiers to the so-called ‚Äúfirst data‚Äù. <br><img src="https://habrastorage.org/files/978/8cc/c60/9788ccc60f7a4813b62f0fd84f4294d6.png"><br>  When forming the list of possible otv.  subdivisions of the ‚ÄúDuring Initialization‚Äù script checks for the presence of ‚Äúfirst data‚Äù and includes groups in the list only if they are available: <br><pre> <code class="php hljs">$src_groups = corganization()-&gt;groups(); $end_groups = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($src_groups <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $g) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($g[<span class="hljs-string"><span class="hljs-string">'data_one'</span></span>])) $end_groups += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($g[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]=&gt;$g[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]); asort($end_groups); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_responsiblegroup'</span></span>)-&gt;values = $end_groups;</code> </pre><br>  When changing the answer  units change the designation of the registration number of the outgoing document: <br><pre> <code class="php hljs">cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = cobjectref()-&gt;calcOutgoingCode();</code> </pre><br>  The helper function calcOutgoingCode is declared in the script ‚ÄúBefore the object is initialized‚Äù: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcOutgoingCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value) &amp;&amp; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">45410</span></span> &amp;&amp; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">1192</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//This is ZapSib-2 Project if (empty(cobjectref()-&gt;attributeref('crs_management_outgoing_content')-&gt;value)) return; $content = classificator(cobjectref()-&gt;attributeref('crs_management_outgoing_content')-&gt;value); if (empty($content)) return; $content_code = $content['data_one']; if (empty($content_code)) return; //TRANSMITTAL return sprintf('TNGP-NPG-ZS2-0311-%s-%05d', $content_code, cobjectref()-&gt;attributeref('crs_management_outgoing_cntnum')-&gt;value ); } if (empty(cobjectref()-&gt;attributeref('crs_management_outgoing_responsibleuser')-&gt;value)) return; if (empty(cobjectref()-&gt;attributeref('crs_management_outgoing_responsiblegroup')-&gt;value)) return; $group_code = str_replace('.','-',corganization()-&gt;group(cobjectref()-&gt;attributeref('crs_management_outgoing_responsiblegroup')-&gt;value)-&gt;data_one); $user_code = mb_substr(corganization()-&gt;allUser(cobjectref()-&gt;attributeref('crs_management_outgoing_responsibleuser')-&gt;value)-&gt;lastname, 0, 2); return sprintf( '%s/%s-%s', $group_code, $user_code, cobjectref()-&gt;attributeref('crs_management_outgoing_cntnum')-&gt;value ); }</span></span></code> </pre><br>  Until recently, the function was much simpler, but due to recent requirements, it was necessary to make a change to it, which takes into account the identifier of the customer and the type of letter.  In accordance with the completed attributes, the function generates the registration number of the document. <br><br><h5>  Serial number </h5><br>  The ordinal number of the outgoing document begins its numbering every year anew.  Therefore, it was impossible to <a href="http://easla.com/">use the</a> numerator built into <a href="http://easla.com/">easla.com</a> .  I had to write my own. <br>  In addition, one of the customers demanded the use of pass-through numbering for a certain type of his letters, so the numbering is double.  Normal for letters with our registration number and unusual for letters with a registration number requested by the customer. <br>  When creating an outgoing document, the initial sequence number is calculated: <br><pre> <code class="php hljs">cattributeref()-&gt;value = cobjectref()-&gt;updateDocumentCntNum();</code> </pre><br>  The auxiliary function updateDocumentCntNum is also declared in the "Before an object is initialized" script: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateDocumentCntNum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cobjectref()-&gt;isNewRecord || <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value) &amp;&amp; !<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value) &amp;&amp; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">45410</span></span> &amp;&amp; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">1192</span></span>) { $num = selectAggregateAll( <span class="hljs-string"><span class="hljs-string">'max'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span>,cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value), <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span>,cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value) ) ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $num + <span class="hljs-number"><span class="hljs-number">1</span></span>; } $year = date_format(currentDateTime(), <span class="hljs-string"><span class="hljs-string">'Y'</span></span>); $condition = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regdate'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'between'</span></span>, $year.<span class="hljs-string"><span class="hljs-string">'-01-01'</span></span>, $year.<span class="hljs-string"><span class="hljs-string">'-12-31'</span></span>), ); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($year) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'2016'</span></span>: $condition[<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>] = <span class="hljs-string"><span class="hljs-string">'&lt;4489'</span></span>; $tmp = selectAggregateAll( <span class="hljs-string"><span class="hljs-string">'max'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>, $condition ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($tmp == <span class="hljs-number"><span class="hljs-number">4488</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($condition[<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $tmp + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } $num = selectAggregateAll( <span class="hljs-string"><span class="hljs-string">'max'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>, $condition ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $num + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value; } }</code> </pre><br>  If you look closely at the code, you will see a strange case condition '2016'.  This is the result of our internal problems.  We also have the registration of documents "retroactively", so in <a href="http://easla.com/">easla.com</a> I did not make a "cut-off" to try to cheat.  However, everything is on the responsibility of the user.  So we created letters with last year‚Äôs numbers at the beginning of this year.  And even managed to send them!  I had to set a condition and cut off such letters in order to correctly number the letters this year. <br>  I will separately pay attention to the selectAggregateAll function.  It returns the aggregated value, in my case, the maximum numeric value of the attribute 'crs_management_outgoing_cntnum' of the object 'crs_management_outgoing' in the process 'crs_management'.  It uses the search condition $ condition, which is formed slightly higher. <br><br>  In the same elma I had to abandon this method in favor of a workaround.  Here's how it was: <br><div class="spoiler">  <b class="spoiler_title">Correct but brake code in elma</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> manager = EntityManager&lt;IOutgoingDoc&gt;.Instance; DateTime startdate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(entity.RegDate.Value.Year, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); DateTime enddate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(entity.RegDate.Value.Year, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> allInYear = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> manager.FindAll() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> d.RegDate.Value &gt;= startdate &amp;&amp; d.RegDate.Value &lt;= enddate <span class="hljs-keyword"><span class="hljs-keyword">orderby</span></span> d.CntNum <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> d; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (allInYear.Count() == <span class="hljs-number"><span class="hljs-number">0</span></span>) entity.CntNum = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> entity.CntNum = allInYear.Last().CntNum + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br></div></div><br>  Everything worked for the time being, but then it began to slow down so much that I had to look for bottlenecks.  It turned out that one such place is the calculation of the sequence number.  I had to create additional.  tables and replace the code to increase the speed of the object and the system as a whole: <br><div class="spoiler">  <b class="spoiler_title">Bypass maneuver in elma</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConString = <span class="hljs-string"><span class="hljs-string">"Data Source=ss2;Initial Catalog=ELMA;User ID=sa;Password=password;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (SqlConnection connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(ConString)) { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (SqlCommand command = connection.CreateCommand()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> year = entity.RegDate.Value.Year; command.CommandText = <span class="hljs-string"><span class="hljs-string">"SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED; SELECT TOP 1 cntNum FROM [ELMA].[dbo].[OutgoingDoc] WHERE (RegDate &gt;= CAST('"</span></span> + year.ToString() + <span class="hljs-string"><span class="hljs-string">"-01-01 00:00:00' AS datetime)) AND (RegDate &lt; CAST('"</span></span> + year.ToString() + <span class="hljs-string"><span class="hljs-string">"-12-31 23:59:59' AS datetime)) ORDER BY cntNum DESC"</span></span>; connection.Open(); SqlDataReader reader = command.ExecuteReader(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cntNum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.Read()) cntNum = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(reader[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToString()); connection.Close(); command.CommandText = <span class="hljs-string"><span class="hljs-string">"SELECT TOP 1 reservedNum FROM [TNGP].[dbo].[ElmaReservedNums] WHERE docType = '"</span></span> entity.TypeUid + <span class="hljs-string"><span class="hljs-string">"' ORDER BY reservedNum DESC"</span></span>; connection.Open(); reader = command.ExecuteReader(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> reservedNum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.Read()) reservedNum = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(reader[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToString()); connection.Close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cntNum &lt; reservedNum) cntNum = reservedNum; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cntNum == <span class="hljs-number"><span class="hljs-number">0</span></span>) cntNum = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cntNum++; command.CommandText = <span class="hljs-string"><span class="hljs-string">"INSERT INTO [TNGP].[dbo].[ElmaReservedNums](reservedNum, docType) VALUES ("</span></span> + cntNum.ToString() + <span class="hljs-string"><span class="hljs-string">",'"</span></span> + entity.TypeUid + <span class="hljs-string"><span class="hljs-string">"')"</span></span>; connection.Open(); command.ExecuteNonQuery(); connection.Close(); entity.CntNum = cntNum; } }</code> </pre><br></div></div><br>  Is this a thing ?! <br><br><h5>  Registration number </h5><br>  Required text attribute is read only.  Stores the registration number of the outgoing document.  Calculated during initialization: <br><pre> <code class="php hljs">cattributeref()-&gt;readonly = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; cattributeref()-&gt;value = cobjectref()-&gt;calcOutgoingCode();</code> </pre><br>  Updated by changing other attributes whose values ‚Äã‚Äãaffect the registration number of the document. <br><img src="https://habrastorage.org/files/71c/a86/9ea/71ca869ea1b34b0889ecd13be4de86d5.png"><br><br><h5>  Theme </h5><br>  Normal multi-line required text attribute. <br><br><h5>  Type of Content </h5><br>  Classifier, allowing to determine the type of content of the letter.  Exactly the same as that of the incoming document.  The list of valid values ‚Äã‚Äãis formed during initialization: <br><pre> <code class="php hljs">$src_classificators = classificatorChilds(<span class="hljs-string"><span class="hljs-string">'crs_content'</span></span>); $end_classificators = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($src_classificators <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $c) { $end_classificators += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($c[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]=&gt;$c[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($c[<span class="hljs-string"><span class="hljs-string">'code'</span></span>] == <span class="hljs-string"><span class="hljs-string">'crs_content_other'</span></span>) $default = $c[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($end_classificators) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { cattributeref()-&gt;values=$end_classificators; cattributeref()-&gt;value = <span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($default) ? $default : $c[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; }</code> </pre><br>         ,  ,  . <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">45410</span></span>) cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value = cobjectref()-&gt;updateDocumentCntNum(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = cobjectref()-&gt;calcOutgoingCode();</code> </pre><br><br><h5>     </h5><br>   ¬´ ¬ª   .    ,   " <a href="https://habrahabr.ru/company/easla/blog/281839">   </a> "   ¬´ ¬ª.     ---  .. <br>   ,   ,           ,       .           ¬´¬ª. <br>          ¬´ ¬ª: <br><pre> <code class="php hljs">cattributeref()-&gt;values = cobjectref()-&gt;prepareIncomings();</code> </pre><br>    prepareIncomings    ¬´  ¬ª: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareIncomings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $src_documents = selectAll( <span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>, <span class="hljs-string"><span class="hljs-string">'crs_management_incoming'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crs_management_incoming_contragent_regnum'</span></span>) ); $end_documents = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($src_documents <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $d) $end_documents += <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($d[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] =&gt; $d[<span class="hljs-string"><span class="hljs-string">'crs_management_incoming_contragent_regnum'</span></span>].<span class="hljs-string"><span class="hljs-string">' ['</span></span>.$d[<span class="hljs-string"><span class="hljs-string">'description'</span></span>].<span class="hljs-string"><span class="hljs-string">']'</span></span>); asort($end_documents); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $end_documents; }</code> </pre><br><br><h5>  Contract </h5><br>    ¬´¬ª   ¬´¬ª.  ,     " <a href="https://habrahabr.ru/company/easla/blog/281839"></a> "   ¬´ ¬ª. <br>        ¬´  ¬ª,       : <br><pre> <code class="php hljs">cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contract'</span></span>)-&gt;values = prepareContracts();</code> </pre><br>         ,  , . <br><br><h5>    </h5><br>    , ..           , ..   .      , ,       ,       -    . <br><br><h5>   </h5><br>       .   ‚Ä¶ <br><br><h5>  ..  </h5><br>          .   ,   .            . <br><br><h5>  Document </h5><br>          . ,   ,   ,     . <br>       ¬´ ¬ª: <br><pre> <code class="php hljs">cattributeref()-&gt;revMode = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; cattributeref()-&gt;canScan = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; cattributeref()-&gt;fileLinks = <span class="hljs-number"><span class="hljs-number">3</span></span>;<span class="hljs-comment"><span class="hljs-comment">//1;//2;</span></span></code> </pre><br>    .  revMode  ,    /      (). <br><img src="https://habrastorage.org/files/a5c/68a/dcf/a5c68adcf534453b9864ab3953f477eb.png"><br><br>  canScan  ,          . <br><img src="https://habrastorage.org/files/992/c7d/b1f/992c7db1fc0c4e21a67e1750f8744515.png"><br><br>   fileLinks=3  ,        ,       (   <a href="http://easla.com/ru/site/page/view/tools">Easla Agent</a> ).        ,     ,       .    0, .. ,        .    1 ‚Äì     ,   .    , ..     ,   ,    2 ‚Äì      ,     .   .      3 ‚Äì        ,        (.  ). <br><br>  ,  <a href="http://easla.com/">easla.com</a>       .             .               .     . <br><img src="https://habrastorage.org/files/374/f9d/98a/374f9d98a48a476f870fc648428cc418.png"><br><br> ,      ,  ,     Microsoft Word,   .  ,    ,       .  ,           ,      .    Microsoft Word     . <br><img src="https://habrastorage.org/files/908/2d9/7b5/9082d97b546f49feb1637818bdac178f.png"><br><br>   , ..   ,   ,    : <br><pre> <code class="php hljs">cobjectref()-&gt;updateDocumentFileName();</code> </pre><br>            . ,     ,    ,    ,  ,     ,        . <br>      ,    ¬´  ¬ª: <br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calcOutgoingDesc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $code = calcOutgoingCode(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($code)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_sentdate'</span></span>)-&gt;value)) { $d = date_create(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regdate'</span></span>)-&gt;value); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $d = date_create(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_sentdate'</span></span>)-&gt;value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sprintf( <span class="hljs-string"><span class="hljs-string">'%s  %s'</span></span>, $code, localeFormatDate($d) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateDocumentFileName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $desc = calcOutgoingDesc(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($desc)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $files = cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>)-&gt;availableFiles(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($files <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $f) { $nowname = sprintf( <span class="hljs-string"><span class="hljs-string">'%s.%s'</span></span>, $desc, pathinfo($f-&gt;nowname, PATHINFO_EXTENSION) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strcmp($nowname, $f-&gt;nowname) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; $f-&gt;nowname = $nowname; $f-&gt;save(); } }</code> </pre><br>   calcOutgoingDesc     . <br><br><h5>  Applications </h5><br>           .    ,   .      ¬´ ¬ª           : <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cattributeref()-&gt;filesCount &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) cattributeref()-&gt;fileInfo = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'revcode'</span></span>,<span class="hljs-string"><span class="hljs-string">'modifytime'</span></span>,<span class="hljs-string"><span class="hljs-string">'count'</span></span>,<span class="hljs-string"><span class="hljs-string">'total'</span></span>,<span class="hljs-string"><span class="hljs-string">'header'</span></span>,<span class="hljs-string"><span class="hljs-string">'filter'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cattributeref()-&gt;fileInfo = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'revcode'</span></span>,<span class="hljs-string"><span class="hljs-string">'modifytime'</span></span>,<span class="hljs-string"><span class="hljs-string">'count'</span></span>,<span class="hljs-string"><span class="hljs-string">'total'</span></span>);</code> </pre><br>    ,          .  mail. <br>    ,        <a href="http://www.tdms.ru/">TDMS</a> ,     - .         .  ,  ,         .   ,       <a href="http://www.tdms.ru/">TDMS</a>    <a href="http://easla.com/">easla.com</a> , , . <br>   : <br><ul><li>   TDMS   </li><li>         pdf    (          ) </li><li>     ,       </li><li>         </li><li>     . </li></ul><br>   ,           2  5    .       10 ,        !  Nightmare! <br>   ,            <a href="http://www.tdms.ru/">TDMS</a> ,  ,  ! <br>  ,  ,    <a href="http://easla.com/">easla.com</a>    <a href="http://www.tdms.ru/">TDMS</a>   .  ,  <a href="http://www.tdms.ru/">TDMS</a>    ,        .      ,       (    <a href="http://easla.com/">easla.com</a>   <a href="https://ru.wikipedia.org/wiki/SOAP">SOAP</a> ),                ! <br><img src="https://habrastorage.org/files/440/1ec/d93/4401ecd935464c38886889e968421dd3.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On this topic, you can write a separate article, if anyone will be interested. </font><font style="vertical-align: inherit;">The solution is highly specialized, but the experience is very useful!</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Link to apps elsewhere </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A text attribute for storing a hyperlink pointing to storing applications somewhere else. </font><font style="vertical-align: inherit;">Say, on a public or corporate file sharing.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Text of the letter </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recently added attribute. </font><font style="vertical-align: inherit;">Designed to write the text of the letter, which does not imply the presence of the accompanying document. </font><font style="vertical-align: inherit;">Currently used for only one type of content - Transmittal.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An object </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just like the list of incoming documents, the list of outgoing documents is colored according to their status. </font><font style="vertical-align: inherit;">It was enough to add code to the ‚ÄúAfter object initialization‚Äù script:</font></font><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (cobjectref()-&gt;status-&gt;code) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_created'</span></span>: cobjectref()-&gt;status-&gt;state = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_fax'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_courier'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_narochnym'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_post'</span></span>: cobjectref()-&gt;status-&gt;state = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_email'</span></span>: cobjectref()-&gt;status-&gt;state = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agree, color adds visibility. </font></font><br><img src="https://habrastorage.org/files/72b/7a6/59b/72b7a659bcce4abb87707307721048d8.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The final validation of an object's attributes is performed in the ‚ÄúBefore an object is saved‚Äù script:</font></font><br><pre> <code class="php hljs">cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = calcOutgoingCode(); cobjectref()-&gt;description = calcOutgoingDesc(); updateDocumentFileName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">45410</span></span> &amp;&amp; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value == <span class="hljs-number"><span class="hljs-number">1192</span></span>) { $conditions = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span>,cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value), <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'id'</span></span>,cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value), <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>=&gt;cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cobjectref()-&gt;isNewRecord) $conditions[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] = <span class="hljs-string"><span class="hljs-string">'&lt;&gt;'</span></span>.cobjectref()-&gt;id; $exist = selectCountAll(<span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>,<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing'</span></span>, $conditions); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($exist) { $nownum = cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value; $freenum = updateDocumentCntNum(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value = $freenum; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = calcOutgoingCode(); updateDocumentFileName(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'  , ..     .  '</span></span>.$nownum.<span class="hljs-string"><span class="hljs-string">'!    '</span></span>.$freenum.<span class="hljs-string"><span class="hljs-string">',    .'</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $year = date_format(date_create(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regdate'</span></span>)-&gt;value), <span class="hljs-string"><span class="hljs-string">'Y'</span></span>); $conditions = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>=&gt;cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value, <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regdate'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'between'</span></span>, $year.<span class="hljs-string"><span class="hljs-string">'-01-01'</span></span>, $year.<span class="hljs-string"><span class="hljs-string">'-12-31'</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cobjectref()-&gt;isNewRecord) $conditions[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] = <span class="hljs-string"><span class="hljs-string">'&lt;&gt;'</span></span>.cobjectref()-&gt;id; $exist = selectCountAll(<span class="hljs-string"><span class="hljs-string">'crs_management'</span></span>,<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing'</span></span>, $conditions); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($exist) { $nownum = cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value; $freenum = updateDocumentCntNum(); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_cntnum'</span></span>)-&gt;value = $freenum; cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value = calcOutgoingCode(); updateDocumentFileName(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'  , ..     .  '</span></span>.$nownum.<span class="hljs-string"><span class="hljs-string">'   '</span></span>.$year.<span class="hljs-string"><span class="hljs-string">' !    '</span></span>.$freenum.<span class="hljs-string"><span class="hljs-string">',    .'</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cobjectref()-&gt;status-&gt;code == <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_create'</span></span>) { cobjectref()-&gt;status = <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_created'</span></span>; cobjectref()-&gt;flags = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { cobjectref()-&gt;flags = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here the status of the object changes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the ‚ÄúAfter saving an object‚Äù script, rights are assigned to the saved object:</font></font><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;crs_management_outgoing_responsibleuser)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;crs_management_outgoing_responsiblegroup)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $ruser = corganization()-&gt;user(cobjectref()-&gt;crs_management_outgoing_responsibleuser); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($ruser)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $rgroup = corganization()-&gt;group(cobjectref()-&gt;crs_management_outgoing_responsiblegroup); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($rgroup)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; $rugroups = $ruser-&gt;groups(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($rugroups <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> &amp;$rug) $rug = $rug[<span class="hljs-string"><span class="hljs-string">'code'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($rgroup-&gt;code == <span class="hljs-string"><span class="hljs-string">'group_general_manager'</span></span> &amp;&amp; in_array($rgroup-&gt;code, $rugroups)) { $c = classificator(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_content'</span></span>)-&gt;value); <span class="hljs-comment"><span class="hljs-comment">// if ($c-&gt;code == 'crs_content_claim') { cobjectref()-&gt;addRolesPermissions(array( 'crs_management_tops', 'crs_management_buh', 'crs_management_gip', 'crs_management_dp', 'crs_management_pmo', )); } else { cobjectref()-&gt;addRolesPermissions(array( 'crs_management_tops', 'crs_management_dp', )); } } elseif ($rgroup-&gt;code == 'group_pdg') { cobjectref()-&gt;addRolesPermissions(array( 'crs_management_tops', // 'crs_management_buh', 'crs_management_gip', 'crs_management_dp', 'crs_management_pmo', )); } else cobjectref()-&gt;resetRolesPermissions();</span></span></code> </pre><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Forms </font></font></h4><br>  <a href="http://easla.com/">easla.com</a>      .        .    ,   .       ¬´¬ª  ¬´¬ª,         . <br>      :   .      , :   ,     .. . ,     .      ,      . <br><img src="https://habrastorage.org/files/acd/5fa/c53/acd5fac537624e0b96bccd0aad0f5f63.png"><br><br><h4>  Statuses </h4><br>  ,   ,    ,     .    : <br><ul><li>  ‚Äì   </li><li>  ‚Äî     </li></ul><br>      : <br><ul><li>    </li><li>   </li><li>   </li><li>   .  </li><li>   </li></ul><br> , ,   ,       .  ,           , ..        .    ,   . <br><br><h4>  Actions </h4><br>      ,  ‚Äì         ,      .    ,   ¬´¬ª  ¬´¬ª  . <br><br><h5>  [‚Ä¶] </h5><br> ,       ,          : <br><ul><li>   </li><li>   </li><li>   </li><li>   </li></ul><br>     ,    : <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_sentdate'</span></span>)-&gt;value)) { cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_sentdate'</span></span>)-&gt;value = currentDateTime(); } cobjectref()-&gt;status = <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_courier'</span></span>; $msg = cobjectref()-&gt;commentTasks(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($msg)) <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$msg);</code> </pre><br>      'crs_management_outgoing_courier'       . <br><br><h5>  .  contacts </h5><br>  ,     ¬´. ¬ª      .  ,   ,      .      .      .  : <br><pre> <code class="php hljs">$contacts = cobjectref()-&gt;prepareOutgoingContacts(); asort($contacts); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_recipients'</span></span>)-&gt;values = $contacts;</code> </pre><br><br><h5>  Add.   </h5><br>     .  ,       .   : <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value)) { $contacts = cobjectref()-&gt;prepareOutgoingContacts(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value); cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_recipients'</span></span>)-&gt;values = $contacts; }</code> </pre><br>  ,             ¬´  ¬ª  prepareOutgoingContacts.     ‚Äì    ,     ‚Äì   .   ,  ¬´¬ª   ,  ¬´¬ª. <br><br><h5>    </h5><br>      ,     , ,    .       ,  ,    !     : <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;crs_management_outgoing_performers)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'   .  !'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;crs_management_outgoing_contragentdate)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'       !'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cobjectref()-&gt;hasAttributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragentperson'</span></span>) &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;crs_management_outgoing_contragentperson)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'     !'</span></span>); cobjectref()-&gt;description = cobjectref()-&gt;calcOutgoingDesc(); $to = corganization()-&gt;users(cobjectref()-&gt;crs_management_outgoing_performers); $body = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">' !'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">': '</span></span>.cobjectref()-&gt;viewLink(), <span class="hljs-string"><span class="hljs-string">': '</span></span>.cobjectref()-&gt;crs_management_outgoing_subj, <span class="hljs-string"><span class="hljs-string">'  .'</span></span>, <span class="hljs-string"><span class="hljs-string">': '</span></span>.(cobjectref()-&gt;hasAttributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragentperson'</span></span>) ? cobjectref()-&gt;crs_management_outgoing_contragentperson : <span class="hljs-string"><span class="hljs-string">''</span></span>), <span class="hljs-string"><span class="hljs-string">'   : '</span></span>.cobjectref()-&gt;crs_management_outgoing_contragentdate, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' ,'</span></span>, cuser()-&gt;description ); $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'from'</span></span>=&gt;cuser(), <span class="hljs-string"><span class="hljs-string">'to'</span></span>=&gt;$to, <span class="hljs-string"><span class="hljs-string">'subj'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'   '</span></span>.cobjectref()-&gt;description, <span class="hljs-string"><span class="hljs-string">'body'</span></span>=&gt;implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$body), ); $options[<span class="hljs-string"><span class="hljs-string">'bcc'</span></span>] = cuser(); sendEmail($options); $message = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($to <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $u) $message[] = $u-&gt;viewLink(); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'   :'</span></span>.implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, $message); <span class="hljs-comment"><span class="hljs-comment">//   caction()-&gt;result = ' : '.implode(',', $message);</span></span></code> </pre><br> ,   <a href="http://easla.com/">easla.com</a>   .    sendMail     !      ,      .  It's simple! <br><br><h5>  </h5><br>        .    ,       .   ,    ,  ¬´   ¬ª.       <a href="http://easla.com/">easla.com</a>    ,  ¬´¬ª  , .        ,  .         .       .     . <br>          . ,          ,    .         : <br><pre> <code class="php hljs">$odt = date_create(); $cdt = date_add(date_create(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateInterval(<span class="hljs-string"><span class="hljs-string">'P1D'</span></span>)); $share = shareFiles( cobjectref(), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>,<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>), $odt, $cdt, cuser(), <span class="hljs-string"><span class="hljs-string">'CP866'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($share)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"      !"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'      : '</span></span>.$share-&gt;link();</code> </pre><br>    ,        ,  . <br><img src="https://habrastorage.org/files/c94/858/3b0/c948583b07104996af50eb4f44afce0a.png"><br><br><h5>   </h5><br> - ,     .     ,  ¬´  . ¬ª   . ‚Ä¶ <br>    ,      ,       .    : <br><pre> <code class="php hljs">cobjectref()-&gt;status = <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_created'</span></span>;</code> </pre><br><br><h5>  </h5><br>   ,    ,     .       ¬´¬ª      .      : <br><pre> <code class="php hljs">$new_notification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Objectref(); $new_notification-&gt;prepare(objectDef(<span class="hljs-string"><span class="hljs-string">'tsk_management'</span></span>,<span class="hljs-string"><span class="hljs-string">'tsk_notification'</span></span>)); $new_notification-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'tsk_notification_subj'</span></span>)-&gt;value = <span class="hljs-string"><span class="hljs-string">'   '</span></span>.cobjectref()-&gt;description; $new_notification-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'tsk_notification_base'</span></span>)-&gt;value = cobjectref()-&gt;id; caction()-&gt;redirect = urlNewObjectref($new_notification);</code> </pre><br><br><h5>   </h5><br>           .   , ,   ¬´¬ª,    : <br><pre> <code class="php hljs">$subj = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value)) $subj = $subj.(strlen($subj) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-string"><span class="hljs-string">' '</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>).cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value; $new_task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Objectref(); $new_task-&gt;prepare(objectDef(<span class="hljs-string"><span class="hljs-string">'tsk_management'</span></span>,<span class="hljs-string"><span class="hljs-string">'tsk_task'</span></span>)); $new_task-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'tsk_task_subj'</span></span>)-&gt;value = $subj; $new_task-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'tsk_task_base_open'</span></span>)-&gt;value = cobjectref()-&gt;id; caction()-&gt;redirect = urlNewObjectref($new_task);</code> </pre><br><br>      , ,       .    !  ,      !  ! <br><br><h5>   .  </h5><br>      !          .         !    ,   ,        . <br>   ,    ,         3 ,      200  .          , ..  ¬´ ¬ª    .    , ,     ,     -  / / ,  ,     ,       : <br> ‚Äî ,    !  You are welcome! <br> ‚Äî   ?   ! <br> ‚Äî  ? <br> ‚Äî           ,       . <br> ‚Äî   ? <br> ‚Äî  ! <br>  On that and decided.   9          .  .  .   ¬´  . ¬ª.        5!    ,            3 ! <br> ,   ,      PHP : <br><div class="spoiler"> <b class="spoiler_title">-      . </b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_regnum'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'      !'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'     !'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contactEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($contact)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contact)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $emails = $contact-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_email'</span></span>)-&gt;value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($emails)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $emails[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contragentEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($contagent)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contagent)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $emails = $contagent-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crm_management_contragent_email'</span></span>)-&gt;value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($emails)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $emails[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($contact)</span></span></span><span class="hljs-function"> </span></span>{ $e = contactEmail($contact); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($e === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($contact-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"     "</span></span>.$contact-&gt;viewLink()); $contragent = select($contact-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent'</span></span>)-&gt;value); $e = contragentEmail($contragent); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $e === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($e =&gt; $contact-&gt;description); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMainEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($contact)</span></span></span><span class="hljs-function"> </span></span>{ $e = contactEmail($contact); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($e === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) $email_1 = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $email_1 = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($e =&gt; $contact-&gt;description); $contragent = select($contact-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crm_management_contact_contragent'</span></span>)-&gt;value); $e = contragentEmail($contragent); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($e === <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) $email_2 = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $email_2 = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($e =&gt; $contragent-&gt;description); $emails = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($email_1) $emails += $email_1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($email_2) $emails += $email_2; <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($email_1, $email_2); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $emails === <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>() ? <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> : $emails; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendEmailDocumentOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$msg, $objref, $to, $cc, $user, $checkSize = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5120000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $maxSize = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'4500k'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $extra_msg = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $dfs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>)-&gt;filesSize; $body = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">' !'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'     .'</span></span>, easla.com <span class="hljs-string"><span class="hljs-string">'    '</span></span>.$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $extra_msg, <span class="hljs-string"><span class="hljs-string">',       @sngp.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' ,'</span></span>, $user-&gt;description ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($dfs &lt; $checkSize) $files = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'compress'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'zip'</span></span>, <span class="hljs-string"><span class="hljs-string">'codepage'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'CP866'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $files = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'compress'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'maxSize'</span></span>=&gt;$maxSize)); $files[<span class="hljs-string"><span class="hljs-string">'attributeCodes'</span></span>] = <span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>; $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'from'</span></span>=&gt;$user, <span class="hljs-string"><span class="hljs-string">'to'</span></span>=&gt;$to, <span class="hljs-string"><span class="hljs-string">'subj'</span></span>=&gt;$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value, <span class="hljs-string"><span class="hljs-string">'body'</span></span>=&gt;implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$body), <span class="hljs-string"><span class="hljs-string">'objects'</span></span>=&gt;$objref, <span class="hljs-string"><span class="hljs-string">'files'</span></span>=&gt;$files ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($cc)) $options[<span class="hljs-string"><span class="hljs-string">'cc'</span></span>] = $cc; $options[<span class="hljs-string"><span class="hljs-string">'bcc'</span></span>] = $user; sendEmail($options); $rcvs = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($to <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cc)) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cc <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; $msg = <span class="hljs-string"><span class="hljs-string">'   : '</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $rcvs).<span class="hljs-string"><span class="hljs-string">'   : '</span></span>.$dfs; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendEmailDocumentAndAttachments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$msg, $objref, $to, $cc, $user, $checkSize = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5120000</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $maxSize = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'4500k'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $extra_msg = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $dfs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>)-&gt;filesSize; $afs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>)-&gt;filesSize; $body = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">' !'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'     .'</span></span>, easla.com <span class="hljs-string"><span class="hljs-string">'    '</span></span>.$objref-&gt;description.($afs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-string"><span class="hljs-string">'  '</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>).<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $extra_msg, <span class="hljs-string"><span class="hljs-string">',       @sngp.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' ,'</span></span>, $user-&gt;description ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($dfs +$afs &lt; $checkSize) $files = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'compress'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'zip'</span></span>, <span class="hljs-string"><span class="hljs-string">'codepage'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'CP866'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $files = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'compress'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'maxSize'</span></span>=&gt;$maxSize)); $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'from'</span></span>=&gt;$user, <span class="hljs-string"><span class="hljs-string">'to'</span></span>=&gt;$to, <span class="hljs-string"><span class="hljs-string">'subj'</span></span>=&gt;$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value, <span class="hljs-string"><span class="hljs-string">'body'</span></span>=&gt;implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$body), <span class="hljs-string"><span class="hljs-string">'objects'</span></span>=&gt;$objref, <span class="hljs-string"><span class="hljs-string">'files'</span></span>=&gt;$files ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($cc)) $options[<span class="hljs-string"><span class="hljs-string">'cc'</span></span>] = $cc; $options[<span class="hljs-string"><span class="hljs-string">'bcc'</span></span>] = $user; sendEmail($options); $rcvs = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($to <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cc)) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cc <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; $msg = <span class="hljs-string"><span class="hljs-string">'     : '</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $rcvs).<span class="hljs-string"><span class="hljs-string">'   : '</span></span>.($dfs+$afs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendShareDocumentAndAttachments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$msg, $objref, $to, $cc, $user, $extra_msg = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $odt = date_create(); $cdt = date_add(date_create(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateInterval(<span class="hljs-string"><span class="hljs-string">'P14D'</span></span>)); $share = shareFiles( cobjectref(), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>,<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>), $odt, $cdt, $user, <span class="hljs-string"><span class="hljs-string">'CP866'</span></span> ); $body = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">' !'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'     .'</span></span>, easla.com <span class="hljs-string"><span class="hljs-string">'          '</span></span>.$share-&gt;link().<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $extra_msg, <span class="hljs-string"><span class="hljs-string">',       @sngp.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' ,'</span></span>, $user-&gt;description ); $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'from'</span></span>=&gt;$user, <span class="hljs-string"><span class="hljs-string">'to'</span></span>=&gt;$to, <span class="hljs-string"><span class="hljs-string">'subj'</span></span>=&gt;$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value, <span class="hljs-string"><span class="hljs-string">'body'</span></span>=&gt;implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$body), ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($cc)) $options[<span class="hljs-string"><span class="hljs-string">'cc'</span></span>] = $cc; $options[<span class="hljs-string"><span class="hljs-string">'bcc'</span></span>] = $user; sendEmail($options); $rcvs = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($to <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cc)) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cc <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; $msg = <span class="hljs-string"><span class="hljs-string">'   '</span></span>.$share-&gt;link().<span class="hljs-string"><span class="hljs-string">'       : '</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $rcvs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shareAttachments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$msg, $objref, $user)</span></span></span><span class="hljs-function"> </span></span>{ $odt = date_create(); $cdt = date_add(date_create(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateInterval(<span class="hljs-string"><span class="hljs-string">'P14D'</span></span>)); $share = shareFiles( cobjectref(), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>), $odt, $cdt, $user, <span class="hljs-string"><span class="hljs-string">'CP866'</span></span> ); $msg = <span class="hljs-string"><span class="hljs-string">'        '</span></span>.$share-&gt;link(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendAsIsDocumentAndAttachments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$msg, $objref, $to, $cc, $user, $maxSize = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'4500k'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, $extra_msg = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ $dfs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>)-&gt;filesSize; $afs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>)-&gt;filesSize; $body = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">' !'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'     .'</span></span>, easla.com <span class="hljs-string"><span class="hljs-string">'    '</span></span>.$objref-&gt;description.($afs &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ? <span class="hljs-string"><span class="hljs-string">'  '</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>).<span class="hljs-string"><span class="hljs-string">'     '</span></span>. $maxSize.<span class="hljs-string"><span class="hljs-string">'.'</span></span>, $extra_msg, <span class="hljs-string"><span class="hljs-string">',       @sngp.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' ,'</span></span>, $user-&gt;description ); $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'from'</span></span>=&gt;$user, <span class="hljs-string"><span class="hljs-string">'to'</span></span>=&gt;$to, <span class="hljs-string"><span class="hljs-string">'subj'</span></span>=&gt;$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value, <span class="hljs-string"><span class="hljs-string">'body'</span></span>=&gt;implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$body), <span class="hljs-string"><span class="hljs-string">'objects'</span></span>=&gt;$objref, <span class="hljs-string"><span class="hljs-string">'files'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'maxSize'</span></span>=&gt;$maxSize) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($cc)) $options[<span class="hljs-string"><span class="hljs-string">'cc'</span></span>] = $cc; $options[<span class="hljs-string"><span class="hljs-string">'bcc'</span></span>] = $user; sendEmail($options); $rcvs = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($to <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cc)) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cc <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; $msg = <span class="hljs-string"><span class="hljs-string">'     : '</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $rcvs).<span class="hljs-string"><span class="hljs-string">'   : '</span></span>.($dfs+$afs); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendFtpSngpRuAttachments</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&amp;$msg, $objref, $to, $cc, $user, $login, $password)</span></span></span><span class="hljs-function"> </span></span>{ $ftp_addr = <span class="hljs-string"><span class="hljs-string">'ftp.sngp.ru'</span></span>; $ftp_link = <span class="hljs-string"><span class="hljs-string">''</span></span>; $dfs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>)-&gt;filesSize; $afs = $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>)-&gt;filesSize; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>)-&gt;filesCount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $ftp = ftp_ssl_connect($ftp_addr); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($ftp == <span class="hljs-keyword"><span class="hljs-keyword">FALSE</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'    FTPS  '</span></span>.$ftp_addr.<span class="hljs-string"><span class="hljs-string">'!'</span></span>); ftp_login($ftp,$login,$password); ftp_pasv($ftp, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $dir = <span class="hljs-string"><span class="hljs-string">"files"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!@ftp_chdir($ftp, $dir)) { ftp_mkdir($ftp, $dir); ftp_chdir($ftp, $dir); } $zip = normalizeFilename($objref-&gt;description).<span class="hljs-string"><span class="hljs-string">' - .zip'</span></span>; $objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_attachments'</span></span>)-&gt;ftp_put($ftp, $zip, FTP_BINARY); ftp_close($ftp); $ftp_link = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-string"><span class="hljs-string">'.$zip.'</span></span> } $files = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'attributeCodes'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_document'</span></span>, <span class="hljs-string"><span class="hljs-string">'compress'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'zip'</span></span>, <span class="hljs-string"><span class="hljs-string">'codepage'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'CP866'</span></span> ); $body = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">' !'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'     .'</span></span>, easla.com <span class="hljs-string"><span class="hljs-string">'    '</span></span>.$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">'  '</span></span>.formatSize($dfs).<span class="hljs-string"><span class="hljs-string">'.'</span></span>, ($ftp_link == <span class="hljs-string"><span class="hljs-string">''</span></span> ? <span class="hljs-string"><span class="hljs-string">''</span></span> : <span class="hljs-string"><span class="hljs-string">'   FTPS  ftps://'</span></span>.$ftp_addr.<span class="hljs-string"><span class="hljs-string">' [: '</span></span>.$login.<span class="hljs-string"><span class="hljs-string">']  '</span></span>.$ftp_link.<span class="hljs-string"><span class="hljs-string">'.'</span></span>), <span class="hljs-string"><span class="hljs-string">',       @sngp.ru'</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' ,'</span></span>, $user-&gt;description ); $options = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'from'</span></span>=&gt;$user, <span class="hljs-string"><span class="hljs-string">'to'</span></span>=&gt;$to, <span class="hljs-string"><span class="hljs-string">'subj'</span></span>=&gt;$objref-&gt;description.<span class="hljs-string"><span class="hljs-string">' '</span></span>.$objref-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_subj'</span></span>)-&gt;value, <span class="hljs-string"><span class="hljs-string">'body'</span></span>=&gt;implode(<span class="hljs-string"><span class="hljs-string">''</span></span>,$body), <span class="hljs-string"><span class="hljs-string">'objects'</span></span>=&gt;$objref, <span class="hljs-string"><span class="hljs-string">'files'</span></span>=&gt;$files ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($cc)) $options[<span class="hljs-string"><span class="hljs-string">'cc'</span></span>] = $cc; $options[<span class="hljs-string"><span class="hljs-string">'bcc'</span></span>] = $user; sendEmail($options); $rcvs = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($to <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cc)) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cc <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().<span class="hljs-string"><span class="hljs-string">' ('</span></span>.$e.<span class="hljs-string"><span class="hljs-string">')'</span></span>; $msg = <span class="hljs-string"><span class="hljs-string">'   : '</span></span>.implode(<span class="hljs-string"><span class="hljs-string">','</span></span>, $rcvs).<span class="hljs-string"><span class="hljs-string">'  : '</span></span>.($dfs).<span class="hljs-string"><span class="hljs-string">'    '</span></span>.$ftp_addr.<span class="hljs-string"><span class="hljs-string">' [: '</span></span>.$login.<span class="hljs-string"><span class="hljs-string">'].'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contragent'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'    ()   '</span></span>.cobjectref()-&gt;viewLink()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>(cobjectref()-&gt;attributeref(<span class="hljs-string"><span class="hljs-string">'crs_management_outgoing_contact'</span></span>)-&gt;value)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">'    ()   '</span></span>.cobjectref()-&gt;viewLink()); <span class="hljs-comment"><span class="hljs-comment">//define $to $contragent = select(cobjectref()-&gt;attributeref('crs_management_outgoing_contragent')-&gt;value); $to = contragentEmail($contragent); if ($to === false) throw new Exception('  .   '.$contragent-&gt;viewLink().'   '.cobjectref()-&gt;viewLink()); $to = array($to =&gt; $contragent-&gt;description); //define $cc $cc = array(); $contact = select(cobjectref()-&gt;attributeref('crs_management_outgoing_contact')-&gt;value); $tmp = getEmail($contact); if ($tmp === false) throw new Exception('  .   '.$contact-&gt;viewLink().'   '.cobjectref()-&gt;viewLink()); $cc += $tmp; if (!empty(cobjectref()-&gt;attributeref('crs_management_outgoing_recipients')-&gt;value)) { $contacts = selects(cobjectref()-&gt;attributeref('crs_management_outgoing_recipients')-&gt;value); foreach ($contacts as $contact) { $tmp = getEmail($contact); if ($tmp === false) throw new Exception('  .   '.$contact-&gt;viewLink().'   '.cobjectref()-&gt;viewLink()); $cc += $tmp; } } if (!empty(cobjectref()-&gt;attributeref('crs_management_outgoing_notifiers')-&gt;value)) { $contacts = selects(cobjectref()-&gt;attributeref('crs_management_outgoing_notifiers')-&gt;value); foreach ($contacts as $contact) { $tmp = getEmail($contact); if ($tmp === false) throw new Exception('  .   '.$contact-&gt;viewLink().'   '.cobjectref()-&gt;viewLink()); $cc += $tmp; } } if (empty($cc)) $cc = null; $cuser = cuser(); $rule = ''; if (cobjectref()-&gt;hasAttributeref('crs_management_outgoing_rule')) $rule = classificator(cobjectref()-&gt;crs_management_outgoing_rule)-&gt;code; $link = ''; if (cobjectref()-&gt;hasAttributeref('crs_management_outgoing_attachments_link')) { if (!empty(cobjectref()-&gt;attributeref('crs_management_outgoing_attachments_link')-&gt;value)) $link = '   .   .';  } $msg = ''; switch ($rule) { case 'crs_outgoing_rule_all_max5': sendEmailDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, 5120000, '4500k', $link); break; case 'crs_outgoing_rule_all_max4': sendEmailDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, 4096000, '3500k', $link); break; case 'crs_outgoing_rule_all_max3': sendEmailDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, 3072000, '2500k', $link); break; case 'crs_outgoing_rule_all_max10': sendEmailDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, 10240000, '9500k', $link); break; case 'crs_outgoing_rule_all_max25': sendEmailDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, 25600000, '20m', $link); break; case 'crs_outgoing_rule_doc_att_max5': if (empty($cc)) sendEmailDocumentAndAttachments($msg, cobjectref(), $to, null, $cuser, 5120000, '4500k', $link); else { $m1 = ''; $m2 = ''; sendEmailDocumentOnly($m1, cobjectref(), $to, null, $cuser, 5120000, '4500k', $link); sendEmailDocumentAndAttachments($m2, cobjectref(), $cc, null, $cuser, 5120000, '4500k', $link); $msg = $m1.' '.$m2; unset($m1,$m2); } break; case 'crs_outgoing_rule_doc_att_max25': if (empty($cc)) sendEmailDocumentAndAttachments($msg, cobjectref(), $to, null, $cuser, 25600000, '20m', $link); else { $m1 = ''; $m2 = ''; sendEmailDocumentOnly($m1, cobjectref(), $to, null, $cuser, 25600000, '20m', $link); sendEmailDocumentAndAttachments($m2, cobjectref(), $cc, null, $cuser, 25600000, '20m', $link); $msg = $m1.' '.$m2; unset($m1,$m2); } break; case 'crs_outgoing_rule_all_share': sendShareDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, $link); break; case 'crs_outgoing_rule_doc_att_share': if (empty($cc)) { if (empty(cobjectref()-&gt;attributeref('crs_management_outgoing_attachments')-&gt;value)) sendEmailDocumentOnly($msg, cobjectref(), $to, null, $cuser, 25600000, '20m', $link); else sendShareDocumentAndAttachments($msg, cobjectref(), $to, null, $cuser, $link); } else { $m1 = ''; $m2 = ''; sendEmailDocumentOnly($m1, cobjectref(), $to, null, $cuser, 25600000, '20m', $link); sendShareDocumentAndAttachments($m2, cobjectref(), $cc, null, $cuser, $link); $msg = $m1.' '.$m2; unset($m1,$m2); } break; case 'crs_outgoing_rule_doc_att_share_max1': $sum = cobjectref()-&gt;attributeref('crs_management_outgoing_document')-&gt;filesSize + cobjectref()-&gt;attributeref('crs_management_outgoing_attachments')-&gt;filesSize; if ($sum &lt; 1048576) { sendAsIsDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, '1m', $link); } else { $m1 = ''; $m2 = ''; shareAttachments($m2, cobjectref(), $cuser); sendEmailDocumentOnly($msg, cobjectref(), $to, $cc, $cuser, 25600000, '20m', $m2.''.$link); } break; case 'crs_outgoing_rule_asis_max3': sendAsIsDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, '3m', $link); break; case 'crs_outgoing_rule_asis_max5': sendAsIsDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, '5m', $link); break; case 'crs_outgoing_rule_asis_max10': sendAsIsDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, '10m', $link); break; case 'crs_outgoing_rule_asis_max20': sendAsIsDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, '20m', $link); break; case 'crs_outgoing_rule_ftp_sngp_ru_tyungd': sendFtpSngpRuAttachments($msg, cobjectref(), $to, $cc, $cuser, ' ', ' '); break; default: sendEmailDocumentAndAttachments($msg, cobjectref(), $to, $cc, $cuser, $link); } if (empty(cobjectref()-&gt;attributeref('crs_management_outgoing_sentdate')-&gt;value)) { cobjectref()-&gt;attributeref('crs_management_outgoing_sentdate')-&gt;value = currentDateTime(); cobjectref()-&gt;description = cobjectref()-&gt;calcOutgoingDesc(); cobjectref()-&gt;updateDocumentFileName(); } cobjectref()-&gt;status = 'crs_management_outgoing_email'; $rcvs = array(); foreach ($to as $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().' ('.$e.')'; if (isset($cc)) foreach ($cc as $e=&gt;$d) $rcvs[] = corganization()-&gt;object($d)-&gt;viewLink().' ('.$e.')'; //  $notices = array(); $ruser = corganization()-&gt;user(cobjectref()-&gt;crs_management_outgoing_responsibleuser); $rgroups = $ruser-&gt;groups(); if (empty($rgroups)) $notices[] = $ruser; else { $f = false; foreach($rgroups as $rgroup) if (strncmp($rgroup['data_one'],'09.',3) == 0) { $notices = $rgroup-&gt;users(); $f = true; break; } if (!$f) $notices[] = $ruser; } if (!empty(cobjectref()-&gt;crs_management_outgoing_performers)) { $eusers = corganization()-&gt;users(cobjectref()-&gt;crs_management_outgoing_performers); if (!empty($eusers)) $notices = array_merge($notices, $eusers); } $notices = array_unique($notices, SORT_REGULAR); if (!empty(cobjectref()-&gt;crs_management_outgoing_contract)) { $contracts = selects(cobjectref()-&gt;crs_management_outgoing_contract); foreach($contracts as &amp;$c) { $c = $c-&gt;viewLink(); } } else { $contracts = array(); } foreach($notices as $n) { $rbody = array( ' '.$n-&gt;description.'!', ' ', ': '.cobjectref()-&gt;viewLink(), ': '.cobjectref()-&gt;crs_management_outgoing_subj, ':'.implode(', ', $contracts), '  :', implode('', $rcvs), ' ', ' ,', cuser()-&gt;description ); sendEmail(array( // 'from'=&gt;cuser(), 'to'=&gt;$n, 'subj'=&gt;'   '.cobjectref()-&gt;description, 'body'=&gt;implode('',$rbody), )); } $task_msg = cobjectref()-&gt;commentTasks(); if (!empty($task_msg)) $msg .= ''.implode('',$task_msg); echo $msg; //   caction()-&gt;result = $msg;</span></span></code> </pre><br></div></div><br>       sendMail.      ,       ,    <a href="https://ru.wikipedia.org/wiki/ZIP">zip</a> ,     <a href="https://ru.wikipedia.org/wiki/7-Zip">7zip</a>     . <br>    .            : <br><img src="https://habrastorage.org/files/ef6/7fb/581/ef67fb581ecb434cbf6daa6d8e38a399.png"><br><br><h4>  </h4><br>     .       ,  ,    , ..     . <br><img src="https://habrastorage.org/files/f12/7c1/5d0/f127c15d04b74e99936ec15c5edfa770.png"><br><br><h4>   </h4><br>      .  !  ,    , ,     - ! <br>       .     ,      .    <a href="http://easla.com/">easla.com</a>   ,     ! <br> PS .    ¬´ ¬ª        <a href="https://easla.com/ru/process/infoAlone/process_id/159"></a> .  ,          . </div><p>Source: <a href="https://habr.com/ru/post/281999/">https://habr.com/ru/post/281999/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../281989/index.html">Intel security hardware technology: a new word in the protection of biometric applications. Part one</a></li>
<li><a href="../281991/index.html">The PDO MSSQL driver (pdo_sqlsrv) for PHP7 is out</a></li>
<li><a href="../281993/index.html">Droplet of reflection for C ++. Part One: Development Retrospective</a></li>
<li><a href="../281995/index.html">Droplet of reflection for C ++. Part Two: Posting on GitHub</a></li>
<li><a href="../281997/index.html">A bit of reflection for C ++. Part Three: Documentation</a></li>
<li><a href="../282001/index.html">New course on microcontrollers - a joint project of industry and universities</a></li>
<li><a href="../282003/index.html">Setting up PhpStorm for layout on Windows</a></li>
<li><a href="../282005/index.html">How to become an IT princess</a></li>
<li><a href="../282009/index.html">RUVDS will provide BCS clients with virtual servers in the heart of the Moscow Exchange</a></li>
<li><a href="../282011/index.html">Explaining the inexplicable. Part 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>