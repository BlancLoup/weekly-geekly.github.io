<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unit tests in ASP.NET WebForms</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About unit tests 
 Unit tests are known to be a software developer's headache pill. If used correctly and according to the instructions, then a health...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unit tests in ASP.NET WebForms</h1><div class="post__text post__text-html js-mediator-article"><h4>  About unit tests </h4><br>  Unit tests are known to be a software developer's headache pill.  If used correctly and according to the instructions, then a healthy complexion and shine in the eyes is provided without stimulating agents.  About unit tests speak differently: with aspiration, those who read about them in MSDN magazine, with admiration those who have already plunged into the world of the beautiful, and with regret those who, by the will of fate, have to work in an environment totally unacceptable to this heavenly mana.  I can only wish decisiveness first, applauding the second, but this article is addressed to the third. <br><br><h4>  Who is it for?  About what? </h4><br>  This article is about the same as me, the developers of corporate sites in C # / ASP.NET WebForms.  People who, like me, have grown to the realization that ASP.NET WebForms is cool, but not quite.  Not really, because web forms do not support unit tests, and therefore TDD.  And the only practical way to write strong code is to read it thoughtfully.  So I suffered the last few years developing existing asp.net projects, until I finally saw the light.  About insight and will be discussed. <br><a name="habracut"></a><br><br><h4>  A bit of history </h4><br>  At the time of formation, WebForms was intended for desktop VB programmers who had already mastered the CommandButton, ComboBox and Click event (do not rush, I started it that way too!), Heard about the unprecedented heyday of the Internet (everyone remembers the dotcom boom?) And decided to invest in this business.  For these, WebForms was invented, which most fully transferred the concept of RAD (rapid application development) to the web: form controls, event handlers, and an optional heap of whistles. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What is the problem? </h4><br>  And everything would be great, but then suddenly, it turned out that in this form, the developer is very easy to mix business logic with the presentation and get stuffing that can not be tested. <br>  To whom the above mentioned affected the depths of programmer indignation, it is clear that the problem is in the environment.  Not only is it difficult to design a reliable, expandable system, as well ASP.NET rests on all the horns and hooves!  Here's how to test ascx control if everything in it is hung up on events?  Hands all, you will not test. <br><br><h4>  How to be? </h4><br>  It is here that I come smoothly and gently to the topic of the article. <br><br><h5>  First, some foreplay </h5><br>  As I said above, one and the fundamental problems is mixing business logic and presentation in one pile.  It is necessary to dilute them in the corners.  Here it is appropriate to use one of the varieties of MVC, MVP.  Because in MVP, View controls the appearance, as well as serves user requests.  The role of Presenter is to prepare data for the view, as well as communication with the data repository for example.  Model is a View Model, aka container containing data for displaying the view.  So, MVP ideally fits into the ASP.NET operation scheme: view is all the same user control, presenter, this is a class containing business logic, and a model is also a class containing data. <br><br>  Laugh work is as follows: view takes the model from the presenter, but when it needs it, and also notifies it of the user's input if it exists.  Presenter, in turn, listens to the view of other presenters and creates a model on demand, taking into account all the incoming data. <br><br><h5>  Begin to pull in the side of the bedroom </h5><br>  Having dealt with the basic structure, you can start writing tests.  It is clear that writing a unit test covering absolutely everything is impractical because such a test will be 2-3 times longer than the class it tests. <br>  A little thought, I wrote a list of possible interactions of components: <br><ul><li>  Presenter-domain (under the domain, I mean domain, that is, repositories, data warehouses, etc.) </li><li>  View-presenter (how view treats presenter methods) </li><li>  User-view (which input comes from the user) </li></ul><br>  And accordingly the following types of tests <br><ul><li>  The interaction of the presenter-domain will be covered by the unit with a presenter test. </li><li>  The interaction of the view-presenter will be covered by the unit test view. </li><li>  Finally, user-view interaction will be covered by an integration test (browser scripting). </li></ul><br><br>  In this article I will talk about the most difficult, about the unit test view.  In the following articles I will describe less complex tests. <br><br><h5>  Go! </h5><br><br>  So, as already mentioned, view is the usual ascx control.  Such control should be hosted on the aspx page in the asp.net runtime.  To do this, you can use the method <br><pre><code class="cs hljs">System.Web.Hosting.ApplicationHost.CreateApplicationHost(Type hostType, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> virtualDir, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> physicalDir)</code> </pre> <br><br>  where hostType must be the type inheriting MarshalByRefObject, and virtualDir and physicalDir must specify the virtual path and physical path, respectively.  CreateApplicationHost returns a host to which HTTP requests can be sent. <br><br>  Now let's think about what we want to write in a unit test?  Since this test covers the interaction between the view and the presenter, it is necessary to write a list of possible scenarios and run the view on them in parallel, tracking what and how the presenter was transmitted.  That is, from our unit test you need to be able to send requests, create a presenter, receive answers, as well as control what happened during the processing of requests. <br><br>  If it is not difficult in principle with requests (for example, to simulate a postback, you just need to correctly compose the POST request parameters), then controlling the presenter is by no means trivial, because it lives on the other side of the AppDomain. <br><br>  AppDomain is something like a process in process.  In other words, the .NET environment allows you to split executable code in the system process into logical subprocesses that are isolated from each other.  In our case, CreateApplicationHost creates a new host just in another AppDomain, and therefore we can‚Äôt directly address objects from the unit test, and accordingly we have no access to the presenter on the other side of the barrier. <br><br>  Fortunately, there are proxy classes that can send requests on both sides using messages.  You can read about proxies in Google (request of type .net remoting proxy).  It is important for us to know that proxies can call methods. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Proxy</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _object; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Proxy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span> { _object = obj; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TResult Invoke&lt;TResult&gt;(Func&lt;T, TResult&gt; selector) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> selector(_object); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;T&gt; action</span></span></span><span class="hljs-function">)</span></span> { action(_object); } }</code> </pre><br><br>  In addition, the question arises, in what specific way will we track the interaction of the view-presenter.  For simplicity, we can use any mocking framework that can track class calls.  In this case, I chose <a href="http://code.google.com/p/moq/">Moq</a> . <br><br>  And the last is a container for data transfer.  We have a lot to transmit: data on the mock-presenter, data on the environment, data on the request, and so on.  Without further ado, we create the TestData class: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestData</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Type MockPresenterType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Delegate MockPresenterInitializer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> SetPresenterMockInitializer&lt;TPresenter&gt;(Action&lt;Mock&lt;TPresenter&gt;&gt; action) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TPresenter : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.MockPresenterInitializer = action; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.MockPresenterType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TPresenter); } }</code> </pre><br><br>  In light of the above, the unit test algorithm looks like this: <br><br>  <b>On the part of the unit test:</b> <br><ol><li>  Create and configure a host </li><li>  Create and configure an instance of the TestData class </li><li>  Send request with the necessary control and testData </li><li>  Process response </li><li>  Check installation mock-presenter </li></ol><br>  <b>From the host side:</b> <br><ol><li>  In Default.aspx OnPreInit load the required control </li><li>  Create the required mock-presenter </li><li>  Apply mock-presenter settings </li></ol><br><br>  And the approximate type of unit test: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> UnitTestView { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> physicalPath = Environment.CurrentDirectory.Substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, Environment.CurrentDirectory.IndexOf(<span class="hljs-string"><span class="hljs-string">"bin"</span></span>)); TestHost host = (TestHost)ApplicationHost.CreateApplicationHost(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TestHost), <span class="hljs-string"><span class="hljs-string">"/Testing"</span></span>, physicalDir); TestData testData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestData(); testData.SetPresenterMockInitializer&lt;Presenter&gt;( mock =&gt; { mock.Setup(m =&gt; ...); }); host.AddQueryParameter(<span class="hljs-string"><span class="hljs-string">"ControlToTest"</span></span>, <span class="hljs-string"><span class="hljs-string">"~/OurView.ascx"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> response = host.ProcessRequest(<span class="hljs-string"><span class="hljs-string">"Default.aspx"</span></span>, testData, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); XDocument doc = XDocument.Parse(response); host.GetPresenterMock&lt;Presenter&gt;().Invoke(mock =&gt; mock.Verify(m =&gt; m.SomeMethodRan(), Times.Once())); }</code> </pre><br><br>  From the host side, the Default.aspx.cs code also looks very simple: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Default</span></span> : <span class="hljs-title"><span class="hljs-title">Page</span></span>, <span class="hljs-title"><span class="hljs-title">IRequiresSessionState</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> PlaceHolder _phContent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PlaceHolder(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FrameworkInitialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Controls.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LiteralControl(<span class="hljs-string"><span class="hljs-string">@"&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;body&gt;"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlForm(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Controls.Add(form); form.Controls.Add(_phContent); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Controls.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LiteralControl(<span class="hljs-string"><span class="hljs-string">@"&lt;/body&gt;&lt;/html&gt;"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPreInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPreInit(e); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controlToTest = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Request.QueryString[<span class="hljs-string"><span class="hljs-string">"ControlToTest"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> testData = (TestData)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Context.Items[<span class="hljs-string"><span class="hljs-string">"TestData"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (controlToTest != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Control c = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.LoadControl(controlToTest); Type viewType = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">get</span></span></span><span class="hljs-function"> view type </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> that control </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">viewType != </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> presenter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (testData.MockPresenterType != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mockType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Mock&lt;&gt;).MakeGenericType(testData.MockPresenterType); <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> mock = Activator.CreateInstance(mockType); AppDomain.CurrentDomain.SetData(<span class="hljs-string"><span class="hljs-string">"PresenterMock"</span></span>, mock); presenter = mockType.GetProperty(<span class="hljs-string"><span class="hljs-string">"Object"</span></span>, testData.MockPresenterType).GetValue(mock, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); testData.MockPresenterInitializer.DynamicInvoke(mock); viewType.GetProperty(<span class="hljs-string"><span class="hljs-string">"Presenter"</span></span>).SetValue(c, presenter, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); AppDomain.CurrentDomain.SetData(<span class="hljs-string"><span class="hljs-string">"Presenter"</span></span>, presenter); _phContent.Controls.Add(c); } }</code> </pre><br><br>  Here I intend to omit the details of the viewType search for it is purely individual (besides, I did not describe how I implemented the MVP pattern).  The key points are <br><ul><li>  Creating and adding a control passed to QueryString </li><li>  Creating a MockPresenter and adding it to the AppDomain via AppDomain.SetData.  Using AppDomain.GetData unit test will be able to access our MockPresenter </li><li>  Calling DynamicInvoke which will apply settings (mock =&gt; mock.Setup ...) </li></ul><br><br>  The companion class TestHost is shown below: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestHost</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; _query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddQueryParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { _query.Add(key, HttpUtility.UrlEncode(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetQueryParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameter <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _query) { sb.AppendFormat(<span class="hljs-string"><span class="hljs-string">"{0}={1}&amp;"</span></span>, parameter.Key, parameter.Value); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.ToString(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> page, TestData testData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> postData</span></span></span><span class="hljs-function">)</span></span> { StringWriter writer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringWriter(); TestRequest swr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestRequest(page, GetQueryParameters(), writer, testData, postData); HttpRuntime.ProcessRequest(swr); writer.Close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> writer.ToString(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Proxy&lt;Mock&lt;TPresenter&gt;&gt; GetPresenterMock&lt;TPresenter&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TPresenter : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> mock = AppDomain.CurrentDomain.GetData(<span class="hljs-string"><span class="hljs-string">"PresenterMock"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Proxy&lt;Mock&lt;TPresenter&gt;&gt;((Mock&lt;TPresenter&gt;)mock); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestRequest</span></span> : <span class="hljs-title"><span class="hljs-title">SimpleWorkerRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TestData _testData; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _postData; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PostContentType = <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> page, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> query, TextWriter output, TestData testData, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> postData</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">page, query, output</span></span></span><span class="hljs-function">)</span></span> { _testData = testData; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(postData)) _postData = Encoding.Default.GetBytes(postData); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetEndOfSendNotification</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EndOfSendNotification callback, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> extraData</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.SetEndOfSendNotification(callback, extraData); HttpContext context = extraData <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> HttpContext; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { context.Items.Add(<span class="hljs-string"><span class="hljs-string">"TestData"</span></span>, _testData); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetHttpVerbName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_postData == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.GetHttpVerbName(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"POST"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetKnownRequestHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == HeaderContentLength) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_postData != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _postData.Length.ToString(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (index == HeaderContentType) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_postData != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PostContentType; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.GetKnownRequestHeader (index); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPreloadedEntityBody</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_postData != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _postData; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.GetPreloadedEntityBody(); } }</code> </pre><br><br><h4>  Smoke break </h4><br><br>  That's all, at this stage you already have the opportunity to write elegant unit tests (as far as possible) for asp.net webforms.  Of course, if you have the opportunity to use another more test-friendly environment, by all means, as my American colleagues say.  But if it is not there, and I want to write more stable code, now it is possible. <br><br>  By the way, I gave only the most necessary code for the proof-of-concept.  I omitted for example the process of creating a postback and transferring test data, as well as preparing test controls for the test.  If there is interest, I can write about it, as well as about my implementation of MVP, and about the other 2 types of tests I mentioned above. <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/118409/">https://habr.com/ru/post/118409/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../118400/index.html">Why am I not yet in the clouds? Idle reflections</a></li>
<li><a href="../118403/index.html">One year as one moment</a></li>
<li><a href="../118405/index.html">Ai, Ladybug, fly away to heaven</a></li>
<li><a href="../118406/index.html">Facebook increases staff by 9,400 employees.</a></li>
<li><a href="../118407/index.html">Exynos - smart and green</a></li>
<li><a href="../118411/index.html">Sencha Touch Tutorial 2: Ext.Panel - Layouting</a></li>
<li><a href="../118413/index.html">Build Ubuntu 11.04 by NNLUG</a></li>
<li><a href="../118414/index.html">Military-smartphone for the US military</a></li>
<li><a href="../118417/index.html">Symfony2: Beta 1 is available!</a></li>
<li><a href="../118420/index.html">Create an application for Windows Phone 7 from start to finish. Part 11. Methods of storing data, using data access classes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>