<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are preparing to build Go-applications in production</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In June, at the RIT ++ conference, my colleague Igor Dolzhikov and I shared our experience in automating the development of services on Go ‚Äî from the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are preparing to build Go-applications in production</h1><div class="post__text post__text-html js-mediator-article">  In June, at the RIT ++ conference, my colleague <a href="https://github.com/takama">Igor Dolzhikov and I</a> shared our experience in automating the development of services on Go ‚Äî <a href="https://youtu.be/0ndWw1udpsA%3Ft%3D7m16s">from the first commit to the release to the Kubernetes production environment</a> (yes, the video starts at 07:16, and we don‚Äôt like it either ).  Since the publication of the master class, from time to time I get questions on various topics covered in it.  Perhaps the hottest questions deserve separate consideration, and today I would like to talk about the process of building the application.  Topics are relevant not only in the preparation of services, but in general for any applications written on Go. <br><br>  Everything that is described in this article is relevant for the current version of Go - 1.9. <br><a name="habracut"></a><br><h3>  Cherished GOPATH and location code </h3><br>  When preparing an application for production, you need to be as confident as possible that the code that the developer expects will fall into the assembly.  By default, Go still does not know how to work with dependency management, which means that when the application is compiled, all ‚Äúexternal‚Äù dependencies will be searched for Go tools inside the <code>$GOPATH/src</code> directory.  How to find out the current <code>GOPATH</code> value if you are not sure about it?  This value can be found in the list of variables output by the <code>go env</code> command. <br><br>  In addition, the code of the project itself should also be inside <code>$GOPATH/src</code> , and I recommend to think in advance about the way in which it will lie.  When a project is under the control of a version control system, when it is tightened using, for example, the <code>go get</code> command, it should fall precisely along the path that we defined for the project initially.  For example, the service code that is stored in my github account in the <a href="https://github.com/rumyantseva/mif">rumyantseva / mif repository is</a> deployed inside my <code>$GOPATH/src/github.com/rumyantseva/mif</code> .  If the same code were inside the mif repository of some private storage example.com in the namespace services, then the path to it on the developer's machine would look like <code>$GOPATH/src/example.com/services/mif</code> .  In order to avoid future problems or ambiguities, the code positioning rule must be observed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Different projects can be stored both within the same <code>GOPATH</code> directory and within several.  Accordingly, in the second case, the <code>GOPATH</code> value <code>GOPATH</code> have to be redefined.  In order to do this, you will need to reset the corresponding environment variable to the desired value.  In case <code>GOPATH</code> not specified at all, Go will consider the <code>go</code> directory in the user's home directory as the working directory.  To better understand this, let's conduct several experiments with the console: <br><br><div class="spoiler">  <b class="spoiler_title">Understanding GOPATH</b> <div class="spoiler_text"><pre> <code class="bash hljs">$ <span class="hljs-comment"><span class="hljs-comment">#   GOPATH   $HOME/go: $ go env | grep GOPATH GOPATH="/Users/elena/go" $ $ #     GOPATH  ,  : $ GOPATH=/Users/tmp/something $ go env | grep GOPATH GOPATH="/Users/tmp/something" $ $ #          go env: $ GOPATH=/pampam go env | grep GOPATH GOPATH="/pampam" $ $ #       GOPATH -  : elena:~ $ go env | grep GOPATH GOPATH="/Users/tmp/test" $ $ #   GOPATH   ,  : $ GOPATH= $ go env | grep GOPATH GOPATH="/Users/elena/go" $ #       :)</span></span></code> </pre> <br></div></div><br>  However, if you still don‚Äôt like the idea of ‚Äã‚ÄãGOPATH, you can turn to tools like <a href="https://getgb.io/">gb</a> , which allows assembling regardless of the location of the code. <br><br><h3>  Work with external dependencies </h3><br>  So, if we are writing an application that uses external (relative to the current repository) dependencies, for a successful build we need all these dependencies to be inside <code>GOPATH</code> .  You can pull in dependencies automatically by calling commands such as <code>go get</code> or <code>go install</code> inside the current working project.  At the same time, we will download the code of dependencies located in the default branches of the repositories.  This is enough for the ‚Äúhere and now‚Äù situation, but in the general case, no one guarantees that after 5 minutes, back-incompatible changes will not appear in the same branches of external dependencies.  So, the next attempt to deploy the application (for example, on the build machine) can end in failure.  What will help us in this situation?  Of course, vendoring. <br><br>  About the <code>vendor</code> directory was repeatedly written on Habr√©, and in many other places, and I will not repeat.  However, I‚Äôll briefly remind you that all the dependencies that we pulled into <code>GOPATH/src</code> can also be added to the vendor directory of the current application.  How to do it?  Or manually, or with the help of a dependency management manager.  As an example of a utility for working with dependencies, we can finally mention <a href="https://github.com/golang/dep">dep</a> , the official Go experiment.  Despite the status of the "official experiment", dep is still neither absolutely stable nor recommended.  Nevertheless, we ventured to try dep in our work projects, and we liked it!  If this is your first time with the issue of dependency management, I highly recommend you a <a href="https://www.youtube.com/watch%3Fv%3DeZwR8qr2BfI">ten-minute video</a> from the conference Gophercon 2017, in which the principles of the work of dep are clearly and visually shown. <br><br>  So, on the basis of using the dependency manager, we got the <code>vendor</code> directory full of packages, and some set of metafiles describing our dependencies.  It would seem that metafiles with a description of the used tags and even hashes of commits are enough for us, and the natural desire would be to remove the <code>vendor</code> directory from the control of the version control system.  However, in real production projects, you should not do this.  Storing code with <code>vendor</code> is the only way to protect against accidents such as dropping a github or completely removing your repository from a third-party developer. <br><br><h3>  Binary Versioning </h3><br>  Perhaps almost all popular console utilities support a command or <code>version</code> flag, which allows you to display information about the current version of the binary.  The same practice can be useful in the case of a running service.  In addition, it is sometimes useful to ‚Äúsew‚Äù a binary not only the information about the semantic version, but also the hash of the commit, the build date, and other useful data. <br><br>  Such information is conveniently stored as variables, for example, in a special package.  And by calling the linker with the <code>-X</code> flag, we can automatically replace the values ‚Äã‚Äãof these variables. <br><br>  A small example.  Create a file <code>hello.go</code> with the following contents: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hello = <span class="hljs-string"><span class="hljs-string">"Hello"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> world = <span class="hljs-string"><span class="hljs-string">"World"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Printf(<span class="hljs-string"><span class="hljs-string">"%s, %s!\n"</span></span>, hello, world) }</code> </pre> <br>  When you start it normally, for example, using the <code>go run hello.go</code> , we get the string ‚ÄúHello, World!‚Äù: <br><br><pre> <code class="bash hljs">$ go run hello.go Hello, World!</code> </pre> <br><br>  And now we add a call to the linker with the <code>-X</code> flags and new variable values: <br><br><pre> <code class="bash hljs">$ go run -ldflags=<span class="hljs-string"><span class="hljs-string">"-X main.hello= -X main.world="</span></span> hello.go , !</code> </pre> <br>  It is possible to substitute not only variables from the <code>main</code> package, but also variables from any packages in general.  Thus, during the assembly of the application, you can sew into it any necessary meta-information. <br><br>  <b>upd.</b>  Thanks to <a href="https://habrahabr.ru/users/forsyte/" class="user_link">forsyte</a> for clarifying the <code>-X</code> flag <br><br><h3>  A set of instructions for building the application </h3><br>  Despite its age, the <code>make</code> utility does not lose its relevance and popularity among those who have to build applications (at least under * nix).  Here and among Go-developers this tool is rather widespread. <br><br>  Consider a <a href="https://github.com/rumyantseva/go-zeroservice/blob/1.0.0/Makefile">specific Makefile example</a> for some service.  I prepared a <a href="https://github.com/rumyantseva/go-zeroservice">go-zeroservice</a> repository containing a ‚Äúzero‚Äù service, the only functionality of which is to run and display build information. <br><br>  The <a href="https://github.com/rumyantseva/go-zeroservice/blob/60f058495e10077e6b9eb58de8849b3bdd409008/Makefile">make build command builds a</a> binary file, substituting the version specified in the Makefile, the last commit hash, and the current time.  In this case, before make build, the clean command is called, which deletes an existing binary (if it was).  To update the dependencies, <a href="https://github.com/rumyantseva/go-zeroservice/blob/0de2ee014eebf069d6f977544abb92648146bbc8/Makefile">make vendor is</a> provided, which will install dep if it does not already exist, and execute the dep ensure command to update packages inside the vendor.  To check the quality of the code, the command <a href="https://github.com/rumyantseva/go-zeroservice/blob/0de2ee014eebf069d6f977544abb92648146bbc8/Makefile">make check is</a> proposed, which will install and launch the <a href="https://github.com/alecthomas/gometalinter">metalinter</a> . <br><br>  In our production projects, we put in the Makefile any more or less repetitive actions - running checks on coding standards and running tests, running the package manager, building the application for the OS with the necessary flags, building commands and running the Docker container, and even , allowing you to launch a service release in Kubernetes using Helm. <br><br>  The presence of such commands on different environments allows you to quickly perform the necessary actions, for example, run tests and collect and run the container on the developer‚Äôs local environment, or run tests and build and release as part of the CI / CD processes.  In the case of go-zeroservice, you can see the <a href="">.travis.yml</a> file, which starts the build of the service within the Travis CI and consists of the commands described in the Makefile. <br><br><h3>  Conclusion </h3><br>  So, in order to deal with the issues of building Go-applications for production, it takes not so much.  First, you need to decide on the location of the application code inside <code>GOPATH</code> and make sure that it corresponds to the location of the code in the version control system.  Secondly, you need to decide how to interact with the management of external dependencies and <a href="https://github.com/golang/go/wiki/PackageManagementTools">select the appropriate tool</a> .  Thirdly, it is convenient when you have at hand all the instructions that you have to perform more or less regularly and on different environments, for example, a Makefile helps in storing such instructions. <br><br>  I hope this article will help the newcomers of the Go world to quickly deal with issues of release preparation.  And if you use other practices to build applications, do not hesitate to share them in the comments and thank you in advance for that. <br><br>  <i>PS By the way, we came up with the continuation of the master class about Go and Kubernetes and plan to present it in September at the <a href="https://gdg-siberia.com/">DevFest Siberia</a> conference.</i>  <i>Join us!</i>  <i>;)</i> </div><p>Source: <a href="https://habr.com/ru/post/337158/">https://habr.com/ru/post/337158/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337148/index.html">Know less, be silent more often: or as in Russia and China, ICO banned</a></li>
<li><a href="../337150/index.html">Asterisk, automatic detection of the cellular operator by phone number, even transferred numbers</a></li>
<li><a href="../337152/index.html">ICO - the dawn of a decentralized business model</a></li>
<li><a href="../337154/index.html">Vulnerable Docker VM - Virtual Docker and Pentesting Puzzle</a></li>
<li><a href="../337156/index.html">Integration of Lokalise service into the largest photo bank in the world: experience.</a></li>
<li><a href="../337162/index.html">Huawei Agile Distributed Wi-Fi Solution: what is it? Part two</a></li>
<li><a href="../337164/index.html">Excursion to the Museum of Computer History in California, with the benefit of the development. Part 1. ENIAC, Stretch, CDC6600, IBM / 360</a></li>
<li><a href="../337166/index.html">Moving to the server side with bem-express</a></li>
<li><a href="../337168/index.html">We write and parsim assembly language MCS-51, as in BASIC</a></li>
<li><a href="../337170/index.html">The book "Continuous delivery. The practice of continuous updates "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>