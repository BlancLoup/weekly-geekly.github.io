<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Model-View-Intent and Load / Update Indicator</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! Many Android applications download data from the server and show the download indicator at this time, and then allow updating data. The appl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Model-View-Intent and Load / Update Indicator</h1><div class="post__text post__text-html js-mediator-article"><p>  Good day!  Many Android applications download data from the server and show the download indicator at this time, and then allow updating data.  The application can have a dozen screens, almost every one of them needs: </p><br><ul><li> when switching to the screen, show the download indicator ( <code>ProgressBar</code> ) while the data is being loaded from the server; </li><li>  in case of a loading error, show the error message and the "Retry loading" button; </li><li>  in case of a successful download, give the user the opportunity to update the data ( <code>SwipeRefreshLayout</code> ); </li><li>  if an error occurred while updating the data, show the corresponding message ( <code>Snackbar</code> ). </li></ul><br><p>  When developing applications, I use the MVI architecture (Model-View-Intent) in the <a href="https://github.com/sockeqwe/mosby">Mosby</a> implementation, more about which you can read on <a href="https://habrahabr.ru/company/tinkoff/blog/325376/">Habr√©</a> or find the original MVI article on <a href="http://hannesdorfmann.com/android/mosby3-mvi-1">the mosby developer website</a> .  In this article, I'm going to talk about creating base classes that would allow us to separate the load / update logic described above from other actions on data. <a name="habracut"></a></p><br><p>  The first thing we start creating base classes for is the creation of a <code>ViewState</code> , which plays a key role in MVI.  <code>ViewState</code> contains information about the current View state (which can be an activation, a fragment or a <code>ViewGroup</code> ).  Given the state of the screen regarding download and refresh, the <code>ViewState</code> looks like this: </p><br><pre> <code class="hljs haskell">//    <span class="hljs-type"><span class="hljs-type">LR</span></span>    <span class="hljs-type"><span class="hljs-type">Load</span></span>-<span class="hljs-type"><span class="hljs-type">Refresh</span></span>. <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRViewState</span></span></span><span class="hljs-class">&lt;out </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">M</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InitialModelHolder</span></span></span><span class="hljs-class">&lt;*&gt;&gt;( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loading</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boolean</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loadingError</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Throwable</span></span></span><span class="hljs-class">?, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">canRefresh</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boolean</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refreshing</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Boolean</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">refreshingError</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Throwable</span></span></span><span class="hljs-class">?, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">M</span></span></span><span class="hljs-class"> )</span></span></code> </pre> <br><p>  The first two fields contain information about the current state of the download (whether the download is now taking place or if an error has occurred)  The following three fields contain information about updating data (whether the user can update the data and whether the update is currently in progress and whether an error has occurred).  The last field is the model that is meant to be shown on the screen after it has been loaded. </p><br><p>  In <code>LRViewState</code> model implements the <code>InitialModelHolder</code> interface, which I will now <code>InitialModelHolder</code> . <br>  Not all data that will be displayed on the screen or will be used somehow within the screen must be downloaded from the server.  For example, there is a model that consists of a list of people that is loaded from the server, and several variables that determine the sorting order or filtering of people in the list.  The user can change the sorting and search parameters even before the list is loaded from the server.  In this case, the list is the initial (initial) part of the model, which is loaded for a long time and for the load time of which it is necessary to show the <code>ProgressBar</code> .  It is in order to highlight what part of the model is the original interface <code>InitialModelHolder</code> is used. </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InitialModelHolder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">in I</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeInitialModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">I</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: InitialModelHolder&lt;I&gt; }</code> </pre> <br><p>  Here, the parameter <code>I</code> shows what the original part of the model will be, and the method <code>changeInitialModel(i: I)</code> , which should implement the model class, allows you to create a new model object in which its initial (initial) part is replaced with the one that is passed to the method as parameter <code>i</code> . </p><br><p>  It‚Äôs clear why we need to change one part of the model to another if we recall one of the main advantages of the MVI, the <strong>State Reducer</strong> (for more, see <a href="http://hannesdorfmann.com/android/mosby3-mvi-3">here</a> ).  State Reducer allows you to apply partial changes ( <strong>Partial Changes</strong> ) to an existing <code>ViewState</code> object and thereby create a new ViewState instance.  In the future, the <code>changeInitialModel(i: I)</code> method will be used in the State Reducer to create a new ViewState instance with loaded data. </p><br><p>  Now it‚Äôs time to talk about Partial Change.  A partial change contains information about what exactly needs to be changed in <code>ViewState</code> .  All partial changes implement the <code>PartialChange</code> interface.  This interface is not part of Mosby and is designed to ensure that all partial changes (those related to download / update and those that do not apply) have a common "root". </p><br><p>  Partial changes are convenient to combine into <code>sealed</code> classes.  Further you can see partial changes that can be applied to the <code>LRViewState</code> . </p><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">LRPartialChange</span></span> : <span class="hljs-type"><span class="hljs-type">PartialChange</span></span> { object <span class="hljs-type"><span class="hljs-type">LoadingStarted</span></span> : <span class="hljs-type"><span class="hljs-type">LRPartialChange</span></span>() //   <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LoadingError</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Throwable</span></span></span><span class="hljs-class">) : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRPartialChange</span></span></span><span class="hljs-class">() //     object </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RefreshStarted</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRPartialChange</span></span></span><span class="hljs-class">() //   </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RefreshError</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Throwable</span></span></span><span class="hljs-class">) : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRPartialChange</span></span></span><span class="hljs-class">() //     //      </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">InitialModelLoaded</span></span></span><span class="hljs-class">&lt;out </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I</span></span></span><span class="hljs-class">&gt;(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I</span></span></span><span class="hljs-class">) : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRPartialChange</span></span></span><span class="hljs-class">() }</span></span></code> </pre> <br><p>  The next step is to create a base interface for the View. </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LRView</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K, in M : InitialModelHolder&lt;*</span></span></span><span class="hljs-class">&gt;&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MvpView { fun load</span></span></span></span>(): Observable&lt;K&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;K&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;K&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vs: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LRViewState</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">M</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> }</code> </pre> <br><p>  Here, the <code>K</code> parameter is the <em>key</em> that will help the presenter determine which data needs to be loaded.  The key can be, for example, the entity ID.  The <code>M</code> parameter defines the type of the model (the type of the <code>model</code> field in the <code>LRViewState</code> ).  The first three methods are intents (in terms of MVI) and are used to transfer events from <code>View</code> to <code>Presenter</code> .  The implementation of the <code>render</code> method will display the <code>ViewState</code> . </p><br><p>  Now that we have an <code>LRViewState</code> and an <code>LRView</code> interface, we can create an <code>LRPresenter</code> .  Consider it in parts. </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LRPresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K, I, M : InitialModelHolder&lt;I</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V : LRView</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K, M</span></span></span><span class="hljs-class">&gt;&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V, LRViewState&lt;M</span></span></span><span class="hljs-class">&gt;&gt;</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialModelSingle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">K</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;I&gt; <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> reloadIntent: Observable&lt;Any&gt; = Observable.never() <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> loadIntent: Observable&lt;K&gt; = intent { it.load() } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retryIntent: Observable&lt;K&gt; = intent { it.retry() } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshIntent: Observable&lt;K&gt; = intent { it.refresh() } ... ... }</code> </pre> <br><p>  <code>LRPresenter</code> parameters are: </p><br><ul><li>  <code>K</code> <em>key</em> for loading the initial part of the model; </li><li>  <code>I</code> type of the initial part of the model; </li><li>  <code>M</code> type of model; </li><li>  <code>V</code> type <code>View</code> , with which this <code>Presenter</code> works. </li></ul><br><p>  The implementation of the <code>initialModelSingle</code> method should return <code>io.reactivex.Single</code> to load the initial part of the model using the transferred <em>key</em> .  The <code>reloadIntent</code> field can be overridden by descendant classes and is used to <code>reloadIntent</code> original part of the model (for example, after certain user actions).  The following three fields create intents for receiving events from the <code>View</code> . </p><br><p>  Next in <code>LRPresenter</code> is a method for creating <code>io.reactivex.Observable</code> , which will transfer partial changes related to the download or update.  In the following, it will be shown how heir classes can use this method. </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRefreshPartialChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;LRPartialChange&gt; = Observable.merge( Observable .merge( Observable.combineLatest( loadIntent, reloadIntent.startWith(Any()), BiFunction { k, _ -&gt; k } ), retryIntent ) .switchMap { initialModelSingle(it) .toObservable() .map&lt;LRPartialChange&gt; { LRPartialChange.InitialModelLoaded(it) } .onErrorReturn { LRPartialChange.LoadingError(it) } .startWith(LRPartialChange.LoadingStarted) }, refreshIntent .switchMap { initialModelSingle(it) .toObservable() .map&lt;LRPartialChange&gt; { LRPartialChange.InitialModelLoaded(it) } .onErrorReturn { LRPartialChange.RefreshError(it) } .startWith(LRPartialChange.RefreshStarted) } )</code> </pre> <br><p>  And the last part of the <code>LRPresenter</code> is the <strong>State Reducer</strong> , which applies partial changes to the <code>ViewState</code> associated with loading or updating (these partial changes were transferred from the <code>Observable</code> created in the <code>loadRefreshPartialChanges</code> method). </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@CallSuper</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stateReducer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(viewState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LRViewState</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">M</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, change: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">PartialChange</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LRViewState&lt;M&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (change !<span class="hljs-keyword"><span class="hljs-keyword">is</span></span> LRPartialChange) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> Exception() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (change) { LRPartialChange.LoadingStarted -&gt; viewState.copy( loading = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, loadingError = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, canRefresh = <span class="hljs-literal"><span class="hljs-literal">false</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> LRPartialChange.LoadingError -&gt; viewState.copy( loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, loadingError = change.t ) LRPartialChange.RefreshStarted -&gt; viewState.copy( refreshing = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, refreshingError = <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> LRPartialChange.RefreshError -&gt; viewState.copy( refreshing = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, refreshingError = change.t ) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> LRPartialChange.InitialModelLoaded&lt;*&gt; -&gt; { <span class="hljs-meta"><span class="hljs-meta">@Suppress(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UNCHECKED_CAST"</span></span></span><span class="hljs-meta">)</span></span> viewState.copy( loading = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, loadingError = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, model = viewState.model.changeInitialModel(change.i <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> I) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> M, canRefresh = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, refreshing = <span class="hljs-literal"><span class="hljs-literal">false</span></span> ) } } }</code> </pre> <br><p>  Now it remains to create a basic fragment or activity that will be implemented by <code>LRView</code> .  In my applications, I follow the SingleActivityApplication approach, so we will create a <code>LRFragment</code> . </p><br><p>  A <code>LoadRefreshPanel</code> interface was created to display load and refresh indicators, as well as to receive events about the need to repeat downloads and updates, to which the <code>LRFragment</code> will delegate the <code>ViewState</code> display and which will be the fa√ßade of the events.  Thus, heir fragments will not be required to have <code>SwipeRefreshLayout</code> and the "Retry" button. </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadRefreshPanel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retryClicks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;Any&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refreshes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;Any&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vs: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LRViewState</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;*&gt;)</span></span></span></span> }</code> </pre> <br><p>  In the demo application, the <a href="">LRPanelImpl</a> class was created, which is a <code>SwipeRefreshLayout</code> with <code>SwipeRefreshLayout</code> embedded in it.  <code>ViewAnimator</code> allows <code>ViewAnimator</code> to display either the <code>ProgressBar</code> , or the error panel, or a model. </p><br><p>  Given the <code>LoadRefreshPanel</code> <code>LRFragment</code> will look like this: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LRFragment</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K, M : InitialModelHolder&lt;*</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V : LRView</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K, M</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">P : MviBasePresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V, LRViewState&lt;M</span></span></span><span class="hljs-class">&gt;&gt;&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MviFragment</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">V, P</span></span></span><span class="hljs-class">&gt;</span></span>(), LRView&lt;K, M&gt; { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> key: K <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewForSnackbar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: View <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRefreshPanel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: LoadRefreshPanel <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;K&gt; = Observable.just(key) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;K&gt; = loadRefreshPanel().retryClicks().map { key } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;K&gt; = loadRefreshPanel().refreshes().map { key } <span class="hljs-meta"><span class="hljs-meta">@CallSuper</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vs: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LRViewState</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">M</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { loadRefreshPanel().render(vs) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vs.refreshingError != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Snackbar.make(viewForSnackbar(), R.string.refreshing_error_text, Snackbar.LENGTH_SHORT) .show() } } }</code> </pre> <br><p>  As can be seen from the above code, the download starts immediately after the presenter joins, and the rest is delegated to <code>LoadRefreshPanel</code> . </p><br><p>  Now creating a screen on which to implement the load / update logic becomes an easy task.  For example, consider the screen with details about the person (the driver, in our case). </p><br><p>  The entity class is trivial. </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Driver</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> name: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> team: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> birthYear: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> )</code> </pre> <br><p>  The model class for the screen with details consists of one entity: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DriverDetailsModel</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> driver: Driver ) : InitialModelHolder&lt;Driver&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeInitialModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Driver</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = copy(driver = i) }</code> </pre> <br><p>  Presenter class for the screen with details: </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DriverDetailsPresenter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRPresenter</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Long, Driver, DriverDetailsModel, DriverDetailsView</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialModelSingle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(key: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Single&lt;Driver&gt; = Single .just(DriversSource.DRIVERS) .map { it.single { it.id == key } } .delay(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeUnit.SECONDS) .flatMap { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (System.currentTimeMillis() % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0L</span></span>) Single.just(it) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Single.error(Exception()) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindIntents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> initialViewState = LRViewState(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, DriverDetailsModel(Driver(-<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> observable = loadRefreshPartialChanges() .scan(initialViewState, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>::stateReducer) .observeOn(AndroidSchedulers.mainThread()) subscribeViewState(observable, DriverDetailsView::render) } }</code> </pre> <br><p>  The <code>initialModelSingle</code> method creates a <code>Single</code> to load an entity on the transferred <code>id</code> (approximately every 2nd time an error is issued to show how the UI error looks like).  The <code>bindIntents</code> method uses the <code>loadRefreshPartialChanges</code> method from <code>LRPresenter</code> to create an <code>Observable</code> that <code>LRPresenter</code> partial changes. </p><br><p>  Let's move on to creating a fragment with details. </p><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DriverDetailsFragment</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">LRFragment</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Long, DriverDetailsModel, DriverDetailsView, DriverDetailsPresenter</span></span></span><span class="hljs-class">&gt;</span></span>(), DriverDetailsView { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> key <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> lazy { arguments.getLong(driverIdKey) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadRefreshPanel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : LoadRefreshPanel { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retryClicks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;Any&gt; = RxView.clicks(retry_Button) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refreshes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Observable&lt;Any&gt; = Observable.never() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vs: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LRViewState</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;*&gt;)</span></span></span></span> { retry_panel.visibility = <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vs.loadingError != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) View.VISIBLE <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> View.GONE <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (vs.loading) { name_TextView.text = <span class="hljs-string"><span class="hljs-string">"...."</span></span> team_TextView.text = <span class="hljs-string"><span class="hljs-string">"...."</span></span> birthYear_TextView.text = <span class="hljs-string"><span class="hljs-string">"...."</span></span> } } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(vs: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LRViewState</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">DriverDetailsModel</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.render(vs) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!vs.loading &amp;&amp; vs.loadingError == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { name_TextView.text = vs.model.driver.name team_TextView.text = vs.model.driver.team birthYear_TextView.text = vs.model.driver.birthYear.toString() } } ... ... }</code> </pre> <br><p>  In this example, the key is stored in the fragment arguments.  The model is <code>render(vs: LRViewState&lt;DriverDetailsModel&gt;)</code> in the <code>render(vs: LRViewState&lt;DriverDetailsModel&gt;)</code> method <code>render(vs: LRViewState&lt;DriverDetailsModel&gt;)</code> fragment.  An implementation of the <code>LoadRefreshPanel</code> interface is also created, which is responsible for displaying the load.  In the above example, the <code>ProgressBar</code> is not used for the load time, but instead the data fields display dots, which symbolizes the load;  <code>retry_panel</code> appears in case of an error, and the update is not provided ( <code>Observable.never()</code> ). </p><br><p>  A demo application that uses the described classes can be found on <a href="https://github.com/qwert2603/MVILoadRefresh">GitHib</a> . <br>  Thanks for attention! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335112/">https://habr.com/ru/post/335112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335098/index.html">Galaxy generation and astronomy basic knowledge training</a></li>
<li><a href="../335102/index.html">Breakthrough in the business process automation market</a></li>
<li><a href="../335104/index.html">Solving a closed transport problem with additional conditions using Python tools</a></li>
<li><a href="../335106/index.html">Basics of working with LongPoll server VKontakte</a></li>
<li><a href="../335110/index.html">How the KOMPAS-3D math library turned into a C3D Toolkit for CAD developers ‚Üí part 2</a></li>
<li><a href="../335114/index.html">Interactive recommenders: how to create, how to work</a></li>
<li><a href="../335120/index.html">RailsClub 2017: we are waiting for all rubists on September 23 in Moscow</a></li>
<li><a href="../335122/index.html">Speed ‚Äã‚Äãup your website using machine learning.</a></li>
<li><a href="../335128/index.html">Getting started with Wagtail CMS (Django) and GraphQL</a></li>
<li><a href="../335132/index.html">Dedicated servers based on Intel Xeon processors Skylake-SP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>