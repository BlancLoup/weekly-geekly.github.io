<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cross-Vmny (CLR / JVM) Python Code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is a highly specialized short note about how I wrote write once, run everywhere tests for a library ported from C # to Java using Python. 

 The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cross-Vmny (CLR / JVM) Python Code</h1><div class="post__text post__text-html js-mediator-article">  This is a highly specialized short note about how I wrote write once, run everywhere tests for a library ported from C # to Java using Python. <br><br>  The point is this: there is a large, thick and beautiful library that has been commercially ported from C # to Java.  API remained almost the same, naming conventions naturally changed when switching to another language.  We needed to write a thick stack of tests verifying that the library's clone works identically to the original (regression tests, in other words).  For this, the results of the work of the library code were compared (certain binaries and xml-metadata).  The tests were non-trivial, there were a lot of them, and the most unpleasant was that they were constantly written from one end by a team of four people.  For some time I diligently ported them to Java, then spat and suggested that the team write tests in a language that could be immediately run on the CLR (with the old library) and the JVM (with the clone).  It turned out that they themselves had been thinking about Python for some time, <a name="habracut"></a>  and that's how it turned out. <br><br><h5>  1. Basics </h5><br>  Well, about the primitive.  On the CLR, I run the code IronPython, on the JVM - Jython, respectively.  From pleasant - Jython itself provides loadable Java-classes instead of getters-setters mechanism perpertey.  Why is it nice?  Because when porting to Java, Sharpee Properties were naturally replaced with getters-setters. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  2. Where am I? </h5><br>  It is useful to know, on top of what runtime we are currently running.  It's simple. <br><pre><code class="python hljs">isDotNet = sys.version.find(<span class="hljs-string"><span class="hljs-string">'IronPython'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span></code> </pre> <br><br><h5>  3. Connection of the necessary libraries </h5><br>  In IronPython and Jython, this is done differently (using the clr library in IronPython, and simply adding it to the path in Jython), and the convention for naming modules is different, so we unify: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpUseLibrary</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lib_path, library)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isDotNet: sys.path.append(lib_path) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> clr clr.AddReference(<span class="hljs-string"><span class="hljs-string">'OurProduct20.'</span></span> + library) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: sys.path.append(lib_path + <span class="hljs-string"><span class="hljs-string">'\\java_libs\\ourproduct20.'</span></span> + library.lower() + <span class="hljs-string"><span class="hljs-string">'.jar'</span></span>)</code> </pre><br><br>  This is used in the working code in the following stupid way: <br><pre> <code class="python hljs">cpUseLibrary(path_to_bins, <span class="hljs-string"><span class="hljs-string">'Core'</span></span>) cpUseLibrary(path_to_bins, <span class="hljs-string"><span class="hljs-string">'Formats.Common'</span></span>)</code> </pre><br><br><h5>  4. Download the required classes. </h5><br>  Here is a small problem.  In general, both interpreters allow stupidly importing from the necessary namespaces / packages, but we need a dynamic construction, taking into account, again, different conventions for naming packages. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpImport</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(module, clazz, globs = globals</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># load class mname = ''; if isDotNet: mname = 'OurProduct.' + module else: mname = 'com.ourcompany.ourproduct.' + module.lower() pckg = __import__(mname, globals(), locals(), [clazz], -1) aliased_class = getattr(pckg, clazz) globs[clazz] = aliased_class</span></span></code> </pre><br><br>  The point is to use __import __ () as the Python internal mechanism for importing from modules.  Actually, the entry ‚Äúimport from somewhere from something‚Äù in __import __ () eventually unfolds.  The current problem that the hands did not reach is to solve - it is the need to transfer globals () each time to such an import (due to the fact that all cross-platform methods are in a separate module).  It looks like this: <br><pre> <code class="python hljs">cpImport(<span class="hljs-string"><span class="hljs-string">'Core'</span></span>, <span class="hljs-string"><span class="hljs-string">'OurProductLicense'</span></span>, globals()) cpImport(<span class="hljs-string"><span class="hljs-string">'Formats'</span></span>, <span class="hljs-string"><span class="hljs-string">'OurProductCommonFormats'</span></span>, globals())</code> </pre><br><br>  Not very nice, but again, it works uniformly on both runtimes. <br><br><h5>  5. Solving the convention naming problem </h5><br>  The difference in the naming of methods is very simple: in C # they start with a capital, in Java - with a lowercase.  What modern scripting languages ‚Äã‚Äãare convenient for is the possibility of metaprogramming.  Not lisp, probably, but all the same.  Ruby would be even more helpful here, but not bad either.  We add cpImport (): <br><br><pre> <code class="python hljs"> aliased_class = getattr(pckg, clazz) <span class="hljs-comment"><span class="hljs-comment"># add uppercased aliases for its lowercased methods (unless there's already an uppercased method with the same name) original_methods = aliased_class.__dict__.copy() for name, method in original_methods.iteritems(): if name[0:1] in string.uppercase: continue newname = name[0:1].upper() + name[1:] if hasattr(aliased_class, newname): continue setattr(aliased_class, newname, method) globs[clazz] = aliased_class</span></span></code> </pre><br><br>  The point here is to use setattr () to prescribe an alias for a method.  In fact, for all methods starting with a lowercase letter, we create an alias right in the classroom, starting with a capital letter. <br><br>  What it looks like in general.  File test.py: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cptest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> isDotNet, cpUseLibrary, cpImport cpUseLibrary(<span class="hljs-string"><span class="hljs-string">'Core'</span></span>) cpUseLibrary(<span class="hljs-string"><span class="hljs-string">'Formats.Common'</span></span>) cpImport(<span class="hljs-string"><span class="hljs-string">'Core'</span></span>, <span class="hljs-string"><span class="hljs-string">'OurProductLicense'</span></span>, globals()) cpImport(<span class="hljs-string"><span class="hljs-string">'Formats'</span></span>, <span class="hljs-string"><span class="hljs-string">'OurProductCommonFormats'</span></span>, globals()) OurProductLicense.SetProductID(<span class="hljs-string"><span class="hljs-string">".NET Product ID"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isDotNet <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">"JavaProductID"</span></span>) OurProductCommonFormats.Initialize();</code> </pre><br><br>  It is executed by a simple ipy test.py / jython test.py from one script without dancing with a tambourine.  Which is nice. <br><br><h5>  PS Possible problems </h5><br>  Well, they are pretty obvious.  We were lucky, our developers in the process of porting quite meticulously adhered to one convention of naming and porting names.  Therefore, libraries, methods, etc., are really easy to call as described above.  Otherwise, you would have to compose a table of exceptions, and take it into account in the cpImport () method.  But on the whole, I liked the described approach very much and it looks like a living solution, such a rarely, probably, encountered problem. </div><p>Source: <a href="https://habr.com/ru/post/148473/">https://habr.com/ru/post/148473/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148462/index.html">HyperActive Record - under-ORM on CodeIgniter</a></li>
<li><a href="../148464/index.html">Google Engineering Calculator</a></li>
<li><a href="../148467/index.html">Qt + OpenCV. Runtime and Widget for CvCapture (video capture devices)</a></li>
<li><a href="../148471/index.html">Microsoft Office365: a classic in modern processing</a></li>
<li><a href="../148472/index.html">We build a report on the membership of users in AD groups: 4 problems in writing a Powershell script</a></li>
<li><a href="../148474/index.html">The seminar ‚ÄúCreating an IT Startup‚Äù on July 29 in Gorky Park (Moscow)</a></li>
<li><a href="../148476/index.html">Launch trailer Metal War Online</a></li>
<li><a href="../148477/index.html">How I received a certificate of state registration of rights to a copyright object in Kazakhstan</a></li>
<li><a href="../148478/index.html">Creating graphs with pChart. Data from mysql</a></li>
<li><a href="../148479/index.html">What is research testing?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>