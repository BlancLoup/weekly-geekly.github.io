<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting to Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Porting to Android 

 At the end of this article, I announced a plan to make a port for Android. Here I will try to describe the problems that I encou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting to Android</h1><div class="post__text post__text-html js-mediator-article"><h4>  Porting to Android </h4><br><br>  At the end of <a href="http://habrahabr.ru/blogs/gdev/128953/">this</a> article, I announced a plan to make a port for Android.  Here I will try to describe the problems that I encountered and the methods for solving them.  I just want to say that the experience with Android at the moment is exactly 2 months and maybe some solutions are dangerous or even not acceptable on this platform. <br><br><h5>  Engine </h5>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The engine (hobby) has been in development for 10 years. <br>  The engine is written entirely in C / C ++, before starting the porting to Android, it supported iOS and Windows. <br>  Logic, rendering, sound - all in C / C ++. <br><br><a name="habracut"></a><br><h5>  File system </h5><br><br>  An important feature that made porting to Android very simple is the engine file system. <br><br>  Pseudo code: <br><blockquote><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStream</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name )</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; open() = <span class="hljs-number"><span class="hljs-number">0</span></span>; write() = <span class="hljs-number"><span class="hljs-number">0</span></span>; ‚Ä¶ = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FileStream</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IStream {   fopen,fread... POSIX API. } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataPackStream</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IStream {     .pak  Core::Meta* m_packFileStreamMeta;; <span class="hljs-comment"><span class="hljs-comment">/// m_packFileStreamMeta-&gt;Create() IStream*         .pak  }</span></span></code> </pre></blockquote><br><br>  So: all work with files in the engine is based on the IStream interface, the engine architecture supports the factory of objects, and its customization. <br><br>  Code example: <br><blockquote><pre> Core :: FileStream :: Type () -&gt; setFactoryMeta (DataPack :: DataPackStream :: Type ());

 FileStream * filestream1 = FileStream :: Create ();
 // the same will happen with new FileStream ()
 FileStream * filestream2 = FileStream :: CreateExact ();

 filestream1 will be a DataPackStream type
 filestream2 will be of type FileStream
</pre></blockquote><br><br>  Nothing new and everything is pretty standard. <br><br>  Since all the resources are zaproprotserenny in the .pak file, then for Android the system had to write its own implementation of IStream specifically for working with Java. <br><br>  Initializing this resource in Java <br><blockquote><pre> AssetFileDescriptor RawAssetsDescriptor = this.getApplicationContext ()
				 .getResources (). openRawResourceFd (R.raw.data000);
 if (RawAssetsDescriptor! = null)
 {
     FileInputStream fis = RawAssetsDescriptor.createInputStream ();
     NativeMethods.dataPackChannel = fis.getChannel ();
     NativeMethods.dataPackOffset = RawAssetsDescriptor.getStartOffset ();
     NativeMethods.dataPackSize = RawAssetsDescriptor.getLength ();
 }
</pre></blockquote><br><br>  Native class all calls open, read, seek translates again in Java <br><blockquote><pre> class AndroidPackStream: public IStream
 {
 // ....
     // read example
     size_t read (void * buffer, size_t size, size_t count)
     {
       if (JavaHelpers :: m_pClass)
       {
         jmethodID mid = JavaHelpers :: GetEnv () -&gt; GetStaticMethodID (JavaHelpers :: m_pClass, "freadDataPack", "(I) I");
         int res = JavaHelpers :: GetEnv () -&gt; CallStaticIntMethod (JavaHelpers :: m_pClass, mid, (int) size * count);
	 jfieldID field = JavaHelpers :: GetEnv () -&gt; GetStaticFieldID (JavaHelpers :: m_pClass, "byteBuffer", "Ljava / nio / MappedByteBuffer;");
	 jobject obj = JavaHelpers :: GetEnv () -&gt; GetStaticObjectField (JavaHelpers :: m_pClass, field);
	 uint8_t * pData = (uint8_t *) JavaHelpers :: GetEnv () -&gt; GetDirectBufferAddress (obj);
	 memcpy (buffer, pData, size * count);
	 JavaHelpers :: GetEnv () -&gt; DeleteLocalRef (obj);
	 return res / size;
     }
 }
</pre></blockquote><br><br>  Java implementation of reading this stream with returning data back to the nytiv <br><blockquote><pre> public static int freadDataPack (int count)
 {
     long curPos = dataPackChannel.position ();
     int countReaded = count;
     byteBuffer = dataPackChannel.map (MapMode.READ_ONLY, dataPackChannel.position (), count);
     byteBuffer.load ();
     dataPackChannel.position (curPos + countReaded);
     return countReaded;
 }
</pre></blockquote><br><br>  The important point is that the apk collector compresses all resources, and we want to read the file as if it is just lying in the file system.  In order for our .pak file not to be compressed inside apk - you must change the extension to one of those that will tell the packer not to compress these files when packing (details <a href="http://ponystyle.com/blog/2010/03/26/dealing-with-asset-compression-in-android-apps/">ponystyle.com/blog/2010/03/26/dealing-with-asset -compression-in-android-apps</a> ).  I chose .imy. <br>  Downloading resources in this way is very fast, for example, on the Kindle Fire is faster than on the iPad 1 <br>  I will stipulate that such a trick can be turned on if you do not have a lot of data. <br>  For a large amount of data - you can unpack the data on the internal media (for example, when you first start) and directly use them through the functions fopen fread (in my case, not through the replaced FileStream), etc. <br><br><h5>  Sound </h5><br>  For Windows and iOS, OpenAL was used.  OpenAL for Android has been compiled thanks to <a href="http://pielot.org/2010/12/14/openal-on-android/">pielot.org/2010/12/14/openal-on-android</a> .  He did not work immediately, but only after the corrections that are described in the comments on the website. <br>  The build for Android is built only for Arm v7 - because the build of the port for Arm v6 OpenAL sometimes led to lags, in iOS OpenAL the mixer works faster and without lags (even on ArmV6, for example, on the iPod Touch 2G). <br><br><h5>  Interaction with native C / C ++ code </h5><br>  A very simple bundle of classes is responsible for handling calls to platform dependent implementations. <br>  Pseudo code: <br><br><blockquote><pre> class IPlatfomCommandFeedback
 {
     void onResponse (string &amp;);
 };
 class IPlatfomCommand
 {
     string execute (string &amp; command, IPlatfomCommandFeedback * feebback);
 };
</pre></blockquote><br><br>  For iOS, its implementation on Objective-C and for Android, its implementation on JNI-&gt; Java. <br><br><h5>  Rendering </h5><br>  The nave part works using OpenGL, minimal changes have been made to Android.  As it turned out later it was not enough.  The fact is that on Windows and on iOS textures are not lost when the application goes into the background, but for Android it always happens.  In the engine, there was already a texture manager (mainly for debugging) and adding reloading resources was not difficult. <br><br><h5>  Assembly </h5><br>  In the very <a href="http://habrahabr.ru/blogs/gdev/122351/">first</a> article I wrote about how I initially compiled iOS using the toolchain and I had customized makefiles.  That's where it came in handy for me.  Targets for assembling using the Android NDK were added, a step was added to Eclipse builders and everything took off.  Yes, you can use the build system from Android NDK samples.  I only used it to find out the parameters that are used for gcc calls. <br><br><h5>  Openfenit admob </h5><br>  The integration of both libraries went without problems - clearly according to the instructions of the developers <br><br><h5>  Proguard </h5><br>  Everything is more or less clear here - you just need to take care that your JNI Native binds don't fail. <br><br><h5>  Development tools </h5><br>  Iron: Kindle Fire, and a couple of tablets and mobile phones of friends (for testing). <br>  Soft: Eclipse with plugins <br><br><h5>  Shock number 1 </h5><br>  Android Market is not an AppStore.  Everything is different there.  There is no category New. <br>  For comparison, on the AppStore on the first day of release there were 800+ races, in the second 2000+, on the Andoid Market the official first hundred races were received only on the third day.  The promotion activity for both platforms was the same. <br><br><h5>  Shock number 2 </h5><br>  If your application is free, you can freely distribute apk, anyone can install this application from any source.  If you don‚Äôt do it, others will do it for you. <br><br><h5>  Shock number 3 </h5><br>  The bestiary of devices is great.  The number of problems, respectively. <br><br><h5>  Amazon </h5><br>  The review process on Amazon AppStore for Android takes a week, plus a few more days until the app appears on the AppStore list on Kindle Fire.  The number of downloads and dynamics corresponds to the Android Market <br><br><h5>  Advertising </h5><br>  Rays of hatred of the Corporation of Good - already a week as an advertising banner was sent in April.  Still silence. <br><br><h5>  Money </h5><br>  At the moment, the amount of money (let me remind you in the game is only advertising) that the iOS version brings is 40 (forty) times more than the Android version.  It is clear that the comparison is not correct and we must wait at least another couple of months until the number of regular players per day stabilizes. <br><br>  <b>UPDATE:</b> In the sound section, I described the reason for the assembly only for ArmV7 Android devices. </div><p>Source: <a href="https://habr.com/ru/post/139293/">https://habr.com/ru/post/139293/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139280/index.html">New features of Guard@Mail.Ru</a></li>
<li><a href="../139284/index.html">We invite everyone to the White Nights: Mobile Games Conference in St. Petersburg!</a></li>
<li><a href="../139285/index.html">ASUS officially unveiled Padfone</a></li>
<li><a href="../139286/index.html">Good deeds</a></li>
<li><a href="../139292/index.html">Program to record the broadcast of elections with webvyboryedg.ru</a></li>
<li><a href="../139294/index.html">Criminal case for key chain</a></li>
<li><a href="../139296/index.html">OVAL¬Æ or the ‚ÄúIdeal Scanner Myth‚Äù</a></li>
<li><a href="../139297/index.html">New details about Medfield, as well as the augmented reality from Intel and the DJ table demo</a></li>
<li><a href="../139302/index.html">Firefox addon: clearly see which sites are silently setting cookies</a></li>
<li><a href="../139304/index.html">Android + Arduino + 4 wheels. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>