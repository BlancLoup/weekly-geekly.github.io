<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A simple way to monitor the response time of Sphinx indexes using Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Task 
 For example, you have the Zabbix monitoring service already configured and distributed throughout the company, and you also use the Sphinx sear...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A simple way to monitor the response time of Sphinx indexes using Zabbix</h1><div class="post__text post__text-html js-mediator-article"><h4>  Task </h4><br>  For example, you have the Zabbix monitoring service already configured and distributed throughout the company, and you also use the Sphinx search engine.  It searches quickly, but has no built-in tools for live monitoring of its performance in the context of the index.  For example, you have a lot of search servers and you want to correlate the consumption of system resources with each specific index in order to understand how to distribute them among servers ‚Äî and also to see which collection starts to respond longer than we would like ‚Äî and whether it correlates with increase user load or something else. <br><a name="habracut"></a><br><h4>  Solution design </h4><br>  Sphinx provides the ability to display more detailed information on resource consumption per request with a small loss of performance and a slight increase in the size of the log.  To do this, you can start the searchd process with the searchd --iostats --cpustats parameters, while starting with version 2.0.1-beta, you must run searchd with the configuration query_log_format = sphinxql to display the full log.  In this case, the log line looks like this: <br><br><pre><code class="dos hljs">/* Sun Jun <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>.<span class="hljs-number"><span class="hljs-number">098</span></span> <span class="hljs-number"><span class="hljs-number">2014</span></span> conn <span class="hljs-number"><span class="hljs-number">531</span></span> real <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> wall <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">06</span></span> found <span class="hljs-number"><span class="hljs-number">1</span></span> */ SELECT tmstmp FROM index ORDER BY tmstmp desc LIMIT <span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>; /* ios=<span class="hljs-number"><span class="hljs-number">0</span></span> kb=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> ioms=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> cpums=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">6</span></span> */</code> </pre> <br><br>  Where <br>  conn - the sequence number of the request from the start <br>  real - the total time spent on a request from all cores <br>  wall - total response time for the client <br>  found - the number of records found <br>  ios - the number of I / O operations <br>  kb - the volume of read index files <br>  ioms - iowait time per request <br>  cpums - user CPU time on request 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1.) Removal of parameters with Sphinx: <br>  The most transparent and safest option for the main process seems to be launching a simple tail -F above the text log - and processing it line by line. <br>  2.) Taking parameters in Zabbix: <br>  Among the possible options you can consider jmx, snmp, zabbix trap, - for jmx, you need to additionally raise jvm on each search server, for snmp you need to work out your own tree of MIB elements, zabbix trap remains - <a href="https://www.zabbix.com/documentation/2.0/manual/config/items/itemtypes/trapper">www.zabbix.com/documentation/2.0/manual/config / items / itemtypes / trapper</a> - a piece that allows you to send data to zabbix directly using the zabbix_sender program - requires the installation of an agent, but if you already have Zabbix monitoring, it is probably already installed. <br>  3.) There are no performance restrictions imposed on the implementation tool - Python is pre-installed on the linux server at the minimum - we‚Äôll select it as the implementation <br><br><h4>  Decision </h4><br>  The source code of the solution can be downloaded here: <a href="https://github.com/kuptservol/SphinxLogMonitor">github.com/kuptservol/SphinxLogMonitor</a> - the solution is a python process that starts a tail subprocess, receives line by line from query.log, parses it at a given regexp &lt;log_parse_pattern&gt; and sends data to Zabbix , can aggregate data by calculating the arithmetic average of the indicator for a given period of &lt;time_aggregation_period_sec&gt;. <br><br>  1.) First you need to install zabbix-agent, if it is not installed: <br><br>  - tar -xzvf zabbix-xxxtar.gz <br>  - cd zabbix-xxx <br>  - ./configure --enable-agent --prefix = / usr / local / zabbix <br>  - make install <br><br>  2.) Then start the Host with the search server in Zabbix, create Items of the Zabbix trapper type by specifying key for each observed log parameter <br><br>  3.) Configure in zabbix_conf.ini the address of the zabbix server [ZabbixServer] mapping pulled out from the string of log parameters to those created in the zabbix key [ZabbixKeyLogFieldMapping] <br><br>  4.) startSphinxLogMonitor.sh, stopSphinxLogMonitor.sh are made to be able to start the daemon in the background and correctly stop the python process and the tail subprocess <br><br>  - make sh executable chmod + x startSphinxLogMonitor.sh <br>  - chmod + x stopSphinxLogMonitor.sh <br><br>  5.) To start: ./startSphinxLogMonitor.sh &lt;path to query.log&gt; &lt;path to zabbix_conf.ini&gt; &lt;path to log&gt; <br>  To stop: ./stopSphinxLogMonitor.sh </div><p>Source: <a href="https://habr.com/ru/post/226983/">https://habr.com/ru/post/226983/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../226973/index.html">Live debian</a></li>
<li><a href="../226975/index.html">"Correct" speed limit in nginx. Myth or reality?</a></li>
<li><a href="../226977/index.html">Listening Ukrainian mobile phones: how it is done and how to protect</a></li>
<li><a href="../226979/index.html">Google Web Starter Kit: Mobile Website Builder</a></li>
<li><a href="../226981/index.html">"Dauria" in space</a></li>
<li><a href="../226985/index.html">"Epson Printing Factory" and a laser printer: break stereotypes</a></li>
<li><a href="../226987/index.html">Unity3D - writing plugins for Android</a></li>
<li><a href="../226991/index.html">The history of the creation of cinematics "Enduring". Part two</a></li>
<li><a href="../226993/index.html">Splash brute-force attacks aimed at easily picked up writeable snmp community</a></li>
<li><a href="../226997/index.html">Welcome to Moscow JavaScript Meetup June 26</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>