<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sample Model-View-Update Architecture on F #</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Did someone not like Redux in React because of its implementation on JS? 


 I did not like clumsy switch-cases in reducer, there are languages ‚Äã‚Äãwith...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sample Model-View-Update Architecture on F #</h1><div class="post__text post__text-html js-mediator-article"><p>  Did someone not like Redux in React because of its implementation on JS? </p><br><p>  I did not like clumsy switch-cases in reducer, there are languages ‚Äã‚Äãwith more convenient pattern matching, and types are better modeling events and models.  For example, F #. <br>  This article is an explanation of the messaging device in <a href="https://elmish.github.io/elmish/">Elmish</a> . </p><a name="habracut"></a><br><p>  I will give an example of a console application written on this architecture, with his example it will be clear how to use this approach, and then we will understand the architecture of Elmish. </p><br><p>  I wrote a simple console application for reading poems, in seed'e there are several poems, one for each author, which are displayed on the console. </p><br><p>  The window contains only 4 lines of text, by pressing the "Up" and "Down" buttons you can flip through a poem, the numeric buttons change the text color, and the left and right buttons allow you to move through the action history, for example, the user read Pushkin's poem, switched to Yesenin's poem, changed the color of the text, and then I thought that the color was not very good and he did not like Yesenin, double-clicked the arrow to the left and returned to the place where Pushkin had finished reading. </p><br><p>  This miracle looks like this: </p><br><p><img src="https://habrastorage.org/webt/3h/2j/lh/3h2jlh-zewzgiozosfdxax-re4m.png"></p><br><p>  Consider the implementation. </p><br><p>  If you think through all the options, it is clear that all the user can do is to press a button, by pressing it, you can determine what the user wants, and he may wish: </p><br><ol><li>  Change author </li><li>  Change color </li><li>  Scroll (up / down) </li><li>  Go to previous / next version </li></ol><br><p>  Since the user must be able to go back to the version, you need to fix his actions and <strong>remember the model</strong> , as a result, all possible messages are described as follows: </p><br><pre><code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Msg</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleEvent</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleKey</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeAuthor</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Author</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeColor</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleColor</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangePosition</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangePosition</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeVersion</span></span></span><span class="hljs-class"> of </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeVersion</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RememberModel</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WaitUserAction</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Exit</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangeVersion</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Back</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Forward</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ChangePosition</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Up</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Down</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Author</span></span></span><span class="hljs-class"> = | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pushkin</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Lermontov</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Blok</span></span></span><span class="hljs-class"> | </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Esenin</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Poem</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Poem</span></span></span><span class="hljs-class"> of string</span></span></code> </pre> <br><p>  In the model, you need to store information about the text that is now in the console, the history of user actions and the number of actions to which the user will roll back in order to know which particular model to show. </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Model</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewTextInfo</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewTextInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">countVersionBack</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">history</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewTextInfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class"> } </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewTextInfo</span></span></span><span class="hljs-class"> = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">text</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">formatText</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">countLines</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">positionY</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">color</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ConsoleColor</span></span></span><span class="hljs-class"> }</span></span></code> </pre> <br><p>  The architecture of Elmish - model-view-update, the model has already been considered, we turn to the view: </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> <span class="hljs-type"><span class="hljs-type">SnowAndUserActionView</span></span> (model: <span class="hljs-type"><span class="hljs-type">Model</span></span>) (dispatch: <span class="hljs-type"><span class="hljs-type">Msg</span></span> -&gt; unit) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> { formatText = ft; color = clr } = model.viewTextInfo; clearConsoleAndPrintTextWithColor ft clr <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> key = <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">ReadKey</span></span>().<span class="hljs-type"><span class="hljs-type">Key</span></span>; <span class="hljs-type"><span class="hljs-type">Msg</span></span>.<span class="hljs-type"><span class="hljs-type">ConsoleEvent</span></span> key |&gt; dispatch <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> clearConsoleAndPrintTextWithColor (text: string) (color: <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>) = <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">Clear</span></span>(); <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">WriteLine</span></span>() <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">ForegroundColor</span></span> &lt;- color <span class="hljs-type"><span class="hljs-type">Console</span></span>.<span class="hljs-type"><span class="hljs-type">WriteLine</span></span>(text)</code> </pre> <br><p>  This is one of the views, it is drawn based on <em>viewTextInfo</em> , waits for the user's reaction, and sends this message to the <em>update</em> function. <br>  Later we will examine in detail what exactly happens when you call <em>dispatch</em> , and what kind of function it is. </p><br><p>  <em>Update</em> : </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> update (msg: <span class="hljs-type"><span class="hljs-type">Msg</span></span>) (model: <span class="hljs-type"><span class="hljs-type">Model</span></span>) = match msg with | <span class="hljs-type"><span class="hljs-type">ConsoleEvent</span></span> key -&gt; model, updateConsoleEvent key | <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> author -&gt; updateChangeAuthor model author | <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> color -&gt; updateChangeColor model color | <span class="hljs-type"><span class="hljs-type">ChangePosition</span></span> position -&gt; updateChangePosition model position | <span class="hljs-type"><span class="hljs-type">ChangeVersion</span></span> version -&gt; updateChangeVersion model version | <span class="hljs-type"><span class="hljs-type">RememberModel</span></span> -&gt; updateAddEvent model | <span class="hljs-type"><span class="hljs-type">WaitUserAction</span></span> -&gt; model, []</code> </pre> <br><p>  Depending on the type of <em>msg</em> , which function will be used to process the message. </p><br><p>  This is an <em>update</em> to the user's action, a button-to-message mapping, the last case - the <em>WaitUserAction</em> event <em>returns</em> - ignoring the click and waiting for further user actions. </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> updateConsoleEvent (key: <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> msg = match key with | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D1</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Red</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D2</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Green</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D3</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Blue</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D4</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Black</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">D5</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> <span class="hljs-type"><span class="hljs-type">ConsoleColor</span></span>.<span class="hljs-type"><span class="hljs-type">Cyan</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">LeftArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeVersion</span></span> <span class="hljs-type"><span class="hljs-type">Back</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">RightArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeVersion</span></span> <span class="hljs-type"><span class="hljs-type">Forward</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">P</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Pushkin</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">E</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Esenin</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Blok</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">L</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> <span class="hljs-type"><span class="hljs-type">Author</span></span>.<span class="hljs-type"><span class="hljs-type">Lermontov</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">UpArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangePosition</span></span> <span class="hljs-type"><span class="hljs-type">Up</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">DownArrow</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">ChangePosition</span></span> <span class="hljs-type"><span class="hljs-type">Down</span></span> | <span class="hljs-type"><span class="hljs-type">ConsoleKey</span></span>.<span class="hljs-type"><span class="hljs-type">X</span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Exit</span></span> | _ -&gt; <span class="hljs-type"><span class="hljs-type">WaitUserAction</span></span> msg |&gt; <span class="hljs-type"><span class="hljs-type">Cmd</span></span>.ofMsg</code> </pre> <br><p>  We change the author, note that <em>countVersionBack is</em> immediately reset to 0, which means that if the user rolls back in his history and then wants to change color, this action will be treated as new and will be added to <em>history</em> . </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> updateChangeAuthor (model: <span class="hljs-type"><span class="hljs-type">Model</span></span>) (author: <span class="hljs-type"><span class="hljs-type">Author</span></span>) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (<span class="hljs-type"><span class="hljs-type">Poem</span></span> updatedText) = seed.[author] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> updatedFormatText = getlines updatedText <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> updatedCountLines = (splitStr updatedText).<span class="hljs-type"><span class="hljs-type">Length</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> updatedViewTextInfo = {model.viewTextInfo with text = updatedText; formatText = updatedFormatText; countLines = updatedCountLines } { model with viewTextInfo = updatedViewTextInfo; countVersionBack = <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-type"><span class="hljs-type">Cmd</span></span>.ofMsg <span class="hljs-type"><span class="hljs-type">RememberModel</span></span></code> </pre><br><p>  We also send a message to <em>RememberModel</em> , whose handler updates <em>history</em> by adding the current model. </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> updateModelHistory model = { model with history = model.history @ [ model.viewTextInfo ] }, <span class="hljs-type"><span class="hljs-type">Cmd</span></span>.ofMsg <span class="hljs-type"><span class="hljs-type">WaitUserAction</span></span></code> </pre> <br><p>  The rest of the <em>update</em> you can see <a href="">here</a> , they are similar to those considered. </p><br><p>  To test the program, I will give tests for several scenarios: </p><br><div class="spoiler">  <b class="spoiler_title">Tests</b> <div class="spoiler_text"><p>  <em>The</em> run <em>method</em> <em>takes a structure in which the</em> Messages <em>list is stored</em> <em>and returns the model after they are processed.</em> </p><br><pre> <code class="haskell hljs">[&lt;<span class="hljs-type"><span class="hljs-type">Property</span></span>(<span class="hljs-type"><span class="hljs-type">Verbose</span></span>=true)&gt;] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ``    `` (authors: <span class="hljs-type"><span class="hljs-type">Author</span></span> list) = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = (createProgram (authors |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span>) |&gt; run) match (authors |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.tryLast) with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (<span class="hljs-type"><span class="hljs-type">Poem</span></span> text) = seed.[s] state.viewTextInfo.text = text | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true [&lt;<span class="hljs-type"><span class="hljs-type">Property</span></span>(<span class="hljs-type"><span class="hljs-type">Verbose</span></span>=true)&gt;] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ``    `` changeColorMsg = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = (createProgram (changeColorMsg|&gt;<span class="hljs-type"><span class="hljs-type">List</span></span>.map <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span>)|&gt; run) match (changeColorMsg |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.tryLast) with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; state.viewTextInfo.color = s | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true [&lt;<span class="hljs-type"><span class="hljs-type">Property</span></span>(<span class="hljs-type"><span class="hljs-type">Verbose</span></span>=true,<span class="hljs-type"><span class="hljs-type">Arbitrary</span></span>=[|typeof&lt;<span class="hljs-type"><span class="hljs-type">ChangeColorAuthorPosition</span></span>&gt;|])&gt;] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> ``        `` msgs = <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> tryLastSomeList list = list |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.filter (<span class="hljs-type"><span class="hljs-type">Option</span></span>.isSome) |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (<span class="hljs-type"><span class="hljs-type">Option</span></span>.get) |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.tryLast <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastAuthor = msgs |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (fun x -&gt; match x with | <span class="hljs-type"><span class="hljs-type">ChangeAuthor</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">Some</span></span> a | _ -&gt; <span class="hljs-type"><span class="hljs-type">None</span></span>) |&gt; tryLastSomeList <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastColor = msgs |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (fun x -&gt; match x with | <span class="hljs-type"><span class="hljs-type">ChangeColor</span></span> a -&gt; <span class="hljs-type"><span class="hljs-type">Some</span></span> a | _ -&gt; <span class="hljs-type"><span class="hljs-type">None</span></span>) |&gt; tryLastSomeList <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> state = (createProgram msgs |&gt; run) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> colorTest = match lastColor with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; state.viewTextInfo.color = s | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> authorTest = match lastAuthor with | <span class="hljs-type"><span class="hljs-type">Some</span></span> s -&gt; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (<span class="hljs-type"><span class="hljs-type">Poem</span></span> t) = seed.[s]; state.viewTextInfo.text = t | <span class="hljs-type"><span class="hljs-type">None</span></span> -&gt; true authorTest &amp;&amp; colorTest</code> </pre></div></div><br><p>  To do this, use the library FsCheck, which provides the ability to generate data. </p><br><p>  Now consider the core of the program, the code in Elmish was written for all occasions, I simplified it ( <a href="https://elmish.github.io/elmish/program.html">original code)</a> : </p><br><pre> <code class="haskell hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">&lt;'msg&gt; = 'msg -&gt; unit </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Sub</span></span></span><span class="hljs-class">&lt;'msg&gt; = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">&lt;'msg&gt; -&gt; unit </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">&lt;'msg&gt; = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Sub</span></span></span><span class="hljs-class">&lt;'msg&gt; list </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'model, 'msg, 'view&gt; = { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class"> -&gt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">update</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class"> -&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> -&gt; ('</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> * </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">&gt;) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">setState</span></span></span><span class="hljs-class">: '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> -&gt; '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Dispatch</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">&gt; -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class"> } let runWith&lt;'arg, 'model, 'msg, 'view&gt; (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">program</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Program</span></span></span><span class="hljs-class">&lt;'</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">msg</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">view</span></span></span><span class="hljs-class">&gt;) = let (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initModel</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initCmd</span></span></span><span class="hljs-class">) = program.init() //1 let mutable state = initModel //2 let mutable reentered = false //3 let buffer = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RingBuffer</span></span></span><span class="hljs-class"> 10 //4 let rec dispatch msg = let mutable nextMsg = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Some</span></span></span><span class="hljs-class"> msg; //5 if reentered //6 then buffer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Push</span></span></span><span class="hljs-class"> msg //7 else while </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Option</span></span></span><span class="hljs-class">.isSome nextMsg do // 8 reentered &lt;- true // 9 let (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cmd</span></span></span><span class="hljs-class">) = program.update nextMsg.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Value</span></span></span><span class="hljs-class"> state // 9 program.setState model nextMsg.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Value</span></span></span><span class="hljs-class"> dispatch // 10 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">.exec dispatch cmd |&gt; ignore //11 state &lt;- model; // 12 nextMsg &lt;- buffer.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Pop</span></span></span><span class="hljs-class">() // 13 reentered &lt;- false; // 14 </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Cmd</span></span></span><span class="hljs-class">.exec dispatch initCmd |&gt; ignore // 15 state //16 let run program = runWith program</span></span></code> </pre> <br><p>  The type of <em>Dispath &lt;'msg&gt; is</em> exactly the dispatch that is used in the <em>view</em> , it takes a <em>Message</em> and returns a <em>unit</em> <br>  <em>Sub &lt;'msg&gt;</em> is the subscriber function, accepts <em>dispatch</em> and returns <em>unit</em> , we generate a <em>Sub</em> list when using <em>ofMsg</em> : </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> ofMsg&lt;'msg&gt; (msg: 'msg): <span class="hljs-type"><span class="hljs-type">Cmd</span></span>&lt;'msg&gt; = [ fun (dispatch: <span class="hljs-type"><span class="hljs-type">Dispatch</span></span>&lt;'msg&gt;) -&gt; dispatch msg ]</code> </pre> <br><p>  After calling <em>ofMsg</em> , such as <em>Cmd.ofMsg RememberModel,</em> at the end of the <em>updateChangeAuthor</em> method, a subscriber will be <em>called</em> after some time and the message will be sent to the <em>update</em> method <br>  <em>Cmd &lt;'msg&gt;</em> - Sheet <em>Sub &lt;' msg&gt;</em> </p><br><p>  Let's go to the <em>Program</em> type, it is a generic type, it accepts the model type, the messages and the <em>view</em> , in the console application there is no need to return something from the <em>view</em> , but in Elmish.React view it returns the F # structure of the DOM tree. </p><br><p>  The <em>init</em> field is called at the start of elmish, this function returns the initial model and the first message, in my case I return <em>Cmd.ofMsg RememberModel</em> <br>  <em>Update</em> is the main <em>update</em> function, you are already familiar with it. </p><br><p>  <em>SetState</em> - in standard Elmish accepts only the model and <em>dispatch</em> and calls the <em>view</em> , but I need to send msg to replace the <em>view</em> depending on the message, I will show its implementation after we look at the exchange of messages. </p><br><p>  The <em>runWith</em> function, gets the configuration, then calls <em>init</em> , the model and the first message are returned, on lines 2,3 two modified objects are declared, the first in which the <em>state</em> will be stored, the second is needed for the <em>dispatch</em> function. </p><br><p>  At line 4, <em>buffer</em> is declared - you can take it as a queue, first went in - first came out (in fact, the implementation of <em>RingBuffer</em> is very interesting, I took it from the library, I advise you to read it on <a href="">github</a> ) </p><br><p>  Next comes the recursive <em>dispatch</em> function itself, the same one that is called in the <em>view</em> , on the first call, we bypass <em>if</em> on line 6 and immediately get into the loop, set <em>reented</em> to <em>true</em> , so that subsequent recursive calls do not enter this cycle again, but add new message in <em>buffer</em> . </p><br><p>  On line 9, we execute the <em>update</em> method, from which we take the modified model and the new message (for the first time this message is <em>RememberModel</em> ) <br>  <em>Line</em> 10 draws a model; the <em>SetState</em> method looks like this: </p><br><p><img src="https://habrastorage.org/webt/3v/2c/3l/3v2c3li4ffe4paffy46f98nadle.png"></p><br><p>  As you can see, different messages cause different <em>views.</em> <br>  This is a necessary measure not to block the flow, because a call to <em>Console.ReadLine</em> blocks the program's flow, and events such as <em>RememberModel, ChangeColor</em> (which are initiated inside the program, and not by the user) will wait each time the user presses the button, although they just have to change Colour. </p><br><p>  The first time, the <em>OnlyShowView</em> function will be called, which will simply draw the model. <br>  If instead of RememberModel the <em>WaitUserAction</em> message came to the <em>method</em> , then the <em>ShowAndUserActionView</em> function would be <em>called</em> , which would <em>draw the</em> model and block the stream, waiting for the button to be pressed, as soon as the button was pressed, the <em>dispatch</em> method would be called again, and the message would run in <em>buffer</em> (because <em>reenvited</em> = <em>false</em> ) </p><br><p>  Next, you need to process all messages that come from the <em>update</em> method, otherwise we will lose them, recursive calls will get into the loop only if <em>reented</em> becomes false.  The 11th line looks complicated, but in fact it‚Äôs just pushing all the messages in <em>buffer</em> : </p><br><pre> <code class="haskell hljs"><span class="hljs-title"><span class="hljs-title">let</span></span> exec&lt;'msg&gt; (dispatch: <span class="hljs-type"><span class="hljs-type">Dispatch</span></span>&lt;'msg&gt;) (cmd: <span class="hljs-type"><span class="hljs-type">Cmd</span></span>&lt;'msg&gt;) = cmd |&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>.map (fun sub -&gt; sub dispatch)</code> </pre> <br><p>  For all subscribers returned by the <em>update</em> method, <em>dispatch</em> will be called, thus these messages will be added to the <em>buffer</em> . </p><br><p>  On the 12th line, we update the model, fetch a new message and return the <em>reented</em> value to false, when the <em>buffer is</em> not empty, but if there are no elements left and <em>dispatch</em> can only be called from the <em>view</em> , it makes sense.  Again, in our case, when everything is synchronous, it does not make sense, since we expect a synchronous call to dispatch on line 10, but if there are asynchronous calls in the code, you can call <em>dispatch</em> from the callback and need to be able to continue executing the program. </p><br><p>  Well, that's all the description of the <em>dispatch</em> function, on line 15 it is called and on 16 it returns <em>state</em> . </p><br><p>  In a console application, an exit occurs when <em>buffer</em> becomes empty.  In the original version, <em>runWith returns</em> nothing, but without this testing is impossible. </p><br><p>  <em>Program</em> for testing is different, the <em>createProgram</em> function accepts a list of messages that the user would initiate, and in <em>SetState</em> they replace the usual click: <br><img src="https://habrastorage.org/webt/jc/tz/4u/jctz4uefscbzhubowwwfa9zltr8.png"></p><br><p>  Another difference of my modified version from the original one is that the update function is called first, and then only <em>setState</em> , in the original version, on the contrary, it first draws and then processes the messages, I had to go for this because of the blocking call <em>Console.ReadKey</em> (the need to change <em>view</em> ) </p><br><p>  I hope I managed to explain how Elmish and similar systems are arranged, quite a lot of Elmish functionality left behind, if you are interested in this topic, I advise you to look at their <a href="https://elmish.github.io/elmish/">website</a> . </p><br><p>  Thanks for attention! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459870/">https://habr.com/ru/post/459870/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459852/index.html">The practice of using the lottie library in the bank‚Äôs mobile application</a></li>
<li><a href="../459858/index.html">Research of modern Malware Cerberus for Android</a></li>
<li><a href="../459860/index.html">Configure ClickHouse for integration testing in gitlab-ci</a></li>
<li><a href="../459862/index.html">Berkeley DB STL Interface</a></li>
<li><a href="../459866/index.html">Solving a task with pwnable.kr 02 - collision. Hash collision</a></li>
<li><a href="../459872/index.html">Patton Jeff. User stories. The art of agile software development</a></li>
<li><a href="../459874/index.html">You have something to hide</a></li>
<li><a href="../459878/index.html">7 tips to optimize CSS to speed up page loading</a></li>
<li><a href="../459882/index.html">Music "by default": what tracks could be found on players and personal computers</a></li>
<li><a href="../459886/index.html">Road rage: the way the developer billing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>