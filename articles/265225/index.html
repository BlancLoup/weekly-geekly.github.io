<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Local network organization with simultaneous connection to two Internet providers using MikroTik router</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose we have two ISPs. The first one receives the settings via L2TP, for the second one it is necessary to set the settings statically, and we need...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Local network organization with simultaneous connection to two Internet providers using MikroTik router</h1><div class="post__text post__text-html js-mediator-article">  Suppose we have two ISPs.  The first one receives the settings via L2TP, for the second one it is necessary to set the settings statically, and we need to organize a trouble-free Internet connection.  That is, <b>in case of failure of the first Internet provider, the router should automatically switch to the second (backup) provider.</b>  And when the connection with the first provider is restored, the router should start working with it again. <br><br><img src="https://habrastorage.org/files/7d0/8fb/d60/7d08fbd60ea342928c1275fd3b5024df.jpg"><br><a name="habracut"></a><br>  To solve the problem, we will use a router configured on the basis of RouterOS.  In this example, MikroTik rb951ui (5-port).  Provider ‚Äú1‚Äù (ISP1) via L2TP will be connected to port No. 1 accordingly.  In the second port provider "2" (ISP2) with StaticIP.  Ports ‚Ññ3, ‚Ññ4, ‚Ññ5 will serve to connect network clients.  IP addresses on the local network will be distributed via DHCP.  The availability of the first or second channel will be judged by the availability of the IP address.  For example, take DNS google.com, the probability of failure of which is very small. <br><br>  Sequencing.  We connect the router to port number 3 and, accordingly, the LAN interface of the PC.  To configure RouterOS, the winbox utility will be used.  Go to the MAC-address and log in.  We see the router configuration interface.  (Fig. 1) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/a26/b49/59b/a26b4959b9b04e7084d1c6df311fe6d0.jpg"><br><br>  <i>Fig.</i>  <i>1. RouterOS configuration interface</i> <br><br>  The first thing we do is configure the interfaces of provider ‚Äú1‚Äù and provider ‚Äú2‚Äù Fig.2, as well as configure the LAN for ports 3, 4 and 5. <br><br><img src="https://habrastorage.org/files/0f3/af3/889/0f3af3889a5e4a06b6de81b7cbb4f936.jpg"><br><br>  <i>Fig.</i>  <i>2. Setting up provider "1" and provider "2"</i> <br><br>  In this case, Interface-1 belongs to provider ‚Äú1‚Äù (ISP1 is a name for convenience) Interface-2 belongs to provider ‚Äú2‚Äù (ISP2).  For LAN organization, go to the ‚ÄúBridge‚Äù menu item and add an interface with the name LAN.  (Fig.3). <br><br><img src="https://habrastorage.org/files/2af/491/322/2af4913229e24511b577a0c60fa4ee43.jpg"><br><br>  <i>Fig.</i>  <i>3. Organization of LAN</i> <br><br>  Indicates the ports that will belong to the internal network (Figure 4) <br><br><img src="https://habrastorage.org/files/7ac/60c/d4b/7ac60cd4b77540e18c5050c69c45f5bb.jpg"><br><br>  <i>Fig.</i>  <i>4. Adding Ports to LAN</i> <br><br>  Now you need to add the IP addresses of the providers, as well as specify the IP address of the gateway to our local network (Fig. 5). <br><br>  Description: The first thing we do is add a local area network gateway (numbers 4, 5).  Interface we specify LAN.  Second, add the static address of the second provider (numbers 6, 7) <br><br><img src="https://habrastorage.org/files/853/df5/e7a/853df5e7a06c44e892fb192782794fb3.jpg"><br><br>  <i>Fig.</i>  <i>5. Adding Addresses for Interfaces</i> <br><br>  Since the organization of the connection with the first provider is carried out via L2TP, it is necessary to add an L2TP client (Fig. 6) <br><br>  Note: Add L2TP-client (Number 2).  We indicate the corresponding parameters in the Dial-out tab, namely the server address, login and password, which are issued by the first provider (numbers 4, 5 and 6). <br><br><img src="https://habrastorage.org/files/54a/716/f4d/54a716f4d3e04852a5acf1584d1a0d24.jpg"><br><br>  <i>Fig.</i>  <i>6. Adding an L2TP Client</i> <br><br>  After adding a client in the status tab, we get a connection.  (Fig. 7) <br><br><img src="https://habrastorage.org/files/0c0/f9c/7ab/0c0f9c7ab1884990baf2bf66843fd001.jpg"><br><br>  <i>Fig.</i>  <i>7. Status of L2TP Connection</i> <br><br>  Now we are going to organize a DHCP server to distribute addresses to our internal network clients.  The first thing we will do is create a pool of issued addresses (Figure 8), and then configure the DHCP server itself.  (Figure 9). <br><br><img src="https://habrastorage.org/files/985/a65/82b/985a6582b8f74156a777106d7f784ccf.jpg"><br><br>  <i>Fig.</i>  <i>8. Creating a pool of issued addresses</i> <br><br><img src="https://habrastorage.org/files/72a/787/a49/72a787a49df14f0fad1f3b5c2c77dbad.jpg"><br><br>  <i>Fig.</i>  <i>9. Adding and configuring a DHCP server</i> <br><br>  Description of the DHCP server: Add the server with the name (server1) to the internal LAN interface with the address pool that was created earlier.  In the network we specify which parameters to transfer to the server to the clients. <br><br>  Now we need to add static routes, since all interaction between networks is carried out in accordance with the routing table.  It is controlled in RouterOS in the ‚ÄúRoutes‚Äù menu.  Addressing with a local network and with internal networks of providers was added dynamically.  It remains to add routes to the Internet (to the address 0.0.0.0/0) through provider gateways.  (Fig. 10). <br><br><img src="https://habrastorage.org/files/6cf/fa7/a2f/6cffa7a2f7af4f3386c5226a123a4da8.jpg"><br><br>  <i>Fig.</i>  <i>10. Adding static routes</i> <br><br>  Further, it is necessary to organize switching of channels in case of unavailability of 1 channel.  The router's OS has a built-in utility ‚ÄúNetwatch‚Äù, which allows you to monitor the status of hosts on your network by sending ICMP requests (ping) and perform any actions based on their availability.  We will track the IP address 8.8.4.4 through the first channel, and if it is not available, switch routes to work on the second one. <br><br>  We create a new ‚ÄúNetwatch host‚Äù, in the ‚ÄúHost‚Äù column we indicate the monitored IP address, and in ‚ÄúInterval‚Äù we indicate the frequency of the checks being made.  (Fig. 11). <br><br><img src="https://habrastorage.org/files/460/1da/3ea/4601da3ea5dc40f98a1f654347bd7ab2.jpg"><br><br>  <i>Fig.</i>  <i>11. Configure channel switching</i> <br><br>  And finally, in the Up tab (number 5) you need to write the following rule: <br><br>  # turn on the route with the comment "ISP1" (main channel) <br>  / ip route set [find comment = "ISP1"] disabled = no <br>  # disable the route with the comment "ISP2" (backup channel) <br>  / ip route set [find comment = "ISP2"] disabled = yes <br>  In the Down tab, write the following rule: <br>  # disable the route with the comment "ISP1" (backup channel) <br>  / ip route set [find comment = "ISP1"] disabled = yes <br>  # we include the route with the comment "ISP2" (main channel) <br>  / ip route set [find comment = "ISP2"] disabled = no <br><br>  <b>Setting rules for passing traffic</b> <br><br>  Using the built-in firewall, you can control absolutely all traffic; we need to disable ping on ISP2.  To do this in the terminal window we will write the following: <br>  # approve use of icmp protocol <br>  ip firewall filter add chain = input comment = "Permit icmp" <br><br>  # limit ping 8.8.4.4 via ISP2 <br>  ip firewall filter add action = drop chain = output comment = "Deny 8.8.4.4 to reserved internet-channel" dst-address = 8.8.4.4 out-interface = "ether2 - internet II (reserve)" protocol = "icmp" <br><br>  The material is introductory and intended to familiarize with the issue of managing a network with two providers. </div><p>Source: <a href="https://habr.com/ru/post/265225/">https://habr.com/ru/post/265225/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../265211/index.html">The simplest physics engine</a></li>
<li><a href="../265213/index.html">Multiproxy based on Debian and SQUID with transparent domain authentication</a></li>
<li><a href="../265215/index.html">Our translation of the article: Twenty-five goals of the software industry for 2015‚Äì2019</a></li>
<li><a href="../265217/index.html">The development of dials for Android Wear - it's easier than it seems</a></li>
<li><a href="../265219/index.html">Security Week 34: Nobody Patches Colonel</a></li>
<li><a href="../265227/index.html">Bypass authorization via social networks when connecting to public Wi-Fi</a></li>
<li><a href="../265229/index.html">What is ITIL and what does it eat?</a></li>
<li><a href="../265231/index.html">Use the official docker image of NGINX in InfoboxCloud: part 1</a></li>
<li><a href="../265233/index.html">Study: Vulnerabilities of a cryptotransponder allow keyless entry of over 100 models of machines.</a></li>
<li><a href="../265235/index.html">Sony PlayStation 4 security analysis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>