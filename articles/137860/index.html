<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arrays of models in MVC - tasty and hard?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The MVC paradigm largely simplifies code maintenance by separating logic and creating abstractions, but often, following the principle of Thick Model ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arrays of models in MVC - tasty and hard?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/983/ef6/57d/983ef657d54353b943393baf61a899de.jpg" align="right"><br>  The MVC paradigm largely simplifies code maintenance by separating logic and creating abstractions, but often, following the principle of Thick Model &amp; Thin Controller (also known as Fat Model &amp; Skinny Controller), developers have to rest on the cornerstone of using any model object, namely - in memory consumption.  What is especially important when working with models that implement the ORM (or ActiveRecord pattern). <br>  In this article I want to briefly demonstrate the standard approaches to solving this problem. <br><br><a name="habracut"></a><br>  For a start, a small digression for those who do not quite understand why you need to use models if you can work directly with data from the database without unnecessary abstractions. <br>  Actually, here are two variants of the code: <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($row[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] == <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// do something ... }</span></span></code> </pre> <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AUTH_ONLY = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $status; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAuthOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;status == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::AUTH_ONLY; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($post-&gt;isAuthOnly()) { <span class="hljs-comment"><span class="hljs-comment">// do something ... }</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you need to solve a problem quickly and simply - the first option is good.  However, if your code will live after you, read not only by you, as well as develop and expand, then the implementation of the second option is often preferable. <br><br>  The essence of the problem: <br>  By themselves, data models are found in large numbers, as a rule, when selecting records from a database.  Abstraction over database records (ORM) requires the implementation of a model with its own logic, however, creating models for each record selected is extremely resource intensive. <br><br>  Most often you can hear the following recommendation: <br>  If few records are needed, then it is possible with models, and if there are many, then it is already possible to process them with a separate query to the database with its own logic.  However, with a separate query, we partially lose the layer of abstraction to the table and lose the ability to use the logic of the model. <br><br>  Since an array of records of a relational database is inherently just a set of rows and fields, the first and most obvious solution is to use only one model object, and replace its parameters in the crawl loop of a sample of records. <br>  The result is something like this: <br><pre> <code class="php hljs">$post = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Post; $result = mysqli_query(<span class="hljs-string"><span class="hljs-string">'SELECT * FROM posts'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($row = mysqli_fetch_array($result)) { $post-&gt;setAttributes($row); <span class="hljs-comment"><span class="hljs-comment">//     if ($post-&gt;isAuthOnly()) { // do something ... } // do something ... }</span></span></code> </pre><br>  Thus, at the cost of some load, we get all the advantages of the model without increasing memory consumption for mass sampling.  Of course, provided we really need the logic of the model. <br><br>  However, this solution, although transparent, is not elegant enough, since when it is re-implemented, significant duplication of code will arise.  Let's call on Iterator‚Äôs strength for help: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostIterator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_model; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_result; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_row_num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_total_rows = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Post $model)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_model = $model; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">selectAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     $this-&gt;_result = mysqli_query('SELECT * FROM posts'); $this-&gt;_total_rows = mysqli_num_rows($this-&gt;_result); } public function current () { //      mysqli_data_seek($this-&gt;_result, $this-&gt;_row_num); $data = mysqli_fetch_array($this-&gt;_result); $this-&gt;_model-&gt;setAttributes($data); return $this-&gt;_model; } public function next () { //     ++$this-&gt;_row_num; } public function key () { //    return $this-&gt;_row_num; } public function valid () { //     return ($this-&gt;_row_num &lt; $this-&gt;_total_rows); } public function rewind () { //     mysqli_data_seek($this-&gt;_result, 0); $this-&gt;_row_num = 0; } } class Post { // ... public function getIterator() { return new PostIterator($this); } } //    $post_model = new Post; $post_iterator = $post_model-&gt;getIterator(); $post_iterator-&gt;selectAll(); foreach ($post_iterator as $post) { if ($post-&gt;isAuthOnly()) { // do something ... } // do something ... }</span></span></code> </pre><br>  I suppose additional comments are unnecessary here.  As a result, we obtained an object that allows processing large enough objects of records using model logic, while maintaining a small amount of memory consumed and sufficient ‚Äútransparency‚Äù. <br><br>  However, the code above has a number of flaws and bottlenecks: <br>  1. We have only one model (object) which we pass through the pseudo-reference inside the loop, as a result, its change within the loop will affect the whole subsequent loop. <br>  2. The transition operation based on the result of a query from the database (mysqli_data_seek) consumes its part of the resources, and if we do not need an ‚Äúexceptionally correct‚Äù implementation of the iterator, then we can slightly ‚Äúease‚Äù it.  Since the Traversable interface will appear in mysqli_result only in PHP 5.4, we cannot directly shift responsibility for its implementation in Iterator to mysqli_result.  However, in the result resource itself, this interface is implicitly implemented, which can be used. <br>  3. Additionally, it is not necessary for us to create a model (Post) each time previously to get an iterator.  This can be implemented through a static method. <br>  4. Usually, in conjunction with the iterator, it is sometimes convenient to implement the ArrayAccess interface, however, you can easily implement this point yourself if necessary (mysqli_data_seek to help you). <br><br>  As regards the above comments, we can get the following, slightly optimized code: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostIterator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_model; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_result; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_row_num = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_total_rows = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_current_data = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      public function __construct($model) { $this-&gt;_model = $model; } public function selectAll() { $this-&gt;_result = mysqli_query('SELECT * FROM posts'); $this-&gt;_total_rows = mysqli_num_rows($this-&gt;_result); $this-&gt;_current_data = mysqli_fetch_array($this-&gt;_result); //  return $this; //  MethodChaining } public function current () { $model = clone $this-&gt;_model; //   $model-&gt;setAttributes($this-&gt;_current_data); return $model; } public function next () { ++$this-&gt;_row_num; $this-&gt;_current_data = mysqli_fetch_array($this-&gt;_result); //  } public function key () { return $this-&gt;_row_num; } public function valid () { return ($this-&gt;_row_num &lt; $this-&gt;_total_rows); } public function rewind () { mysqli_data_seek($this-&gt;_result, 0); $this-&gt;_row_num = 0; $this-&gt;_current_data = mysqli_fetch_array($this-&gt;_result); //  } } class Post { // ... public static function getIterator() { $class_name = __CLASS__; return new PostIterator(new $class_name); } } //    $post_iterator = Post::getIterator()-&gt;selectAll(); foreach ($post_iterator as $post) { if ($post-&gt;isAuthOnly()) { // do something ... } // do something ... }</span></span></code> </pre><br>  As a result, we got a fairly simple ‚Äúbicycle‚Äù, which, with proper ‚Äúfile completion‚Äù, will allow the models to be used more flexibly and with larger sample sizes. <br>  In it, we got rid of the above disadvantages, however, there is a problem with using the internal iterator of the query result, which does not come up with standard use only in the foreach loop, but using the Iterator interface in more complex structures will not work (choose this approach or not for speed) - you decide, it all depends on the task). <br><br>  Serious disadvantages of this approach: <br>  1. More significant load on the computing resources of the machine.  Therefore, it is correct to always have a cache layer behind such an implementation, in fact, like everywhere else. <br>  2. Not every model logic can be used with a similar abstraction, for example, relational model relationships.  If there are any, then they will have to either be ‚Äúsewn up‚Äù inside the iterator, or they should look for some more optimal solution within the model itself. <br>  3. Additional difficulties may arise if it is required to use a model with states, which will also require a separate implementation for the iterator. <br><br>  PS: <br>  All the above code is quite abstract from any specific task.  It is given only to obtain a general idea of ‚Äã‚Äãthe principle, which can be independently implemented in practice.  And, of course, there is no limit to perfection. </div><p>Source: <a href="https://habr.com/ru/post/137860/">https://habr.com/ru/post/137860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../137855/index.html">Hero numbers - Build Manager</a></li>
<li><a href="../137856/index.html">Jelastic is now in Russia</a></li>
<li><a href="../137857/index.html">Node.js daemon for FreeBSD: forever + rc.d</a></li>
<li><a href="../137858/index.html">Questions by Leonardo da Vinci</a></li>
<li><a href="../137859/index.html">Google will collect search statistics, offering money to users</a></li>
<li><a href="../137861/index.html">The app in honor of Valentine's Day on libgdx</a></li>
<li><a href="../137862/index.html">Can you trust WebVizor from Yandex?</a></li>
<li><a href="../137863/index.html">Background Information Update</a></li>
<li><a href="../137864/index.html">Pseudorandom vs. Truly Random</a></li>
<li><a href="../137865/index.html">CISM certification experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>