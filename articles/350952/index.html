<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Testing C / C ++ Projects with Python</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The ability to integrate Python and C / C ++ is well known. Typically, this technique is used to accelerate programs in Python or to tu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Testing C / C ++ Projects with Python</h1><div class="post__text post__text-html js-mediator-article"><h3>  Introduction </h3><br>  The ability to integrate Python and C / C ++ is well known.  Typically, this technique is used to accelerate programs in Python or to tune programs in C / C ++.  I would like to highlight the possibility of using python to test C / C ++ code in the IDE without the support of the test organization system in the IDE.  From my point of view, it is advisable to apply in the field of software development for microcontrollers. <br><br>  You can talk a lot about the need for tests in projects, I assume that tests help me develop the functionality of the program.  And after the completion of the project, after some time, help to understand it and save it from mistakes. <br><br>  When developing programs for microcontrollers, I came across a lack of standard input / output (of course, you can redefine the input and output functions in the simulator, output data via the UART - but often the UART is already involved, and the simulator does not always work correctly) hardware erroneous business logic.  At the development stage, I implemented separate projects, testing parts of the program, and then I was responsible for running all test applications after making changes.  Of course, all this can be automated.  So you can work, but I found a better way. <br><a name="habracut"></a><br><h3>  Method Description </h3><br>  It is possible to use python (namely ctypes) to cover the tests of individual modules of the project in C / C ++.  The essence of the technique is reduced to the creation of isolated parts that implement part of the functionality in the form of dynamically linked libraries (dll), data input and control of the result.  Python is used as a ‚Äústrapping‚Äù.  This technique does not imply a change in the code of the application under test. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To test individual pieces of code, you may need to create an additional c / c ++ file - ‚Äúadapter‚Äù, to deal with the naming of overloaded functions (the naming of exported functions is covered in detail in <a href="https://habrahabr.ru/post/150327/">habrahabr.ru/post/150327</a> ) or with functionality having complex dependencies and hard to implement in the "ideology" dll. <br><br><h3>  Necessary software environment </h3><br>  This technique implies the ability to compile individual parts of the program from the command line.  So we need a c / c ++ compiler, and a python interpreter.  For example, I use GCC (for windows - MinGW (MinGw <a href="http://www.mingw.org/">www.mingw.org</a> ), python ( <a href="https://www.python.org/">www.python.org</a> ), well, as a rule, in linux distributions, as a rule, everything you need is set to default). <br><br><h3>  Usage example </h3><br>  To illustrate this technique, I will give the following example: <br>  initial project: <br><br>  file structure: <br><br><pre> + --- Project
     |  Makefile
     + --- src
         + --- api
         |  ApiClass.cpp
         |  ApiClass.h
         |  ApiFunction.cpp
         |  ApiFunction.h
         |       
         \ --- user
                 main.cpp
</pre><br>  Project files: <br><br><div class="spoiler">  <b class="spoiler_title">ApiFunction.cpp file</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ApiFunction.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cstring&gt; int apiFunction(int v1, int v2){ return v1*v2; } void apiFunctionMutablePointer(double * value){ * value = *value * 100; } Data apiFunctionGetData(){ Data dt; dt.intValue = 1; dt.doubleValue = 3.1415; dt.ucharValue = 0xff; return dt; } Data GLOBAL_DATA; Data * apiFunctionGetPointerData(){ GLOBAL_DATA.intValue = 1*2; GLOBAL_DATA.doubleValue = 3.1415*2; GLOBAL_DATA.ucharValue = 0xAA; return &amp;GLOBAL_DATA; } void apiFunctionMutablePointerData(Data * data){ data-&gt;intValue = data-&gt;intValue * 3; data-&gt;doubleValue = data-&gt;doubleValue *3; data-&gt;ucharValue = data-&gt;ucharValue * 3; } BigData apiFunctionGetBigData(){ BigData bd; bd.iv = 1; bd.v1 = 2; bd.v2 = 3; bd.v3 = 4; bd.v4 = 5; std::memset(bd.st,0,12); std::memmove(bd.st,"hello world",12); return bd; }</span></span></span></span></code> </pre> <br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">ApiFunction.h file</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> SRC_API_APIFUNCTION_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SRC_API_APIFUNCTION_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> int apiFunction(int v1, int v2); void apiFunctionMutablePointer(double * value); struct Data{ int intValue; double doubleValue; unsigned char ucharValue; }; struct BigData{ int iv; int v1:4; int v2:4; int v3:8; int v4:16; char st[12]; }; Data apiFunctionGetData(); Data * apiFunctionGetPointerData(); void apiFunctionMutablePointerData(Data * data); BigData apiFunctionGetBigData(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">ApiClass.cpp file</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ApiClass.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; ApiClass::ApiClass():value(0) { std::cout&lt;&lt;std::endl&lt;&lt;"create ApiClass value = "&lt;&lt;value&lt;&lt;std::endl; } ApiClass::ApiClass(int startValue): value(startValue){ std::cout&lt;&lt;std::endl&lt;&lt;"create ApiClass value = "&lt;&lt;value&lt;&lt;std::endl; } ApiClass::~ApiClass() { std::cout&lt;&lt;std::endl&lt;&lt;"delete ApiClass"&lt;&lt;std::endl; } int ApiClass::method(int vl){ value +=vl; return value; }</span></span></span></span></code> </pre><br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">ApiClass.h file</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> SRC_API_APICLASS_H_ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SRC_API_APICLASS_H_ class ApiClass { public: ApiClass(); ApiClass(int startValue); virtual ~ApiClass(); int method(int vl); private: int value; }; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Main.cpp file</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;iostream&gt; #include "ApiFunction.h" #include "ApiClass.h" int main(){ std::cout&lt;&lt;"start work"&lt;&lt;std::endl; std::cout&lt;&lt;"=============================================="&lt;&lt;std::endl; std::cout&lt;&lt;"call apiFunction(10,20) = "&lt;&lt;apiFunction(10,20)&lt;&lt;std::endl; std::cout&lt;&lt;"call apiFunction(30,40) = "&lt;&lt;apiFunction(30,40)&lt;&lt;std::endl; std::cout&lt;&lt;"=============================================="&lt;&lt;std::endl; ApiClass ac01; std::cout&lt;&lt;"call ac01.method(30) = "&lt;&lt;ac01.method(30)&lt;&lt;std::endl; std::cout&lt;&lt;"call ac01.method(40) = "&lt;&lt;ac01.method(40)&lt;&lt;std::endl; std::cout&lt;&lt;"=============================================="&lt;&lt;std::endl; ApiClass ac02(10); std::cout&lt;&lt;"call ac02.method(30) = "&lt;&lt;ac02.method(30)&lt;&lt;std::endl; std::cout&lt;&lt;"call ac02.method(40) = "&lt;&lt;ac02.method(40)&lt;&lt;std::endl; }</span></span></span></span></code> </pre><br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">makefile</b> <div class="spoiler_text"><pre> <code class="hljs mel">FOLDER_EXECUTABLE = bin/ EXECUTABLE_NAME = Project.exe EXECUTABLE = $(FOLDER_EXECUTABLE)$(EXECUTABLE_NAME) FOLDERS = bin bin/src bin/src/api bin/src/user SOURSES = src/user/main.cpp src/api/ApiClass.cpp src/api/ApiFunction.cpp CC = g++ CFLAGS = -c -Wall -Isrc/helper -Isrc/api LDFLAGS = OBJECTS = $(SOURSES:.cpp=.o) OBJECTS_PATH = $(addprefix $(FOLDER_EXECUTABLE),$(OBJECTS)) all: $(SOURSES) $(EXECUTABLE) $(EXECUTABLE): $(OBJECTS) $(CC) $(LDLAGS) $(OBJECTS_PATH) -o $@ .cpp.o: mkdir -p $(FOLDERS) $(CC) $(CFLAGS) $&lt; -o $(FOLDER_EXECUTABLE)$@ clean: rm -rf $(OBJECTS) $(EXECUTABLE)</code> </pre><br></div></div><br>  To cover the tests in the project folder, add the test folder.  In this folder, we will have everything related to testing. <br><br>  For convenience, we will create a helpers folder in the test folder (we don‚Äôt forget to create the python package inside the __init__.py file) - this will contain support functions common to all tests. <br>  Helper functions from the helpers package: <br><br><div class="spoiler">  <b class="spoiler_title">CallCommandHelper.py file</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallCommandHelperException</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Exception)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CallCommandHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cmd)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> subprocess.Popen(cmd, stdout=subprocess.PIPE,shell=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> proc: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> proc.wait() != <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> CallCommandHelperException(<span class="hljs-string"><span class="hljs-string">"error :"</span></span> +cmd)</code> </pre><br><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">CreteDll.py file</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> helpers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> callCommandHelper <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(folderTargetName, fileTargetName,fileSO)</span></span></span><span class="hljs-function">:</span></span> templateCompill = <span class="hljs-string"><span class="hljs-string">"g++ {flags} {fileSourse} -o {fileTarget}"</span></span> templateLinc = <span class="hljs-string"><span class="hljs-string">"g++ -shared {objectfile} -o {fileTarget}"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> os.path.exists(folderTargetName) == <span class="hljs-keyword"><span class="hljs-keyword">False</span></span>: os.makedirs(folderTargetName) <span class="hljs-comment"><span class="hljs-comment">#---------------delete old version----------------------------------- if os.path.exists(fileTargetName): os.remove(fileTargetName) for fso in fileSO: if os.path.exists(fso["rezultName"]): os.remove(fso["rezultName"]) #---------------compil ----------------------------------------------- for filePair in fileSO: fileSourseName = filePair["sourseName"] fileObjecteName = filePair["rezultName"] flagCompil = filePair["flagsCompil"] cmd = templateCompill.format( fileSourse = fileSourseName, flags = flagCompil, fileTarget = fileObjecteName) callCommandHelper.CallCommandHelper(cmd) #---------------linck----------------------------------------------- fileObjectName = " " for filePair in fileSO: fileObjectName = fileObjectName + filePair["rezultName"]+" " cmd = templateLinc.format( objectfile = fileObjectName, fileTarget = fileTargetName) callCommandHelper.CallCommandHelper(cmd) #======================================================</span></span></code> </pre><br></div></div><br>  Note: If you use a compiler other than gcc, then you need to correct the name of the programs in the templateCompill and templateLinc variables. <br><br>  In the creteDll.py file, all the magic of creating a test dll occurs.  I simply create commands for the operating system used to compile and link (build) dll.  As an option, it is possible to create a makefile template and substitute file names there, but it seemed so easier to me.  (in general, as I understand, all the testing work can be taken out in a makefile, but it seems difficult to me, and projects created in keil or in other IDEs are not always built on a makefile). <br><br>  This completed all the training, we can now begin testing. <br><br><h3>  Easy test creation </h3><br>  Consider the option to create a test without using an adapter. <br><br>  Test the functions from the piFunction.h / piFunction.cpp file. <br><br>  Create a folder in the test folder for ApiFunctionTest for the created dll.  Create a Python file to perform the test using the unittest module.  In the setUpClass method, dll is created, loaded and ‚Äúconfigured‚Äù functions.  And later we need to write standard methods for testing. <br><br><div class="spoiler">  <b class="spoiler_title">ApiFunctionTest.py file</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> helpers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> creteDll <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Data</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ctypes.Structure)</span></span></span><span class="hljs-class">:</span></span> _fields_ = [(<span class="hljs-string"><span class="hljs-string">"intValue"</span></span>,ctypes.c_int),(<span class="hljs-string"><span class="hljs-string">"doubleValue"</span></span>,ctypes.c_double),(<span class="hljs-string"><span class="hljs-string">"ucharValue"</span></span>,ctypes.c_ubyte)] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigData</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ctypes.Structure)</span></span></span><span class="hljs-class">:</span></span> _fields_ = [(<span class="hljs-string"><span class="hljs-string">"iv"</span></span>,ctypes.c_int), (<span class="hljs-string"><span class="hljs-string">"v1"</span></span>,ctypes.c_int,<span class="hljs-number"><span class="hljs-number">4</span></span>), (<span class="hljs-string"><span class="hljs-string">"v2"</span></span>,ctypes.c_int,<span class="hljs-number"><span class="hljs-number">4</span></span>), (<span class="hljs-string"><span class="hljs-string">"v3"</span></span>,ctypes.c_int,<span class="hljs-number"><span class="hljs-number">8</span></span>), (<span class="hljs-string"><span class="hljs-string">"v4"</span></span>,ctypes.c_int,<span class="hljs-number"><span class="hljs-number">16</span></span>), (<span class="hljs-string"><span class="hljs-string">"st"</span></span>,ctypes.c_char*<span class="hljs-number"><span class="hljs-number">12</span></span>)] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiFunctionTest</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> folderTargetName = os.path.join(os.path.dirname(__file__),<span class="hljs-string"><span class="hljs-string">"ApiFunctionTest"</span></span>) fileSO = [ {<span class="hljs-string"><span class="hljs-string">"sourseName"</span></span>:<span class="hljs-string"><span class="hljs-string">"../src/api/ApiFunction.cpp"</span></span>, <span class="hljs-string"><span class="hljs-string">"flagsCompil"</span></span>:<span class="hljs-string"><span class="hljs-string">"-Wall -c -fPIC"</span></span>, <span class="hljs-string"><span class="hljs-string">"rezultName"</span></span> :os.path.join(folderTargetName,<span class="hljs-string"><span class="hljs-string">"ApiFunction.o"</span></span>)} ] fileTargetName = os.path.join(folderTargetName,<span class="hljs-string"><span class="hljs-string">"ApiFunction.dll"</span></span>) <span class="hljs-comment"><span class="hljs-comment">#============================================================= creteDll.CreateDll(folderTargetName, fileTargetName, fileSO) lib = ctypes.cdll.LoadLibrary(fileTargetName) self.apiFunction = lib.apiFunction self.apiFunction.restype = ctypes.c_int self.apiFunctionMutablePointer = lib.apiFunctionMutablePointer self.apiFunctionMutablePointer.argtype = ctypes.POINTER(ctypes.c_double) self.apiFunctionGetData = lib.apiFunctionGetData self.apiFunctionGetData.restype = Data self.apiFunctionGetPointerData = lib.apiFunctionGetPointerData self.apiFunctionGetPointerData.restype = ctypes.POINTER(Data) self.apiFunctionMutablePointerData = lib.apiFunctionMutablePointerData self.apiFunctionMutablePointerData.argtype = ctypes.POINTER(Data) self.apiFunctionGetBigData = lib.apiFunctionGetBigData self.apiFunctionGetBigData.restype = BigData def test_var1(self): self.assertEqual(self.apiFunction(10,20), 200,'10*20 = 200') def test_var2(self): self.assertEqual(self.apiFunction(30,40), 1200,'30*40 = 1200') def test_var3(self): vl = ctypes.c_double(1.1) self.apiFunctionMutablePointer(ctypes.pointer(vl) ) self.assertEqual(vl.value, 110.00000000000001,'vl != 110') def test_var4(self): data = self.apiFunctionGetData() self.assertEqual(data.intValue, 1,'data.intValue != 1') self.assertEqual(data.doubleValue, 3.1415,'data.doubleValue != 3.1415') self.assertEqual(data.ucharValue, 0xff,'data.ucharValue != 0xff') def test_var5(self): pointerData = self.apiFunctionGetPointerData() self.assertEqual(pointerData.contents.intValue, 1*2,'data.intValue != 1*2') self.assertEqual(pointerData.contents.doubleValue, 3.1415*2,'data.doubleValue != 3.1415 * 2') self.assertEqual(pointerData.contents.ucharValue, 0xAA,'data.ucharValue != 0xAA') def test_var5(self): pointerData = ctypes.pointer(Data()) pointerData.contents.intValue = ctypes.c_int(10) pointerData.contents.doubleValue = ctypes.c_double(20) pointerData.contents.ucharValue = ctypes.c_ubyte(85) self.apiFunctionMutablePointerData(pointerData) self.assertEqual(pointerData.contents.intValue, 30,'data.intValue != 30') self.assertEqual(pointerData.contents.doubleValue, 60,'data.doubleValue != 60') self.assertEqual(pointerData.contents.ucharValue, 0xff,'data.ucharValue != 0xff') def test_var6(self): bigData = self.apiFunctionGetBigData() st = ctypes.c_char_p(bigData.st).value self.assertEqual(bigData.iv, 1,'1') self.assertEqual(bigData.v1, 2,'2') self.assertEqual(bigData.v2, 3,'3') self.assertEqual(bigData.v3, 4,'4') self.assertEqual(bigData.v4, 5,'5') self.assertEqual(st in b"hello world",True,'getting string')</span></span></code> </pre><br></div></div><br>  Note: If you are using a compiler other than gcc, then you need to fix the line with the flagsCompil key. <br><br>  As you can see for testing there is no need for any additional actions.  We are limited only by the fantasy of creating test scripts.  This example demonstrates the possibilities of transferring functions to a sish function and obtaining various types of data from them (this is described in more detail in the <a href="https://docs.python.org/3.5/library/ctypes.html">ctypes</a> documentation). <br><br><h3>  Creating a test using the "adapter" </h3><br>  Consider the option to create a test using the "adapter". <br><br>  Test the ApiClass class from the ApiClass.h / ApiClass.cpp files.  As you can see, this class has several options for creating, it also saves state between calls.  Create a folder in the test folder for ApiClassTest for the dll being created, and the ‚Äúadapter‚Äù is ApiClassAdapter.cpp. <br><br><div class="spoiler">  <b class="spoiler_title">ApiClassAdapter.cpp file</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ApiClass.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> ApiClass * pEmptyApiClass = 0; ApiClass * pApiClass = 0; void createEmptyApiClass(){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(pEmptyApiClass != 0){ delete pEmptyApiClass; } pEmptyApiClass = new ApiClass; } void deleteEmptyApiClass(){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(pEmptyApiClass != 0){ delete pEmptyApiClass; pEmptyApiClass=0; } } void createApiClass(int value){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(pApiClass != 0){ delete pApiClass; } pApiClass = new ApiClass(value); } void deleteApiClass(){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(pApiClass != 0){ delete pApiClass; pApiClass=0; } } int callEmptyApiClassMethod(int vl){ return pEmptyApiClass-&gt;method(vl); } int callApiClassMethod(int vl){ return pApiClass-&gt;method(vl); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre><br></div></div><br>  As you can see, the ‚Äúadapter‚Äù simply wraps up the ApiClass class calls for the convenience of calls from python. <br><br>  To test this class, create an apiClassTest.py file. <br><br><div class="spoiler">  <b class="spoiler_title">ApiClassTest.py file</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> helpers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> creteDll <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiClassTest</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUpClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> folderTargetName = os.path.join(os.path.dirname(__file__),<span class="hljs-string"><span class="hljs-string">"ApiClassTest"</span></span>) fileSO = [ { <span class="hljs-string"><span class="hljs-string">"sourseName"</span></span>:os.path.abspath(<span class="hljs-string"><span class="hljs-string">"../src/api/ApiClass.cpp"</span></span>), <span class="hljs-string"><span class="hljs-string">"flagsCompil"</span></span>:<span class="hljs-string"><span class="hljs-string">"-Wall -c -fPIC"</span></span>, <span class="hljs-string"><span class="hljs-string">"rezultName"</span></span> :os.path.join(folderTargetName,<span class="hljs-string"><span class="hljs-string">"ApiClass.o"</span></span>) }, { <span class="hljs-string"><span class="hljs-string">"sourseName"</span></span>:os.path.join(folderTargetName,<span class="hljs-string"><span class="hljs-string">"ApiClassAdapter.cpp"</span></span>), <span class="hljs-string"><span class="hljs-string">"flagsCompil"</span></span>:<span class="hljs-string"><span class="hljs-string">"-Wall -c -fPIC -I../src/api"</span></span>, <span class="hljs-string"><span class="hljs-string">"rezultName"</span></span> :os.path.join(folderTargetName,<span class="hljs-string"><span class="hljs-string">"ApiClassAdapter.o"</span></span>) } ] fileTargetName = os.path.join(folderTargetName,<span class="hljs-string"><span class="hljs-string">"ApiClass.dll"</span></span>) <span class="hljs-comment"><span class="hljs-comment">#====================================================== creteDll.CreateDll(folderTargetName, fileTargetName, fileSO) #====================================================== lib = ctypes.cdll.LoadLibrary(fileTargetName) self.createEmptyApiClass = lib.createEmptyApiClass self.deleteEmptyApiClass = lib.deleteEmptyApiClass self.callEmptyApiClassMethod = lib.callEmptyApiClassMethod self.callEmptyApiClassMethod.restype = ctypes.c_int self.createApiClass = lib.createApiClass self.deleteApiClass = lib.deleteApiClass self.callApiClassMethod = lib.callApiClassMethod self.callApiClassMethod.restype = ctypes.c_int def tearDown(self): self.deleteEmptyApiClass() self.deleteApiClass() def test_var1(self): self.createEmptyApiClass() self.assertEqual(self.callEmptyApiClassMethod(10), 10,'10+0 = 10') self.assertEqual(self.callEmptyApiClassMethod(20), 30,'20+10 = 30') def test_var2(self): self.createApiClass(100) self.assertEqual(self.callApiClassMethod(10), 110,'10+100 = 110') self.assertEqual(self.callApiClassMethod(20), 130,'20+110 = 130')</span></span></code> </pre><br></div></div><br>  Here you should pay attention to the tearDown method, after each test method, the objects created in the dll are deleted in it to prevent memory leaks (in this context, this does not have a special meaning). <br><br>  Well, the union of all the tests in the file TestRun.py <br><br><div class="spoiler">  <b class="spoiler_title">TestRun.py file</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest loader = unittest.TestLoader() suite = loader.discover(start_dir=<span class="hljs-string"><span class="hljs-string">'.'</span></span>, pattern=<span class="hljs-string"><span class="hljs-string">'*Test.py'</span></span>) runner = unittest.TextTestRunner(verbosity=<span class="hljs-number"><span class="hljs-number">5</span></span>) result = runner.run(suite)</code> </pre><br></div></div><br><h3>  Run all tests </h3><br>  At the command prompt, type: <br><br><pre> <code class="bash hljs">python TestRun.py</code> </pre> <br>  (or run individual tests, like this: python -m unittest apiFunctionTest.py) and enjoy the results. <br><br><h3>  The disadvantages of this technique </h3><br>  The disadvantages of this technique include: <br><br><ul><li>  the relative complexity of the dll creation algorithm. </li><li>  Possible problems associated with type consistency and alignment issues in structures. </li><li>  Debugging possible errors in the "adapter" file. </li><li>  Great compile time for individual dll. </li><li>  You must correctly and manually select the compilation keys. </li><li>  The need to install additional software. </li></ul><br><h3>  findings </h3><br>  Of course, it is good to use IDE with built-in test support, but if there is none, then this technique makes life much easier.  It is enough to spend time setting up a project testing system.  It should also be noted that it is possible to use the python parsing capabilities to generate live documentation and, in general, python's capabilities for working with C / C ++ program texts. <br><br>  <a href="https://github.com/aabDevelop/Project">Link to the project archive</a> . <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/350952/">https://habr.com/ru/post/350952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350942/index.html">Autotest, balancing, terminal and not only - what we will talk about this Thursday</a></li>
<li><a href="../350944/index.html">March 22-24, Moscow, OpenHack on Microsoft containers and microservices</a></li>
<li><a href="../350946/index.html">React + SVG game development. Part 3</a></li>
<li><a href="../350948/index.html">How to deal with ‚Äúnihilists in information security‚Äù</a></li>
<li><a href="../350950/index.html">Telephony for hotels: billing and wake-up calls in 3CX</a></li>
<li><a href="../350954/index.html">How to monitor the work of the business process and not be distracted by nonsense</a></li>
<li><a href="../350956/index.html">Rust: use serde to serialize</a></li>
<li><a href="../350960/index.html">Integration between monitoring and ITSM</a></li>
<li><a href="../350962/index.html">Hooks life cycle Vue.js</a></li>
<li><a href="../350964/index.html">How we saddled OPNsense</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>