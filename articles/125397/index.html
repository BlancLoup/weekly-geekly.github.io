<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Beautiful parsing email alerts from the bank</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We continue to delight you with interesting technical solutions. 

 Today on the queue email alerts from the bank, which look like this: 


 Pokupka, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Beautiful parsing email alerts from the bank</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://zenmoney.ru/%3Fp%3Dhabr"><img src="https://habrastorage.org/storage1/fde98f52/6ef96e55/83aa0670/26f54a70.jpg" align="left"></a>  We <a href="http://habrahabr.ru/blogs/eCommerce/118161/">continue to delight</a> you with interesting technical solutions. <br><br>  Today on the queue email alerts from the bank, which look like this: <br><pre>  Pokupka, SHELL AZS OLGINO 1133, karta * 347788, 07.23.11 12:09, 300.25 rub.  Dostupno = 421.61 rub </pre>  or so <br><pre>  1000.00 RUR was charged from your account ** 77876.
 Point of sale: ZAO GAMMAEKSPER
 Date: 07/12/2011
 Available balance: 12344.11 RUR </pre><br><br>  What do you think the beautiful handling of such alerts in the personal finance service should look like? <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  The king is dead </h2><br>  I'll start with the story.  Email processing appeared in <a href="https://zenmoney.ru/%3Fp%3Dhabr">Zen-mani</a> more than a year ago.  But then she had a bunch of flaws: <br><ul><li>  only one bank was supported; </li><li>  each Zen-Mani account had its own email-address and, if you had several accounts in one bank, the payments to the accounts were not shared; </li><li>  if the bank sent any notifications, they did not reach you, because the service intercepted all the letters. </li></ul><br>  The inconvenience of working with email alerts and the success of our overseas counterpart Mint (for which you <i>do</i> n‚Äôt need to enter expenses and incomes at all (he gets all the data from a bank card and kindly sorts them into food, gasoline, entertainment ...) prompted us to rewrite the processing email alerts. <br><br>  Let's start small, increase the support of banks to four: VTB24, Citibank, Bank Saint Petersburg and Bank24.ru.  This is done by smart regular expressions and hard testing :) <br><br>  Then the first interesting solution, leave one email address (dropbox).  In general, one for all accounts and all banks (for one user).  The difference in accounts occurs in the last four digits.  The user enters them at the stage of creating an account: <br><br> <a href="https://zenmoney.ru/%3Fp%3Dhabr"><img src="https://habrastorage.org/storage1/f5c47198/504f9662/c7771344/0b664c07.png"></a> <br><br>  The last inconvenience with the loss of information letters, we decided by sending all messages to the user's personal email.  And it was a very difficult decision for us.  Before this function, we did not ask for e-mail in order to preserve the privacy of such sensitive information as personal finances as much as possible.  Now you have a choice to specify the mail or not. <br><br>  These three improvements are not enough for a beautiful solution.  The user still has to determine what each transaction was spent on: gasoline, training, or something else.  <b>I suggest you unravel what we came up with</b> :) The answer is below under the heading ‚ÄúZest‚Äù, but for now some code. <br><br><h2>  Parser mechanism </h2><br>  The message parser works in two stages: <br><ul><li>  definition of letter format; </li><li>  directly parsing. </li></ul><br>  We will parse this letter here: <br><pre>  Dear Customer,

 1000.00 RUR was charged from your account ** 77876.
 Point of sale: ZAO GAMMAEKSPERT
 Date: 07/12/2011
 Available balance: 12344.11 RUR
 Please note that the available balance on the current ruble account includes a credit limit.

 If you do not agree with the information received, please contact a CitiPhone employee at (495) 775 75 75 (in Moscow), (812) 336 75 75 (in St. Petersburg), 8 (800) 700 38 38 (in other . cities of the Russian Federation) for eight days.

 For more information about our services, visit our website on www.citibank.ru. </pre><br><br>  To determine from which bank the letter came, and what to expect inside we use the following sign: <br><pre>  id foreign_format check_order marker_location marker_pattern datatype
 43 33 0 10 /www\.citibank\.ru/mail
 44 33 1 2 / ^ \ d / mail </pre><br><br>  For each letter, we check each of the formats in turn in the check_order order and look for marker_pattern in the lines.  As it is easy to check the letter from Citibank above gives us 33 format. <br><br>  From the second table select field parsers for 33 formats: <br><pre>  id column_name value_offset foreign_format
 49 outcome 2 / ^ ([\ d \.] +) / "33
 50 datedmy 4 # (\ d {2} / \ d {2} / \ d {4}) $ # 33
 51 payee 3 /[^::+:(.*)$/ "33 </pre><br><br>  The number before the regexp means the line number of the letter.  We go through the letter again and get the data we need. <br><br><h2>  Zest: Autodetect categories </h2><br>  So we got to the most interesting - our implementation of automatic comparison of categories of spending on the map. <br><br>  First, another example: <br><pre>  We inform you that on 07/21/2011 at 11:12:05 your bank card VTB24 ... 7780 made a payment transaction in the amount of 1959.00 RUR.
 Available for use: 2274.35 RUR.  Payment details: HITZONA.  Authorization code 222635 </pre><br><br>  And now look, in each payment we have a store code: <br><ul><li>  SHELL AZS OLGINO - Gasoline. </li><li>  HITZONA - entertainment (music, movies, games). </li></ul><br>  That is, it is enough for us to compare store codes to our categories.  But where to get this data?  <b>Crowdsourcing</b> comes to the rescue. <br><br>  Each Zen-mani user contributes to the common cause by comparing a payment on a card of one of the categories.  And we get something like this (users themselves enter the category names). <br><pre>  10 SHELL AZS Petrol
 3 SHELL AZS Cars
 1 SHELL AZS Sweets </pre><br><br>  When a user receives a notification about a payment in SHELL AZS, we look for the intersection of the base with its categories and select the most popular one.  There is a category ‚ÄúGasoline‚Äù - choose it, if not choose ‚ÄúCars‚Äù. <br><br>  In other words, we in Zen-mani are doing everything to facilitate your home accounting.  Today, it is receiving data from six banks: Alfa-Bank, Raiffeisenbank, VTB24, Citibank, Bank Saint Petersburg, Bank24.ru and Yandex.Money systems. <br><br>  <a href="https://zenmoney.ru/%3Fp%3Dhabr">Try it today :)</a> </div><p>Source: <a href="https://habr.com/ru/post/125397/">https://habr.com/ru/post/125397/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125383/index.html">Biglion and apartment with 90% discount</a></li>
<li><a href="../125384/index.html">Adobe Edge: HTML5 / JavaScript Animation Editor</a></li>
<li><a href="../125394/index.html">On high</a></li>
<li><a href="../125395/index.html">Salaries and cost of living in Silicon Valley</a></li>
<li><a href="../125396/index.html">CSS hacks</a></li>
<li><a href="../125398/index.html">OpenCL: universality and high performance or is it not so simple?</a></li>
<li><a href="../125399/index.html">Museum of video cards. Mindfulness first</a></li>
<li><a href="../125400/index.html">Seismic monitoring systems: overview, installation, configuration</a></li>
<li><a href="../125401/index.html">What to do with the huge old topics on the forums?</a></li>
<li><a href="../125402/index.html">ASUS Pro P31 / 41: Everest Testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>