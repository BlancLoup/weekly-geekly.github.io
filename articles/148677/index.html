<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Record video from Mac OS X screen with open-source tools</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes you need to record a demo of the program, but there are no suitable tools at hand. Moreover, free utilities for these purposes are not found...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Record video from Mac OS X screen with open-source tools</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/f98/ac0/382/f98ac0382f30da6a367ec80f6abc1203.jpg" align="right">  Sometimes you need to record a demo of the program, but there are no suitable tools at hand.  <s>Moreover, free utilities for these purposes are not found at all, and the paid ones are not the fact that they will cope as they should.</s>  As they corrected me in comments, the regular version of QuickTime Player writes great videos.  Further it is recommended to read only to fans of open-source and unusual solutions. <br>  In my case, it became necessary to record the work of the game on the iPhone and Android simulator.  The programmer inside me immediately offered to write a bunch of code, both for iOS / Android, and for Mac himself, dump the frames via OpenGL, etc. Having stopped these urges, I decided to find ready-made solutions and then issue an article here as a reminder. <br><br><a name="habracut"></a><br><h2>  Prelude </h2><br>  Searching the forums has shown that people with similar tasks fall into two categories: those who buy specialized programs with the ability to capture (QuickTime Pro, etc.) and those who use hacked / trial / beta versions of the same programs.  Having dug a little deeper, I learned that in the Linux / Unix world there is no such problem at all since the addition of the x11grab module to ffmpeg.  This module intercepts the buffer of X applications and then through ffmpeg the video is compressed into an intermediate format (qtrle, raw, x264 lossless, etc.).  The Mac also has an X server, but only programs that are ported from Linux, but not adapted for Cocoa, are displayed through it.  This was the starting point of my experiments. <br><br><h2>  Tools: ffmpeg + x11grab + Xvfb </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/e7b/b94/dc8/e7bb94dc8762e0a0a5c0e6d8b6695b00.png" alt="image" align="right"><br>  In MacPorts, in ffmpeg, the x11grab module is basically missing.  It didn't work out from the first time to collect it entirely from the source, so I decided to patch the port file for ffmpeg-devel: <br> <code>/opt/local/var/macports/sources/rsync.macports.org/release/tarballs/ports/multimedia/ffmpeg-devel/Portfile</code> <br>  I added the --enable-x11grab and --enable-shared lines to the nonfree configuration to activate x11grab. <br>  Looking ahead to say that there was a flaw in this method, because I do not post the corrected Portfile, but describe it here for reference only. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When the X program is displayed in the session (display): 0.0 by default, video recording gives a small frame rate, mainly due to the screen size (2560x1440 from the iMac), and most likely also because of the graphics rendering, so I decided to redirect programs in a virtual display with a low resolution.  This is done through the <a href="http://en.wikipedia.org/wiki/Xvfb">Xvfb</a> project, which was installed from the ports without any problems. <br>  It runs quite simply through the terminal (size with a margin): <br> <code>Xvfb :1 -screen 0 1024x800x15 -shmem</code> <br> <br>  It also just connects to this virtual ffmpeg display: <br> <code>ffmpeg -r 30 -s 1024x768 -f x11grab -i :1.0+0,20 -vcodec qtrle target.mov</code> <br> <br>  At this stage, I was waiting for an error with the Shared Memory overflow, which for some reason in OS X is set to indecent value in 4mb.  A temporary increase in its size is described in Apple‚Äôs recommendations for <a href="http://support.apple.com/kb/HT4022">servers</a> and <a href="http://www.caktusgroup.com/blog/2009/08/13/setting-postgresqls-shmmax-in-mac-os-x-105-leopard/">other sources</a> : <br> <code>sudo sysctl -w kern.sysv.shmmax=67108864 <br> sudo sysctl -w kern.sysv.shmall=67108864</code> <br> <br><h2>  Record VirtualBox Session </h2><br>  The next step I decided to display something useful through the X server.  The first thought was to collect the X version of VirtualBox, and already there in the virtual machine to show literally anything, but VirtualBox for Macs had long ago migrated to Cocoa, because it was a dead end.  The second sound idea was to connect via RDP to a virtual machine and record the rdesktop session, since it works under X. Activating RDP under VirtualBox is quite simple, but it requires installing the Extension Pack from the official <a href="https://www.virtualbox.org/wiki/Downloads">site</a> . <br>  Connection rdesktop with output through the screen: 0.1 <br> <code>DISPLAY=:1.0 rdesktop -xl localhost</code> <br> <br>  After these actions, ffmpeg starts writing a video to the .mov file quite successfully.  In my case, this was a handy Android x86: <br><img src="https://habrastorage.org/storage2/cd7/0c0/ada/cd70c0ada40b0fc7a7d17fd0dffe1888.jpg"><br><br>  Unfortunately, the video is quite jerky, it affects the compression rdp, because the animation is not so good to shoot. <br><br>  The next step I decided to move from RDP to VNC.  VirtualBox has a VNC server built in, but not in public builds, but in collected from ports or sources.  I didn‚Äôt have to do any port manipulations, after assembling the virtualbox port, I got version 4.1.14, which is quite possible to work with. <br><div style="text-align:center;"><img src="https://habrastorage.org/storage2/08f/d79/f4c/08fd79f4cb0d13058176dd77100c9019.png"></div><br>  The unpleasant moment was only that VNC is not accessible through the interface, but only when launched in headless mode: <br> <code>VBoxHeadless -startvm 'Android x86' -v on --vnc</code> <br>  This mode has to be managed either through the second VNC session or again via RDP, which is not very convenient, but generally tolerable.  To capture the VNC stream, vncviewer was used, redirected to the virtual X display: <br> <code>vncviewer localhost -ViewOnly -display :1.0 -PreferredEncoding raw -FullColor</code> <br> <br>  The result of all these delights was a 5-minute video with an honest 30 fps at a resolution of 1024x768: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/gqa-eVJdx7Y%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhhSV6pg6wqjrakMj5ld8JEZyzl0CQ" frameborder="0" allowfullscreen=""></iframe><br>  (I apologize in advance for the quality of the content, I'm still not a professional player) <br><br>  If you look closely, there are sometimes pauses for a few seconds.  Unfortunately, this problem did not manage to be won, and the approach itself came out rather cumbersome.  For the simplest demonstration of the game in Android, this is generally sufficient, so I switched to the next task - shooting a video of the iPhone simulator. <br><br><h2>  Capture VNC for the entire screen </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/fda/702/bdf/fda702bdfea2f354085959e4f649fae1.png" alt="image" align="right"><br>  OS X has built-in remote access that works simultaneously under two protocols, ARD and VNC.  Before the release of Lion 10.7, it was possible to turn on Screen Sharing in the system settings and connect to the current session with any VNC client.  Starting from 10.7, serious changes began: all types of compression were thrown out, except for ZRLE, not all clients can connect, and after connecting we see a gray login screen, and only after entering the user's password we connect to the session.  This is great for administrators, but for my task, on the contrary, it created only obstacles.  The vncviewer program (also known as RealVNC) in the latest versions already knows how to connect to OS X, but does not know how to enter a user password, because this way also turned out to be a dead end. <br>  As an alternative, I took the free VNC server from TestPlant (from the same osxvnc and also Vine).  Version 3.0 with sourceforge is outdated, so you need to build a new one from source or take it from the <a href="http://www.testplant.com/support/downloads/vine/">TestPlant</a> website <br><br>  An unimportant bug of this server is that occasionally the client disappears with the error "unknown message type 131".  It is treated by restarting the server. <br><br>  With the already well-established bundle of ffmpeg + x11grab + Xvfb and vncviewer, it turned out to shoot the full-screen video of the current OS X session, where the iPhone simulator was launched: <br><img src="https://habrastorage.org/storage2/688/c0a/f55/688c0af55fac3fca0929ba379c5b3573.png"><br><br>  The size of the virtual buffer, I obviously chose a smaller screen resolution to remove the upper left corner.  The result came out quite decent, but unfortunately, with low FPS - the animation in the game frankly braked.  Moreover, the pauses, which were quite rare with the schema from VirtualBox, became much more pronounced. <br>  At this stage, I conducted several experiments, reassembled the VNC server and client from source, put the minimum screen resolution, but did not achieve a good result.  After a few hours, it became clear that the server itself gives frames with some delay.  After digging into the code, it turned out that the server intentionally pauses between screen updates: <br><pre> <code class="hljs php"> <span class="hljs-comment"><span class="hljs-comment">/* OK, now, to save bandwidth, wait a little while for more updates to come along. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* REDSTONE - Lets send it right away if no rfbDeferUpdateTime */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rfbDeferUpdateTime &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; !cl-&gt;immediateUpdate &amp;&amp; !cl-&gt;needNewScreenSize) { pthread_mutex_unlock(&amp;cl-&gt;updateMutex); usleep(rfbDeferUpdateTime * <span class="hljs-number"><span class="hljs-number">1000</span></span>); pthread_mutex_lock(&amp;cl-&gt;updateMutex); }</code> </pre><br>  It turned out that the rfbDeferUpdateTime variable has an initial value of 40 ms, but it is completely controllable and is set via the command line.  In the Vine Server itself there is a separate field for this: <br><img src="https://habrastorage.org/storage2/9ad/de5/36f/9adde536faafff61cce2f41e5fa3aa0e.png"><br>  I set the value with a margin of 15, which gives a maximum frame rate of 66 fps.  After that, the lags stopped, but there were still noticeable pauses in the video.  Theoretically, from such a video sequence they can be cut and collected something acceptable, but I wanted a more universal solution. <br><br><h2>  Ace up your sleeve: vnc2flv </h2><br>  Now I had a video stream in vnc format of excellent quality, it only remained to write it to a file.  I again suppressed the primordially programmer desire to write my own dumper and found the project <a href="http://www.unixuser.org/~euske/vnc2swf/">vnc2swf</a> , and then its successor <a href="http://www.unixuser.org/~euske/python/vnc2flv/index.html">vnc2flv,</a> in the depths of the Internet.  Skeptical grabber on Python passed immediately after the first results - the program records video stream in lossless quality and WQHD resolution with 15+ fps!  I <s>run</s> it without <s>perversions with</s> Xvfb, directly connecting to the VNC server: <br> <code>flvrec.py -r 30 127.0.0.1</code> <br> <br>  To increase fps, it is enough to reduce the resolution to 1280x720.  What's interesting is that you can restart Vine VNC, it will pick up the current screen resolution, and then you can safely switch to the native resolution and start recording. <br>  The installation of vnc2flv is very simple and is described on the website, there are no special pitfalls here. <br>  The finished video can be processed in your favorite video editor, cut off the excess and convert it to the desired format.  I use VirtualDub running under wine, but this is a matter of habit. <br> <a href=""><img src="https://habrastorage.org/storage2/d81/19c/df2/d8119cdf2faf5bbca0c5e205d4b8ffce.jpg"></a> <br><br>  Here is the result of this whole epic: <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/qxUGI7dIo0s%3Ffeature%3Doembed&amp;xid=17259,15700002,15700021,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhiwKinxV1f0Q9ziLDLkjq1p3-dtAA" frameborder="0" allowfullscreen=""></iframe><br>  The video is quite clear, without jerks and lags.  Animation is recorded normally.  As for me, it is quite possible to use to write literally anything from the Mac OS screen.  There is literally just a cursor missing, but this can be experienced as it is. <br><br><h2>  Afterword: dead-end branches </h2><br>  I will list here the dead ends and rakes that I met, in case someone will look for their own method. <br><br>  <a href="http://www.videolan.org/vlc/">VLC Player</a> - since OS X 10.7 can not record video from the screen <br>  <a href="http://www.chimoosoft.com/products/captureme/">CaptureMe</a> - crashes, writes blank video <br>  <a href="http://thinkultimate.com/2009/10/iphone-screen-capture/">SIMBL plugin</a> for iPhone Simulator - requires modifying the version of the simulator in the code and rebuilding, does not write iPad video, in general did not work for me at all <br>  <a href="http://sourceforge.net/projects/osxvnc/">osxvnc 3.0</a> c SourceForge - crash on 10.7 <br>  <a href="http://www.realvnc.com/products/vnc/">RealVNC Server</a> - requires a license key <br>  <a href="https://forums.virtualbox.org/viewtopic.php%3Ff%3D5%26t%3D18895">VirtualBox, video recording mode</a> - died 3 years ago, not supported and not working <br>  <a href="http://www.jedi.be/blog/2010/08/30/capturing-the-screen-of-your-virtual-machines-using-x-vnc-rdp-or-native/">ffmpeg + x11grab</a> is perspective and flexible, but it gives incurable pauses in the video.  I cite a link to the blog, from which I underlined this idea. <br>  <a href="http-streaming/">Apple HTTP Live Streaming</a> - does not contain streaming tools </div><p>Source: <a href="https://habr.com/ru/post/148677/">https://habr.com/ru/post/148677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148670/index.html">Ideal document repository</a></li>
<li><a href="../148672/index.html">edX this fall: MITx / HarvardX / BerkeleyX</a></li>
<li><a href="../148673/index.html">Labels are not going to share with the authors of prey after the trial of The Pirate Bay</a></li>
<li><a href="../148675/index.html">Freelance as a means of earning. Part 2 Getting Started</a></li>
<li><a href="../148676/index.html">Future with AR</a></li>
<li><a href="../148678/index.html">Overview of the laboratory power supply Mastech 3003D</a></li>
<li><a href="../148683/index.html">Ninja Tel - amateur wireless telephone network on Defcon</a></li>
<li><a href="../148684/index.html">Bitly announced Realtime search service.</a></li>
<li><a href="../148685/index.html">Apple buys AuthenTec</a></li>
<li><a href="../148686/index.html">In the beginning was the Word</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>