<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Targeting users: region, city, street</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes in my projects I wanted to fasten a certain geographic base, with the help of which I would divide the users of the resource according to th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Targeting users: region, city, street</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a53/796/7fc/a537967fc8810a469e9094743b54d52e.png" align="left">  Sometimes in my projects I wanted to fasten a certain geographic base, with the help of which I would divide the users of the resource according to their place of stay.  But constant employment with vital matters in no way allowed the idea to be implemented with a base of regions and a little bit convenient interface for its visualization. <br>  By the will of fate and the customer (or the fate of the customer or the customer of fate) such a task finally arose - it is necessary to create a base of regions, cities and streets for user segmentation and implement a convenient web form, in fact, for its use.  Fortunately, the customer focused his business on Russia, which dramatically simplified the task. <br><br><a name="habracut"></a><br><br>  The search on the Internet for ready-made databases of subjects of the Russian Federation did not bring any special results - I found the KLADR database, but it turned out to be not very relevant.  Having rummaged further, I stumbled upon the post <a href="http://habrahabr.ru/post/140378/">KLADR died, long live the FIAS?</a>  .  Thanks <a href="http://habrahabr.ru/users/sergpenza/" class="user_link">sergpenza</a> , now there is much to dig! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The FIAS base really turned out to be as complete and relevant as possible, and even too much - there is a lot of unnecessary in it.  Another disadvantage of the base is that it is ‚Äúflat‚Äù: the main tablet is ADDROBJ.dbf, it contains areas, districts, cities and streets, and all this refers to itself.  Another disadvantage is that there is no list of regions of the Russian Federation.  But it is simple - they can easily be parsed from the site of the GNIVTS FTS RUSSIA. <br><br>  I will not go into the process of sawing the base into a relational view - this is a routine, and the link to the ready base is at the bottom of my post. <br><br>  Excellent base there.  It is necessary to create an interface for its visualization under the web, I will dwell on this part in more detail. <br>  The interface includes front and back-end. <br><br><ol><li>  Front end is html, js, jQuery </li><li>  MS's MVC back-end (c #) </li></ol><br><br><h3>  Front end </h3><br>  Task: the user must be able to fill in data about his place of stay, for this he consistently enters the region, city and street. <br>  Given the number of cities (more than 160k) and the number of streets in each city, the task becomes more complicated - there is no drop-down list use, some quick search and filtering mechanism must be provided.  Of course, the mechanism should be universal and cover not only the region, but also cities with streets. <br>  This mechanism is best implemented in the form of a library that is connected in the right places on the site.  Let's call the library jquery.locateme.js.  By the name of the library it is clear that it is dependent on jQuery.  Initially, I had the idea to write a plugin for jQuery in accordance with the ideology of the framework, but in the end I refused it. <br><br>  The library should have the following functions: <br><ul><li>  search in all database objects (regions, cities, streets) </li><li>  displaying search results (both list and autocomplete) </li><li>  keyboard control (navigation through search results) </li><li>  handling various callbacks to scale the functionality </li></ul><br><div class="spoiler">  <b class="spoiler_title">Implementation (skeleton)</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> locateMe = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">wrapperName, fieldName, fieldLabel, url, urlData, applyHandler, cancelHandler</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _this = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, _urlData = urlData; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isApplied = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputLabel = $(<span class="hljs-string"><span class="hljs-string">"&lt;span&gt;"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"label"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, fieldName + <span class="hljs-string"><span class="hljs-string">"_label"</span></span>).html(fieldLabel); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput = $(<span class="hljs-string"><span class="hljs-string">"&lt;input/&gt;"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"input_search"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, fieldName).attr(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputTip = $(<span class="hljs-string"><span class="hljs-string">"&lt;input/&gt;"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"input_search_tip"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, fieldName + <span class="hljs-string"><span class="hljs-string">"_tip"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"text"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResultsTipId = $(<span class="hljs-string"><span class="hljs-string">"&lt;input/&gt;"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, fieldName + <span class="hljs-string"><span class="hljs-string">"_tip_id"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"type"</span></span>, <span class="hljs-string"><span class="hljs-string">"hidden"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResults = $(<span class="hljs-string"><span class="hljs-string">"&lt;div&gt;"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"results"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>, fieldName + <span class="hljs-string"><span class="hljs-string">"_results"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchUrl = url; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; };</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Public functions</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Reload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">reloadValues</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reloadValues) { _this.SearchInput.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); _this.SearchInputTip.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); _this.SearchResultsTipId.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); _this.SearchResults.hide().empty(); } _methods.setResultsPosition(); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Dispose = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isApplied = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputLabel.remove(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput.unbind().remove(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputTip.remove(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResultsTipId.remove(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResults.unbind().remove(); _this = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Disable = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">setDisabled</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (setDisabled) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput.val(<span class="hljs-string"><span class="hljs-string">""</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"disabled"</span></span>, <span class="hljs-string"><span class="hljs-string">"disabled"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputTip.val(<span class="hljs-string"><span class="hljs-string">""</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"disabled"</span></span>, <span class="hljs-string"><span class="hljs-string">"disabled"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResultsTipId.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResults.empty().hide(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput.removeAttr(<span class="hljs-string"><span class="hljs-string">"disabled"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputTip.removeAttr(<span class="hljs-string"><span class="hljs-string">"disabled"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.AjaxRequestParameters = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ _urlData = data; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _urlData; }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DefaultValue = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, val</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResultsTipId.val(id); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput.val(val); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Value = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">k</span></span>: _this.SearchResultsTipId.val(), <span class="hljs-attr"><span class="hljs-attr">v</span></span>: _this.SearchInput.val() }; };</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Designer control and internal functions</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _methods = { <span class="hljs-attr"><span class="hljs-attr">setResultsPosition</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inputOffset = _this.SearchInput.offset(), inputSize = _methods.objectWH(_this.SearchInput); _this.SearchResults .css(<span class="hljs-string"><span class="hljs-string">"left"</span></span>, inputOffset.left) .css(<span class="hljs-string"><span class="hljs-string">"top"</span></span>, inputOffset.top + inputSize.height - <span class="hljs-number"><span class="hljs-number">2</span></span>) .css(<span class="hljs-string"><span class="hljs-string">"width"</span></span>, inputSize.width - <span class="hljs-number"><span class="hljs-number">2</span></span>); }, <span class="hljs-attr"><span class="hljs-attr">retrieveResults</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">query</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (query &amp;&amp; query.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _data = {}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_urlData &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (_urlData) === <span class="hljs-string"><span class="hljs-string">"object"</span></span>) { _data = _urlData, _data.searchquery = query; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _data = { <span class="hljs-attr"><span class="hljs-attr">searchquery</span></span>: query }; $.ajax({ <span class="hljs-attr"><span class="hljs-attr">async</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">url</span></span>: _this.SearchUrl, <span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-attr"><span class="hljs-attr">data</span></span>: _data, <span class="hljs-attr"><span class="hljs-attr">success</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function">) </span></span>{ _methods.fillResults(response); } }); } }, <span class="hljs-attr"><span class="hljs-attr">fillResults</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">arr</span></span></span><span class="hljs-function">) </span></span>{ _this.SearchResults.empty().hide(); _this.SearchInputTip.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arr &amp;&amp; arr.length &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) { $(arr).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, o</span></span></span><span class="hljs-function">) </span></span>{ _this.SearchResults.append(<span class="hljs-string"><span class="hljs-string">"&lt;div class=\"row\" id=\""</span></span> + ok + <span class="hljs-string"><span class="hljs-string">"\"&gt;"</span></span> + ov + <span class="hljs-string"><span class="hljs-string">"&lt;/div&gt;"</span></span>); }); _this.SearchResults .find(<span class="hljs-string"><span class="hljs-string">"div"</span></span>) .unbind() .click(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ $(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"selected"</span></span>); _methods.resultsApply(); }).end() .css(<span class="hljs-string"><span class="hljs-string">"height"</span></span>, arr.length * <span class="hljs-number"><span class="hljs-number">19</span></span>).show(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arr &amp;&amp; arr.length == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> searchInputValue = _this.SearchInput.val().length, arrayValue = arr[<span class="hljs-number"><span class="hljs-number">0</span></span>].v, arrayKey = arr[<span class="hljs-number"><span class="hljs-number">0</span></span>].k, tip = _this.SearchInput.val() + arrayValue.substring(searchInputValue, arrayValue.length); _this.SearchResultsTipId.val(arrayKey); _this.SearchInputTip.val(tip); } }, <span class="hljs-attr"><span class="hljs-attr">resultsMove</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">direction</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentPosition = <span class="hljs-number"><span class="hljs-number">-1</span></span>, resultsCount = _this.SearchResults.find(<span class="hljs-string"><span class="hljs-string">".row"</span></span>).length - <span class="hljs-number"><span class="hljs-number">1</span></span>; $(_this.SearchResults.children()).each(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i, o</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($(o).hasClass(<span class="hljs-string"><span class="hljs-string">"selected"</span></span>)) { currentPosition = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (direction == <span class="hljs-string"><span class="hljs-string">"up"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentPosition &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { currentPosition--; _this.SearchResults .find(<span class="hljs-string"><span class="hljs-string">"div.selected"</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"selected"</span></span>).end() .find(<span class="hljs-string"><span class="hljs-string">"div:eq("</span></span> + currentPosition + <span class="hljs-string"><span class="hljs-string">")"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"selected"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentPosition &lt; resultsCount) { currentPosition++; _this.SearchResults .find(<span class="hljs-string"><span class="hljs-string">"div.selected"</span></span>).removeClass(<span class="hljs-string"><span class="hljs-string">"selected"</span></span>).end() .find(<span class="hljs-string"><span class="hljs-string">"div:eq("</span></span> + currentPosition + <span class="hljs-string"><span class="hljs-string">")"</span></span>).addClass(<span class="hljs-string"><span class="hljs-string">"selected"</span></span>); } } }, <span class="hljs-attr"><span class="hljs-attr">resultsApply</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> selectedId = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_this.SearchResultsTipId.val() != <span class="hljs-string"><span class="hljs-string">""</span></span> || _this.SearchResults.find(<span class="hljs-string"><span class="hljs-string">"div"</span></span>).length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_this.SearchResults.is(<span class="hljs-string"><span class="hljs-string">":visible"</span></span>)) { selectedId = _this.SearchResults.find(<span class="hljs-string"><span class="hljs-string">".selected"</span></span>).attr(<span class="hljs-string"><span class="hljs-string">"id"</span></span>); _this.SearchInput.val(_this.SearchResults.find(<span class="hljs-string"><span class="hljs-string">".selected"</span></span>).html()); _this.SearchInputTip.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); _this.SearchResultsTipId.val(selectedId); _this.SearchResults.empty().hide(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { selectedId = _this.SearchResultsTipId.val(); _this.SearchInput.val(_this.SearchInputTip.val()); _this.SearchInputTip.val(<span class="hljs-string"><span class="hljs-string">""</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_this.isApplied) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (applyHandler &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> (applyHandler) === <span class="hljs-string"><span class="hljs-string">"function"</span></span>) { applyHandler(selectedId); } _this.isApplied = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> selectedId; }, <span class="hljs-attr"><span class="hljs-attr">objectWH</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">obj</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> r = { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">height</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"height"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"padding-top"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"padding-bottom"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"margin-top"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"margin-bottom"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"border-top-width"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.height += obj.css(<span class="hljs-string"><span class="hljs-string">"border-bottom-width"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"width"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"padding-left"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"padding-right"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"margin-left"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"margin-right"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"border-left-width"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; r.width += obj.css(<span class="hljs-string"><span class="hljs-string">"border-right-width"</span></span>).replace(<span class="hljs-string"><span class="hljs-string">"px"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) * <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r; } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> target = $(<span class="hljs-string"><span class="hljs-string">"."</span></span> + wrapperName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (target.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { target .append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputLabel) .append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput) .append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInputTip) .append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResultsTipId) .append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchResults); $(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>) .resize(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ _methods.setResultsPosition(); }) .trigger(<span class="hljs-string"><span class="hljs-string">"resize"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SearchInput .keydown(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val = _this.SearchInput.val(), valLength = val.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.which &gt; <span class="hljs-number"><span class="hljs-number">32</span></span> &amp;&amp; e.which != <span class="hljs-number"><span class="hljs-number">40</span></span> &amp;&amp; e.which != <span class="hljs-number"><span class="hljs-number">38</span></span> &amp;&amp; e.which != <span class="hljs-number"><span class="hljs-number">9</span></span> &amp;&amp; e.which != <span class="hljs-number"><span class="hljs-number">39</span></span> &amp;&amp; e.which != <span class="hljs-number"><span class="hljs-number">46</span></span> &amp;&amp; e.which != <span class="hljs-number"><span class="hljs-number">13</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.which == <span class="hljs-number"><span class="hljs-number">8</span></span> || <span class="hljs-comment"><span class="hljs-comment">// [Backspace] e.which == 46) { // [DELETE] if ((valLength - 1) &gt; 0) { _methods.retrieveResults(val.substring(0, valLength - 1)); } if (_this.isApplied) { _this.isApplied = false; _this.SearchResultsTipId.val(""); if (cancelHandler &amp;&amp; typeof (cancelHandler) === "function") { cancelHandler(); } } } else if (e.which == 40) { //‚ñº _methods.resultsMove("down"); } else if (e.which == 38) { //‚ñ≤ _methods.resultsMove("up"); } else if (e.which == 39) { //‚Üí _methods.resultsApply(); } else if (e.which == 9) { //TAB _methods.resultsApply(); return false; } else if (e.which == 13) { //ENTER _methods.resultsApply(); } }) .keypress(function (e) { var text = _this.SearchInput.val(), pressedChar = String.fromCharCode(e.which || e.keyCode), query = text + pressedChar; _methods.retrieveResults(query); }); }</span></span></code> </pre><br></div></div><br><br>  Use control on the page should be so <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> region = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> locateMe(<span class="hljs-string"><span class="hljs-string">"field_wrapper"</span></span>, <span class="hljs-string"><span class="hljs-string">"field_name"</span></span>, <span class="hljs-string"><span class="hljs-string">"field_label"</span></span>, <span class="hljs-string"><span class="hljs-string">"search_URL"</span></span>, search_URL_DATA, applyHandler, cancelHandler);</code> </pre><br>  <i>field_wrapper</i> - class selector, shell in which control will be created <br>  <i>field_name</i> - control field name <br>  <i>field_label</i> is what will be written above the search field <br>  <i>search_URL</i> - the URL that will be requested for the search (POST method) <br>  [search_URL_DATA] - optional parameters passed to search_URL (object) <br>  [applyHandler] - the function will be called after the search is completed in the field <br>  [cancelHandler] - function, called when the field is changed (if, of course, the search was completed) <br><br>  Example: <br><pre> <code class="hljs actionscript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> region = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> locateMe(<span class="hljs-string"><span class="hljs-string">"uloc_region"</span></span>, <span class="hljs-string"><span class="hljs-string">"region"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"/region"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(selectedId)</span></span></span></span>{ alert(<span class="hljs-string"><span class="hljs-string">" ID:"</span></span> + selectedId); });</code> </pre><br>  The example creates a field called "region" in the div ".uloc_region".  For the search, the url "/ region" with no parameters will be requested, and after finding the desired region, an alert will appear with the text "region ID:% regionID%". <br><br><h3>  Back end </h3><br>  Task: implement a selection from the database of fields that satisfy the user's search query for any database objects (region, city or street) <br>  The typical behavior of a user who wants to find his city is to start typing his name in the text field, at this moment the front-end control starts to work, offering auto-completion as you type a search query. <br><br>  The solution architecture (solution, .sln) consists of 4 libraries: <br><br><ul><li>  BO (BusinesObjects) </li><li>  DC (DataContext) </li><li>  DP (DataProvider) </li><li>  LocateMe (UI, web interface) </li></ul><br><br>  It does not make sense to describe BO, DC, DP, as they are typical (linq, DTO, database context).  Link to the archive with the whole solution (solution) at the end of the post. <br>  As for the UI, it can be considered in general terms.  Namely search method signatures <br><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">HttpPost</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Region</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> searchquery</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Database.SearchRegions(searchquery, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { k = i.Id, v = i.Region }); } [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">City</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> regionId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> searchquery</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Database.SearchCities(regionId, searchquery, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { k = i.Id, v = i.City }); } [HttpPost] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> JsonResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Street</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cityId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> searchquery</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Json(<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Database.SearchStreets(cityId, searchquery, <span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { k = i.Id, v = i.Street }); }</code> </pre><br><br>  It's simple: 3 methods for three database objects.  Each accepts a searchquery string, which is a user's search query.  In the last two methods, there is another parameter RegionId and CityId - they indicate in which region (or city) to search.  Search results are limited to 5 entries.  An anonymous type serialized into JSON is used as the returned object, where v is the name of the region \ city <br>  or the streets, and k is their identifiers. <br><br>  Demo <a href="http://185.49.147.111/">right here</a> <br><br>  Project (in full) <a href="https://github.com/letmefree/jqLocateme">here</a> (github) <br>  Base (dump) <a href="https://github.com/letmefree/jqLocateme/tree/master/database">in the same place</a> <br><br><div class="spoiler">  <b class="spoiler_title">Links, descriptions, instructions</b> <div class="spoiler_text">  As a database server - MS SQL 2012 <br>  The relevance of the database in 2014, I quarter.  New regions of Crimea and Sevastopol, as well as the territory of Baikonur are present <br>  Back-end .Net 4.0, mvc 3 <br><br>  Base file (mdf, log) <a href="">tyk</a> (github will not commit, probably the size is large) <br></div></div><br><br><h5>  UPD </h5>  Thank you <a href="http://habrahabr.ru/users/winddrop/" class="user_link">WindDrop</a> , <a href="http://habrahabr.ru/users/andriyan/" class="user_link">Andriyan</a> <br>  Fixed \ added: <br>  1. Repeatedly pressing [ENTER], [TAB] or [RIGHT ARROW] after manual input or auto-complete. <br>  2. Autocomplete case sensitive <br>  3. Displaying the search results window with an empty field. <br>  4. Arbitrary filling of the field region ("Republic of Bashko ..." or "Bashko ....") will have the same result (without changing the database) <br><br>  Not fixed: <br>  Unclear library behavior (keystrokes) in FF <br><br></div><p>Source: <a href="https://habr.com/ru/post/221989/">https://habr.com/ru/post/221989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221975/index.html">My story Imagine cup, or how Microsoft makes life brighter</a></li>
<li><a href="../221977/index.html">Robotic snake to help people</a></li>
<li><a href="../221979/index.html">Synchronize MySQL + Git structure</a></li>
<li><a href="../221983/index.html">US Robotics Pilot 5000 - the first successful PDA. Internals, modem, use with modern OS</a></li>
<li><a href="../221987/index.html">Universal powerful PC the size of a smartphone: Tango PC</a></li>
<li><a href="../221991/index.html">Hacker Battles: Parsing PHDays CTF and CTF Quals</a></li>
<li><a href="../221997/index.html">Introduction to programming the DECT module SC14CVMDECT</a></li>
<li><a href="../221999/index.html">Conflicts when merging csproj files</a></li>
<li><a href="../222001/index.html">IconBIT Toucan Stick 4K Review: Top HDMI Stick on AllWinner A31</a></li>
<li><a href="../222005/index.html">Each environment has its own favicon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>