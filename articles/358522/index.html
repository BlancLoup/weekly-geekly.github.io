<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Go: we accelerate sampling of large tables from MySQL</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I have been using Go to write an ad network for almost a year now. I am developing on the server Intel i7-7700, 16Gb RAM, 256Gb SSD. And in the script...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Go: we accelerate sampling of large tables from MySQL</h1><div class="post__text post__text-html js-mediator-article">  I have been using Go to write an ad network for almost a year now.  I am developing on the server Intel i7-7700, 16Gb RAM, 256Gb SSD.  And in the script that runs once a day, the task appeared to select all the shows for the past day and recalculate on this basis the statistics for the day for several objects at once (website, campaign, banner). <br><br>  On Go idioms, everything is done quite trivially: <br><a name="habracut"></a><br><pre><code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Hit <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { siteID, zoneID, poolID, mediaID, campaignID <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span> } rows, err := db.Query(<span class="hljs-string"><span class="hljs-string">"SELECT siteID, zoneID, poolID, mediaID, campaignID FROM "</span></span>+where) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(<span class="hljs-string"><span class="hljs-string">"Query fail"</span></span>, err) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( c <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span> h Hit ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() { rows.Scan(&amp;h.siteID, &amp;h.zoneID, &amp;h.poolID, &amp;h.mediaID, &amp;h.campaignID) campCounter.Inc(h.campaignID) siteCounter.Inc(h.siteID) zoneCounter.Inc(h.zoneID) poolCounter.Inc(h.poolID) mediaCounter.Inc(h.mediaID) c++ } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Err(); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(<span class="hljs-string"><span class="hljs-string">"Scan Rows err"</span></span>, err) } log.Println(name, <span class="hljs-string"><span class="hljs-string">" "</span></span>, c, <span class="hljs-string"><span class="hljs-string">" "</span></span>, where, <span class="hljs-string"><span class="hljs-string">"in"</span></span>, time.Since(now))</code> </pre> <br>  Everything is working.  And the sample rate is 36 seconds for almost 56 million records. <br><br><pre> <code class="hljs pgsql">hit_20180507 <span class="hljs-number"><span class="hljs-number">55928930</span></span> <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BETWEEN</span></span> <span class="hljs-number"><span class="hljs-number">1525640400</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1525726799</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">36.331342451</span></span>s</code> </pre> <br>  Under the hood of the <b>go tool pprof</b> performance analyzer we see something like the following 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs go"> flat flat% sum% cum cum% <span class="hljs-number"><span class="hljs-number">7130</span></span>ms <span class="hljs-number"><span class="hljs-number">18.32</span></span>% <span class="hljs-number"><span class="hljs-number">18.32</span></span>% <span class="hljs-number"><span class="hljs-number">10800</span></span>ms <span class="hljs-number"><span class="hljs-number">27.75</span></span>% runtime.mallocgc <span class="hljs-number"><span class="hljs-number">2380</span></span>ms <span class="hljs-number"><span class="hljs-number">6.12</span></span>% <span class="hljs-number"><span class="hljs-number">24.43</span></span>% <span class="hljs-number"><span class="hljs-number">5710</span></span>ms <span class="hljs-number"><span class="hljs-number">14.67</span></span>% fmt.(*pp).doPrintf <span class="hljs-number"><span class="hljs-number">2140</span></span>ms <span class="hljs-number"><span class="hljs-number">5.50</span></span>% <span class="hljs-number"><span class="hljs-number">29.93</span></span>% <span class="hljs-number"><span class="hljs-number">13300</span></span>ms <span class="hljs-number"><span class="hljs-number">34.17</span></span>% github.com/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-sql-driver/mysql.(*textRows).readRow <span class="hljs-number"><span class="hljs-number">1800</span></span>ms <span class="hljs-number"><span class="hljs-number">4.62</span></span>% <span class="hljs-number"><span class="hljs-number">34.56</span></span>% <span class="hljs-number"><span class="hljs-number">2170</span></span>ms <span class="hljs-number"><span class="hljs-number">5.58</span></span>% runtime.mapassign_fast32 <span class="hljs-number"><span class="hljs-number">1700</span></span>ms <span class="hljs-number"><span class="hljs-number">4.37</span></span>% <span class="hljs-number"><span class="hljs-number">38.93</span></span>% <span class="hljs-number"><span class="hljs-number">1700</span></span>ms <span class="hljs-number"><span class="hljs-number">4.37</span></span>% runtime.heapBitsSetType <span class="hljs-number"><span class="hljs-number">1170</span></span>ms <span class="hljs-number"><span class="hljs-number">3.01</span></span>% <span class="hljs-number"><span class="hljs-number">41.93</span></span>% <span class="hljs-number"><span class="hljs-number">36350</span></span>ms <span class="hljs-number"><span class="hljs-number">93.40</span></span>% main.loadHits <span class="hljs-number"><span class="hljs-number">1110</span></span>ms <span class="hljs-number"><span class="hljs-number">2.85</span></span>% <span class="hljs-number"><span class="hljs-number">44.78</span></span>% <span class="hljs-number"><span class="hljs-number">8500</span></span>ms <span class="hljs-number"><span class="hljs-number">21.84</span></span>% runtime.convT2Eslice <span class="hljs-number"><span class="hljs-number">1070</span></span>ms <span class="hljs-number"><span class="hljs-number">2.75</span></span>% <span class="hljs-number"><span class="hljs-number">47.53</span></span>% <span class="hljs-number"><span class="hljs-number">1970</span></span>ms <span class="hljs-number"><span class="hljs-number">5.06</span></span>% fmt.(*fmt).fmt_integer <span class="hljs-number"><span class="hljs-number">950</span></span>ms <span class="hljs-number"><span class="hljs-number">2.44</span></span>% <span class="hljs-number"><span class="hljs-number">49.97</span></span>% <span class="hljs-number"><span class="hljs-number">1380</span></span>ms <span class="hljs-number"><span class="hljs-number">3.55</span></span>% github.com/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-sql-driver/mysql.readLengthEncodedString <span class="hljs-number"><span class="hljs-number">930</span></span>ms <span class="hljs-number"><span class="hljs-number">2.39</span></span>% <span class="hljs-number"><span class="hljs-number">52.36</span></span>% <span class="hljs-number"><span class="hljs-number">1060</span></span>ms <span class="hljs-number"><span class="hljs-number">2.72</span></span>% runtime.freedefer <span class="hljs-number"><span class="hljs-number">930</span></span>ms <span class="hljs-number"><span class="hljs-number">2.39</span></span>% <span class="hljs-number"><span class="hljs-number">54.75</span></span>% <span class="hljs-number"><span class="hljs-number">930</span></span>ms <span class="hljs-number"><span class="hljs-number">2.39</span></span>% runtime.mapaccess1_fast32 <span class="hljs-number"><span class="hljs-number">910</span></span>ms <span class="hljs-number"><span class="hljs-number">2.34</span></span>% <span class="hljs-number"><span class="hljs-number">57.09</span></span>% <span class="hljs-number"><span class="hljs-number">2070</span></span>ms <span class="hljs-number"><span class="hljs-number">5.32</span></span>% runtime.deferreturn <span class="hljs-number"><span class="hljs-number">860</span></span>ms <span class="hljs-number"><span class="hljs-number">2.21</span></span>% <span class="hljs-number"><span class="hljs-number">59.30</span></span>% <span class="hljs-number"><span class="hljs-number">1220</span></span>ms <span class="hljs-number"><span class="hljs-number">3.13</span></span>% runtime.scanobject</code> </pre> <br>  You may notice that we are working in the MySQL text protocol using mysql. (* TextRows) .readRow, respectively, the incoming rows Scan converts to uin32 types.  But in the first place in time we have a memory allocation function. <br><br>  What can be accelerated? <br><br>  I accidentally caught the eye of the <a href="https://golang.org/pkg/database/sql/">RawBytes</a> type which guarantees that the bytes from the database driver will be transferred to the user without copying.  What.  We will try to extract Scan into an intermediate structure with sql.RawBytes fields and convert themselves then [] bytes to uint32 using the bu2 function that hastily written, discarding error checks (after all, you will not search for them in the text that came from the database, right?) <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b2u</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uint32</span></span></span></span> { n := <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, c := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> b { n = n*<span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>) + <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(c-<span class="hljs-string"><span class="hljs-string">'0'</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> HitRaw <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { siteID, zoneID, poolID, mediaID, campaignID sql.RawBytes }</code> </pre><br>  As a result, the processing time was reduced to 28 seconds, which makes reading 2 million lines per second already! <br><br>  And the profiler already gives this picture <br><br><pre> <code class="hljs go"> <span class="hljs-number"><span class="hljs-number">4690</span></span>ms <span class="hljs-number"><span class="hljs-number">15.68</span></span>% <span class="hljs-number"><span class="hljs-number">15.68</span></span>% <span class="hljs-number"><span class="hljs-number">7630</span></span>ms <span class="hljs-number"><span class="hljs-number">25.51</span></span>% runtime.mallocgc <span class="hljs-number"><span class="hljs-number">2400</span></span>ms <span class="hljs-number"><span class="hljs-number">8.02</span></span>% <span class="hljs-number"><span class="hljs-number">23.70</span></span>% <span class="hljs-number"><span class="hljs-number">2700</span></span>ms <span class="hljs-number"><span class="hljs-number">9.03</span></span>% runtime.mapaccess1_fast32 <span class="hljs-number"><span class="hljs-number">1660</span></span>ms <span class="hljs-number"><span class="hljs-number">5.55</span></span>% <span class="hljs-number"><span class="hljs-number">29.25</span></span>% <span class="hljs-number"><span class="hljs-number">1660</span></span>ms <span class="hljs-number"><span class="hljs-number">5.55</span></span>% runtime.heapBitsSetType <span class="hljs-number"><span class="hljs-number">1640</span></span>ms <span class="hljs-number"><span class="hljs-number">5.48</span></span>% <span class="hljs-number"><span class="hljs-number">34.74</span></span>% <span class="hljs-number"><span class="hljs-number">28110</span></span>ms <span class="hljs-number"><span class="hljs-number">93.98</span></span>% main.loadHits <span class="hljs-number"><span class="hljs-number">1590</span></span>ms <span class="hljs-number"><span class="hljs-number">5.32</span></span>% <span class="hljs-number"><span class="hljs-number">40.05</span></span>% <span class="hljs-number"><span class="hljs-number">1860</span></span>ms <span class="hljs-number"><span class="hljs-number">6.22</span></span>% runtime.mapassign_fast32 <span class="hljs-number"><span class="hljs-number">1300</span></span>ms <span class="hljs-number"><span class="hljs-number">4.35</span></span>% <span class="hljs-number"><span class="hljs-number">44.40</span></span>% <span class="hljs-number"><span class="hljs-number">12450</span></span>ms <span class="hljs-number"><span class="hljs-number">41.62</span></span>% github.com/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-sql-driver/mysql.(*textRows).readRow <span class="hljs-number"><span class="hljs-number">1140</span></span>ms <span class="hljs-number"><span class="hljs-number">3.81</span></span>% <span class="hljs-number"><span class="hljs-number">48.21</span></span>% <span class="hljs-number"><span class="hljs-number">2090</span></span>ms <span class="hljs-number"><span class="hljs-number">6.99</span></span>% runtime.deferreturn <span class="hljs-number"><span class="hljs-number">1060</span></span>ms <span class="hljs-number"><span class="hljs-number">3.54</span></span>% <span class="hljs-number"><span class="hljs-number">51.76</span></span>% <span class="hljs-number"><span class="hljs-number">1470</span></span>ms <span class="hljs-number"><span class="hljs-number">4.91</span></span>% github.com/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-sql-driver/mysql.readLengthEncodedString <span class="hljs-number"><span class="hljs-number">1050</span></span>ms <span class="hljs-number"><span class="hljs-number">3.51</span></span>% <span class="hljs-number"><span class="hljs-number">55.27</span></span>% <span class="hljs-number"><span class="hljs-number">1050</span></span>ms <span class="hljs-number"><span class="hljs-number">3.51</span></span>% main.b2u <span class="hljs-number"><span class="hljs-number">1040</span></span>ms <span class="hljs-number"><span class="hljs-number">3.48</span></span>% <span class="hljs-number"><span class="hljs-number">58.74</span></span>% <span class="hljs-number"><span class="hljs-number">1130</span></span>ms <span class="hljs-number"><span class="hljs-number">3.78</span></span>% database/sql.convertAssign <span class="hljs-number"><span class="hljs-number">910</span></span>ms <span class="hljs-number"><span class="hljs-number">3.04</span></span>% <span class="hljs-number"><span class="hljs-number">61.79</span></span>% <span class="hljs-number"><span class="hljs-number">8640</span></span>ms <span class="hljs-number"><span class="hljs-number">28.89</span></span>% runtime.convT2Eslice <span class="hljs-number"><span class="hljs-number">730</span></span>ms <span class="hljs-number"><span class="hljs-number">2.44</span></span>% <span class="hljs-number"><span class="hljs-number">64.23</span></span>% <span class="hljs-number"><span class="hljs-number">2540</span></span>ms <span class="hljs-number"><span class="hljs-number">8.49</span></span>% database/sql.(*Rows).Scan</code> </pre> <br>  Well, not bad for a start.  Next, I learned to study the MySQL driver, which, as it turned out, was written specifically for Go and implements low-level protocols itself, using sockets.  And the second MySQL protocol turned out to be binary.  That, in theory, gives a faster generation of a MySQL server response.  Accordingly, the driver, less calls the functions of converting text-integer.  To enable the binary protocol, you need to switch from db.Query to db.Prepare - stsm.Query - the minimum of changes to the source code and voila - 26.70 seconds of execution. <br><br><pre> <code class="go hljs">stmtOut, err := db.Prepare(sqlQ) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> stmtOut.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(<span class="hljs-string"><span class="hljs-string">"prepare"</span></span>, err, sqlQ) } rows, err := stmtOut.Query() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { log.Fatal(<span class="hljs-string"><span class="hljs-string">"query"</span></span>, err, sqlQ) } <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close()</code> </pre> <br>  The profiler shows that the protocol is already truly binary by (* binaryRows) .readRow, but when reading in RawBytes, it still goes through conversion to text, and then back. <br><br><pre> <code class="hljs swift"> flat flat% sum% cum cum% 2910ms <span class="hljs-number"><span class="hljs-number">10.79</span></span>% <span class="hljs-number"><span class="hljs-number">10.79</span></span>% 3310ms <span class="hljs-number"><span class="hljs-number">12.27</span></span>% runtime.mallocgc 2280ms <span class="hljs-number"><span class="hljs-number">8.45</span></span>% <span class="hljs-number"><span class="hljs-number">19.24</span></span>% 2600ms <span class="hljs-number"><span class="hljs-number">9.64</span></span>% runtime.mapaccess1_fast32 1960ms <span class="hljs-number"><span class="hljs-number">7.27</span></span>% <span class="hljs-number"><span class="hljs-number">26.51</span></span>% 7070ms <span class="hljs-number"><span class="hljs-number">26.21</span></span>% database/sql.convertAssign 1530ms <span class="hljs-number"><span class="hljs-number">5.67</span></span>% <span class="hljs-number"><span class="hljs-number">32.18</span></span>% 1810ms <span class="hljs-number"><span class="hljs-number">6.71</span></span>% runtime.mapassign_fast32 1460ms <span class="hljs-number"><span class="hljs-number">5.41</span></span>% <span class="hljs-number"><span class="hljs-number">37.60</span></span>% 6660ms <span class="hljs-number"><span class="hljs-number">24.69</span></span>% github.com/go-sql-driver/mysql.(*binaryRows).readRow 1420ms <span class="hljs-number"><span class="hljs-number">5.27</span></span>% <span class="hljs-number"><span class="hljs-number">42.86</span></span>% 26680ms <span class="hljs-number"><span class="hljs-number">98.92</span></span>% main.loadHits 1210ms <span class="hljs-number"><span class="hljs-number">4.49</span></span>% <span class="hljs-number"><span class="hljs-number">47.35</span></span>% 3010ms <span class="hljs-number"><span class="hljs-number">11.16</span></span>% strconv.<span class="hljs-type"><span class="hljs-type">AppendInt</span></span> 1100ms <span class="hljs-number"><span class="hljs-number">4.08</span></span>% <span class="hljs-number"><span class="hljs-number">51.43</span></span>% 1320ms <span class="hljs-number"><span class="hljs-number">4.89</span></span>% strconv.formatBits 950ms <span class="hljs-number"><span class="hljs-number">3.52</span></span>% <span class="hljs-number"><span class="hljs-number">54.95</span></span>% 1650ms <span class="hljs-number"><span class="hljs-number">6.12</span></span>% runtime.deferreturn 820ms <span class="hljs-number"><span class="hljs-number">3.04</span></span>% <span class="hljs-number"><span class="hljs-number">57.99</span></span>% 820ms <span class="hljs-number"><span class="hljs-number">3.04</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">ValueOf</span></span> 810ms <span class="hljs-number"><span class="hljs-number">3.00</span></span>% <span class="hljs-number"><span class="hljs-number">60.99</span></span>% 4120ms <span class="hljs-number"><span class="hljs-number">15.28</span></span>% runtime.convT2E64 750ms <span class="hljs-number"><span class="hljs-number">2.78</span></span>% <span class="hljs-number"><span class="hljs-number">63.77</span></span>% 4240ms <span class="hljs-number"><span class="hljs-number">15.72</span></span>% database/sql.asBytes</code> </pre><br>  Let's do Scan right away in uint32 structures!  Already nothing should be converted - only the conversion is integer-integer. <br><br>  The result was sad - 49.827306314s That is, the slowdown is generally terrifying.  The most stupid option of all, despite a good theoretical basis for the fastest result.  What is the matter? <br><br>  We look: <br><br><pre> <code class="hljs swift"> 4620ms <span class="hljs-number"><span class="hljs-number">9.22</span></span>% <span class="hljs-number"><span class="hljs-number">9.22</span></span>% 29230ms <span class="hljs-number"><span class="hljs-number">58.32</span></span>% database/sql.convertAssign 3610ms <span class="hljs-number"><span class="hljs-number">7.20</span></span>% <span class="hljs-number"><span class="hljs-number">16.42</span></span>% 4010ms <span class="hljs-number"><span class="hljs-number">8.00</span></span>% runtime.mallocgc 3010ms <span class="hljs-number"><span class="hljs-number">6.01</span></span>% <span class="hljs-number"><span class="hljs-number">22.43</span></span>% 8610ms <span class="hljs-number"><span class="hljs-number">17.18</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.(*rtype).<span class="hljs-type"><span class="hljs-type">Name</span></span> 2980ms <span class="hljs-number"><span class="hljs-number">5.95</span></span>% <span class="hljs-number"><span class="hljs-number">28.37</span></span>% 5600ms <span class="hljs-number"><span class="hljs-number">11.17</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.(*rtype).<span class="hljs-type"><span class="hljs-type">String</span></span> 2770ms <span class="hljs-number"><span class="hljs-number">5.53</span></span>% <span class="hljs-number"><span class="hljs-number">33.90</span></span>% 3330ms <span class="hljs-number"><span class="hljs-number">6.64</span></span>% runtime.mapaccess1_fast32 2570ms <span class="hljs-number"><span class="hljs-number">5.13</span></span>% <span class="hljs-number"><span class="hljs-number">39.03</span></span>% 2570ms <span class="hljs-number"><span class="hljs-number">5.13</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">ValueOf</span></span> 1760ms <span class="hljs-number"><span class="hljs-number">3.51</span></span>% <span class="hljs-number"><span class="hljs-number">42.54</span></span>% 1980ms <span class="hljs-number"><span class="hljs-number">3.95</span></span>% runtime.mapassign_fast32 1640ms <span class="hljs-number"><span class="hljs-number">3.27</span></span>% <span class="hljs-number"><span class="hljs-number">45.81</span></span>% 6630ms <span class="hljs-number"><span class="hljs-number">13.23</span></span>% github.com/go-sql-driver/mysql.(*binaryRows).readRow 1540ms <span class="hljs-number"><span class="hljs-number">3.07</span></span>% <span class="hljs-number"><span class="hljs-number">48.88</span></span>% 3870ms <span class="hljs-number"><span class="hljs-number">7.72</span></span>% strconv.<span class="hljs-type"><span class="hljs-type">FormatInt</span></span> 1240ms <span class="hljs-number"><span class="hljs-number">2.47</span></span>% <span class="hljs-number"><span class="hljs-number">51.36</span></span>% 49600ms <span class="hljs-number"><span class="hljs-number">98.96</span></span>% main.loadHits 1150ms <span class="hljs-number"><span class="hljs-number">2.29</span></span>% <span class="hljs-number"><span class="hljs-number">53.65</span></span>% 1150ms <span class="hljs-number"><span class="hljs-number">2.29</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">Value</span></span>.<span class="hljs-type"><span class="hljs-type">Type</span></span> 1120ms <span class="hljs-number"><span class="hljs-number">2.23</span></span>% <span class="hljs-number"><span class="hljs-number">55.89</span></span>% 1120ms <span class="hljs-number"><span class="hljs-number">2.23</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">Value</span></span>.<span class="hljs-type"><span class="hljs-type">Elem</span></span> 1070ms <span class="hljs-number"><span class="hljs-number">2.13</span></span>% <span class="hljs-number"><span class="hljs-number">58.02</span></span>% 30950ms <span class="hljs-number"><span class="hljs-number">61.75</span></span>% database/sql.(*<span class="hljs-type"><span class="hljs-type">Rows</span></span>).<span class="hljs-type"><span class="hljs-type">Scan</span></span> 1070ms <span class="hljs-number"><span class="hljs-number">2.13</span></span>% <span class="hljs-number"><span class="hljs-number">60.16</span></span>% 1070ms <span class="hljs-number"><span class="hljs-number">2.13</span></span>% strconv.<span class="hljs-type"><span class="hljs-type">ParseUint</span></span></code> </pre><br>  Judging by the presence of strconv.ParseUint - the conversion of 2 types is performed through a string!  Seriously?  reflect-transformations took the first lines in terms of execution time.  No wonder Rob Pike talks about the careful use of reflection.  You can mess things up. <br><br>  Having studied the MySQL driver, I stumbled upon the fact that from the binary protocol all data is converted to int64 - we will try to derive benefit from it.  Scan do in structure <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> HitRaw <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { siteID, zoneID, poolID, mediaID, campaignID <span class="hljs-keyword"><span class="hljs-keyword">int64</span></span> } ... h.siteID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(raw.siteID) h.zoneID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(raw.zoneID) h.poolID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(raw.poolID) h.mediaID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(raw.mediaID) h.campaignID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(raw.campaignID)</code> </pre><br>  The result was 33.98 seconds.  With this layout by function <br><br><pre> <code class="hljs swift"> 3600ms <span class="hljs-number"><span class="hljs-number">10.48</span></span>% <span class="hljs-number"><span class="hljs-number">10.48</span></span>% 14360ms <span class="hljs-number"><span class="hljs-number">41.79</span></span>% database/sql.convertAssign 2860ms <span class="hljs-number"><span class="hljs-number">8.32</span></span>% <span class="hljs-number"><span class="hljs-number">18.80</span></span>% 3340ms <span class="hljs-number"><span class="hljs-number">9.72</span></span>% runtime.mallocgc 2560ms <span class="hljs-number"><span class="hljs-number">7.45</span></span>% <span class="hljs-number"><span class="hljs-number">26.25</span></span>% 2920ms <span class="hljs-number"><span class="hljs-number">8.50</span></span>% runtime.mapaccess1_fast32 1660ms <span class="hljs-number"><span class="hljs-number">4.83</span></span>% <span class="hljs-number"><span class="hljs-number">31.08</span></span>% 6730ms <span class="hljs-number"><span class="hljs-number">19.59</span></span>% github.com/go-sql-driver/mysql.(*binaryRows).readRow 1540ms <span class="hljs-number"><span class="hljs-number">4.48</span></span>% <span class="hljs-number"><span class="hljs-number">35.56</span></span>% 33970ms <span class="hljs-number"><span class="hljs-number">98.86</span></span>% main.loadHits 1410ms <span class="hljs-number"><span class="hljs-number">4.10</span></span>% <span class="hljs-number"><span class="hljs-number">39.67</span></span>% 1690ms <span class="hljs-number"><span class="hljs-number">4.92</span></span>% runtime.mapassign_fast32 1340ms <span class="hljs-number"><span class="hljs-number">3.90</span></span>% <span class="hljs-number"><span class="hljs-number">43.57</span></span>% 1340ms <span class="hljs-number"><span class="hljs-number">3.90</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">ValueOf</span></span> 1290ms <span class="hljs-number"><span class="hljs-number">3.75</span></span>% <span class="hljs-number"><span class="hljs-number">47.32</span></span>% 4010ms <span class="hljs-number"><span class="hljs-number">11.67</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">Value</span></span>.<span class="hljs-type"><span class="hljs-type">Set</span></span> 940ms <span class="hljs-number"><span class="hljs-number">2.74</span></span>% <span class="hljs-number"><span class="hljs-number">50.06</span></span>% 15960ms <span class="hljs-number"><span class="hljs-number">46.45</span></span>% database/sql.(*<span class="hljs-type"><span class="hljs-type">Rows</span></span>).<span class="hljs-type"><span class="hljs-type">Scan</span></span> 900ms <span class="hljs-number"><span class="hljs-number">2.62</span></span>% <span class="hljs-number"><span class="hljs-number">52.68</span></span>% 900ms <span class="hljs-number"><span class="hljs-number">2.62</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">Value</span></span>.<span class="hljs-type"><span class="hljs-type">Elem</span></span> 840ms <span class="hljs-number"><span class="hljs-number">2.44</span></span>% <span class="hljs-number"><span class="hljs-number">55.12</span></span>% 840ms <span class="hljs-number"><span class="hljs-number">2.44</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">Value</span></span>.<span class="hljs-type"><span class="hljs-type">Type</span></span> 840ms <span class="hljs-number"><span class="hljs-number">2.44</span></span>% <span class="hljs-number"><span class="hljs-number">57.57</span></span>% 1500ms <span class="hljs-number"><span class="hljs-number">4.37</span></span>% runtime.deferreturn 810ms <span class="hljs-number"><span class="hljs-number">2.36</span></span>% <span class="hljs-number"><span class="hljs-number">59.92</span></span>% 810ms <span class="hljs-number"><span class="hljs-number">2.36</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.directlyAssignable 760ms <span class="hljs-number"><span class="hljs-number">2.21</span></span>% <span class="hljs-number"><span class="hljs-number">62.14</span></span>% 760ms <span class="hljs-number"><span class="hljs-number">2.21</span></span>% runtime.getitab 730ms <span class="hljs-number"><span class="hljs-number">2.12</span></span>% <span class="hljs-number"><span class="hljs-number">64.26</span></span>% 900ms <span class="hljs-number"><span class="hljs-number">2.62</span></span>% <span class="hljs-built_in"><span class="hljs-built_in">reflect</span></span>.<span class="hljs-type"><span class="hljs-type">Value</span></span>.assignTo 720ms <span class="hljs-number"><span class="hljs-number">2.10</span></span>% <span class="hljs-number"><span class="hljs-number">66.36</span></span>% 4060ms <span class="hljs-number"><span class="hljs-number">11.82</span></span>% runtime.convT2E64</code> </pre><br>  It can be seen that sql.convertAssign reduces all the benefits of using a binary protocol.  And now the data is not copied through the text, but inside reflect it is still quite difficult to determine that int64 can be copied to the user's int64 variable.  And copying numbers to text and back goes faster than reflect.directlyAssignable - reflect.Value.assignTo. <br><br>  As a warm-up, I tried to translate the b2u function into a go-assembler.  Assembler was my one of the first BK-0011 programming languages ‚Äã‚Äãlearned at school without a drive and a cassette recorder) So it was funny.  Although Go generates a practically optimal code and if you don‚Äôt come up with algorithmic tricks or using non-standard ASM commands, there‚Äôs no special point in writing these functions. <br><br><pre> <code class="hljs pgsql">// func b2u(data []byte) uint32 // // memory layout <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> the stack relative <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> FP // +<span class="hljs-number"><span class="hljs-number">0</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> ptr // +<span class="hljs-number"><span class="hljs-number">8</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> len // +<span class="hljs-number"><span class="hljs-number">16</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">slice</span></span> cap #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "textflag.h" <span class="hljs-type"><span class="hljs-type">TEXT</span></span> ¬∑B2u(SB),NOSPLIT,<span class="hljs-meta"><span class="hljs-meta">$0</span></span><span class="hljs-number"><span class="hljs-number">-24</span></span> // data ptr MOVQ data+<span class="hljs-number"><span class="hljs-number">0</span></span>(FP), SI // data len MOVQ data+<span class="hljs-number"><span class="hljs-number">8</span></span>(FP), CX // result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> AX MOVBLZX (SI), AX // - <span class="hljs-string"><span class="hljs-string">'0'</span></span> SUBL <span class="hljs-meta"><span class="hljs-meta">$48</span></span>, AX // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> DECQ CX JZ AX2RET LOOPBYTE: //<span class="hljs-keyword"><span class="hljs-keyword">move</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> one byte upper INCQ SI MOVBLZX (SI), BX //prev result *= <span class="hljs-number"><span class="hljs-number">10</span></span> IMULL <span class="hljs-meta"><span class="hljs-meta">$10</span></span>, AX // bx -= <span class="hljs-string"><span class="hljs-string">'0'</span></span> SUBL <span class="hljs-meta"><span class="hljs-meta">$48</span></span>, BX ADDL BX, AX // <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (cx<span class="hljs-comment"><span class="hljs-comment">--) DECQ CX JNZ LOOPBYTE AX2RET: MOVL AX, ret+24(FP) RET</span></span></code> </pre><br>  According to the tests, it gives an acceleration of 2-20% from the Go version.  Depends on the number of digits in the number. <br>  As a result, the working example accelerated to 26.94 seconds. <br><br>  Conclusion from the article, for those who only looked through the text - the fastest way to read a large amount of integer data from MySQL to memory - use db.Prepare - stmt.Query - Scan in interface {} and convert uint32 (hit.siteID. (Int64) ) into an unsigned integer that works for uint64 without cutting the upper bit off. <br>  That is, the ways of working with the driver shown in standard examples are not always optimal.  Perhaps the developers will pay attention to the driver's behavior, because there are a lot of hidden calls and overheads for both a simple and not overloaded with language functionality.  After all, Go in tests, in which SELECT selections from the database appear, <a href="https://www.techempower.com/benchmarks/">does not shine with performance</a> .  Moreover, not all experienced programmers have the time and desire to dig under the hood.  As far as I know, nobody has ever conducted such tests on SELECT at all. <br><br>  UPD: In the comments gave an example of a miraculous driver <a href="https://github.com/lazada/sqle">github.com/lazada/sqle</a> supposedly designed for quick reading.  The result was when reading through <br>  rows.Scan (&amp; h.siteID, &amp; h.zoneID, &amp; h.poolID, &amp; h.mediaID, &amp; h.campaignID) in uint32 variables is very sad <br> <code>55928930 time BETWEEN 1525640400 AND 1525726799 in 1m0.307942824s</code> <br>  And if you look at what the program did for a minute, it becomes clear that there was simply no thought of optimizing this case.  Standard driver wins 2 times. <br> <code>flat flat% sum% cum cum% <br> 4.63s 7.62% 7.62% 29.25s 48.11% database/sql.convertAssign <br> 4.22s 6.94% 14.56% 4.68s 7.70% runtime.mallocgc <br> 2.97s 4.88% 19.44% 8.48s 13.95% reflect.(*rtype).Name <br> 2.96s 4.87% 24.31% 5.51s 9.06% reflect.(*rtype).String <br> 2.90s 4.77% 29.08% 41.28s 67.89% github.com/lazada/sqle.(*Rows).Scan <br> 2.51s 4.13% 33.21% 2.95s 4.85% runtime.mapaccess1_fast32 <br> 2.38s 3.91% 37.12% 2.38s 3.91% reflect.ValueOf <br> 1.92s 3.16% 40.28% 3.69s 6.07% runtime.assertE2I2 <br> 1.77s 2.91% 43.19% 1.77s 2.91% runtime.getitab <br> 1.65s 2.71% 45.90% 7.04s 11.58% github.com/go-sql-driver/mysql.(*binaryRows).readRow <br> 1.49s 2.45% 48.36% 1.86s 3.06% runtime.mapassign_fast32 <br> 1.35s 2.22% 50.58% 60.27s 99.13% main.loadHits <br> 1.31s 2.15% 52.73% 4.01s 6.60% github.com/lazada/sqle.typeCheck <br> 1.31s 2.15% 54.88% 4.19s 6.89% strconv.FormatInt <br> 1.28s 2.11% 56.99% 2.88s 4.74% strconv.formatBits <br> 1.25s 2.06% 59.05% 1.25s 2.06% reflect.(*rtype).Kind <br> 1.12s 1.84% 60.89% 31.05s 51.07% database/sql.(*Rows).Scan <br></code> <br>  If you read Scan to [] byte variables and convert b2u () to uint32, you get 44 seconds.  In my opinion, you can not further test what a great substitute for the standard database / sql guys wrote.  The next myth about acceleration has been debunked about practical tests. <br><br>  UPD2: To understand the speed of reading from MySQL made a cycle without conversions and calculations <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() { c++ }</code> </pre><br>  total - 11.9 seconds.  Thus, 15 seconds out of 27 spend on converting and working with hashmaps. <br><br>  UPD3: After writing the article, I began to understand more about the insides of Go - and found a pill for my case right under my nose: <br>  <a href="https://golang.org/pkg/database/sql/">golang.org/pkg/database/sql/#Rows.Scan</a> <br>  If an argument has a type that has been defined as the interface case, it does not apply. <br>  Here is the final version of the code, which I recommend to everyone: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> HitRaw <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { siteID, zoneID, poolID, mediaID, campaignID, status <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>{} } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( hit HitRaw h Hit ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() { rows.Scan(&amp;hit.siteID, &amp;hit.zoneID, &amp;hit.poolID, &amp;hit.mediaID, &amp;hit.campaignID, &amp;hit.status) h.siteID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(hit.siteID.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>)) h.zoneID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(hit.zoneID.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>)) h.siteID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(hit.siteID.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>)) h.poolID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(hit.poolID.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>)) h.mediaID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(hit.mediaID.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>)) h.campaignID = <span class="hljs-keyword"><span class="hljs-keyword">uint32</span></span>(hit.campaignID.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>)) h.status = <span class="hljs-keyword"><span class="hljs-keyword">uint8</span></span>(hit.status.(<span class="hljs-keyword"><span class="hljs-keyword">int64</span></span>))</code> </pre><br>  The result will not leave anyone indifferent: <br>  12.206921479s on 55.9 million records.  And this is after 27 seconds, in which I thought I had reached Nirvana. <br>  And the profiler produces already quite a good deal - most of the time, the program updates the counters in hash.  Binary data is sent from the driver straight to where they are waiting.  Assembler was not at all mandatory. <br> <code>flat flat% sum% cum cum% <br> 3110ms 15.20% 15.20% 3460ms 16.91% runtime.mallocgc <br> 2350ms 11.49% 26.69% 2700ms 13.20% runtime.mapaccess1_fast32 <br> 1850ms 9.04% 35.73% 2150ms 10.51% runtime.mapassign_fast32 <br> 1460ms 7.14% 42.86% 6670ms 32.60% github.com/go-sql-driver/mysql.(*binaryRows).readRow <br> 1420ms 6.94% 49.80% 20070ms 98.09% main.loadHits <br> 1170ms 5.72% 55.52% 1190ms 5.82% database/sql.convertAssign <br> 840ms 4.11% 59.63% 4300ms 21.02% runtime.convT2E64 <br> 710ms 3.47% 63.10% 2470ms 12.07% database/sql.(*Rows).Scan <br> 680ms 3.32% 66.42% 1260ms 6.16% runtime.deferreturn <br> 680ms 3.32% 69.75% 680ms 3.32% sync.(*RWMutex).RLock <br> 650ms 3.18% 72.92% 650ms 3.18% runtime.aeshash32 <br> 630ms 3.08% 76.00% 630ms 3.08% sync.(*RWMutex).RUnlock <br></code> </div><p>Source: <a href="https://habr.com/ru/post/358522/">https://habr.com/ru/post/358522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../358512/index.html">Carrot models, bottlenecks and speech recognition: the absence of dictionaries in the field of artificial intelligence</a></li>
<li><a href="../358514/index.html">Release Rust 1.26</a></li>
<li><a href="../358516/index.html">Terminal server for AutoCAD</a></li>
<li><a href="../358518/index.html">VimpelCom subscribers will pay 13 rubles per month for the Spring Law</a></li>
<li><a href="../358520/index.html">Java and Linux - features of operation</a></li>
<li><a href="../358524/index.html">We will again be counted: National biometric platform and ‚Äúpass-through identifier‚Äù</a></li>
<li><a href="../358526/index.html">Number all real numbers on the interval [0,1]</a></li>
<li><a href="../358528/index.html">REST-API automatic documentation system in Laravel projects</a></li>
<li><a href="../358530/index.html">Introduction to Data Engineering. ETL, star schema and airflow</a></li>
<li><a href="../358532/index.html">Open webinar: ‚ÄúTranslation difficulties: 2 and 3 versions‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>