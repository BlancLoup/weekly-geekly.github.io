<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC 3/4: Anti-Hacking</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, I read another article on SQL injections in Habr√©, the article was devoted to true PHP, there were disputes about how to deal with da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC 3/4: Anti-Hacking</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/253/3e8/c34/2533e8c341d1e7852ff1def306e5c43e.jpg"><br><br>  Not so long ago, I read another article on SQL injections in Habr√©, the article was devoted to true PHP, there were disputes about how to deal with data from the user, through what functions to drive them away, with PHP familiar with the surface, but I learned the big picture.  Then the idea was born to show how things are going with security in ASP.NET MVC. <br><br><a name="habracut"></a>  First of all, we will create a simple website, I will not describe step-by-step creation, I‚Äôll just say a bunch of technologies used: ASP.NET MVC4 and Entity Framework 4.3.1 (ORM for working with databases).  The project can be downloaded at the end of the article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a result, we received a site with one static news and the ability to add comments. <br><br><h4>  Cross-Site Scripting (XSS) </h4><hr><br>  Let's start our hacking with XSS, we will implement scripts on the page by adding comments. <br>  Now we will try to add a comment with the script: <br><br><img src="https://habrastorage.org/storage2/4c3/ad4/088/4c3ad408814c7998b8d2ecc69c9d8199.png"><br><br>  Click add a comment and get an error, alas, we have not reached the method: <br><br><img src="https://habrastorage.org/storage2/349/b8f/d48/349b8fd48f3cc2027ef9fa2bcc8def4b.png"><br><br>  What is the fastest way to make a website work?  Certainly chop off validation for the method: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ValidateInput(false)</span></span>]</code> </pre> <br>  This is not a task, again our script is not executed: <br><br><img src="https://habrastorage.org/storage2/e4a/e08/7d7/e4ae087d7ce37f4748a9aaa37371402a.png"><br><br>  This happens because, by default, all text is encoded and output encoded, the situation can change: <br><br><pre> <code class="cs hljs">@Html.Raw()</code> </pre><br>  It is worth remembering that the user can not be trusted; you need to save only the checked content, for example, as the habr parser does, deleting potentially dangerous content.  Also, with the help of XSS, you can steal data using a banal img tag that is hidden, while loading the page confidential data can get to a third party.  Once again, although I gave an example of how to still write the script to the database, you should always remember that at one point a new developer may appear who will add ajax features using jquery and using $ .html () will return the XSS hole to security. <br><br><h4>  SQL injection </h4><hr><br>  For hacking the site using injections, I made a separate page, on which there is a field for searching comments by the name of the author, there is no point in doing methods for working with models of numbers, bool values ‚Äã‚Äãand other things, since I‚Äôll not convey my string at the binding stage (binding) input parameters and models, this data will be deselected. <br><br><img src="https://habrastorage.org/storage2/dee/869/1c6/dee8691c6fdab127fec2f993d7e0543e.png"><br><br>  Actually, as long as I did not try to do something, it did not work out, the use of ORM was to blame, there are no string concatenations there, the data is passed by parameters and escaped.  It‚Äôs hard to imagine a person who does not use ORM or other safe methods when working with a database (example from <a href="http://habrahabr.ru/post/148338/">servitRM</a> ) (first of all, I‚Äôm talking about preventing the user from inserting data in the form in which you received it by concatenating strings) the project is from scratch and there are no restrictions on technology, perhaps, if some old modules are used and there is no time to rewrite - this can be somehow justified, but then all responsibility falls on the developer. <br><br><h4>  Cross-Site Request Forgery (CSRF) </h4><hr><br>  An example of this attack could be, for example, a website with a local currency and you only need one POST request to transfer money to another user.  The attacker makes a form on his site, where in action (form action) points to another site, creates hidden parameters: the amount, <br>  wallet, etc ... Being authorized on that site you will transfer money to it (other options: removal of something, additions, in general most of POST requests). <br><br>  To combat this, MVC has a helper for presentation, which should be in the form body: <br><br><pre> <code class="cs hljs">@Html.AntiForgeryToken()</code> </pre><br><img src="https://habrastorage.org/storage2/2df/020/bd5/2df020bd53f8a99dc2f0586f7c66d7dc.png"><br><br>  Now the attribute for the controller's (Action) method: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ValidateAntiForgeryToken</span></span>]</code> </pre><br>  Let us check that we succeeded (I added this logic to the page with XSS), we make the usual query: <br><br><img src="https://habrastorage.org/storage2/ee3/898/641/ee3898641a3df17caac75d49f0665ee2.png"><br><br>  In addition to hidden fields, we also had cookies: <br><br><img src="https://habrastorage.org/storage2/08d/465/d83/08d465d83000975894a8e22e5c281aec.png"><br><br>  Now, we‚Äôll remove this hidden field and look at the result (at least three options, remove it from the view, delete it using Firebug and more interesting for me via Composer in Fiddler, drag a successful query and simply delete this parameter in Request Body): <br><br><img src="https://habrastorage.org/storage2/3d7/3b0/4df/3d73b04dfc82306e460353ba0c5efa18.png"><br><br>  It is worth remembering that this parameter is not generated with each request and by intercepting the package in the future you can hack. <br><br><h4>  Information hiding </h4><hr><br>  Many do not give this attention, but I believe that this item is very important.  When choosing a lock for a metal door, I found out that many locks are opened elementarily with the help of a drill, be there three thick bolts (cylinders that move out), but it is enough to drill one hole in the right <br>  place (as it were, deliver a pinpoint blow to weak points) and the lock is open.  Similarly, if you say that you have such and such IIS, such and such version of ASP.NET, etc.  You provide invaluable assistance to the burglar!  I love to clean the Elmah logs with a cup of tea and watch how my site is trying to find php, mysql, using wonderful services to determine which CMS is used, etc. <br><br>  Here is what my site is returning now: <br><br><img src="https://habrastorage.org/storage2/906/92c/53a/90692c53a97a2426911d9e6776b27eff.png"><br><br>  Remove X-Powered-By: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpProtocol</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">customHeaders</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">remove</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"X-Powered-By"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">customHeaders</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpProtocol</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  ASP.NET version: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpRuntime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enableVersionHeader</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  MVC version in Application_Start: <br><br><pre> <code class="cs hljs">MvcHandler.DisableMvcResponseHeader = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre><br>  And the most difficult is the server, for which we will make the HttpModule: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomServerHeaderModule</span></span> : <span class="hljs-title"><span class="hljs-title">IHttpModule</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpApplication context</span></span></span><span class="hljs-function">)</span></span> { context.PreSendRequestHeaders += OnPreSendRequestHeaders; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPreSendRequestHeaders</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { HttpContext.Current.Response.Headers.Set(<span class="hljs-string"><span class="hljs-string">"Server"</span></span>, <span class="hljs-string"><span class="hljs-string">"Apache 2000 Server"</span></span>); } }</code> </pre><br>  and add to the config: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modules</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">runAllManagedModulesForAllRequests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"CustomServerHeader"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"HackingMVC.HttpModules.CustomServerHeaderModule"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modules</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.webServer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  As a result, we got the following result: <br><br><img src="https://habrastorage.org/storage2/7ca/d27/dbd/7cad27dbd73dc4a82f035ef0cff13e63.png"><br><br><h4>  Instead of conclusion </h4><hr><br>  Not for nothing is ASP.NET famous for its security, MVC is actively developing, which with each version becomes more and more interesting.  Some points were not considered, I missed something, but it‚Äôs enough just to mention something, in any case it is impossible to consider such a voluminous topic in one article.  It is worth focusing on the fact that it is very important to use SSL on the site, because otherwise your data may be stolen during authorization, session on any page, authorization token or any other data stolen, which negates a lot of protection.  Keep in mind both JSON Hijacking and the fact that it doesn‚Äôt simply throw a warning if you try to retrieve data via a GET request without specifying permission, in this way you should give only those data that are not afraid to lose.  I showed only a part of the problems that you may encounter and which you should pay attention to when developing. <br><br>  PS Wishes and options for hacking this site are welcome: <a href="">zip-archive</a> .  (8.7 MB, since the downloaded NuGet packages are included in the solution / project (solution)) or without a <a href="">zip-archive</a> package (706 KB). <br><br>  <b>UPDATE:</b> Added archive without packages.  A few words about hashing: the site uses Forms authorization for the admin, the password is stored in clear text in the web.config, which is done for clarity when viewing the source.  In real projects, password hashing must be used, both in the config and in the database. You also need to use salt to obtain data with a well-known hashing algorithm to pass the passwords through the tables and the salt must be different, so that you cannot recognize the value and a hash of one password to find identical passwords, which will speed up hacking. <br></div><p>Source: <a href="https://habr.com/ru/post/148338/">https://habr.com/ru/post/148338/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148329/index.html">What have you spent your best karma on?</a></li>
<li><a href="../148331/index.html">Remote wipe on Android and Exchange ActiveSync</a></li>
<li><a href="../148332/index.html">Create a feedback form using Google Forms</a></li>
<li><a href="../148334/index.html">Black screen internet. An example of a minimal useful web application.</a></li>
<li><a href="../148337/index.html">Why copyright is unconstitutional</a></li>
<li><a href="../148340/index.html">Template sites VS exclusive sites</a></li>
<li><a href="../148341/index.html">Comparison of various types of modulation in WDM communication systems</a></li>
<li><a href="../148342/index.html">How to mess with typography: a selection of working methods</a></li>
<li><a href="../148343/index.html">Clever waste bin from Japan picks it up on the fly</a></li>
<li><a href="../148344/index.html">Interactive glasses with built-in translator based on Raspberry Pi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>