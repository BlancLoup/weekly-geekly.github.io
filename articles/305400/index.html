<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ansible Handbook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This practical guide will introduce you to Ansible. You will need a virtual or real machine that will act as a host for Ansible. The environment for V...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ansible Handbook</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/783/076/0a4/7830760a48bc40a0a8d54853598fc013.jpg" alt="orchestra configuration management"></p><br><p>  This practical guide will introduce you to Ansible.  You will need a virtual or real machine that will act as a host for Ansible.  The environment for Vagrant comes with this manual. </p><br><p>  Ansible is a software solution for remote configuration management.  It allows you to configure remote machines.  Its main difference from other similar systems is that Ansible uses the existing SSH infrastructure, while others (chef, puppet, etc.) require the installation of a special PKI environment. </p><br><p>  The manual covers such topics: </p><br><ol><li>  Ansible and Vagrant installation </li><li>  Inventory file </li><li>  Modules shell, copy, fact collection, variables </li><li>  Run on host group </li><li>  Playbooks </li><li>  Example: raising a cluster, installing and configuring Apache and HAproxy load balancer </li><li>  Error handling, rollback </li><li>  Configuration templates </li><li>  Roles </li></ol><br><p>  Ansible uses the so-called push mode: the configuration is ‚Äúpushed‚Äù (push) from the host machine.  Other CM-systems usually do the opposite - the nodes pull the configuration from the main machine. </p><br><p>  This mode is interesting because you do not need to have a publicly accessible host machine to remotely configure nodes;  these nodes must be accessible (we will see later that hidden nodes can also receive a configuration). <a name="habracut"></a></p><br><h2>  What you need for Ansible </h2><br><p>  The following Python modules are required. </p><br><ul><li>  python-yaml </li><li>  python-jinja2 </li></ul><br><p>  On Debian / Ubuntu, run: </p><br><pre><code class="hljs mel">sudo apt-get install <span class="hljs-keyword"><span class="hljs-keyword">python</span></span>-yaml <span class="hljs-keyword"><span class="hljs-keyword">python</span></span>-jinja2 <span class="hljs-keyword"><span class="hljs-keyword">python</span></span>-paramiko <span class="hljs-keyword"><span class="hljs-keyword">python</span></span>-crypto</code> </pre> <br><p>  You should also have a pair of keys in ~ / .ssh. </p><br><h2>  Ansible installation </h2><br><h3>  From source </h3><br><p>  The devel branch is always stable, so use it.  You may need to install git ( <code>sudo apt-get install git</code> on Debian / Ubuntu). </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">git</span></span> clone git://github.com/ansible/ansible.git cd ./ansible</code> </pre> <br><p>  Now you can load the Ansible environment. </p><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">source</span></span> ./hacking/<span class="hljs-keyword"><span class="hljs-keyword">env</span></span>-setup</code> </pre> <br><h3>  From deb package </h3><br><pre> <code class="hljs sql">sudo apt-get <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> make fakeroot cdbs python-support git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> git://github.com/ansible/ansible.git cd ./ansible make deb sudo dpkg -i ../ansible_1<span class="hljs-number"><span class="hljs-number">.1</span></span>_all.deb (<span class="hljs-keyword"><span class="hljs-keyword">version</span></span> may vary)</code> </pre> <br><p>  This tutorial assumes that you used this particular method. </p><br><h2>  Install Vagrant </h2><br><p>  Vagrant allows you to easily create virtual machines and run them on VirtualBox.  Vagrantfile comes with a guide. </p><br><p>  To run Vagrant you need to install: </p><br><ul><li>  Virtualbox </li><li>  Ruby (most likely already installed on your system) </li><li>  Vagrant 1.1+ (see <br>  <a href="http://docs.vagrantup.com/v2/installation/index.html">http://docs.vagrantup.com/v2/installation/index.html</a> ). </li></ul><br><p>  Now initialize the virtual machine with the following command.  Keep in mind that you do not need to download any "box" manually.  This manual already <a href="https://github.com/leucos/ansible-tuto/blob/master/Vagrantfile">contains a</a> ready-made <code>Vagrantfile</code> , it contains everything you need to work. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">vagrant</span></span> up</code> </pre> <br><p>  and pour yourself some coffee (if you use vagrant-hostmaster, then you will need to enter the root password).  If something went wrong, check out the <a href="http://docs.vagrantup.com/v2/getting-started/index.html">tutorial on Vagrant</a> . </p><br><h2>  Adding SSH keys in a virtual machine </h2><br><p>  To continue, you need to add your keys to the <code>authorized_keys</code> root on the virtual machine.  This is not necessary (Ansible can use sudo and password authentication), but it will be so much easier. </p><br><p>  Ansible is perfect for this task, so we use it.  However, I will not explain anything yet.  Just trust me. </p><br><pre> <code class="hljs vbscript">ansible-playbook -c paramiko -i <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-00</span></span>/hosts <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-00</span></span>/setup.yml --ask-pass --sudo</code> </pre> <br><p>  Enter <em>vagrant</em> as your <em>password</em> .  If errors of "Connections refused" occur, then check the firewall settings. </p><br><p>  Now add your keys to ssh-agent ( <code>ssh-add</code> ). </p><br><h2>  Inventory </h2><br><p>  Now we need to prepare the inventory file.  The default location is <code>/etc/ansible/hosts</code> . <br>  But you can configure Ansible to use a different path.  To do this, use the environment variable ( <code>ANSIBLE_HOSTS</code> ) or the <code>-i</code> flag. </p><br><p>  We have created such an inventory file: </p><br><pre> <code class="hljs">host0.example.org ansible_ssh_host=192.168.33.10 ansible_ssh_user=root host1.example.org ansible_ssh_host=192.168.33.11 ansible_ssh_user=root host2.example.org ansible_ssh_host=192.168.33.12 ansible_ssh_user=root</code> </pre> <br><p>  <code>ansible_ssh_host</code> is a special <em>variable</em> that contains the IP address of the host to which the connection will be created.  In this case, it is not necessary if you use gem vagrant-hostmaster.  Also, you will need to change IP addresses if you have installed and configured your virtual machine with other addresses. </p><br><p>  <code>ansible_ssh_user</code> is another special <em>variable</em> that tells Ansible to connect under the specified account (user).  By default, Ansible uses your current account, or another default value specified in ~ / .ansible.cfg ( <code>remote_user</code> ). </p><br><h2>  Check </h2><br><p>  Now that Ansible is installed, let's check that everything works: </p><br><pre> <code class="hljs pgsql">ansible -m ping <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -i step<span class="hljs-number"><span class="hljs-number">-01</span></span>/hosts</code> </pre> <br><p>  Here Ansible will try to start the <code>ping</code> module (more on the modules later) on each host.  The output should be something like this: </p><br><pre> <code class="hljs objectivec">host0.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"ping"</span></span>: <span class="hljs-string"><span class="hljs-string">"pong"</span></span> } host1.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"ping"</span></span>: <span class="hljs-string"><span class="hljs-string">"pong"</span></span> } host2.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"ping"</span></span>: <span class="hljs-string"><span class="hljs-string">"pong"</span></span> }</code> </pre> <br><p>  Fine!  All three hosts are alive and well, and Ansible can communicate with them. </p><br><h1>  Communication with nodes </h1><br><p>  Now we are ready.  Let's play with the already familiar team from the previous section: <code>ansible</code> .  This command is one of three commands that Ansible uses to interact with nodes. </p><br><h2>  Do something useful </h2><br><p>  In the last command, <code>-m ping</code> meant "use the <em>ping</em> module."  This is one of the many modules available in Ansible.  The <code>ping</code> module <code>ping</code> very simple; it does not require any arguments.  Modules requiring arguments can get them through <code>-a</code> .  Let's take a look at several modules. </p><br><h3>  Shell module </h3><br><p>  This module allows you to run shell commands on a remote host: </p><br><pre> <code class="hljs matlab">ansible -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> step<span class="hljs-number"><span class="hljs-number">-02</span></span>/hosts -m shell -a <span class="hljs-string"><span class="hljs-string">'uname -a'</span></span> host0.example.org</code> </pre> <br><p>  The output should be like: </p><br><pre> <code class="hljs ruby">host<span class="hljs-number"><span class="hljs-number">0</span></span>.example.org <span class="hljs-params"><span class="hljs-params">| success |</span></span> rc=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>Linux host<span class="hljs-number"><span class="hljs-number">0</span></span>.example.org <span class="hljs-number"><span class="hljs-number">3.2</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">23</span></span>-generic-pae <span class="hljs-comment"><span class="hljs-comment">#36-Ubuntu SMP Tue Apr 10 22:19:09 UTC 2012 i686 i686 i386 GNU/Linux</span></span></code> </pre> <br><p>  Easy! </p><br><h3>  Copy module </h3><br><p>  The <code>copy</code> module allows you to copy a file from a management machine to a remote node.  Imagine that we need to copy our <code>/etc/motd</code> to the <code>/tmp</code> node: </p><br><pre> <code class="hljs pgsql">ansible -i step<span class="hljs-number"><span class="hljs-number">-02</span></span>/hosts -m <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> -a <span class="hljs-string"><span class="hljs-string">'src=/etc/motd dest=/tmp/'</span></span> host0.example.org</code> </pre> <br><p>  Conclusion: </p><br><pre> <code class="hljs objectivec">host0.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"dest"</span></span>: <span class="hljs-string"><span class="hljs-string">"/tmp/motd"</span></span>, <span class="hljs-string"><span class="hljs-string">"group"</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-string"><span class="hljs-string">"md5sum"</span></span>: <span class="hljs-string"><span class="hljs-string">"d41d8cd98f00b204e9800998ecf8427e"</span></span>, <span class="hljs-string"><span class="hljs-string">"mode"</span></span>: <span class="hljs-string"><span class="hljs-string">"0644"</span></span>, <span class="hljs-string"><span class="hljs-string">"owner"</span></span>: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"src"</span></span>: <span class="hljs-string"><span class="hljs-string">"/root/.ansible/tmp/ansible-1362910475.9-246937081757218/motd"</span></span>, <span class="hljs-string"><span class="hljs-string">"state"</span></span>: <span class="hljs-string"><span class="hljs-string">"file"</span></span> }</code> </pre> <br><p>  Ansible (more precisely, the <em>copy</em> module running on the node) responded with a bunch of useful information in JSON format.  We will see later how this can be used. </p><br><p>  Ansible has a huge <br>  <a href="http://docs.ansible.com/list_of_all_modules.html">a list of modules</a> that covers almost everything that can be done in the system.  If you have not found a suitable module, then writing your own module is a fairly simple task (and you don‚Äôt have to write it in Python, as long as it understands JSON). </p><br><h2>  Many hosts, one team </h2><br><p>  Everything above was great, but we need to manage multiple hosts.  Let's try.  Suppose we want to gather facts about a node and, for example, we want to know which version of Ubuntu is installed on the nodes.  This is pretty easy: </p><br><pre> <code class="hljs vhdl">ansible -i step-<span class="hljs-number"><span class="hljs-number">02</span></span>/hosts -m shell -a <span class="hljs-symbol"><span class="hljs-symbol">'grep</span></span> DISTRIB_RELEASE /etc/lsb-<span class="hljs-keyword"><span class="hljs-keyword">release</span></span>' <span class="hljs-keyword"><span class="hljs-keyword">all</span></span></code> </pre> <br><p>  <code>all</code> means "all hosts in the inventory file".  The output will be something like this: </p><br><pre> <code class="hljs ruby">host1.example.org <span class="hljs-params"><span class="hljs-params">| success |</span></span> rc=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>DISTRIB_RELEASE=<span class="hljs-number"><span class="hljs-number">12.04</span></span> host2.example.org <span class="hljs-params"><span class="hljs-params">| success |</span></span> rc=<span class="hljs-number"><span class="hljs-number">0</span></span> &gt;&gt; DISTRIB_RELEASE=<span class="hljs-number"><span class="hljs-number">12.04</span></span> host<span class="hljs-number"><span class="hljs-number">0</span></span>.example.org <span class="hljs-params"><span class="hljs-params">| success |</span></span> rc=<span class="hljs-number"><span class="hljs-number">0</span></span> &gt;&gt; DISTRIB_RELEASE=<span class="hljs-number"><span class="hljs-number">12.04</span></span></code> </pre> <br><h2>  More facts </h2><br><p>  Simply and easily.  However, if we need more information (IP addresses, RAM sizes, etc.), this approach can quickly be inconvenient.  The solution is to use the <code>setup</code> module.  He specializes in collecting <em>facts</em> from nodes. </p><br><p>  Try: </p><br><pre> <code class="hljs matlab">ansible -<span class="hljs-built_in"><span class="hljs-built_in">i</span></span> step<span class="hljs-number"><span class="hljs-number">-02</span></span>/hosts -m setup host0.example.org</code> </pre> <br><p>  answer: </p><br><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"ansible_facts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ansible_all_ipv4_addresses"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"192.168.0.60"</span></span> ], <span class="hljs-string"><span class="hljs-string">"ansible_all_ipv6_addresses"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"ansible_architecture"</span></span>: <span class="hljs-string"><span class="hljs-string">"x86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"ansible_bios_date"</span></span>: <span class="hljs-string"><span class="hljs-string">"01/01/2007"</span></span>, <span class="hljs-string"><span class="hljs-string">"ansible_bios_version"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bochs"</span></span> }, ---snip--- <span class="hljs-string"><span class="hljs-string">"ansible_virtualization_role"</span></span>: <span class="hljs-string"><span class="hljs-string">"guest"</span></span>, <span class="hljs-string"><span class="hljs-string">"ansible_virtualization_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"kvm"</span></span> }, <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"verbose_override"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><p>  The output has been shortened for simplicity, but you can learn a lot from this information.  You can also filter the keys if you are interested in something specific. </p><br><p>  For example, you need to find out how much memory is available on all hosts.  It's easy: run <code>ansible -i step-02/hosts -m setup -a 'filter=ansible_memtotal_mb' all</code> : </p><br><pre> <code class="hljs objectivec">host2.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"ansible_facts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ansible_memtotal_mb"</span></span>: <span class="hljs-number"><span class="hljs-number">187</span></span> }, <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"verbose_override"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } host1.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"ansible_facts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ansible_memtotal_mb"</span></span>: <span class="hljs-number"><span class="hljs-number">187</span></span> }, <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"verbose_override"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } host0.example.org | success &gt;&gt; { <span class="hljs-string"><span class="hljs-string">"ansible_facts"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ansible_memtotal_mb"</span></span>: <span class="hljs-number"><span class="hljs-number">187</span></span> }, <span class="hljs-string"><span class="hljs-string">"changed"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"verbose_override"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> }</code> </pre> <br><p>  Notice that the nodes did not answer in the order in which they answered above.  Ansible communicates with hosts in parallel! </p><br><p>  By the way, when using the <code>setup</code> module, you can specify <code>*</code> in the <code>filter=</code> expression.  As in the shell. </p><br><h2>  Choice of hosts </h2><br><p>  We have seen that <code>all</code> means "all hosts", but in Ansible there is <br>  <a href="http://ansible.cc/docs/patterns.html">A bunch of other ways to choose hosts</a> : </p><br><ul><li>  <code>host0.example.org:host1.example.org</code> will run on host0.example.org and <br>  host1.example.org </li><li>  <code>host*.example.org</code> will be run on all hosts whose names begin with 'host' and end with '.example.org' (also in the shell) </li></ul><br><h1>  Host grouping </h1><br><p>  Hosts in inventory can be grouped.  For example, you can create a <code>debian</code> group, a <code>web-servers</code> group, a <code>production</code> group, and so on. </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[debian]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span></code> </pre> <br><p>  You can even cut: </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[debian]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[0-2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span></code> </pre> <br><p>  If you want to set up child groups, use <code>[groupname:children]</code> and add child groups to it.  For example, we have different Linux distributions, they can be organized as follows: </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[ubuntu]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[debian]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">[1-2]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[linux:children]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ubuntu</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">debian</span></span></code> </pre> <br><h1>  Setting variables </h1><br><p>  You can add variables for hosts in several places: in the inventory file, host variable files, group variable files, etc. </p><br><p>  Usually I set all the variables in the files of the group / host variables (more on this later).  However, I often use variables directly in the inventory file, for example, <code>ansible_ssh_host</code> , which specifies the IP address of the host.  By default, Ansible rezolvit host names when connecting over SSH.  But when you initialize a host, it may not have an IP address yet.  <code>ansible_ssh_host</code> will be useful in this case. </p><br><p>  When using the <code>ansible-playbook</code> command (and not the usual <code>ansible</code> ), variables can be set using the - <code>--extra-vars</code> (or <code>-e</code> ) flag.  We'll talk about the <code>ansible-playbook</code> team in the next step. </p><br><p>  <code>ansible_ssh_port</code> , as you might have guessed, is used to specify an SSH connection port. </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">ubuntu</span></span>] host0.example.org ansible_ssh_host=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> ansible_ssh_port=<span class="hljs-number"><span class="hljs-number">2222</span></span></code> </pre> <br><p>  Ansible searches for additional variables in variable group and host files.  It will search for these files in the <code>group_vars</code> and <code>host_vars</code> directories, inside the directory where the main inventory file is located. </p><br><p>  Ansible will search for files by name.  For example, when using the inventory file mentioned earlier, Ansible will search for <code>host0.example.org</code> variables in the files: </p><br><ul><li> <code>group_vars/linux</code> </li> <li> <code>group_vars/ubuntu</code> </li> <li> <code>host_vars/host0.example.org</code> </li> </ul><br><p>  If these files do not exist, nothing will happen, but if they exist, they will be used. </p><br><p>  Now that we have learned about modules, inventory, and variables, let's finally find out about the real power of Ansible with playbooks. </p><br><h1>  Ansible Playbooks </h1><br><p>  The concept of playbooks is very simple: it's just a set of Ansible commands (tasks, tasks), similar to those that we did with the <code>ansible</code> utility.  These tasks are aimed at specific sets of nodes / groups. </p><br><h2>  Example with Apache (aka "Hello World!" In Ansible) </h2><br><p>  We continue with the assumption that your inventory file looks like this (let's call it <code>hosts</code> ): </p><br><pre> <code class="hljs css"><span class="hljs-selector-attr"><span class="hljs-selector-attr">[web]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span></code> </pre> <br><p>  and all hosts are Debian based systems. </p><br><p>  Note: remember that you can (and in our exercise we are doing this) use <code>ansible_ssh_host</code> to set the real IP address of the host.  You can also change inventory and use a real hostname.  In any case, use the machine with which it is safe to experiment.  On real hosts, we also add <code>ansible_ssh_user=root</code> to avoid potential problems with different default configurations. </p><br><p>  Let's build a playbook that installs Apache on <code>web</code> group machines. </p><br><pre> <code class="hljs pgsql">- hosts: web tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Installs apache web <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> apt: pkg=apache2 state=installed update_cache=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span></code> </pre> <br><p>  We just need to say what we want to do using the correct Ansible modules.  Here we use the <a href="http://ansible.cc/docs/modules.html">apt</a> module, which can install Debian packages.  We also ask this module to update the cache. </p><br><p>  We need a name for this task.  This is not necessary, but desirable for your own convenience. </p><br><p>  Well, overall it was pretty easy!  Now you can start the playbook (let's call it <code>apache.yml</code> ): </p><br><pre> <code class="hljs vbscript">ansible-playbook -i <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span>/hosts -l host1.example.org <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span>/apache.yml</code> </pre> <br><p>  Here <code>step-04/hosts</code> is the inventory file, <code>-l</code> limits the launch to <code>host1.example.org</code> , <br>  and <code>apache.yml</code> is our playbook. </p><br><p>  When you run the command, there will be an output similar to this: </p><br><pre> <code class="hljs markdown">PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] TASK: [Installs apache web server] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] PLAY RECAP *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> host1.example.org : ok=2 changed=1 unreachable=0 failed=0</code> </pre> <br><p>  Note: you may notice a cow passing by, if you have <code>cowsay</code> installed :-) If you don't like it, you can disable it like this: <code>export ANSIBLE_NOCOWS="1"</code> . </p><br><p>  Let's analyze the output line by line. </p><br><pre> <code class="hljs markdown">PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>*</code> </pre> <br><p>  Ansible tells us that play is in the <code>web</code> group.  Play is a set of Ansible instructions related to the host.  If we had another <code>-host: blah</code> in the playbook, it would also be outputted (but after the first play is completed). </p><br><pre> <code class="hljs markdown">GATHERING FACTS <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* ok: [host1.example.org]</code> </pre> <br><p>  Remember when we used the <code>setup</code> module?  Before each playback, Ansible runs it on each host and collects the facts.  If this is not required (say, because you do not need any information about the host), you can add <code>gather_facts: no</code> under the host line (at the same level as the <code>tasks:</code> . </p><br><pre> <code class="hljs markdown">TASK: [Installs apache web server] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* changed: [host1.example.org]</code> </pre> <br><p>  Now the most important thing: our first and only task is running, and since it says <code>changed</code> , we know that it has changed something on <code>host1.example.org</code> . </p><br><pre> <code class="hljs markdown">PLAY RECAP <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* host1.example.org : ok=2 changed=1 unreachable=0 failed=0</code> </pre> <br><p>  Finally, Ansible displays a squeeze of what happened: two tasks were performed, and one of them changed something on the host (this was our apache task; the setup module changes nothing). </p><br><p>  Let's run it again and see what happens: </p><br><pre> <code class="hljs markdown">$ ansible-playbook -i step-04/hosts -l host1.example.org step-04/apache.yml PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] TASK: [Installs apache web server] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] PLAY RECAP *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> host1.example.org : ok=2 changed=0 unreachable=0 failed=0</code> </pre> <br><p>  Now changed is '0'.  This is completely normal and is one of the main features of Ansible: a playbook will do something only if there is something to do.  This is called <em>idempotency</em> .  This means that you can run a playbook as many times as you like, but in the end we will have the machine in the same state (well, only if you are not going crazy with the <code>shell</code> module, but here Ansible cannot do anything about it). </p><br><h1>  Improving apache set </h1><br><p>  We have installed apache, now let's configure virtualhost. </p><br><h2>  Playbook Upgrade </h2><br><p>  We need only one virtual host on the server, but we want to change the default one to something more specific.  Therefore, we will have to delete the current virtualhost, send our virtualhost, activate it and restart apache. </p><br><p>  Let's create a directory called <code>files</code> and add our configuration for host1.example.org, let's call it <code>awesome-app</code> : </p><br><pre> <code class="hljs pgsql">&lt;VirtualHost *:<span class="hljs-number"><span class="hljs-number">80</span></span>&gt; DocumentRoot /var/www/awesome-app <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> -Indexes ErrorLog /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/apache2/error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> TransferLog /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/apache2/<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> &lt;/VirtualHost&gt;</code> </pre> <br><p>  Now a small resetting of the playbook and everything is ready: </p><br><pre> <code class="hljs pgsql">- hosts: web tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Installs apache web <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> apt: pkg=apache2 state=installed update_cache=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Push <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtual host <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>: src=files/awesome-app dest=/etc/apache2/sites-available/ mode=<span class="hljs-number"><span class="hljs-number">0640</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ssl virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl - <span class="hljs-type"><span class="hljs-type">name</span></span>: Activates our virtualhost command: a2ensite awesome-app <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache handlers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache service: <span class="hljs-type"><span class="hljs-type">name</span></span>=apache2 state=restarted</code> </pre> <br><p>  Go: </p><br><pre> <code class="hljs markdown">$ ansible-playbook -i step-05/hosts -l host1.example.org step-05/apache.yml PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] TASK: [Installs apache web server] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] TASK: [Push default virtual host configuration] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] TASK: [Deactivates the default virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] TASK: [Deactivates the default ssl virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] TASK: [Activates our virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] NOTIFIED: [restart apache] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] PLAY RECAP <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* host1.example.org : ok=7 changed=5 unreachable=0 failed=0</code> </pre> <br><p>  Cool!  Well, if you think about it, we are a little ahead of the events.  Is it not necessary to check the configuration correctness before restarting apache?  In order not to disrupt the service in case the configuration contains an error. </p><br><h1>  Restart in case of configuration error </h1><br><p>  We installed apache, changed virtualhost and restarted the server.  But what if we only want to restart the server when the configuration is correct? </p><br><h2>  Roll back if there are problems </h2><br><p>  Ansible contains a cool feature: it will stop all processing if something goes wrong.  We use this feature to stop the playbook when the configuration is not valid. </p><br><p>  Let's change the <code>awesome-app</code> virtual host configuration file and break it: </p><br><pre> <code class="hljs pgsql"> &lt;VirtualHost *:<span class="hljs-number"><span class="hljs-number">80</span></span>&gt; RocumentDoot /var/www/awesome-app <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> -Indexes ErrorLog /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/apache2/error.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> TransferLog /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/apache2/<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> &lt;/VirtualHost&gt;</code> </pre> <br><p>  As I said, if the task cannot be completed, the processing stops.  So you need to make sure that the configuration is valid before restarting the server.  We will also start by adding a virtual host <em>before</em> removing the default virtual host, so a subsequent restart (perhaps done directly on the server) will not break apache. </p><br><p>  It was necessary to do it at the very beginning.  Since we have already launched this playbook, the default virtual host has already been deactivated.  No problem: this playbook can be used on other innocent hosts, so let's protect them. </p><br><pre> <code class="hljs pgsql">- hosts: web tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Installs apache web <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> apt: pkg=apache2 state=installed update_cache=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Push future <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtual host <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>: src=files/awesome-app dest=/etc/apache2/sites-available/ mode=<span class="hljs-number"><span class="hljs-number">0640</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Activates our virtualhost command: a2ensite awesome-app - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> that our config <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span> command: apache2ctl configtest - <span class="hljs-type"><span class="hljs-type">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ssl virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache handlers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache service: <span class="hljs-type"><span class="hljs-type">name</span></span>=apache2 state=restarted</code> </pre> <br><p>  Go: </p><br><pre> <code class="hljs pgsql">$ ansible-playbook -i step<span class="hljs-number"><span class="hljs-number">-06</span></span>/hosts -l host1.example.org step<span class="hljs-number"><span class="hljs-number">-06</span></span>/apache.yml PLAY [web] ********************* GATHERING FACTS ********************* ok: [host1.example.org] TASK: [Installs apache web <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>] ********************* ok: [host1.example.org] TASK: [Push future <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtual host <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span>] ********************* changed: [host1.example.org] TASK: [Activates our virtualhost] ********************* changed: [host1.example.org] TASK: [<span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> that our config <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span>] ********************* failed: [host1.example.org] =&gt; {"changed": <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, "cmd": ["apache2ctl", "configtest"], "delta": "0:00:00.045046", "end": "2013-03-08 16:09:32.002063", "rc": <span class="hljs-number"><span class="hljs-number">1</span></span>, "start": "2013-03-08 16:09:31.957017"} stderr: Syntax error <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-type"><span class="hljs-type">line</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> /etc/apache2/sites-enabled/awesome-app: Invalid command <span class="hljs-string"><span class="hljs-string">'RocumentDoot'</span></span>, perhaps misspelled <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> defined <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> a module <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> included <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> stdout: Action <span class="hljs-string"><span class="hljs-string">'configtest'</span></span> failed. The Apache error <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> may have more information. FATAL: <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> hosts have already failed <span class="hljs-comment"><span class="hljs-comment">-- aborting PLAY RECAP ********************* host1.example.org : ok=4 changed=2 unreachable=0 failed=1</span></span></code> </pre> <br><p>  As you noticed, <code>apache2ctl</code> returns error code 1. Ansible sees this and stops working.  Fine! </p><br><p>  Hmmm, no, not great ... Our virtual host was added anyway.  Any subsequent attempt to restart Apache will swear on the configuration on and off.  So we need a way to catch errors and return to a working state. </p><br><p>  <em>(comment: translation: habrauser <a href="https://habrahabr.ru/users/clickfreak/">@clickfreak</a> in the comments <a href="https://habrahabr.ru/post/305400/">suggests</a> looking at the special <a href="http://docs.ansible.com/ansible/playbooks_blocks.html">feature</a> Ansible 2.x).</em> </p><br><h1>  Use of conditions </h1><br><p>  We installed Apache, added a virtual host, and restarted the server.  But we want to return to working condition if something went wrong. </p><br><h2>  Return in case of problems </h2><br><p>  There is no magic here.  The past mistake is not Ansible's fault.  This is not a backup system, and it does not know how to deny everything to past states.  Playbook security is your responsibility.  Ansible just doesn't know how to undo the <code>a2ensite awesome-app</code> effect. </p><br><p>  As mentioned earlier, if the task cannot be completed - the processing stops ... but we can accept an error (and we <a href="http://www.aaronsw.com/weblog/geremiah">need to do it</a> ).  So we will do: continue processing in case of an error, but only to return everything to the working state. </p><br><pre> <code class="hljs pgsql">- hosts: web tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Installs apache web <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> apt: pkg=apache2 state=installed update_cache=<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Push future <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtual host <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span>: src=files/awesome-app dest=/etc/apache2/sites-available/ mode=<span class="hljs-number"><span class="hljs-number">0640</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Activates our virtualhost command: a2ensite awesome-app - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> that our config <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">valid</span></span> command: apache2ctl configtest register: result ignore_errors: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Rolling back - Restoring <span class="hljs-built_in"><span class="hljs-built_in">old</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtualhost command: a2ensite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: result|failed - <span class="hljs-type"><span class="hljs-type">name</span></span>: Rolling back - Removing our virtualhost command: a2dissite awesome-app <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: result|failed - <span class="hljs-type"><span class="hljs-type">name</span></span>: Rolling back - Ending playbook fail: msg="Configuration file is not valid. Please check that before re-running the playbook." <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: result|failed - <span class="hljs-type"><span class="hljs-type">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ssl virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache handlers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache service: <span class="hljs-type"><span class="hljs-type">name</span></span>=apache2 state=restarted</code> </pre> <br><p>  The <code>register</code> keyword records the output of the <code>apache2ctl configtest</code> command (exit <br>  status, stdout, stderr, ...), and <code>when: result|failed</code> checks if the variable contains <br>  ( <code>result</code> ) status failed. </p><br><p>  Go: </p><br><pre> <code class="hljs markdown">$ ansible-playbook -i step-07/hosts -l host1.example.org step-07/apache.yml PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] TASK: [Installs apache web server] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] TASK: [Push future default virtual host configuration] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] TASK: [Activates our virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] TASK: [Check that our config is valid] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> failed: [host1.example.org] =&gt; {"changed": true, "cmd": ["apache2ctl", "configtest"], "delta": "0:00:00.051874", "end": "2013-03-10 10:50:17.714105", "rc": 1, "start": "2013-03-10 10:50:17.662231"} stderr: Syntax error on line 2 of /etc/apache2/sites-enabled/awesome-app: Invalid command 'RocumentDoot', perhaps misspelled or defined by a module not included in the server configuration stdout: Action 'configtest' failed. The Apache error log may have more information. ...ignoring TASK: [Rolling back - Restoring old default virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] TASK: [Rolling back - Removing our virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] TASK: [Rolling back - Ending playbook] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* failed: [host1.example.org] =&gt; {"failed": true} msg: Configuration file is not valid. Please check that before re-running the playbook. FATAL: all hosts have already failed -- aborting PLAY RECAP *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> host1.example.org : ok=7 changed=4 unreachable=0 failed=1</code> </pre> <br><p>  It seems everything works as it should.  Let's try restarting apache: </p><br><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$ </span></span>ansible -i step<span class="hljs-number"><span class="hljs-number">-07</span></span>/hosts -m service -a <span class="hljs-string"><span class="hljs-string">'name=apache2 state=restarted'</span></span> host1.example.org host1.example.org | success &gt;&gt; { <span class="hljs-comment"><span class="hljs-comment">"changed"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-comment"><span class="hljs-comment">"name"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"apache2"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"state"</span></span>: <span class="hljs-comment"><span class="hljs-comment">"started"</span></span> }</code> </pre> <br><p>  Now our Apache is protected from configuration errors.  Remember, variables can be used almost everywhere, so this playbook can be used for apache and in other cases.  Write once and use everywhere. </p><br><h1>  Deploy a site with Git </h1><br><p>  We installed Apache, added a virtual host, and restarted the server safely.     git    . </p><br><h2>  git </h2><br><p> ,  ,    ,  .  <code>git</code>     .    - .    ,      <code>ansible-pull</code> . </p><br><p>   ,         .     PHP,      <code>libapache2-mod-php5</code> .     <code>git</code> ,  , ,  git   . </p><br><p>   : </p><br><pre> <code class="hljs delphi"> ... - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Installs apache web server apt: pkg=apache2 state=installed update_cache=true - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Installs php5 module apt: pkg=libapache2-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-php5 state=installed - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Installs git apt: pkg=git state=installed ...</code> </pre> <br><p>   Ansible   .            ,  : </p><br><pre> <code class="hljs sql">- hosts: web tasks: - name: Updates apt <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> apt: update_cache=<span class="hljs-literal"><span class="hljs-literal">true</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Installs necessary packages apt: pkg={{ item }} state=latest with_items: - apache2 - libapache2-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-php5 - git - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Push future <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> host configuration copy: src=files/awesome-app dest=/etc/apache2/sites-available/ <span class="hljs-keyword"><span class="hljs-keyword">mode</span></span>=<span class="hljs-number"><span class="hljs-number">0640</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Activates our virtualhost command: a2ensite awesome-app - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Check</span></span> that our config <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> valid command: apache2ctl configtest <span class="hljs-keyword"><span class="hljs-keyword">register</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">result</span></span> ignore_errors: <span class="hljs-literal"><span class="hljs-literal">True</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Rolling</span></span> back - Restoring <span class="hljs-keyword"><span class="hljs-keyword">old</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtualhost command: a2ensite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">result</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">failed</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Rolling</span></span> back - Removing <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> virtualhost command: a2dissite awesome-app <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">result</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">failed</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Rolling</span></span> back - Ending playbook fail: msg=<span class="hljs-string"><span class="hljs-string">"Configuration file is not valid. Please check that before re-running the playbook."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">result</span></span>|<span class="hljs-keyword"><span class="hljs-keyword">failed</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Deploy our awesome application git: repo=https://github.com/leucos/ansible-tuto-demosite.git dest=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/awesome-app tags: deploy - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ssl virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl notify: - restart apache handlers: - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: restart apache service: <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>=apache2 state=restarted</code> </pre> <br><p> : </p><br><pre> <code class="hljs markdown">$ ansible-playbook -i step-08/hosts -l host1.example.org step-08/apache.yml PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] TASK: [Updates apt cache] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] TASK: [Installs necessary packages] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] =&gt; (item=apache2,libapache2-mod-php5,git) TASK: [Push future default virtual host configuration] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] TASK: [Activates our virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] TASK: [Check that our config is valid] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] TASK: [Rolling back - Restoring old default virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> skipping: [host1.example.org] TASK: [Rolling back - Removing out virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* skipping: [host1.example.org] TASK: [Rolling back - Ending playbook] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> skipping: [host1.example.org] TASK: [Deploy our awesome application] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] TASK: [Deactivates the default virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] TASK: [Deactivates the default ssl virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] NOTIFIED: [restart apache] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] PLAY RECAP <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* host1.example.org : ok=10 changed=8 unreachable=0 failed=0</code> </pre> <br><p>     <a href="http://192.168.33.11/">http://192.168.33.11</a>      . </p><br><p>  <code>tags: deploy</code>     . ,     .         ,    .      . , "deploy" ‚Äî   ,   .  ,    : </p><br><p> $ ansible-playbook -i step-08/hosts -l host1.example.org step-08/apache.yml -t deploy <br> X11 forwarding request failed on channel 0 </p><br><p> PLAY [web] * <strong><strong><strong><strong>****</strong></strong></strong></strong> </p><br><p> GATHERING FACTS * <strong><strong><strong><strong>****</strong></strong></strong></strong> <br> ok: [host1.example.org] </p><br><p> TASK: [Deploy our awesome application] * <strong><strong><strong><strong>****</strong></strong></strong></strong> <br> changed: [host1.example.org] </p><br><p> PLAY RECAP * <strong><strong><strong><strong>****</strong></strong></strong></strong> <br> host1.example.org: ok=2 changed=1 unreachable=0 failed=0 </p><br><h1>    - </h1><br><p>     -.   . </p><br><h2>  inventory </h2><br><p>    ,       -  ,      .    inventory: </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">web</span></span>] host1.example.org ansible_ssh_host=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.33</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span> ansible_ssh_user=root host2.example.org ansible_ssh_host=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.33</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span> ansible_ssh_user=root [haproxy] host0.example.org ansible_ssh_host=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.33</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> ansible_ssh_user=root</code> </pre> <br><p> ,    <code>ansible_ssh_host</code>       IP,  .        <code>/etc/hosts</code>     (       ). </p><br><h2>   - </h2><br><p>      .     : </p><br><pre> <code class="hljs markdown">$ ansible-playbook -i step-09/hosts step-09/apache.yml PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host2.example.org] ok: [host1.example.org] TASK: [Updates apt cache] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] ok: [host2.example.org] TASK: [Installs necessary packages] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] =&gt; (item=apache2,libapache2-mod-php5,git) changed: [host2.example.org] =&gt; (item=apache2,libapache2-mod-php5,git) TASK: [Push future default virtual host configuration] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] changed: [host2.example.org] TASK: [Activates our virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host2.example.org] changed: [host1.example.org] TASK: [Check that our config is valid] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host2.example.org] changed: [host1.example.org] TASK: [Rolling back - Restoring old default virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> skipping: [host1.example.org] skipping: [host2.example.org] TASK: [Rolling back - Removing out virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* skipping: [host1.example.org] skipping: [host2.example.org] TASK: [Rolling back - Ending playbook] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> skipping: [host1.example.org] skipping: [host2.example.org] TASK: [Deploy our awesome application] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] changed: [host2.example.org] TASK: [Deactivates the default virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] changed: [host2.example.org] TASK: [Deactivates the default ssl virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host2.example.org] changed: [host1.example.org] NOTIFIED: [restart apache] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] changed: [host2.example.org] PLAY RECAP <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>* host1.example.org : ok=10 changed=5 unreachable=0 failed=0 host2.example.org : ok=10 changed=8 unreachable=0 failed=0</code> </pre> <br><p> ,  ,   <code>-l host1.example.org</code>   . , <code>-l</code>     .    ,        <code>web</code> . </p><br><p>     <code>web</code>   ,            ,    , , : <code>-l firsthost:secondhost:...</code> . </p><br><p>       -,         . </p><br><h1>  Templates </h1><br><p>    <code>haproxy</code>   .   ,   apache.    ,        -   <code>haproxy</code> .  How to do it? </p><br><h2>   HAProxy </h2><br><p> Ansible  <a href="http://jinja.pocoo.org/docs/">Jinja2</a> ,    Python.  Jinja2-    ,   Ansible'. </p><br><p> ,      inventory_name ,    ,     <code>{{ inventory_hostname }}</code>  Jinja2-. ,    IP-  ethernet- (  Ansible    <code>setup</code> ),    <code>{{ ansible_eth1['ipv4']['address'] }}</code> . </p><br><p> Jinja2   ,   . </p><br><p>    <code>templates/</code>  Jinja- .   <code>haproxy.cfg.j2</code> .  <code>.j2</code>    ,   . </p><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> daemon maxconn <span class="hljs-number"><span class="hljs-number">256</span></span> defaults mode http timeout connect <span class="hljs-number"><span class="hljs-number">5000</span></span>ms timeout client <span class="hljs-number"><span class="hljs-number">50000</span></span>ms timeout server <span class="hljs-number"><span class="hljs-number">50000</span></span>ms listen <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> bind {{ ansible_eth1[<span class="hljs-string"><span class="hljs-string">'ipv4'</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>] }}:<span class="hljs-number"><span class="hljs-number">80</span></span> mode http stats enable balance roundrobin {% <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> backend <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> groups[<span class="hljs-string"><span class="hljs-string">'web'</span></span>] %} server {{ hostvars[backend][<span class="hljs-string"><span class="hljs-string">'ansible_hostname'</span></span>] }} {{ hostvars[backend][<span class="hljs-string"><span class="hljs-string">'ansible_eth1'</span></span>][<span class="hljs-string"><span class="hljs-string">'ipv4'</span></span>][<span class="hljs-string"><span class="hljs-string">'address'</span></span>] }} check port <span class="hljs-number"><span class="hljs-number">80</span></span> {% endfor %} option httpchk HEAD /index.php HTTP/<span class="hljs-number"><span class="hljs-number">1.0</span></span></code> </pre> <br><p>       . </p><br><p> -, <code>{{ ansible_eth1['ipv4']['address'] }}</code>   IP    eth1. </p><br><p>     .      -.         <code>[web]</code> ,         <code>backend</code> .           .       <code>hostvars</code> ,    (,    IP,    )     . </p><br><p>      ,     .   ,       .  ,           <code>[web]</code> . </p><br><h2> HAProxy playbook </h2><br><p>  The hardest thing behind.       HAproxy  : </p><br><pre> <code class="hljs pgsql">- hosts: haproxy tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Installs haproxy <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> balancer apt: pkg=haproxy state=installed update_cache=yes - <span class="hljs-type"><span class="hljs-type">name</span></span>: Pushes <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: src=templates/haproxy.cfg.j2 dest=/etc/haproxy/haproxy.cfg mode=<span class="hljs-number"><span class="hljs-number">0640</span></span> owner=root <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=root <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> haproxy - <span class="hljs-type"><span class="hljs-type">name</span></span>: Sets <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> starting flag <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> lineinfile: dest=/etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/haproxy regexp="^ENABLED" <span class="hljs-type"><span class="hljs-type">line</span></span>="ENABLED=1" <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> haproxy handlers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> haproxy service: <span class="hljs-type"><span class="hljs-type">name</span></span>=haproxy state=restarted</code> </pre> <br><p>  , ?     : <code>template</code> .     ,   <code>copy</code> .        <code>haproxy</code> . </p><br><p>  ‚Ä¶ .   inventory      ,             . ,   ,     ,   haproxy-   <em></em>  -.    ,   . </p><br><pre> <code class="hljs markdown">$ ansible-playbook -i step-10/hosts step-10/apache.yml step-10/haproxy.yml PLAY [web] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* GATHERING FACTS *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] ok: [host2.example.org] TASK: [Updates apt cache] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host1.example.org] ok: [host2.example.org] TASK: [Installs necessary packages] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> ok: [host1.example.org] =&gt; (item=apache2,libapache2-mod-php5,git) ok: [host2.example.org] =&gt; (item=apache2,libapache2-mod-php5,git) TASK: [Push future default virtual host configuration] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host2.example.org] ok: [host1.example.org] TASK: [Activates our virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] changed: [host2.example.org] TASK: [Check that our config is valid] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host1.example.org] changed: [host2.example.org] TASK: [Rolling back - Restoring old default virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> skipping: [host1.example.org] skipping: [host2.example.org] TASK: [Rolling back - Removing out virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* skipping: [host1.example.org] skipping: [host2.example.org] TASK: [Rolling back - Ending playbook] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> skipping: [host1.example.org] skipping: [host2.example.org] TASK: [Deploy our awesome application] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host2.example.org] ok: [host1.example.org] TASK: [Deactivates the default virtualhost] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host1.example.org] changed: [host2.example.org] TASK: [Deactivates the default ssl virtualhost] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host2.example.org] changed: [host1.example.org] NOTIFIED: [restart apache] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host2.example.org] changed: [host1.example.org] PLAY RECAP <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* host1.example.org : ok=10 changed=5 unreachable=0 failed=0 host2.example.org : ok=10 changed=5 unreachable=0 failed=0 PLAY [haproxy] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> GATHERING FACTS <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ok: [host0.example.org] TASK: [Installs haproxy load balancer] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host0.example.org] TASK: [Pushes configuration] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host0.example.org] TASK: [Sets default starting flag to 1] *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> changed: [host0.example.org] NOTIFIED: [restart haproxy] <span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* changed: [host0.example.org] PLAY RECAP *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> host0.example.org : ok=5 changed=4 unreachable=0 failed=0</code> </pre> <br><p>   .   <a href="http://192.168.33.10/">http://192.168.33.10/</a>   .  !      HAproxy: <a href="http://192.168.33.10/haproxy%3Fstats">http://192.168.33.10/haproxy?stats</a> . </p><br><h1>   </h1><br><p> ,    ,    .           . </p><br><p> Ansible     .    <code>ansible_ssh_host</code>   inventory,    ,     <code>host_vars</code>  <code>group_vars</code> . </p><br><h2>    HAProxy </h2><br><p>  HAProxy ,   .    ,     ,  HAProxy     . </p><br><p>       ( 0  256).   ,          .  ,             . </p><br><p>       . </p><br><h2> Group- </h2><br><p>   haproxy     group_vars.  ,   haproxy  . </p><br><p>    <code>group_vars/haproxy</code>   inventory.       ,    .        web,     <code>group_vars/web</code> . </p><br><pre> <code class="hljs javascript">haproxy_check_interval: <span class="hljs-number"><span class="hljs-number">3000</span></span> haproxy_stats_socket: <span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>sock</code> </pre> <br><p>     . ,    ,  -   .      (  Python dict)  : </p><br><pre> <code class="hljs javascript">haproxy: check_interval: <span class="hljs-number"><span class="hljs-number">3000</span></span> stats_socket: <span class="hljs-regexp"><span class="hljs-regexp">/tmp/</span></span>sock</code> </pre> <br><p>  It's a matter of taste.      .      . </p><br><h2>   </h2><br><p>      ,      <code>host_vars</code> .      <code>host_vars/host1.example.com</code> : </p><br><pre> <code class="hljs">haproxy_backend_weight: 100</code> </pre> <br><p>   <code>host_vars/host2.example.com</code> : </p><br><pre> <code class="hljs">haproxy_backend_weight: 150</code> </pre> <br><p>     <code>haproxy_backend_weight</code>  <code>group_vars/web</code> ,     -: <br>    <code>host_vars</code>      <code>group_vars</code> . </p><br><h2>   </h2><br><p>    ,     . </p><br><pre> <code class="hljs markdown">global daemon maxconn 256 {% if haproxy<span class="hljs-emphasis"><span class="hljs-emphasis">_stats_</span></span>socket %} stats socket {{ haproxy<span class="hljs-emphasis"><span class="hljs-emphasis">_stats_</span></span>socket }} {% endif %} defaults mode http timeout connect 5000ms timeout client 50000ms timeout server 50000ms listen cluster bind {{ ansible<span class="hljs-emphasis"><span class="hljs-emphasis">_eth1['ipv4']['address'] }}:80 mode http stats enable balance roundrobin {% for backend in groups['web'] %} server {{ hostvars[backend]['ansible_</span></span>hostname'] }} {{ hostvars[<span class="hljs-string"><span class="hljs-string">backend</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">'ansible_eth1'</span></span>][<span class="hljs-string"><span class="hljs-string">'ipv4'</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">'address'</span></span>] }} check inter {{ haproxy<span class="hljs-emphasis"><span class="hljs-emphasis">_check_</span></span>interval }} weight {{ hostvars[<span class="hljs-string"><span class="hljs-string">backend</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">'haproxy_backend_weight'</span></span>] }} port 80 {% endfor %} option httpchk HEAD /index.php HTTP/1.0</code> </pre> <br><p>   <code>{% if ...</code> ?    ,   .  ,   -  <code>haproxy_stats_socket</code>    (   <code>--extra-vars="haproxy_stats_sockets=/tmp/sock"</code>     ),        . </p><br><p>  ,         ! </p><br><p> : </p><br><pre> <code class="hljs vbscript">ansible-playbook -i <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>/hosts <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>/haproxy.yml</code> </pre> <br><p>  ,      apache,     .     .    haproxy: </p><br><pre> <code class="hljs pgsql">- hosts: web - hosts: haproxy tasks: - <span class="hljs-type"><span class="hljs-type">name</span></span>: Installs haproxy <span class="hljs-keyword"><span class="hljs-keyword">load</span></span> balancer apt: pkg=haproxy state=installed update_cache=yes - <span class="hljs-type"><span class="hljs-type">name</span></span>: Pushes <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: src=templates/haproxy.cfg.j2 dest=/etc/haproxy/haproxy.cfg mode=<span class="hljs-number"><span class="hljs-number">0640</span></span> owner=root <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=root <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> haproxy - <span class="hljs-type"><span class="hljs-type">name</span></span>: Sets <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> starting flag <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> lineinfile: dest=/etc/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/haproxy regexp="^ENABLED" <span class="hljs-type"><span class="hljs-type">line</span></span>="ENABLED=1" <span class="hljs-keyword"><span class="hljs-keyword">notify</span></span>: - <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> haproxy handlers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> haproxy service: <span class="hljs-type"><span class="hljs-type">name</span></span>=haproxy state=restarted</code> </pre> <br><p>  Do you see?      -   .     .      Ansible     <code>web</code> .  ,    haproxy     .    ,  Ansible  ,   <code>ansible_eth1</code>  . </p><br><h1>   ! </h1><br><p> ,    ,   !     .  ‚Äî       ,       .     ,     <br> <a href="http://www.ansibleworks.com/docs/playbooks_roles.html"> Ansible</a> .    ‚Äî   :  B      A.     B,     A. </p><br><h2>   </h2><br><p>    ¬´¬ª  Ansible:     .     ,        .   ,   ,       .       .    "convention over configuration". </p><br><p>     : </p><br><pre> <code class="hljs ruby">roles <span class="hljs-params"><span class="hljs-params">| |</span></span>_some_role <span class="hljs-params"><span class="hljs-params">| |</span></span>_files <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>_file1 <span class="hljs-params"><span class="hljs-params">| |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span>... <span class="hljs-params"><span class="hljs-params">| |</span></span>_templates <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>_template1.j2 <span class="hljs-params"><span class="hljs-params">| |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span>... <span class="hljs-params"><span class="hljs-params">| |</span></span>_tasks <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>_main.yml <span class="hljs-params"><span class="hljs-params">| |</span></span>_some_other_file.yml <span class="hljs-params"><span class="hljs-params">| |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span> ... <span class="hljs-params"><span class="hljs-params">| |</span></span>_handlers <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>_main.yml <span class="hljs-params"><span class="hljs-params">| |</span></span>_some_other_file.yml <span class="hljs-params"><span class="hljs-params">| |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span> ... <span class="hljs-params"><span class="hljs-params">| |</span></span>_vars <span class="hljs-params"><span class="hljs-params">| |</span></span> <span class="hljs-params"><span class="hljs-params">| |</span></span>_main.yml <span class="hljs-params"><span class="hljs-params">| |</span></span>_some_other_file.yml <span class="hljs-params"><span class="hljs-params">| |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span> ... <span class="hljs-params"><span class="hljs-params">| |</span></span>_meta <span class="hljs-params"><span class="hljs-params">| |</span></span>_main.yml <span class="hljs-params"><span class="hljs-params">|_some_other_file.yml |</span></span><span class="hljs-number"><span class="hljs-number">_</span></span> ...</code> </pre> <br><p>  Pretty simple. </p><br><p>  <code>main.yml</code>  .    ,       .          . </p><br><p>     <code>vars</code>  <code>meta</code> . <code>vars</code>   ,    ,   .            .  ,      ,   ‚Äî  .  ,    ,   ‚Äî   .     ¬´¬ª (, )    .              .     . Ansible   . </p><br><p>   <code>meta</code>  ,       .     <code>roles</code> . </p><br><h2>   Apache </h2><br><p>     ,     apache    . </p><br><p>   : </p><br><ul><li>       apache </li><li>   apache   <code>roles/apache/handlers/main.yml</code> </li><li>    apache <code>awesome-app</code>  <code>roles/apache/files/</code> </li><li>     </li></ul><br><h3>   </h3><br><p>  It's simple: </p><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> -p step-<span class="hljs-number"><span class="hljs-number">12</span></span>/roles/apache/{tasks,handlers,files}</code> </pre> <br><p>     <code>apache.yml</code>  <code>main.yml</code> .   : </p><br><pre> <code class="hljs sql">- name: Updates apt <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> apt: update_cache=<span class="hljs-literal"><span class="hljs-literal">true</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Installs necessary packages apt: pkg={{ item }} state=latest with_items: - apache2 - libapache2-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-php5 - git ... - <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: Deactivates the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> ssl virtualhost command: a2dissite <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-ssl notify: - restart apache</code> </pre> <br><p>     ,   .      <br> <code>apache.yml</code>  <code>tasks:</code>  <code>handlers:</code> . </p><br><p>       <code>files/</code>  <code>templates/</code>  .      , Ansible  ,    . </p><br><h3>   </h3><br><p>    <code>step-12/roles/apache/handlers/main.yml</code> : </p><br><pre> <code class="hljs pgsql">- <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> apache service: <span class="hljs-type"><span class="hljs-type">name</span></span>=apache2 state=restarted</code> </pre> <br><h3>    </h3><br><p>  : </p><br><pre> <code class="hljs vbscript">cp <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>/files/awesome-app <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/roles/apache/files/</code> </pre> <br><p>  apache .      . </p><br><h3>    </h3><br><p>             .   <code>site.yml</code> ,       .    <code>haproxy</code> : </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hosts</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">web</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">roles</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">role</span></span>: apache } <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hosts</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">haproxy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">roles</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">role</span></span>: haproxy }</code> </pre> <br><p>   .     haproxy: </p><br><pre> <code class="hljs vbscript">mkdir -p <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/roles/haproxy/{tasks,handlers,templates} cp <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-11</span></span>/templates/haproxy.cfg.j2 <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/roles/haproxy/templates/</code> </pre> <br><p>       <code>templates/</code> . </p><br><p> ?: </p><br><pre> <code class="hljs vbscript">ansible-playbook -i <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/hosts <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/site.yml</code> </pre> <br><p>   ,    "PLAY RECAP": </p><br><pre> <code class="hljs erlang-repl">host0.example.org : ok=<span class="hljs-number"><span class="hljs-number">5</span></span> changed=<span class="hljs-number"><span class="hljs-number">2</span></span> unreachable=<span class="hljs-number"><span class="hljs-number">0</span></span> failed=<span class="hljs-number"><span class="hljs-number">0</span></span> host1.example.org : ok=<span class="hljs-number"><span class="hljs-number">10</span></span> changed=<span class="hljs-number"><span class="hljs-number">5</span></span> unreachable=<span class="hljs-number"><span class="hljs-number">0</span></span> failed=<span class="hljs-number"><span class="hljs-number">0</span></span> host2.example.org : ok=<span class="hljs-number"><span class="hljs-number">10</span></span> changed=<span class="hljs-number"><span class="hljs-number">5</span></span> unreachable=<span class="hljs-number"><span class="hljs-number">0</span></span> failed=<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>   ,      site.yml   .        -? !  limit-: </p><br><pre> <code class="hljs vbscript">ansible-playbook -i <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/hosts -l web <span class="hljs-keyword"><span class="hljs-keyword">step</span></span><span class="hljs-number"><span class="hljs-number">-12</span></span>/site.yml</code> </pre> <br><p>      . </p><br><p> <em>( :           .         ).</em> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/305400/">https://habr.com/ru/post/305400/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../305390/index.html">$ 10 million stolen from Ukrainian bank: new attack by SWIFT hackers</a></li>
<li><a href="../305392/index.html">Isilon CloudPools Transparent Cloud Layered Storage</a></li>
<li><a href="../305394/index.html">‚ÄúThe web is the most complex platform in the history of mankind‚Äù - an interview with Vadim Makeev from Opera</a></li>
<li><a href="../305396/index.html">Projecting Google Material Design onto the desktop system ... (part three)</a></li>
<li><a href="../305398/index.html">Arrow hell, or a new circle of old problems</a></li>
<li><a href="../305402/index.html">History of programming languages: Perl is an unusual language created by a linguist for programmers.</a></li>
<li><a href="../305404/index.html">Google fixed Android vulnerabilities</a></li>
<li><a href="../305406/index.html">Accord.Net: we are looking for an error in the code, due to which the machines will enslave humanity</a></li>
<li><a href="../305408/index.html">Render to texture using Three.js</a></li>
<li><a href="../305414/index.html">IoT and ViaLatM. Automation of sending commands to Internet of Things objects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>