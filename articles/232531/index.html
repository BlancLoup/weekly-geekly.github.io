<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hack mobile online game? Easy!.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Today I will tell you about what you may encounter if you suddenly decide to get into the jungle of someone else's application on Android (i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hack mobile online game? Easy!.</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr!  Today I will tell you about what you may encounter if you suddenly decide to get into the jungle of someone else's application on Android (in this case, online games).  Adventures with viewing Java classes in .dex, learning Dalvik op codes, and even binary programming.  But first things first. <br><br>  Under the cut traffic to ~ 800kb, 293 of which are screenshots of the code (!) <br><a name="habracut"></a><br>  <i>This article is written for informational purposes only.</i>  <i>The author is not responsible for any actions of users who read the article.</i>  <i>Any coincidences in the article are random.</i> <br><br>  Once, on a rainy summer evening, my girlfriend and I were looking for something to occupy.  I didn‚Äôt want to watch the movie, but there was no desire to get out of bed.  The choice fell on a mobile toy.  There were not too many basic requirements for the game: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  must support iOS and Android; </li><li>  must have a single server for both platforms; </li><li>  There should be a joint game, so that there is a sense to play together. </li></ul><br><br>  Thus, we found a game from the top of Google Play.  In order not to disclose names, let's call it a game N. True, as it turned out later, the third item from the list above is implemented there a little more than nothing. <br><br>  Below I have hidden a brief description of the game under the spoiler, it is not necessary to read it, but it will be useful to complete the picture. <br><br><div class="spoiler">  <b class="spoiler_title">Description</b> <div class="spoiler_text">  The game is based on monsters.  You call them, shake them and their spells, put on them runes that put up different stats.  Monsters, in addition to the usual levels (levels), there is also a gradation by the stars: <br><br>  1 star - max level 15 <br>  2 star - max level 20 <br>  3 start - max level 25 <br><br>  and so on up to 6 stars and a maximum level of 40. Having reached the maximum level, you can raise the number of stars to the monster, while its level will drop to the first.  This process in the game is called ‚ÄúEvolve‚Äù.  To do this, you will have to "eat" other certain monsters, for example: <br><br>  for evolv one monster 2s -&gt; 3s, you need to eat 2 already existing monster 2s. <br>  4s -&gt; 5s - you need to swallow 4 monsters 4s <br>  5s -&gt; 6s - 5 monsters 5s - this is <i>very</i> labor-intensive by the standards of the game. <br><br>  Monsters can be invoked in many ways, but ultimately it all boils down to three: <br><br><ol><li>  knock out in the location (maximum 3s, the chance is quite small) </li><li>  1-3 scrolls of the call (1s-3s, respectively. 95%, that from the call you get 1s or 2s. It is worthwhile to clarify that the monsters 1s-2s are slag, and in 99% of cases they are consumed, because stats lose a lot. Scrolls fall very often, you can get 20-30 pieces per day without much zadrotstvo); </li><li>  3-5 scrolls of appeal (~ 90-95% that you get 3s, 4s rarely fall, 5s monsters never fell from these scrolls. Scrolls can be bought in unlimited quantities for red crystals. They fall very rarely) </li></ol><br><br>  Now about the game currency: <br><br>  Energy - needed for hiking in PvE locations and dungeons.  Consumption - from 3 to 8, depending on location.  Accumulates one in 5 minutes, often falls directly from dead mobs.  There is a ceiling of energy that increases with the level of the player (not to be confused with the level of monsters) and with the help of a special building. <br><br>  Arena Energy - used for trips to the arena, "PvP".  About why PvP in quotes, you will learn below.  1 trip to the arena spends 1 unit of energy arena, maximum - 10, accumulates one time in half an hour. <br><br>  Blue crystals - the main currency of the game.  It bought things from the store, most of the buildings.  It accumulates in various buildings, falls from dead mobs, give as a reward for tasks. <br><br>  Red crystals are a minor currency that can be bought for real money.  They can be spent on those same scrolls 3-5, on renewing energy and the arena of energy, and buying blue crystals for them.  Very rarely, they fall from dead mobs or in the arena.  On the day they can be earned about 30-40, by the way, one roll of 3-5 costs 75. <br><br>  Points of fame - the currency that is given for winning in the arena.  For it is bought a lot of interesting buildings and objects.  This currency can not be purchased for any other or for donat. <br><br>  Donat in the game do not crush.  All is well and calmly passed / bought without an infusion of money.  Donat, in fact, gives you only more scrolls, the chances of getting useless monsters from them are the same.  You cannot buy a specific monster for donate (and in general it is not possible at all). <br><br>  The combat system resembles Final Fantasy 7-10 or, if you prefer, HoMM is a turn-based combat, with a choice of 2-4 spell.  In the dungeons from 3 to 10 levels (most often 3 or 5), at each level there is a pack of mobs, you kill - pass on, do not kill - you get everything that you managed to earn (crystals, energy, experience). <br><br>  About the "PvP" and "team play."  As it turned out, you do not have the opportunity to play with a person or against a person.  You play either on your own or on auto attack and always against the computer.  Therefore, PvP is pretty boring here.  It consists in the following: each player defuses 4 monsters and buys towers for protection.  Getting into the arena, you fight AI, which is pretty dumb.  In order to balance this, after a while, the very same towers begin to fire on you, each time more and more often. <br></div></div><br><br>  I am a remote programmer, so I work at home.  And at home there is always a good wi-fi, and I didn‚Äôt particularly think about how and when the game interacts with the server. <br><br>  Until I decided to enter the game from the mobile Internet.  Having run all the levels in the next dungeon, I received the message ‚ÄúNetwork connection is delayed.  Resend Battle Results?  (If battle results are not lost, count as loss.) ".  After I clicked on the ‚ÄúYes‚Äù button, the results still went to the server. <br><br>  If you have read the description of the game, then much has fallen into place for you: why there is no normal PvP or two games - the game connects to the server rarely, most likely via HTTP, no sockets.  And most importantly - apparently, in this game, the <i>client</i> calculates the results of the battle, and the server only receives them. <br><br>  Immediately after experimenting with the disconnection of the Internet at various points in the game, I found out the following: <br><br><ul><li>  when entering a location, you send a request to the server.  If it passes, and you get the answer - the download starts in the location; </li><li>  the server does not control your movement between location levels; </li><li>  when you kill the final pack of mobs, another request is sent.  Your loot comes in response. </li><li>  if you can send the results of the battle, but you can‚Äôt get an answer, they‚Äôll show you the same message - ‚ÄúNetwork connection is delayed ...‚Äù.  But if you try to do it again (and the request-response passes), you will receive the message ‚ÄúCan't find match data‚Äù.  This suggests that when you load into a location, you are sent in reply by your battle id, which at the end of the dungeon is used to send its results. </li><li>  as I said in the description, not only blue crystals are falling from mobs.  Quite often, energy and occasionally red crystals fall, and you can see what and how much fell when the mob was killed.  And here there is a thought: does the client really decide how much and what will fall, and then sends it to the server?  If so, then by sending the "correct" request, we will not only be able to "win" the dungeon, which is too tough for us, but also take a couple of hundred red crystals and energy from it. </li><li>  with all this, you can not fear for the further passage of the squad through the dungeon.  Having completed the passage (anyway), we just get the message ‚ÄúCan't find match data‚Äù, the results have already been sent. </li></ul><br><br><h4>  Idea 1. Forged request </h4><br>  The most logical idea that can come after the above. <br>  In order to fake a request, we need the original.  There are a lot of options for monitoring traffic, I chose the easiest one for me - to let traffic through the laptop and look at it all with the help of WireShark. <br><br>  Instructions for turning your computer into an access point can be found <a href="http://habrahabr.ru/post/130271/">here</a> . <br>  So that there is less excess "noise" in the logs, we close all applications and disable synchronization. <br>  At boot time, the game loads information about promotions, partners, and friends from Facebook - in general, there is a lot of traffic and it goes to different servers, so we are not interested.  Go to the location: <br><br><div class="spoiler">  <b class="spoiler_title">Request</b> <div class="spoiler_text"><pre><code class="hljs delphi">POST /api/gateway.php HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> User-Agent: Dalvik/<span class="hljs-number"><span class="hljs-number">1.6</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">(***)</span></span> Host: *** Connection: Keep-Alive Accept-Encoding: gzip Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: application/x-www-form-urlencoded Content-Length: <span class="hljs-number"><span class="hljs-number">556</span></span> hEuirYJfxnRGR7vITBb1x/<span class="hljs-number"><span class="hljs-number">3</span></span>KpY+<span class="hljs-number"><span class="hljs-number">0</span></span>DZmSWBLuxNnJn+Vqdb2eg7X+TKBKgcldJEY1A59yw8ocPnyD/A+Xec5uLtk9IEojAmPTwDiJDNu6BcRKXQpCGIildUlzpBxCSSp0PU8OgSaXNqlP+aGrXnHGoZXKVREMPRAXZPwlOGD6XIemvS5wkWrv+<span class="hljs-number"><span class="hljs-number">4</span></span>GBPhO3v21CEfify4wO0x6GWUswX55TbAiLbT4Lr3C4TKXJyJQ8eujxC7Nd0OFEK8d92KbamPEFocxJotYTNuLa6qwVfdpgvaoDCCeKGXvu+z3ZZCjaruh2XMHtg6MRU0ywpB7d5qR9b4JOYRGwe2z9WHXKZesSwl7S7HsLgKtjLKz9oIRJAiTgRIWGn2WM9WaMtFSn9fXyEj31lS3JWtJ4hkgntVYh4qC6DvnTt0XJTZBXWm93Ki2FVASHDkr+tTPNZm69uBWXQ8/a768aoaTO+v+<span class="hljs-number"><span class="hljs-number">1</span></span>o/ymQ8TQBDeMt79XZ8w3kGYrXC9PZh8IacSA3KPqzVQxlFeXnyzuTuqTzef9ZB9B2yc0VGD+xeIwgswiyNOjTBYqKmI=</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Answer</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span>: nginx <span class="hljs-type"><span class="hljs-type">Date</span></span>: Sat, <span class="hljs-number"><span class="hljs-number">19</span></span> Jul <span class="hljs-number"><span class="hljs-number">2014</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span> GMT Content-<span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>: application/octet-stream; charset=utf<span class="hljs-number"><span class="hljs-number">-8</span></span> Content-Length: <span class="hljs-number"><span class="hljs-number">1048</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connection</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> X-Powered-<span class="hljs-keyword"><span class="hljs-keyword">By</span></span>: PHP/<span class="hljs-number"><span class="hljs-number">5.4</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Cache</span></span>-Control: no-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span>, must-revalidate Pragma: no-<span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> vyb3BQeGoRphqgM/QCIBv0m2Ms5lBf3iUEKauCdpgRCXWjyITAUa+t1w36VzBxlkZlYF+jH+Lmw+hmPbLtKj2pBidUrZ0CO44AsQ2erYG+m0n2WK8SY5m7Ioar1gNtim67rwpZQeGzP+dUvLE5T3Q/<span class="hljs-number"><span class="hljs-number">3</span></span>iqua8dHNAhkrsrYyHYevbh535JODq0Qwd5y8ZQtsYQnl+Vtc2YeL6O3hvUc6UEKNHmc79saLz+PhH64nRA7xih+OLip3FGrgJdgDTTNBn2xBxyRmTeuoD1LqwKa/eWfDkwoA9IOMoc9NozoRyiUDRZjaya0VZH+k6DR4lRGMrDJtmBwjIWfAIbEg5K3xUEPtJIvU7QryaDTqZT+FOgQRr1sZ5MFzoDzJ+titAfbKNKZxF7QUDbAzi+o3j6pzZkioPbWMotsUWKUM/IOrfKcRGIV1yd0w8sGHhh9m7wDwbFA1/RCpifJBV528TZ9Ql3P3gQGvvqnGf5n88BpKXo3IF5+T3Fr9QXijR4kJ5H9MxltRCLB3DU41XZ9bQuP9o7IvWkt+TGvByAW4bI3JkLz855R7AzSoyrVfYPaguKH7yvJX6cQkm5GDqYRCwFA+mRQmHg6AEYbBS2M+DrZ1U/UvdB5bMY+sLDEPE6MLVeRadFjNzFlKkQxWUlGmzD06ia9kCOoyC9du4bCRTziH03qNK4m1tgwqw2jsUtu8I+HTK30YibHmrUWdqtfyIm0EqiXKI8ZsZYxsG1qeqYQNnQ9HIYxpYRXIETlLBl1Fs3bY1tXoUxetaNDVhxW/PMvFCLSJJCNJ6V8iJRieA0o23hqAKsJpDRANz8oEJ0vNKubXn7HeXq48UzkStqobE/UotzQ8ocdVBW7MgErF5DzjWLxgMjB3pnKiOFl8pqacD6qFWSywQtcF8xJ2RQMuEefusrrfFi67e5PLSdJW2utMIMAudJyllcOK4wNur6fo18J6zHyjzSklIuPhzPn2XQj+FcgUh1pU0wLKhuWq39PFCi4ekupSLt7j0VSZCoKDmKQO4q1b/SpeA5Bb7lW5TvgRSsg==</code> </pre><br></div></div><br><br>  At first glance it is clear that this is Base64.  But by typing the text into the first decoder, I received complete nonsense, although I was expecting JSON (just kidding, it would be too naive - from the application 10kk + downloads). <br><br><h5>  We need to go deeper ¬© </h5><br>  Download apk games (many options, I took advantage of <a href="http://apps.evozi.com/apk-downloader/">this</a> ).  The APK file is a regular ZIP archive, there is a lot of things in it, but first of all we are interested in the classes.dex file.  This is the Dalvik executable format.  Essentially - compiled Java classes.  To open them, we need <a href="https://code.google.com/p/dex2jar/">dex2jar</a> and <a href="http://jd.benow.ca/">jd-gui</a> .  The first converts dex to jar, the second tries to restore the source code from jar. <br>  What jd-gui will restore is pretty dreadful and read-only.  You should not try to compile it.  You can save and open source files from jd-gui in your favorite editor.  I downloaded the 30-day IDEA trial from JetBrains, because I really love the way the search was done in their products (I use the purchased PyCharm and PHPStorm myself). <br><br>  Warning for those who prefer this editor - do not set the SDK, you will fill up with errors. <br><br>  From programming for android, I knew only the basics and had no particular idea where to start my searches.  Therefore, I launched the search for ‚Äúbase64‚Äù on the project, and found a class that implements Base64 decode and encode.  I was very surprised by this, because these methods were not just a wrapper for library methods, but, judging by the code, they actually <i>implemented</i> Base64 encoding and decoding. <br><br>  The first thought that came to me was that the creators wrote something of their own, which is similar to Base64, but is encoded differently.  Since the code looks awful (methods on thousands of lines, goto's, instructions in methods immediately after return and other joys of life), I could not rewrite it.  Then I remembered that the server was written in PHP, and decided not to despair, because containing two of my own Base64 implementations on two very different platforms is quite expensive for development.  A little later, I started Base64 to Java and realized that in standard Java libraries (version 6 and 7) there is no base64 encoding, which finally drove away my fears about an alternative implementation. <br><br>  Looking for the use of this class, I went to another - StringEncrypter, which implemented several methods, but the main ones were decrypt and encrypt.  Skimming the decrypt method, I realized that this was what I needed.  The data was decrypted from base64, run through AES / CBC / PKCS7Padding and returned.  It remained only to find the key that was used for Cipher and the initial vector (Initialization vector). <br><br>  For this, I began to look for the use of these methods.  And I found out that the StringEncrypter class is not used anywhere.  This surprised me a lot, but I thought it was jd-gui flaws. <br><br>  I started searching the project again, this time I immediately looked for Cipher.  There were many results, and, wandering through them, I came across a file, the source code of which, apparently, could not be recovered.  Instead of the code hung "INTERNAL ERROR".  Having started the search for this ‚ÄúINTERNAL ERROR‚Äù project, I got 55 results.  It became clear why I could not find the use of some classes.  Among these files there was one with the interesting name ActiveUserNetwork. <br><br><h5>  We need to go deeper ¬© </h5><br>  I guessed that further - only the assembler.  So it happened. <br><br>  Dalvik VM has a <a href="http://pallergabor.uw.hu/androidblog/dalvik_opcodes.html">lot of op codes</a> , and, in fact, smali code is quite user-friendly to read, especially if you‚Äôve been tinkering with assembly language. <br><br>  This time we will need <a href="https://code.google.com/p/smali/">smali and baksmali</a> .  Backsmali converts the classes.dex file to the source folder, while preserving the hierarchy and folder and file names.  At first, it will be much easier to understand the smali code by opening the same java file (if, of course, jd-gui could decompile it).  There are enough resources on the Internet where you can find code examples, <a href="http://androidcracking.blogspot.ru/2011/01/example-structuressmali.html">here</a> , for example, it shows what arrays look like in smali and for / switch instructions. <br><br>  But let's return to our game, and specifically to the ActiveUserNetwork file that interested me.  Here everything was found - Cipher, methods encrypt and decrypt, Base64, (by the way, here it was used from the android.utils library) and even the constant ‚Äúhttp: //***.com/gateway.php‚Äù.  Yes, this is not /api/gateway.php, but at least something.  By the way, the search for "api / gateway.php" did not give anything even by smali code, but I was not particularly upset because I saw that StringBuilder is often used. <br>  There are no highlights of the smali code in Habr√© (frankly, there are few of them at all), so I‚Äôll upload large chunks of this code with screenshots. <br><br>  So, the <code>decrypt</code> method: <br><br><img src="https://habrastorage.org/files/077/ea5/659/077ea56596a1400a8bd4b1967cbc792c.png"><br><br>  Explanation of the code: in the first line is the standard description of the method: what it takes and what it returns.  The method takes 2 parameters - a string and a byte array (here it looks like [B).  Returns a byte array. <br>  The <b>.locals</b> directive indicates the number of registers that the method will use, not counting its parameters.  In addition to this directive, there is a similar one, which is called <b>.registers</b> , it defines the number of registers that are used by the method, including method parameters.  Those.  In general, .registers = .locals + params.  In this case, if you declare the number of registers through the directive .registers, the method parameters fall into the latest registers.  Registers are accessed via v0, v1, v2, and so on, parameters are p0, p1, and so on. <br>  This method is static and is called without an object, otherwise there would be 3 parameters, the first of which would be the object for which the method (this) is called.  The following two directives may be missing, these are the names of the parameters.  The <b>.annotaions</b> directive declares additional information about the method, in this case, the thrown exception.  The <b>.prologue</b> directive says that the body of the method goes further. <br>  Given all this, the first 11 lines are converted into one line of Java code: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypt(String key, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception {</code> </pre><br><br>  Looking into the table of op-codes and remembering that in invoke-virtual the first parameter always passes the object itself, unlike invoke-static, ‚Äúliterally‚Äù rewrites the method in Java: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypt(String key, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { String v1 = <span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS7Padding"</span></span>; Cipher cipher; cipher = Cipher.getInstance(v1); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v1_1 = <span class="hljs-number"><span class="hljs-number">2</span></span>; SecretKeySpec v2 = createSecretKey(key); AlgorithmParameterSpec v3 = spec; cipher.init(v1_1, v2, v3); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1_2 = cipher.doFinal(data); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v1_2; }</code> </pre><br><br>  Here <code>spec</code> is a static variable of the ActiveUserNetwork class, it is initialized in the class constructor <br><br><pre> <code class="hljs pgsql">.line <span class="hljs-number"><span class="hljs-number">78</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-instance v0, Ljavax/crypto/spec/IvParameterSpec; const/<span class="hljs-number"><span class="hljs-number">16</span></span> v1, <span class="hljs-number"><span class="hljs-number">0x10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">array</span></span> v1, v1, [B invoke-direct {v0, v1}, Ljavax/crypto/spec/IvParameterSpec;-&gt;&lt;init&gt;([B)V sput-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> v0, Lcom/com2us/module/activeuser/ActiveUserNetwork;-&gt;spec:Ljava/<span class="hljs-keyword"><span class="hljs-keyword">security</span></span>/spec/AlgorithmParameterSpec;</code> </pre><br><br>  I replaced this constructor code with the <code>getSpec</code> method.  We <code>decrypt</code> method to a normal form: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decrypt(String key, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { String alg = <span class="hljs-string"><span class="hljs-string">"AES/CBC/PKCS7Padding"</span></span>; Cipher cipher = Cipher.getInstance(alg); SecretKeySpec secretKeySpec = createSecretKey(key); cipher.init(<span class="hljs-number"><span class="hljs-number">2</span></span>, secretKeySpec, getSpec()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cipher.doFinal(data); }</code> </pre><br><br>  So, we need to deal with the <code>createSecretKey</code> and <code>getSpec</code> methods. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> AlgorithmParameterSpec </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSpec</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IvParameterSpec(v1); }</code> </pre><br><br>  This is the converted code from the constructor.  It was already at night, and the number 0x10 my brain translated into the decimal system as "10."  It's good that I decided to double-check in the calculator, otherwise I would wait for disappointment :) <br><br>  Method <code>createSecretKey</code> (here, by the way, a typo in the name, we will fix it too) <br><br><img src="https://habrastorage.org/files/f2f/446/c46/f2f446c46c0b422d978caa92a5796d1a.png"><br><br>  The method is quite simple, converted to <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SecretKeySpec </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createSecretKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecretKeySpec(key.getBytes(), <span class="hljs-string"><span class="hljs-string">"AES"</span></span>); }</code> </pre><br><br>  Great, it remains only to find out what is transmitted to the method with a key and data. <br>  The <code>processNetworkTask</code> method is responsible for <code>processNetworkTask</code> ; it simultaneously sends the request (with encrypt and Base64 encode) and receives the answer.  The method is voluminous (1k lines), so I will lay out only the assembly of the pieces of interest to us ( <code>v18</code> is an object of the <code>org.apache.http.HttpResponse</code> class) <br><br><img src="https://habrastorage.org/files/3a2/4d9/fef/3a24d9fef76941dc99af2d7cb80c24bf.png"><br><br>  In short: <br>  Take the header value <code>REQ-TIMESTAMP</code> , call the <code>createHash("MD5", header_value)</code> method <code>createHash("MD5", header_value)</code> .  From the returned string, we get the substring from the first character to the sixteenth, and this substring is passed to the <code>decrypt</code> method with the key.  The data transfers the byte array from <code>Base64.decode()</code> . <br><br>  So, we have everything in our hands, except for the <code>createHash</code> method. <br>  smali code: <br><br><img src="https://habrastorage.org/files/785/6c0/e5d/7856c0e5de2a4bddbaf62d26fa49da34.png"><br><br>  This method is already heavier for perception: there is a cycle, exceptions, and conditions.  But to make mistakes in cryptographic methods is impossible.  This construction alone is worth: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span>/<span class="hljs-number"><span class="hljs-number">4</span></span> v7, <span class="hljs-number"><span class="hljs-number">0x1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-array v7, v7, [Ljava/lang/Object; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>/<span class="hljs-number"><span class="hljs-number">4</span></span> v8, <span class="hljs-number"><span class="hljs-number">0x0</span></span> aget-<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> v9, v3, v1 invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {v9}, Ljava/lang/Byte;-&gt;valueOf(B)Ljava/lang/Byte; move-result-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> v9 aput-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> v9, v7, v8</code> </pre><br><br>  And it turns into a banal <code>Byte v9 = mdByte[i];</code> <br>  As a hint: almost always when you see an increment ( <code>add-int/lit8 v1, v1, 0x1</code> ) before <code>goto</code> is a for loop.  Final Java code: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String algorithm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { MessageDigest md = MessageDigest.getInstance(<span class="hljs-string"><span class="hljs-string">"MD5"</span></span>); md.update(data); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] mdByte = md.digest(); String mdString = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = mdByte.length; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { StringBuilder v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(mdString); String v6 = <span class="hljs-string"><span class="hljs-string">"%02x"</span></span>; Byte v9 = mdByte[i]; v6 = String.format(v6, v9); v5.append(v6); mdString = v5.toString(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mdString; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (NoSuchAlgorithmException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">""</span></span>; } }</code> </pre><br><br>  Putting it all together.  I created a new application and threw everything in MainActivity: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); String b64 = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Base64 request body String req_ts = ""; // REQ-TIMESTAMP header byte[] decodeBase64Byte = Base64.decode(b64, 4); String hash = createHash("MD5", req_ts.getBytes()); hash = hash.substring(0, 16); try { Log.d("MYAPP", "Decrypted: " + new String(decrypt(hash, decodeBase64Byte))); } catch (Exception e) { Log.d("MYAPP", e.getClass() + "-" + e.getMessage()); } }</span></span></code> </pre><br><br>  Now back to why we all do it.  The attentive reader might have noticed that there was no header REQ-TIMESTAMP in either the answer or the query that were mentioned above.  However, there the request goes to / gateway, not to / api / gateway.  Requests to / gateway go during application initialization.  There are only two of them, deciphering them, I got ... nothing.  No, there was data about the device, the MAC address and even whether the tablet was ruled.  But I did not get anything worthwhile.  Requests to / api / gateway came from somewhere else and were in no way connected to / gateway. <br><br>  While I was dealing with smali code, I made several more attempts in different directions, before I came to the decision to deal with all the methods and rewrite them in Java. <br><br>  Attempt 1: do not look for how the key is generated, but simply make a request with it to your server.  Smali code can be changed and compiled back, so the idea was simple - before decrypt we make a request to your server, passing the key as a GET parameter, and then we look at the logs of the web server. <br>  Looking for how to compile smali code I found <a href="https://code.google.com/p/android-apktool/">apktool</a> .  This tool is able to parse the apk file right away on the smali code, and also collect it all back into apk. <br><br><pre> <code class="hljs ruby">./apktool decode ~<span class="hljs-regexp"><span class="hljs-regexp">/Downloads/</span></span>***.apk ~<span class="hljs-regexp"><span class="hljs-regexp">/Documents/out</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ./apktool</span></span> build ~<span class="hljs-regexp"><span class="hljs-regexp">/Documents/out</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ~/</span></span>Downloads/***.new.apk</code> </pre><br><br>  But when you try to install a new application, you get an error: <br><br><pre> <code class="hljs coffeescript">.<span class="hljs-regexp"><span class="hljs-regexp">/adb install -r ~/Downloads/</span></span>***.<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>.apk Failure [INSTALL_PARSE_FAILED_INCONSISTENT_CERTIFICATE]</code> </pre><br><br>  On stackoverflow, it is advised to remove the application manually, and then install it again, but that did not save me.  Making a new key, for this we need the keytool and jarsigner (included in the openjdk package) <br><br><pre> <code class="hljs pgsql">keytool -genkey -keystore ~/<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>.keystore -validity <span class="hljs-number"><span class="hljs-number">10000</span></span> -<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> jarsigner -keystore ~/<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>.keystore -<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span> ~/Downloads<span class="hljs-comment"><span class="hljs-comment">/***.new.apk debug</span></span></code> </pre><br><br>  Important note - jarsigner behaves differently in jdk version 6 and 7, and on version 7 the command will swear at alias.  I did not find a solution to this problem and installed an additional version 6 for myself. <br><br>  After that, the installation of the application will pass.  But, unfortunately, the application (even if it was not modified, but simply decompiled, compiled, sub-set, installed) immediately crashed.  I guess that the server somehow checks the signatures, but I will be glad if someone specifies in the comments.  This idea had to be left. <br><br>  Attempt 2: if there is no desire to poke around in smali code (and I didn‚Äôt have it, I thought it was a problem for ~ 5 hours), then you can do it easier.  In your application, create an empty method with the same interface as the one you want to copy, create an apk, decompile, copy the body of the method, collect it back.  Each such iteration takes a lot of time.  Therefore, it will be faster to learn op codes.  It is clear that you will not be able to open the source code of the assembled application. <br><br>  <i>This article was not written in one day, and I write this remark a week after the paragraph above.</i>  <i>The way of describing the interface and copying smali code into the method body helped me a lot when I could not recover the source code of the key generation method.</i>  <i>To simplify your life and reduce the time of iteration, you can combine everything into one team</i> <br><br><pre> <code class="hljs pgsql">apktool build ~/myapp/ ~/myapp.apk &amp;&amp; jarsigner -keystore ~/<span class="hljs-keyword"><span class="hljs-keyword">debug</span></span>.keystore -<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span> ~/myapp.apk <span class="hljs-keyword"><span class="hljs-keyword">debug</span></span> &amp;&amp; adb install -r ~/myapp.apk &amp;&amp; adb shell am <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> -n "com.example.myapp/com.example.myapp.MyActivity" -a android.intent.action.MAIN -c android.intent.category.LAUNCHER &amp;&amp; adb shell logcat MYAPP:D *:S</code> </pre><br><br><h4>  Idea 2. We make a supermonstra. </h4><br>  Well, if it does not work through the request - let's go the other way. <br>  New monsters are loaded into the game not through an update in Google Play, but through an intragame update.  It means that they are stored somewhere outside apk, and theoretically we can modify them. <br>  It was not necessary to search for a long folder - /sdcard/Android/data/com.***/files/patch/ <br>  There were all the sprites and sounds, and most importantly - a lot of files with the names of monsters and the extension. Dat.  We open it with a hex editor and skim through it - no headers or lines that the eye would catch.  I took the first monster of the first level, looked at his HP and began to search / replace these bytes in the hope that the file is not encrypted.  Found 7 matches.  By successively replacing them, I received 4 crash games and 3 "nothing has changed."  Sorry, encrypted. <br>  But something has to decipher it!  We are looking for the "\ .dat \ b" in the regexp code (to exclude in the results methods starting with "data").  Only the CommonData.dat file is located.  This file is hidden in the /data/data/com.***/ folder (if you have no data in the / data folder, you need root access). <br>  The file is encrypted and has a size of 1kb.  It is clear that there is nothing standing there, however, the encryption algorithm may be the same.  This time I will not upload the code, it takes about a thousand lines.  Most importantly, a string based on ANDROID_ID is passed to the decrypt key.  After opening the file, the MAC address was found (again).  Having experienced the same algorithm on monster files, I received an error. <br>  Sadness longing. <br><br><h4>  Hi, assembler! </h4><br>  However, in the same folder / data / data / com. * * * / Lib / I came across the .so library.  I already saw them in apk and saw them connected in the MainActivity (honestly, all this time I really hoped that I wouldn't have to pick them).  There were two libraries - libgame.so, libcom ***. So.  The second one weighed very little and did not carry any value for me.  I opened the first with a hex editor and in half a minute I found the line ‚Äúhttp: //***.com/gateway/api.php‚Äù. <br><br><h5>  We need to go deeper ¬© </h5><br>  I hope you are not tired yet :) Because we start practically from the very beginning. <br>  Frankly, at this stage I spent about 20-30 hours of my time.  If you are not familiar with processor op-codes, registers and memory, you will also be stuck here for a long time.  I was saved only by my persistence and desire to prove that a person is steeper than some kind of application. <br>  A lot of time was spent on the selection of tools and techniques.  And if the remaining article will save someone a few hours in the future - it will be great. <br><br>  Tools. <br>  Ida Pro 6.1+ - the main tool for debugging.  Since version 6.1 it comes with the android_server file and the ability to remotely debug Android applications. <br>  <a href="http://gnutoolchains.com/android/">gdbserver</a> is another tool for remote debugging. <br>  At this stage, root access to the device is required. <br><br>  We upload both servers to the device: <br><br><pre> <code class="hljs perl">adb <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> gdbserver /data/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/tmp adb <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> android_server /data/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/tmp</code> </pre><br><br>  We configure port forwarding on localhost: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">adb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forward</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tcp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5039</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tcp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5039</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">adb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forward</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tcp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:23945</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tcp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:23945</span></span></code> </pre><br><br>  We set the necessary rights: <br><br><pre> <code class="hljs perl">adb shell su <span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">755</span></span> /data/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/tmp/gdbserver <span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> <span class="hljs-number"><span class="hljs-number">755</span></span> /data/<span class="hljs-keyword"><span class="hljs-keyword">local</span></span>/tmp/android_server</code> </pre><br><br>  The basic idea (thanks to <a href="http://forum.xda-developers.com/showthread.php%3Ft%3D2050393">this topic</a> , it saved me a ton of time): <br><ol><li>  connect through android_server, find the library, remember the offset; </li><li>  load the library in Ida with the specified offset; </li><li>  Ida analyzes, sets function names, call schedules and even tries to reproduce source code; </li><li>  run the application on the device; </li><li>  already analyzed library we load in application through gdbserver </li><li>  set breakpoints, analyze.  If the application crashes, <code>goto 4</code> . </li></ol><br><br>  Why are two servers used for remote debugging?  android_server can "beautifully" show loaded libraries and the offset for the desired library is in it very quickly.  But breakpoint does not work in it.  But they work fine in gdb.  It would seem possible to look for <code>info sharedlibrary</code> through the gdb client using <code>info sharedlibrary</code> , but this did not work for me. <br><br><div class="spoiler">  <b class="spoiler_title">The location of the desired settings in Ida</b> <div class="spoiler_text">  You can load a file with offset through <code>File &gt; Open &gt;   &gt; Manual load</code> .  In the same window it is necessary to indicate the type of processor. <br>  Selecting a remote debugger: <code>Debugger &gt; Switch debugger</code> . <br>  Connection setup for debugger: <code>Debugger &gt; Process options</code> .  Here we set localhost and the port of the server that is being used. <br></div></div><br><br>  Another important point: <br>  If the application crashes, you (with some probability) will have to do all the steps from the first.  It's all about <a href="http://ru.wikipedia.org/wiki/Address_Space_Layout_Randomization">ASLR</a> technology.  To disable it, run in the shell: <br><br><pre> <code class="hljs ruby">echo <span class="hljs-number"><span class="hljs-number">0</span></span> &gt; <span class="hljs-regexp"><span class="hljs-regexp">/proc/sys</span></span><span class="hljs-regexp"><span class="hljs-regexp">/kernel/randomize</span></span>_va_space</code> </pre><br>  <b>Attention!</b>  This greatly affects the security of your device.  Remember to remember the value of this parameter and return it to the place after your experiments. <br><br>  So, a more detailed action plan: <br><ol><li>  Run android_server: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">adb</span></span> shell su /<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">/local/tmp/andoid_server</span></span></code> </pre> <br></li><li>  Open Ida without downloading anything, go to <code>Debugger &gt; Attach to &gt; Remote ARM/Android Debugger</code> . </li><li>  Select the desired application from the list. </li><li>  We are looking for our library (there are many options, but the quickest thing I could do was find it with my eyes - by scrolling and browsing. Search is slow, jump to the label does not always work. </li><li>  Remember the library offset ( <code>5D699000</code> in my case). </li><li>  Disconnect from the process ( <code>Debugger &gt; Detach from process</code> ).  The process on the device remains alive. </li><li>  Open the file, set the desired offset ( <code>0:5D699000</code> in my case). </li><li>  While Ida is analyzing the file, kill android_server and prepare gdbserver: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">adb</span></span> shell su /<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">/local/tmp/gdbserver </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">--attach :5039 1234</span></span></span></span></code> </pre> <br>  (The --attach option tells the server to join the already running process: 5039 is the port number, 1234 is the pid of the process that can be seen with the usual <code>ps</code> in the shell). </li><li>  Changing Ida settings to work with gdbserver. </li><li>  Connect to the process. </li></ol><br><br>  Now, if everything is done correctly, the library code, which Ida analyzed, will go to the right place. <br><br>  Having studied the list of functions from the library, I found a very entertaining group that was responsible for interacting with the server.  Here are some of the features: <br><ul><li>  battleArenaStart </li><li>  battleArenaResult </li><li>  battleDungeonStart </li><li>  battleDungeonList </li><li>  battleDungeonResult </li></ul><br>  All these functions formed JSON, filled it, and called the <code>sub_5D839994</code> function.  This feature is the cornerstone of communicating with the server.  It encrypts strings, packs it in base64 and sends data. <br>  It was hard to mess with cryptography even in more or less understandable smali code.  Immediately it was hell.  Although I found the key that is used for encryption, I still get lost in the search for IV. <br>  But since we already hang on the application debugger, it is enough for us to intercept the line before encryption, change it and continue the application.  And the server will leave a modified string. <br>    ,   ( <code>sub_5D839994</code> )   (  ),     ,       ,    ,      . <br>  ,   .   2 :    <code>sub_5D839994</code>   , ,   , ‚Äì    <code>AESConvertEncode</code> ,     . <br><br> ,  ,      .    ,   ‚Äì  .  ,    <code>AESConvertEncode</code> ,   ‚Ä¶ !      .   R0: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"command"</span></span>: <span class="hljs-string"><span class="hljs-string">"BattleArenaResult"</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1234567</span></span>, <span class="hljs-string"><span class="hljs-string">"session_key"</span></span>: <span class="hljs-string"><span class="hljs-string">"***"</span></span>, <span class="hljs-string"><span class="hljs-string">"win"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"unit_status"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">"result"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}, {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">"result"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">"result"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>,<span class="hljs-string"><span class="hljs-string">"result"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>} ], <span class="hljs-string"><span class="hljs-string">"unit_list"</span></span>: [ {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">123456781</span></span>, <span class="hljs-string"><span class="hljs-string">"pos_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>}, {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">123456782</span></span>, <span class="hljs-string"><span class="hljs-string">"pos_id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>}, {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">123456783</span></span>, <span class="hljs-string"><span class="hljs-string">"pos_id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>}, {<span class="hljs-string"><span class="hljs-string">"unit_id"</span></span>: <span class="hljs-number"><span class="hljs-number">123456784</span></span>, <span class="hljs-string"><span class="hljs-string">"pos_id"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>} ], <span class="hljs-string"><span class="hljs-string">"position"</span></span>: {<span class="hljs-string"><span class="hljs-string">"island_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"pos_x"</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-string"><span class="hljs-string">"pos_y"</span></span>: <span class="hljs-number"><span class="hljs-number">22</span></span>} }</code> </pre><br><br> ,       99.(9)%,  ‚Äì    <i></i> ,   ,     . <br>     ,   ,     ‚Äì     ,   <code>unit_status</code> .           ,  ,   id-result           (2 ‚Äì , 1 ‚Äì ).    ,   . ,           , , ,    ‚Äì   .  ,      : <br><blockquote>     ,       .        ,   ,       .     :   ,    ,     ?  ,   ¬´¬ª ,     ¬´¬ª ,     ,       -     . <br></blockquote><br> ,     ,    ,         .       ,       ‚Äì      . ,    ,   ,     ‚Äì    (,      :    ,         , ,  +  .            ).    ,         /     .          ,   . <br><br>  ,  ,      ,      ‚Äì ,   .       . ,       .   ,     ‚Äì   .      .     : <br><br> Stage 1 ‚Äì 3  (  ,  ) <br> Stage 2 ‚Äì 4  (     ) <br> Stage 3 ‚Äì 3  (     ,    ) <br> ,    JSON  ,     : <br><br><pre> <code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"unit_status"</span></span>: [ <span class="hljs-comment"><span class="hljs-comment">// Stage 1 {"unit_id": 1,"result": 2}, {"unit_id": 2,"result": 2}, {"unit_id": 3,"result": 2}, // Stage 2 {"unit_id": 4,"result": 2}, {"unit_id": 5,"result": 1}, {"unit_id": 6,"result": 1}, {"unit_id": 7,"result": 1} ]</span></span></code> </pre><br><br>  , - ,       ,        .       ¬´win¬ª      ¬´dead¬ª,             .     ,     ,    .       .     :) <br>    ,     ,        100%. <br><br>    .          ,  -     ,  . ,        ,         .  This is not very convenient.  ,     :    ¬´win¬ª ,   ¬´result¬ª    . <br><br>  ,   ¬´win¬ª  JSON.    ,    . <br><br><pre> <code class="hljs objectivec">MOVS R0, R6 BLX __floatsidf BL cJSON_CreateNumber LDR R1, =(unk_5D8C3240 ‚Äì <span class="hljs-number"><span class="hljs-number">0x5D84666E</span></span>) ; <span class="hljs-string"><span class="hljs-string">"win"</span></span> MOVS R2, R0 LDR R0, [SP,<span class="hljs-meta"><span class="hljs-meta">#0x30+var_2C] ADD R1, PC BL cJSON_AddItemToObject</span></span></code> </pre><br><br>   ,  <code>R6</code>  ,    ‚Äì  .          . <br>   ,           ,    .         ,    ,   <code>R6</code>  2.      ,     2 (0x2)  ¬´2¬ª (0x32 ASCII). <br>    ‚Äì  .  , Ida    ASM ,     . <br><br>        ?    ! <br><br> ,   -  ,      .  <a href="http://www.coranac.com/files/gba/re-ejected-thumbref2.pdf"></a>  <a href="https://ece.uwaterloo.ca/~ece222/ARM/ARM7-TDMI-manual-pt3.pdf"></a>      . <br>   hex-,      . <br> <code>MOVS R0, R6 ; 321</code> <br>  ,  <code>1C32</code> .   : <br> <code>0001 1100 0011 0000</code> <br>  ,   .   ARM (  ),  Thumb  Thumb-2. <br> ,     <code>MOVS</code> ,    .   ,    <code>ADDS R0, R6, #0</code> .    Ida      , -       . <br><br><pre> <code class="hljs dos"><span class="hljs-number"><span class="hljs-number">0001110</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span> <span class="hljs-number"><span class="hljs-number">110</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span> ADDS Imm Rn <span class="hljs-built_in"><span class="hljs-built_in">Rd</span></span></code> </pre><br><br> <code>ADDS</code> ‚Äì       <br> <code>Imm</code> ‚Äì immediate value.  ,    . <br> <code>Rn</code> ‚Äì ,     . <br> <code>Rd</code> ‚Äì destination register. ,       . <br><br> ,     . - ,    ,    ,    : <br> <code>SUBS R0, R6, #1</code> <br>  <code>SUBS</code>   <code>R6</code>      <code>R0</code> .  ,       <code>R6</code> ,  <code>R0</code>    . <br>    : <br><br><pre> <code class="hljs dos"><span class="hljs-number"><span class="hljs-number">0001111</span></span> <span class="hljs-number"><span class="hljs-number">001</span></span> <span class="hljs-number"><span class="hljs-number">110</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span> SUBS Imm Rn <span class="hljs-built_in"><span class="hljs-built_in">Rd</span></span></code> </pre><br><br>    ‚Äì <code>1E70</code> .  ‚Äì <code>701E</code> .      . <br> : <br> <code>MOVS R0, R6</code> <br> : <br> <code>SUBS R0, R6, #1</code> <br> <br>             <code>AESConvertEncode</code>  ,   . <br><br>    ,     . <br>    ,  . <br><br><pre> <code class="hljs swift"><span class="hljs-type"><span class="hljs-type">ADD</span></span> <span class="hljs-type"><span class="hljs-type">R8</span></span>, <span class="hljs-type"><span class="hljs-type">PC</span></span> ; <span class="hljs-string"><span class="hljs-string">"unit_id"</span></span> <span class="hljs-type"><span class="hljs-type">MOV</span></span> <span class="hljs-type"><span class="hljs-type">R9</span></span>, <span class="hljs-type"><span class="hljs-type">R3</span></span> <span class="hljs-type"><span class="hljs-type">ADD</span></span> <span class="hljs-type"><span class="hljs-type">R9</span></span>, <span class="hljs-type"><span class="hljs-type">PC</span></span> ; <span class="hljs-string"><span class="hljs-string">"result"</span></span> loc_5D8466E2 <span class="hljs-type"><span class="hljs-type">BL</span></span> cJSON_CreateObject <span class="hljs-type"><span class="hljs-type">MOVS</span></span> <span class="hljs-type"><span class="hljs-type">R4</span></span>, <span class="hljs-type"><span class="hljs-type">R0</span></span> <span class="hljs-type"><span class="hljs-type">LDMIA</span></span> <span class="hljs-type"><span class="hljs-type">R7!</span></span>, {<span class="hljs-type"><span class="hljs-type">R0</span></span>,<span class="hljs-type"><span class="hljs-type">R1</span></span>} <span class="hljs-type"><span class="hljs-type">BLX</span></span> __floatundidf <span class="hljs-type"><span class="hljs-type">BL</span></span> cJSON_CreateNumber <span class="hljs-type"><span class="hljs-type">MOV</span></span> <span class="hljs-type"><span class="hljs-type">R1</span></span>, <span class="hljs-type"><span class="hljs-type">R8</span></span> <span class="hljs-type"><span class="hljs-type">MOVS</span></span> <span class="hljs-type"><span class="hljs-type">R2</span></span>, <span class="hljs-type"><span class="hljs-type">R0</span></span> <span class="hljs-type"><span class="hljs-type">MOVS</span></span> <span class="hljs-type"><span class="hljs-type">R0</span></span>, <span class="hljs-type"><span class="hljs-type">R4</span></span> <span class="hljs-type"><span class="hljs-type">BL</span></span> cJSON_AddItemToObject <span class="hljs-type"><span class="hljs-type">LDMIA</span></span> <span class="hljs-type"><span class="hljs-type">R6!</span></span>, {<span class="hljs-type"><span class="hljs-type">R0</span></span>} <span class="hljs-type"><span class="hljs-type">BLX</span></span> __floatsidf <span class="hljs-type"><span class="hljs-type">BL</span></span> cJSON_CreateNumber <span class="hljs-type"><span class="hljs-type">MOV</span></span> <span class="hljs-type"><span class="hljs-type">R1</span></span>, <span class="hljs-type"><span class="hljs-type">R9</span></span> <span class="hljs-type"><span class="hljs-type">MOVS</span></span> <span class="hljs-type"><span class="hljs-type">R2</span></span>, <span class="hljs-type"><span class="hljs-type">R0</span></span> <span class="hljs-type"><span class="hljs-type">MOVS</span></span> <span class="hljs-type"><span class="hljs-type">R0</span></span>, <span class="hljs-type"><span class="hljs-type">R4</span></span> <span class="hljs-type"><span class="hljs-type">BL</span></span> cJSON_AddItemToObject <span class="hljs-type"><span class="hljs-type">ADDS</span></span> <span class="hljs-type"><span class="hljs-type">R5</span></span>, #<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">MOV</span></span> <span class="hljs-type"><span class="hljs-type">R0</span></span>, <span class="hljs-type"><span class="hljs-type">R10</span></span> <span class="hljs-type"><span class="hljs-type">MOVS</span></span> <span class="hljs-type"><span class="hljs-type">R1</span></span>, <span class="hljs-type"><span class="hljs-type">R4</span></span> <span class="hljs-type"><span class="hljs-type">BL</span></span> cJSON_AddItemToArray <span class="hljs-type"><span class="hljs-type">CMP</span></span> <span class="hljs-type"><span class="hljs-type">R5</span></span>, <span class="hljs-type"><span class="hljs-type">R11</span></span> <span class="hljs-type"><span class="hljs-type">BNE</span></span> loc_5D8466E2</code> </pre><br><br>       for. <br><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text">  <code>R11</code>   ,     : <br><br><pre> <code class="hljs 1c">ADDS R5, <span class="hljs-meta"><span class="hljs-meta">#1 ;   CMP R5, R11 ;      BNE loc_5D8466E2 ; </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  -   </span></span></code> </pre><br></div></div><br><br>    ‚Äì <code>R6</code> .  <code>LDMIA</code>     <code>R6</code> ,  <code>R6</code>           <code>R0</code> .      ,     <code>R0</code>  ‚Äì <code>MOVS R0, #2</code> <br><br><pre> <code class="hljs dos"><span class="hljs-number"><span class="hljs-number">00100</span></span> <span class="hljs-number"><span class="hljs-number">000</span></span> <span class="hljs-number"><span class="hljs-number">00000010</span></span> MOVS <span class="hljs-built_in"><span class="hljs-built_in">Rd</span></span> Imm</code> </pre><br><br> Hex ‚Äì <code>2002</code> .  ( <code>0220</code> )  . <br>  :   ,   ‚Ä¶ <br><br><img src="https://habrastorage.org/files/c91/e5a/d94/c91e5ad94b554f41bb02c891150aa42b.png"><br><br><img src="https://habrastorage.org/files/a32/f85/591/a32f855915f94b208300445c4d108257.png"><br><br><img src="https://habrastorage.org/files/263/4c0/4a2/2634c04a22314bb68e84760dddfdc6df.png"><br><br><img src="https://habrastorage.org/files/c9f/846/015/c9f846015c8a422cb47d61b6ed37d4a4.png"><br><br> Profit!    ,      .     ‚Äî    .       .   ,    ,       . <br><br><h4>  Instead of conclusion </h4><br>        - ,     ,       .    ,             .      ,   .      :          shared object.     ‚Äî     ?     C/C++   ,      .       " <code>sub_xxxxxxxx</code> ",  ,    ,    .      . <br><br> <i> ,    . <br>         . <br>      ‚Äî   .</i> </div><p>Source: <a href="https://habr.com/ru/post/232531/">https://habr.com/ru/post/232531/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232519/index.html">Sensor Hug helps to track water consumption throughout the day</a></li>
<li><a href="../232521/index.html">What is your procrastinator?</a></li>
<li><a href="../232523/index.html">Google's HTML5 Web Designer Update</a></li>
<li><a href="../232525/index.html">Imagrium: A framework for automating cross-platform testing of mobile applications.</a></li>
<li><a href="../232527/index.html">Efficient backup scripts</a></li>
<li><a href="../232533/index.html">The second meeting of the community JUG.EKB</a></li>
<li><a href="../232535/index.html">Looking for an ergonomic workplace</a></li>
<li><a href="../232537/index.html">How we nontrivially chose a place for coworking in Moscow and how we arranged everything inside</a></li>
<li><a href="../232539/index.html">Why we chose MongoDB</a></li>
<li><a href="../232543/index.html">How we designed and made True Image for Mac</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>