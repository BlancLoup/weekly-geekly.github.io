<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple USSD request in Android 4.0+</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In Android, there is still no API for USSD requests. The bug has been hanging for 6 years ! 
 I found different ways to create and retrieve informatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple USSD request in Android 4.0+</h1><div class="post__text post__text-html js-mediator-article">  In Android, there is still no API for USSD requests.  The bug has been <a href="http://code.google.com/p/android/issues/detail%3Fid%3D1285">hanging for 6 years</a> ! <br>  I found different ways to create and retrieve information from USSD requests, but in the end none of them arranged it. <br>  Then I found references to the fact that with the help of the updated services in Android 4.0, the specials.  features you can easily get the contents of the windows and so get the text from the window and the result of the USSD request.  I tried - it turns out great!  Without rebooting and securely. <a name="habracut"></a><br><br><h5>  Submit request </h5><br>  First, you need to send the USSD request itself.  It is quite simple: <br><br><pre><code class="java hljs">String encodedHash = Uri.encode(<span class="hljs-string"><span class="hljs-string">"#"</span></span>); String ussd = <span class="hljs-string"><span class="hljs-string">"*100"</span></span> + encodedHash; startActivityForResult(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"android.intent.action.CALL"</span></span>, Uri.parse(<span class="hljs-string"><span class="hljs-string">"tel:"</span></span> + ussd)), <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  To get permission to work with the phone, you need to get permission, for this we register in Android.Manifest.xml: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="java hljs">&lt;uses-permission android:name=<span class="hljs-string"><span class="hljs-string">"android.permission.CALL_PHONE"</span></span> /&gt;</code> </pre><br>  OK, the request is sent from the program, now you have to work hard to get its text. <br><br><h5>  Accessibility service </h5><br>  To work with specials.  capabilities need to export our service.  To do this, add to Android.Manifest.xml: <br><br><pre> <code class="java hljs">&lt;service android:name=<span class="hljs-string"><span class="hljs-string">".USSDService"</span></span> android:permission=<span class="hljs-string"><span class="hljs-string">"android.permission.BIND_ACCESSIBILITY_SERVICE"</span></span> &gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.accessibilityservice.AccessibilityService"</span></span> /&gt; &lt;/intent-filter&gt; &lt;/service&gt;</code> </pre><br>  Instead of USSDService write the name of your class. <br><br>  I took the class itself almost unchanged <a href="https://gist.github.com/qihnus/1909616">from here</a> . <br><br>  In order not to get too much, change the method onServiceConnected: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onServiceConnected</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onServiceConnected(); Log.v(TAG, <span class="hljs-string"><span class="hljs-string">"onServiceConnected"</span></span>); AccessibilityServiceInfo info = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AccessibilityServiceInfo(); info.flags = AccessibilityServiceInfo.DEFAULT; info.packageNames = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] {<span class="hljs-string"><span class="hljs-string">"com.android.phone"</span></span>}; info.eventTypes = AccessibilityEvent.TYPE_WINDOW_STATE_CHANGED; info.feedbackType = AccessibilityServiceInfo.FEEDBACK_GENERIC; setServiceInfo(info); }</code> </pre><br>  You will also need an additional filter in the onAccessibilityEvent method: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAccessibilityEvent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AccessibilityEvent event)</span></span></span><span class="hljs-function"> </span></span>{ String text = getEventText(event); Log.v(TAG, String.format( <span class="hljs-string"><span class="hljs-string">"onAccessibilityEvent: [type] %s [class] %s [package] %s [time] %s [text] %s"</span></span>, getEventType(event), event.getClassName(), event.getPackageName(), event.getEventTime(), getEventText(event))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.getClassName().equals(<span class="hljs-string"><span class="hljs-string">"android.app.AlertDialog"</span></span>)) { performGlobalAction(GLOBAL_ACTION_BACK); Log.i(TAG, text); Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"REFRESH"</span></span>); intent.putExtra(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, text); sendBroadcast(intent); } }</code> </pre><br>  The performGlobalAction method (GLOBAL_ACTION_BACK) requires Android 4.1+, if you don‚Äôt use it, you can fit in 4.0.  It closes the window immediately after an AlertDialog appears, so the window will not remain to hang. <br>  For simplicity, I have already added the sendBroadcast method to send the received message further. <br>  To get the message, add the following methods to the required class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BroadcastReceiver mMessageReceiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BroadcastReceiver() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Intent intent)</span></span></span><span class="hljs-function"> </span></span>{ String message = intent.getStringExtra(<span class="hljs-string"><span class="hljs-string">"message"</span></span>); Log.i(<span class="hljs-string"><span class="hljs-string">"receiver"</span></span>, <span class="hljs-string"><span class="hljs-string">"Got message: "</span></span> + message); showText(message); } };</code> </pre><br>  showText is your procedure that does something with the received text. <br><br>  For BroadcastReceiver to work, you need to add some code to onCreate () or a similar method of your class: <br><br><pre> <code class="java hljs">IntentFilter mFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(<span class="hljs-string"><span class="hljs-string">"REFRESH"</span></span>); mContext.registerReceiver(mMessageReceiver, mFilter); isRegistered = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>;</code> </pre><br>  And this is in onPause () or similar: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isRegistered) { mContext.unregisterReceiver(mMessageReceiver); isRegistered = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); }</code> </pre><br>  That's all!  As you can see, simple and reliable. <br><br><h5>  Underwater rocks </h5><br>  There may be problems with working in the background: for example, if the screen is locked, then the AccessibilityService will not work at all - you need to wake the device.  In the unlocked state, the request will always come to the fore, which is also not convenient. <br><br>  AccessibilityService will listen constantly, even when the user himself dials the USSD code or, even worse, if com.android.phone throws an AlertDialog.  So it is necessary either to enhance the filters (for example, to parse only if there is a certain sequence in the message), or to use the flag to process events only if your application makes a USSD request. <br><br>  And do not forget to customize the settings.  opportunities to activate your application, by the way for this, it would also be nice to add a check%) <br><br>  Alternatives: <br>  <a href="http://habrahabr.ru/post/130717/">habrahabr.ru/post/130717</a> - takes the answer from the logs.  It is inconvenient that in order to suppress the window, it is necessary to resort to hacks, and to do this through the AccessibilityService is cleaner and simpler. <br>  <a href="https://github.com/alaasalman/ussdinterceptor">github.com/alaasalman/ussdinterceptor</a> is still the old way.  Uses undocumented class.  According to reviews, often falls off and requires a reboot. </div><p>Source: <a href="https://habr.com/ru/post/234425/">https://habr.com/ru/post/234425/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234409/index.html">BaasCMS - no backend needed</a></li>
<li><a href="../234411/index.html">The digest of interesting news and materials from the world of PHP No. 46 (August 3 - 24, 2014)</a></li>
<li><a href="../234413/index.html">How to display 350 million rows from a database on a web form</a></li>
<li><a href="../234415/index.html">Complain about health: as we understood that the main thing is support</a></li>
<li><a href="../234417/index.html">Some interesting and useful things for web developer # 26</a></li>
<li><a href="../234427/index.html">Bookmarklet: Analysis of Essential Points, Part One</a></li>
<li><a href="../234429/index.html">Doctors from Peking University for the first time implanted a vertebra printed on a 3D printer to a man</a></li>
<li><a href="../23443/index.html">The largest domain registration.RU this year</a></li>
<li><a href="../234431/index.html">Interorbital tug</a></li>
<li><a href="../234433/index.html">A magic object for storing and transmitting heterogeneous data with type and value checking</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>