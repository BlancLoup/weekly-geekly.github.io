<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>On the way to creating a secure web resource. Part 2 - Development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I am pleased to continue to share my views on approaches to creating secure web resources and web applications and move on from the first part , which...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>On the way to creating a secure web resource. Part 2 - Development</h1><div class="post__text post__text-html js-mediator-article">  I am pleased to continue to share my views on approaches to creating secure web resources and web applications and move on from the <a href="http://habrahabr.ru/post/168739/">first part</a> , which contains some generally useful security instructions for creating an infrastructure for a project, and to the second, developing the application itself. <br><br><div class="spoiler">  <b class="spoiler_title">The security hole has not been fixed, as product managers want a new feature</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/4a1/d25/a93/4a1d25a93f67c6abe4a35565973caf27.gif"></div></div><br><a name="habracut"></a><br><h4>  Programmers </h4><br>  It is logical to start with them, with their knowledge and experience.  The fault of the employee himself is that he does not have sufficient knowledge of security development is minimal.  Primary responsibility on management, HR and anyone else.  The problem occurs at the recruitment stage.  Consider a typical interview, even based on the guides, which were laid out here on Habr√©: <br><br><ul><li>  <a href="http://habrahabr.ru/post/21681/">PHP developer job interview</a> - rating 54 </li><li>  <a href="http://habrahabr.ru/post/148509/">Candidates with the declared status of "PHP-expert" and questions on logic</a> - rating 46, there is also an interview plan </li><li>  <a href="http://habrahabr.ru/post/67963/">Interview.</a>  <a href="http://habrahabr.ru/post/67963/">Today</a> - rating 68 </li><li>  <a href="http://habrahabr.ru/post/120642/">The perfect job interview?</a>  - rating 71, discussion of the ‚Äúperfect‚Äù interview </li></ul><br>  No one anywhere (including the last article in the comments) has ever mentioned the security aspects.  "The fish rots from the head" and this is a fact.  What do I suggest?  When recruiting employees, firstly, to figure it out myself, although in the basic points of programming, including  security view and ask questions about them.  And I propose the following questions, the answers to which (and most importantly - a detailed explanation) will give at least some picture of the developer‚Äôs knowledge in the field of security.  Choose some typical constructions and vulnerabilities in them: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Xss </h5><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $name = $_GET[<span class="hljs-string"><span class="hljs-string">'name'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello, &lt;b&gt;$name&lt;/b&gt;!"</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br>  We ask opinion.  It doesn't matter if the applicant knows whether it is reflected, stored or DOM XSS.  The main thing is that he understands that such constructions are unacceptable (and it will be cool if he knows the consequences of such constructions. And even cooler is the solution).  The task can be complicated with the substitution of data through JS, obtained from somewhere. <br><br><h5>  SQLi </h5><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $value = <span class="hljs-string"><span class="hljs-string">"id = "</span></span>.$_GET[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]; $select-&gt;where($value); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  This is a reference to one of <a href="http://habrahabr.ru/post/140145/"><abbr title="The path to SQL injection in the Zend Framework">my previous articles</abbr></a> (the problem is not contrived, but was taken from practice).  And so, we are looking for a specialist in Zend, he is cool to answer all the questions, but ... It is quite normal for such constructions.  Or substitutes in where the array that came from GET / POST through implode. <br><br><h5>  File upload </h5><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_FILES[<span class="hljs-string"><span class="hljs-string">"file"</span></span>][<span class="hljs-string"><span class="hljs-string">"type"</span></span>] == <span class="hljs-string"><span class="hljs-string">"image/gif"</span></span>) || $_FILES[<span class="hljs-string"><span class="hljs-string">"file"</span></span>][<span class="hljs-string"><span class="hljs-string">"type"</span></span>] == <span class="hljs-string"><span class="hljs-string">"image/jpeg"</span></span> || $_FILES[<span class="hljs-string"><span class="hljs-string">"file"</span></span>][<span class="hljs-string"><span class="hljs-string">"type"</span></span>] == <span class="hljs-string"><span class="hljs-string">"image/png"</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Uploaded file is image, all ok move_uploaded_file ... } </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br>  Loading pictures.  People who have at least some experience will say at once that no one writes this anymore.  $ _FILES ["file"] ["type"] is assigned a value from HTTP, which is easily "forged".  Well, okay, the candidate says that we just change to ‚Äúfile - ib‚Äù or use PEAR / Zend for this and that‚Äôs the end (at the same time it refers to <a href="http://stackoverflow.com/questions/652002/detecting-mime-type-in-php">stackoverflow</a> ).  But here he will be wrong (but better).  It is quite easy to create an evil.php file containing php code, while having image headers.  So what is needed is to check the headers of an already received file (via `file`, PEAR or Zend, for example), and set an extension to it, based on the specified mime-type. <br><br>  I want to say that incorrect (inaccurate) answers should not be decisive when accepting an employee (this opinion is based on rational motives, not from a security point of view), but keep in mind that an employee needs to study certain material in this area.  And the first time you need to check its code, especially in some important points (like downloading files). <br><br>  And we have already accepted employees.  They need to conduct a separate work and periodically "give heat", sorting out any found vulnerable code for all.  Or at least a mailing list with links to read on this topic. <br><br>  And so, we move from the human to the technical factor. <br><br><h5>  Hierarchy </h5><br>  I'll start with the directory structure.  It is practiced by many: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.com</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">config</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ini</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">framework</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">src</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">controller</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">model</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">view</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">crontab</span></span> ‚îÇ  ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">daily_flush_stat</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.php</span></span> ‚îÇ  ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">weekly_remove_cache</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.sh</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">htdocs</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">css</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">img</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.php</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">js</span></span></code> </pre> <br>  I use a similar directory structure, and I see no problems with it.  Let's start with the last item - htdocs.  In htdocs we have only 1 php script - index.php (referring to the first part of the article), a kind of bootsrtap, which starts the whole application and gives the necessary functionality depending on the location.  There is all the static and upload from users.  Only 1 file remains executable to php, and this is great! <br><br>  app - application, rendered as htdocs, this excludes such constructions in module files as useless as: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!defined(<span class="hljs-string"><span class="hljs-string">'IN_SITE'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> (<span class="hljs-string"><span class="hljs-string">"Hack attempt!"</span></span>);</code> </pre><br>  Direct access to files is basically impossible.  Also, we do not need to create a bunch of empty index.html in each folder, if for some unknown reason we have enabled indexing in directories and we cannot disable it. <br><br>  config.ini is also not accessible from the web, so it will not be given to plain-text by direct access to it. <br><br>  Cron-scripts (or scripts for jenkins'a) are also conveniently stored in the directory we need. <br><br><h5>  Application code </h5><br>  Let us analyze the most popular pattern of using design patterns - MVC and decide where we are and what will be. <br><br><h6>  Model </h6><br>  Validation.  Much depends on what is accepted in your team.  Usually, nevertheless, validation of data is given here at model initialization.  But it can be successfully done elsewhere (service as an example). <br><br><h6>  View </h6><br>  Here I will consider the perennial question - where to convert HTML special characters?  For example, phpbb does this when writing data to the database and, as a result, the data takes up more space.  Message <pre> <code class="hljs ruby">WOW <span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-string"><span class="hljs-string">"NEW NEW NEW"</span></span></code> </pre>  will take not 42 bytes (in UTF8), but 82, since it will be <pre> <code class="hljs pgsql">WOW &amp;gt;&amp;gt;&amp;gt; &amp;quot;<span class="hljs-built_in"><span class="hljs-built_in">NEW</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NEW</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NEW</span></span>&amp;quot;</code> </pre> <br>  It can also lead to errors in the order of data validation (which are present in phpbb). <br>  My opinion is that the data should be recorded in the form in which they came.  And convert specials.  output characters in the template engine. <br>  Of course, direct conversion specials.  characters when writing to the database is more secure than converting them to the output.  Since  in one place the developer did everything correctly, and in another place he forgot (or another developer brought them).  But the first option can be considered a crutch. <br><br><h6>  Controller </h6><br>  The main vulnerabilities are most often found in places with data manipulation.  Here I want to repeat what I wrote about in my first articles, and suggest using the following construction: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// try something } catch (Exception $e) { echo ",   .         !" errorLog($e-&gt;getMessage()); }</span></span></code> </pre><br>  Where errorLog () will add an error entry to the database, send an email to dev@example.com or something else.  You will always be aware of all the problems that occur on the project.  Also, if we use New Relic (which was mentioned in the first part of the article), then we will get similar beautiful monitoring: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/fa4/0c6/96e/fa40c696e60b96110217cf55ffc0a140.jpg"></a> <br>  <i>An example of error logging when someone tried to find the address of phpmyadmin, for example, using <a href="http://en.wikipedia.org/wiki/Nikto_Web_Scanner">nikto</a></i> <br><br>  Time, log, and the number of occurrences of this error.  error.log in the modern version. <br><br><h5>  Iterations </h5><br>  If your product is updated by iterations, then the process of checking the paged code for production easily fits into such a process organization.  A full diff is done and viewed by experienced programmers or the security department (person). <br><br><h5>  Framework, CMS / CMF </h5><br>  Product development on the framework is not a panacea for security (this was especially confirmed by RoR from the very beginning of the year).  Using the most popular engines and full use of their API in the development of modules is also not a panacea ( <a href="http://lab.onsec.ru/2013/01/wordpress-xmlrpc-pingback-additional.html">WordPress =&gt; 3.5 XMLRPC pingback additional issues</a> ). <br><br><h5>  Findings? </h5><br>  My opinion remains the same, that it is better to write all the code from scratch, while already having experience in security (and better in hacking / pentest).  But, of course, it is practically inappropriate in the modern world, since it requires quite large additional costs for a business (and it‚Äôs quite difficult to find so many specialists at once). <br>  By the way, on this subject I have an excellent schedule (about which I learned from Alexey Babenko from Informzashchita, who himself, in turn, found out about him on one of the overseas internships on security) <br><br><img src="https://habrastorage.org/storage2/e3f/e79/984/e3fe7998478fdc57abaa19fbf5eafb86.png"><br>  <i>The optimal level of security at minimum cost.</i>  <i>Picture found <a href="http://www.musc.edu/security/guidelines/MUSC-Risk-Management-Guidelines.html">here</a></i> <br><br>  From which we can conclude that the initial investment gives a quick and sharp leap in security.  But the more investments there are, the less the risks will decrease. <br><br><h6>  Series: <br><ul><li>  <a href="http://habrahabr.ru/post/168739/">On the way to creating a secure web resource.</a>  <a href="http://habrahabr.ru/post/168739/">Part 1 - server software</a> </li><li>  On the way to creating a secure web resource.  Part 2 - Development </li><li>  <a href="http://habrahabr.ru/post/170167/">On the way to creating a secure (web) resource.</a>  <a href="http://habrahabr.ru/post/170167/">Part 3 - office, staff</a> </li></ul></h6></div><p>Source: <a href="https://habr.com/ru/post/168823/">https://habr.com/ru/post/168823/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../168807/index.html">Playstation: how it was</a></li>
<li><a href="../168809/index.html">ICANN won the .WEB domain case</a></li>
<li><a href="../168811/index.html">.Net: we get Portable Library and UI</a></li>
<li><a href="../168813/index.html">Refinement completion Ricoh Dx2330</a></li>
<li><a href="../168817/index.html">My experience of introducing R or "I Love R"</a></li>
<li><a href="../168827/index.html">Type conversion to Boost.Python. We do the conversion between the usual types of C + + and Python</a></li>
<li><a href="../168829/index.html">File Manager (Silex + Kendo UI) - Tutorial</a></li>
<li><a href="../168831/index.html">keyContentSwitcher - JS library for quick switch creation</a></li>
<li><a href="../168833/index.html">People and organizations that influenced the creation and development of the Internet</a></li>
<li><a href="../168835/index.html">Installing Fusion Drive in iMac 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>