<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Laravel 5. Hierarchical RBAC for the smallest</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you obviously know, RBAC is role-based access control . Everyone who created the systems a little larger than the home page and a little smaller th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Laravel 5. Hierarchical RBAC for the smallest</h1><div class="post__text post__text-html js-mediator-article"><p>  As you obviously know, RBAC is <a href="https://ru.wikipedia.org/wiki/%25D0%25A3%25D0%25BF%25D1%2580%25D0%25B0%25D0%25B2%25D0%25BB%25D0%25B5%25D0%25BD%25D0%25B8%25D0%25B5_%25D0%25B4%25D0%25BE%25D1%2581%25D1%2582%25D1%2583%25D0%25BF%25D0%25BE%25D0%25BC_%25D0%25BD%25D0%25B0_%25D0%25BE%25D1%2581%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25B5_%25D1%2580%25D0%25BE%25D0%25BB%25D0%25B5%25D0%25B9">role-based access control</a> .  Everyone who created the systems a little larger than the home page and a little smaller than the state services, thought about how to differentiate the rights of users. </p><br><p>  In this article I will not talk about what RBAC is and why it‚Äôs good (although I‚Äôll tell you a little, of course), and I‚Äôll introduce you to my modest development ( <a href="https://github.com/dlnsk/h-rbac">h-rbac</a> ) and try to explain why it is better in some aspects than famous "monsters". </p><a name="habracut"></a><br><h2 id="vstuplenie">  Introduction </h2><br><p>  The two pillars on which RBAC holds are <strong>roles</strong> and <strong>operations</strong> .  I like the word ‚Äúoperation‚Äù more than ‚Äúresolution‚Äù, and the meaning reflects more correctly.  It looks like this: </p><br><blockquote>  <em>Code ‚Üí Operation ‚Üí Role ‚Üí User</em> </blockquote><p>  Thus, in the code, we check the possibility of performing the <em>operation</em> : </p><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($request-&gt;user()-&gt;can(<span class="hljs-string"><span class="hljs-string">'add-to-favorites'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//  -       }</span></span></code> </pre> <br><p>  In turn, the RBAC module determines whether the specified operation is allowed for a given user (that is, whether it is contained in his role) and, if so, the block content is executed. </p><br><p>  In no case should you check in the code that the user has a role, since  Today, the "manager" can add to favorites, but tomorrow can not.  Searching by text and excluding individual roles from checks is not a thankful business; in fact, there are ‚Äúoperations‚Äù for this. </p><br><p>  The operation is always directly connected with the program block (see the example above) and if you change roles here, you don‚Äôt have to change anything.  But operations are included and excluded easily, simply and centrally. </p><br><p>  Usually a list of roles and operations is stored in a database.  <em>Users</em> and <em>roles</em> are most often associated with the many-to-many relationship, and <em>roles</em> with <em>operations</em> are associated with the same attitude. </p><br><h2 id="mastodonty">  Mastodon </h2><br><p><del>  Everyone who created the system a little big ... </del>  I repeat something.  In short, you all know the main players of the market access restrictions for Laravel.  It: </p><br><ul><li>  <a href="https://github.com/Zizaco/entrust">Entrust</a> </li><li>  <a href="https://github.com/cartalyst/sentinel">Centinel</a> </li><li>  <a href="https://github.com/romanbican/roles">Roles</a> </li><li>  <a href="https://github.com/JosephSilber/bouncer">Bouncer</a> </li><li>  <a href="https://github.com/santigarcor/laratrust">Laratrust</a> </li></ul><br><p>  These are really serious products that have many different "buns" like <em>redefining operations</em> for a specific user, etc., but I have one simple question for them ( <em>goodbye karma, we were good together</em> ): </p><br><p>  <strong>How to allow the user to edit <em>only their</em> articles?</strong> </p><br><p>  Hmm ... and there are no built-in mechanisms for this!  And it is very strange, because  In most systems, users generate some kind of content (for example, articles) and should be able to edit it without having access to editing someone else‚Äôs. </p><br><p>  <strong>And also:</strong> what if my project is not so big?  What if all this hemorrhoids with storing roles and operations in the database, linking tables for many-to-many and creating a whole UI to manage the entire farm is redundant? <br>  - Ta-dam! </p><br><h2 id="bolshoy-sekret-dlya-malenkoy"><del>  Big secret </del>  for a little ... </h2><br><p>  So, it's time to talk about your own <del>  R </del>  clothes  The title of the article does not accidentally sound "... RBAC for the smallest."  This, of course, is not about the performance characteristics of programmers, but rather about the size of projects (and, of course, this estimate is very conditional). </p><br><p>  If your project does not have a lot of operations and not a lot of roles, and you <del>  do not mind </del>  dreamed of storing them as an array, then I‚Äôm happy to introduce the <a href="https://github.com/dlnsk/h-rbac">h-rbac module</a> (hierarchical RBAC with callbacks). </p><br><blockquote>  There are no contradictions in order to add different providers to the module and store roles and operations even in the database, at least in <del>  gp ... </del>  any other place of interest. </blockquote><p>  I just want to admit that the principle used in this module was spied by me in Yii.  It was spared from an unnecessary (in my opinion) <em>Task</em> entity and a real perversion in the form of bizRule, computed using <code>eval()</code> (of course, I'm talking about Yii 1.1, in 2.0 it was different, but, in my opinion, also quite confusing ). </p><br><h4 id="trebovaniya">  Requirements </h4><br><p>  <em>To work with the module requires Laravel 5.1 or higher.</em> </p><br><p>  I want to start with the fact that the standard system of permissions (operations) <a href="https://laravel.com/docs/5.1/authorization">appeared</a> in Laravel since version 5.1.  It has a good infrastructure, many useful methods, is supported in the blade and even allows you <em>to allow the user to edit his articles</em> (ie, pass arguments to the check), but (!) There are no roles at all ... </p><br><p>  ... all users are equal - just some kind of democracy.  But we all know that there must be someone "more equal" than the rest.  No other way! </p><br><p>  So, the <a href="https://github.com/dlnsk/h-rbac">h-rbac module</a> , in fact, is a superstructure over the standard authorization mechanism (not to be confused with authentication!), Which adds roles and a hierarchy of operations.  Therefore, you will continue to use absolutely all the standard "buns", but in the context of the presence of roles. </p><br><h4 id="ustanovka">  Installation </h4><br><p>  Using Composer </p><br><pre> <code class="bash hljs">$ composer require dlnsk/h-rbac</code> </pre> <br><p>  We register the provider in config / app.php </p><br><pre> <code class="php hljs">Dlnsk\HierarchicalRBAC\HRBACServiceProvider::class,</code> </pre> <br><p>  Publish the items we need </p><br><pre> <code class="bash hljs">$ php artisan vendor:publish --provider=<span class="hljs-string"><span class="hljs-string">"Dlnsk\HierarchicalRBAC\HRBACServiceProvider"</span></span></code> </pre> <br><p>  namely: </p><br><ul><li>  configuration file (config / h-rbac.php) </li><li>  migration (adds a text field to the <code>users</code> table) </li><li>  configuration class roles, operations and callbacks (app / Classes / Authorization / AuthorizationClass.php) </li></ul><br><p>  Yes, dear friends, as the title says, this is a ‚Äúfor the little ones‚Äù module, so the user can have only one role!  But on the other hand, because the role - it's just an array, add another easy. </p><br><h2 id="blekdzhek-i-devochki">  Blackjack and girls </h2><br><p>  Take the following roles: </p><br><ul><li>  admin </li><li>  manager </li><li>  user </li></ul><br><p>  and a set of operations: </p><br><ul><li>  update-post </li><li>  add-to-favorites </li></ul><br><p>  Suppose we want to divide users into those who can edit all articles, those who will edit articles only in certain categories and those who can only edit their own articles. </p><br><p>  To do this, we actually have to create three operations and combine them into a chain from the most open to the most limited: </p><br><blockquote>  update-post ‚Üí update-post-in-category ‚Üí update-own-post </blockquote><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizationClass</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authorization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPermissions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'update-post'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">//   "" 'description' =&gt; '  ', //     ()  'next' =&gt; 'update-post-in-category', ], 'update-post-in-category' =&gt; [ 'description' =&gt; '    ', 'next' =&gt; 'update-own-post', ], 'update-own-post' =&gt; [ 'description' =&gt; '  ', //    ], //  'add-to-favorites' =&gt; [ 'description' =&gt; '    ', ], ]; } }</span></span></code> </pre> <br><p>  Assigning operations to roles is very simple.  Who can do what is obvious: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizationClass</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authorization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRoles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'admin'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'update-post'</span></span>, ], <span class="hljs-string"><span class="hljs-string">'manager'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'update-post-in-category'</span></span>, ], <span class="hljs-string"><span class="hljs-string">'user'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'update-own-post'</span></span>, <span class="hljs-string"><span class="hljs-string">'add-to-favorites'</span></span>, ], ]; } }</code> </pre> <br><p>  Please note that in essence we only have two <code>update-post</code> and <code>add-to-favorites</code> operations, and we should check the possibility of their implementation.  <code>update-post-in-category</code> and <code>update-own-post</code> support operations will be checked automatically, since  they are the contents of the one with the <code>update-post</code> chain. </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// PostController.php class PostController extends Controller { public function update(Post $post) { $this-&gt;authorize('update-post', $post); // ,    } }</span></span></code> </pre> <br><pre> <code class="html hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- post-view.php --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $post-&gt;title }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post-tools"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post author"</span></span></span><span class="hljs-tag">&gt;</span></span>{{ $post-&gt;author-&gt;username }}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @can('update-post', $post) <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post update"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @endcan @can('add-to-favorites') <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"post add-favorite"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> @endcan <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  The <code>add-to-favorites</code> operation implies the ability to add any article to favorites, i.e.  no additional checks are needed, it is enough that this operation is contained in the user role.  For this reason, you can not transfer the <code>$post</code> object to the scan (but I would pass it in any case, since there are no additional conditions today, but they may appear tomorrow). </p><br><p>  It remains to figure out how to do the checks for those additional conditions for <code>update-post-in-category</code> and <code>update-own-post</code> .  To do this, it is enough to add two methods (the names of the methods are obtained by camelization (o-pa!) The name of the operation): </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizationClass</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authorization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updatePostInCategory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($user, $post, $permission)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      ,  $post  id  $post = $this-&gt;getModel(\App\Post::class, $post); return $user-&gt;category_id === $post-&gt;category_id; } public function updateOwnPost($user, $post, $permission) { $post = $this-&gt;getModel(\App\Post::class, $post); return $user-&gt;id === $post-&gt;user_id; } }</span></span></code> </pre> <br><p>  The <code>$permission</code> parameter in both of these methods will contain the name of the originally requested <code>update-post</code> operation. </p><br><h4 id="logika-proverki">  Check logic </h4><br><p>  All operations in the chain are checked one by one in the order selected by the user and the operation: </p><br><ul><li>  <strong>allowed</strong> if it is contained in a role and there is no additional check function; </li><li>  <strong>resolved</strong> if it is contained in a role and the additional verification function returns <strong>true</strong> (verification of the remaining operations of the chain is terminated) </li><li>  <strong>prohibited</strong> if none of the chain operations is contained in a role; </li><li>  <strong>It is prohibited</strong> if for all operations of the chain contained in the role, the additional check functions returned <strong>false</strong> . </li></ul><br><h4 id="fishka-dlya-lenivyh">  Chip for the lazy </h4><br><p>  Let's add a <code>delete-post</code> operation.  Logic dictates that the user can delete articles that he can edit.  A similar situation occurs quite often and in order not to create an additional chain of operations and absolutely identical argument checking functions, we use one trick - the <code>equal</code> parameter: </p><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthorizationClass</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Authorization</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPermissions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'update-post'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">//   "" 'description' =&gt; '  ', //     ()  'next' =&gt; 'update-post-in-category', ], 'update-post-in-category' =&gt; [ 'description' =&gt; '    ', 'next' =&gt; 'update-own-post', ], 'update-own-post' =&gt; [ 'description' =&gt; '  ', //    ], //  'add-to-favorites' =&gt; [ 'description' =&gt; '    ', ], //  'delete-post' =&gt; [ 'description' =&gt; ' ', 'equal' =&gt; 'update-post', //     ], ]; } public function getRoles() { return [ 'admin' =&gt; [ 'update-post', 'delete-post', ], 'manager' =&gt; [ 'update-post-in-category', ], 'user' =&gt; [ 'update-own-post', 'add-to-favorites', 'delete-post', ], ]; } }</span></span></code> </pre> <br><p>  Based on this example, the <em>admin</em> will be able to delete any posts, the <em>user</em> only his own, but the <em>manager</em> will not be able to delete anything at all, because  in its role there is no <code>delete-post</code> operation, and therefore nothing is required to be checked. </p><br><h2 id="pishite-shura-pishite">  Write, Shura, write ... </h2><br><p>  As mentioned <a href="https://habr.com/ru/post/321678/">earlier</a> , the module is an add-on above the standard authorization system for Laravel 5.1 and above, so you need to use it as it is written in the <a href="https://laravel.com/docs/5.4/authorization">documentation</a> , and if it is short, here are some examples: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (\Gate::allows(<span class="hljs-string"><span class="hljs-string">'update-post'</span></span>, $post)) { <span class="hljs-comment"><span class="hljs-comment">//  -,      } ... if (\Gate::denies('update-post', $post)) { abort(403); } ... if (\Gate::forUser($user)-&gt;allows('update-post', $post)) { //  -,      }</span></span></code> </pre> <br><p>  From the User model: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($request-&gt;user()-&gt;can(<span class="hljs-string"><span class="hljs-string">'update-post'</span></span>, $post)) { <span class="hljs-comment"><span class="hljs-comment">//  - } ... if ($request-&gt;user()-&gt;cannot('update-post', $post)) { abort(403); }</span></span></code> </pre> <br><p>  In the controller: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;authorize(<span class="hljs-string"><span class="hljs-string">'update-post'</span></span>, $post);</code> </pre> <br><p>  Using Blade </p><br><pre> <code class="html hljs xml">@can('update-post', $post) <span class="hljs-comment"><span class="hljs-comment">&lt;!--      --&gt;</span></span> @else <span class="hljs-comment"><span class="hljs-comment">&lt;!--       --&gt;</span></span> @endcan @cannot('update-post', $post) <span class="hljs-comment"><span class="hljs-comment">&lt;!--       --&gt;</span></span> @endcannot</code> </pre> <br><p>  In addition, especially for <del>  bad </del>  boys and girls, an additional <code>@role</code> directive has been <code>@role</code> that can be used with <code>@else</code> </p><br><pre> <code class="html hljs xml">@role('user|manager') <span class="hljs-comment"><span class="hljs-comment">&lt;!--       --&gt;</span></span> @endrole</code> </pre> <br><p>  This is a module that combines the power of standard features, really necessary functionality and ease of configuration.  Thanks for attention! </p><br><div class="spoiler">  <b class="spoiler_title">All configuration of operations and roles in one place</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// app/Classes/Authorization/AuthorizationClass.php </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">&lt;?php</span></span></span><span class="hljs-comment"> namespace App\Classes\Authorization; use Dlnsk\HierarchicalRBAC\Authorization; class AuthorizationClass extends Authorization { public function getPermissions() { return [ 'update-post' =&gt; [ //   "" 'description' =&gt; '  ', //     ()  'next' =&gt; 'update-post-in-category', ], 'update-post-in-category' =&gt; [ 'description' =&gt; '    ', 'next' =&gt; 'update-own-post', ], 'update-own-post' =&gt; [ 'description' =&gt; '  ', //    ], //  'add-to-favorites' =&gt; [ 'description' =&gt; '    ', ], //  'delete-post' =&gt; [ 'description' =&gt; ' ', 'equal' =&gt; 'update-post', //     ], ]; } public function getRoles() { return [ 'admin' =&gt; [ 'update-post', 'delete-post', ], 'manager' =&gt; [ 'update-post-in-category', ], 'user' =&gt; [ 'update-own-post', 'add-to-favorites', 'delete-post', ], ]; } ////////////// Callbacks /////////////// public function updatePostInCategory($user, $post) { //      ,  $post  id  $post = $this-&gt;getModel(\App\Post::class, $post); return $user-&gt;category_id === $post-&gt;category_id; } public function updateOwnPost($user, $post) { $post = $this-&gt;getModel(\App\Post::class, $post); return $user-&gt;id === $post-&gt;user_id; } }</span></span></code> </pre> </div></div><br><p>  <strong>PS:</strong> </p><br><p>  I almost forgot ... The names of the roles "admin", "manager" and "user" are taken in this article just as an example.  In fact, the "admin" role is built into the module and does not need to be defined.  It makes the user a SUPER USER.  No checks are applied to him, he is allowed absolutely everything.  Cheers, comrades! </p><br><p>  <strong>References:</strong> </p><br><ol><li>  <a href="https://habrahabr.ru/post/177873">RBAC Authorization in YII and LDAP</a> </li><li>  <a href="https://github.com/dlnsk/h-rbac">H-rbac module on github</a> </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/321678/">https://habr.com/ru/post/321678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321668/index.html">Versioning build artifacts in Gradle using git tag, brunch and commit names</a></li>
<li><a href="../321670/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ249 (February 6 - 12, 2017)</a></li>
<li><a href="../321672/index.html">PHP Digest number 102 - interesting news, materials and tools (February 1 - 12, 2017)</a></li>
<li><a href="../321674/index.html">How does the FIFO work</a></li>
<li><a href="../321676/index.html">FPGA for the programmer, simple recipes</a></li>
<li><a href="../321682/index.html">Login to the site using Telegram</a></li>
<li><a href="../321684/index.html">Zeigarnik effect in practice</a></li>
<li><a href="../321686/index.html">Development of transactional microservices using aggregates, Event Sourcing and CQRS (Part 1)</a></li>
<li><a href="../321688/index.html">‚ÄúLike an Iceberg in the Ocean‚Äù: Data Center Cooling Technologies</a></li>
<li><a href="../321690/index.html">Iterative Design and GitHub</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>