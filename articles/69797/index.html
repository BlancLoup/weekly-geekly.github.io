<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java virtual machine bytecode structure</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, articles appeared on Habr√© that affect the manipulation of bytecode. What made me post the following article on its structure. 

 The java p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java virtual machine bytecode structure</h1><div class="post__text post__text-html js-mediator-article">  Recently, articles appeared on Habr√© that affect the manipulation of bytecode.  What made me post the following article on its structure. <br><br>  The java platform has two features.  To ensure cross-platform, the program is first compiled into an intermediate low-level language - bytecode.  The second feature is loading executable classes using an extensible classloader.  This mechanism provides more flexibility and allows modifying executable code when loading, creating and loading new classes during program execution. <br><br>  This technique is widely used to implement AOP, creating test frameworks, ORM.  I especially want to mention <a href="http://www.terracotta.org/">terracotta</a> , a product with a beautiful idea of ‚Äã‚Äãclustering jvm and using a modification of byte-code to the full extent.  This note will be devoted to a review of the structure of the bytecode, the first part of this strong bundle. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Each class in java corresponds to one compiled file.  This is true even for subclasses or anonymous classes.  Such a file contains information about the name of the class, its parent, the list of interfaces that it implements, the enumeration of its fields and methods.  It is important to note that after compiling the information that contains the import directive, it is lost and all classes are now named through the full path.  For example, java / lang / String will be written in the String location. <br><br>  The most interesting thing will look like class methods in bytecode.  We will observe what the next class is transforming into: <br><br><pre> package org;

 class Test {
     private String name;

     public String getName () {
         return name;
     }

     public void setName (String name) {
         this.name = name;
     }
 }
</pre><br>  Let's start with the title.  It contains information about the name of the method, the fact that the method is called without parameters, and the type of the returned argument. <br><br>  Byte-code is a stack-oriented language, similar in structure to assembler.  To make operations with data, you first need to put it on the stack.  We want to take the field from the object.  To do this you need to put it on the stack.  In bytecode there are no variable names, they have numbers.  The zero number of the link to the current object or the variable this.  Then come the parameters of the executable method.  Then the rest of the variables. <br><br>  The ALOAD 0 command puts the this variable on the stack.  To put a different type of data on the stack, you need to use another command.  For long will be LLOAD, and for doubles [] will be DALOAD. <br><br>  The following command GETFIELD, removes from the stack a link to the object and puts a primitive type or a link to the field of this object.  She has two options.  The first name is a class, the second name is a variable.  If the variable is static, then you do not need to put anything on the stack beforehand, and the command should be replaced with GETSTATIC with the same parameters. <br><br>  The last command says that the method is complete and returns the values ‚Äã‚Äãof the link type from the stack. <br><br>  The setter has a slightly more complex structure. <br><pre> public setName (Ljava / lang / String;) V
 ALOAD 0
 ALOAD 1
 PUTFIELD org / Test name
 RETURN
</pre><br>  This method returns nothing.  The first two commands put on the stack the variable this and the parameter of the executable method.  Then the command PUTFIELD (PUTSTATIC for a static field) is called, which sets the value of the object field and removes the last two values ‚Äã‚Äãfrom the stack.  The last command is the exit from the method. <br><br>  Add a couple more methods to our object and see which bytecode corresponds to them. <br><br><pre>     public void forTest (Boolean b) {
         System.out.prinln (b);
     }

     public Long testMethods (Collection &lt;Long&gt; testInterface) {
         Long a = System.curretM ();
         forTest (testInterface.contains (a));    
         return a;
     }
</pre><br>  testMethod has the following view. <br><pre> INVOKESTATIC java / lang / System currentTimeMillis () J
 LSTORE 2
 ALOAD 0
 ALOAD 1
 LLOAD 2
 INVOKESTATIC java / lang / Long valueOf (J) Ljava / lang / Long;
 INVOKEINTERFACE java / util / Collection contains (Ljava / lang / Object;) Z
 INVOKESTATIC java / lang / Boolean valueOf (Z) Ljava / lang / Boolean;
 INVOKEVIRTUAL org / Test forTest (Ljava / lang / Boolean;) V
 LLOAD 2
 INVOKESTATIC java / lang / Long valueOf (J) Ljava / lang / Long;
 ARETURN
</pre><br>  The first command calls a static method on the System class.  The second stores the result of calling the currentTimeMillis method in a variable with the second number.  Then we put the this variable, the method parameter and the variable number 2 on the stack.  I convert a variable to java / lang / Long.  And we check that it is contained in the collection by calling the method on the executable parameter.  We have an interface parameter, so the INVOKEINTERFACE command is used.  For a class method, you must use INVOKEVIRTUAL.  To call a method on an object or interface, it is necessary that the object be on the stack, then the parameters of the method being called.  As a result of calling the method, they will be replaced with the result or they will simply be removed from the stack if the method returns anything.  The last three commands put a change on the stack, turn it into an object and return it as a method value. <br><br>  To complete our excursion into the bytecode, add the last method and look at the cycles and conditional statements. <br><pre>     public void testAriphmentics () {
        int i = -17;
         while (i &lt;10) {
             if (i &lt;0) {
                 i = i + 7;
             }
             i = i * 13;
         }
     }
</pre><br>  It will look like this in bytecode. <br><pre> ACC_FINAL -17
 ISTORE 1
 Label: L1466604866
 ILOAD 1
 ACC_FINAL 10
 IF_ICMPGE L329949514
 ILOAD 1
 IFGE L658705244
 ILOAD 1
 ACC_FINAL 7
 Iadd
 ISTORE 1
 Label: L658705244
 ILOAD 1
 ACC_FINAL 13
 Imul
 ISTORE 1
 GOTO L1466604866
 Label: L329949514
 RETURN
</pre><br>  The first two commands initialize the variable i (number 1) with a value of -17. <br><br>  Next we begin the body of the cycle.  For the implementation of which will require labels <br>  transition command and conditional statement.  In the body of our method, as many as three tags.  The first label indicates the start of the cycle.  The second is needed for the conditional operator, and the latter marks the end of the cycle.  The catchment operator has one parameter transition label.  Before it is called, the compared values ‚Äã‚Äãmust lie on the stack.  For comparison with zero, a separate command is used.  Each type has its own comparison operator.  For int it is IF_ICMPGE.  After comparing, the compared values ‚Äã‚Äãare removed from the stack.  For arithmetic operations with two variables, just as for the conditional operator, you must first put them on the stack.  After execution, they are removed from the stack, and the result is put in their place. <br><br>  This brief excursion into the byte-code is complete, some questions such as exceptions, synchronization were not affected.  I hope that having an idea about the byte code the reader can easily cope with them.  In the next part, we will look at the tools that are used to modify bytecode. <br><br>  <a href="http://math-and-prog.blogspot.com/2009/08/java.html">http://math-and-prog.blogspot.com/2009/08/java.html</a> </div><p>Source: <a href="https://habr.com/ru/post/69797/">https://habr.com/ru/post/69797/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../69785/index.html">Why Beeline Kamaz for 5 million?</a></li>
<li><a href="../69788/index.html">Pirate Bay with a taste of Wi-Fi</a></li>
<li><a href="../69789/index.html">Typedia font encyclopedia</a></li>
<li><a href="../69790/index.html">Watchman: on guard system</a></li>
<li><a href="../69792/index.html">Video lesson on soldering small things</a></li>
<li><a href="../69799/index.html">Opera Mini 5 beta released</a></li>
<li><a href="../69801/index.html">New version of Android Market is already available in Cyanogen Mod v4.1.10.1</a></li>
<li><a href="../69806/index.html">Microsoft refused to patch Windows XP</a></li>
<li><a href="../69808/index.html">Do you like autotravel?</a></li>
<li><a href="../69811/index.html">What will happen in Java 7 - the final list</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>