<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Industrial reverse engineering</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story of the borrowing process in the development of electronics on a good example. 



 Logging the elevator work with homemade sniffer 


 Once ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Industrial reverse engineering</h1><div class="post__text post__text-html js-mediator-article"><p>  The story of the borrowing process in the development of electronics on a good example. </p><br><p><img src="https://habrastorage.org/webt/r4/4r/gn/r44rgn9ckwjsxn3aqhznjl6yopg.png"><br>  <em>Logging the elevator work with homemade sniffer</em> </p><a name="habracut"></a><br><p>  Once I needed to copy a fairly simple device.  The manufacturing company has ceased to exist, but throughout the country there was still a demand for the replacement of broken or exhausted devices. </p><br><p>  The device itself is the elevator call button in the photo on the left.  For the experiments I was given two copies, one of which could be completely disassembled. </p><br><p>  The overall work plan looked like this: </p><br><ol><li>  Studying the wiring diagram of the board; </li><li>  The study of the elemental base of the board itself; </li><li>  Drawing its electrical circuit; </li><li>  Attempting to read the firmware file from the microcontroller; </li><li>  Disassemble the firmware; </li><li>  Extract algorithm work; </li><li>  Development of a new board; </li><li>  Writing a new firmware. </li></ol><br><p>  With the failure of paragraph 4, the further plan would have been more difficult, but I was lucky. </p><br><h3 id="izuchaem-podopytnogo">  We study the experimental </h3><br><p><img src="https://habrastorage.org/webt/_i/ys/gk/_iysgkygkocn9mdncbzolz0u9q4.jpeg"><br>  <em>Main microcontroller</em> </p><br><p><img src="https://habrastorage.org/webt/cn/eh/fj/cnehfjp5bvviohtimlndliklm9i.png"><br>  <em>A piece of elevator wiring diagram on which our boards are circled in red</em> </p><br><p>  The board is assembled on a microcontroller of 1997 release <a href="https://ww1.microchip.com/downloads/en/DeviceDoc/doc0368.pdf">AT89C2051</a> , which is based on the architecture of <a href="https://en.wikipedia.org/wiki/Intel_MCS-51">Intel MCS-51</a> .  In 2020, she celebrates her 40th anniversary in the embedded market. </p><br><blockquote>  A small explanation: the microcontroller is such a chip containing a computational core and a set of peripherals to control external devices.  For example, in a modern washing machine, the microcontroller polls control buttons, sensors, displays information on the screen, and controls the pumps, heater, valves, and drum drive.  For most of the listed functions, it does not require intermediate devices, only a set of passive electronic components. </blockquote><p><img src="https://habrastorage.org/webt/rk/o2/uf/rko2ufxrcsmtjghptrilwcpx3fq.jpeg"><br>  <em>We disassemble the board for drawing the electrical circuit</em> <em><br></em> <br>  Drawing the original circuit board in the future will help you find out the pin assignment of the microcontroller, which is necessary to parse the firmware code. </p><br><p>  The original device was developed by a Chinese company, and therefore its scheme is extremely complicated and with a lot of unnecessary components.  For example, the relay was turned on through a triple cascade of a bipolar transistor, an optocoupler and a field device (in that order). </p><br><p>  An acquaintance working with Chinese manufactures told me that the Chinese are engaged in a similar complication of schemes to increase the cost of development and production, if both are made by some people.  After this, I tend to believe him: </p><br><p><img src="https://habrastorage.org/webt/fs/ku/lh/fskulhqa3cjeb4v9ilr7bncg9y8.png"><br>  <em>The same place on the Chinese dual layer board on both sides.</em>  <em>Three huge resistors are not connected to anything.</em>  <em>I even shined the board with a powerful flashlight to be sure.</em> </p><br><p>  The scheme is copied, mysterious places are modeled in <a href="https://www.ni.com/ru-ru/shop/electronic-test-instrumentation/application-software-for-electronic-test-and-instrumentation-category/what-is-multisim.html">multisyme</a> , we take up the firmware. </p><br><h3 id="pytaemsya-schitat-proshivku">  We are trying to read the firmware </h3><br><p>  I was very lucky that the read protection was not enabled on both the controllers in the controllers, so I successfully merged two versions of the firmware with similar pornography: </p><br><p><img src="https://habrastorage.org/webt/re/9i/ep/re9iepb510h1ylxdfsc29sfre80.jpeg"><br>  <em>Photo from the <a href="http://ceptimus.co.uk/%3Fp%3D216">personal blog of the</a> American enthusiast</em> </p><br><h3 id="dizassemblirovanie-proshivki">  Disassembling the firmware </h3><br><p>  In the next step, we need to convert this machine code to something more readable: </p><br><p><img src="https://habrastorage.org/webt/kp/te/gn/kptegnvznij68y49jd7y15vpwsi.png"></p><br><p>  Take the well-known tool <a href="http://www.idasoft.ru/idapro/">IDA Pro</a> , which already has our controller with all the registers of the periphery, and open the HEX firmware file: </p><br><p><img src="https://habrastorage.org/webt/yx/g_/zj/yxg_zjqxt1nqg3f_jkvuwhhknqy.png"><br>  <em>Processing accepted by the card data in assembly language</em> </p><br><p>  After that, there is a rather tedious process of studying the <a href="http://www.keil.com/dd/docs/datashts/atmel/at_c51ism.pdf">instruction set of</a> our computational core, commenting and decoding assembly code. </p><br><p>  At the addresses of the interrupt vector table, interrupt handlers themselves were found, writing to the peripheral registers gave information about the configuration of the communication interface.  Step by step, the unnamed assembly code has become something that can be read. </p><br><h3 id="izvlechenie-algoritma-raboty">  Extract Algorithm </h3><br><p>  Since I needed to develop a new device on a different element base, it was necessary to extract an algorithm from the code.  Some time later, this pseudocode was born: </p><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UartISR</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ counter500ms = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//ClearFlag(isrFlags, ISR_FLAG_3); ProcessUart(recievedByte); } void ProcessUart(uint8_t recievedData) { static uint8_t uartPacketsToRxLeft, uartRecievedCmd, uartCurrPacketCRC; static uint8_t i, carryFlag; static uint16_t uartIsrPointer; static uint8_t uartBuffer1[8], uartBuffer2[6]; static uint8_t uartBuffer1Pos, uartBuffer2Pos; // 0 - // 1 - // 2 - // 3 - led state, 0x0F // 4 - // 5 - // 6 - // 7 - // 8 - buttons time static uint8_t dataRegisters[9]; // RAM:0050 uint8_t tmpVal, i; uint8_t dataToSend; if (GetFlag(UartISRFlags, UART_RECIEVED_FLAG)) { ClearFlag(UartISRFlags, UART_RECIEVED_FLAG); if (recieved9thBit) { switch (recievedData) { case 0xC1: uartPacketsToRxLeft = 8; uartRecievedCmd = 1; uartBuffer1Pos = 0; uartBuffer1[uartBuffer1Pos] = recievedData; //uartIsrPointer = 0x0037; //tmpVal_0037 = recievedData; uartCurrPacketCRC = recievedData; UartRxOn(); return; break; case 0xC2: uartPacketsToRxLeft = 3; uartRecievedCmd = 2;</span></span></code> </pre> <br><p>  The same processing of received data in the C language </p><br><p>  Who is interested in the transfer protocol: </p><br><blockquote>  The elevator control station communicated with the call button boards over a full-duplex 24-volt interface.  In normal mode, the button boards listened to the line, waiting for a 9-bit data packet.  If in this packet the address of our board arrived (set by a DIP switch on the board), the board switched to 8-bit receive mode, and all subsequent packets were hardware ignored by the other boards. <br><br>  The first after the address was a packet with the control command code.  Specifically, this board took only 3 teams: <br><ol><li>  Write to data registers.  For example, the frequency and duration of the flashing button when called; </li><li>  Turn on the button illumination; </li><li>  Request the status of the buttons (pressed or not). </li></ol><br><br>  The last byte was the checksum, which is a simple XOR of all bytes after the address. <br>  After the checksum, the fee again went into standby for its address. </blockquote><br><h3 id="razrabotka-novoy-platy">  Development of a new board </h3><br><p>  For the development phase of the new circuitry and the PCB, I have no pictures, but it was like this: <br><img src="https://habrastorage.org/webt/qo/o1/ib/qoo1ib5i-46roxxqoea1tw9sshq.jpeg"></p><br><p>  Wiring and wiring board made in <a href="https://www.altium.com/altium-designer/ru">Altium Designer</a> .  The manufacture of a printed circuit board was ordered in Zelenograd <a href="http://rezonit.ru/">Rezonite</a> . </p><br><h3 id="napisanie-novoy-proshivki">  Writing a new firmware </h3><br><p>  While our new board is in production, we are going to the facility where these call buttons are installed, and check the correctness of the disassembled transmission protocol using the sniffer assembled on the arduin: <br><img src="https://habrastorage.org/webt/aa/wl/0e/aawl0ep77fnv2gz_txeorxjzkls.png"><br>  A piece of transmitter circuit that is electrically equivalent to the original.  The receiver is just an optocoupler. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//UART1 initialize // desired baud rate:19200 // actual baud rate:19231 (0,2%) // char size: 9 bit // parity: Disabled void uart1_init(void) { UCSR1B = 0x00; //disable while setting baud rate UCSR1A = 0x00; UCSR1C = 0x06; UBRR1L = 0x33; //set baud rate lo UBRR1H = 0x00; //set baud rate hi UCSR1B = 0x94; } #pragma interrupt_handler uart1_rx_isr:iv_USART1_RXC void uart1_rx_isr(void) { unsigned char tmp; unsigned int rcv = 0; if (UCSR1B &amp; 0x02) { rcv = 0x100; } rcv |= UDR1; tmp = (rcv &gt;&gt; 4) &amp; 0x0F; if (rcv &amp; 0x100) { tmp |= 0xC0; } else { tmp |= 0x80; } txBuf12 = (rcv &amp; 0x0F); txBuf11 = tmp; txState1 = 0; TX_ON(); msCounter0 = 5000; }</span></span></code> </pre> <br><p>  Gosnokodim in ICC AVR our sniffer </p><br><p>  Then it was necessary to act very carefully so as not to burn anything in the elevator and prevent it from stopping. </p><br><p><img src="https://habrastorage.org/webt/ji/fm/g3/jifmg3osv9g5dxwr_4sq90ela6g.jpeg"><br>  We climb into the call button.  Thick yellow wires - board power and transmission interface.  White on the 4-pin connector - connect the button and its backlight. </p><br><p>  We check that everything works as it should, fix the jambs and write a new firmware for our device: </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//ICC-AVR application builder : 11.02.2015 12:25:51 // Target : M328p // Crystal: 16.000Mhz #include &lt;macros.h&gt; #include &lt;iccioavr.h&gt; #include &lt;avrdef.h&gt; #include "types.h" #include "gpio.h" #define TX_OFF() UCSR0B &amp;= 0b11011111; #define TX_ON() UCSR0B |= 0b00100000; #define TX_STATE() (UCSR0B &amp; 0b00100000) #define MAX_TIMEOUT 3000 //#define SNIFFER_MODE 1 //#define MASTER_MODE 1 // #pragma avr_fuse (fuses0, fuses1, fuses2, fuses3, fuses4, fuses5) #pragma avr_fuse (0xFF, 0xD1, 0xFC) #pragma avr_lockbits (0xFC) // AVR signature is always three bytes. Signature0 is always the Atmel // manufacturer code of 0x1E. The other two bytes are device dependent. #pragma avr_signature (0x1E, 0x95, 0x0F) // atmega32 static GPIOx errorLed, rcvLed, butUp, butDn, ledUp, ledDn, butLedUp, butLedDn, ledButUp, ledButDn; static uint8_t msFlag = 0; static uint8_t ledState = 0, buttonsState = 0; static uint16_t rcvLedLitTime = 0, butMaskCalcTime = 0, timeoutTimer = 0; typedef struct { uint16_t buffer[10]; uint8_t dataLength; } UartPacket; static UartPacket txPacket, rxPacket; #ifdef SNIFFER_MODE static uint8_t txBuffer[64], txBufferLength = 0, bufferMutex = 0; #endif static uint8_t GetPacketCRC(UartPacket* packet); static void SendLedState(void); uint8_t GetAddress(void) { return (PINC &amp; 0x3F); }</span></span></code> </pre> <br><p>  C code for the new board based on the AVR <a href="http://ww1.microchip.com/downloads/en/DeviceDoc/Atmel-7810-Automotive-Microcontrollers-ATmega328P_Datasheet.pdf">ATmega328P</a> microcontroller </p><br><p>  The simplicity of the device and firmware can be estimated by the amount of code, it contains only about 600 lines in the C language. </p><br><p>  The build process looked like this: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/UIF7QEQrbh8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  The fee is different, but the principle is the same. </p><br><p>  I can not attach the photo of the finished device, just believe that it is still being made and sold. </p><br><h3 id="liricheskoe-zaklyuchenie">  Lyric conclusion </h3><br><p>  About the elevator buttons "up" and "down" on the floor.  I noticed that many people completely misunderstand their purpose and press both at once. </p><br><p><img src="https://habrastorage.org/webt/r2/6r/e7/r26re7kjkj8dhppaxmbkdcedvt8.png"><br>  <a href="https://www.videoblocks.com/video/man-pressing-elevator-button-to-go-up-and-to-go-down-eqfinkfkxik5c29t3">From here</a> </p><br><p>  The elevator has two sets of buttons: in the cab there is an order bar, and on the floor, a call bar.  Already by name, you can guess that the orders panel has a higher management priority. </p><br><p>  All elevators that have call panels with up and down buttons work with some of the variants of the travel optimization algorithm, the purpose of which is to transport the maximum number of passengers in minimum time and a separate condition for maximum waiting time on the floor (regulated by the state standard). </p><br><p>  Such an algorithm usually involves the selection of passengers on the floors, if they are traveling in the same direction, which is indicated by pressing the call button "up" or "down." </p><br><p>  Imagine a situation that an elevator with passengers goes down and on the way receives a call ‚Äúdown‚Äù from the floor below.  The elevator will stop for the selection of a passenger (yes, there is still accounting for the loading of the cabin on the weighing sensor, but we will lower it). </p><br><p>  The elevator goes further and receives a ‚Äúupward‚Äù call from the floor below.  It is logical that the elevator will not stop for the selection of a passenger, as it will not change the direction of travel (this is also regulated by the standard), and picking up a passenger to go down and then up is useless energy consumption and space in the elevator. </p><br><p>  The elevator goes further and receives two calls up and down at once from the floor below, which were pressed by some impatient passenger who needs to go up.  It is logical that the elevator will stop on this floor, but the passenger will not enter it, but will spend time in the cabin for people to slow down and stop the elevator, open the doors, wait, close the doors and accelerate to the rated speed. </p><br><p>  If the elevator has only one button on the floor, then in 99% of cases it works according to the ‚Äúcollective down‚Äù algorithm, and if there are orders in the cabin it stops only when it moves down. </p><br><p>  If you have programming skills in JS, you can try to implement a similar control algorithm in the online game <a href="https://play.elevatorsaga.com/">Elevator Saga</a> .  It has all aspects of optimizing travel without deepening in hardcore like the work of elevator safety chains. </p><br><p><img src="https://habrastorage.org/webt/pi/kj/ig/pikjigdf2mqsd2ptmjbtot-yd34.png"></p><br><p>  In my <a href="https://t.me/govnokoder">telegram channel,</a> I post similar materials.  Right now there you can follow the development of the next device. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/459492/">https://habr.com/ru/post/459492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459482/index.html">How we beat the category tree</a></li>
<li><a href="../459484/index.html">Generation Arduino. What modern schoolchildren invent</a></li>
<li><a href="../459488/index.html">Special game modes in the context of Roguelike</a></li>
<li><a href="../45949/index.html">Developer weekdays</a></li>
<li><a href="../459490/index.html">CRM vendors' dirty tricks: would you buy a car without wheels?</a></li>
<li><a href="../459494/index.html">How to start a growing b2c startup after hackathon</a></li>
<li><a href="../459498/index.html">Slurm - an easy way to break into the Kubernetes topic</a></li>
<li><a href="../4595/index.html">Web 3.0 will stir up human civilization</a></li>
<li><a href="../459500/index.html">HTML is the web</a></li>
<li><a href="../459502/index.html">We continue to develop an adventure platform for Russians: interface features and summer preferences</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>