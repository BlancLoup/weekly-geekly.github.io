<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Three holes in Scratch Mania</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Recently, my friends and I published the game Scratch Mania for the Windows Phone platform, on the approach of Android. Here I will tell you...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Three holes in Scratch Mania</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Recently, my friends and I published the game Scratch Mania for the <a href="http://windowsphone.com/s%3Fappid%3D02e2cacf-8ef9-4b67-9893-aa70ae97045e">Windows Phone</a> platform, on the approach of Android.  Here I will tell you about where you‚Äôve been missing since the last posts about Kinect and how an enterprise developer is writing games. <br><br> <a href="http://habrahabr.ru/post/268379/"><img src="https://habrastorage.org/files/841/a5e/620/841a5e6204f14eb2a49b88ee23c6519a.png"><br></a> <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">About the game</b> <div class="spoiler_text">  In the game Scratch Mania, the player is asked to guess a picture hidden by a protective layer.  The protective layer is erased by simple touches of the screen.  Moreover, the player can erase only part of the protective layer, this gives interest and, at the same time, additional complexity.  Pictures are grouped into albums by subject: sports, cars, actors, cities, etc.  For each guessed picture, the player receives in-game coins, which he can exchange for new albums. <br></div></div><br>  We conceived this game as a hackathon theme for the weekend: get together from someone, write a basis - a working prototype, and then bring it to a state suitable for publication in a month.  And actually spent a great year.  More than a year, Karl!  In fairness, I note that the work was done as a rule in the evenings, in free time.  Now is the time to look at the key technical solutions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  <font color="#062478">Measure seven times</font> </h1><br>  If you make a rating of the most popular questions from people I tell about the game, this question comes first: ‚ÄúGee, Windows Phone?  Seriously? .. ‚ÄùEven the Sarcasm sign is not needed.  Nevertheless, we chose this platform because we know C #.  And Java is also a C-derived language, so we decided to skip the version for Android, only it is in a semi-ready state for now.  As a result, the choice was reduced to the decision whether to use ‚Äústylish, trendy, youth‚Äù Xamarin or to write native applications.  Alas, but Xamarin lost.  Mainly due to mixed reviews from colleagues and the online community.  I really did not want to spend a lot of time fighting the framework.  And besides, the price turned out to be biting - about $ 20 per month for individual developers. <br><br>  Java and .NET were not the only contenders, they also considered exotic options, such as javascript.  But he is too slow.  By the way, we later used prototypes for the <a href="http://smania.lardite.com/Index.html%3Fl%3Dru">site of the game</a> , but do not lose the good. <br><br>  As for the versions of Windows Phone and Android, for simplicity, they decided to stop at WP 8+ and Android API 11+, respectively.  And here I will mainly talk about Windows Phone, because  it's too early to talk about Android. <br><br><h1>  <font color="#062478">Down and Out trouble started</font> </h1><br>  We spent about two weeks on prototypes, instead of two days off, as originally planned.  Started with javascript.  The idea is simple: add canvas to the page, draw a picture in it.  Create another canvas, without adding to the DOM.  In it we draw another map, while the dimensions of the canvas are the same.  In the OnMouseMove event handler, copy the N √ó N area of ‚Äã‚Äãpixels from one canvas to another.  It turns out, something like: <br><img src="https://habrastorage.org/files/26b/a5e/4c5/26ba5e4c58814e7a9c34ff2f6e12cc95.png"><br><br>  But this will not surprise anyone, so we wrote the following prototype on Windows Forms, and the erasure algorithm itself was made by analogy with the airbrush tool from graphic editors.  In this prototype, two images superimposed on each other and at the top, in the touch zone, the value of the alpha channel changed.  I'm sure javascript guru could write something similar, but this was not found among us. <br><br>  The code from the prototype was practically unchanged on smartphones.  It turned out that the components of Windows Phone and Android work differently with the alpha channel.  In Windows Phone, the channel is premultiplied, whereas in Android it is not.  This means that on Android, the alpha channel value does not affect the color components (RGB) of a pixel, whereas on Windows Phone they are modified according to the formulas: <br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">A</span></span> = alpha R = red √ó alpha / <span class="hljs-number"><span class="hljs-number">255</span></span> G = green √ó alpha / <span class="hljs-number"><span class="hljs-number">255</span></span> B = blue √ó alpha / <span class="hljs-number"><span class="hljs-number">255</span></span></code> </pre> <br>  Images presented in this format are easier to overlap, since in this case the operation of calculating the pixel value actually reduces to the addition of the pixel components, for example, Rres ~ R1 + R2.  Details can be found in the book Programming Windows (6th edition) by Charles Petzold ( <a href="http://www.amazon.com/Programming-Windows-Writing-Developer-Reference/dp/0735671761">amazon</a> ). <br><img src="https://habrastorage.org/files/1ce/6ff/24b/1ce6ff24b3c74ce9ab872b8eb6cf3fd7.jpg"><br><br>  But trouble does not come alone.  The Touch.FrameReported event (onTouchEvent in Android) is very slow on both platforms.  Let's say if we subscribe to this event in order to calculate a new value for the alpha channel at the touch point in its handler, then we get an FPS of about 20. This is very small, because  delays become visible to the naked eye.  The Android has so far postponed and decided to fix it closer to the release.  In Windows Phone, the problem was solved using a background stream, which queries the screen about once every 25ms, gets points (there are usually several) touches (if any) and calculates the value of the alpha channel.  This allows you to keep the FPS level 30-40. <br><br>  In addition, you need to remember that in Windows Phone there is no invalidation of the part of the image - after any changes, you need to update the whole picture.  This also imposes additional restrictions on touch handling: the more points that are processed at a time, the better.  On the other hand, one cannot process too many points, since  jerks will be noticeable. <br><br><h1>  <font color="#062478">There is no limit to perfection</font> </h1><br>  Beautiful erasure is the first killer feature, the second is picture albums.  Understanding that such an important code requires an appropriate attitude to itself, they took the design seriously.  They stratified the system - from the low-level parser of individual albums to the high-level manager of installed albums and albums available for download. <br><div class="spoiler">  <b class="spoiler_title">About albums</b> <div class="spoiler_text">  The game was originally pre-installed 3 albums with pictures, the other albums are stored on our server.  This allows the player to decide which albums are interesting for him and download them, and allows us to simplify the process of distributing new albums - the player will see them marked ‚Äúnew‚Äù in the album list. <br></div></div><br>  Here we made a blunder that can be described as the ‚ÄúEnterprise of the brain‚Äù.  Just look at the class diagram. <br><img src="https://habrastorage.org/files/0c2/923/006/0c2923006ec54372b8bb2ff662be9250.png"><br>  At first glance, not everything is so scary, but much is simplified in the diagram: some types are not indicated, code contracts for all interfaces, helper classes, etc.  This family was refactored several times, corresponded and in the end almost all interfaces and factories were removed. <br><br><h1>  <font color="#062478">Learn from mistakes</font> </h1><br>  An attempt to create an ideal architecture can be called: a textbook, classical, but not instructive for us, because  if the correct conclusions were made on time, the game would have been ready six months ago. <br><br>  This is almost all that we managed to do in 4 months.  The skeleton was ready: it was possible to switch between pre-installed albums, guess pictures in two modes (by letter and select from the options), view already guessed pictures.  But there was still more to do: draw a UI, implement scoring, download albums, integrate with social networks - ‚Äútell friends‚Äù, add google analytics and in-game purchases. <br><br><h1>  <font color="#062478">All in "openwork"</font> </h1><br>  We deployed the server part of the game in Microsoft Azure.  Original pictures and finished albums are stored in Blob Storage.  For storing album metadata such as ID, physical location (in Blob), in-game availability, etc.  Azure SQL is used.  Working with these components is hidden by the RESTful service.  Now this is the main stream, so we decided to keep up. <br><br>  In fact, our service is a set of 3 methods: get a list of albums, get detailed information about the album, download the album. <br><br><img src="https://habrastorage.org/files/c44/98d/ec4/c4498dec40794ba1accb70fa1c18a293.png"><br><br>  To download an album, the service generates a link with a limited lifetime.  Azure provides a ready-made mechanism - Shared Access Signatures.  The essence of the procedure is as follows: the validity period is stitched in the URL, then the URL is signed with a private key.  This eliminates any URL changes.  The date can be not specified - it is enough to create an access policy for the container, and refer to this policy in the URL.  However, this option is less convenient in the case of short-lived links (for each new period, you must create a new policy). <br><br><h1>  <font color="#062478">Meet on clothes</font> </h1><br>  The harsh truth of life - the player doesn‚Äôt care what is inside the game and how many man-hours it takes to spend his few minutes with pleasure.  Therefore, it is important to build a user-friendly interface.  We decided to try painting everything on our own.  Although, perhaps, it would be worthwhile to look for a professional artist and the costs of his work would have paid off with the free time. <br><br>  It took us about a month to draw sketches.  Expression Design was chosen as an editor, simply because: a) we had it, b) it is convenient to use it, and c) its files are easily exported to XAML or PNG.  Therefore, later almost all the styles and icons turned out to be transferred without changes to the game. <br><div class="spoiler">  <b class="spoiler_title">Design to PNG</b> <div class="spoiler_text">  When you have to export a large number of Expression Design files to PNG or JPEG, the process can be tedious without automation.  I wrote a small converter using the Expression Design API (this is not a documented API, obtained by examining the assemblies with one popular "reflector"). <br><br>  We will need two assemblies: <br>  % ProgramFiles% \ Microsoft Expression \ Design 4 \ GraphicsCore.dll <br>  % ProgramFiles% \ Microsoft Expression \ Design 4 \ Microsoft.Expression.Design.dll <br>  And this code: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-string"><span class="hljs-string">@"..."</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   *.design  const string to = @"..."; //    *.png  Module.Instance.Initialize(); var doc = Module.Instance.OpenDocument(from, false, null); ExportImageInfoHandler exportHandler = doc.ExportImage(to, (Enum)ImageFormat.Png); exportHandler.Info.Resolution = 96.0; exportHandler.Info.DocumentUnits = UnitType.Pixel; exportHandler.Info.ConstrainProperties = false; exportHandler.Execute();</span></span></code> </pre><br></div></div><br>  Another, no less important element of the game, affecting the overall perception - these are pictures that the player will guess.  We tried to select interesting and high-quality, as well as with a free license.  Each album has about 20-30 pictures.  To simplify your life, we decided that the pictures should be the same size.  A side effect of such an assumption was the extra effort when creating an album; each picture needs to be adjusted in size.  And what if the resolution we decided to use today will change tomorrow? <br><br>  It turns out you need to re-edit all the pictures.  So we came up with the idea of ‚Äã‚Äãcreating an album designer.  The result was a complete management system.  The designer allows you not only to create and edit albums for different languages ‚Äã‚Äã(they are now available in 2 languages: English and Russian), but also to publish them, i.e.  make available in the game. <br><img src="https://habrastorage.org/files/aea/452/bf7/aea452bf7fd8492e8545fefba9a862fe.png"><br><br><h1>  <font color="#062478">What goes around comes around</font> </h1><br>  We spent about 3,500 rubles on advertising the game.  This includes advertising on VKontakte, Bing and Windows Store.  As practice has shown, advertising in Reddit is the same as buying snow in the winter: $ 20 - 0 installations. <br><br>  But the publication of news in groups dedicated to mobile games in social networks.  The easiest way is to find groups dedicated to games, windows phone, etc.  and contact the administrator with a request to publish an advertisement.  Now we continue to work in this direction, mainly looking for contacts of people who are ready to publish a review of the game.  So far, only guys from 1800 Pocket / PC went to the meeting and published a review. <br><br>  The version for Android due to the release is not yet being actively developed.  This is a goal for the near future.  Will there be an iOS version?  It is not yet clear and largely depends on the success of the game for Windows Phone and Android. <br><br>  PS So what is the enterprise developer writing games?  Instructive.  It does not matter whether you design complex high-load systems, automate business processes, or write your online store - keep it simple.  Everything.  Trite ... :) </div><p>Source: <a href="https://habr.com/ru/post/268379/">https://habr.com/ru/post/268379/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268365/index.html">Building Unity3D builds on Jenkins on Mac OS X. Part 2</a></li>
<li><a href="../268369/index.html">The secret arrow in the address bar and other surprises in the assembly Vivaldi 1.0.291.18</a></li>
<li><a href="../268371/index.html">DTO vs POCO vs Value Object</a></li>
<li><a href="../268375/index.html">Solving the problem of setting the screen resolution in Thinstation</a></li>
<li><a href="../268377/index.html">How to create a game on Unity3D without a mat</a></li>
<li><a href="../268381/index.html">Productive unit testing of web applications using the example of yii2 and codeception</a></li>
<li><a href="../268383/index.html">Transfer. I left my system fonts in San Francisco</a></li>
<li><a href="../268387/index.html">New scam: pay Bitcoins to save a hacked phone</a></li>
<li><a href="../268389/index.html">Codebattle: a game for programmers</a></li>
<li><a href="../268395/index.html">Tehnokniga, Part 4: literature on product management, web services development, web project management, business and systems analysis of architects</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>