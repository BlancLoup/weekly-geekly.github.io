<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Embed Lua interpreter in the project for the microcontroller (stm32)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In fairly large applications, a considerable part of the project is business logic. It is convenient to debug this part of the program on a computer, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Embed Lua interpreter in the project for the microcontroller (stm32)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/p6/9j/kz/p69jkzome873c4rbil8fftedrxs.png"><br><br>  In fairly large applications, a considerable part of the project is business logic.  It is convenient to debug this part of the program on a computer, and then build it into the microcontroller project, expecting that this part will be executed exactly as it was intended without any debugging (the ideal case). <br><br>  Since most programs for microcontrollers are written in C / C ++, abstract classes that provide interfaces to low-level entities are usually used for these purposes (if a project is written only with C, then function pointer structures are often used).  This approach provides the required level of abstraction over iron, however, it is fraught with the need for constant re-compilation of the project with subsequent programming of the non-volatile memory of the microcontroller with a binary <a href="https://habr.com/ru/post/437848/">firmware</a> file of <a href="https://habr.com/ru/post/437848/">large volume</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      However, there is another way - the use of a scripting language that allows you to debug business logic in real time on the device itself or download work scripts directly from external memory, without including this code in the microcontroller firmware. <br><br>  I chose Lua as the scripting language. <a name="habracut"></a><br><br><h2>  Why Lua? </h2><br>  There are several scripting languages ‚Äã‚Äãthat can be embedded in a project for a microcontroller.  Several simple BASIC-like, PyMite, Pawn ... Each has its pros and cons, the discussion of which does not include the list of issues discussed in this article. <br><br>  Briefly about what exactly lua is good for - you can read in the article <a href="https://zserge.wordpress.com/2012/02/23/lua-%25D0%25B7%25D0%25B0-60-%25D0%25BC%25D0%25B8%25D0%25BD%25D1%2583%25D1%2582/">‚ÄúLua in 60 minutes‚Äù</a> .  I was strongly inspired by this article and I, for a more detailed study of the question, read the official manual-book from the author of the language to Robert Ieruzalimsky " <a href="https://www.ozon.ru/context/detail/id/135559046/">Programming in the Lua language</a> " (available in the official Russian translation). <br><br>  Separately, I want to mention the project eLua.  In my case, I already have a ready-made low-level software layer for interacting with the microcontroller periphery and for other required peripherals located on the device board.  Therefore, this project was not considered by me (since it is recognized to provide those layers for the connection of the Lua core with the microcontroller periphery). <br><br><h2>  About the project in which Lua will be embedded </h2><br>  <a href="https://habr.com/ru/post/437848/">Traditionally</a> , my <a href="https://github.com/Vadimatorik/ChiptunePlayer-2.22-Firmware/tree/05389bd925aa72c7c36fab1228482dcbe4bd5f97">sandbox project</a> will be used as a field for experimentation (a link to a commit with an already integrated lua with all the necessary modifications described below). <br><br>  The project is based on the stm32f405rgt6 microcontroller with 1 MB of non-volatile and 192 KB of RAM (the older 2 blocks with a total capacity of 128 KB are currently used). <br><br>  The project has a real-time operating system FreeRTOS to support the infrastructure for working with hardware peripherals.  All memory for tasks, semaphores and other FreeRTOS objects is statically allocated at the layout stage (located in the .bss memory area).  All FreeRTOS entities (semaphores, queues, task stacks, and others) are parts of global objects in private areas of their classes.  However, the FreeRTOS heap is still allocated to support the <i>malloc</i> , <i>free</i> , <i>calloc</i> functions (required for functions such as <a href="https://habr.com/ru/post/459420/">printf</a> ) that are redefined to work with it.  There is a raised API for working with MicroSD (FatFS) cards, as well as a debugging UART (115200, 8N1). <br><br><h2>  About the logic of using Lua in the project </h2><br>  For the purpose of debugging business logic, it is assumed that the commands will be sent over the UART, packed (in a separate object) into complete lines (terminated with a "\ n" + 0 terminator) and sent to the lua-machine.  In case of unsuccessful execution, output by means of printf (since it was <a href="https://habr.com/ru/post/459420/">previously involved</a> in the project).  When the logic is debugged, it will be possible to implement the download of the final business logic file from the file from the microSD card (not included in the material of this article).  Also for the purpose of debugging Lua, the machine will be executed inside a separate FreeRTOS thread (in the future, a separate thread will be allocated to each debugged business logic script in which it will run with its environment). <br><br><h2>  Inclusion of the submodule lua in the project </h2><br>  The <a href="https://github.com/lua/lua">official mirror of the project on github</a> will be used as the source of the lua library (since my project is also located there. You can use the source directly from the <a href="https://www.lua.org/">official site</a> ).  Since the project has an established submodule assembly system as part of the project for individual CMakeLists <a href="https://github.com/Vadimatorik/module_lua/tree/529eb759aeb7f64504b9396fbb9fb0f505a92742">sub modules</a> for each module, I created a <a href="https://github.com/Vadimatorik/module_lua/tree/529eb759aeb7f64504b9396fbb9fb0f505a92742">separate submodule</a> in which I included the fork of this and CMakeLists to preserve the unified stylistics of the assembly. <br><br>  <a href="https://github.com/Vadimatorik/module_lua/blob/529eb759aeb7f64504b9396fbb9fb0f505a92742/CMakeLists.txt">CMakeLists</a> builds the source code of the lua repository as a static library with the following compilation flags of the submodule (taken from <a href="https://github.com/Vadimatorik/ChiptunePlayer-2.22-Firmware/blob/05389bd925aa72c7c36fab1228482dcbe4bd5f97/cmake/opt_flags.cmake">the submodule configuration file</a> in the main project): <br><br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(C_COMPILER_FLAGS <span class="hljs-string"><span class="hljs-string">"-std=gnu99;-fshort-enums;-fno-exceptions;-Wno-type-limits;-ffunction-sections;-fdata-sections;"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(MODULE_LUA_COMP_FLAGS <span class="hljs-string"><span class="hljs-string">"-O0;-g3;${C_COMPILER_FLAGS}"</span></span></code> </pre> <br>  And the specificization flags of the processor used (specified in the <a href="https://github.com/Vadimatorik/ChiptunePlayer-2.22-Firmware/blob/05389bd925aa72c7c36fab1228482dcbe4bd5f97/CMakeLists.txt">root CMakeLists</a> ): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(HARDWARE_FLAGS -mthumb; -mcpu=cortex-m4; -mfloat-abi=hard; -mfpu=fpv4-sp-d16;)</code> </pre> <br>  It is important to note the need for the root CMakeLists to specify a definition that allows not to use double values ‚Äã‚Äã(since the microcontroller does not have hardware support for double. Only float): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span>(-DLUA_32BITS)</code> </pre> <br>  Well, it remains only to inform the linker about the need to build this library and include the result in the layout of the final project: <br><br><div class="spoiler">  <b class="spoiler_title">CMakeLists site for building a project with the lua library</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span>/bsp/submodules/module_lua) ... <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf PUBLIC <span class="hljs-comment"><span class="hljs-comment"># -Wl,--start-group       #      . #  Lua    ,      #  . "-Wl,--start-group" ..._... MODULE_LUA ..._... "-Wl,--end-group")</span></span></code> </pre> </div></div><br><h2>  Definition of functions for working with memory </h2><br>  Since Lua itself does not work with memory, this responsibility passes to the user.  However, when using the bundled <i>lauxlib</i> library and the <i>luaL_newstate</i> function from it, the <i>l_alloc</i> function is <i>bound</i> as a memory system.  It is defined as follows: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l_alloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ud, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nsize)</span></span></span><span class="hljs-function"> </span></span>{ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ud; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)osize; <span class="hljs-comment"><span class="hljs-comment">/* not used */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nsize == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(ptr, nsize); }</code> </pre> <br>  As it was said at the beginning of the article, the project already has overridden functions <i>malloc</i> and <i>free</i> , but there is no <i>realloc</i> function.  We need to fix this. <br><br>  In the standard FreeRTOS heap handling mechanism, in the heap_4.c file used in the project, there is no function for resizing a previously allocated block of memory.  In this regard, it is necessary on the basis of <i>malloc</i> and <i>free</i> to make its implementation. <br><br>  Since it is possible to change the memory allocation scheme in the future (using another heap_x.c file), it was decided not to use the internals of the current scheme (heap_4.c), but to make a higher level superstructure.  Though less effective. <br><br>  It is important to note that the <i>realloc</i> method not only removes the old block (if it existed) and creates a new one, but also moves data from the old block to the new one.  Moreover, if there was more data in the old block than in the new one, then the new one is filled with the old one to the limit, and the remaining data is discarded. <br><br>  If you do not take into account this fact, then your machine will be able to execute such a script three times from the line " <i>a = 3 \ n</i> ", after which it will fall into the hard fault.  The problem will be solved after studying the residual image of the registers in the hard fault handler, from which it will be possible to know that the crash occurred after trying to expand the table in the depths of the interpreter code and its libraries.  If you call the script by the type " <i>print 'test'</i> ", then the behavior will change depending on how the firmware file is assembled (in other words, the behavior is not defined). <br><br>  In order to copy the data from the old block to the new one, we need to know the size of the old block.  FreeRTOS heap_4.c (like other files that provide methods for working with the heap) does not provide an API for this.  So you have to add your own.  As a basis, I took the function <i>vPortFree</i> and cut its functionality to the following: <br><br><div class="spoiler">  <b class="spoiler_title">VPortGetSizeBlock function code</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vPortGetSizeBlock</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *puc = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)pv; BlockLink_t *pxLink; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pv != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { puc -= xHeapStructSize; pxLink = (BlockLink_t *)puc; configASSERT((pxLink-&gt;xBlockSize &amp; xBlockAllocatedBit) != <span class="hljs-number"><span class="hljs-number">0</span></span>); configASSERT(pxLink-&gt;pxNextFreeBlock == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pxLink-&gt;xBlockSize &amp; ~xBlockAllocatedBit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> </div></div><br>  Now it's small, write <i>realloc</i> based on <i>malloc</i> , <i>free</i> , and <i>vPortGetSizeBlock</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Realloc implementation code based on malloc, free, and vPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> new_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> old_size = vPortGetSizeBlock(ptr); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cpy_len = (new_size &lt; old_size)?new_size:old_size; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, ptr, cpy_len); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; }</code> </pre> </div></div><br><h2>  Add support for working with stdout </h2><br>  As it becomes known from the official description, the lua interpreter itself does not know how to work with input-output.  For these purposes, one of the standard libraries is connected.  For output, it uses the <i>stdout</i> stream.  The <i>luaopen_io</i> function from the standard library is responsible for connecting to the stream.  To support <i>stdout</i> (as opposed to <a href="https://habr.com/ru/post/459420/">printf</a> ), you will need to override the <i>fwrite</i> function.  I redefined it based on the functions described in the <a href="https://habr.com/ru/post/459420/">previous article</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Fwrite function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fwrite(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count, FILE *stream) { stream = stream; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = size * count; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(buf); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_write_char((s[i])) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len; }</code> </pre> </div></div><br>  Without its definition, the <i>print</i> function in lua will work successfully, but there will be no output.  At the same time, there will be no errors on the Lua machine stack (since formally the function was executed successfully). <br><br>  In addition to this function, we need the <i>fflush</i> function (for the functioning of the interactive mode, which will be <i>discussed</i> later).  Since this function cannot be redefined, you will have to call it a little differently.  The function is a truncated version of the <i>fwrite</i> function and is intended to send what is now in the buffer with its subsequent cleaning (without additional carriage return). <br><br><div class="spoiler">  <b class="spoiler_title">Mc_fflush function</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mc_fflush</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len = buf_p; buf_p = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uart_1.tx(tx_buf, len, <span class="hljs-number"><span class="hljs-number">100</span></span>) != mc_interfaces::res::ok) { errno = EIO; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br><h2>  Getting strings from a serial port </h2><br>  To get the strings for the lua-machine, I decided to write a simple uart-terminal class that: <br><br><ul><li>  receives data on the serial port byte-by-byte (in interrupt); </li><li>  adds the received byte to the queue from where the stream receives it; </li><li>  in the byte stream, if it is not a newline, it is sent back in the form in which it came; </li><li>  if the line feed arrived (' <i>\ r</i> '), then 2 bytes of the terminal carriage return are sent (" <i>\ n \ r</i> "); </li><li>  after sending the response, the byte handler is called (string composition object); </li><li>  controls the keystroke for deleting a character (to avoid deleting service characters from the terminal window); </li></ul><br>  Links to sources: <br><br><ul><li>  UART class interface is <a href="">here</a> ; </li><li>  UART base class is <a href="">here</a> and <a href="">here</a> ; </li><li>  the uart_terminal class is <a href="">here</a> and <a href="">here</a> ; </li><li>  creating a class object as part of the project <a href="">here</a> . </li></ul><br>  Additionally, I note that in order for this object to work properly, you need to assign a UART interrupt priority in the allowed range to work with FreeRTOS functions from an interrupt.  Otherwise, you can get interesting difficult debugged errors.  In the current example, the following parameters for interrupts are set in the <a href="">FreeRTOSConfig.h</a> file. <br><br><div class="spoiler">  <b class="spoiler_title">Settings in FreeRTOSConfig.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configPRIO_BITS 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configKERNEL_INTERRUPT_PRIORITY 0XF0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   FreeRTOS API   //   0x8 - 0xF. #define configMAX_SYSCALL_INTERRUPT_PRIORITY 0x80</span></span></span></span></code> </pre> </div></div><br>  In the project itself, an object of the <i>nvic</i> class sets the interrupt priority to 0x9, which is within the allowable range (the nvic class is described <a href="">here</a> and <a href="">here</a> ). <br><br><h2>  Forming a string for a Lua machine </h2><br>  The bytes received from the uart_terminal object are transferred to an instance of the simple serial_cli class, which provides a minimal interface for editing a string and passing it directly to the stream in which the lua-machine is running (via a callback function).  Upon accepting the '\ r' character, the callback function is called.  This function should copy the string and ‚Äúrelease‚Äù the control (since during a call, the reception of new bytes is blocked. This is not a problem if the priorities of the threads are set correctly and the UART speed is low enough). <br><br>  Links to sources: <br><br><ul><li>  description files serial_cli <a href="">here</a> and <a href="">here</a> ; </li><li>  creating a class object as part of the project <a href="">here</a> . </li></ul><br>  It is important to note that this class considers a string longer than 255 characters to be invalid and resets it.  This is intentional, since the lua interpreter allows you to enter constructions line by line, waiting for the block to end. <br><br><h2>  Passing a string to the Lua interpreter and its execution </h2><br>  By itself, the Lua interpreter does not know how to accept the block code line by line, and then execute the whole block itself.  However, if we install Lua on a computer and run the interpreter interactively, we can see that the execution proceeds line by line with the appropriate notation as it is entered, that the block is not yet complete.  Since the interactive mode is what is provided in the standard package, we can see its code.  It is in the <a href="">lua.c</a> file.  We are interested in the <i>doREPL</i> function and everything that it uses.  In order not to invent a bicycle, I made a port of this code into a separate class for receiving interactive mode functions, which I named after the original function <i>lua_repl</i> , which uses printf to output information to the console and has a public method <i>add_lua_string</i> to add a string obtained from the class object The serial_cli described above. <br><br>  References: <br><br><ul><li>  description of the lua_repl class <a href="">here</a> ; </li><li>  code <a href="">here</a> , <a href="">here</a> and <a href="">here</a> ; </li></ul><br>  The class is made according to the Myers pattern of singleers, since there is no need to provide several interactive modes within the same device.  An object of class lua_repl receives data from an object of class serial_cli <a href="">here</a> . <br><br>  Since the project already has a unified system for initializing and servicing global objects, a pointer to an object of class lua_repl is passed to the object of the global class <a href="">player :: base</a> <a href="">here</a> .  In the <i>start</i> method of the <a href="">player :: base</a> class object (declared <a href="">here</a> . It is immediately called from the main), the <i>init</i> method of the lua_repl class object is called with the FreeRTOS 3 task priority (in the project, you can assign a task priority from 1 to 4. Where 1 - the lowest priority, and 4 - the highest).  Upon completion of the successful initialization, the global class launches the FreeRTOS scheduler and the interactive mode begins its work. <br><br><h2>  Problems that appear when porting </h2><br>  Below is a list of problems that I encountered during the port of the Lua machine. <br><br><h4>  2-3 single-line variable assignment scripts are executed, then everything falls into the hard fault </h4><br>  The problem was in the realloc method.  It is required not only to re-allocate the block, but also to copy the contents of the old one (about which I wrote above). <br><br><h4>  At attempt to print value the interpreter falls in hard fault </h4><br>  It was already harder to detect the problem, but as a result, we managed to find out that snprintf is used for printing.  Since lua stores values ‚Äã‚Äãin double (or float in our case), printf (and its derivatives) with floating point support is required (I wrote about the intricacies of the printf settings <a href="https://habr.com/ru/post/459420/">here</a> ). <br><br><h2>  Requirements for non-volatile (flash) memory </h2><br>  Here are some measurements that I made, allowing you to judge how much you need to allocate non-volatile (flash) memory to integrate a Lua-machine into the project.  Compilation was done using gcc-arm-none-eabi-8-2018-q4-major.  The version used is Lua 5.4.  Below in the measurements, the phrase ‚Äúwithout Lua‚Äù means not including the interpreter directly in the project and the methods interacting with it and its libraries, as well as the object of the lua_repl class.  All low-level entities (including overrides for the work of the <i>printf</i> and <i>fwrite</i> functions) remain in the project.  FreeRTOS heap size is 1024 * 25 bytes.  The rest is occupied by the global essence of the project. <br><br>  A summary table of the results looks like this (all sizes in bytes): <br><table border="1"><tbody><tr><th>  Build options </th><th>  No lua </th><th>  Core only </th><th>  Lua with base library </th><th>  Lua with libraries base, coroutine, table, string </th><th>  luaL_openlibs </th></tr><tr><td>  -O0 -g3 </td><td>  103028 </td><td>  220924 </td><td>  236124 </td><td>  262652 </td><td>  308372 </td></tr><tr><td>  -O1 -g3 </td><td>  74940 </td><td>  144732 </td><td>  156916 </td><td>  174452 </td><td>  213068 </td></tr><tr><td>  -Os -g0 </td><td>  71172 </td><td>  134228 </td><td>  145756 </td><td>  161428 </td><td>  198400 </td></tr></tbody></table><br><h2>  RAM requirements </h2><br>  Since the consumption of RAM depends entirely on the task, I will give a summary table of consumed memory immediately after turning on the machine with a different set of libraries (it is displayed with the command <i>print (collectgarbage ("count" * 1024)</i> )). <br><table border="1"><tbody><tr><td>  Composition </td><td>  RAM used </td></tr><tr><td>  Lua with base library </td><td>  4809 </td></tr><tr><td>  Lua with libraries base, coroutine, table, string </td><td>  6407 </td></tr><tr><td>  luaL_openlibs </td><td>  12769 </td></tr></tbody></table><br>  In the case of using all libraries, the size of the required RAM increases significantly in comparison with the previous sets.  However, its use in a large part of the application is not necessary. <br><br>  In addition, 4 kb is also allocated to the task stack, in which the Lua-machine is executed. <br><br><h2>  Further use </h2><br>  To make full use of the machine in the project, then you will need to describe all the interfaces required by the business logic code to the hardware or service objects of the project.  However, this is a topic for a separate article. <br><br><h2>  Results </h2><br>  This article explained how you can connect a Lua-machine to the microcontroller project, as well as launch a full-fledged interactive interpreter that allows you to experiment with business logic directly from the command line of the terminal.  In addition, the hardware requirements of the microcontroller were considered for different trim levels of the Lua machine. </div><p>Source: <a href="https://habr.com/ru/post/459602/">https://habr.com/ru/post/459602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459594/index.html">Read between notes: data transfer system inside music</a></li>
<li><a href="../459596/index.html">iOS digest number 9 (June 28 - July 11)</a></li>
<li><a href="../459598/index.html">SELinux Frequently Asked Questions (FAQ)</a></li>
<li><a href="../4596/index.html">Social network as a way to improve yourself</a></li>
<li><a href="../45960/index.html">"I do not minus" or the value of diversity</a></li>
<li><a href="../459604/index.html">Telegram - bot | Full menu</a></li>
<li><a href="../459606/index.html">Distributed social networks</a></li>
<li><a href="../459610/index.html">These dangerous routers: the most large-scale hacks of recent network equipment and ways to protect</a></li>
<li><a href="../459612/index.html">How Qualcomm has ripped off the mobile industry for almost 20 years in a row.</a></li>
<li><a href="../459614/index.html">Utko-robot muddies the water in the rice fields</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>