<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flexible access control at the record object level</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello to all! 


 In projects based on Django, one often wants to use flexible access control at the level of records (objects) when different users h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flexible access control at the record object level</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello to all! </p><br><p>  In projects based on Django, one often wants to use flexible access control at the level of records (objects) when different users have, or vice versa, do not have access to individual objects within the same model. </p><br><p>  I want to tell you what kind of data access policy was required in our project, why a suitable ready-made system was not found and how a new access control system appeared at the record level. </p><br><p>  For the most meticulous, the following are the details of the system, its internal logic and how to handle it. </p><a name="habracut"></a><br><h1 id="dlya-teh-komu-ne-terpitsya">  For those who can not wait </h1><br><p>  <a href="https://github.com/nnseva/django-access">Django-Access Project</a> </p><br><h1 id="suschestvuyuschie-sistemy">  Existing Systems </h1><br><p>  For Jangi, there are already several entry-level access control systems.  The most famous and stable systems such as <a href="http://django-guardian.readthedocs.io/">Django-Guardian</a> and <a href="http://django-authority.readthedocs.io/en/latest/">Django-Authority</a> . </p><br><h2 id="django-guardian">  Django-guardian </h2><br><p>  The first of the systems, <a href="http://django-guardian.readthedocs.io/">Django-Guardian</a> , requires the creation of an untyped relationship (that is, records in the database) between the user and the object with which the user can interact.  Each pair of user and object requires such a separate rights record.  The number of these records in the database will be calculated as the product of the number of users and objects, the access rights to which are regulated in such a system. </p><br><p>  It is easy to understand that in the case of an unlimited number of users and management objects in the project database, the number of rights records will grow quite quickly.  Also, managing the deletion of these records when deleting users, a group change of rights records in the event of a change in the user's access area or moving an object from one user to another, made use of <a href="http://django-guardian.readthedocs.io/">Django-Guardian</a> in our project unlikely. </p><br><h2 id="django-authority">  Django-authority </h2><br><p>  The second system, <a href="http://django-authority.readthedocs.io/en/latest/">Django-Authority</a> , tries to solve the problem of the first, establishing the relationship between the user and the managed object through common tags.  Each such tag is an entry in the tag table associated with the user or control object.  If tags with the same name are associated with a specific user and a specific object, we consider that this user has access to this control object. </p><br><p>  The number of tag entries in this case will be substantially less and proportional to the sum of the number of users and objects, which is acceptable.  However, in such a system will have to maintain a very unusual tag naming system.  Practically, each such name will correspond to a certain "scope" (visibility for example).  All objects belonging to this scope will have the corresponding tag, as well as users who have access to this scope. </p><br><p>  The performance problem, which is not fundamentally solved in Django-Guardian, is quite tolerably solved in Django-Authority. </p><br><p>  Unfortunately, the development of this system has been suspended for a long time.  Integration with the admin control access according to the established relationship, it does not.  We wanted to develop an application interface based on the admin panel, but using this system, we would still have to edit the admin panel anyway. </p><br><p>  If you still have to edit the admin panel, why not make your own access control system? </p><br><h1 id="chto-trebuetsya-ot-novoy-sistemy">  What is required from the new system </h1><br><h2 id="kakie-prava-nuzhno-raspredelyat">  What rights need to be distributed </h2><br><p>  Initially, our system was focused only on determining the visibility of objects, dividing their set "horizontally."  The rights to control objects that were in the zone of visibility were distributed according to the traditional system of rights in Dzhanga, in accordance with their models (types) - ‚Äúvertically‚Äù. </p><br><p>  This separation worked until a certain point is quite acceptable, however, when it was necessary to distribute access "crosswise", it turned out that our system is too coarse.  Really.  Let we distribute access to objects of users.  The user - the administrator of his group, may well edit and even delete a user record from this group.  On the other hand, we would like users who are the administrators of their groups to be ordinary users of other groups.  However, the admin has the same access to the records as soon as he sees them, no matter which group. </p><br><p>  Thus, it became clear that ‚Äúhorizontally‚Äù it was necessary to control not only the visibility of objects, but also the entire spectrum of operations performed on them.  Traditionally, 4 types of the most popular and commonly used actions on objects are defined, sometimes combined with the abbreviation CRUD (Create, Read, Update, Delete): </p><br><ul><li>  create </li><li>  see </li><li>  change </li><li>  delete </li></ul><br><h2 id="mnozhestva-nad-kotorymi-opredeleny-prava">  Sets over which rights are defined </h2><br><p> We need to regulate permissions on certain actions on subsets of objects.  The most natural and effective way to manipulate specific subsets of objects in Jange is to use the <code>QuerySet</code> .  We will use it wherever we need to deal with a specific subset of objects. </p><br><p>  However, <code>QuerySet</code> does not describe one of the variants of the sets that we need: the set of all objects of this model, <em>including all past and future objects</em> .  In fact, this set is determined by the model itself, and it is the only kind of set over which the ‚Äútraditional‚Äù Django rights are defined.  In fact: let's say we check permissions based on the <code>QuerySet</code> .  Having received an empty <code>QuerySet</code> , we cannot be sure whether there are any objects in it due to the fact that we do not have enough rights to see any objects, or because the database has not yet formed such objects that we could would see. </p><br><p>  Thus, we will define a set of objects over which rights are defined, either using the <code>QuerySet</code> , defining a specific set of objects, or using a model, meaning all the objects of this model that have ever existed or were created in the future. </p><br><h2 id="chto-pridetsya-izmenit">  What will have to change </h2><br><h3 id="adminka">  Admin panel </h3><br><p>  Actually, all of the above should be applied to the admin panel.  It should show us a list of visible objects, allowing and forbidding them to add, edit or delete, depending on the rights set. </p><br><p>  In order to change the behavior of already existing admins, it is necessary to make so that instead of (or in addition to) parts of their methods, code is called that takes into account the restrictions and permissions imposed by the new access control system.  This is best done using the <em>Mixin</em> programming <em>pattern</em> , defining a class that, being at the top of the list of base classes, intercepts the method call from other base classes. </p><br><h3 id="tradicionnaya-sistema-permission">  Traditional <em>Permission</em> System </h3><br><p>  We still need to define rights not only over the subsets defined by the <code>QuerySet</code> , but also over the set of all objects of a given type, defined by the model as such.  Therefore, we will define the ‚Äútraditional‚Äù Jungi rights model, based on <em>Permission</em> objects, as one of the <em>possible ones</em> , which may or may not be used in the project. </p><br><h2 id="gde-dolzhny-byt-opisany-prava">  Where rights should be described </h2><br><p>  At first it seems that the best place to post information about the method of distribution of rights is the model.  Our old system used the object manager for this, the thing in Jang, which serves to access the model objects and can be redefined if you insert it into the definition of the model class (the <em>objects</em> property). </p><br><p>  However, this method, as it turned out, has several disadvantages. </p><br><p>  First, the method of accessing the model object is a property not of <em>the</em> Django <em>application</em> (subsystem, which is often used unchanged from the installed package), but of the <em>project</em> as a whole.  If the same application (package) is used in different projects, it is very likely that access to the model objects of this application will be defined in these projects differently. </p><br><p>  Secondly, the definition of access rules can (and most often will) cross the boundaries of several applications (for example <em>auth</em> ).  Being described in one of them, the definition may require unnecessary communication with another application (package). </p><br><p>  Thus, the project should have its own, independent of individual applications, register of access rules for different objects of its applications (packages).  This registry can be populated structured from different modules imported as models are used.  Such a registry will contain the definition of access rules not only for its own models, but also models imported from all applications (packages) involved in the project. </p><br><h2 id="kak-opisyvat-prava">  How to describe rights </h2><br><p>  Unsuccessful, too narrow, the solution to this problem led to unnecessary restrictions in existing packages. </p><br><p>  Unlike other packages, we will describe the rights not with the help of some special models intended only for this purpose, but dynamically, with the help of the <em>code</em> applied to the models already existing in the project and the requests for them. </p><br><p>  Fortunately, the code can be located not only in a method or function, but also in a lambda expression.  We will use this method to describe the most obvious, simple, and frequently used access restriction rules. </p><br><h2 id="kontekst-vypolneniya-pravil-ogranicheniya-dostupa">  Context of the execution of access restriction rules </h2><br><p>  Usually, access restrictions are made relative to the "current" user.  It should not be forgotten, however, that the current user may not be the only element of the context for which access is restricted.  It may well be that accessing will be affected by the ‚Äúcurrent venture‚Äù, the selected country, language, or any other factors that are relevant at the time of the decision to grant access. </p><br><p>  Therefore, our code defining the access rules will receive as a context access restrictions, the entire request ( <em>Request</em> ).  What exactly of this context is subject to restrictions, this code itself must decide. </p><br><h1 id="struktura-klassov-sistemy">  Class structure of the system </h1><br><h2 id="menedzher-dostupa">  Access manager </h2><br><p>  The central class that determines the functionality of the system is the access manager - the <code>managers.AccessManager</code> class.  On the one hand, it allows you to register plug-in objects that define access restriction rules for various objects, and on the other hand, objects of this class are used to perform operations on determining rights regarding objects and sets when such a definition is required in the program. </p><br><h2 id="sozdanie-pravil-ogranicheniya-dostupa">  Creating access restriction rules </h2><br><p>  Access restriction rules are created by constructing and registering plug-in objects. </p><br><p>  The <code>register/unregister_plugin(s)</code> manager class methods allow you to manipulate the plugin registry.  No more than one plug-in for one model class is added to the registry.  The <code>register_plugins</code> method receives a dictionary in which the models serve as keys, and <code>register_plugin</code> receives the model class and the plug-in object as separate parameters. </p><br><p>  The helper class of the manager class <code>get_default_plugin</code> returns the registered plugin by default, and <code>plugin_for</code> searches for the plugin registered for the transferred class of the model.  When searching for a plugin for a model, inheritance is taken into account, but classes that are not a model are excluded from the search.  If the plugin for the model is not found, the default plugin is returned. </p><br><p>  The predefined plug-in classes in the <code>plugins</code> module include <code>CompoundPlugin</code> to combine other plug-ins, plug-ins to dynamically define <code>ApplyAblePlugin</code> and <code>CheckAblePlugin</code> access restriction rules, and <code>DjangoAccessPlugin</code> , which implements access restriction rules like the traditional ones, based on the analysis of <code>django.contrib.auth.Permission</code> . </p><br><h2 id="proverka-ogranicheniya-dostupa">  Access restriction check </h2><br><p>  Dynamically defined attributes allow the <code>AccessManager</code> methods <code>check_something</code> and <code>apply_something</code> , where <code>something</code> is any valid name.  This name serves as the name of an ability ‚Äî the <em>ability</em> ‚Äî that is requested from the system.  For example, to obtain permissions for viewing (ability <code>visible</code> ), the methods <code>check_visible</code> and <code>appy_visible</code> . </p><br><p>  The <code>check_something</code> method gets the model and determines the ability limit on its relation, and the <code>appy_something</code> method passes the <code>QuerySet</code> and the method determines the limitations of our ability relative to the list of objects in this query. </p><br><p>  The manager searches for the registered plug-in and requests from him, or from the plug-in by default, a similar method.  The missing method means the permission of the requested actions with the specified ability with respect to all objects of the requested set.  If a plugin is found, it checks. </p><br><h3 id="ogranichenie-dostupa-k-modeli-v-celom">  Restricting access to the model as a whole </h3><br><p>  Restricting access to the model as a whole is done using the plugin method with the <code>check_</code> prefix.  The model and the <code>Request</code> object are passed to the method, determining the context of the rights check.  If the method returns False, access is denied.  To allow access, a dictionary is usually returned, which allows you to combine the returned values ‚Äã‚Äãwhen <code>CompoundPlugin</code> processes them.  This, somewhat unexpected, method of returning values ‚Äã‚Äãallows them to be used when requesting access to add <code>check_appendable</code> : the fields whose names are mentioned in the returned combined dictionary are filled with values ‚Äã‚Äãtaken from the dictionary from the newly created object. </p><br><h3 id="ogranichenie-dostupa-k-otdelnym-obektam">  Restricting access to individual objects </h3><br><p>  Analysis of restriction of access to individual objects implies the imposition of filters on the <code>QuerySet</code> query, leaving in it only those objects for which the specified access is allowed. </p><br><p>  Such an overlay is performed by the plugin method with the prefix <code>apply_</code> .  The method is passed the <code>QuerySet</code> and the <code>Request</code> object, which defines the context of the rights check.  The method imposes on the passed <code>QuerySet</code> filters that limit the set of objects only to those that allow the specified access method for the specified context, and returns the filtered <code>QuerySet</code> . </p><br><h2 id="standartnye-proverki">  Standard checks </h2><br><p>  The system checks the following capabilities from the context in relation to the system objects: </p><br><ul><li>  <code>appendable</code> - create </li><li>  <code>visible</code> - see </li><li>  <code>changeable</code> - change </li><li>  <code>deleteable</code> - delete </li></ul><br><p>  At the same time, the ability of <code>appendable</code> checked only for the model as a whole, using the <code>check_appendable</code> method <code>check_appendable</code> respectively, since checking for specific objects does not make sense: they have already been created. </p><br><p>  The remaining abilities are tested both in relation to the model as a whole, and in relation to a specific list of objects.  Total for standard checks, the following plugin methods are called if they are defined: </p><br><ul><li> <code>check_appendable</code> </li> <li> <code>check_visible</code> </li> <li> <code>apply_visible</code> </li> <li> <code>check_changeable</code> </li> <li> <code>apply_changeable</code> </li> <li> <code>check_deleteable</code> </li> <li> <code>apply_deleteable</code> </li> </ul><br><h2 id="nestandartnye-proverki">  Custom checks </h2><br><p>  Any application can construct an <code>AccessManager</code> object and request that it check both standard and non-standard capabilities.  To do this, the application requests a method with the prefix <code>check_</code> or <code>apply_</code> and the suffix corresponding to the requested ability. </p><br><p>  If the method corresponding to the requested ability is not defined in the found plugin, it is considered available.  The <code>check_</code> method in this case returns an empty dictionary, and <code>apply_</code> an unmodified <code>QuerySet</code> . </p><br><h2 id="adminka-1">  Admin panel </h2><br><p>  The <code>admin</code> module contains a special class <code>AccessControlMixin</code> , which can be <code>AccessControlMixin</code> to any class of standard jung admin admin.  This class overrides the methods that participate in determining the order of access to objects, and restricts access in accordance with the rules of access restriction established for the project. </p><br><p>  For constructing admins from scratch, the classes <code>AccessModelAdmin</code> , <code>AccessTabularInline</code> and <code>AccessStackedInline</code> are also defined, which can be used in exactly the same way as their prototypes from Dzhangi.  In essence, these classes are a pure combination of <code>AccessControlMixin</code> and the corresponding class from Jangi. </p><br><h1 id="primer">  Example </h1><br><p>  To demonstrate the capabilities of the package, we use an example that is part of the package source code. </p><br><p>  The example uses models from the standard package <code>django.contrib.auth</code> , and also has its own additional application, <code>someapp</code> , in which it defines two model classes: </p><br><ul><li>  <code>SomeObject</code> managed from a separate <code>ModelAdmin</code> , which refers to the <code>editor_group</code> editors and many groups with read access - <code>viewer_groups</code> </li><li>  <code>SomeChild</code> which refers to <code>SomeObject</code> and is controlled from <code>InlineAdmin</code> </li></ul><br><p>  The example defines the following access scheme: </p><br><ul><li>  superuser can do anything </li><li>  ordinary <code>Permission</code> are used </li><li>  all users can read, if allowed, all the characteristics of a <code>User</code> object from each other, with the exception of a password and email </li><li>  <code>User</code> 's record about yourself is available to change, excluding the <code>is_superuser</code> field </li><li>  Group groups and <code>Permission</code> rights are available only those that are relevant to this user </li><li>  <code>SomeObject</code> objects and their <code>SomeChild</code> subobjects <code>SomeChild</code> available for reading to users of groups defined as <code>viewer_groups</code> and for writing to users included in the <code>editor_group</code> group </li></ul><br><p>  The add access rule for a group also determines that when added, the group includes its creator.  This is done to ensure that the newly created group is available to its creator after adding. </p><br><p>  Thus, in the example, by using the functionality of the package and adding a minimum of additional code, a comfortable secure environment with controlled access is created, both to the individual functions of users and to the common space for them. </p><br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  The functional definition of access restriction rules in the <a href="https://github.com/nnseva/django-access">Django-Access</a> package makes it easy to set complex arbitrary access control rules, avoiding the creation of additional entities that clutter up a project with code and the database with records. </p><br><p>  Join the development of the project, look for bugs, create an issue.  Pull requests are welcome. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341496/">https://habr.com/ru/post/341496/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341484/index.html">Monitoring raid arrays in Windows Core</a></li>
<li><a href="../341486/index.html">What are the most popular programming languages: IT platform statistics</a></li>
<li><a href="../341490/index.html">Introducing free ordering and extended subscription for freelancers</a></li>
<li><a href="../341492/index.html">Network visibility and Ixia solutions</a></li>
<li><a href="../341494/index.html">Intuitive algorithm development</a></li>
<li><a href="../341500/index.html">Introduction to frequently used features of ES6. Part 2</a></li>
<li><a href="../341502/index.html">We write your mapper for .NET Standard 2.0</a></li>
<li><a href="../341506/index.html">Reed-Solomon codes. Part 2 - Galois Field Arithmetic</a></li>
<li><a href="../341508/index.html">How do we make a map for those who make a map</a></li>
<li><a href="../341510/index.html">Taxes on the sale of Google applications and ads</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>