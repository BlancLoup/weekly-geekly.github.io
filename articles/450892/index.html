<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Is storage speed suitable for etcd? Ask fio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A short story about fio and etcd 


 The performance of an etcd cluster depends largely on the performance of its storage. etcd exports some metrics t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Is storage speed suitable for etcd? Ask fio</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/6g/sf/kx/6gsfkx6hm7bcpebreyfrtw3kpps.jpeg"></p><br><h3 id="korotkaya-istoriya-o-fio-i-etcd">  A short story about fio and etcd </h3><br><p>  The performance of an <a href="https://github.com/etcd-io/etcd">etcd</a> cluster depends largely on the performance of its storage.  etcd exports some metrics to <a href="https://prometheus.io/">Prometheus</a> to provide the necessary storage performance information.  For example, the metric wal_fsync_duration_seconds.  <a href="">The etcd documentation says</a> : for the storage to be considered fast enough, the 99th percentile of this metric must be less than 10 ms.  If you plan to run the etcd cluster on Linux machines and want to evaluate whether your storage is fast enough (for example, SSD), you can use <a href="https://github.com/axboe/fio">fio</a> , a popular tool for testing I / O operations.  Run the following command, where test-data is the directory under the storage connection point: </p><br><pre><code class="plaintext hljs">fio --rw=write --ioengine=sync --fdatasync=1 --directory=test-data --size=22m --bs=2300 --name=mytest</code> </pre> <br><p>  You just need to look at the results and check that the 99th percentile of the <a href="https://linux.die.net/man/2/fdatasync">fdatasync</a> duration is less than 10 ms.  If yes, you have enough fast storage.  Here is an example of the results: </p><br><pre> <code class="plaintext hljs"> sync (usec): min=534, max=15766, avg=1273.08, stdev=1084.70 sync percentiles (usec): | 1.00th=[ 553], 5.00th=[ 578], 10.00th=[ 594], 20.00th=[ 627], | 30.00th=[ 709], 40.00th=[ 750], 50.00th=[ 783], 60.00th=[ 1549], | 70.00th=[ 1729], 80.00th=[ 1991], 90.00th=[ 2180], 95.00th=[ 2278], | 99.00th=[ 2376], 99.50th=[ 9634], 99.90th=[15795], 99.95th=[15795], | 99.99th=[15795]</code> </pre> <a name="habracut"></a><br><p>  <strong>Notes</strong> </p><br><ul><li>  We have configured the values ‚Äã‚Äãof the parameters --size and --bs for our specific script.  To get a useful result from fio, specify your values.  Where to get them?  Read <a href="https://www.ibm.com/blogs/bluemix/2019/04/using-fio-to-tell-whether-your-storage-is-fast-enough-for-etcd/">how we learned to customize fio</a> . </li><li>  During testing, the entire I / O load comes from fio.  In the real scenario, most likely, the storage will receive other write requests, except for those related to wal_fsync_duration_seconds.  The additional load will increase the value of wal_fsync_duration_seconds.  So if the 99th percentile almost reached 10 ms, your storage will not have enough speed. </li><li>  <strong>Take the <a href="https://github.com/axboe/fio">fio</a> version at least 3.5</strong> (the previous ones do not show percentiles of the length of fdatasync). </li><li>  The above shows only a fragment of the results from fio. </li></ul><br><h3 id="dlinnaya-istoriya-o-fio-i-etcd">  Long story about fio and etcd </h3><br><p>  <strong>What is WAL in etcd</strong> </p><br><p>  Typically, databases use a <a href="https://en.wikipedia.org/wiki/Write-ahead_logging">proactive write log</a> ;  etcd also uses it.  Here we will not discuss in detail the forward-looking log (write-ahead log, WAL).  We just need to know that every member of the etcd cluster keeps it in persistent storage.  etcd records each operation with key-value pairs (for example, an update) in WAL before applying them to the repository.  If between the snapshots one of the members of the repository crashes and restarts, it can locally recover transactions since the last snapshot of the WAL content. </p><br><p>  When a client adds a key to the repository of key-value pairs or updates the value of an existing key, etcd records this operation in WAL, which is a regular file in the persistent store.  Before proceeding further, etcd MUST be completely sure that an entry in WAL has actually occurred.  In Linux, a single <a href="https://linux.die.net/man/2/write">write</a> system call is not enough, since the actual write to the physical storage may be delayed.  For example, Linux may for some time store a WAL entry in the cache in the kernel‚Äôs memory (for example, a page cache).  And in order for the data to be accurately recorded in the persistent storage, you need the fdatasync system call after recording, and etcd just uses it (as you can see from the work of <a href="https://linux.die.net/man/1/strace">strace</a> , where 8 is the WAL file descriptor): </p><br><pre> <code class="plaintext hljs">21:23:09.894875 lseek(8, 0, SEEK_CUR) = 12808 &lt;0.000012&gt; 21:23:09.894911 write(8, ".\0\0\0\0\0\0\202\10\2\20\361\223\255\266\6\32$\10\0\20\10\30\26\"\34\"\r\n\3fo"..., 2296) = 2296 &lt;0.000130&gt; 21:23:09.895041 fdatasync(8) = 0 &lt;0.008314&gt;</code> </pre> <br><p>  Unfortunately, writing to the persistent storage does not take place instantly.  If the fdatasync call is slow, the performance of the etcd system drops.  <a href="">The etcd documentation states</a> that storage is considered fast enough if in the 99th percentile of calls to fdatasync it takes less than 10 ms to write to the WAL file.  There are other useful metrics for storage, but in this post we only talk about this metric. </p><br><h3 id="ocenka-hranilischa-s-pomoschyu-fio">  Evaluation of storage using fio </h3><br><p>  If you need to assess whether your storage is suitable for etcd, use fio, a very popular I / O load test tool.  It should be remembered that disk operations can be very different: synchronous and asynchronous, many classes of system calls, etc. As a result, fio is very difficult to use.  It has many parameters, and different combinations of their values ‚Äã‚Äãproduce completely different I / O workloads.  To get adequate numbers for etcd, you should make sure that the recording test load from fio is as close as possible to the actual load from etcd when writing WAL files. </p><br><p>  Therefore, fio should, at a minimum, create a load in the form of a series of consecutive write operations to a file, each record will consist of a <a href="https://linux.die.net/man/2/write">write</a> system call followed by a fdatasync system call.  For consecutive write operations, fio needs the --rw = write parameter.  To use the write call system instead of pwrite when writing fio, you should specify the --ioengine = sync parameter.  Finally, in order for fdatasync to be called after each record, you need to add the parameter - fdatasync = 1.  The other two parameters in this example (--size and --bs) depend on the specific script.  In the next section, we will explain how to configure them. </p><br><h3 id="pochemu-imenno-fio-i-kak-my-nauchilis-ego-nastraivat">  Why exactly fio and how we learned to tune it </h3><br><p>  In this post we describe the real case.  We had a cluster of <a href="http://ibm.com/cloud/learn/kubernetes">Kubernetes</a> v1.13, which we monitored using Prometheus.  etcd v3.2.24 hosted on SSD.  The etcd metrics showed too high latency for fdatasync, even when the cluster did nothing.  The metrics were weird, and we really didn't know what they meant.  The cluster consisted of virtual machines, it was necessary to understand what the problem was: in physical SSDs or in the virtualization layer.  In addition, we often made changes in the configuration of hardware and software, and we needed a way to evaluate their results.  We could run etcd in each configuration and look at the metrics of Prometheus, but this is too troublesome.  We were looking for a fairly simple way to evaluate a specific configuration.  We wanted to check whether we understand Prometheus metrics from etcd. </p><br><p>  But for this it was necessary to solve two problems.  First, what does the I / O load that etcd creates when writing to WAL?  What system calls are used?  What is the size of the records?  Secondly, if we answer these questions, how do you reproduce a similar workload with fio?  Remember that fio is a very flexible tool with many options.  We solved both problems with a single approach ‚Äî using the <a href="https://linux.die.net/man/8/lsof">lsof</a> and <a href="https://linux.die.net/man/1/strace">strace</a> commands.  lsof displays all the file descriptors used by the process, and the associated files.  And with the help of strace, you can study an already running process or start a process and study it.  strace displays all system calls from the process being studied (and its child processes).  The latter is very important, because etcd just takes a similar approach. </p><br><p>  First of all, we used strace to examine the etcd server for Kubernetes when there was no load on the cluster.  We saw that almost all WAL entries were about the same size: 2200‚Äì2400 bytes.  Therefore, in the command at the beginning of the post, we specified the parameter --bs = 2300 (bs means the size in bytes for each fio entry).  Note that the size of the etcd entry depends on the etcd version, delivery, parameter values, etc., and affects the duration of fdatasync.  If you have a similar scenario, examine your etcd processes with strace to find out the exact numbers. </p><br><p>  Then, to get a good idea of ‚Äã‚Äãthe actions in the etcd file system, we launched it with strace and with the -ffttT parameters.  So we tried to study the child processes and write the output of each of them in a separate file, and also get detailed reports on the beginning and duration of each system call.  We used lsof to confirm our analysis of the output of strace and see which file descriptor was used for what purpose.  So with the help of strace we got the results shown above.  Synchronization time statistics confirmed that the wal_fsync_duration_seconds from etcd met the fdatasync invocations with WAL file descriptors. </p><br><p>  We studied the fio documentation and chose parameters for our script so that fio generates a load similar to etcd.  We also checked the system calls and their duration by running fio from strace, similar to etcd. </p><br><p>  We carefully selected the value of the --size parameter, which represents the entire I / O load from fio.  In our case, this is the total number of bytes written to the storage.  It turned out to be directly proportional to the number of write (and fdatasync) system calls.  For a specific bs value, the number of calls fdatasync = size / bs.  Since we were interested in the percentile, we should have had enough samples for validity, and we calculated that 10 ^ 4 will be enough for us (it turns out 22 mebibytes).  If --size is smaller, outliers may occur (for example, several fdatasync calls work longer than usual and affect the 99th percentile). </p><br><h3 id="poprobuyte-sami">  Try it yourself </h3><br><p>  We showed how to use fio and find out if the storage has enough speed for high performance etcd.  Now you can try it in practice on your own, using, for example, SSD virtual machines in the <a href="https://cloud.ibm.com/">IBM Cloud</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/450892/">https://habr.com/ru/post/450892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45088/index.html">EP - United Russian Portal. Mama‚Ä¶</a></li>
<li><a href="../450880/index.html">Measure cast parts of complex shape? MetraSCAN 3D to the rescue</a></li>
<li><a href="../450886/index.html">Background: how hydrogen cars work and when they will appear on the roads</a></li>
<li><a href="../450888/index.html">Swift: Eratosthenes Sieve</a></li>
<li><a href="../450890/index.html">Google News I / O 2019: Pixel 3a, Android Q, Kotlin, etc.</a></li>
<li><a href="../450894/index.html">Pro antennas for the smallest</a></li>
<li><a href="../450896/index.html">Lab: set up lvm, raid on linux</a></li>
<li><a href="../450898/index.html">Interface development on multiple screens. Step to using AI</a></li>
<li><a href="../4509/index.html">Yahoo collects "parcel" for aliens</a></li>
<li><a href="../450902/index.html">Want loyal employees - start with yourself</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>