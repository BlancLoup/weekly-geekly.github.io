<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with Aerospike on scala using macro magic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our bigdata department, some of the data is stored in Aerospike. There are a lot of consumers, among them there are two applications written in Sca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with Aerospike on scala using macro magic</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/e89/09d/519/e8909d5198454cd8bfa681f747f3b43d.png" alt="N |  Solid"></p><br><p>  In our bigdata department, some of the data is stored in Aerospike.  There are a lot of consumers, among them there are two applications written in Scala, the interaction with the base in which will be expanded in connection with the constantly growing demands of the business.  The only decent driver for us was the java client mentioned on the site of the aerospike.com database itself ( <a href="http://www.aerospike.com/docs/client/java">http://www.aerospike.com/docs/client/java</a> ).  Converting rock data types (and especially hierarchical) to the corresponding Aerospike types leads to a large amount of boilerplate.  To avoid this, we need a more convenient, and at the same time, a type-safe interface. </p><br><p>  Engineers do not like to write the same code many times and try to simplify and optimize all repetitive actions.  Such problems are often solved by code generation.  Therefore, we decided to write our own library for working with Aerospike, using <a href="http://docs.scala-lang.org/overviews/macros/overview.html">macros</a> . </p><br><a name="habracut"></a><br><h4 id="nemnogo-pro-aerospike">  A little bit about Aerospike </h4><br><p>  <a href="http://www.aerospike.com/russian/">Aerospike</a> is a distributed schema-less key-value database that works on the principle of a hash table.  It is actively used in our bank for building distributed caches and for tasks requiring low response time.  The database is easy to install and easy to administer, which simplifies its implementation and support. </p><br><p> About the storage model: the namespace and setName parameters are associated with record keys, and the data itself is stored in so-called bins.  Values ‚Äã‚Äãcan be of various types: <code>Integers, Strings, Bytes, Doubles, Lists, Maps, Sorted Maps, GeoJSON</code> .  Interestingly, the type of the bean is not fixed and, having written down, say, <code>Integer</code> , you can then overwrite it with any other.  Drivers written for this database have a fair amount of code for serializing the values ‚Äã‚Äãof the external model into the internal one. </p><br><h4 id="pro-sozdanie-dsl">  About creating DSL </h4><br><p>  Consider the simple examples of the design process of our DSL, why we decided to use macros, and what came of it all. </p><br><p>  In conditions of limited time (interaction with this base is only a small part of the project) it is difficult to write the entire client with the implementation of the protocol.  In addition, it would require more effort in support.  Therefore, we stopped at creating a wrapper for an existing client.  Consider the examples. </p><br><p>  The basis is the Aerospike Java Client version 3.3.1 (it can be found at www.aerospike.com, the source code is on <a href="https://github.com/aerospike/aerospike-client-java">GitHub</a> ), a considerable part of the methods in which operates with keys and bins from the <code>com.aerospike.client</code> package.  Java Client supports working with the database both in synchronous and asynchronous mode.  We use asynchronous <code>com.aerospike.client.async.AsyncClient</code> .  The easiest way to create it: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AsyncClient</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AsyncClientPolicy</span></span>, hosts.map(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Host</span></span>(_, port)): _*)</code> </pre> <br><p>  where <code>hosts</code> is a <code>List[String]</code> containing the hosts of your database, and <code>port</code> is an <code>Int</code> (default 3000). </p><br><p>  If during the creation of the client to transfer invalid values ‚Äã‚Äãof the hosts or the wrong port, the driver throws an error, because during the call it checks the connection: </p><br><pre> <code class="scala hljs">scala&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AsyncClient</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AsyncClientPolicy</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>().map(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Host</span></span>(_, port)): _*) com.aerospike.client.<span class="hljs-type"><span class="hljs-type">AerospikeException</span></span>$<span class="hljs-type"><span class="hljs-type">Connection</span></span>: <span class="hljs-type"><span class="hljs-type">Error</span></span> <span class="hljs-type"><span class="hljs-type">Code</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-type"><span class="hljs-type">Failed</span></span> to connect to host(s):</code> </pre> <br><h5 id="tablica-sootvetstviy-tipov-v-dsl-java-client-i-baze-dannyh">  Type mapping table in DSL, Java CLient and database </h5><br><br><pre> <code class="scala hljs">| <span class="hljs-type"><span class="hljs-type">Scala</span></span> | <span class="hljs-type"><span class="hljs-type">Java</span></span> <span class="hljs-type"><span class="hljs-type">Client</span></span> | <span class="hljs-type"><span class="hljs-type">Aerospike</span></span> | |-------------- |-------------- |----------- | | <span class="hljs-type"><span class="hljs-type">Int</span></span> | <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span> | <span class="hljs-type"><span class="hljs-type">Integer</span></span> | | <span class="hljs-type"><span class="hljs-type">Long</span></span> | <span class="hljs-type"><span class="hljs-type">LongValue</span></span> | <span class="hljs-type"><span class="hljs-type">Integer</span></span> | | <span class="hljs-type"><span class="hljs-type">String</span></span> | <span class="hljs-type"><span class="hljs-type">StringValue</span></span> | <span class="hljs-type"><span class="hljs-type">String</span></span> | | <span class="hljs-type"><span class="hljs-type">Boolean</span></span> | <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span> | <span class="hljs-type"><span class="hljs-type">Integer</span></span> | | <span class="hljs-type"><span class="hljs-type">Float</span></span> | <span class="hljs-type"><span class="hljs-type">FloatValue</span></span> | <span class="hljs-type"><span class="hljs-type">Double</span></span> | | <span class="hljs-type"><span class="hljs-type">Double</span></span> | <span class="hljs-type"><span class="hljs-type">DoubleValue</span></span> | <span class="hljs-type"><span class="hljs-type">Double</span></span> | | <span class="hljs-type"><span class="hljs-type">Seq</span></span> | <span class="hljs-type"><span class="hljs-type">ListValue</span></span> | <span class="hljs-type"><span class="hljs-type">List</span></span> | | <span class="hljs-type"><span class="hljs-type">Map</span></span> | <span class="hljs-type"><span class="hljs-type">MapValue</span></span> | <span class="hljs-type"><span class="hljs-type">Map</span></span> | | <span class="hljs-type"><span class="hljs-type">Char</span></span> | <span class="hljs-type"><span class="hljs-type">StringValue</span></span> | <span class="hljs-type"><span class="hljs-type">String</span></span> | | <span class="hljs-type"><span class="hljs-type">Short</span></span> | <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span> | <span class="hljs-type"><span class="hljs-type">Integer</span></span> | | <span class="hljs-type"><span class="hljs-type">Byte</span></span> | <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span> | <span class="hljs-type"><span class="hljs-type">Integer</span></span> | | <span class="hljs-type"><span class="hljs-type">HList</span></span> | <span class="hljs-type"><span class="hljs-type">MapValue</span></span> | <span class="hljs-type"><span class="hljs-type">Map</span></span> | | <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">|</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MapValue</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">|</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Map</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">|</span></span></span></span></code> </pre> <br><p>  The table shows that there are quite a few similar transformations ahead.  Write it all with your hands every time there is no desire. </p><br><p>  The first thought was about reflexion, but the runtime version does not suit us - it is long and expensive.  There remains a variant with a compile-time reflexion, which allows generating converters and receiving error messages at the compilation stage. </p><br><p>  In the interface methods of our DSL for any actions with the database, we will transmit only specific values ‚Äã‚Äãof keys and bins, and all the transformations will be done by macros.  The main idea was to get rid of the boilerplate and to protect the user from a thorough study of the internal data structure of Aerospike itself.  We have previously described the most optimal storage option, based on the type of value transmitted for recording. </p><br><p>  Consider the example of one of the most common operations with Aerospike - adding a record and then reading it in a key.  We will use the <code>Put</code> method.  First we need the functions to convert values ‚Äã‚Äãof certain types into internal driver models: keys in <code>com.aerospike.client.Key</code> , and bins in <code>com.aerospike.client.Bin</code> . <br>  Let the key be <code>String</code> , and we will write bins of types <code>String, Int, Boolean</code> in various services. </p><br><p>  Write the key conversion function: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.aerospike.client.<span class="hljs-type"><span class="hljs-type">Key</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStringKey</span></span></span></span>(namespace: <span class="hljs-type"><span class="hljs-type">String</span></span>, setName: <span class="hljs-type"><span class="hljs-type">String</span></span>, value: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Key</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Key</span></span>(namespace, setName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringValue</span></span>(value))</code> </pre> <br><p>  and bins, respectively: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.aerospike.client.<span class="hljs-type"><span class="hljs-type">Value</span></span>.{<span class="hljs-type"><span class="hljs-type">IntegerValue</span></span>, <span class="hljs-type"><span class="hljs-type">StringValue</span></span>, <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span>} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createStringBin</span></span></span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>, value: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Bin</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(name, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringValue</span></span>(value)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createIntBin</span></span></span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>, value: <span class="hljs-type"><span class="hljs-type">Int</span></span>): <span class="hljs-type"><span class="hljs-type">Bin</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(name, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span>(value)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBooleanBin</span></span></span></span>(name: <span class="hljs-type"><span class="hljs-type">String</span></span>, value: <span class="hljs-type"><span class="hljs-type">Boolean</span></span>): <span class="hljs-type"><span class="hljs-type">Bin</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(name, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span>(value))</code> </pre> <br><p>  The signature of the method we need in the library in java (several options, we take with the least number of parameters): </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WritePolicy policy, Key key, Bin... bins)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AerospikeException</span></span>;</code> </pre> <br><p>  This means that calls using this library will look like this: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.aerospike.client.policy.<span class="hljs-type"><span class="hljs-type">WritePolicy</span></span> client.put(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">WritePolicy</span></span>, createStringKey(<span class="hljs-string"><span class="hljs-string">"namespace"</span></span>, <span class="hljs-string"><span class="hljs-string">"setName"</span></span>, <span class="hljs-string"><span class="hljs-string">"keyValue1"</span></span>), <span class="hljs-type"><span class="hljs-type">Seq</span></span>(createStringBin(<span class="hljs-string"><span class="hljs-string">"binName1"</span></span>, <span class="hljs-string"><span class="hljs-string">"binValue1"</span></span>), createStringBin(<span class="hljs-string"><span class="hljs-string">"binName2"</span></span>, <span class="hljs-string"><span class="hljs-string">"binValue2"</span></span>)): _*) client.put(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">WritePolicy</span></span>, createStringKey(<span class="hljs-string"><span class="hljs-string">"namespace"</span></span>, <span class="hljs-string"><span class="hljs-string">"setName"</span></span>, <span class="hljs-string"><span class="hljs-string">"keyValue2"</span></span>), <span class="hljs-type"><span class="hljs-type">Seq</span></span>(createIntBin(<span class="hljs-string"><span class="hljs-string">"binName1"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>), createIntBin(<span class="hljs-string"><span class="hljs-string">"binName2"</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>)): _*) client.put(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">WritePolicy</span></span>, createStringKey(<span class="hljs-string"><span class="hljs-string">"namespace"</span></span>, <span class="hljs-string"><span class="hljs-string">"setName"</span></span>, <span class="hljs-string"><span class="hljs-string">"keyValue3"</span></span>), <span class="hljs-type"><span class="hljs-type">Seq</span></span>(createBooleanBin(<span class="hljs-string"><span class="hljs-string">"binName1"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>), createBooleanBin(<span class="hljs-string"><span class="hljs-string">"binName2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>)): _*)</code> </pre> <br><p>  Not too cute, right?  Let's try to simplify: </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createKey</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](ns: <span class="hljs-type"><span class="hljs-type">String</span></span>, sn: <span class="hljs-type"><span class="hljs-type">String</span></span>, value: <span class="hljs-type"><span class="hljs-type">T</span></span>): <span class="hljs-type"><span class="hljs-type">Key</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> key = value <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s: <span class="hljs-type"><span class="hljs-type">String</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringValue</span></span>(s) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> i: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span>(i) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">Boolean</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"Not implemented"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Key</span></span>(ns, sn, key) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBin</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](name: <span class="hljs-type"><span class="hljs-type">String</span></span>, value: <span class="hljs-type"><span class="hljs-type">T</span></span>): <span class="hljs-type"><span class="hljs-type">Bin</span></span> = { value <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s: <span class="hljs-type"><span class="hljs-type">String</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(name, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringValue</span></span>(s)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> i: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(name, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span>(i)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">Boolean</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(name, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span>(b)) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"Not implemented"</span></span>) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putValues</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">K</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>](client: <span class="hljs-type"><span class="hljs-type">AsyncClient</span></span>, namespace: <span class="hljs-type"><span class="hljs-type">String</span></span>, setName: <span class="hljs-type"><span class="hljs-type">String</span></span>, keyValue: <span class="hljs-type"><span class="hljs-type">K</span></span>, bins: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[(<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>)])(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> wPolicy: <span class="hljs-type"><span class="hljs-type">WritePolicy</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { client.put(wPolicy, createKey(namespace, setName, keyValue), bins.map(b =&gt; createBin(b._1, b._2)): _*) }</code> </pre> <br><p>  Now we need to get rid of the functions <code>createKey</code> and <code>createBin</code> , we add <del>  of magic </del>  implies. </p><br><p>  We need utility objects that, based on the types of input data, generate the appropriate models of the driver used: </p><br><pre> <code class="scala hljs"><span class="hljs-type"><span class="hljs-type">KeyWrapper</span></span>: [<span class="hljs-type"><span class="hljs-type">K</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">Key</span></span>] <span class="hljs-type"><span class="hljs-type">BinWrapper</span></span>: [<span class="hljs-type"><span class="hljs-type">B</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">Bin</span></span>]</code> </pre> <br><p>  Now you can collect all the logic in one method: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SingleBin</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">B</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">B</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">putValues</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">B</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">client: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">AsyncClient</span></span></span></span><span class="hljs-class"><span class="hljs-params">, key: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">K</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SingleBin</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">B</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">)(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit kC: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">KeyWrapper</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">K</span></span></span></span><span class="hljs-class"><span class="hljs-params">], bC: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">BinWrapper</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">B</span></span></span></span><span class="hljs-class"><span class="hljs-params">], wPolicy: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">WritePolicy</span></span></span></span></span><span class="hljs-class">)</span></span>: <span class="hljs-type"><span class="hljs-type">Unit</span></span> = client.put(wPolicy, kC(key), bC(value))</code> </pre> <br><p>  where <code>WritePolicy</code> is a container object containing various write parameters.  We will use the default one, creating it so <code>new WritePolicy</code> . </p><br><p>  Obviously, the most commonplace option would be to describe the creation of wrappers of all types.  But why do this when we know exactly how each of the instances will be created?  This is where macros come in handy. </p><br><p>  The simplest option is to describe the creation of one or another type of converter using <a href="http://docs.scala-lang.org/overviews/quasiquotes/intro.html">quasi quotes</a> .  Let's start with the keys: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KeyWrapper</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">KT</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> namespace: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> setName: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span></span>(k: <span class="hljs-type"><span class="hljs-type">KT</span></span>): <span class="hljs-type"><span class="hljs-type">Key</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toValue</span></span></span></span>(v: <span class="hljs-type"><span class="hljs-type">KT</span></span>): <span class="hljs-type"><span class="hljs-type">Value</span></span> = v <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">String</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">Boolean</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"not implemented"</span></span>) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KeyWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">materialize</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> dbc: <span class="hljs-type"><span class="hljs-type">DBCredentials</span></span>): <span class="hljs-type"><span class="hljs-type">KeyWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>] = macro impl[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">impl</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>: c.<span class="hljs-type"><span class="hljs-type">WeakTypeTag</span></span>](c: <span class="hljs-type"><span class="hljs-type">Context</span></span>)(dbc: c.<span class="hljs-type"><span class="hljs-type">Expr</span></span>[<span class="hljs-type"><span class="hljs-type">DBCredentials</span></span>]): c.<span class="hljs-type"><span class="hljs-type">Expr</span></span>[<span class="hljs-type"><span class="hljs-type">KeyWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]] = { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> c.universe._ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tpe = weakTypeOf[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> ns = reify(dbc.splice.namespace) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sn = reify(dbc.splice.setname) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> imports = <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">" import com.aerospike.client.{Key, Value} import collection.JavaConversions._ import com.aerospike.client.Value._ import scala.collection.immutable.Seq import ru.tinkoff.aerospikescala.domain.ByteSegment import scala.util.{Failure, Success, Try} "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> c.<span class="hljs-type"><span class="hljs-type">Expr</span></span>[<span class="hljs-type"><span class="hljs-type">KeyWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]] { <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">" $imports new KeyWrapper[$tpe] { override val namespace = $ns override val setName = $sn def apply(k: $tpe): Key = new Key(namespace, setName, toValue(k)) } "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> } } }</code> </pre> <br><p>  where <code>DBCredentials</code> contains the namespace and setName. </p><br><p>  Thus, we can describe the method for the service, during compilation of which the converters will be generated independently. </p><br><p><img src="https://habrastorage.org/files/fc8/df3/0eb/fc8df30eba7340d08b65b81728bdd79b.gif" alt="N |  Solid"></p><br><p>  With bins, our situation is somewhat more complicated.  You must get the values ‚Äã‚Äãstored in the database, previously converted to the internal format Aerospike.  To do this, we use the simplest of the driver methods: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Record </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Policy policy, Key key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> AerospikeException</span></span>;</code> </pre> <br><p>  where the return value is: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Record</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Map&lt;String,Object&gt; bins, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> generation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expiration )</span></span></span></span></code> </pre> <br><p>  and the data we need is in <code>Map&lt;String,Object&gt; bins</code> .  There is a problem here (see the correspondence table).  Since our goal is to generate converters at the compilation stage and provide the output of a type that is identical to the one written earlier, we need to predict how to describe the function that gets the value we need from the database.  Among other things, the types that we get in <code>bins</code> from the <code>java.util</code> package means that we will need converters from the corresponding <code>scala.collection</code> packages. <br>  Now we will write a bins converter: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BinWrapper</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BT</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.aerospike.client.<span class="hljs-type"><span class="hljs-type">Value</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.aerospike.client.{<span class="hljs-type"><span class="hljs-type">Bin</span></span>, <span class="hljs-type"><span class="hljs-type">Record</span></span>, <span class="hljs-type"><span class="hljs-type">Value</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.collection.<span class="hljs-type"><span class="hljs-type">JavaConversions</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.collection.immutable.<span class="hljs-type"><span class="hljs-type">Map</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.reflect.runtime.universe._ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Singleton</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">SingleBin</span></span>[<span class="hljs-type"><span class="hljs-type">BT</span></span>] <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Out</span></span></span><span class="hljs-class"> </span></span>= (<span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">BT</span></span>]], <span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span></span>(one: <span class="hljs-type"><span class="hljs-type">Singleton</span></span>): <span class="hljs-type"><span class="hljs-type">Bin</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (one.name.length &gt; <span class="hljs-number"><span class="hljs-number">14</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IllegalArgumentException</span></span>(<span class="hljs-string"><span class="hljs-string">"Current limit for bean name is 14 characters"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Bin</span></span>(one.name, toValue(one.value)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toValue</span></span></span></span>(v: <span class="hljs-type"><span class="hljs-type">BT</span></span>): <span class="hljs-type"><span class="hljs-type">Value</span></span> = v <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">IntegerValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">String</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">StringValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> b: <span class="hljs-type"><span class="hljs-type">Boolean</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">BooleanValue</span></span>(b) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"not implemented"</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span></span>(r: <span class="hljs-type"><span class="hljs-type">Record</span></span>): <span class="hljs-type"><span class="hljs-type">Out</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> outValue: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">BT</span></span>]] = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jMap = r.bins.view collect { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (name, bt: <span class="hljs-type"><span class="hljs-type">Any</span></span>) =&gt; name -&gt; fetch(bt) } jMap.toMap } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outValue.values.isEmpty &amp;&amp; r.bins.nonEmpty) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">ClassCastException</span></span>( <span class="hljs-string"><span class="hljs-string">s"Failed to cast </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${weakTypeOf[BT]}</span></span></span><span class="hljs-string">. Please, implement fetch function in BinWrapper"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> (outValue, r.generation, r.expiration) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span></span>(any: <span class="hljs-type"><span class="hljs-type">Any</span></span>): <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">BT</span></span>] }</code> </pre> <br><p>  The <code>apply</code> method takes as a parameter <code>Record</code> - here you can summarize everything up to the moment of parsing the type of the value itself.  The implementation of this method is easier to write in macros: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BinWrapper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">materialize</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]: <span class="hljs-type"><span class="hljs-type">BinWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>] = macro materializeImpl[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">materializeImpl</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>: c.<span class="hljs-type"><span class="hljs-type">WeakTypeTag</span></span>](c: blackbox.<span class="hljs-type"><span class="hljs-type">Context</span></span>): c.<span class="hljs-type"><span class="hljs-type">Expr</span></span>[<span class="hljs-type"><span class="hljs-type">BinWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]] = { <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> c.universe._ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tpe = weakTypeOf[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> singleton = weakTypeOf[<span class="hljs-type"><span class="hljs-type">SingleBin</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]] <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> out = weakTypeOf[(<span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]], <span class="hljs-type"><span class="hljs-type">Int</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> tpeSt = <span class="hljs-string"><span class="hljs-string">q"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${tpe.toString}</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fetchValue = tpe <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> t =:= weakTypeOf[<span class="hljs-type"><span class="hljs-type">String</span></span>] =&gt; <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">"override def fetch(any: Any): Option[$tpe] = any match { case v: String =&gt; Option(v) case oth =&gt; scala.util.Try(oth.toString).toOption } "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> t =:= weakTypeOf[<span class="hljs-type"><span class="hljs-type">Boolean</span></span>] =&gt; <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">"override def fetch(any: Any): Option[$tpe] = any match { case v: java.lang.Long =&gt; Option(v == 1) case _ =&gt; None } "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> t =:= weakTypeOf[<span class="hljs-type"><span class="hljs-type">Int</span></span>] =&gt; <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">"override def fetch(any: Any): Option[$tpe] = any match { case v: java.lang.Long =&gt; Option(v.toInt) case oth =&gt; scala.util.Try(oth.toString.toInt).toOption } "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> t.toString.contains(<span class="hljs-string"><span class="hljs-string">"HNil"</span></span>) || t.toString.contains(<span class="hljs-string"><span class="hljs-string">"HList"</span></span>) =&gt; <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">"override def fetch(any: Any): Option[$tpe] = any match { case m: java.util.HashMap[Any, Any] =&gt; val newList = castHListElements(m.asScala.values.toList, $tpeSt) newList.toHList[$tpe] case oth =&gt; None } "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> _ =&gt; <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> imports = <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">" import java.util.{List =&gt; JList, Map =&gt; JMap} import com.aerospike.client.{Bin, Record, Value} import com.aerospike.client.Value.{BlobValue, ListValue, MapValue, ValueArray} import scala.collection.JavaConversions._ import scala.collection.JavaConverters._ import shapeless.{HList, _} import shapeless.HList.hlistOps import syntax.std.traversable._ .... "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> c.<span class="hljs-type"><span class="hljs-type">Expr</span></span>[<span class="hljs-type"><span class="hljs-type">BinWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]] { <span class="hljs-string"><span class="hljs-string">q""</span></span><span class="hljs-string"><span class="hljs-string">" $imports new BinWrapper[$tpe] { override def apply(one: $singleton): Bin = { if (one.name.length &gt; 14) throw new IllegalArgumentException("</span></span><span class="hljs-type"><span class="hljs-type">Current</span></span> limit <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> bean name is <span class="hljs-number"><span class="hljs-number">14</span></span> <span class="hljs-string"><span class="hljs-string">characters") else new Bin(one.name, toValue(one.value)) } override def apply(r: Record): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$out</span></span></span><span class="hljs-string"> = { val outValue: Map[String, Option[</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$tpe</span></span></span><span class="hljs-string">]] = { val jMap = r.bins.view collect { case (name, bt: Any) =&gt; val res = fetch(bt) if (res.isEmpty &amp;&amp; r.bins.nonEmpty) throwClassCast(</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$tpeSt</span></span></span><span class="hljs-string">) else name -&gt; res } jMap.toMap } (outValue, r.generation, r.expiration) } </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$fetchValue</span></span></span><span class="hljs-string"> } "</span></span><span class="hljs-string"><span class="hljs-string">""</span></span> } } }</code> </pre> <br><p>  The macros have done all the work for us - the instances of all the required converters will be generated independently, the method calls will contain only the keys and bins values ‚Äã‚Äãthemselves. </p><br><p><img src="https://habrastorage.org/files/b40/f8b/40a/b40f8b40adc84b0299ebe033fed87236.gif" alt="N |  Solid"></p><br><p>  <code>Quasiquotes</code> easy to work with: predictable behavior, no pitfalls.  It is important to remember that when using this approach, all libraries that are needed in the methods described in <code>Quasiquotes</code> should be imported into the file where the macro is used.  Therefore, I immediately added the <code>imports</code> parameter in both converters in order not to copy the set of libraries in each file. </p><br><p>  Now we have everything to write a service wrapper: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpikeImpl</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">client: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">IAsyncClient</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">putValue</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">K</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>](key: <span class="hljs-type"><span class="hljs-type">K</span></span>, value: <span class="hljs-type"><span class="hljs-type">SingleBin</span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span>])(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> kC: <span class="hljs-type"><span class="hljs-type">KeyWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">K</span></span>], bC: <span class="hljs-type"><span class="hljs-type">BinWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span>]): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> wPolicy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">WritePolicy</span></span> client.put(wPolicy, kC(key), bC(value)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getByKey</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">K</span></span>, <span class="hljs-type"><span class="hljs-type">B</span></span>](k: <span class="hljs-type"><span class="hljs-type">K</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> kC: <span class="hljs-type"><span class="hljs-type">KeyWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">K</span></span>], bC: <span class="hljs-type"><span class="hljs-type">BinWrapper</span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span>]): <span class="hljs-type"><span class="hljs-type">Option</span></span>[<span class="hljs-type"><span class="hljs-type">B</span></span>] = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> policy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Policy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> record = client.get(policy, kC(k)) bC.apply(record)._1.headOption.flatMap(_._2) } }</code> </pre> <br><p>  Now you can check the work of our service: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> shapeless.{<span class="hljs-type"><span class="hljs-type">HList</span></span>, _} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> shapeless.<span class="hljs-type"><span class="hljs-type">HList</span></span>.hlistOps <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.reflect.macros.blackbox._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.language.experimental.macros <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloAerospike</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AsyncClient</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AsyncClientPolicy</span></span>, hosts.map(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Host</span></span>(_, port)): _*) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> database = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SpikeImpl</span></span>(client) <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dbc = <span class="hljs-type"><span class="hljs-type">DBCredentials</span></span>(<span class="hljs-string"><span class="hljs-string">"namespace"</span></span>, <span class="hljs-string"><span class="hljs-string">"setName"</span></span>) database.putValue(<span class="hljs-string"><span class="hljs-string">"key"</span></span>, <span class="hljs-type"><span class="hljs-type">SingleBin</span></span>(<span class="hljs-string"><span class="hljs-string">"binName"</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span> :: <span class="hljs-string"><span class="hljs-string">"strValue"</span></span> :: <span class="hljs-literal"><span class="hljs-literal">true</span></span> :: <span class="hljs-type"><span class="hljs-type">HNil</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> hlistBin = database.getByKey[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span> :: <span class="hljs-type"><span class="hljs-type">String</span></span> :: <span class="hljs-type"><span class="hljs-type">Boolean</span></span> :: <span class="hljs-type"><span class="hljs-type">HNil</span></span>](<span class="hljs-string"><span class="hljs-string">"key"</span></span>) .getOrElse(<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Exception</span></span>(<span class="hljs-string"><span class="hljs-string">"Failed to get bin value"</span></span>)) println(<span class="hljs-string"><span class="hljs-string">"hlistBin value = "</span></span> + hlistBin) }</code> </pre> <br><p>  Run and go to the database: </p><br><pre> <code class="hljs ruby">Mac-mini-administrator-<span class="hljs-number"><span class="hljs-number">5</span></span><span class="hljs-symbol"><span class="hljs-symbol">:~</span></span> MarinaSigaeva$ ssh user@host user@host<span class="hljs-string"><span class="hljs-string">'s password: Last login: Wed Nov 23 19:41:56 2016 from 1.1.1.1 [user@host ~]$ aql Aerospike Query Client Version 3.9.1.2 Copyright 2012-2016 Aerospike. All rights reserved. aql&gt; select * from namespace.setName +------------------------------------------+ | binName | +------------------------------------------+ | MAP('</span></span>{<span class="hljs-string"><span class="hljs-string">"0"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"strValue"</span></span></span></span>, <span class="hljs-string"><span class="hljs-string">"2"</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">1</span></span>}<span class="hljs-string"><span class="hljs-string">') | +------------------------------------------+ 1 row in set (0.049 secs) aql&gt;</span></span></code> </pre> <br><p>  Data recorded.  Now let's see what the application brought to the console: </p><br><pre> <code class="scala hljs">[info] <span class="hljs-type"><span class="hljs-type">Compiling</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Scala</span></span> source to /<span class="hljs-type"><span class="hljs-type">Users</span></span>/<span class="hljs-type"><span class="hljs-type">Marina</span></span>/<span class="hljs-type"><span class="hljs-type">Desktop</span></span>/forks/playground/target/scala<span class="hljs-number"><span class="hljs-number">-2.11</span></span>/classes... [info] <span class="hljs-type"><span class="hljs-type">Running</span></span> <span class="hljs-type"><span class="hljs-type">HelloAerospike</span></span> hlistBin value = <span class="hljs-number"><span class="hljs-number">123</span></span> :: strValue :: <span class="hljs-literal"><span class="hljs-literal">true</span></span> :: <span class="hljs-type"><span class="hljs-type">HNil</span></span> [success] <span class="hljs-type"><span class="hljs-type">Total</span></span> time: <span class="hljs-number"><span class="hljs-number">0</span></span> s, completed <span class="hljs-number"><span class="hljs-number">23.11</span></span><span class="hljs-number"><span class="hljs-number">.2016</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span></code> </pre> <br><p>  For scala developers, the solution may be more intuitive than the java library.  The code of the current DSL is laid out on <a href="https://github.com/TinkoffCreditSystems/aerospike-scala">Github</a> with a detailed description of <a href="">how to</a> and a <a href="https://github.com/TinkoffCreditSystems/aerospike-scala/tree/master/cookbook">book</a> , which will be supplemented.  In light of recent events ( <a href="https://www.lightbend.com/blog/scala-2-12-released">scala 2.12 released</a> ), a challenge has emerged for interesting experiments with <a href="http://scalameta.org/">scala-meta</a> .  I hope this experience will be useful to you in solving such problems. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/317742/">https://habr.com/ru/post/317742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317730/index.html">How IT professionals work. Maxim Zelinsky, Sberbank-Technology</a></li>
<li><a href="../317732/index.html">Chatbot on the basis of a recurrent neural network do-it-yourself for 1 evening / $ 6 and ~ 100 lines of code</a></li>
<li><a href="../317736/index.html">New promising sites for HTML5 games</a></li>
<li><a href="../317738/index.html">Development for Sailfish OS: working with notifications on the example of a note taking application</a></li>
<li><a href="../317740/index.html">On the MegaFon Card - technical details</a></li>
<li><a href="../317744/index.html">How to make a successful holiday mailing</a></li>
<li><a href="../317746/index.html">RTCP as a telephony admin tool</a></li>
<li><a href="../317748/index.html">13 promising programming languages</a></li>
<li><a href="../317750/index.html">Giant component: hooks for fishing, galaxy clusters, molecular biotechnology, nanomaterials</a></li>
<li><a href="../317752/index.html">We monitor the freelance site in slack</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>