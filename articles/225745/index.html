<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Python, tone shift and Pianoputer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: 

 The article, which I suggest you read, is not new - it was published as early as March 29. But on Reddit, she posted it just a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Python, tone shift and Pianoputer</h1><div class="post__text post__text-html js-mediator-article">  From the translator: <br><br>  The article, which I suggest you read, is not new - it was published as early as March 29.  But on Reddit, she posted it just a few days ago, and she definitely didn‚Äôt lose her actuality.  Its interestingness is that the author demonstrates the practical use of three large and popular libraries in a simple and short example: numpy, scipy and pygame.  Many have heard about the first two, but more and more in the context of scientific works, so it is interesting to look at their use in ‚Äúordinary‚Äù life.  At the end of the article there is an excellent video demonstration of the result, at least it is definitely worth seeing. <br><br>  The author's code was kept unchanged, despite the fact that it was not designed according to PEP-8 and I cannot vouch for its validity.  One way or another, this working code is on the GitHub; you will find the link at the end of the article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>Record the sound, change the tone 50 times and match each new sound with a key on the computer keyboard.</i>  <i>It turns out Pianoputer!</i> <br><br><a name="habracut"></a><br><br>  The sound can be encoded as an array (or list, <i>list</i> ) of values, like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ab/672/698/1ab672698be5b500d744996c69f6004a.png"><br><br>  To play this sound twice as fast, delete every second value in the array: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/308/899/32a/30889932ae1f54b35caa5623a90494f3.png"><br><br>  Having done this, we not only halved the duration of the sound, but doubled its frequency, therefore its tone became higher. <br><br>  On the contrary, if you repeat each value, you get a slower sound, with a longer period, and therefore lower tone: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d0/c1d/1cc/4d0c1d1ccfb8799f4ba7a32aaad46516.png"><br><br>  Here is a simple Python function that changes the speed of sound according to the transmitted coefficient: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">speedx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sound_array, factor)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Multiplies the sound's speed by some `factor` """</span></span> indices = np.round( np.arange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(snd_array), factor) ) indices = indices[indices &lt; len(snd_array)].astype(int) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sound_array[ indices.astype(int) ]</code> </pre> <br><br>  It is more difficult to change the duration, while maintaining the tone (stretching the sound), or to change the tone, saving the duration (tone shift). <br><br><h4>  Stretching sound </h4><br><br>  You can stretch the sound using the classic <i>phase vocoder</i> method.  We first break the sound into intersecting pieces, and then move them so that they intersect more (to reduce the sound) or less (to stretch it), as in the picture: <br><br><img src="//habrastorage.org/files/35b/d83/d56/35bd83d5602e48709eb8d952c2f77636.png"><br><br>  The difficulty here is that the moved pieces can interact poorly, and a certain phase transformation is needed to prevent this from happening.  Here is the code on Python, freely rewritten <a href="http://audioprograming.wordpress.com/2012/03/02/a-phase-vocoder-in-python/">from here</a> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stretch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(sound_array, f, window_size, h)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Stretches the sound by a factor `f` """</span></span> phase = np.zeros(window_size) hanning_window = np.hanning(window_size) result = np.zeros( len(sound_array) /f + window_size) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> np.arange(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(sound_array)-(window_size+h), h*f): <span class="hljs-comment"><span class="hljs-comment"># two potentially overlapping subarrays a1 = sound_array[i: i + window_size] a2 = sound_array[i + h: i + window_size + h] # resynchronize the second array on the first s1 = np.fft.fft(hanning_window * a1) s2 = np.fft.fft(hanning_window * a2) phase = (phase + np.angle(s2/s1)) % 2*np.pi a2_rephased = np.fft.ifft(np.abs(s2)*np.exp(1j*phase)) # add to result i2 = int(i/f) result[i2 : i2 + window_size] += hanning_window*a2_rephased result = ((2**(16-4)) * result/result.max()) # normalize (16bit) return result.astype('int16')</span></span></code> </pre> <br><br><h4>  Tone offset </h4><br><br>  After stretching the sound, the tone shift is made simple.  To get a higher tone, we stretch the sound, preserving the tone, and then speeding up the result so that the final sound has the same length as the original one, but a higher tone due to the change in speed. <br><br>  Doubling the frequency of the sound will increase the tone by one octave, or 12 semitones.  Thus, in order to raise the tones by <i>n</i> semitones, it is necessary to multiply the height by 2 ^ (n / 12): <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pitchshift</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(snd_array, n, window_size=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">**</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">13</span></span></span></span><span class="hljs-function"><span class="hljs-params">, h=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">**</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">11</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Changes the pitch of a sound by ``n`` semitones. """</span></span> factor = <span class="hljs-number"><span class="hljs-number">2</span></span>**(<span class="hljs-number"><span class="hljs-number">1.0</span></span> * n / <span class="hljs-number"><span class="hljs-number">12.0</span></span>) stretched = stretch(snd_array, <span class="hljs-number"><span class="hljs-number">1.0</span></span>/factor, window_size, h) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> speedx(stretched[window_size:], factor)</code> </pre> <br><br><h4>  Application: Pianoputer </h4><br><br>  Let's try our new toner blender.  To start knocking on the bowl: <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/oXm0CLp40ws%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253&amp;usg=ALkJrhjXZVi8208bujMxBAnnsfpabJvszg" frameborder="0" allowfullscreen=""></iframe><br><br>  Then create 50 derived sounds from very low to very high: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scipy.io <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> wavfile fps, bowl_sound = wavfile.read(<span class="hljs-string"><span class="hljs-string">"bowl.wav"</span></span>) tones = range(<span class="hljs-number"><span class="hljs-number">-25</span></span>,<span class="hljs-number"><span class="hljs-number">25</span></span>) transposed = [pitchshift(bowl_sound, n) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tones]</code> </pre> <br><br>  Assign a sound to each key on the keyboard, following the order specified in <a href="">this file</a> , like this: <br><br><img src="//habrastorage.org/files/f2e/9a3/ca0/f2e9a3ca063d4192975dfca694bf2a62.jpg"><br><br>  And here is the Python code that turns your computer into a piano (piano <i>computer</i> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pygame pygame.mixer.init(fps, <span class="hljs-number"><span class="hljs-number">-16</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">512</span></span>) <span class="hljs-comment"><span class="hljs-comment"># so flexible ;) screen = pygame.display.set_mode((640,480)) # for the focus # Get a list of the order of the keys of the keyboard in right order. # ``keys`` is like ['Q','W','E','R' ...] keys = open('typewriter.kb').read().split('\n') sounds = map(pygame.sndarray.make_sound, transposed) key_sound = dict( zip(keys, sounds) ) is_playing = {k: False for k in keys} while True: event = pygame.event.wait() if event.type in (pygame.KEYDOWN, pygame.KEYUP): key = pygame.key.name(event.key) if event.type == pygame.KEYDOWN: if (key in key_sound.keys()) and (not is_playing[key]): key_sound[key].play(fade_ms=50) is_playing[key] = True elif event.key == pygame.K_ESCAPE: pygame.quit() raise KeyboardInterrupt elif event.type == pygame.KEYUP and key in key_sound.keys(): key_sound[key].fadeout(50) # stops with 50ms fadeout is_playing[key] = False</span></span></code> </pre> <br><br>  That's all!  And now I‚Äôll play you a traditional Turkish song ( <i>actually, no. Appro. Lane</i> )! <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/z410eauCnHc%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253&amp;usg=ALkJrhimuRaUY6c3yapOy_9xsQoVy7Qb_Q" frameborder="0" allowfullscreen=""></iframe><br><br>  If you want to try the same thing at home, here are <a href="https://github.com/Zulko/pianoputer">all the files</a> you need.  I think it would be great if someone among the readers from HTML5 / JS / elm-developers created a browser version of Pianoputer, so it would be available to a wider audience. <br><br>  Speaking at all, it seems to me that computers are not sufficiently used for <i>playing</i> music.  I understand that it is easier to take a real piano keyboard or write a real instrument, but you only see what you can achieve with a regular bowl and 60 lines on Python! <br><br>  Even a cheap computer has enough controls to become a full-fledged music station: you can sing into a microphone, show gestures through a webcam, modulate all sorts of things with a mouse and control the rest from the keyboard.  So many means of expression, and for everyone there is a library on Python ... Artistic hackers, no one wants to step in this direction? </div><p>Source: <a href="https://habr.com/ru/post/225745/">https://habr.com/ru/post/225745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225727/index.html">Swift + CoreData + A bit of a file</a></li>
<li><a href="../225735/index.html">ZeptoLab and Codeforces join forces</a></li>
<li><a href="../225739/index.html">NASA Announces Mars Design Competition</a></li>
<li><a href="../225741/index.html">UK rewrites the rules of the road under the "robot"</a></li>
<li><a href="../225743/index.html">Qualifying round of the Russian Code Cup 2014: results and analysis of tasks</a></li>
<li><a href="../225749/index.html">Do I need support LaTeX on Habr√©?</a></li>
<li><a href="../225751/index.html">Creating audio plug-ins, part 4</a></li>
<li><a href="../225755/index.html">Creating audio plug-ins, part 5</a></li>
<li><a href="../225757/index.html">The controversy around high-frequency trading is gaining momentum again</a></li>
<li><a href="../225761/index.html">Creating a game in front of your eyes - part 6: Let's talk about PR indie games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>