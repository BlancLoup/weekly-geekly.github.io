<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Selective logging of SQL queries in Hibernate</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the beginning of last week I began working on a real project that manages audio content for the radio station. The usual admin panel using the VAAD...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Selective logging of SQL queries in Hibernate</h1><div class="post__text post__text-html js-mediator-article">  At the beginning of last week I began working on a real project that manages audio content for the radio station.  The usual admin panel using the VAADIN framework ( <a href="https://vaadin.com/home">https://vaadin.com/home</a> ) provides the user with a web interface that allows you to customize playlists and other features that simplify the life of DJs. <br><br>  The customer got the application by inheritance and he wanted to expand its functionality and fix the bugs that were identified during the operation of the system.  As for me, it is quite a normal and rational desire. <br><a name="habracut"></a><br><br>  One of my tasks was to fix a data sampling bug.  As it turned out, the application wrote records with empty values ‚Äã‚Äãto the database, and during the selection it was assumed that the data are non-empty.  The application uses the JPA implementation from Hibernate to work with the database.  Well, in principle, nothing surprising, because Hibernate is a fairly common framework.  I have been working with him for several years, but I am not a professional.  In addition, the database model and object Java model were not simple: using cyclic dependencies, inheritance, many-to-many relationships, etc.  In general, immediately looking at the model, I did not understand where to look for the cause of the error. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      There was a question about SQL logging in order to determine where the validator is passed. <br>  Use the <strong>hibernate.show_sql = true</strong> parameter I didn‚Äôt really like.  I saw two problems: <br><br>  1) Hibernate in System.out writes only SQL queries with question marks and without real parameters; <br>  2) Hibernate writes absolutely all database queries (As it turned out, on one page load, the application performed about 50 queries). <br><br>  Looking at the displayed queries, I realized that I need to display only queries to those tables that are associated with my task. <br><br>  Turning to google for help, I found advice on how to display the real parameters: when using Log4j, I need to add a logger for the parameters ( <a href="http://www.mkyong.com/hibernate/how-to-display-hibernate-sql-parameter-values-log4j/">link to the article</a> ): <br><br>  # Hibernate logging options (INFO only shows startup messages) <br>  log4j.logger.org.hibernate = INFO <br>  # Log JDBC bind Parameter runtime arguments <br>  log4j.logger.org.hibernate.type = trace <br><br>  After these gestures, I solved problem No. 1: query parameters were written to the log, but the logs became excessively large, I had to search for the query I needed for a few minutes.  I immediately realized that this would not work and then the idea was born when the application was running to turn on and off request logging. <br>  The current project uses EJB 3 components for working with a database. After reading about Interceptors, the idea arose to write it to turn on and off logging of SQL queries on the fly. <br><br>  The code is as follows: <br><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Interceptor public class ShowHibernateSQLInterceptor { //  @AroundInvoke public Object showSQL(InvocationContext ictx) throws Exception { //  SQL  Logger sqlLogger = Logger.getLogger("org.hibernate.SQL"); sqlLogger.setLevel(Level.DEBUG); //    Logger descLogger = Logger.getLogger("org.hibernate.type.descriptor.sql.BasicBinder"); descLogger.setLevel(Level.TRACE); //    Object res = ictx.proceed(); //  SQL sqlLogger = Logger.getLogger("org.hibernate.SQL"); sqlLogger.setLevel(Level.INFO); //   descLogger = Logger.getLogger("org.hibernate.type.descriptor.sql.BasicBinder"); descLogger.setLevel(Level.INFO); return res; } }</span></span></code> </pre> <br><br>  An example of using logging for the selected method from the service: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-meta"><span class="hljs-meta">@Interceptors</span></span>(ShowHibernateSQLInterceptor.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;AudioItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listAllAudioItems</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> em.createQuery(<span class="hljs-string"><span class="hljs-string">"select a from AudioItem a"</span></span>).getResultList(); }</code> </pre><br><br>  When the method is called, all SQL queries with parameters related to the selection of AudioItem entities from the database are written to the log. <br>  (If <strong>@Interceptors (ShowHibernateSQLInterceptor.class) is</strong> specified for the entire service class, and not for the selected method, then all methods of this class will be logged) <br>  Because  queries are output to the Hiberante log due to org.hibernate.SQL = DEBUG, the need for <br>  <strong>hibernate.show_sql = true has</strong> disappeared and I have disabled this feature. <br><br>  Total: <br>  For logging only certain methods it is recommended: <br>  1) disable <strong>hibernate.show_sql = true</strong> <br>  2) Write a class Interceptor <br>  3) Add an interceptor for the selected method. <br><br>  Limitations: <br>  1) Tested only with log4j - not sure if it will work with another logger, but I think that it is possible either to add Log4j to the project, or to correct the Interceptor for another logger-framework <br>  2) The proposed solution is relevant only for EJB 3, if the project uses Spring, then it is necessary to write an aspect (Spring AOP) with similar functionality. <br>  3) Tested on JBoss AS: this server uses its logger adapter for Log4j.  Therefore, it should work on another server, but there may be nuances ... <br><br>  Perhaps there are more elegant solutions for this problem, but a cursory review of Google search results did not allow me to find such ones, so I decided to spend 20 minutes and the problem was solved and, as a result, the task was completed on time. <br><br>  If someone knows a better solution, I‚Äôm ready to listen to it - because sometimes I need a tool to analyze Hibernate queries, which will help to quickly solve the problem. </div><p>Source: <a href="https://habr.com/ru/post/149001/">https://habr.com/ru/post/149001/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148990/index.html">What happens with Oracle?</a></li>
<li><a href="../148991/index.html">"Hola, apple gadgets!"</a></li>
<li><a href="../148993/index.html">In court for "Like"</a></li>
<li><a href="../148996/index.html">Creating a plugin for Intellij Platform (IntelliJ IDEA, RubyMine, WebStorm, PhpStorm, PyCharm and AppCode)</a></li>
<li><a href="../148999/index.html">Does your site also allow you to upload everything?</a></li>
<li><a href="../149004/index.html">Hot summer build Opera 12.50</a></li>
<li><a href="../149006/index.html">We do it yourself Single-Side Arduino with a COM port on board</a></li>
<li><a href="../149007/index.html">Destructive printers for the healthcare modernization program</a></li>
<li><a href="../149010/index.html">Masking numeric values ‚Äã‚Äãusing autoNumeric and Knockout</a></li>
<li><a href="../149012/index.html">Labeled pointers, or how to fit an object in one inte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>