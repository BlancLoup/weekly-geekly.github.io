<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Instructions for forwarding ports on Juniper SRX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With this article I plan to open a series of manuals for the Juniper SRX series. If it will be useful to someone, I will be very happy. And do not hes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Instructions for forwarding ports on Juniper SRX</h1><div class="post__text post__text-html js-mediator-article">  With this article I plan to open a series of manuals for the Juniper SRX series.  If it will be useful to someone, I will be very happy.  And do not hesitate to ask questions. <br><br>  I will note that everything written below will most likely be suitable for any other model of Juniper routers (due to their slogan ‚ÄúOne Junos‚Äù, that is, one operating system for all hardware).  This article is based on the official English manual for setting up NAT, taken from here: <a href="http://www.juniper.net/us/en/local/pdf/app-notes/3500151-en.pdf">www.juniper.net/us/en/local/pdf/app-notes/3500151-en.pdf</a> . <br><br>  So, port forwarding.  Or scientifically, destination NAT.  Here it is necessary to make one small note.  Some admins are accustomed under the word NAT to understand the source NAT, with all the consequences.  And not even the source NAT, but one of its varieties - PAT.  But we must understand the differences between different types of nat.  Here I will not go into the theory, everything is written quite clearly on Wikipedia.  I want to make only one explanation: NAT is just a substitution of addresses, nothing more.  If you understand the essence of this technology differently, you are wrong.  This technology does not do anything more than replace one address in the header of an IP packet with another.  And there is nothing initially terrible and terrible in it.  Accordingly, if we are talking about destination NAT, then we are talking about the substitution of the destination address.  Consider an example: <br><a name="habracut"></a><br><img src="https://habrastorage.org/storage2/21c/78c/661/21c78c661ed1db7c57698dc2e9cebc87.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Suppose we have an internal service (web server, address 10.1.1.100), which we want to make accessible from the outside to our external address (1.2.3.4 port 80).  We write: <br><blockquote><code>root@jsrx# edit security nat destination</code> </blockquote>  This way we got into the destination NAT configuration section.  First you need to create an address entry (pool) of our web server. <br><blockquote> <code>root@jsrx# set pool web-server address 10.1.1.100 port 80</code> </blockquote>  Next, create a rule-set, i.e.  Code of Destination Nata: <br><blockquote> <code>root@jsrx# set rule-set DNAT from zone untrust</code> </blockquote>  Thereby we say that this set of rules works for packages that come from the untrust zone, i.e.  in our case from the Internet.  In this example, everything is fine, but sometimes it may be necessary to specify which particular interface the packets for this set of rules should come from.  In this case, the phrase <code>from zone untrust</code> should be replaced with <code>from interface ge-0/0/0</code> (as in our example).  You can also specify the source of the <code>routing-instance</code> packet packets, but this is a more rare case, we will not think about it. <br>  This rule-set must be filled with the necessary rules: <br><blockquote> <code>root@jsrx# set rule-set DNAT rule dnat_for_web match destination-address 1.2.3.4</code> <br> <code>root@jsrx# set rule-set DNAT rule dnat_for_web match destination-port 80</code> <br> <code>root@jsrx# set rule-set DNAT rule dnat_for_web then destination-nat pool web-server</code> </blockquote>  In the first line, we indicate our external IP-address to which clients will knock.  In the second line, we specify the external port, and in the third - the actual pool itself, which we described at the beginning. <br>  If everything is left as it is, then nothing will work.  Because you need to create an access policy to our web server: <br><blockquote> <code>root@jsrx# top edit security address-book global</code> <br> <code>root@jsrx# set address web_server 10.1.1.100</code> <br> <code>root@jsrx# top edit security policies from-zone untrust to-zone trust</code> <br> <code>root@jsrx# set policy web_access match source-address any</code> <br> <code>root@jsrx# set policy web_access match destination-address web_server</code> <br> <code>root@jsrx# set policy web_access match application any</code> <br> <code>root@jsrx# set policy web_access then permit</code> </blockquote>  Do <blockquote> <code>root@jsrx# commit check</code> </blockquote>  then if everything went ok <blockquote> <code>root@jsrx# commit</code> </blockquote>  This completes the destination NAT'a, everything is quite simple.  The final config is shown below: <br><blockquote><pre>  root @ jsrx # show security nat destination
 pool web-server {
     address 10.1.1.100/32 port 80;
 }
 rule-set DNAT {
     from zone untrust;
     rule dnat_for_web {
         match {
             destination-address 1.2.3.4/32;
             destination-port 80;
         }
         then {
             destination-nat pool web-server;
         }
     }
 }
 root @ jsrx # show security address-book global
 address web_server 10.1.1.100/32;

 root @ jsrx # show security policies from-zone to-zone trust
 policy web_access {
     match {
         source-address any;
         destination-address web_server;
         application any;
     }
     then {
         permit;
     }
 }
</pre></blockquote><br><br>  Several valuable additions. <br>  1. For <u>each</u> port to be forwarded, you must write these rules (policies need to be written only for new servers being added).  <u>Unable to</u> forward a range of ports with one command.  A pity, sometimes you want. <br>  If you desperately need to forward dofig and more ports, it may be worth looking in the direction of Static NAT. <br>  2. Rules names should not be repeated within the entire NAT configuration.  If you start repeating, then commit check will curse the names of the rules. <br>  3. Names of rules, rulebooks, pools, etc.  You can write any at your discretion.  In my case, these are DNAT, web server, dnat_for_web, etc. <br>  4. You can view the counting of forwarding trips from the operating mode using the command: <br><blockquote> <code>root@jsrx&gt; show security nat destination rule _</code> </blockquote>  The Translation hits line will show the number of times the triggering has been activated.  Very handy diagnostic tool Nata.  Such a moment: destination NAT'a rules are processed BEFORE checking for compliance with policies.  Therefore, if you see by the meter that forwarding is triggered, but there is no access, it is worth checking the policies.  Most likely, you just forgot to add something there. <br>  5. If you are confused by the string <code>match application any</code> in the policy config, then you are right.  In an amicable way, for security reasons, it is necessary to enter the name of a specific application (that is, the port) that will be used by external clients. You can write <code>match application junos-http</code> for the web server.  I will write more about applications in Junos OS later. <br><br>  As you can see, the procedure for creating a callback is pretty simple, but it also has its own nuances.  Thank you all for your attention, I will be very happy with any questions. </div><p>Source: <a href="https://habr.com/ru/post/166637/">https://habr.com/ru/post/166637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../166625/index.html">Excel for Windows 2.x in Russian</a></li>
<li><a href="../166627/index.html">We put into practice the knowledge gained in the course An course to Interactive Programming in Python (coursera.org)</a></li>
<li><a href="../166629/index.html">Interview with developers of Windows 8 and Windows Phone applications</a></li>
<li><a href="../166631/index.html">Zend Framework: XSL and Self Serialization Views</a></li>
<li><a href="../166633/index.html">Performance Comparison: curl, php curl, php socket, python pycurl</a></li>
<li><a href="../166639/index.html">Automatic configuration of virtual machines in the clouds using metadata</a></li>
<li><a href="../166641/index.html">Store ID in Cookie</a></li>
<li><a href="../166643/index.html">[Translation] What happened when Facebook blocked my account</a></li>
<li><a href="../166645/index.html">Small useful things. How to make access from nagios / icinga to the host management interface through Google Chrome and MS IE browsers</a></li>
<li><a href="../166647/index.html">Adding your functionality to UMI.CMS using event handlers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>