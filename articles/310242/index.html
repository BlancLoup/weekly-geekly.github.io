<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shaper for Linux in user space (NFQUEUE-based)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The times of narrow Internet channels are gradually becoming a thing of the past, but sometimes it is also necessary to shape network traffic. In Linu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shaper for Linux in user space (NFQUEUE-based)</h1><div class="post__text post__text-html js-mediator-article">  The times of narrow Internet channels are gradually becoming a thing of the past, but sometimes it is also necessary to shape network traffic.  In Linux, there are corresponding kernel mechanisms and utilities for controlling mechanisms for this.  All this economy is quite complicated, usually the comprehension of shaping takes more than one day.  Although, in simple cases, you can accumulate tc spells from articles or find the script that generates these spells. <br><br>  As an inquisitive person, it was always interesting, is it possible to make the process of setting up shaping for smaller networks easier?  Is it possible to at least roughly detect the <i>important</i> traffic and separate it from the <i>unimportant</i> without DPI and signature analysis?  Is it possible to shape traffic in any direction without creating pseudo-interfaces or adding modules to the kernel?  And so, after some thinking and googling, I decided to write a simple shaper in userspace.  To try to answer questions by experiment. <br><a name="habracut"></a><br>  As a result of the experiment, such a thing turned out to be <a href="https://github.com/vmxdev/damper/">github.com/vmxdev/damper</a> <br><br>  It works like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At startup, two program threads are created.  The first NFQUEUE captures packets, they are analyzed, each packet is assigned a ‚Äúweight‚Äù (or priority) and it is stored in a priority queue.  When the queue is full, low priority packets are overwritten by high priority ones.  Another thread selects the packets with the highest weight and marks them for shipment.  Sending takes place at a limited speed, because of this, the actual shaping is obtained. <br><br><h3>  A small digression about the mechanism NFQUEUE </h3><br>  This mechanism allows you to copy network packets into user space for processing.  An application that listens to the appropriate queue must render a verdict regarding the packet (skip or discard).  In addition, it is possible to change the package.  This mechanism is used by IDS / IPS type Snort or Suricata.  Packages are marked for processing in iptables, the goal of NFQUEUE.  That is, we can choose any direction (incoming traffic, outgoing, transit, or, say, UDP from port 666 to port 13) and send it to the shaper.  There the packets will be analyzed, it is possible to change their order, and when the limit is exceeded, the lowest priority ones will be discarded. <br><br>  The first working versions of the shaper captured packets, placed them in a queue, and then re-injected them into a raw socket.  On StackOverflow and some other articles they write that this is the only way to delay packets before re-sending.  The construction worked, but Comrade <a href="https://www.linux.org.ru/people/vel/profile">Vel</a> explained where the package could be retained right in NFQUEUE, the shaper's setup was simplified. <br><br><h3>  Modules </h3><br>  Since the shaper is experimental, I made it not monolithic, but ‚Äúmodular‚Äù.  Each module calculates the weight of the package according to different criteria.  There are 4 modules out of the box, but you can easily write another one.  Modules can be used together, you can separately. <br><br>  Modules: <br><br><ul><li>  <strong>inhibit_big_flows</strong> - suppress large flows.  The more bytes transferred between two IP-addresses, the smaller the ‚Äúweight‚Äù of the packet becomes.  That is, it increases the likelihood that a packet from a large, heavy session will be dropped.  Information is stored in a circular buffer, so that an amnesty comes from time to time (the number of sessions monitored is set in the config file), the flows are replaced with more recent ones. <br><br></li><li>  <strong>bymark</strong> - the weight of packages is set by brand.  An iptables brand is set according to some criteria, for these packages the coefficient specified in the config will be applied.  You can manually raise or lower the priority of some marked traffic <br><br></li><li>  <strong>entropy</strong> - the weight is considered depending on the entropy (more precisely, the measure of entropy according to Shannon) flow.  The stream is identified by the protocol number and the participant addresses.  For TCP / UDP, the source and destination port is also taken into account.  The higher the entropy, the less weight.  Those.  multimedia, encrypted, compressed traffic is more likely to be dropped than the rest. <br><br></li><li>  And a very primitive random module - it just adds randomness to the process of dropping and reordering packets (if you use only this module, you get the classic RED). </li></ul><br>  Packet weights, measured in each module, are multiplied by a factor (you can specify your own for each module) and add.  It turns out the resulting weight. <br><br><h3>  Statistics and graphs </h3><br>  Shaper can keep statistics and draw graphs.  Live it looks like this: <a href="http://damper.xenoeye.com/">damper.xenoeye.com</a> .  Green ‚Äî how many bytes / packets are missing; red ‚Äî how many are dropped.  Schedule you can reason / scroll. <br><br>  The second graph (included by the ‚Äúwchart yes‚Äù directive in the config) is the average packet weights per second, normalized, broken down by module. <br><br>  The demo works on not-so-fast ARMs (Scaleway bare metal, 32-bit ARMv7), sometimes it may stick slightly. <br><br><h3>  Debugging </h3><br>  The modules inhibit_big_flows and entropy have a debug mode that is included in the config.  In this mode, modules every N seconds do a dump of current flows with weights. <br><br>  In addition, there is a mode without speed limit ("limit no" in the config).  In this mode, all packets are skipped (without analysis in the modules), but you can keep statistics of past packets / bytes, meditate on the channel load schedule, for example. <br><br><h3>  results </h3><br>  Shaper turned out quite simple (well, in my, zamylenny, look).  To use, you need to choose the direction in which to shape, add an iptables rule, set the desired speed in the config and run. <br><br>  Heavy and high-entropy sessions are defined and reduced in priority, but there are no miracles: if the channel is very narrow, comfortable surfing will not work. <br><br>  At high speeds and a large number of users, I did not test it, but on tens of megabits and with several users it is subjectively better than without a shaper.  Although it loads the CPU, but not only from the use of NFQUEUE, but also from the general code clumsiness (and a little from the features of clock_nanosleep ()), it is possible to optimize and optimize. <br><br>  This, of course, is only proof of concepts, the code is muddled in places and almost never combed. <br><br>  If someone has ideas, wishes and suggestions about it, it would be interesting to read. </div><p>Source: <a href="https://habr.com/ru/post/310242/">https://habr.com/ru/post/310242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310224/index.html">The cruel reality of creating FPS for mobile devices</a></li>
<li><a href="../310232/index.html">Paul Graham: What you need to do in high school to become a good hacker</a></li>
<li><a href="../310234/index.html">Introduction to futures-rs: asynchronous on Rust [translation]</a></li>
<li><a href="../310236/index.html">Creating a menu for playing on Unity3D based on states</a></li>
<li><a href="../310238/index.html">Apple released iOS 10.0.1</a></li>
<li><a href="../310244/index.html">Users of the Tor web browser are encouraged to update it as soon as possible.</a></li>
<li><a href="../310252/index.html">Five promising programming languages ‚Äã‚Äãwith a bright future</a></li>
<li><a href="../310254/index.html">Development of a php server and system scripts</a></li>
<li><a href="../310258/index.html">Challenge search cloud. Lecture in Yandex</a></li>
<li><a href="../310260/index.html">3CX Enterprise Edition, an extension for Chrome CallVia3CX, integration with Zendesk and improved Webmeeting infrastructure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>