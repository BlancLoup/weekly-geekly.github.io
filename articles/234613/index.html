<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Flask Mega-Tutorial, Part 10: Full-Text Search</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the tenth article in the series where I describe my experience of writing a Python web application using the Flask mic framework. 

 The purpo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Flask Mega-Tutorial, Part 10: Full-Text Search</h1><div class="post__text post__text-html js-mediator-article"> This is the tenth article in the series where I describe my experience of writing a Python web application using the Flask mic framework. <br><br>  The purpose of this guide is to develop a fairly functional microblog application, which I decided to call <code>microblog</code> in the absence of originality. <br><br><div class="spoiler">  <b class="spoiler_title">Table of contents</b> <div class="spoiler_text">  <a href="http://habrahabr.ru/post/193242/">Part 1: Hello, World!</a> <br>  <a href="http://habrahabr.ru/post/193260/">Part 2: Templates</a> <br>  <a href="http://habrahabr.ru/post/194062/">Part 3: Forms</a> <br>  <a href="http://habrahabr.ru/post/196810/">Part 4: Database</a> <br>  <a href="http://habrahabr.ru/post/222983/">Part 5: User Login</a> <br>  <a href="http://habrahabr.ru/post/223375/">Part 6: Profile Page and Avatars</a> <br>  <a href="http://habrahabr.ru/post/223783/">Part 7: Unit Testing</a> <br>  <a href="http://habrahabr.ru/post/230643/">Part 8: Subscribers, Contacts and Friends</a> <br>  <a href="http://habrahabr.ru/post/230897/">Part 9: Pagination</a> <br>  <a href="http://habrahabr.ru/post/234613/">Part 10: Full Text Search (this article)</a> <br>  <a href="http://habrahabr.ru/post/234737/">Part 11: Email Support</a> <br>  <a href="http://habrahabr.ru/post/234785/">Part 12: Reconstruction</a> <br>  <a href="http://habrahabr.ru/post/236753/">Part 13: Date and Time</a> <br>  <a href="http://habrahabr.ru/post/236861/">Part 14: I18n and L10n</a> <br>  <a href="http://habrahabr.ru/post/237065/">Part 15: Ajax</a> <br>  <a href="http://habrahabr.ru/post/237317/">Part 16: Debugging, Testing, and Profiling</a> <br>  <a href="http://habrahabr.ru/post/237489/">Part 17: Deploying to Linux (and even to Raspberry Pi!)</a> <br>  <a href="http://habrahabr.ru/post/237517/">Part 18: Deploying to Heroku Cloud</a> <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Brief repetition </h2><br>  In the previous article, we improved our queries so that they return posts to the page. <br><br>  Today we will continue to work with our database, but with a different purpose.  All applications that store content should provide the ability to search. <br><a name="habracut"></a><br>  For many types of websites, you can simply enable Google, Bing, etc.  index everything and provide search results.  This works well with sites that are based on static pages, such as a forum.  In our small application, the basic unit of content is a short user post, not a whole page.  We want a more dynamic search result.  For example, if we search for the word ‚Äúdog‚Äù, we want to see all user posts that include this word.  Obviously, the search result page does not exist until no one searches, so search engines will not be able to index it. <br><br><h2>  Introduction to Full-Text Search Systems </h2><br>  Unfortunately, support for full-text search in relational databases is not standardized.  Each database implements full-text search in its own way, and SQLAlchemy does not have a suitable abstraction for this case. <br><br>  We are now using SQLite for our database, so we could just create a full-text index using the capabilities provided by SQLite, bypassing SQLAlchemy.  But this is a bad idea, because if one day we decide to switch to another database, we will have to rewrite our full-text search for another database. <br><br>  Instead, we are going to leave our database for working with ordinary data, and create a specialized database for search. <br><br>  There are several open source full-text search systems.  Only one, as far as I know, has a Flask extension called Whoosh, and its engine is also written in Python.  The advantage of using pure Python is the ability to install it and run wherever Python is available.  The disadvantage is the efficiency of the search, which does not compare with the engines written in C or C ++.  In my opinion, it would be an ideal solution to have an extension for Flask that can connect with different systems and abstract us from details, as Flask-SQLAlchemy does, freeing us from the nuances of various databases, but there is nothing like that in the full-text search area.  Django developers have a very good extension that supports various full-text search systems called django-haystack.  Maybe one day someone will create a similar extension for Flask. <br><br>  But now, we implement our search using Whoosh.  The extension we are going to use is Flask-WhooshAlchemy, which combines the Whoosh base with the Flask-SQLAlchemy model. <br><br>  If you do not yet have Flask-WhooshAlchemy in your virtual environment, it's time to install it.  Windows users should do this: <br><br><pre> <code class="bash hljs">flask\Scripts\pip install Flask-WhooshAlchemy</code> </pre><br><br>  All others can do this: <br><br><pre> <code class="bash hljs">flask/bin/pip install Flask-WhooshAlchemy</code> </pre><br><br><h2>  Configuration </h2><br>  The configuration of Flask-WhooshAlchemy is very simple.  We just have to tell the extension the name of our base for full-text search (the <code>config.py</code> ): <br><br><pre> <code class="python hljs">WHOOSH_BASE = os.path.join(basedir, <span class="hljs-string"><span class="hljs-string">'search.db'</span></span>)</code> </pre><br><br><h2>  Model changes </h2><br>  Since Flask-WhooshAlchemy integrates Flask-SQLAlchemy, we need to specify which data should be indexed in which models (file <code>app/models.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> flask.ext.whooshalchemy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> whooshalchemy <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(db.Model)</span></span></span><span class="hljs-class">:</span></span> __searchable__ = [<span class="hljs-string"><span class="hljs-string">'body'</span></span>] id = db.Column(db.Integer, primary_key = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) body = db.Column(db.String(<span class="hljs-number"><span class="hljs-number">140</span></span>)) timestamp = db.Column(db.DateTime) user_id = db.Column(db.Integer, db.ForeignKey(<span class="hljs-string"><span class="hljs-string">'user.id'</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__repr__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'&lt;Post %r&gt;'</span></span> % (self.body) whooshalchemy.whoosh_index(app, Post)</code> </pre><br><br>  The model now has a new field <code>__searchable__</code> , which is an array with all the fields of the <code>__searchable__</code> that should be included in the index.  In our case, we need only the index of the body field of our post. <br><br>  We also initialize the full-text index for this model by calling the <code>whoosh_index</code> function. <br><br>  Since we did not change the format of our database, we do not need to do a new migration. <br><br>  Unfortunately, all the posts that were in the database before adding the full-text search engine will not be indexed.  To make sure that the database and the search engine are synchronized, we must remove all posts from the database and start over.  First, run the Python interpreter.  For Windows users: <br><br><pre> <code class="bash hljs">flask\Scripts\python</code> </pre><br>  For everyone else: <br><br><pre> <code class="bash hljs">flask/bin/python</code> </pre><br>  With this request, we delete all posts: <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; from app.models import Post &gt;&gt;&gt; from app import db &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> post <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Post.query.all(): ... db.session.delete(post) &gt;&gt;&gt; db.session.commit()</code> </pre><br><br><h2>  Search </h2><br>  Now we are ready to search.  Let's first add some posts to the database.  We have two ways to do this.  We can start the application and add posts via a web browser as a regular user, or we can do it through an interpreter. <br><br>  Through the interpreter, we can do this as follows: <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; from app.models import User, Post &gt;&gt;&gt; from app import db &gt;&gt;&gt; import datetime &gt;&gt;&gt; u = User.query.get(1) &gt;&gt;&gt; p = Post(body=<span class="hljs-string"><span class="hljs-string">'my first post'</span></span>, timestamp=datetime.datetime.utcnow(), author=u) &gt;&gt;&gt; db.session.add(p) &gt;&gt;&gt; p = Post(body=<span class="hljs-string"><span class="hljs-string">'my second post'</span></span>, timestamp=datetime.datetime.utcnow(), author=u) &gt;&gt;&gt; db.session.add(p) &gt;&gt;&gt; p = Post(body=<span class="hljs-string"><span class="hljs-string">'my third and last post'</span></span>, timestamp=datetime.datetime.utcnow(), author=u) &gt;&gt;&gt; db.session.add(p) &gt;&gt;&gt; db.session.commit()</code> </pre><br>  The Flask-WhooshAlchemy extension is very cool because it connects to Flask-SQLAlchemy automatically.  We do not need to maintain a full-text search index, everything is done transparently for us. <br><br>  Now we have several posts indexed for full-text search and we can try to search: <br><br><pre> <code class="bash hljs">&gt;&gt;&gt; Post.query.whoosh_search(<span class="hljs-string"><span class="hljs-string">'post'</span></span>).all() [&lt;Post u<span class="hljs-string"><span class="hljs-string">'my second post'</span></span>&gt;, &lt;Post u<span class="hljs-string"><span class="hljs-string">'my first post'</span></span>&gt;, &lt;Post u<span class="hljs-string"><span class="hljs-string">'my third and last post'</span></span>&gt;] &gt;&gt;&gt; Post.query.whoosh_search(<span class="hljs-string"><span class="hljs-string">'second'</span></span>).all() [&lt;Post u<span class="hljs-string"><span class="hljs-string">'my second post'</span></span>&gt;] &gt;&gt;&gt; Post.query.whoosh_search(<span class="hljs-string"><span class="hljs-string">'second OR last'</span></span>).all() [&lt;Post u<span class="hljs-string"><span class="hljs-string">'my second post'</span></span>&gt;, &lt;Post u<span class="hljs-string"><span class="hljs-string">'my third and last post'</span></span>&gt;]</code> </pre><br>  As you can see in the examples, requests do not have to be limited to single words.  In fact, Whoosh supports <a href="http://packages.python.org/Whoosh/querylang.html">excellent search language</a> . <br><br><h2>  Full-text search integration in our application </h2><br>  To make the search available to users of our application, we need to make a few small changes. <br><br><h3>  Configuration </h3><br>  In the configuration, we must specify how many search results should be returned ( <code>config.py</code> ): <br><br><pre> <code class="python hljs">MAX_SEARCH_RESULTS = <span class="hljs-number"><span class="hljs-number">50</span></span></code> </pre><br><br><h3>  Search form </h3><br>  We are going to add a search form to the navigation bar at the top of the page.  The location at the top is very good, since the search will be available from all pages. <br><br>  First we need to add a search form class ( <code>app/forms.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchForm</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Form)</span></span></span><span class="hljs-class">:</span></span> search = TextField(<span class="hljs-string"><span class="hljs-string">'search'</span></span>, validators = [Required()])</code> </pre><br><br>  Then we need to create a search form object and make it available to all templates.  We put it in the navigation bar, which is common to all pages.  A simple way to achieve this is to create a form in the <code>before_request</code> handler, and insert it into the global variable <code>g</code> (file <code>app/views.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> forms <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SearchForm @app.before_request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">before_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> g.user = current_user <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> g.user.is_authenticated(): g.user.last_seen = datetime.utcnow() db.session.add(g.user) db.session.commit() g.search_form = SearchForm()</code> </pre><br><br>  Then we will add the form to our template ( <code>app/templates/base.html</code> ): <br><br><pre> <code class="django hljs"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Microblog: </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('index') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Home</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> g.user.is_authenticated() %}</span></span><span class="xml"><span class="xml"> | </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('user', nickname = g.user.nickname) }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Your Profile</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> | </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">form</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"display: inline;"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{url_for('search')}}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">method</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"post"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"search"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{g.search_form.hidden_tag()}}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{g.search_form.search(size=20)}}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">input</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"Search"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">form</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> | </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ url_for('logout') }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Logout</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  Please note we display the search form only when the user is logged in.  In the same way, the <code>before_request</code> handler will create the form only when the user is logged in, since our application does not show any content to unauthorized guests. <br><br><h3>  View.  Search function </h3><br>  The <code>action</code> field for our form was set above to send all requests to the <code>search</code> function of our view.  This is where we will execute our full-text queries ( <code>app/views.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/search', methods = ['POST']) @login_required def search(): if not g.search_form.validate_on_submit(): return redirect(url_for('index')) return redirect(url_for('search_results', query = g.search_form.search.data))</span></span></code> </pre><br><br>  This function is actually not so big, it simply collects the request from the form and redirects it to another page that accepts the request as an argument.  We do not search directly in this function so that the user's browser does not issue a warning about re-submitting the form if the user tries to refresh the page.  This situation can be avoided by making a redirect to a POST request, then when the page is updated, the browser will update the page to which the redirect was, and not the request itself. <br><br><h2>  Results page </h2><br>  After the query string is submitted by the form, the POST handler passes it through redirection to the <code>search_results</code> handler ( <code>app/views.py</code> ): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MAX_SEARCH_RESULTS @app.route(<span class="hljs-string"><span class="hljs-string">'/search_results/&lt;query&gt;'</span></span>) @login_required <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">search_results</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(query)</span></span></span><span class="hljs-function">:</span></span> results = Post.query.whoosh_search(query, MAX_SEARCH_RESULTS).all() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> render_template(<span class="hljs-string"><span class="hljs-string">'search_results.html'</span></span>, query = query, results = results)</code> </pre><br><br>  The <code>search_result</code> function sends a request to Whoosh, passing along with the request a limit on the number of results in order to protect against a potentially large number of search results. <br><br>  The search is completed in the search_result template ( <code>app/templates/search_results.html</code> ): <br><br><pre> <code class="django hljs"><span class="xml"><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!-- extend base layout --&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> "base.html" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">block</span></span></span></span></span><span class="hljs-template-tag"> content %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Search results for "</span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{query}}</span></span><span class="xml"><span class="xml">":</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> post </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> results %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">include</span></span></span></span></span><span class="hljs-template-tag"> 'post.html' %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endblock</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br><br>  And here we can again reuse our <code>post.html</code> . <br><br><h2>  Final words </h2><br>  We have now completed another very important, albeit often overlooked feature, which a decent web application should have. <br><br>  Below I post the updated version of the microblog application in all the changes made in this article. <br><br>  Download <a href="">microblog-0.10.zip</a> . <br><br>  As always, there is no database, you have to create it yourself.  If you follow this series of articles, you know how to do it.  If not, go back to the database article to find out. <br><br>  I hope you enjoyed this tutorial. <br><br>  Miguel </div><p>Source: <a href="https://habr.com/ru/post/234613/">https://habr.com/ru/post/234613/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../234601/index.html">7-inch TFT LCD backlight brightness control</a></li>
<li><a href="../234603/index.html">The story of the creation of iOS games about fast reaction and steel nerves</a></li>
<li><a href="../234607/index.html">How to enter the US magistracy?</a></li>
<li><a href="../234609/index.html">Mini airship control system</a></li>
<li><a href="../234611/index.html">Setting up a time tracking system: try it out for yourself</a></li>
<li><a href="../234615/index.html">The search engine in the NSA contains more than 850 billion records</a></li>
<li><a href="../234619/index.html">RenderDoc - a graphical debugger for DirectX11 from Crytek</a></li>
<li><a href="../234621/index.html">How we made the educational platform: the first application</a></li>
<li><a href="../234623/index.html">Message Passing Concept. Agents and actors</a></li>
<li><a href="../234627/index.html">ZSlice landscape editor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>