<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimizing ASP.NET - practical tips for working with IIS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this publication, we will focus on setting up important parameters of the ASP.NET application pool when calling remote web services and actively wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimizing ASP.NET - practical tips for working with IIS</h1><div class="post__text post__text-html js-mediator-article">  In this publication, we will focus on setting up important parameters of the ASP.NET application pool when calling remote web services and actively working with the network on the server side through standard .NET classes. <br><br><img src="https://habrastorage.org/files/d90/c66/1f7/d90c661f7c984fd0ba2131cdbdd63652.jpg"><br><br><h3>  Introduction </h3><br>  Have you ever set up production servers on Windows Server 2008 R2 / IIS 7.5 or higher?  For system administrators who have extensive experience with IIS, this is most likely a trivial task, but for web developers, who for various reasons sometimes have to participate in setting up the ‚Äúcombat‚Äù servers, this information can be very useful. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we proceed.  We accelerate a site on ASP.NET - we save money of the enterprise and nerves of the administrator. <br><a name="habracut"></a><br>  <a href="https://habr.com/ru/post/250881/">Prehistory</a> <br>  <a href="https://habr.com/ru/post/250881/">1. IIS configuration options</a> <br>  <a href="https://habr.com/ru/post/250881/">2. Configure ASP.NET</a> <br>  <a href="https://habr.com/ru/post/250881/">3. Recommendations for optimizing the basic configuration</a> <br>  <a href="https://habr.com/ru/post/250881/">Additionally</a> <br>  <a href="https://habr.com/ru/post/250881/">Conclusion</a> <br>  <a href="https://habr.com/ru/post/250881/">Links</a> <br><br><h3>  Prehistory </h3><br>  At the end of last year, in a large organization, we faced problems with the performance of web servers with a dramatically increased user load.  At that time, more than 200,000 clients were registered in the web application.  In normal mode, about 1000 users work at the same time, about 10-15% of unique visitors from the total number of registered users per day, so the load is relatively low.  However, there are peak loads at which the system turns out to be practically inoperable. <br><br>  Web administrators checked everything they could and could not understand what was the matter.  Indeed, despite the fact that on all physical parameters of the system at the physical level, the performance was good, there were failures with the availability of services, and a huge queue of requests gathered in the pool.  The organization uses a 4-node NLB cluster (Windows Server 2008 R2 + IIS 7.5 + .NET 4.5), there is a margin for CPU and memory usage, network channels are large, the number of ports used is sufficient.  All the checks indicated that the problems lie in the depths of IIS and the configuration of the ASP.NET pool.  A vivid example when administrators would not be prevented by the help of experienced web developers ... <br><br><h3>  1. IIS configuration options </h3><br><div class="spoiler">  <b class="spoiler_title">General Description of .NET Configuration</b> <div class="spoiler_text">  Beginning with IIS 7, all ASP.NET configuration settings are stored in XML files (* .config).  They replaced the metabase that was used in IIS 6.0 and earlier. <br><br>  The configuration file scheme for IIS 7.x and higher looks like this: <br><br><img src="https://habrastorage.org/files/b33/c07/8fa/b33c078fa0cb4844ae2e55608455da5e.png"><br>  <i>Fig.</i>  <i>1. Diagram of configuration files</i> <br><br>  At the top of the .NET hierarchical configuration is the <b>machine.config file</b> .  It defines global parameters for a specific machine.  This file defines the supported sections of the configuration files, configures the ASP.NET worker process, and registers suppliers of various modules.  To optimize the initialization process, the <b>machine.config file has</b> been greatly simplified, and it is located in the directory: <br><br><pre><code class="cs hljs">%systemroot%\Microsoft.NET\Framework\&lt;versionNumber&gt;\CONFIG\</code> </pre> <br>  Here is the <b>machine.config.comments file</b> , which allows you to find out which parameters are used by default.  Using this data in <b>machine.config,</b> you can add parameters with redefined values. <br><br>  The root of the ASP.NET configuration hierarchy is the <b>web.config file</b> located in the same directory as the <b>machine.config</b> .  This file includes parameters that are used for all ASP.NET applications. <br><br>  <b>ApplicationHost.config</b> - the root IIS configuration file, includes descriptions of all sites, applications, virtual directories and application pools, as well as global default settings for web server settings.  It is located in the following folders depending on the OS version: <br><ul><li>  for 32-bit -% WINDIR% \ System32 \ inetsrv \ config \ </li><li>  for 64-bit -% WINDIR% \ SysWOW64 \ inetsrv \ config \ </li></ul><br>  Each local <b>web.config file</b> applies configuration settings for the directory in which it is located, as well as for all child directories.  Settings of nested directories can be overridden by their own ‚Äúconfigs‚Äù. <br></div></div><br>  Before you begin setting up IIS configuration, pay attention to the ASP.NET performance counters, evaluate the current and peak system load, record the available indicators.  Check the logs for the error ‚ÄúHTTP Error 503.2 - Service Unavailable‚Äù.  Try to determine if some of the requests in the queue are blocked. <br><br>  If the system performance meets the needs of the customer, then it is better to leave the default settings, because they are designed for most ASP.NET applications. <br><br>  When configuring IIS, there are two main parameters that affect the availability of the application and its performance. <br><br>  1. The <b>appConcurrentRequestLimit</b> parameter is the maximum number of simultaneous requests in the application.  Increasing the number of concurrent IIS requests will expand the available web server resources to serve requests.  The default is 5000. <br><br>  The <b>appConcurrentRequestLimit</b> parameter can be changed most quickly using the <a href="http://habrahabr.ru/post/145476/">appcmd.exe</a> utility via the command line.  This can be done globally for all IIS sites through the <b>ApplicationHost.config</b> file, or for a separate site (application). <br><br><pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">%windir%</span></span>\system32\inetsrv appcmd.exe <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> config /section:system.webserver/serverRuntime /appConcurrentRequestLimit:<span class="hljs-number"><span class="hljs-number">20000</span></span></code> </pre><br>  We execute the command, then open the ‚ÄúConfiguration Editor‚Äù section in the IIS for the root directory and check the new value of the set <b>appConcurrentRequestLimit</b> parameter.  And here you can manually change this value. <br><br><img src="https://habrastorage.org/files/978/191/b1a/978191b1abe443c4ac4da3d2da3401eb.jpg"><br>  <i>Fig.</i>  <i>2. Set appConcurrentRequestLimit parameter</i> <br><br>  To set this parameter, the following formula is most often used: <br>  &lt; <b>usersCount * 1.5</b> &gt;, where <b>usersCount</b> is the number of simultaneously working users. <br><br>  2. The <b>QueueLength</b> parameter is the maximum number of requests that the Http.sys driver places in the application pool queue.  When the queue is full, new requests receive the error "503.2 - Service Unavailable".  The default is 5000. <br><br>  This parameter can be configured in several ways: <br><ul><li>  globally for .NET at the server level via <b>machine.config</b> , processModel / requestQueueLimit section; </li><li>  at the IIS level via <b>ApplicationHost.config</b> : system.web / httpRuntime -&gt; appRequestQueueLimit; </li><li>  set the value of the <b>queueLength</b> parameter for a specific pool. </li></ul><br>  As an example, we will change this parameter for the DefaultAppPool pool via the command line: <br><br><pre> <code class="dos hljs">appcmd.exe <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> apppool "DefaultAppPool" /queueLength:<span class="hljs-number"><span class="hljs-number">20000</span></span></code> </pre><br>  We execute the command, then open the ‚ÄúApplication Pools‚Äù section in IIS, select the ‚ÄúDefaultAppPool‚Äù pool from the list, go to the ‚ÄúAdvanced Settings‚Äù menu and check. <br><br><img src="https://habrastorage.org/files/5b1/845/0b1/5b18450b18564a8eb917ad963315b615.jpg"><br>  <i>Fig.</i>  <i>3. Set the queueLength parameter</i> <br><br><div class="spoiler">  <b class="spoiler_title">Note: View current requests in the running pool through ‚ÄúIIS -&gt; Worker Processes‚Äù</b> <div class="spoiler_text">  In IIS Manager, select the server node in the tree, then click on the "Worker Processes" icon: <br><br><img src="https://habrastorage.org/files/470/eda/c8e/470edac8ec7c4e399092619bfd87ba32.jpg"><br>  <i>Fig.</i>  <i>4. Worker Processes menu in IIS Manager</i> <br><br>  In the list that appears, you can see the download of all currently running pools. <br><br><img src="https://habrastorage.org/files/232/ca6/7a9/232ca67a9a14483e9ccf2410a31f0e7a.jpg"><br>  <i>Fig.</i>  <i>5. View running pools through Worker Processes</i> <br><br>  When you click ‚ÄúView Current Request‚Äù a table appears with a list of addresses of pages being processed and other useful parameters.  To update the list, you can press F5 on the screen.  Thus, you can find ‚Äúpending‚Äù requests: <br><br><img src="https://habrastorage.org/files/b8d/2ed/b91/b8d2edb915844c5dacfc923fa9eaffd8.jpg"><br>  <i>Fig.</i>  <i>6. List of current requests in the pool</i> <br><br>  To view the performance indicators, of course, it is better to use the Performance Monitor counters, but they will not show you, like the Requests Monitor, the URLs of current requests. <br></div></div><br><h3>  2. Configure ASP.NET </h3><br>  ASP.NET limits the number of worker threads and call completion ports used to execute requests.  If a server-side web application actively uses external web service calls, standard classes from the System.NET namespace to organize requests over the network, then there may be conflicts of poor performance and deadlocks.  At the beginning, a part of requests may simply ‚Äúhang‚Äù, the execution time will increase significantly.  In the worst case, if the classic pool configuration mode (the classic pipeline) is used, this can lead to a recycle in general.  ASP.NET deadlock detection is not performed for a pool running in <b>integrated mode</b> (default on IIS 7 and higher). <br><br>  The operation of application pools in the integrated mode has several advantages compared with the work in the classical mode.  It is recommended to run application pools in integrated mode. <br><br>  The figure below clearly shows how requests are processed in ASP.NET and which parameters are most important: <br><br><img src="https://habrastorage.org/files/ebe/c38/29d/ebec3829daaf4be9bdd48eeaefe5e8ae.jpg"><br>  <i>Fig.</i>  <i>7. The processing of requests in ASP.NET</i> <br><br>  For optimal performance of web applications, the auto-configuration of pool settings is enabled by default.  In this case, the autoConfig <b>property</b> is equal to " <b>true</b> " for the &lt; <b>processModel</b> &gt; section in the <b>machine.config file</b> , and other key parameters are not specified at all. <br><br>  Having thoroughly ‚Äúrummaged‚Äù in MSDN and in the <b>machine.config.comments file</b> , I found a description of the basic configuration of the pool.  There are 7 key parameters that affect the work of ASP.NET with services and network: <br><ul><li>  maxConnection </li><li>  maxWorkerThreads / minWorkerThreads </li><li>  maxIoThreads / minIoThreads </li><li>  minFreeThreads </li><li>  minLocalRequestFreeThreads </li></ul><br>  The <b>maxconnection</b> parameter specifies the maximum number of simultaneous requests from a single IP address.  When the auto pool configuration is enabled by default, this parameter is determined by the formula: <br>  <b>maxConnection</b> = <b>12 * cpuNum</b> , where <b>cpuNum</b> is the number of processor cores <br><br>  Thus, on a server with a 4-core processor, the maximum number of simultaneous connections to the final IP address is 48 = 12 * 4 (by default). <br><br>  The easiest way to get around this limitation is to specify the following directly in the code of your ASP.NET application in the <b>Application_Start</b> method in the <b>global.asax</b> file: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// maximum number of concurrent connections allowed by a ServicePoint object System.Net.ServicePointManager.DefaultConnectionLimit = Int16.MaxValue;</span></span></code> </pre><br>  It is more flexible to configure <b>maxconnection</b> better through configuration files at the application domain level (web.config) or web server (applicationHost.config).  The &lt; <b>system.net</b> &gt; section contains parameters that define how the .NET Framework connects to the network. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.net</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionManagement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxconnection</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5000"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.habrahabr.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxconnection</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"9999"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://65.53.32.230:88"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxconnection</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"240"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionManagement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.net</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <b>Important:</b> The scheme for the address of the <b>maxconnection</b> parameter should be like this: <br><br><pre> <code class="dos hljs">http(s)://&lt;IP-   &gt;:&lt;&gt;</code> </pre><br>  Increasing <b>maxconnection</b> allows you to make more simultaneous calls to remote services.  <b>This attribute does not affect local web services calls!</b>  It is necessary to understand that it is not enough to bypass the limit on the number of simultaneous connections to the service.  Since the increase in the number of simultaneous calls leads to an increase in the use of CLR threads, which are used to create remote and handle callbacks. <br><br>  ASP.NET through the <b>maxWorkerThreads</b> parameter sets the restriction of threads on the <b>w3wp.exe</b> worker process (starting with IIS 7).  Due to the fact that ASP.NET is built into IIS, ASP.NET processes generate requests for workflows.  Due to an insufficient number of threads in the CLR ThreadPool, requests will queue up and freeze. <br><br>  Attributes specified in the &lt; <b>processModel</b> &gt; section: <br>  1. The <b><a href="https://msdn.microsoft.com/en-us/library/system.web.configuration.processmodelsection.maxworkerthreads(v%3Dvs.110).aspx" title="maxWorkerThreads">maxWorkerThreads</a></b> parameter indicates the maximum number of worker threads for each processor in the CLR thread pool.  The default value is 20. The maximum value is 100. <br><br>  2. The <b><a href="https://msdn.microsoft.com/en-us/library/system.web.configuration.processmodelsection.maxiothreads(v%3Dvs.110).aspx" title="maxIoThreads">maxIoThreads</a></b> parameter specifies the maximum number of I / O threads for each processor in the CLR thread pool.  The default value is 20. The maximum value is 100. <br><br>  3. The <b><a href="https://msdn.microsoft.com/en-us/library/system.web.configuration.processmodelsection.minWorkerThreads(v%3Dvs.110).aspx" title="minWorkerThreads">minWorkerThreads</a></b> parameter ‚Äî specifies the minimum number of worker threads for each processor that can be provided immediately to service a remote request.  The default is 1. <br><br>  4. The <b><a href="https://msdn.microsoft.com/en-us/library/system.web.configuration.processmodelsection.minIoThreads%2520(v%3Dvs.110).aspx" title="minIoThreads">minIoThreads</a></b> parameter indicates the minimum number of I / O threads for each processor that can be provided immediately for callback processing.  The default is 1. <br><br>  The <b>minWorkerThreads</b> / <b>minIoThreads parameters</b> allow you to quickly deal with a sudden increase in the number of simultaneous connections, when in case of inactivity the thread pool may not have enough time to reach the optimal level of threads. <br><br>  Attributes specified in the &lt; <b>httpRuntime</b> &gt; section: <br>  1. The parameter <b>minFreeThreads</b> - determines the number of threads that can be used for work, except for processing incoming requests to the workflow.  This parameter prevents the ASP.NET process from using threads from the pool to process a new HTTP request if the total number of threads in the pool drops below this limit.  The default is 8. <br><br>  2. The <b>minLocalRequestFreeThreads</b> parameter defines the minimum number of free threads that ASP.NET keeps available for executing new local requests.  The default is 4. <br><br>  Notice that the <b>maxWorkerThreads</b> , <b>minWorkerThreads</b> , <b>maxIoThreads</b> , <b>minIoThreads parameters are</b> implicitly multiplied by the number of processors, and the <b>minFreeThreads</b> and <b>minLocalRequestFreeThreads parameters</b> are not. <br><br>  ASP.NET will not perform more than the following number of simultaneous requests: <br>  ( <b>maxWorkerThreads</b> * <b>number of CPUs</b> ) - <b>minFreeThreads</b> <br><br>  <b>Note:</b> for the entire application pool, that is, for each <b>w3wp.exe</b> worker process that serves the pool, there is one thread pool CLR ThreadPool.  For all application domains (sites) configured for one pool, a common set of threads is used.  Therefore, for resource-demanding applications it is better to use separate pools. <br><br><h3>  3. Recommendations for optimizing the basic configuration </h3><br>  First of all, you need to accurately determine the number of processors on the web server.  Alternatively, you can see TaskManager -&gt; tab "Performance".  If the processor supports <b>HyperThreadingTechnology</b> (HTT) mode, then half of the cores are logical (Logical processors), and not physical (Cores).  For example, when the HTT mode is enabled, a processor with 4 physical cores will work as 8 logical cores: <br><br><img src="https://habrastorage.org/files/ffa/70f/1db/ffa70f1dbce94cd7b615ca0781d245fd.jpg"><br>  <i>Fig.</i>  <i>8. Processor loading window in TaskManager</i> <br><br>  You can also try using the following commands on the command line: <br><br><pre> <code class="dos hljs">WMIC CPU Get DeviceID,NumberOfCores,NumberOfLogicalProcessors</code> </pre>  or <pre> <code class="dos hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">%NUMBER_OF_PROCESSORS%</span></span></code> </pre><br>  For example, on a server with 4 processors and the <b>autoConfig</b> = " <b>true</b> " property, ASP.NET will have the following default settings: <br>  maxConnection - 48;  maxWorkerThreads - 80;  maxIoThreads - 80, minFreeThreads - 8, minLocalRequestFreeThreads - 4. <br><br>  If the webpage on the backend makes multiple net calls for each request, MSDN recommends using the following configuration settings: <br><br><ol><li>  maxWorkerThreads = 100 |  minWorkerThreads = maxWorkerThreads / 2 = 50 </li><li>  maxIoThreads = 100 </li><li>  maxConnection = 12 * N </li><li>  minFreeThreads = 88 * N </li><li>  minLocalRequestFreeThreads = 76 * N, where N is the number of processors. </li></ol><br>  This section only provides recommendations, not rules.  And the date of publication of this data is quite old.  For our ‚Äúcombat‚Äù system, we use slightly different configuration parameters.  These formulas are a good starting point for the start of optimization, they show well the dependence of parameters on each other.  For example, by increasing the value of the <b>maxConnection</b> parameter several times, you can easily ‚Äúestimate‚Äù the basic values ‚Äã‚Äãfor the remaining parameters. <br><br>  Changes to the &lt; <b>processModel</b> &gt; section are allowed to be made only in the <b>machine.config file</b> due to the attribute <b>set allowDefinition</b> = " <b>MachineOnly</b> " when adding the <b>processModel</b> section. <br><br>  <i>C: \ Windows \ Microsoft .NET \ Framework64 \ v4.0.30319 \ Config \ Machine.config</i> : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"processModel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Web.Configuration.ProcessModelSection, System.Web, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">allowDefinition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MachineOnly"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">allowLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  To be able to set the values ‚Äã‚Äãof the <b>processModel</b> section for each application separately via <b>web.config</b> , you must set the property <b>allowDefinition</b> = " <b>Everywhere</b> ". <br><br><div class="spoiler">  <b class="spoiler_title">I will give the configuration settings from our web server.</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">processModel</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autoConfig</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"False"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxWorkerThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxIoThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">minWorkerThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"50"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">minIoThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpRuntime</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">minFreeThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"640"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">minLocalRequestFreeThreads</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"96"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.net</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionManagement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://__1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxconnection</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5000"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://__2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxconnection</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5000"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">connectionManagement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.net</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br>  <b>Important:</b> after making changes, you need to update the Application pools. <br><br>  Remember that you need to increase these parameters only if necessary if you have enough CPU resources. <br><br>  To analyze the performance of web servers, I recommend setting up ASP.NET counters via Performance Monitor: <br><br><ul><li>  ASP.NET Applications \ Requests / Sec </li><li>  Web Service \ ISAPI Extension Requests / sec </li><li>  ASP.NET \ Requests Current </li><li>  ASP.NET \ Requests Queued </li><li>  ASP.NET \ Requests Rejected </li><li>  ASP.NET Applications \ Requests Executing </li><li>  ASP.NET Applications \ Requests Timed Out </li><li>  ASP.NET \ Request Execution Time </li></ul><br>  For a more in-depth analysis of the <b>w3wp.exe</b> process serving the IIS application pool, you can try the <b>WinDbg</b> debugger from the <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bg162891.aspx">Windows Software Development Kit</a> . <br><br>  It is possible that after checking the counters you will have to make adjustments to the configuration of your system. <br><br><h3>  Additionally </h3><br>  For a better understanding of how IIS works, I recommend that you familiarize yourself with the process of processing a request from a user's browser to the final pool of an ASP.NET application in this useful article, <a href="http://habrahabr.ru/post/189086/">‚ÄúBasics of the IIS architecture, or query pipeline for ASP.NET‚Äù</a> . <br><br>  If you are using IIS8, it will not be superfluous to pay attention to <a href="http://habrahabr.ru/post/139766/">"Full CPU load control (CPU Throttling)".</a> <br><br><h3>  Conclusion </h3><br>  For sites that do not make frequent network requests on the server side, the standard pool settings should be sufficient (processModel / autoConfig = ‚Äútrue‚Äù).  At the same time, IIS will set a limit of 20 worker threads and 12 remote connections per core.  If these values ‚Äã‚Äãare exceeded, requests will start to queue and the performance of the web application will drop. <br><br>  If your site works well and you can estimate the expected load on the system, then you should not change anything.  If you start ‚Äúfreezing‚Äù when processing requests to various services - you should not immediately blame the hardware for everything!  It is better to make changes to the basic ASP.NET configuration.  Keep in mind that changing the basic parameters of the application pool will certainly lead to an increase in CPU usage.  Optimal balancing of all system parameters is the key to stable and productive equipment operation.  As the saying goes, ‚Äúforewarned is forearmed.‚Äù <br><br>  I invite everyone to share your experience in setting up and optimizing the work of production web servers on the Windows Server platform. <br><br><h3>  Links </h3><br><ul><li>  <a href="https://msdn.microsoft.com/en-us/library/ff647813.aspx">Chapter 17 - Tuning .NET Application Performance</a> </li><li>  <a href="http://support.microsoft.com/kb/821268%3Fln%3Den-us">When you make calls to Web services</a> </li><li>  <a href="http://www.amazon.com/Performance-Tuning-Optimizing-ASP-NET-Applications/dp/1590590724">Performance Tuning and Optimizing ASP.NET Applications</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/ff647791.aspx">Chapter 15 - Measuring .NET Application Performance</a> </li><li>  <a href="https://msdn.microsoft.com/en-us/library/System.Web.Configuration.ProcessModelSection(v%3Dvs.110).aspx">MSDN: ProcessModelSection Class</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/250881/">https://habr.com/ru/post/250881/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250861/index.html">Parsing function calls in PHP</a></li>
<li><a href="../250867/index.html">When the site can be more than 1Mb?</a></li>
<li><a href="../250873/index.html">Unity: Build under Android or "size matters"</a></li>
<li><a href="../250875/index.html">What is Business Intelligence?</a></li>
<li><a href="../250879/index.html">Everything has been stolen before us.</a></li>
<li><a href="../250885/index.html">Translit for JavaScript and GOST-7.79-2000</a></li>
<li><a href="../250887/index.html">Do not be evil</a></li>
<li><a href="../250891/index.html">Communication scripts from different browser tabs</a></li>
<li><a href="../250893/index.html">What is 1C. On a complex system in simple words</a></li>
<li><a href="../250895/index.html">DotNext Conference returns to Moscow - with new forces and updated name</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>