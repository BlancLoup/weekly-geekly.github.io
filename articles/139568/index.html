<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RGB firefly on Attiny13</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings to you, colleagues, comrades accompanying and just interested! 
 The other day, I made a device that can be used as a basis for an original ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RGB firefly on Attiny13</h1><div class="post__text post__text-html js-mediator-article">  Greetings to you, colleagues, comrades accompanying and just interested! <br>  The other day, I made a device that can be used as a basis for an original gift, a souvenir, or just made for my own pleasure, if it gives you a fuss with modern microelectronics.  Immediately video demonstration of the device: <iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/uli7GuBFUAU%3Ffeature%3Doembed&amp;xid=17259,15700019,15700186,15700191,15700253,15700256,15700259&amp;usg=ALkJrhgAgfrkmtPeTFN0BX1Ti7p41OQnqA" frameborder="0" allowfullscreen=""></iframe><br>  Unfortunately, the camera can not convey the shades and modulations of the glow of the RGB-LED, it looks much nicer live.  However, if you are nevertheless interested, then there are a lot of letters and pictures further. <br><a name="habracut"></a><br>  The prerequisites for the creation of the device were an irresistible craving for everything and everyone filling in microcontrollers, an article by Comrade <a href="http://habrahabr.ru/users/Ariman/">Ariman</a> ( <a href="http://habrahabr.ru/blogs/DIY/111610/">We are creating an original gift with the help of chemistry, physics and electronics</a> ) - for which he once again has a separate respect and respect, and a desire to do something interesting with his own hands. <br>  First, I bring to your attention a quick assembly manual, and then, for the curious, the details of the internal structure and performance characteristics. <br>  So, we will need: <br>  1. Atmel Attiny13 microcontroller - 1 pc. <br>  2. RGB LED - 1 pc. <br>  3. Development board type CRS 044 - 1 pc. <br>  4. Resistor 1 MŒ©, smd - 1 pc. <br>  5. Copper wire (lived from a twisted pair) - 30 cm. <br>  6. CR2032 battery - 1 pc. <br>  7. Clip - 1 pc. <br><img src="http://img713.imageshack.us/img713/1033/26562409.jpg" alt="image"><br>  It also assumes the presence of a soldering iron, a simple tool for working with electronics and straight arms. <br>  First of all, we cut off a piece of about 3x3 cm from the breadboard. The size is determined by the dimensions of the battery, which should fit on the marked piece, taking into account the gap for the wire sensor along the sides. <br><img src="http://img716.imageshack.us/img716/1617/79833295.jpg" alt="image"><br>  After cutting out a piece of board, unbend the clip, which we will use as the contact-holder of the battery.  The clip is bent as necessary and fastened in the holes of the board.  We push the battery and turn it in, so that it would hold tight.  Also from the copper wire make a second contact for the negative pole of the battery. <br><img src="http://img40.imageshack.us/img40/1147/70647986.jpg" alt="image"><br>  Both contacts are soldered to the breadboard.  Once again, insert the battery and check the reliability of its attachment.  It is better to tighten the paperclip tightly, try until the battery keeps well. <br><img src="http://img696.imageshack.us/img696/4730/35968256.jpg" alt="image"><br>  And now we will sew.  But not a microcontroller, but recall the skills of sewing with thread and needle.  Stitch by stitch, around the perimeter, by copper wire we go around our kerchief, and we draw the ends in the designated place.  This will be our sensor.  One moment, at the corners of the main diagonal wire, we snack and fix.  Therefore, as it turned out later ("... experience, son of difficult errors ...") such a large sensor is poorly calibrated and leads to poor-quality detection of touch.  So, the role of the sensor remains only behind the two sides of the square of our board, the rest is decorative (in the photo the sensor is not consumed, as it all turned out after the trial tests. But the cut sensor can be seen in the last photo of the finished device). <br><img src="http://img36.imageshack.us/img36/2904/91028665.jpg" alt="image"><br>  Well, we got to our microcontroller.  What a wonderful thing it is!  On a tiny platform with only 8 legs and you have an ADC, and a timer, and hardware PWM, and it has a built-in generator and you only show him the electricity, and he is already working.  What else is needed for happiness, especially since the price of this pleasure is only 75 American kopecks.  There are of course some flaws, but - well, the world is not perfect.  Okay, enough of the lyrics, we continue. <br>  So, we solder our tin to the prepared site.  STOP! .. I almost forgot.  Now we will sew. <br>  Download the finished <a href="">kosher firmware</a> and fill it in any convenient way, I personally used the simplest LPT programmer, though I did it a bit for myself, but this is not the point - the circuit is as simple as a stool, it works reliably like a hammer.  Fyuzy not touch. <br>  Now we solder our tin to the prepared site: 4th pin (ground, minus source) to the wire contact from the center of the battery, 8th pin (power, plus source) to the clip, 2nd pin to the wire from the sensor.  From the side we catch the smd resistor (1 MŒ©), between pins 2 and 3. If the smd resistor is not at hand, the usual one can be crammed. <br><img src="http://img814.imageshack.us/img814/421/66152696.jpg" alt="image"><br>  The case remains for small - RGB-LED.  RGB-LED we need one that with four pins (there are, however, oddly enough, and with 2 - do not take them).  Three of them are anodes of red, green and blue diodes, one conclusion is common.  The LED lens must first be melted with a transparent silicone hot melt.  If this is not done, then it will not glow very nicely, because  emitters give beams that almost do not mix and in general do not look ice.  So we heat the thermogun and thickly apply molten silicone to the head of the LED, then you can show your sculptural abilities by trying to portray a flower, a bug, or whatever. <br><img src="http://img585.imageshack.us/img585/4563/40559571.jpg" alt="image"><br>  Then we solder the LED to the mikruh, common on the 4th leg (ground), red to the 5th, blue to the 6th, green to the 7th (the color arrangement matters, because for the green the software brightness correction is used) . <br><img src="http://img21.imageshack.us/img21/9162/47382670.jpg" alt="image"><br>  Well that's all!  Boldly and smartly insert the battery - 3 colors will light up one by one, each for 1 second.  During this time, you must remove your hands from the device, because then the sensor calibration starts immediately, which is signaled to us by a flashing blink for about 4 seconds.  During this period, the sensor state is recorded when it is not touched.  After the illumination is over, you can take the firefly in your hands and watch the fascinating colors, the play of light and halftones. <br><br>  If you are still not running to the nearest electronics store for details, then I would like to give you a clue to the focus, i.e.  how it all works.  Also, perhaps, something will seem interesting to those who are in the subject.  As I already wrote, the basis of the design was the above article.  Therefore, I refer you to the description of the fundamentals and the work of the sensor, everything is very well chewed there.  My improvement is connecting to the RGB and refactoring code.  Let me explain in more detail: the 13th tinkle is, of course, beautiful, but only the PWM hardware channels have only 2 channels, and for controlling the RGB LED, as Cap suggests, you need at least 3 channels.  This raises the question: where to get another PWM channel?  When asked if there is an answer to a simple one, we won‚Äôt look for another PWM, and we‚Äôre not going to use hardware shim at all, but write down our own program PWM - Orthodox, just like a channel!  From loud slogans we turn to real practice.  I hope that such PWM, duty cycle, no need to explain? (Rhetorical question). <br>  So, given: <br>  1. The frequency of the PWM channel - at least 100 Hz, in fact, the eye and from 50 blink practically does not notice, but the real guys less than 100 do not look.  So  pulse duration with a duty cycle of 100% should be 10 ms.  In these 10 ms we have to push the brightness adjustment, at least 100 levels.  Then we find that the minimum pulse duration is 0.1 ms (at a duty cycle of 1%). <br>  2. The frequency of the microcontroller's internal timer depends on a) the frequency of the clock generator, which, since  we use internal, maybe 4.8 or 9.6 MHz;  b) clock generator divider;  c) the divider of the timer itself.  Using the timer, we should be able to count down the intervals of 0.1 ms, i.e.  handle events at a frequency of at least 10 kHz. <br>  In short, as a result of theoretical and empirical research, such results were obtained.  The clock frequency of the controller is 9.6 MHz, the timer works with a division of 1/256 = at a frequency of 37.5 KHz.  In order to be able to handle events at this frequency, we set the timer operation mode by triggering by coincidence.  Those.  as soon as the timer counter coincides with the value set in the ORCA0 register, an interrupt occurs - and here we are.  In this case, the set value of the ORCA0 register, as some of you have already guessed, should be 0. Brightness will not be adjusted by 100, but by 256 levels (the controller is 8-bit, so it is more convenient, and more shades), then we get the frequency PWM 37500/256 = 146 Hz, which is more than satisfactory. <br>  Consider the interrupt processing in more detail: <br><br> <code>//  <br> unsigned char wave_counter=0;//   <br> <br> unsigned char red_bs=0;// 1 (0-255) <br> unsigned char green_bs=0;// 2 (0-255) <br> unsigned char blue_bs=0;// 3 (0-255) <br> <br> interrupt [TIM0_COMPA] void timer0_compa_isr(void) <br> { <br> PORTB.RED=(wave_counter&lt;red_bs); <br> PORTB.GREEN=(wave_counter/2&lt;green_bs); <br> PORTB.BLUE=(wave_counter&lt;blue_bs); <br> wave_counter++; <br> }</code> <br> <br>  The brightness of each LED is set by global variables red_bs, green_bs, blue_bs and is changed by the main program according to the special effects plan.  The wave_counter counter rotates in a circle.  When the brightness of the LED is greater than the value of the counter, it lights up, otherwise it is extinguished.  So  if the brightness is 255, then this corresponds to a 100% duty cycle.  I did the division by 2 in the green LED in order to increase its brightness, because  its visual luminosity turned out to be less than the others, apparently the specificity of the spectral characteristics.  In general, gourmets and interested can appreciate the entire <a href="http://pastebin.com/RP5UeuMt">source</a> . <br>  Much more could be written about adjusting the overall brightness, processing the sensor, the size of the program and the memory (oh, darling, here's another sore point), setting the watchdog timer and low power mode (by the way, as shown by , in hibernation, the circuit eats 0.06 mA) ... It would be possible to attach oscillograms to increase visibility and clarity for beginners, discuss the use of the rand () function and debate about contrasting the advantages of programming in assembler with convenience and power  tion CodeVisionAVR compiler code.  But, as the unforgettable Kozma Prutkov used to say: ‚ÄúYou can‚Äôt grasp the immensity,‚Äù and popular wisdom says, ‚ÄúHave a good time.‚Äù  I hope I will still have the opportunity to share with you delights in this area, which I also wish you, professional, creative and every success. <br>  Present ladies - with the coming! </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/139568/">https://habr.com/ru/post/139568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139560/index.html">The Tale of wx.Python</a></li>
<li><a href="../139562/index.html">Android Market is no more</a></li>
<li><a href="../139564/index.html">Adobe Shadow - make the development of mobile sites easier and faster.</a></li>
<li><a href="../139566/index.html">IT Louvre</a></li>
<li><a href="../139567/index.html">Officially presented Xeon E5 processors and servers on them from major manufacturers</a></li>
<li><a href="../139570/index.html">Developer Connection - a new site for InterSystems developers</a></li>
<li><a href="../139572/index.html">Google continues to be entertained</a></li>
<li><a href="../139573/index.html">COBOL: in search of fresh blood</a></li>
<li><a href="../139575/index.html">What awaits us in the Joomla Framework 12.1</a></li>
<li><a href="../139576/index.html">onlineMerchant: a convenient payment solution for online stores. Part I</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>