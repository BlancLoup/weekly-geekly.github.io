<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing an Openfire server on Debian in the AD2008 domain with transparent user authorization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 I want to share the experience of installing an Openfire server on Debian in the AD Windows Server 2008 domain using SSO by the Spark client...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing an Openfire server on Debian in the AD2008 domain with transparent user authorization</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  I want to share the experience of installing an <a href="http://www.igniterealtime.org/projects/index.jsp">Openfire</a> server on <a href="http://www.debian.org/">Debian</a> in the AD Windows Server 2008 domain using SSO by the Spark client. <br><br>  The installation itself is simple and takes a little time, the main difficulties for me arose when setting up kerberos authorization of the entire software bundle. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Infrastructure: <br>  Openfire 3.8.2 is installed on Debian 7.0 "Wheezy" x64 using MySQL DBMS. <br>  Debian server name: openfireserver. <br>  Active Directory is deployed on Windows 2008 Server Standard (Kerberos uses RC4-HMAC-NT encryption by default). <br>  Domain realm.local. <br>  Workstations Windows XP Pro and Windows 7 Pro x32 / x64 with the Spark 2.6.3 client installed. <br><a name="habracut"></a><br><br>  Installation step by step (MySQL, Samba, Sun / Oracle Java are already preinstalled on Debian): <br><br>  1) Login as root. <br><br>  2) Check the pre-installed software: <br><pre>  # cat / etc / issue </pre><br>  Debian GNU / Linux 7.0 \ n \ l <br><br><pre>  # smbd -V </pre><br>  Version 3.6.6 <br><br><pre>  # mysql -V </pre><br>  mysql Ver 14.14 Distrib 5.5.31, for debian-linux-gnu (x86_64) using readline 6.2 <br><br><pre>  # java -version </pre><br>  java version "1.7.0_21" <br>  Java (TM) SE Runtime Environment (build 1.7.0_21-b11) <br>  Java HotSpot (TM) 64-Bit VM Server (build 23.21-b01, mixed mode) <br><br>  3) Create the database ‚Äúopenfire‚Äù and the MySQL user ‚Äúopenfire‚Äù: <br><pre>  # mysql -p </pre><br>  Enter password: [type root user password in MySQL] <br>  Welcome to the MySQL monitor.  Commands end with;  or \ g. <br>  Your MySQL connection id is 49 <br>  Server version: 5.5.31-0 + wheezy1 (Debian) <br>  Copyright 2000, 2013, Oracle and / or its affiliates.  All rights reserved. <br>  Oracle is a registered trademark of Oracle Corporation and / or its <br>  affiliates.  Other names may be trademarks of their respective <br>  owners. <br>  Type 'help;'  or '\ h' for help.  Type '\ c' to clear the current input statement. <br><br><pre>  mysql&gt; CREATE DATABASE openfire; </pre><br>  Query OK, 1 row affected (0.00 sec) <br><br><pre>  mysql&gt; GRANT ALL PRIVILEGES ON openfire. * TO 'openfire' @ 'localhost' IDENTIFIED BY 'PasswordGoldFish' WITH GRANT OPTION; </pre><br>  Query OK, 0 rows affected (0.00 sec) <br><br><pre>  mysql&gt; FLUSH PRIVILEGES; </pre><br>  Query OK, 0 rows affected (0.00 sec) <br><br><pre>  mysql&gt; exit </pre><br>  Bye <br><br>  4) Download and install the Openfire server. <br><pre>  # cd / tmp
 # wget http://www.igniterealtime.org/downloadServlet?filename=openfire/openfire_3.8.2_all.deb </pre><br>  100% [===================================&gt;] 12,838,026 2.92M / s for 7, 6s <br>  2013-05-28 12:58:04 (1.62 MB / s) - ‚ÄúdownloadServlet? Filename = openfire% 2Fopenfire_3.8.2_all.deb‚Äù saved [12838026/12838026] <br><pre>  / tmp # cp downloadServlet \? filename \ = openfire% 2Fopenfire_3.8.1_all.deb openfire_3.8.2_all.deb
 / tmp # rm downloadServlet \? filename \ = openfire% 2Fopenfire_3.8.2_all.deb
 / tmp # dpkg -i openfire_3.8.2_all.deb </pre><br>  Warning: / var / lib / openfire <br>  Starting openfire: openfire <br><br><pre>  # /etc/init.d/openfire stop </pre><br>  Stopping openfire: openfire. <br><br>  Change the owner: <br><pre>  # chown -R openfire: openfire / var / lib / openfire

 # /etc/init.d/openfire start </pre><br>  Starting openfire: openfire. <br><br>  5) Go to the browser at the address (I use Mozilla Firefox): <br>  <a href="http://openfireserver:9090/">http: // openfireserver: 9090</a> <br>  Choose the language (Russian translation of the curve, I left English) <br>  Type in Domain name: openfireserver.realm.local <br>  Next, select "Standard Database Conncection" <br>  Choose Preset MySQL <br>  Fix [hostname] on localhost and [database-name] on openfire <br>  We collect Username: openfire <br>  Type Password: PasswordGoldFish <br>  Click "Continue" <br>  Profile Setup, Step 1: <br>  Choose "Directory Server (LDAP)" <br>  Choose Server Type: Active Directory <br>  We type Host: realm.local <br>  Type Base DN: ou = Jabber, ou = Company_Users, dc = realm, dc = local <br>  We type Administrator DN: cn = LDAP, cn = Users, dc = realm, dc = local <br>  Type Password: Password_LDAP <br>  For this step, I previously created a user in AD with the name LDAP and perpetual password: Password_LDAP <br>  Save and continue. <br>  Steps 2 and 3 remain unchanged. <br>  We add Openfire administrators, it can be any users from Base DN. <br>  Just type their logins and click "Add". <br>  If users are successfully added, click "Continue". <br><br>  This completes the installation of Openfire, you can go to the administrator console. <br>  If you go to the Users section, you can see that all users from the Base DN are already there. <br>  Everything is already working and the user can authenticate in the usual way, but my goal is SSO (the main problem is to lock accounts in AD after changing the password). <br>  For this we go further ... <br><br>  6) Configure Samba: <br><pre>  # nano /etc/samba/smb.conf </pre><br><pre>  [global]
    workgroup = REALM
    realm = REALM.LOCAL
    security = ADS
    encrypt passwords = true
    dns proxy = no
    socket options = TCP_NODELAY
    kerberos method = secrets and keytab
    winbind refresh tickets = yes
    password server = realm.local
    domain master = no
    local master = no
    preferred master = no
    os level = 0
    domain logons = no
    load printers = no
    show add printer wizard = no
    printcap name = / dev / null
    disable spoolss = yes </pre><br><br>  7) Configure Kerberos: <br><pre>  # nano /etc/krb5.conf </pre><br><pre>  [libdefaults]
         default_realm = REALM.LOCAL
         kdc_timesync = 1
         forwardable = true
         proxiable = true
         default_tkt_enctypes = rc4-hmac des3-cbc-sha1 des-cbc-crc des-cbc-md5
         default_tgs_enctypes = rc4-hmac des3-cbc-sha1 des-cbc-crc des-cbc-md5
         permitted_enctypes = rc4-hmac des3-cbc-sha1 des-cbc-crc des-cbc-md5
 [realms]
         REALM.LOCAL = {
                 kdc = realm.local
                 admin_server = realm.local
                 default_domain = REALM.LOCAL
         }
 [domain_realm]
         .realm.local = REALM.LOCAL
         realm.local = REALM.LOCAL
</pre><br><br>  8) Restart Samba <br><pre>  # /etc/init.d/samba restart </pre><br><br>  9) We join the Debian server to AD: <br><pre>  # net ads join -U DomainAdminAccount -D REALM.LOCAL </pre><br>  or <br><br><pre>  # net rpc join -U DomainAdminAccount </pre><br><br>  10) Check how joined: <br><pre>  # net ads testjoin </pre><br>  Join is OK <br><br><pre>  # net rpc testjoin </pre><br>  Join to 'REALM' is OK <br><br>  11) DNS check: <br><pre>  # nslookup
 &gt; openfireserver </pre><br>  Server: 192.168.1.1 <br>  Address: 192.168.1.1 # 53 <br>  Name: openfireserver.realm.local <br>  Address: 192.168.1.22 <br><br><pre>  &gt; 192.168.1.22 </pre><br>  Server: 192.168.1.1 <br>  Address: 192.168.1.1 # 53 <br>  22.1.168.192.in-addr.arpa name = openfireserver.realm.local. <br><br><pre>  &gt; exit </pre><br><br>  The following five steps are performed on a Windows Server 2008 domain controller: <br><br>  12) Create an xmpp-openfire user in AD with perpetual password and the option ‚ÄúDo not require Kerberos preauthentication‚Äù enabled (Without Kerberos pre-authentication). <br><br>  13) Create an SPN and associate it with the user xmpp-openfire: <br>  Run the command prompt with Administrator privileges. <br><pre>  &gt; setspn -A xmpp/openfireserver.realm.local@REALM.LOCAL xmpp-openfire
 &gt; ktpass -princ xmpp/openfireserver.realm.local@REALM.LOCAL -mapuser xmpp-openfire@realm.local -pass * -ptype KRB5_NT_PRINCIPAL
</pre><br>  Enter the password for the user xmpp-openfire. <br><br>  14) If we use the JRE to generate the keytab file, then create the file C: \ Windows \ krb5.ini with the contents: <br><pre>  [libdefaults]
     default_realm = REALM.LOCAL
 [realms]
     REALM.LOCAL = {
         kdc = realm.local
         admin_server = realm.local
         default_domain = REALM.LOCAL
     }
 [domain_realm]
     .realm.local = REALM.LOCAL
     realm.local = REALM.LOCAL </pre><br><br>  15) Create a keytab file (Sun / Oracle JRE6 must be installed): <br><pre>  cd C: \ Program Files (x86) \ Java \ jre6 \ bin&gt;
 C: \ Program Files (x86) \ Java \ jre6 \ bin&gt; ktab -k xmpp.keytab -a xmpp/openfireserver.realm.local@REALM.LOCAL </pre><br>  Enter the password for the user xmpp-openfire. <br><br>  Or you can use another way, without JRE <br><pre>  &gt; ktpass -princ xmpp/openfireserver.realm.local@REALM.LOCAL-mapuser xmpp-openfire@realm.local -pass * -ptype KRB5_NT_PRINCIPAL-out xmpp.keytab </pre><br>  Enter the password for the user xmpp-openfire. <br><br>  16) Check the generated keytab file (need JRE): <br><pre>  C: \ Program Files (x86) \ Java \ jre6 \ bin&gt; kinit -k -t xmpp.keytab xmpp/openfireserver.realm.local@REALM.LOCAL </pre><br><br>  17) Transferring the verified xmpp.keytab file to the Debian server in / usr / share / openfire / resources <br>  Change the owner: <br><pre>  # chown openfire: openfire xmpp.keytab </pre><br><br>  18) Check the xmpp.keytab file on the Debian server: <br><pre>  # kinit -V -k -t /usr/share/openfire/resources/xmpp.keytab xmpp/openfireserver.realm.local@REALM.LOCAL </pre><br><br>  19) Create a \ etc \ openfire \ gss.conf file with the contents on the Debian server: <br><pre>  com.sun.security.jgss.accept {
     com.sun.security.auth.module.Krb5LoginModule
     required
     storeKey = true
     keyTab = "/ usr / share / openfire / resources / xmpp.keytab"
     doNotPrompt = true
     useKeyTab = true
     realm = "REALM.LOCAL"
     principal = "xmpp/openfireserver.realm.local@REALM.LOCAL"
     isInitiator = false
     debug = true;
 }; </pre><br><br>  20) Go to the browser in the Openfire admin console and in the System properties section add parameters: <br>  sasl.gssapi.config = /etc/openfire/gss.conf <br>  sasl.gssapi.debug = false <br>  sasl.gssapi.useSubjectCredsOnly = false <br>  sasl.mechs = GSSAPI <br>  sasl.realm = REALM.LOCAL <br>  xmpp.fqdn = openfireserver.realm.local <br><br>  21) Restart Openfire <br><pre>  # /etc/init.d/openfire restart </pre><br><br>  22) Installing Spark 2.6.3 with JRE on Jabber client workstations. <br><br>  23) Rule the registry: <br>  In section <br>  HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Control \ Lsa \ Kerberos \ Parameters <br>  (For XP: HKEY_LOCAL_MACHINE \ System \ CurrentControlSet \ Control \ Lsa \ Kerberos) <br>  add a DWORD value <br>  AllowTGTSessionKey with a value of 1. <br><br>  24) Create a kbd5.ini file in C: \ Windows with the contents: <br><pre>  [libdefaults]
     default_realm = REALM.LOCAL
     default_tkt_enctypes = rc4-hmac
     default_tgs_enctypes = rc4-hmac
 [realms]
     REALM.LOCAL = {
         kdc = realm.local
         admin_server = realm.local
         default_domain = REALM.LOCAL
     }
 [domain_realm]
     .realm.local = REALM.LOCAL
     realm.local = REALM.LOCAL </pre><br><br>  25) Reboot the workstation. <br><br>  26) In Spark, select the option ‚ÄúUse Single Sign-On (SSO) via GSSAPI‚Äù, type openfireserver in the ‚ÄúServer‚Äù field and connect. <br><br>  There are no problems in Windows XP, but in Windows 7 SSO in Spark works out of the box only with unprivileged users. <br>  If you are working as an administrator, start Spark as Administrator or disable UAC. <br><br>  Good luck! <br><br>  As the development of the product should continue ... </div><p>Source: <a href="https://habr.com/ru/post/181374/">https://habr.com/ru/post/181374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../181356/index.html">Fundamental problems of the economy on Bitcoin</a></li>
<li><a href="../181362/index.html">Overview of the Philips Shoqbox SB7300 Portable Audio System</a></li>
<li><a href="../181366/index.html">Runetology (200): Maxim Spiridonov, CEO of the Netology Education Center</a></li>
<li><a href="../181368/index.html">The secret ingredient is a good architect.</a></li>
<li><a href="../181372/index.html">You are dangerously incompetent in cryptography</a></li>
<li><a href="../181378/index.html">Merge Duplicates in Oracle</a></li>
<li><a href="../181384/index.html">Again "sea battle". Count the number of possible ship locations</a></li>
<li><a href="../181386/index.html">In the video editor Youtube function appeared intellectual slowing down time</a></li>
<li><a href="../181388/index.html">Convenient "chips" to work with designers</a></li>
<li><a href="../181392/index.html">Are you registered on public services?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>