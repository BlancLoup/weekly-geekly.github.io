<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We develop habraklaviatura under iOS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Often for reading Habr I use Habrahabr mobile application for iPhone and iPad. It is quite convenient for reading articles, but not very convenient fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We develop habraklaviatura under iOS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/914/91f/fc1/91491ffc1c97423b8f1902fd9d263452.png" align="left"><br>  Often for reading Habr I use Habrahabr mobile application for iPhone and iPad.  It is quite convenient for reading articles, but not very convenient for writing comments, especially if you want to write something like that, using the formatting tags.  It is inconvenient, because all tags must be typed manually, so it is very easy to make a mistake and, as a result, leave an ugly comment. <br><br>  So I had an idea to write my own keyboard, in which, by pressing a key, an opening and closing tag is added to the text field.  The cursor should be right between them in order to immediately start writing the text.  It is also necessary to be able to move the cursor using swipe gestures, subjectively, it is more convenient than pulling a finger to the field, waiting for the magnifying glass to appear, moving the finger and hoping that the cursor gets where it should be.  And finally, it's time to deal with the tags "Sarcasm" and "Bore", which are not supported by the habr parser.  The keyboard must have special keys for this purpose, and the design of the tags must be configurable in the keyboard settings so that everyone can specify the look that they like. <br><br>  With the release of iOS 8, Apple opens a new API that allows you to develop extensions to applications.  Keyboard (Custom Keyboard) is one of the representatives of such extensions.  About her and will be discussed.  In the article, you will learn about what features, limitations and bugs are provided by the new API, how to develop a custom keyboard, and how to make your keyboard appear in the AppStore, and therefore on the devices of your users. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Features and limitations </h4><br>  Opening access to the API for creating third-party keyboards, Apple built a narrow bridge between applications.  On the one hand, each application is still in its sandbox, but on the other hand, the data entered in one application can now be transferred to another, or sent directly to the server.  This functionality is quite serious in terms of the security of user data, so Apple has strictly defined what can and cannot be done.  Before turning to the detailed description, I want to clarify that all types of extensions, including the keyboard, can be installed on a mobile device only as part of the main application (container application).  For example, an extension in the form of a widget in the Notification Center was added to the latest version of the Habrahabr application. <br><br>  And so, what opportunities do we have: <br><ul><li>  The third-party keyboard can be used in almost any application installed on the device.  To do this, the user must personally add the installed keyboard in the device settings.  Fortunately, application developers can prohibit the use of third-party keyboards in their applications, but more on that later; </li><li>  The keyboard can exchange data with both the container application and the developer server.  The permission of such an exchange is configured by the user, and this feature is initially disabled; </li><li>  The keyboard can have access to the geolocation and address book service.  To gain access, user permission is required both in the keyboard settings and in the corresponding service settings; </li><li>  The keyboard can refer to the built-in dictionary to display options for auto-correction and auto-completion of the entered text.  Data is taken from the following sources: <ol><li>  The address book of the device (first and last names are provided indistinctly); </li><li>  The abbreviations indicated by the user in the settings of the smartphone; </li><li>  General dictionary. </li></ol></li></ul><br>  This, in fact, all the basic features.  Let's pass to restrictions: <br><ul><li>  You can not inherit from the standard keyboard.  That is, to take the built-in keyboard as a basis and add gesture processing to control the cursor in it does not work, you have to do everything from scratch.  Moreover, the standard keyboard cannot be recreated in principle.  The reasons are described in the following clauses; </li><li>  A third-party keyboard, like other types of extensions, does not have access to the microphone, which makes it impossible to support voice input; </li><li> A third-party keyboard cannot be used to enter hidden text ( <code>secureTextEntry = YES</code> ).  That is, if the field is intended for entering a password, then the user will be able to use only the standard keyboard; </li><li>  Custom keyboard cannot be used for fields with type <code>UIKeyboardTypePhonePad</code> and <code>UIKeyboardTypeNamePhonePad</code> ; </li><li>  The keyboard does not have access to text selection in the input field.  That is, changing the selection without user intervention will not work; </li><li>  Unlike the standard keyboard, in a third-party keyboard it‚Äôs impossible to get out of the frame.  That is, you cannot display anything above the keyboard, such as by long pressing the keys on the top row of a standard keyboard; </li><li>  Developers can prohibit the use of third-party keyboards in their applications.  To do this, you must override the <code>application:shouldAllowExtensionPointIdentifier:</code> method <code>application:shouldAllowExtensionPointIdentifier:</code> protocol.  For an identifier named <code>UIApplicationKeyboardExtensionPointIdentifier</code> you must return <code>NO</code> .  By the way, for iOS 8 it is the only type of extensions that can be prohibited to use. </li></ul><br>  Full <a href="https://developer.apple.com/library/prerelease/ios/documentation/General/Conceptual/ExtensibilityPG/Keyboard.html">Custom Keyboard</a> Development Documentation: <a href="https://developer.apple.com/library/prerelease/ios/documentation/General/Conceptual/ExtensibilityPG/Keyboard.html">Custom Keyboard</a> <br><br><h4>  Habraklaviatura </h4><br>  With the theory figured out, go to the practice. <br>  Create a new project, select Application, everything is standard. <br><img src="https://habrastorage.org/files/17a/7fa/467/17a7fa46730e4b49bf1287a0ef21e29a.png"><br><br>  Next, you need to add a new Target "Custom Keyboard". <br><img src="https://habrastorage.org/files/737/116/c88/737116c881b245e682af3ba9fc5cac4d.png"><br><br>  As a result, Xcode generates a descendant class from <code>UIInputViewController</code> and <code>Info.plist</code> . <br>  The <code>UIInputViewController</code> class is a keyboard controller.  All interaction with the input field occurs through it.  Consider the class interface in more detail. <br>  Basic methods: <br><ul><li>  <code>- (void)dismissKeyboard</code> - allows you to hide the keyboard.  This is an opportunity that is absent in all standard keyboards on the iPhone; </li><li>  <code>- (void)advanceToNextInputMode</code> ‚Äî performs the display of the next keyboard.  The list of available keyboards is defined by the user in the device settings; </li><li>  <code>- (void)requestSupplementaryLexiconWithCompletion:(void (^)(UILexicon *))completionHandler</code> ‚Äî Provides an array of pairs of strings.  Each pair consists of a line that the <code>userInput</code> user can enter and a line that is autocompletion or autocorrection of <code>documentText</code> .  For example, on my iPhone, this method returns 151 pairs. </li></ul><br>  To interact with the field, the <code>textDocumentProxy</code> property is <code>textDocumentProxy</code> .  I will describe only the most important for the development of methods: <br><ul><li>  <code>- (void)adjustTextPositionByCharacterOffset:(NSInteger)offset</code> - allows you to control the cursor; </li><li>  <code>- (NSString *)documentContextBeforeInput</code> - returns the string up to the cursor; </li><li>  <code>- (NSString *)documentContextAfterInput</code> - returns the string after the cursor; </li><li>  <code>- (void)insertText:(NSString *)text</code> - inserts a string after the cursor; </li><li>  <code>- (void)deleteBackward</code> - deletes one character before the cursor; </li><li>  <code>- (UIKeyboardAppearance)keyboardAppearance</code> - allows you to determine which theme is used: light or dark; </li><li>  <code>- (UIKeyboardType)keyboardType</code> - allows you to determine which type of keyboard requires an input field. </li></ul><br>  In addition to the methods described above, the <code>UIInputViewController</code> class implements the <code>UITextInputDelegate</code> protocol: <br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITextInputDelegate</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class">&gt; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">selectionWillChange</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITextInput</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textInput</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">selectionDidChange</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITextInput</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textInput</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textWillChange</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITextInput</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textInput</span></span></span><span class="hljs-class">; - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textDidChange</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UITextInput</span></span></span><span class="hljs-class">&gt;)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">textInput</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Calls to these methods must report the selection and modification of text in the input field, and the <code>textInput</code> object must provide information about the input field itself and the text it contains. <br>  But in fact, we have the following behavior: <br><ul><li>  The first two methods are never invoked, regardless of whether the user selects text or not; </li><li>  The last two methods are called, but the <code>textInput</code> object is always <code>nil</code> . </li></ul><br>  It looks like a bug.  On Stackoverflow, people write that they have encountered the same problem, there is no solution.  I want to note that the above described behavior is reproduced on the release version of iOS8. <br><br>  The second point of contact for the developer is the <code>Info.plist</code> file.  In addition to the already known fields, it contains the <code>NSExtension</code> group: <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>NSExtension<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dict</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>NSExtensionAttributes<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dict</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>IsASCIICapable<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">false</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>PrefersRightToLeft<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">false</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>PrimaryLanguage<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>RequestsOpenAccess<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">false</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dict</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>NSExtensionPointIdentifier<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>com.apple.keyboard-service<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span>NSExtensionPrincipalClass<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">key</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span>VPKeyboardViewController<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dict</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  It indicates the type of extension being developed, the name of the controller class, and the attributes.  Note the <code>RequestsOpenAccess</code> attribute.  With its help, the system understands whether you need advanced access: data exchange with a container application or server, access to geolocation and address book.  If you specify <code>true</code> , then be prepared to explain to Apple what you need it all for. <br><br>  This completes the introduction to the API and proceeds to direct development. <br>  To begin with, we define a layout.  I planned to implement support for portrait and landscape orientations for the iPhone and eventually work out for the iPad.  The layout for portrait and landscape orientations should have been slightly different.  For these purposes, the newly created <a href="http://habrahabr.ru/post/235181/">Sizes Classes</a> technology was perfectly suited.  Why am I writing in the past tense?  Yes, because all plans failed.  The fact is that regardless of the orientation, the system assigns us the same Size Classes: wCompact and hCompact, which corresponds to the landscape orientation for the iPhone.  Most likely this is due to the fact that the keyboard frame does not occupy the entire screen, but only the bottom half.  In principle, this is a logical behavior, and to get around this problem, you can manually assign an arbitrary Size Class to the controller.  To do this, use the <code>setOverrideTraitCollection:forChildViewController:</code> method.  But it was not there, in fact, the call of this method does not affect anything, that is, the <code>UITraitCollection</code> child controller remains unchanged.  If any of you have had a positive experience using this method, please share them.  I flooded the version of the code with the above described behavior in a separate brunch, if someone is interested you can pick it up.  Until the problem is solved, we will be satisfied with one layout for all orientations: <br><img src="https://habrastorage.org/files/009/fc9/018/009fc90180c64afca4dab74b0ad00994.gif"><br><br>  For the convenience of controlling the cursor, let's add the recognition of Swipe gestures.  We add two <code>UISwipeGestureRecognizer</code> objects to <code>UISwipeGestureRecognizer</code> , in the code we implement event handlers: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onLeftSwipeRecognized:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy.documentContextBeforeInput.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy adjustTextPositionByCharacterOffset:<span class="hljs-number"><span class="hljs-number">-1</span></span>]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onRightSwipeRecognized:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy.documentContextAfterInput.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy adjustTextPositionByCharacterOffset:<span class="hljs-number"><span class="hljs-number">1</span></span>]; } }</code> </pre><br>  Next, add handlers to close the keyboard and go to the next: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onNextInputModeButtonPressed:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> advanceToNextInputMode]; } - (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onDismissKeyboardButtonPressed:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> dismissKeyboard]; }</code> </pre><br>  To delete the entered text, we implement two possibilities: <br><ol><li>  Delete the last character before the cursor, as in a standard keyboard: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onDeleteButtonPressed:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy.documentContextBeforeInput.length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy deleteBackward]; } }</code> </pre></li><li>  Deletes all entered text regardless of cursor position.  To avoid accidental deletion of text, we will use <code>UILongTapGestureRecognizer</code> : <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onClearButtonPressed:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> endPositionOffset = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy.documentContextAfterInput.length; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy adjustTextPositionByCharacterOffset:endPositionOffset]; dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number"><span class="hljs-number">0.1</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">NSEC_PER_SEC</span></span>)), dispatch_get_main_queue(), ^{ <span class="hljs-comment"><span class="hljs-comment">// We can't know when text position adjustment is finished // Hack: Call this code after delay. In other case these changes won't be applied while (self.textDocumentProxy.documentContextBeforeInput.length &gt; 0) { [self.textDocumentProxy deleteBackward]; } }); }</span></span></code> </pre><br>  To achieve the goal, you have to use a hack with the execution of the code with a delay.  The fact is that the API allows you to delete text just before the cursor.  That is, in order to delete all the text, you must first move the cursor to the end of the line, but the moving process itself is asynchronous, at the same time I did not find an opportunity to find out the time point when this process was completed.  Therefore, we set a delay of 0.1 seconds and believe that the cursor has reached its goal. </li></ol><br>  It remains to figure out for what we actually gathered here: with the introduction of formatting tags. <br>  To store standard tags that are supported by Habrom, we will use the JSON file: <br><pre> <code class="xml hljs">{ "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">i</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">u</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">s</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">blockquote</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">blockquote</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">code</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">\</span></span></span><span class="hljs-tag">"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http:</span></span></span><span class="hljs-tag">//\"&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">\</span></span></span><span class="hljs-tag">"</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http:</span></span></span><span class="hljs-tag">//\"/&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag">&gt;</span></span>http://<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">video</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spoiler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">\</span></span></span><span class="hljs-tag">"\"&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spoiler</span></span></span><span class="hljs-tag">&gt;</span></span>", "": "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hh</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">\</span></span></span><span class="hljs-tag">"\"/&gt;</span></span>" }</code> </pre><br><br>  For the tags "Sarcasm" and "Bore" you need to create settings so that each user can set the values ‚Äã‚Äãfor the opening and closing tags.  Add Settings Bundle: <br><img src="https://habrastorage.org/files/a70/4ae/0ec/a704ae0ec36e40b9a94b0c5382524cb9.png"><br><br>  Go to Settings.bundle -&gt; Root.plist and fill in all the required fields.  Below is the source code of the settings and what the user should see: <br><img src="https://habrastorage.org/files/a66/629/b45/a66629b4588a477f970613a582377a90.png"><br><br>  But in reality, when installing the keyboard, the values ‚Äã‚Äãfor the tags are not displayed, that is, in fact, the fields are empty.  These fields are set by the <code>Default Value</code> key.  At first, I thought I was doing something wrong.  But even if you enter the settings and manually fill in these fields, then when you exit the settings, the values ‚Äã‚Äãare not saved.  This is a bug.  Other users faced a similar problem, several topics on Stackoverflow confirm this, that is, the problem is not local.  It seems that the developers forgot to call the <code>synchronize</code> method on the <code>NSUserDefaults</code> object.  Sadly, it only remains to wait for an update to iOS 8.1 or iOS 8.0.1.  To take into account this problem, I use the default values ‚Äã‚Äãin the code, if the settings could not be loaded. <br><br>  With the storage of tags figured out, now we will write a keystroke handler to add tags to the input field: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)onHabraButtonPressed:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *tagKey = [sender titleForState:<span class="hljs-built_in"><span class="hljs-built_in">UIControlStateNormal</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *tagValue = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.tagsDictionary[tagKey]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.textDocumentProxy insertText:tagValue]; dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(<span class="hljs-number"><span class="hljs-number">0.1</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">NSEC_PER_SEC</span></span>)), dispatch_get_main_queue(), ^{ <span class="hljs-comment"><span class="hljs-comment">// We can't know when text insert is finished // Hack: Call this code after delay. In other case these changes won't be applied [self moveTextPositionToInputPointForTag:tagValue]; }); } - (void)moveTextPositionToInputPointForTag:(NSString *)tag { static NSArray *inputPointLabels = nil; if (inputPointLabels == nil) { inputPointLabels = @[@"]", @"://", @"=\"", @"&gt;"]; } for (NSString *label in inputPointLabels) { NSRange labelRange = [tag rangeOfString:label]; if (labelRange.location != NSNotFound) { NSInteger offset = labelRange.location + labelRange.length - tag.length; [self.textDocumentProxy adjustTextPositionByCharacterOffset:offset]; break; } } }</span></span></code> </pre><br>  It uses the previously described hack with delayed code execution.  It is connected with the same cursor.  When we call the <code>insertText:</code> method <code>insertText:</code> cursor does not move instantaneously, and this must be taken into account.  To explain why we need to take into account the offset of the cursor, let me give an example: let's say we want to add a link to a Habrayuser.  For this you need to add a tag <hh>  and then enter the username between the quotes.  For convenience, I made it so that the cursor is automatically positioned between the quotes.  Similarly for other tags.  For these purposes, the above-described <code>moveTextPositionToInputPointForTag:</code> method is <code>moveTextPositionToInputPointForTag:</code> , which, using an array of label strings, determines the position to which the cursor should be placed. <br><br>  Implementation completed, select the extension as the active schema and run.  For ease of debugging, I recommend to go to the "Edit Scheme" and tick off the "Debug executable".  This will allow you to simultaneously debug both the extension and the main application: <br><img src="https://habrastorage.org/files/656/676/c53/656676c53bf14d1fa9d6e693cf68c78e.png"><br><br>  To install the keyboard, go to Settings -&gt; General -&gt; Keyboard -&gt; Keyboards -&gt; New Keyboards ... <br><img src="https://habrastorage.org/files/84f/4a0/48d/84f4a048d8184670bc19d8e758276371.png"><br><br>  The screenshot on the right shows the dialog that is displayed when the user tries to allow full keyboard access.  To tell the truth, this text tells me to choose ‚ÄúDo not allow‚Äù. <br><br>  As a bonus, I want to show the hierarchy with a standard keyboard view.  I will leave the comments with myself, let everyone draw their own conclusions: <br><img src="https://habrastorage.org/files/77d/ca5/92c/77dca592c5b14957ba8f70f709cd1086.png"><br><br>  The full version of the source code is available on GitHub: <a href="https://github.com/Visput/Habrakeyboard">Habrakeyboard</a> <br><br><h4>  Demonstration </h4><br><img src="https://habrastorage.org/files/b60/a86/999/b60a86999e7a471e9b4b9819a40572d1.gif"><br><br><h4>  Publication </h4><br>  The process of publishing, like keyboards and other types of extensions, is practically no different from the publication of a regular application, but the extension itself must meet certain technical requirements: <br><ul><li>  An extension can only be published as part of a container application.  Alone it cannot exist.  It is deleted when the application is deleted.  By the way, this restriction is only for iOS.  For Mac, the extension can be distributed separately; </li><li>  Deployment Target for the extension should be&gt; = iOS 8.0.  The main application can also be published for earlier versions of the operating system.  In older versions, the extension will simply not be available.  That is, if, for example, the developers of the Habrahabr application want to implement something like this, then it will not be necessary to increase the Deployment Target; </li><li>  Target for expansion should contain a setting for assembly for processors with 64-bit architecture (arm64).  If the application implements the data exchange with the extension, then it must meet the same requirements.  Anyway, but you need to think about the support of 64-bit processors.  For large projects with complex low-level code, this may require considerable labor costs. </li></ul><br>  Apple also added several new items to a document with recommendations for reviewing.  They are specific to ‚ÄúKeyboard‚Äù extensions: <br><ul><li>  Opening your keyboard, the user should be able to go to the next; </li><li>  The keyboard must remain operational in the absence of an Internet connection; </li><li>  The keyboard should implement the following types of keyboards: Number and Decimal (that is, if the input field implies entering a number, then the keyboard should provide a convenient method for this); </li><li>  The main category for an application that contains a keyboard extension should be Utilities.  Also, the application must provide the user with its own privacy policy; </li><li>  The keyboard should use user data only to improve its functionality. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Recommendations in the original</b> <div class="spoiler_text"><ul><li>  Keyboard extensions must be provided for the next keyboard; </li><li>  Keyboard extensions must remain functional; </li><li>  Keyboard types; </li><li>  You have to be rejected; </li><li>  It can be rejected. </li></ul></div></div><br>  If all the requirements described above are satisfied, then it remains to perform several generally known steps: <br><ol><li>  Go to the developer portal and create an App ID for the extension.  It must be a continuation of the identifier of the main application.  For example, if the App ID for the application is: <code>com.company.application</code> , then the App ID for the extension might be: <code>com.company.application.keyboard</code> .  Next, for the new App ID, you must create a provisioning profile.  These data must be specified in the settings Target in Xcode; </li><li>  If the extension implements data exchange with the main application, then the App Group must be created in the developer portal, and the option to use the App Group in the App IDs settings for the extension and the application must be enabled.  Actually, this step must be performed at the stage of testing the application, otherwise you will not see data exchange; </li><li>  Add screenshots and description for your iTunesConnect extension.  Apple has not added special fields for this purpose.  These data are filled in along with the information on the main application; </li><li>  Collect Target main application and send to review.  The extension is already contained in the application package; </li><li>  That's all, it remains only to wait. </li></ol><br>  <a href="https://developer.apple.com/app-store/review/guidelines/">App</a> Testing Advisory Document: <a href="https://developer.apple.com/app-store/review/guidelines/">App Store Review Guidelines</a> </hh></div><p>Source: <a href="https://habr.com/ru/post/235917/">https://habr.com/ru/post/235917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../235903/index.html">"My way" with MS Excel</a></li>
<li><a href="../235907/index.html">School of 3D solutions for students: what's inside and how to get to study for free</a></li>
<li><a href="../235909/index.html">First All-Russian Olympiad of Schoolchildren on Programming (Informatics) 1989</a></li>
<li><a href="../235913/index.html">nanoCAD becomes available in a virtual environment thanks to NVIDIA GRID</a></li>
<li><a href="../235915/index.html">Sorry - Weekend Project</a></li>
<li><a href="../235921/index.html">bb-mobile Techno 9.7 3G - iPad Air Clone Budget</a></li>
<li><a href="../235927/index.html">Internet in Belarus</a></li>
<li><a href="../235931/index.html">Top 10 Things We Understand When Working With Foundation for Apps</a></li>
<li><a href="../235937/index.html">Scrawl - a screenshot of websites and security of web interfaces of SIP devices</a></li>
<li><a href="../235939/index.html">The Sims 4 developers joked about "pirates"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>