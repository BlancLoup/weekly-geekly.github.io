<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recipes for Android: IoC with Gradle Taste</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Android projects are great. Sometimes really big. One of our projects is a news application that is being developed simultaneously for two alternative...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recipes for Android: IoC with Gradle Taste</h1><div class="post__text post__text-html js-mediator-article">  Android projects are great.  Sometimes really big.  One of our projects is a news application that is being developed simultaneously for two alternative platforms: Android and FireOS, which is from Amazon.  This allows you to expand the circle of readers of news, because users of Kindle Fire readers love to read :).  However, this also imposes an obligation to reckon with the features of each of the platforms.  For example, if on Android you use GCM for push messages, then on FireOS you should use Amazon AWS for this.  Similarly, for in-app shopping systems: Google in-app billing vs.  In-App Purchasing.  But large project size! = Large application size! <br><br>  In this article, we show how to use alternative builds to optimize the application and support them without harm to the development process. <br><br><h2>  What are we cooking? </h2><br><img src="https://habrastorage.org/files/c68/f84/455/c68f8445551246349084937628c983b1.png"><br><a name="habracut"></a><br>  When developing a multiplatform application, a developer can deal with code that is executed only on one of the platforms, but being launched on others will be a dead weight.  In addition to its existence, such a code will probably introduce all its dependencies into the project with the same cargo.  This in itself is not very good, and considering the specifics of development for Android: ‚Äúproblem 65k‚Äù, best practice to make the downloadable file size as small as possible, with this code you definitely need to do something.  But endless checks ifAndroid () or ifAmazon () want to see a little less than never. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If you are an experienced Android developer, you probably already have come across the Android Gradle option of the plugin as ProductFlavor. <br><br>  <b><i>Flavor (English) - taste, aroma</i></b> <br><br>  This option allows you to create alternative assemblies of the same project, including in the build files from different directories depending on the name of the flavor being collected.  Often, ProductFlavor is used for all sorts of ‚Äúbranding‚Äù of the application, replacing resources (images, texts, links).  Another frequent case is the division of the application into demo- and full versions, because the name of the collected flavor is automatically placed in the field of the BuildConfig.FLAVOR class.  Its value can later be checked in runtime and not allowed to perform any actions in the demo version. <br><br>  Sharing on flavor'y can not only resources, but also the code.  But you need to understand that the code used in flavor1 can never interact with the code from flavor2.  And the code lying in the main module can always see only one flavor at a time.  All this means, for example, that you cannot write a set of utility methods in one flavor and use them in another.  It is necessary to divide the code wisely and very carefully, as isolated as possible, so that the switching of alternative builds goes unnoticed by the main module.  The Dependency Injection pattern will help us a lot in this.  Following it, we will leave only common interfaces in the main module, and we will also expand specific implementations in flavor form.  We will look at the whole process on the example of creating a simple application for searching repositories on GitHub. <br><br><h2>  Ingredients </h2><br>  So, we need: <br><ol><li>  Screen with input field, button and list of results (1 pc.). </li><li>  Class for working with the Github Web API: its mock and real implementation (total 2 pcs.). </li><li>  Class for caching search results: also real and mock-implementations (total 2 pcs.). </li><li>  Icons, texts, progress bars - to taste. </li></ol><br><br>  We will follow the approach of dividing the application into layers and immediately create 3 packages: .view for the presentation, .models for the business logic models, and .data for the content provider classes.  In the data package, we still need 2 services and storages packages.  As a result, the whole structure should look like this: <br><img src="https://habrastorage.org/files/9be/33a/b2d/9be33ab2d51d4af4b574114fdb6a8bd8.png"><br><br>  Modelki is enough for us with only one: ‚ÄúRepository‚Äù.  You can store anything in it, but we wanted to have a description, name, and htmlUrl in it. <br><br>  Now let's define the interface of the service class that will look for the AppService repositories: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">List&lt;Repository&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span></span>; }</code> </pre> <br>  Immediately create and interface class that caches the search results RepositoryStorage: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryStorage</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query, List&lt;Repository&gt; repositoryList)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;Repository&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span></span>; }</code> </pre><br>  We will create and store our service and repository inside the Application class: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AppService appService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RepositoryStorage repositoryStorage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AppService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAppService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> appService; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RepositoryStorage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRepositoryStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> repositoryStorage; } }</code> </pre><br>  For the preparatory stage, it remains only to create the screen itself and write the receipt and display of the results in it.  Within the framework of the demo application, AsyncTask will be enough for us to perform background work, but you can always use your favorite approach. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bind</span></span>(R.id.actionSearchView) Button actionSearchView; <span class="hljs-meta"><span class="hljs-meta">@Bind</span></span>(R.id.recyclerView) RecyclerView recyclerView; <span class="hljs-meta"><span class="hljs-meta">@Bind</span></span>(R.id.searchQueryView) EditText searchQueryView; <span class="hljs-meta"><span class="hljs-meta">@Bind</span></span>(R.id.progressView) View progressView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SearchResultsAdapter adapter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AppService appService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SearchTask searchTask; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RepositoryStorage repositoryStorage; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); ButterKnife.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); appService = ((App) getApplication()).getAppService(); repositoryStorage = ((App) getApplication()).getRepositoryStorage(); recyclerView.setLayoutManager(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinearLayoutManager(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>)); adapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchResultsAdapter(); recyclerView.setAdapter(adapter); searchQueryView.setOnEditorActionListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextView.OnEditorActionListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEditorAction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TextView v, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> actionId, KeyEvent event)</span></span></span><span class="hljs-function"> </span></span>{ querySearch(searchQueryView.getText().toString()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }); } <span class="hljs-meta"><span class="hljs-meta">@OnClick</span></span>(R.id.actionSearchView) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onActionSearchClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ querySearch(searchQueryView.getText().toString()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">querySearch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (TextUtils.isEmpty(query)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (searchTask != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE); imm.hideSoftInputFromWindow(searchQueryView.getWindowToken(), <span class="hljs-number"><span class="hljs-number">0</span></span>); searchTask = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchTask(); searchTask.execute(query); showProgress(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;Repository&gt; repositories)</span></span></span><span class="hljs-function"> </span></span>{ searchTask = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; adapter.setData(repositories); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showProgress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> inProgress)</span></span></span><span class="hljs-function"> </span></span>{ progressView.setVisibility(inProgress ? View.VISIBLE : View.GONE); actionSearchView.setEnabled(!inProgress); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable ApiException exception)</span></span></span><span class="hljs-function"> </span></span>{ searchTask = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlertDialog.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .setMessage(exception != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? exception.getMessage() : getString(R.string.unknown_error)) .setTitle(R.string.error_title) .show(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchTask</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">String</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SearchTaskResult</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> SearchTaskResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... params)</span></span></span><span class="hljs-function"> </span></span>{ String q = params[<span class="hljs-number"><span class="hljs-number">0</span></span>]; SearchTaskResult result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SearchTaskResult(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { result.repositories = appService.searchRepositories(q); repositoryStorage.saveRepositories(q, result.repositories); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ApiException e) { result.exception = e; <span class="hljs-comment"><span class="hljs-comment">//try to show some cached results result.repositories = repositoryStorage.getRepositories(q); } return result; } @Override protected void onPostExecute(SearchTaskResult result) { if (result.exception != null) { showError(result.exception); } showData(result.repositories); showProgress(false); } } private class SearchTaskResult { List&lt;Repository&gt; repositories; ApiException exception; } }</span></span></code> </pre><br>  The implementation of the adapter and in general the whole demo project can be viewed on <a href="https://github.com/EBTRussia/FlavorDI/">GitHub</a> . <br><br>  At this stage, our project can already be compiled and run, but this makes no sense, because we have not written any implementation of our interfaces <b>AppService</b> and <b>RepositoryStorage</b> , so it's time to do it. <br><br><h2>  Add taste </h2><br>  First you need to open <b>build.gradle</b> in the main project module and add our flavor to it.  Let's call them, for example, <b>‚Äúmock‚Äù</b> and <b>‚Äúprod‚Äù</b> <br><pre> <code class="java hljs">productFlavors { mock {} prod {} }</code> </pre><br>  They should be <b>added to the</b> <b>android {...}</b> section at the same level as <b>buildTypes {...}</b> . <br>  Be sure to then click on the Sync Project With Gradle Files button. <br><img src="https://habrastorage.org/files/d41/8ee/28d/d418ee28d49045dd8f68c6a11d138411.png"><br><br>  As soon as the synchronization is completed, new flavors will appear in the Build Variants window. <br><img src="https://habrastorage.org/files/9b5/c73/fe3/9b5c73fe355c4d53a86e91e911a4403b.png"><br><br>  Now choose <b>mockDebug</b> . <br><br>  Once we have defined the product flavors in the project, we can create directories of the same name for them on the same level as <b>main</b> .  From these directories, the files will be taken during the assembly of some flavor. <br>  Add a <b>mock</b> folder, repeating in it the structure of the <b>services</b> and <b>storages packages</b> : <br><img src="https://habrastorage.org/files/fdd/f5c/9f5/fddf5c9f5bee4112b8675d6f23db0a2b.png"><br><br>  Finally, you can proceed with the mock implementation of our interfaces: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Repository&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (query.equals(<span class="hljs-string"><span class="hljs-string">"error"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiException(<span class="hljs-string"><span class="hljs-string">"Manual exception"</span></span>); } List&lt;Repository&gt; results = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt;= <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { results.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Repository(<span class="hljs-string"><span class="hljs-string">"Mock description "</span></span> + i, <span class="hljs-string"><span class="hljs-string">"Mock Repository "</span></span> + i, <span class="hljs-string"><span class="hljs-string">"http://mock-repo-url"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> results; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockRepositoryStorage</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryStorage</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String q, List&lt;Repository&gt; repositoryList)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Repository&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String q)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br>  As you can see, the mock-service gives us 10 very informative Repository models, and mock-storage does nothing at all.  We initialize them in our App-class: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); appService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppServiceImpl(); repositoryStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockRepositoryStorage(); }</code> </pre><br>  Now that our application is ready to be assembled and running.  Now we can test and adjust the work of the UI.  Now we can ... go to the real implementation of our interfaces. <br><br>  In the Build Variants window, select the prodDebug option and, similarly to the <b>mock</b> folder, create the <b>prod</b> folder with the same packages and classes: <br><img src="https://habrastorage.org/files/580/93e/f2a/58093ef2af8c46109272c4523b5ddca8.png"><br><br>  We will resort to using retrofit2 for network requests, it will work inside our implementation of AppServiceImpl: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RetroGithubService service; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AppServiceImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Retrofit.Builder() .baseUrl(<span class="hljs-string"><span class="hljs-string">"https://api.github.com/"</span></span>) .addConverterFactory(GsonConverterFactory.create()) .build().create(RetroGithubService.class); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> List&lt;Repository&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String query)</span></span></span><span class="hljs-function"> </span></span>{ Call&lt;ApiRepositorySearchEntity&gt; call = service.searchRepositories(query); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Response&lt;ApiRepositorySearchEntity&gt; response = call.execute(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.isSuccess()) { ApiRepositorySearchEntity body = response.body(); List&lt;Repository&gt; results = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); RepositoryMapper mapper = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepositoryMapper(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (RepositoryEntity entity : body.items) { results.add(mapper.map(entity)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> results; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiException(response.message()); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiException(e); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RetroGithubService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@GET</span></span>(<span class="hljs-string"><span class="hljs-string">"search/repositories"</span></span>) <span class="hljs-function"><span class="hljs-function">Call&lt;ApiRepositorySearchEntity&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">searchRepositories</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Query(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"q"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String query)</span></span>; }</code> </pre><br>  As you can see from the code, we have made some more auxiliary classes: <b>* Entity</b> for parsing answers and <b>RepositoryMapper</b> for mapping responses into the <b>Repository</b> model. <br><br>  <b><i>Please note that all classes related to real work with the server, such as RepositoryEntity, RepositoryMapper, RetroGithubService, are in the flavor folder ‚Äúprod‚Äù.</i></b>  <b><i>This means that when building any other flavor, such as mock, these classes will not fall into the resulting apk-file</i> .</b> <br><br>  The attentive reader may notice that the name of the class that implements the real work in the server and the name of its mock analog match: <b>AppServiceImpl.java</b> .  This is done on purpose and thanks to this, in the main project code, which is located in the main folder, you do not need to change anything when changing flavor.  When the <b>mock</b> flavor is selected, the application sees the AppServiceImpl class located in the mock folder and does not see the class located in the <b>prod</b> folder.  Similarly, with the selected flavor <b>prod</b> . <br><br>  An equally attentive reader may notice that we called the implementation cache class <b>MockRepositoryStorage</b> and, possibly, were sealed.  But no, we did it specifically to show one of the options of how you can have different names of implementation classes, and even different constructors for each of them. <br>  The trick is essentially simple; we will do the <b>RepositoryStorageBuilder</b> class of the same name for different flavors, which, depending on the flavor you choose, will give us the desired implementation. <br><br>  productFlavor = prod <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryStorageBuilder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxSize; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RepositoryStorageBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMaxSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxSize)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.maxSize = maxSize; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RepositoryStorage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryRepositoryStorage(maxSize); } }</code> </pre><br><br>  productFlavor = mock <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryStorageBuilder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RepositoryStorageBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMaxSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxSize)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RepositoryStorage </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockRepositoryStorage(); } }</code> </pre><br><br>  And common for both initialization in Application: <br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(); ... repositoryStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepositoryStorageBuilder() .setMaxSize(<span class="hljs-number"><span class="hljs-number">5</span></span>) .build(); }</code> </pre><br><br>  Now the ‚Äúhonest‚Äù implementation of the work can be considered complete, but if we stop here, we will not use all the power of ProductFlavor.  The fact is that the libraries used in the fair implementation of the search, which are declared in the <b>dependencies</b> section, get into our assembly regardless of the flavor selected.  Fortunately, we can specify for each dependency separately whether we want to see it in the build by adding the desired name flavor before the word compile: <br><pre> <code class="java hljs">dependencies { <span class="hljs-function"><span class="hljs-function">compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(dir: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'libs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, include: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'*.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">])</span></span></span><span class="hljs-function"> testCompile 'junit:junit:4.12' prodCompile 'com.squareup.retrofit:retrofit:2.0.0-beta2' prodCompile 'com.squareup.retrofit:converter-gson:2.0.0-beta2' prodCompile 'com.google.code.gson:gson:2.5' compile 'com.android.support:appcompat-v7:23.1.1' compile 'com.android.support:recyclerview-v7:23.1.1' compile 'com.jakewharton:butterknife:7.0.1' }</span></span></code> </pre><br>  This will not only reduce the size of the application, but also increase the speed of its assembly, if the dependencies are really large. <br><br><h2>  What for? </h2><br>  Why use this approach to Dependency Injection, if there is Dagger2, Roboguice, if you can even write it manually? <br>  Of course, the key difference of this approach is that the definition of implementations occurs at the compilation stage and only those dependencies that will actually be used, with all the ensuing consequences, fall into the build.  At the same time, to determine dependencies at runtime, you can continue to use your favorite DI framework. <br><br><h2>  True story </h2><br>  As we mentioned at the beginning, we are developing one of our projects for two platforms at once: Android and Amazon FireOS.  These operating systems are basically similar to each other (of course, we all understand who and who resembles someone :)), but each of them has its own implementation of push-notifications and its own built-in shopping mechanism.  For these and other platform differences, we, as in the demo project, left only common interfaces in the main module: the same registration of the device on the server of push messages, the same subscription purchase process, and specific platform-specific implementations are stored in the corresponding flavor. <br><br><img src="https://habrastorage.org/files/cf9/6a7/d90/cf96a7d907c8496785e77816a37d18b4.jpg"><br><br>  We have been using this approach for a long time and are ready to share our impressions of use: <br>  pros <br><ol><li>  Exclusion from the resulting assembly of all the code and its dependencies, which will never be used on any of the platforms. </li><li>  Reduced project build time  only selected (active) flavor is collected. </li><li>  All the benefits of using IoC, separating the interface from the implementation, and no ugly if isAndroid () style </li></ol><br>  Minuses <br><ol><li>  Android Studio simultaneously sees only the selected flavor and its directory.  Because of this, automatic refactoring, search by java-classes, search by resources does not work fully.  It does not work in the sense that it does not apply to inactive flavors.  After refactoring, sometimes you have to switch between flavors and repeat refactoring separately for each of them. </li></ol><br>  As you can see, we believe that there are 3 times more advantages :) Bon appetit to all! </div><p>Source: <a href="https://habr.com/ru/post/276927/">https://habr.com/ru/post/276927/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../276917/index.html">The court recognized "Mail.Ru" blogger</a></li>
<li><a href="../276919/index.html">New Java-conference from JUG.ru in Novosibirsk</a></li>
<li><a href="../276921/index.html">Best practices for protecting e-commerce sites</a></li>
<li><a href="../276923/index.html">Creating the concept of mobile f2p games. Part 1</a></li>
<li><a href="../276925/index.html">EDI standard. Technical Overview</a></li>
<li><a href="../276931/index.html">Web version of Server Management Tools for TP 2016</a></li>
<li><a href="../276933/index.html">Record on the anniversary tour to the cloud data center Inoventica Services</a></li>
<li><a href="../276935/index.html">Reset suspended RDP sessions</a></li>
<li><a href="../276937/index.html">Algorithm for creating a list of all permutations or placements</a></li>
<li><a href="../276939/index.html">DUMP-2016 Developer Conference: Ekaterinburg, April 8</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>