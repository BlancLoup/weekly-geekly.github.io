<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do you know how much, or mass launch of servers with minimum labor costs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our first article, as previously announced, we are in a hurry to share our experience in such a rarely discussed issue as the rapid deployment of h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do you know how much, or mass launch of servers with minimum labor costs</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://badoo.com/"><img src="https://habrastorage.org/storage1/7c701b54/3bbd50f8/586fe987/3c371d85.png" align="left"></a>  In our first article, as previously announced, we are in a hurry to share our experience in such a rarely discussed issue as the rapid deployment of hundreds of servers in a highly loaded project. <br><br>  How to deploy several hundred servers in a geographically remote data center in the absence of physical access to equipment?  How does <a href="http://badoo.com/">Badoo</a> solve this problem? <br>  We will tell you about this with the following example. <br><br>  Below we will talk about the very first stage of configuring server hardware;  how quickly and in time we completed a specific task, and not about writing optimal scripts.  In case this topic seems interesting to you, we will be happy to tell you about installing the OS on the server and setting up the working environment, which also has its subtleties. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, we were tasked to deploy several hundred new servers that had just arrived at our two data centers. <br><br>  If successful, we should get: <ul><li>  description of the entire "iron" component for each server; </li><li>  correspondence of the ordered equipment to the received one (there are cases that the configuration that was ordered is not the one that was ordered); </li><li>  ready to install OS and server software (with updated versions of RAID, ROM, etc., configured RAID-arrays, no problems with hardware). </li></ul>  Information that we have: <ul><li>  servers are mounted in racks / cabinets and included; </li><li>  known factory logins and passwords; </li><li>  all servers have an <a href="http://ru.wikipedia.org/wiki/IPMI">IPMI interface</a> (management interface); </li><li>  there are no pre-sets from the manufacturer on the servers (in particular, no RAID configuration is configured, power settings are not set); </li><li>  all servers are connected to the network equipment by at least two interfaces, are in a previously known <a href="http://ru.wikipedia.org/wiki/VLAN">VLAN</a> ; </li><li>  New servers receive their IP addresses dynamically, respectively, they are available immediately after switching on; </li><li>  It is known how many server configurations should have been in the delivery. </li></ul>  Of course, it was not without additional difficulties.  First, our engineers did not have physical access to the servers.  Secondly, the ‚Äúiron‚Äù in the delivery had several different configurations.  And thirdly, everything that we knew about our servers is actually only their factory logins and passwords. <br><br>  Most often, this kind of tasks are suggested to be solved with the help of <a href="http://ru.wikipedia.org/wiki/dd">dd</a> , <a href="http://ru.wikipedia.org/wiki/PXE">PXE</a> server and <a href="http://ru.wikipedia.org/wiki/Rsync">rsync</a> , setting tasks, involving data center employees.  But we approached the question differently. <br><br>  The solution we found involves some automation.  Please note that all the scripts below are for informational purposes only and do not claim to be perfect. <br><br>  To complete the task we needed: <ul><li>  several text files that are deleted upon completion; </li><li>  some very simple scripts using expect; </li><li>  configured network boot server (in our case, <a href="http://en.wikipedia.org/wiki/XCAT">xCAT</a> ); </li><li>  a customized and working OS image (no matter what, the main thing is that this image includes all the utilities we need); </li><li>  customized equipment inventory system (in our case, this is a <a href="http://www.glpi-project.org/">glpi project</a> ). </li></ul>  First we needed to know which IP addresses were obtained by our new servers.  To do this, we made a text file nodes with data about logins and passwords in the format <br><br><pre>  ILOHOSTNAME1 ILOPASSWORD1
 ILOHOSTNAME2 ILOPASSWORD2 </pre><br>  We obtained this data from the labels available on each server using a barcode scanner.  Standard login was known in advance - Administrator.  Sticker example: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/c1cc0047/7aa3d123/6766ec5c/2e6fd33e.jpg"></div><br>  Now it was possible to run a command that collected hostname and IP matches for us: <br><br><pre>  for i in $ (cat nodes | awk {'print $ 1'});  do j = $ (cat nodes | grep $ i | awk {'print $ 2'});  ssh DHCPD_SERVER_FQDN "sudo cat / var / log / messages | grep $ i | tail -1 | sed 's / $ /' $ j '/ g'";  done </pre><br>  As a result, we received lines like the ones below, put them in the nodeswip file: <br><br><pre>  Jul 1 10:31:23 local @ DHCPD_SERVER dhcpd: DHCPACK on 10.10.10.213 to 9c: 8e: 99: 19: 3a: 68 (ILOUSE125NDBF) via 10.10.10.1 W3G554L7
 Jul 1 10:31:35 local @ DHCPD_SERVER dhcpd: DHCPACK on 10.10.10.210 to 9c: 8e: 99: 19: b6: aa (ILOUSE125NDBA) via 10.10.10.1 BJCP691P
 Jul 1 10:31:47 local @ DHCPD_SERVER dhcpd: DHCPACK on 10.10.10.211 to 9c: 8e: 99: 19: 58: 7c (ILOUSE125NDBG) via 10.10.10.1 67MG91SV </pre><br>  Now we needed to create a standard user with a set of rights available to him on all IPMI interfaces of new servers.  It was also necessary to obtain the MAC addresses of the net and mgm interfaces for further structuring.  For this we have executed the command <br><br><pre>  for i in $ (cat nodeswip | awk {'print $ 8'});  do j = $ (grep $ i nodeswip | awk {'print $ 14'});  expect expwip.sh $ i $ j |  grep Port1NIC_MACAddress;  done; </pre><br>  where the sh script expwip.sh looked like this: <br><br><pre>  #! / usr / bin / expect
 set timeout 600  
 set ip [lindex $ argv 0]
 set pass [lindex $ argv 1]
 spawn ssh Administrator @ $ ip
 set answ "$ pass"
 set comm1 "create / map1 / accounts1 username = deployer password = PASSWORD name = deployer group = admin, config, oemhp_vm, oemhp_power, oemhp_rc"
 expect "Administrator @ $ ip's password:"
 send "$ answ \ r"
 expect "&lt;/&gt; hpiLO-&gt;"
 send "$ comm1 \ r"
 expect "&lt;/&gt; hpiLO-&gt;"
 send "show / system1 / network1 / Integrated_NICs \ r"
 expect "&lt;/&gt; hpiLO-&gt;"
 send "exit \ r"
 expect eof </pre><br>  The resulting list of MAC addresses of the net interfaces of our servers was added to the spreadsheet editor, which allowed us to see all matches. <br><br>  Then we performed the configuration steps for the DHCP server, then sent the servers to netboot.  After that, we had to send IPMI interfaces to reboot in order for them to occupy their intended addresses.  This was done using the command <br><br><pre>  expect reset_ilo.sh $ i $ j </pre><br>  where $ i is the server address received earlier, $ j is the factory administrator password <br><br>  The reset_ilo.sh script looked like this: <br><br><pre>  #! / usr / bin / expect
 set timeout 600  
 set ip [lindex $ argv 0]
 set pass [lindex $ argv 1]
 spawn ssh Administrator @ $ ip
 set answ "$ pass"
 set comm1 "reset / map1"
 expect "Administrator @ $ ip's password:"
 send "$ answ \ r"
 expect "&lt;/&gt; hpiLO-&gt;"
 send "$ comm1 \ r"
 expect eof </pre><br>  Next, we proceeded to automatic generation of RAID-arrays, updating all possible firmware versions on hardware, obtaining comprehensive information on the layout of servers in a convenient form.  All these operations were performed at network boot. <br><br>  First, an init script was launched that ‚Äúprepared‚Äù the RAID array: <br><br><pre>  LD = `/ usr / sbin / hpacucli ctrl slot = 0 logicaldrive all show | awk '$ 0 ~ / RAID 5 / ||  / Raid 0 / ||  / Raid 1 / {print $ 1 "" $ 2} '`

 LD = $ {LD: -NULL}

 if ["$ LD"! = "NULL"];  then / usr / sbin / hpacucli ctrl slot = 0 $ LD delete delete;  fi
 / usr / sbin / hpacucli ctrl slot = 0 create type = ld drives = `/ usr / sbin / hpacucli ctrl slot = 0 | show | awk '$ 1 ~ / physicaldrive / {split ($ 2, arr,": "); print $ 2} '| tr "\ n" "," | sed' s /, $ // '`raid = 1 + 0
 if [`/ usr / sbin / hpacucli ctrl slot = 0 physicaldrive all show |  grep physicaldrive |  wc -l` -gt 1];  then r = `/ usr / sbin / hpacucli ctrl slot = 0 physicaldrive all show |  grep physicaldrive |  wc -l`;  let t = $ r% 2;  if [$ t -ne 0];  then let tl = $ r-1;  / usr / sbin / hpacucli ctrl slot = 0 create type = ld drives = `/ usr / sbin / hpacucli ctrl slot = 0 physical drive all show | grep physical drive |  head - $ tl | awk '$ 1 ~ / physicaldrive / {split ($ 2, arr, ":"); print $ 2}' | tr "\ n" ", | | sed 's /, $ //'` raid = 1 + 0;  / usr / sbin / hpacucli ctrl slot = 0 array all add spares = `/ usr / sbin / hpacucli ctrl slot = 0 physical drive |  tail -1 | awk '$ 1 ~ / physicaldrive / {split ($ 2, arr, ":"); print $ 2}' | tr "\ n" "," | sed 's /, $ //' `;  fi;  fi </pre><br>  As a result, we received 1 + 0 or ‚Äúmirror‚Äù.  Then, the agent was launched, which sent information about the hardware to our inventory system.  We use the fusion inventory agent, in whose settings we did not change anything except the address of the collection server.  The result is visible in the <a href="http://fusioninventory.org/">Fusion Inventory</a> interface: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/storage1/8eb02749/33ddcce6/1df673e6/d14d50b0.png"></div><br>  The last to run was a script that updated all the firmware on the hardware.  For this, several <a href="http://en.wikipedia.org/wiki/Puppet_(software)">puppet</a> classes were used that were run on new servers.  Below is an example of a class that ‚Äúlooks‚Äù at the current server configuration and, if necessary, updates the firmware version of the RAID controller to the required one.  In the same scenario, other updates of the hardware firmware were also performed. <br><br><pre>  class hp_raid_update_rom {
         exec {"updateraid":
                 command =&gt; "wget ‚Äã‚Äã-P / tmp / http: //WEBSERVER/install/soft/firmware/hp/raid/5_12/CP015960.scexe; wget -P / tmp / http: // WEBSERVER / install / soft / update_hp_raid_firmware_512. sh; chmod + x /tmp/CP015960.scexe; chmod + x /tmp/update_hp_raid_firmware_512.sh; /tmp/update_hp_raid_firmware_512.sh; echo '5.12'&gt; / tmp / firmware_raid ",
                 onlyif =&gt; "/ usr / bin / test` / sbin / lspci | grep -i 'Hewlett-Packard Company Smart Array G6' | wc -l`! = '0' &amp;&amp; / usr / bin / test `/ usr / sbin / hpacucli ctrl all show detail | grep -i firmware | awk {'print \ $ 3'} `! = '5.12' &amp;&amp; ([! -f / tmp / firmware_raid] || [cat / tmp / firmware_raid`! = ' 5.12 ']) ",
                 path =&gt; "/ usr / bin: / bin",
                 require =&gt; Exec ["remove_report_file", "remove_empty_report_file"],
         }
         exec {"remove_report_file":
                 command =&gt; "/ bin / rm / tmp / firmware_raid",
                 onlyif =&gt; "[-f / tmp / firmware_raid] &amp;&amp; [` cat / tmp / firmware_raid` == `/ usr / sbin / hpacucli ctrl all show detail | grep -i firmware | awk {'print \ $ 3'}`] ",
                 path =&gt; "/ usr / bin: / bin",
         }
         exec {"remove_empty_report_file":
                 command =&gt; "/ bin / rm / tmp / firmware_raid",
                 onlyif =&gt; "[-f / tmp / firmware_raid] &amp;&amp; [` cat / tmp / firmware_raid | wc -l` == '0'] ",
                 path =&gt; "/ usr / bin: / bin",
         }
 } </pre><br>  Thus, we solved the task, using only our own resources.  All our machines were ready to install the combat OS, install the software and start servicing Badoo users. <br><br>  All the above describes only the preparatory stage of setting up the equipment, the issues of installing the OS and configuring the working environment are left out of the article  If you are interested in this topic, we will be happy to prepare material on xCAT and puppet and share our ways of solving specific problems using these tools. <br><br>  You can safely leave your suggestions, questions and comments on the above in the comments - we are always open for dialogue! <br><br>  <i>Badoo Company</i> </div><p>Source: <a href="https://habr.com/ru/post/133387/">https://habr.com/ru/post/133387/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../133380/index.html">Forth CPU. What it is? (Part 2)</a></li>
<li><a href="../133381/index.html">About the opera and its standard template for viewing FTP</a></li>
<li><a href="../133383/index.html">FPGA programming. Smoothly changing the brightness of the LEDs on the Spartan-3E Starter Kit using PWM</a></li>
<li><a href="../133384/index.html">Google added 4shared, The Pirate Bay and others to the list of pirated words</a></li>
<li><a href="../133385/index.html">Tester conferences in Europe or an excuse for poking?</a></li>
<li><a href="../133388/index.html">Poking around in the SIM-card: processor, memory, file system + I / O</a></li>
<li><a href="../133389/index.html">Revealed the secret of the power elixir from "Druid Panoraomix" - Gars Telecom Marketing Director</a></li>
<li><a href="../133391/index.html">A zombie farm</a></li>
<li><a href="../133392/index.html">IE developers opposed Google Dart</a></li>
<li><a href="../133393/index.html">New Guide: Publishing Web Projects with Visual Studio 2010</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>