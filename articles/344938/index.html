<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Multi-pattern matching on GPU myth or reality</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some lyrics 
 In the old days, when the grass was greener and the trees were taller, I firmly believed that such scary words as thread divergence, cac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Multi-pattern matching on GPU myth or reality</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/la/vf/rb/lavfrb5mfo0wlaoim6af36kqm9k.jpeg" alt="image" width="350" align="left"><h3>  <b>Some lyrics</b> </h3><br>  In the old days, when the grass was greener and the trees were taller, I firmly believed that such scary words as thread divergence, cache missing, coalescing global memory accesses and others do not effectively implement the task of multiple search on the GPU.  The years went by, the confidence did not disappear, but one fine day I came across the <a href="https://github.com/pfac-lib/PFAC">PFAC</a> library.  If you are interested in what she is capable of - welcome under cat. <a name="habracut"></a><br><br><br clear="left"><h3>  <b>Why all this</b> </h3><br>  Why do we do it and what do we want to get?  The most interesting fact is the performance of the PFAC library.  I want to get a high speed of work, obtained through the use of a GPU.  For comparison, we will use the CPU and OpenMP implementation of the PFAC algorithm. <br><br>  I assume that the reader has some understanding of the architecture of CUDA.  If this is not the case yet, then the main ideas can be found in articles, for example, <a href="https://habrahabr.ru/company/epam_systems/blog/245503/">here</a> and <a href="https://habrahabr.ru/company/epam_systems/blog/245523/">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  <b>About the library</b> </h3><br>  The PFAC library was developed in 2012 and adapted to the architecture and capabilities of the video cards of that time, so if you have a video card with compute capability no higher than 3.0, you are ready to install ubuntu 12.04 and cuda 4.2, then everything should take off from the box.  However, we are not looking for easy ways and in this article we will work with ubuntu 16.04 and cuda 9.0.  A laptop with an Intel Core i7-7500U, GeForce 940MX and 8 GB of RAM will be used as a test bench. <br><br>  Before we rush into battle and count gigabits, I will say a few words about the algorithmic part in order to understand what awaits us. <br><br>  The library implements a parallel Aho-Korasik algorithm without gatherings.  PFAC, respectively, is short for Parallel Failureless Aho-Corasick.  The algorithm builds a prefix tree without gathering and packs it into a table. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/f-/92/ybf-92i3a7suhp5lojr2vv49a4q.png"></div><br>  As stated in the documentation, each thread processes data, starting with its input symbol. <br><img src="https://habrastorage.org/webt/a4/s4/kk/a4s4kkso1fscvi7y6b0nb6oeoz8.png"><br>  However, if you look at the source, each thread handles 4 characters, which is associated with memory alignment. <br><br>  All the scary words with which I started the article have a place to be in this decision.  No one guarantees that all the threads inside one warp (32 successive threads inside one block) will process closely located data in the table.  There are also no guarantees that all the threads inside the warp will move along one branch of the branch or exit the cycle of passage through the tree at one time. <br><br>  But I suggest not to think about the bad, and with burning eyes and optimistic attitude to start a computational experiment. <br><br><h3>  <b>Deployment</b> </h3><br>  First, let's try deploying PFAC.  I believe that CUDA is already installed, as well as the paths to nvcc and libraries added. <br><br>  Go to the project, do make.  Waiting - all is well, everything is unfolded.  Harsh reality - some strange mistakes.  It turns out that for CUDA 9.0 assemblies for video cards with compute capability below 3.0 are deprecated.  This can be fought.  You just need to change the src / makefile. <br><br><div class="spoiler">  <b class="spoiler_title">Sample Makefile for compute capability 5.0.</b> <div class="spoiler_text"><pre><code class="hljs smalltalk"># # <span class="hljs-type"><span class="hljs-type">Makefile</span></span> in directory src # # resource usage: # # <span class="hljs-type"><span class="hljs-type">To</span></span> compile a dynamic module # (<span class="hljs-number"><span class="hljs-number">1</span></span>) nvcc cannot accept -fPIC, so compile .cu to .cu.cpp first # nvcc -arch=sm_50 -cuda ../src/<span class="hljs-type"><span class="hljs-type">PFAC_kernel</span></span>.cu # # (<span class="hljs-number"><span class="hljs-number">2</span></span>) then use g++ to comple <span class="hljs-type"><span class="hljs-type">PFAC_notex_shared_reorder</span></span>.cu.cpp # g++ -fPIC -c <span class="hljs-type"><span class="hljs-type">PFAC_kernel</span></span>.cu.cpp # # (<span class="hljs-number"><span class="hljs-number">3</span></span>) finally combine two object files to a .so library # g++ -shared -o libpfac.so <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIBS</span></span>) <span class="hljs-type"><span class="hljs-type">PFAC_kernel</span></span>.cu.o ... # # <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIBS</span></span>) is necessary when compiling <span class="hljs-type"><span class="hljs-type">PFAC</span></span> library on <span class="hljs-number"><span class="hljs-number">32</span></span>-bit machine # include ../common.mk <span class="hljs-type"><span class="hljs-type">INC_DIR</span></span> = ../include <span class="hljs-type"><span class="hljs-type">LIB_DIR</span></span> = ../lib <span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span> = ../obj <span class="hljs-type"><span class="hljs-type">INCPATH</span></span> += -<span class="hljs-type"><span class="hljs-type">I</span></span>../include/ <span class="hljs-type"><span class="hljs-type">CU_SRC</span></span> = <span class="hljs-type"><span class="hljs-type">PFAC_kernel</span></span>.cu <span class="hljs-type"><span class="hljs-type">CU_SRC</span></span> += <span class="hljs-type"><span class="hljs-type">PFAC_reduce_kernel</span></span>.cu <span class="hljs-type"><span class="hljs-type">CU_SRC</span></span> += <span class="hljs-type"><span class="hljs-type">PFAC_reduce_inplace_kernel</span></span>.cu <span class="hljs-type"><span class="hljs-type">CU_SRC</span></span> += <span class="hljs-type"><span class="hljs-type">PFAC_kernel_spaceDriven</span></span>.cu <span class="hljs-type"><span class="hljs-type">CPP_SRC</span></span> = <span class="hljs-type"><span class="hljs-type">PFAC_reorder_Table</span></span>.cpp <span class="hljs-type"><span class="hljs-type">CPP_SRC</span></span> += <span class="hljs-type"><span class="hljs-type">PFAC_CPU</span></span>.cpp <span class="hljs-type"><span class="hljs-type">CPP_SRC</span></span> += <span class="hljs-type"><span class="hljs-type">PFAC_CPU_OMP</span></span>.cpp <span class="hljs-type"><span class="hljs-type">CPP_SRC</span></span> += <span class="hljs-type"><span class="hljs-type">PFAC</span></span>.cpp inc_files = <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INC_DIR</span></span>)/<span class="hljs-type"><span class="hljs-type">PFAC_P</span></span>.h <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INC_DIR</span></span>)/<span class="hljs-type"><span class="hljs-type">PFAC</span></span>.h <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-type"><span class="hljs-type">CU_OBJ</span></span> = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.cu,%.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CU_SRC</span></span>)) <span class="hljs-type"><span class="hljs-type">CU_CPP</span></span> = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.cu,%.cu.cpp,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CU_SRC</span></span>)) <span class="hljs-type"><span class="hljs-type">CPP_OBJ</span></span> = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.cpp,%.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CPP_SRC</span></span>)) cppobj_loc = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/%.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CPP_OBJ</span></span>)) cppobj_fpic_loc = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/%_fpic.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CPP_OBJ</span></span>)) cu_cpp_sm50_loc = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.cpp,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/sm50_%.cpp,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CU_CPP</span></span>)) cu_cpp_obj_sm50_loc = <span class="hljs-string"><span class="hljs-string">$(</span></span>patsubst %.cpp,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/sm50_%.cpp.o,<span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CU_CPP</span></span>)) all: mk_libso_no50 mk_lib_fpic mk_libso_no50: <span class="hljs-string"><span class="hljs-string">$(</span></span>cu_cpp_sm50_loc) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -shared -o <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIB_DIR</span></span>)/libpfac_sm50.so <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIBS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span>cu_cpp_obj_sm50_loc) mk_liba: <span class="hljs-string"><span class="hljs-string">$(</span></span>cppobj_loc) ar cru <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIB_DIR</span></span>)/libpfac.a <span class="hljs-string"><span class="hljs-string">$(</span></span>cppobj_loc) ranlib <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIB_DIR</span></span>)/libpfac.a mk_lib_fpic: <span class="hljs-string"><span class="hljs-string">$(</span></span>cppobj_fpic_loc) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -shared -o <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIB_DIR</span></span>)/libpfac.so <span class="hljs-string"><span class="hljs-string">$(</span></span>cppobj_fpic_loc) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">LIBS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/%_fpic.o: %.cpp <span class="hljs-string"><span class="hljs-string">$(</span></span>inc_files) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -fPIC -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-string"><span class="hljs-string">$&lt;</span></span> <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/<span class="hljs-type"><span class="hljs-type">PFAC_CPU_OMP_reorder_fpic</span></span>.o: <span class="hljs-type"><span class="hljs-type">PFAC_CPU_OMP_reorder</span></span>.cpp <span class="hljs-string"><span class="hljs-string">$(</span></span>inc_files) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -fPIC -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-string"><span class="hljs-string">$&lt;</span></span> <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/<span class="hljs-type"><span class="hljs-type">PFAC_CPU_OMP_reorder</span></span>.o: <span class="hljs-type"><span class="hljs-type">PFAC_CPU_OMP_reorder</span></span>.cpp <span class="hljs-string"><span class="hljs-string">$(</span></span>inc_files) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-string"><span class="hljs-string">$&lt;</span></span> <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/%.o: %.cpp <span class="hljs-string"><span class="hljs-string">$(</span></span>inc_files) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-string"><span class="hljs-string">$&lt;</span></span> <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/sm50_%.cu.cpp: %.cu <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">NVCC</span></span>) -arch=sm_50 -cuda <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-string"><span class="hljs-string">$&lt;</span></span> <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -fPIC -<span class="hljs-type"><span class="hljs-type">O2</span></span> -c -o <span class="hljs-string"><span class="hljs-string">$@</span></span>.o <span class="hljs-string"><span class="hljs-string">$@</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#clean</span></span> : # rm -f *.linkinfo # rm -f <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">OBJ_DIR</span></span>)/* # rm -f <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">EXE_DIR</span></span>)/* ####### <span class="hljs-type"><span class="hljs-type">Implicit</span></span> rules .<span class="hljs-type"><span class="hljs-type">SUFFIXES</span></span>: .o .c .cpp .cc .cxx .<span class="hljs-type"><span class="hljs-type">C</span></span> .cpp.o: <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-comment"><span class="hljs-comment">"$@"</span></span> <span class="hljs-comment"><span class="hljs-comment">"$&lt;"</span></span> .cc.o: <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-comment"><span class="hljs-comment">"$@"</span></span> <span class="hljs-comment"><span class="hljs-comment">"$&lt;"</span></span> .cxx.o: <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-comment"><span class="hljs-comment">"$@"</span></span> <span class="hljs-comment"><span class="hljs-comment">"$&lt;"</span></span> .<span class="hljs-type"><span class="hljs-type">Co</span></span>: <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXX</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CXXFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-comment"><span class="hljs-comment">"$@"</span></span> <span class="hljs-comment"><span class="hljs-comment">"$&lt;"</span></span> .co: <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CC</span></span>) -c <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">CFLAGS</span></span>) <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">INCPATH</span></span>) -o <span class="hljs-comment"><span class="hljs-comment">"$@"</span></span> <span class="hljs-comment"><span class="hljs-comment">"$&lt;"</span></span> ####### <span class="hljs-type"><span class="hljs-type">Build</span></span> rules</code> </pre> <br></div></div><br>  Rebuild. <br><br>  Whew!  It seems to be all right.  Add to LD_LIBRARY_PATH the path to the lib folder.  We try to run the test example simple_example - the error takes off: <br><br> <code>simple_example.cpp:64: int main(int, char**): Assertion `PFAC_STATUS_SUCCESS == PFAC_status' failed.</code> <br> <br>  If you add the output PFAC_status - we get the status 10008, which corresponds to PFAC_STATUS_ARCH_MISMATCH.  For reasons unknown, the architecture is not supported. <br>  We dive into the code deeper.  In the src / PFAC.cpp file, we find the following code that generates this status. <br><br><div class="spoiler">  <b class="spoiler_title">there‚Äôs not much</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> device_no = <span class="hljs-number"><span class="hljs-number">10</span></span>*deviceProp.major + deviceProp.minor ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">30</span></span> == device_no ){ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span> (modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm30.so"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">21</span></span> == device_no ){ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span> (modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm21.so"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">20</span></span> == device_no ){ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span> (modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm20.so"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">13</span></span> == device_no ){ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span> (modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm13.so"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">12</span></span> == device_no ){ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span> (modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm12.so"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">11</span></span> == device_no ){ <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span> (modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm11.so"</span></span>); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PFAC_STATUS_ARCH_MISMATCH ; }</code> </pre> <br></div></div><br>  From the comments next to it becomes clear that the code does not work only with compute capability 1.0.  Replace this fragment with <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> device_no = <span class="hljs-number"><span class="hljs-number">10</span></span>*deviceProp.major + deviceProp.minor ; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-number"><span class="hljs-number">11</span></span> &gt; device_no ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PFAC_STATUS_ARCH_MISMATCH ; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(modulepath, <span class="hljs-string"><span class="hljs-string">"libpfac_sm%d.so"</span></span>, device_no);</code> </pre><br>  It seems now everything is fine.  More explicit dependencies on the version of the computational capabilities of the video card are not observed. <br><br>  Again, try running the test version.  Observe a strange error: <br><br> <code>Error: fails to PFAC_matchFromHost, PFAC_STATUS_CUDA_ALLOC_FAILED: allocation fails on device memory.</code> <br> <br>  Fortunately, there is a way to enable debug information in the library. <br>  In the include / PFAC_P.h file you need to uncomment the line <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PFAC_PRINTF( ... ) printf( __VA_ARGS__ )</span></span></code> </pre> <br>  And, accordingly, comment out <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//#define PFAC_PRINTF(...)</span></span></code> </pre> <br>  Now, after running simple_example, you can see a more distinct error message: <br><br> <code>Error: cannot bind texture, 11264 bytes invalid texture reference <br> Error: fails to PFAC_matchFromHost, PFAC_STATUS_CUDA_ALLOC_FAILED: allocation fails on device memory</code> <br> <br>  Yeah, so the problem is not the allocation of memory, but the use of texture memory.  PFAC allows you to disable texture memory.  Let's try to use it.  In the test / simple_example.cpp file, after creating the handle, add the line: <br><br><pre> <code class="cpp hljs">PFAC_setTextureMode(handle, PFAC_TEXTURE_OFF ) ;</code> </pre> <br>  The miracle happened, the console gave us the long-awaited lines. <br><br><div class="spoiler">  <b class="spoiler_title">Something found</b> <div class="spoiler_text"> <code>At position 0, match pattern 1 <br> At position 1, match pattern 3 <br> At position 2, match pattern 4 <br> At position 4, match pattern 4 <br> At position 6, match pattern 2</code> <br> </div></div><br>  However, ancient manuscripts suggest that texture memory improves performance through the use of texture cache.  Well, let's try to run PFAC with texture memory. <br><br>  PFAC supports 2 modes of operation PFAC_TIME_DRIVEN and PFAC_SPACE_DRIVEN.  We are interested in the first.  The implementation is located in the src / PFAC_kernel.cu file. <br><br>  We find the lines where the texture memory is mounted on the global one: <br><br><pre> <code class="cpp hljs">cuda_status = cudaBindTexture( &amp;offset, (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> struct textureReference*) texRefTable, (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*) handle-&gt;d_PFAC_table, (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> struct cudaChannelFormatDesc*) &amp;channelDesc, handle-&gt;sizeOfTableInBytes ) ;</code> </pre> <br>  For video cards with compute capability 5.0 and later, the implementation of the texture memory operation is somewhat changed and the access mode set is incorrect, so we replace this line with <br><br><pre> <code class="cpp hljs">cuda_status = cudaBindTexture( &amp;offset, tex_PFAC_table, (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*) handle-&gt;d_PFAC_table, handle-&gt;sizeOfTableInBytes ) ;</code> </pre> <br>  After that, in the test / simple_example.cpp file we turn on the texture memory again: <br><br><pre> <code class="cpp hljs">PFAC_setTextureMode(handle, PFAC_TEXTURE_ON ) ;</code> </pre> <br>  We check the work - everything works. <br><br><h3>  <b>Testing and Comparison</b> </h3><br>  Now look at the performance of the library. <br><br>  For testing we will use signatures provided by <a href="https://www.clamav.net/downloads">clamAV</a> <br>  Download the file main.cvd.  Next, unpack <br><br><pre> <code class="bash hljs">dd <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>=main.cvd of=main.tar.gz bs=512 skip=1 tar xzvf main.tar.gz</code> </pre><br>  We will test on the signatures of the main.mdb file.  We do many routine actions: we cut off n lines and consider them to be patterns, shaflim input data, etc.  I think here it‚Äôs no longer necessary to bump into the details. <br><br>  In order to play with performance, I have somewhat modernized the test / simple_example.cpp file. <br><br><div class="spoiler">  <b class="spoiler_title">Today it looks like this</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;iostream&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;assert.h&gt; #include &lt;chrono&gt; #include &lt;PFAC.h&gt; int main(int argc, char **argv) { if(argc &lt; 2){ printf("args input file, input pattern\n" ); return 0; } char dumpTableFile[] = "table.txt" ; char *inputFile = argv[1]; //"../test/data/example_input" ; char *patternFile = argv[2];//"../test/pattern/example_pattern" ; PFAC_handle_t handle ; PFAC_status_t PFAC_status ; int input_size ; char *h_inputString = NULL ; int *h_matched_result = NULL ; // step 1: create PFAC handle PFAC_status = PFAC_create( &amp;handle ) ; PFAC_status = PFAC_setTextureMode(handle, PFAC_TEXTURE_OFF); printf("%d\n", PFAC_status); assert( PFAC_STATUS_SUCCESS == PFAC_status ); // step 2: read patterns and dump transition table PFAC_status = PFAC_readPatternFromFile( handle, patternFile) ; if ( PFAC_STATUS_SUCCESS != PFAC_status ){ printf("Error: fails to read pattern from file, %s\n", PFAC_getErrorString(PFAC_status) ); exit(1) ; } // dump transition table FILE *table_fp = fopen( dumpTableFile, "w") ; assert( NULL != table_fp ) ; PFAC_status = PFAC_dumpTransitionTable( handle, table_fp ); fclose( table_fp ) ; if ( PFAC_STATUS_SUCCESS != PFAC_status ){ printf("Error: fails to dump transition table, %s\n", PFAC_getErrorString(PFAC_status) ); exit(1) ; } //step 3: prepare input stream FILE* fpin = fopen( inputFile, "rb"); assert ( NULL != fpin ) ; // obtain file size fseek (fpin , 0 , SEEK_END); input_size = ftell (fpin); rewind (fpin); // allocate memory to contain the whole file h_inputString = (char *) malloc (sizeof(char)*input_size); assert( NULL != h_inputString ); h_matched_result = (int *) malloc (sizeof(int)*input_size); assert( NULL != h_matched_result ); memset( h_matched_result, 0, sizeof(int)*input_size ) ; // copy the file into the buffer input_size = fread (h_inputString, 1, input_size, fpin); fclose(fpin); auto started = std::chrono::high_resolution_clock::now(); // step 4: run PFAC on GPU PFAC_status = PFAC_matchFromHost( handle, h_inputString, input_size, h_matched_result ) ; if ( PFAC_STATUS_SUCCESS != PFAC_status ){ printf("Error: fails to PFAC_matchFromHost, %s\n", PFAC_getErrorString(PFAC_status) ); exit(1) ; } auto done = std::chrono::high_resolution_clock::now(); std::cout &lt;&lt; "gpu_time: " &lt;&lt; std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(done-started).count()&lt;&lt; std::endl; memset( h_matched_result, 0, sizeof(int)*input_size ) ; PFAC_setPlatform(handle, PFAC_PLATFORM_CPU); started = std::chrono::high_resolution_clock::now(); // step 4: run PFAC on CPU PFAC_status = PFAC_matchFromHost( handle, h_inputString, input_size, h_matched_result ) ; if ( PFAC_STATUS_SUCCESS != PFAC_status ){ printf("Error: fails to PFAC_matchFromHost, %s\n", PFAC_getErrorString(PFAC_status) ); exit(1) ; } done = std::chrono::high_resolution_clock::now(); std::cout &lt;&lt; "cpu_time: " &lt;&lt; std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(done-started).count()&lt;&lt; std::endl; memset( h_matched_result, 0, sizeof(int)*input_size ) ; PFAC_setPlatform(handle, PFAC_PLATFORM_CPU_OMP); started = std::chrono::high_resolution_clock::now(); // step 4: run PFAC on OMP PFAC_status = PFAC_matchFromHost( handle, h_inputString, input_size, h_matched_result ) ; if ( PFAC_STATUS_SUCCESS != PFAC_status ){ printf("Error: fails to PFAC_matchFromHost, %s\n", PFAC_getErrorString(PFAC_status) ); exit(1) ; } done = std::chrono::high_resolution_clock::now(); std::cout &lt;&lt; "omp_time: " &lt;&lt; std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(done-started).count() &lt;&lt; std::endl; PFAC_status = PFAC_destroy( handle ) ; assert( PFAC_STATUS_SUCCESS == PFAC_status ); free(h_inputString); free(h_matched_result); return 0; }</span></span></span></span></code> </pre> <br></div></div><br>  Because for time measurements I use std :: chrono, in the test / Makefile file you need to add the -std = c ++ 0x flag.  And do not forget to set the number of threads for OpenMP (I used 4 myself): <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> OMP_NUM_THREADS=4</code> </pre> <br>  Now you can begin to measure performance.  Let's see what the GPU can show.  The length of each pattern is 32, the length of the input data is 128 MB. <br><br>  We get the following schedule: <br><br><img src="https://habrastorage.org/webt/jd/ka/m4/jdkam4a1bcbomvrpxcpqrixif4k.png" alt="image"><br><br>  As the number of patterns grows, performance degrades.  This is not surprising, because the Aho-Corasica algorithm without gathering depends not only on the input data, but also on the patterns, since  for each position in the text, it is necessary to go deep into the tree for the length of the matched substring of the text with the prefix of any attribute, and with an increase in the number of patterns, the probability of finding a substring coinciding with a certain prefix increases. <br><br>  And now a more interesting graph - acceleration, with the help of the GPU. <br><br><img src="https://habrastorage.org/webt/b9/uv/aa/b9uvaa71-dyfowvedvrq4w3lvr4.png" alt="image"><br><br>  On a small number of patterns, it is almost imperceptible, it is eaten by data transfer.  However, as the number increases, so does the acceleration, which indicates the potential possibilities of the GPU in an unusual task. <br><br><h3>  Instead of output </h3><br>  When I took on this task, I was skeptical, because there can be no such thing.  However, the result gives hope for the possibility of using CUDA in an uncharacteristic industry. <br>  The path of the researcher does not end there, it will take a lot of work, a lot of performance research and comparisons with competitors. <br><br>  The first step is made, do not lose hope! </div><p>Source: <a href="https://habr.com/ru/post/344938/">https://habr.com/ru/post/344938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../344926/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ293 (December 11 - 17, 2017)</a></li>
<li><a href="../344930/index.html">How to animate the picture in the browser. Multi-pass WebGL rendering</a></li>
<li><a href="../344932/index.html">Economy solution for the Internet of Things. Azure IoT Hub + Azure functions</a></li>
<li><a href="../344934/index.html">Jeb Klitschko</a></li>
<li><a href="../344936/index.html">The concept of communication in projection modeling</a></li>
<li><a href="../344942/index.html">How to ask questions in IRC</a></li>
<li><a href="../344944/index.html">Aliexpress brain</a></li>
<li><a href="../344946/index.html">Check Point Video & Webinars</a></li>
<li><a href="../344950/index.html">Does Ketchapp clone games?</a></li>
<li><a href="../344952/index.html">Winter internship for mobile developers at Redmadrobot</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>