<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refinement of the vector container for working with large amounts of data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of reading the article ‚ÄúLightweight‚Äù implementation of the vector container, I remembered my experience in dealing with the vector. Act...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refinement of the vector container for working with large amounts of data</h1><div class="post__text post__text-html js-mediator-article">  In the process of reading the article <a href="http://habrahabr.ru/blogs/cpp/112826/">‚ÄúLightweight‚Äù implementation of the vector container, I</a> remembered my experience in dealing with the vector.  Actually, I would like to share this experience. <br><br>  Yes, with an array dimension of 10,000 elements, the extra pointer in the implementation of the element will bring tangible inconveniences, but the real problem of memory when using vector is fully manifested somewhat differently. <br><br><a name="habracut"></a>  Actually, the problem is to allocate memory for new items. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the recent past I worked on a project in which I had to process large data arrays (about 20‚Äì30 thousand elements per array, ~ 24 bytes of static per element).  It was very convenient to use for this vector.  At once I will make a reservation that performance was not a bottleneck in the project. <br><br>  Usually, no one thinks about what happens at the moment when push_back () is called.  We also did not think about it until the memory limit was entered for our application.  And here the rake struck the first blow.  Namely - I had to pay attention to the fact that the graph of memory usage resembles a cardiogram.  Those.  in some seemingly random moments of time, there appear quite significant peaks for a very insignificant time and these peaks are out of limit.  In addition, it was finally noticed that the application has a problem with spontaneous ‚Äúhanging up‚Äù for a short time.  The time was irrelevant, but it was still unclear why the calls to the same method take 1-2 milliseconds or 1-2 seconds. <br><br>  The trial led us to the very push_back (). <br>  During the trial, I learned (from a more savvy colleague) that the memory in the vector is allocated logarithmically, namely: <br>  - if when adding an element there is no reserved memory for it, then size * K memory is reserved, where size is the current size of the vector and K is a factor depending on the implementation of the vector and usually it is 2 (you can read in more detail, for example, <a href="http://alenacpp.blogspot.com/2005/06/vector_30.html">Alena Sagalayeva</a> ). <br><br>  Thus we get the following: <br>  Suppose we already have 1024 elements in the vector.  When push_back () is called, the size of the vector will be increased to 2048 (with K = 2, for simplicity, we assume that this is always the case), but only 1025 elements will actually be stored there.  Of course, the excess reserved memory can be freed up, for example with the help of swap trick, but it seems more correct not to allocate too much, i.e.  use reserve. <br><br>  No sooner said than done.  They added, reassembled and started testing and returned to the beginning because the cardiogram stubbornly continued to take place, as well as "hangs up". <br><br>  In the end, after long reflections on the meaning of life, the principles of operation of the vector and the system of memory allocation, justice prevailed. <br><br>  Let's return to our vector which already has 1024 elements. <br>  For clarity, we assume that the size of the element is 16 bytes. <br>  Then the amount of memory occupied by such a vector (without taking into account the overhead of the vector itself and the dynamic part of the elements) will be 16 kilobytes. <br>  Since the vector is always located in continuous memory, when you try to add to it the ill-fated 1025th element, the following happens: <br><ul><li>  A new memory block of size * K is allocated, i.e.  32 kilobyte </li><li>  The contents of the vector are copied to this new block. </li><li>  old block is destroyed </li><li>  our 1025th element is physically added to the vector </li></ul><br>  So the problem is that at some point in time the amount of memory used is equal to size + size * K, i.e.  and the old block and the new - 48 kilobytes in our case. <br>  On small lists, this does not matter, but imagine a similar operation with a list of several tens of thousands of items.  Using reserve does not save the situation because the picture is almost the same - the old block + new, a little larger than the old one, copying, deleting - 32 kilobytes. <br>  It also turned out that this was also the cause of "hang-ups" - allocating large amounts of memory and then copying the data requires remarkable effort. <br><br>  You can talk for a long time on the optimization of the elements themselves and various spherical horses in a vacuum, but in our case, the solution was the implementation of MultyVector (as we called it), a class that repeats the necessary interface of the original vector that stores data in a vector of vectors, dynamic expansion / cleaning. <br><br>  I think that it would be superfluous to describe all the insides of this uncomplicated wrapper and bring in any code. <br>  Let me just say that in our case the normal size of the internal vector was 1000 elements, and deleting / adding elements to an arbitrary point of the array was so rarely used that they could be neglected and not be afraid that one of the internal vectors would grow to incredible sizes again. <br><br>  Thus, it was possible to replace the work with a large memory block with a set of smaller ones (several vectors of 1000 elements each). <br><br>  The approach does not claim to be the ideal, but coped with the task at 100%. <br><br>  UPD.  I, in fact, do not quite understand the reason for the hollywood in comments, therefore: <br>  1. The specifics of the project did not allow the use of anything third-party.  All the most necessary was provided by the framework.  Among the suitable necessities was only a vector and a leaf.  The vector was more convenient because of the fact that it was necessary to work with such volumes of data learned only by the end of the project.  For the same reason, at first did not think about memory. <br>  2. As for spherical horses in a vacuum and idiots in comments, I already wrote above. </div><p>Source: <a href="https://habr.com/ru/post/113324/">https://habr.com/ru/post/113324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../113317/index.html">Idea for a geolocation startup</a></li>
<li><a href="../113319/index.html">An example of caching software animations in Flash</a></li>
<li><a href="../113320/index.html">Toshiba will participate in the World Mobile Congress</a></li>
<li><a href="../113321/index.html">A complete overview of the capabilities of the Motorola ZINE ZN5</a></li>
<li><a href="../113323/index.html">Negative reviews on the Internet. How to fight?</a></li>
<li><a href="../113325/index.html">Day to business, day to prototype</a></li>
<li><a href="../113328/index.html">Latest GarminASUS A50</a></li>
<li><a href="../113329/index.html">Talismania</a></li>
<li><a href="../113330/index.html">Johannesburg Stock Exchange switches to Linux</a></li>
<li><a href="../113331/index.html">Motorola Xoom - camera project?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>