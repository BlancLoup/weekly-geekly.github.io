<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developing and testing chef dolls with the Sparrowdo tool</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Much has been written about the development of the chef kukbuk and its associated infrastructure, and there are already plenty of tools in this...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developing and testing chef dolls with the Sparrowdo tool</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello!  Much has been written about the development of the <a href="https://docs.chef.io/cookbooks.html">chef kukbuk</a> and its associated infrastructure, and there are already plenty of tools in this area.  Among them are such solutions as <a href="https://www.vagrantup.com/">vagrant</a> , <a href="http://kitchen.ci/">test kitchen</a> , <a href="http://www.foodcritic.io/">food critic</a> , <a href="https://docs.chef.io/chefspec.html">chef spec</a> , <a href="https://github.com/chef/minitest-chef-handler">minitest-chef-handler</a> , <a href="http://serverspec.org/">serverspec</a> , <a href="https://github.com/chef/inspec">inspec</a> .  All of them, in varying degrees, simplify and accelerate the industrial development and testing of chef books and their customized infrastructure. </p><br><p>  If this area is close to you and you also have something to do with the Perl language (more precisely, with <a href="http://perl6.org/">Perl6</a> ), then welcome to the topic. </p><br><p>  So today I‚Äôll tell you how I use <a href="https://habrahabr.ru/post/304982/">Sparrowdo</a> when developing and testing chef cookbooks. </p><br><a name="habracut"></a><br><p>  First, a little introductory. </p><br><h1 id="chto-takoe-sparrowdo">  What is Sparrowdo? </h1><br><p>  <a href="https://github.com/melezhik/sparrowdo">Sparrowdo</a> is an add-on to the sparrow plugin system that allows you to run these ssh plugins on remote servers.  In turn, <a href="https://sparrowhub.org/">sparrow</a> plugins are various automation scripts written mostly (but not limited to these languages) in <a href="https://www.perl.org/">Perl5</a> and <a href="https://en.wikipedia.org/wiki/Bash_(Unix_shell)">Bash</a> .  I have already written a whole series of articles on habrahabr about all of this; anyone who is interested can type in a search <a href="https://habrahabr.ru/search/%3Fq%3Dsparrow">query</a> with the word sparrow and, accordingly, read.  But, so that for the uninitiated reader it would be clear, all this is very similar to the ideology of <a href="https://www.ansible.com/">ansible</a> , when you have a centralized server from which you run different tasks on other remote servers. </p><br><p>  So, you can run various sparrow plugins <em>after</em> or <em>before</em> running the chef client on the server, and perform various checks that determine that the deployment procedure is successful or satisfies certain conditions. </p><br><p>  All this is very similar to writing scripts in the stylespec or inspec with the only difference that sparrow plugins are multi-purpose and are not limited to testing and auditing tasks. In principle, you can implement any other logic that you cannot use for any reason. would like to stuff kukbuk in chef. </p><br><p>  In fact, sparrowdo so conveniently "fit" in the task of automatically setting up servers that I even run the client chef itself ... But, enough theory, let's consider a specific simple but illustrative example ... </p><br><h1 id="pishem-kukbuk-dlya-ustanovki-nginx--tomcat-i-testiruem-ego-s-pomoschyu-sparrowdo">  Writing a kookbook to install nginx + tomcat and test it with sparrowdo </h1><br><p>  For the sake of simplicity, I will use ec2 instance with the chef client preinstalled and configured on the local chef server.  Those.  all questions related to the initial configuration of the system will be left out of the box.  Next we have an ssh key to our instance and a login with sudo: </p><br><pre><code class="hljs pgsql">$ ssh remote.<span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre> <br><p>  Now let's step aside from the issues of access to the server and write our symbolic kukbook, we need: </p><br><ul><li>  install <a href="https://nginx.org/ru/">nginx</a> server </li><li>  install <a href="http://tomcat.apache.org/">tomcat</a> server </li><li>  if the tomcat_redirect attribute is set, configure proxying all requests that come to nginx to the tomcat server running on localhost port 8080 </li></ul><br><h1 id="pishem-kukbuk">  We write kukbuk </h1><br><p>  The code is trivial, again the focus of this article is not on learning to write chef cookbooks, but on using chef in conjunction with sparrowdo / sparrow </p><br><pre> <code class="hljs kotlin"># recipes/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.rb <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-string"><span class="hljs-string">'nginx'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> <span class="hljs-string"><span class="hljs-string">'tomcat7'</span></span> service <span class="hljs-string"><span class="hljs-string">'nginx'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> action [ :enable, :start ] end service <span class="hljs-string"><span class="hljs-string">'tomcat7'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> action [ :enable, :start ] end template <span class="hljs-string"><span class="hljs-string">'/etc/nginx/conf.d/default.conf'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> source <span class="hljs-string"><span class="hljs-string">'nginx.conf'</span></span> mode <span class="hljs-string"><span class="hljs-string">'644'</span></span> variables :tomcat_redirect =&gt; node[:tomcat_redirect] notifies :restart, <span class="hljs-string"><span class="hljs-string">'service[nginx]'</span></span>, :delayed end # attributes/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.rb <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>[:tomcat_redirect] = <span class="hljs-literal"><span class="hljs-literal">false</span></span> # cat templates/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>/nginx.conf server { listen <span class="hljs-number"><span class="hljs-number">80</span></span> default_server; server_name _; root /usr/share/nginx/html; index index.html index.htm; &lt;% <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-meta"><span class="hljs-meta">@tomcat_redirect</span></span> %&gt; location / { proxy_pass http:<span class="hljs-comment"><span class="hljs-comment">//127.0.0.1:8080; } &lt;% else %&gt; location / { try_files $uri $uri/ $uri.html =404; } &lt;% end %&gt; error_page 404 /404.html; location = /404.html { } # redirect server error pages to the static page /50x.html # error_page 500 502 503 504 /50x.html; location = /50x.html { } }</span></span></code> </pre> <br><p>  I think that comments on the code for the kookbook are superfluous, I will only note that by default nginx does not perform proxying on tomcat, since the <code>tomcat_redirect</code> attribute <code>tomcat_redirect</code> set to false.  And finally, let's call the nginx-app kukbook and upload it to the chef server: </p><br><pre> <code class="hljs pgsql"># cat metadata.rb <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-string"><span class="hljs-string">'app-nginx'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-string"><span class="hljs-string">'0.0.1'</span></span> $ knife cookbook upload app-nginx -o ../</code> </pre> <br><p>  Now, actually run the created kukbook on our server. </p><br><h1 id="pishem-sparrowdo-scenariy">  Writing a sparrowdo script </h1><br><p>  Sparrowdo script - code written in Perl6 and running tasks on a remote server.  Tasks are nothing more than sparrow plugins with parameters.  As I said, we will use sparrow, including to start the chef client </p><br><pre> <code class="hljs javascript">$ cat sparrowfile task_run %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"set up chef run list an attributes"</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">"file"</span></span>, parameters =&gt; %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"/tmp/chef.json"</span></span>, content =&gt; q:to/<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>/, { <span class="hljs-string"><span class="hljs-string">"run_list"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"recipe[nginx-app]"</span></span>, ], <span class="hljs-string"><span class="hljs-string">"tomcat_redirect"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span> ), ); task_run %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"run chef-client"</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">"bash"</span></span>, parameters =&gt; %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"chef-client --color --json /tmp/chef.json"</span></span> ), );</code> </pre> <br><p>  A small explanation of the code. </p><br><ul><li><p>  The script file should be called a <code>sparrowfile</code> and should be <code>sparrowfile</code> in the same directory where you will run the client's sparrowdo, it makes sense to keep it in the kukbook directory - clearly and always at hand. </p><br></li><li>  In this example, two sparrow plugins are used: <a href="https://sparrowhub.org/info/bash">file</a> ‚Äî to create files and <a href="https://sparrowhub.org/info/bash">bash</a> ‚Äî to run arbitrary commands on Bash, as already mentioned, they are launched with parameters using the <code>task_run</code> function, and the <code>task</code> parameter in calls to this function adds an arbitrary text description of the task to be performed. </li></ul><br><p>  Now you can run the script.  Since  On the given server, the sparrow client is not yet installed, we start with the --bootstrap option, asking sparrowdo to install the client first, which will perform all tasks: </p><br><pre> <code class="hljs kotlin">$ sparrowdo --http_proxy=$http_proxy --https_proxy=$https_proxy --host=remote.server --ssh_user=root --no_sudo --no_index_update running sparrow tasks on remote.server ... target OS <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> - centos6 push task &lt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> up chef run list an attributes&gt; plg &lt;file&gt; OK push task &lt;run chef-client&gt; plg &lt;bash&gt; OK <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> up task box file - /tmp/sparrowdo-box.json - OK <span class="hljs-symbol"><span class="hljs-symbol">public@</span></span>file <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> uptodate (<span class="hljs-number"><span class="hljs-number">0.0</span></span>.2) <span class="hljs-symbol"><span class="hljs-symbol">public@</span></span>bash <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> uptodate (<span class="hljs-number"><span class="hljs-number">0.1</span></span>.1) running task box from /tmp/sparrowdo-box.json ... &lt;<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-up-chef-run-list-an-attributes&gt; / started <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> target content target created <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> target mode to <span class="hljs-number"><span class="hljs-number">644</span></span> ok scenario succeeded ok output match /target (created|removed)/ ok output match <span class="hljs-string"><span class="hljs-string">'set target content'</span></span> STATUS SUCCEED &lt;run-chef-client&gt; / started [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Forking chef instance to converge... [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: *** Chef <span class="hljs-number"><span class="hljs-number">11.16</span></span>.4 *** [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">48</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Chef-client pid: <span class="hljs-number"><span class="hljs-number">5389</span></span> [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Setting the run_list to [<span class="hljs-string"><span class="hljs-string">"recipe[nginx-app]"</span></span>] from CLI options [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Run List <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> [recipe[nginx-app]] [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Run List expands to [nginx-app] [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Starting Chef Run <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sandbox-generic-ci-i-ef7cbedf [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Running start handlers [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Start handlers complete. [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: HTTP Request Returned <span class="hljs-number"><span class="hljs-number">404</span></span> Not Found: [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Loading cookbooks [nginx-<span class="hljs-symbol"><span class="hljs-symbol">app@</span></span><span class="hljs-number"><span class="hljs-number">0.0</span></span>.1] [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>[nginx] action install (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">1</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing <span class="hljs-keyword"><span class="hljs-keyword">package</span></span>[tomcat7] action install (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">3</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing service[nginx] action enable (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing service[nginx] action start (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">5</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing service[tomcat7] action enable (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">9</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing service[tomcat7] action start (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">9</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Processing template[/etc/nginx/conf.d/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.conf] action create (nginx-app::<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> line <span class="hljs-number"><span class="hljs-number">13</span></span>) [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Chef Run complete <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">3.604494597</span></span> seconds [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Running report handlers [<span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>-<span class="hljs-number"><span class="hljs-number">19</span></span>T10:<span class="hljs-number"><span class="hljs-number">02</span></span>:<span class="hljs-number"><span class="hljs-number">53</span></span>+<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>] INFO: Report handlers complete bash-command-done ok scenario succeeded ok output match <span class="hljs-string"><span class="hljs-string">'bash-command-done'</span></span> STATUS SUCCEED</code> </pre> <br><p>  The first launch of the script worked out well, we see that the chef client installed the required packages and configured them, following the logic set in the kukbook. </p><br><p>  We will slightly change the sparrowdo script, minimizing the output from the client‚Äôs chef during the following launches: </p><br><pre> <code class="hljs javascript">task_run %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"run chef-client"</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">"bash"</span></span>, parameters =&gt; %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">command</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"chef-client --color --json /tmp/chef.json -l error"</span></span> ), );</code> </pre> <br><p>  Now it's time to add a couple of checks that our deployment has ended in success, namely: </p><br><ul><li>  nginx service is visible in the process list </li><li>  tomcat service is visible in the process list </li></ul><br><p>  This may seem redundant, since  chef guarantees us the processing / output of all errors associated with the launch of services, however experience shows that this is not always <em>enough</em> , for example, the service may fall a little later, after the chef client has successfully completed.  And then it never hurts to write a couple more "parallel" tests (which by the way can be run <em>outside the context of the</em> client chef), especially since with sparrowdo this is very easy to do.  Add a couple of tasks to our sparrowdo script: </p><br><pre> <code class="hljs php">task_run %( task =&gt; <span class="hljs-string"><span class="hljs-string">'check nginx process'</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">'proc-validate'</span></span>, parameters =&gt; %( pid_file =&gt; <span class="hljs-string"><span class="hljs-string">'/var/run/nginx.pid'</span></span>, footprint =&gt; <span class="hljs-string"><span class="hljs-string">'nginx.*master'</span></span> ) ); task_run %( task =&gt; <span class="hljs-string"><span class="hljs-string">'check tomcat7 process'</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">'proc-validate'</span></span>, parameters =&gt; %( pid_file =&gt; <span class="hljs-string"><span class="hljs-string">'/var/run/tomcat7.pid'</span></span>, footprint =&gt; <span class="hljs-string"><span class="hljs-string">'java'</span></span> ) );</code> </pre> <br><p>  Here we used the <a href="https://sparrowhub.org/info/proc-validate">proc-validate</a> plugin, which checks the existence of a process by the specified PID file, and also searches for it by following the ‚Äútrace‚Äù in the list of running processes: </p><br><pre> <code class="hljs mel"> $ sparrowdo --http_proxy=$http_proxy --https_proxy=$https_proxy --host=remote.server --ssh_user=root --no_sudo --no_index_update running sparrow tasks on remote.server ... target OS is - centos6 push task &lt;set up chef run list an attributes&gt; plg &lt;<span class="hljs-keyword"><span class="hljs-keyword">file</span></span>&gt; OK push task &lt;run chef-client&gt; plg &lt;bash&gt; OK push task &lt;check nginx process&gt; plg &lt;<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>-validate&gt; OK push task &lt;check tomcat7 process&gt; plg &lt;<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>-validate&gt; OK set up task box <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> - /tmp/sparrowdo-box.json - OK public@file is uptodate (<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>) public@bash is uptodate (<span class="hljs-number"><span class="hljs-number">0.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>) public@proc-validate is uptodate (<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>) running task box from /tmp/sparrowdo-box.json ... &lt;set-up-chef-run-list-an-attributes&gt; / started set target content target created set target mode to <span class="hljs-number"><span class="hljs-number">644</span></span> ok scenario succeeded ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /target (created|removed)/ ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">'set target content'</span></span> STATUS SUCCEED &lt;run-chef-client&gt; / started bash-command-done ok scenario succeeded ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">'bash-command-done'</span></span> STATUS SUCCEED &lt;check-nginx-process&gt; / started pid_file - /var/run/nginx.pid pid <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> pid:<span class="hljs-number"><span class="hljs-number">4526</span></span> process footprint: <span class="hljs-number"><span class="hljs-number">4526</span></span> nginx: master process /usr/ <span class="hljs-number"><span class="hljs-number">31</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span> ok scenario succeeded ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /pid_file - \S+/ ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">'pid file exists'</span></span> ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /pid:\d+/ ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /process footprint:/ ok <span class="hljs-string"><span class="hljs-string">'process footprint: 4526 nginx: master process /usr/ 31:47'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /nginx.*master/ STATUS SUCCEED &lt;check-tomcat7-process&gt; / started pid_file - /var/run/tomcat7.pid pid <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> pid:<span class="hljs-number"><span class="hljs-number">29458</span></span> process footprint: <span class="hljs-number"><span class="hljs-number">29458</span></span> /usr/lib/jvm/java<span class="hljs-number"><span class="hljs-number">-1.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/bin <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">25</span></span> ok scenario succeeded ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /pid_file - \S+/ ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> <span class="hljs-string"><span class="hljs-string">'pid file exists'</span></span> ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /pid:\d+/ ok output <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /process footprint:/ ok <span class="hljs-string"><span class="hljs-string">'process footprint: 29458 /usr/lib/jvm/java-1.6.0/bin 22:11:25'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> /java/ STATUS SUCCEED</code> </pre> <br><p>  Fine.  We see that our services are really running.  Another advantage of this approach is that you can run <em>such</em> checks on an already closed server without running the client chef itself. </p><br><p>  OK, go ahead.  Check the availability of our services on <em>http</em> .  To do this, use the <a href="http://curl.haxx.se/">curl</a> utility, this is what you need to add to our sparrowdo script: </p><br><pre> <code class="hljs php">task_run %( task =&gt; <span class="hljs-string"><span class="hljs-string">'install curl'</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">'package-generic'</span></span>, parameters =&gt; %( <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'curl'</span></span>, ) ); task_run %( task =&gt; <span class="hljs-string"><span class="hljs-string">'check nginx http port'</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">'bash'</span></span>, parameters =&gt; %( command =&gt; <span class="hljs-string"><span class="hljs-string">'sleep 5; curl --retry 2 --noproxy 127.0.0.1 -f -o /dev/null -D - http://127.0.0.1'</span></span>, ) ); task_run %( task =&gt; <span class="hljs-string"><span class="hljs-string">'check tomcat http port'</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">'bash'</span></span>, parameters =&gt; %( command =&gt; <span class="hljs-string"><span class="hljs-string">'sleep 5; curl --retry 2 --noproxy 127.0.0.1 -f -o /dev/null -D - http://127.0.0.1:8080'</span></span>, ) );</code> </pre> <br><p>  ... </p><br><p>  Run the script: </p><br><p> <code>$ sparrowdo --http_proxy=$http_proxy --https_proxy=$https_proxy --host=remote.server --ssh_user=root --no_sudo --no_index_update</code> </p> <br><pre> <code class="hljs dos">#    ... &lt;install-curl&gt; / started package installer /modules/yum/ started trying to install curl ... installer - yum Installed Packages curl.x86_64 <span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">19</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>-<span class="hljs-number"><span class="hljs-number">37</span></span>.el6_4 @base/$releasever ok scenario succeeded ok output match 'Installed' STATUS SUCCEED &lt;check-nginx-http-port&gt; / started % Total % Received % Xferd Average Speed <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> Current Dload Upload Total Spent Left Speed <span class="hljs-number"><span class="hljs-number">102</span></span> <span class="hljs-number"><span class="hljs-number">3698</span></span> <span class="hljs-number"><span class="hljs-number">102</span></span> <span class="hljs-number"><span class="hljs-number">3698</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">3218</span></span>k <span class="hljs-number"><span class="hljs-number">0</span></span> --:--:-- --:--:-- --:--:-- <span class="hljs-number"><span class="hljs-number">0</span></span> HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Server: nginx/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Wed, <span class="hljs-number"><span class="hljs-number">19</span></span> Oct <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span> GMT Content-<span class="hljs-built_in"><span class="hljs-built_in">Type</span></span>: text/html Content-Length: <span class="hljs-number"><span class="hljs-number">3698</span></span> Last-Modified: Fri, <span class="hljs-number"><span class="hljs-number">26</span></span> Apr <span class="hljs-number"><span class="hljs-number">2013</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">36</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span> GMT Connection: keep-alive Accept-Ranges: bytes bash-command-done ok scenario succeeded ok output match 'bash-command-done' STATUS SUCCEED &lt;check-tomcat-http-port&gt; / started % Total % Received % Xferd Average Speed <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Time</span></span> Current Dload Upload Total Spent Left Speed <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">11197</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">11197</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1195</span></span>k <span class="hljs-number"><span class="hljs-number">0</span></span> --:--:-- --:--:-- --:--:-- <span class="hljs-number"><span class="hljs-number">1366</span></span>k HTTP/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Server: Apache-Coyote/<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> Content-<span class="hljs-built_in"><span class="hljs-built_in">Type</span></span>: text/html;charset=ISO-<span class="hljs-number"><span class="hljs-number">8859</span></span>-<span class="hljs-number"><span class="hljs-number">1</span></span> Transfer-Encoding: chunked <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Wed, <span class="hljs-number"><span class="hljs-number">19</span></span> Oct <span class="hljs-number"><span class="hljs-number">2016</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">56</span></span> GMT bash-command-done ok scenario succeeded ok output match 'bash-command-done' STATUS SUCCEED</code> </pre> <br><p>  As we see, our services are available via http.  I note, we previously installed the curl utility, using the <a href="https://sparrowhub.org/info/package-generic">package-generic</a> plugin to install packages. </p><br><p>  Well, finally, we set the <code>tomcat_redirect</code> attribute to true, forcing nginx to proxy all requests to tomcat and verify that this happens. </p><br><p>  Set attribute: </p><br><pre> <code class="hljs javascript">task_run %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">task</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"set up chef run list an attributes"</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">"file"</span></span>, parameters =&gt; %( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">target</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">"/tmp/chef.json"</span></span>, content =&gt; q:to/<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>/, { <span class="hljs-string"><span class="hljs-string">"run_list"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"recipe[nginx-app]"</span></span>, ], <span class="hljs-string"><span class="hljs-string">"tomcat_redirect"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span> ), );</code> </pre> <br><p>  Add the <code>expect_stdout</code> parameter to the <code>bash</code> plugin launch, which will force it to check the STDOUT of the command being executed by the specified regex: </p><br><pre> <code class="hljs php">task_run %( task =&gt; <span class="hljs-string"><span class="hljs-string">'check nginx http port'</span></span>, plugin =&gt; <span class="hljs-string"><span class="hljs-string">'bash'</span></span>, parameters =&gt; %( command =&gt; <span class="hljs-string"><span class="hljs-string">'sleep 5; curl --retry 2 --noproxy 127.0.0.1 -f http://127.0.0.1 | head -n 10'</span></span>, expect_stdout =&gt; <span class="hljs-string"><span class="hljs-string">'Apache Tomcat'</span></span> ) );</code> </pre> <br><p>  Run the script: </p><br><pre> <code class="hljs xml">$ sparrowdo --http_proxy=$http_proxy --https_proxy=$https_proxy --host=remote.server --ssh_user=root --no_sudo --no_index_update #    ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">check-nginx-http-port</span></span></span><span class="hljs-tag">&gt;</span></span> / started <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Apache Tomcat/7.0.57<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"favicon.ico"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"icon"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image/x-icon"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"favicon.ico"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"shortcut icon"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image/x-icon"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tomcat.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> /&gt;</span></span> % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 0 0 0 0 0 0 0 0 --:--:-- --:--:-- --:--:-- 0 curl: (23) Failed writing body (146 != 3151) bash-command-done ok scenario succeeded ok output match 'bash-command-done' ok output match /Apache Tomcat/ STATUS SUCCEED <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">check-tomcat-http-port</span></span></span><span class="hljs-tag">&gt;</span></span> / started % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 11197 0 11197 0 0 3364k 0 --:--:-- --:--:-- --:--:-- 0 HTTP/1.1 200 OK Server: Apache-Coyote/1.1 Content-Type: text/html;charset=ISO-8859-1 Transfer-Encoding: chunked Date: Wed, 19 Oct 2016 12:03:02 GMT bash-command-done ok scenario succeeded ok output match 'bash-command-done' STATUS SUCCEED</code> </pre> <br><h1 id="zaklyuchenie">  Conclusion </h1><br><p>  In this simple example, we learned how to use sparrowdo / sparrow in the development and testing processes of chef cookbooks, namely: </p><br><ul><li>  run the client chef with the specified parameters and attributes on the specified hosts </li><li>  check the existence of processes </li><li>  do the simplest checks on the availability of web services </li><li>  install the tools needed for testing. </li></ul><br><p>  In fact, you could write a lot more.  Cases for using sparrowdo and chef are really a large number.  Just take ready-made plugins <a href="http://sparrowhub.org/search">here</a> or write your own, because it‚Äôs really <a href="https://habrahabr.ru/post/300876/">not difficult</a> and start using sparrowdo in your development. </p><br><p>  The whole feature of the sparrow system, which favorably distinguishes it from other similar tools, such as serverspec / inspec, is that the functionality is not hard-wired "in the kernel", but the user can easily and quickly <a href="https://habrahabr.ru/post/300876/">write</a> his plug-ins that fit his realities and immediately use them using sparrowdo, you can even "compile" more complex scripts based on sparrow plugins using the so-called sparrowdo <a href="https://github.com/melezhik/sparrowdo">modules</a> , which are written in Perl6 (you can write a separate article about this, if you are interested). </p><br><p>  If this article has caused your interest - write, comment, ask questions and ... constructively criticize :)) I would be grateful.  As usual, the single center for documentation and the plugin repository of sparrow is <a href="https://sparrowhub.org/">https://sparrowhub.org</a> </p><br><p>  Thank. </p><br><p>  PS At the end of the article, as usual, a simple question, indirectly related to the topic of the article. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/313034/">https://habr.com/ru/post/313034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313022/index.html">Michael Fezers, author of the book ‚ÄúWorking Effectively with Legacy Code‚Äù, goes to Kharkov with a report</a></li>
<li><a href="../313024/index.html">Do you need marketing automation?</a></li>
<li><a href="../313026/index.html">Encapsulating a novice in a team and inheriting custom</a></li>
<li><a href="../313028/index.html">Google telephone interview experience demonstrating the failure of the hiring process</a></li>
<li><a href="../313030/index.html">Easy tor integration into the android application using the example of a rutracker client</a></li>
<li><a href="../313036/index.html">Why "1984" will not come</a></li>
<li><a href="../313038/index.html">Writing a simple React application using the cellx library</a></li>
<li><a href="../313040/index.html">A person. As the creator of JavaScript, Brendan Ike came to the creation of his company</a></li>
<li><a href="../313042/index.html">Configure the LoRaWAN gateway and create our first IoT application</a></li>
<li><a href="../313044/index.html">How will virtual offices affect our lives?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>