<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with MySQL: how to scale the data warehouse 20 times in three weeks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Earlier in the blog at Habr√© we talked about the development of our product - billing for telecom operators Hydra , and also addressed issues of worki...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with MySQL: how to scale the data warehouse 20 times in three weeks</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/latera/blog/282798/"><img src="https://habrastorage.org/files/252/f59/68d/252f5968d9a54f5fa90710144f2072a8.png"></a> <br><br>  Earlier in the blog at Habr√© we talked about the development of our product - <a href="http://www.hydra-billing.ru/">billing for telecom operators Hydra</a> , and also addressed issues of working with infrastructure and the use of new technologies.  For example, we looked at the <a href="https://habrahabr.ru/company/latera/blog/280734/">advantages of Clojure</a> , situations where it is worthwhile and <a href="https://habrahabr.ru/company/latera/blog/280196/">not worth using MongoDB</a> and <a href="https://habrahabr.ru/company/latera/blog/282281/">restrictions in PostgreSQL</a> . <br><br>  Today we will talk about scaling.  The developers of the open-source email application Nylas published on their blog a <a href="https://nylas.com/blog/growing-up-with-mysql/">story</a> about how they managed to scale the system 20 times in three weeks using the ProxySQL tool.  To do this, they had to move from Amazon RDS to MySQL to EC2.  We present to you the highlights of this interesting article. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  One beautiful day ... </h4><br>  The story began in the summer of 2015. The sun made its way through the fog hovering over San Francisco, on the radio played the hit <a href="https://www.youtube.com/watch%3Fv%3DQcIy9NiNbmo">Bad Blood</a> Taylor Swift and Kendrick Lamar.  Nylas had only two synchronization machines and one MySQL database, managed through Amazon RDS.  It was the simplest solution that the company managed to find at that time. <br><br>  The company's engineers managed to achieve good performance of this configuration so that they slowly worked to improve the synchronization logic and telemetry.  The team understood all the dangers of premature product optimization.  Everyone believed that the best way to succeed in horizontal scaling of the system (sharding) is to postpone it as far as possible.  Therefore, to gain time, engineers were engaged in optimizing work with disks, instance upgrades and data compression. <br><br><h4>  And then users appeared </h4><br>  Everything changed on October 5, 2015. On this day, Nylas N1 was released - an open email application with a beautiful user interface and modern architecture using plug-ins.  The link to the product was published in Hacker News.  According to the Nylas team, this led to the emergence of tens of thousands of new users in minutes.  And along with the users came large amounts of new information. <br><br>  For an hour, the MySQL database stopped dealing with such volumes, and the delay in API work broke all records.  I had to temporarily disable the possibility of registration.  The company has not yet realized the full depth of the problems, but one thing was obvious to everyone: you need to scale as soon as possible. <br><br><h4>  On the barricades </h4><br>  Within a few days after the launch of Nylas N1, several bottlenecks were detected in the code at once.  I had to face the limitations of Redis and MySQL on the intensity of data recording.  Engineers have learned a lot about AWS. <br><br>  But the most serious problem was the database.  Day and night, the Nylas team tried to correct errors such as MySQL connection leaks, as well as poorly optimized queries that negatively affect performance.  In addition to patching holes, it was necessary to think about the future.  The only option is to apply horizontal scaling of data to provide quality support for new users.  That is, the time has come to sharding the system. <br><br><h4>  Why mysql </h4><br>  In 2013, when the company Nylas was founded, its engineers chose MySQL, not only on the basis of specific characteristics, but also because this tool has proven itself in the work of high-loaded projects.  The Cassandra, MongoDB, and Postgres technologies looked impressive and progressed quickly, but engineers were confident that they could create a petabyte processing system using MySQL.  The experience of companies like Facebook, Dropbox, Pinterest, and Uber spoke about this.  Using MySQL allowed to draw on the experience of these technological giants. <br><br>  This base is easy to use, and the requirements of Nylas were initially not particularly large-scale.  Based on this, it was decided to use Amazon RDS hosting.  RDS does not give root access to the MySQL host, but many processes are automated.  For example, backups and point updates. <br><br><h4>  Time to scale </h4><br>  By the time of performance problems, engineers had already squeezed long text columns in the database, which helped save 40% of disk space, and also switched to the use of 6 terabyte disks.  But InnoDB in MySQL DBMS has a <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_Limits.html">limit of 2 TB</a> per table, which was a problem. <br><br>  Engineers considered an option using Amazon Aurora - a MySQL-compatible storage with autoscaling up to 64 TB.  However, even in this case, if a given limit of 64 terabytes is exceeded, it would be necessary to break the data into different tables in order to fit in the InnoDB restrictions.  In addition, the team did not want to depend so heavily on Amazon technology in the long term. <br><br>  Instead, Nylas engineers scaled out using simple data partitioning, as well as creating additional MySQL clusters running on Oracle versions of the database on regular EC2 instances.  The main goal was the simplicity of the configuration, which made it possible to complete the optimization in three weeks. <br><br><h4>  Goodbye RDS </h4><br>  In the process of scaling, it was decided to abandon the RDS.  The reason is the lack of control capabilities, as well as poor experience in implementing optimization solutions.  It seemed that RDS was simply not a solution for building reliable systems with zero downtime. <br><br>  In addition, the ability to configure replication is extremely limited in RDS.  Yes, it has the multi-AZ option for synchronous data copying, but the performance of such operations left much to be desired.  Once its use has led to a 3-hour downtime in the operation of the application Nylas.  I had to contact Amazon engineers and wait for them to investigate the problem. <br><br>  Nylas also tried to create asynchronous copies for a given master database, but it turned out that such a copy was activated with a delay of several minutes.  RDS does not support sequential copying, which was planned to be used to distribute shards across instances of the base. <br><br>  Instead, it turned out that many tasks can be successfully solved using EC2.  Yes, problems may arise with individual instances, but at least it was possible to create a base architecture that is resistant to the effects of the problems described above.  The company decided to abandon the RDS and manage the database independently. <br><br><h4>  Running MySQL on EC2 </h4><br>  Translation of MySQL to EC2 is not an easy process.  It was necessary to write our own scripts to manage tasks that were automated in RDS ‚Äî for example, provisioning new servers, creating and distributing slave instances in the event of a master database failure, and creating and restoring backups.  Nylas has written such scripts from scratch, but there are a <a href="https://engineering.pinterest.com/blog/open-sourcing-pinterest-mysql-management-tools">number of open tools</a> that solve the same problem. <br><br>  One of the shard clusters in MySQL consists of a control node and a sub node.  The second supports updates via the MySQL copy log, and is usually used for backups.  In the process of reconfiguring the system, transferring nodes to different types of instances, the cluster must have more than one slave instance.  If additional slaves are not active, they are marked with the ‚Äúdebug‚Äù EC2 tag, which excludes them from monitoring, backups and other processes for active nodes. <br><br><h4>  Emergency switching </h4><br>  For each base cluster, it was necessary to foresee a situation where the master node refuses to function correctly.  This can happen when the processes in the database get lost or hang, the host becomes unavailable, or something else happens.  In this case, you need to have in stock the possibility of recovery, manually or automatically, when the slave node replaces the master node with time and receives both read and write requests. <br><br>  To solve this problem, a special script was written that allows engineers to manually operate the slave node in this way.  As soon as the team was convinced that this operation can be carried out without fear of data loss, the script was integrated into the standard <a href="https://dev.mysql.com/doc/mysql-utilities/1.5/en/mysqlfailover.html">mysqlfailover</a> tool, with some additions that allow identifying the belonging of nodes.  If a failure occurs in the master node, mysqlfailover finds out about this through the state check mechanism and identifies the slave as a new master.  The mysqlfailover construct, among other things, updates the EC2 tags to display the new configuration. <br><br>  Recovery works automatically, but engineers receive alerts.  After that, one of them can manually detect the node on which the failure occurred, and convert it to a new slave for the cluster.  If this is not possible - for example, in case of data corruption, the previous master is decommissioned, and a new slave is created from the most recent backup.  The system has become resilient to failures, and it has become easier to manage. <br><br>  Application sharding <br><br>  When transferring from one database to several databases on different machines, it is necessary to develop a new mechanism for mapping object IDs to specific servers.  This is especially true if the application refers to the database by the primary key in the secondary storage, as is the case with Redis. <br><br>  Nylas engineers selected a simple solution to this problem: the primary key value of the table is a 64-bit integer, the upper bits contain the shard ID, the lower bits are a local counter of automatic numeric keys. <br><br><pre>  | &lt;- 16bits -&gt; | &lt;-------- 48bits -------&gt; |
 + ------------ + ----------------------- +
 |  shard id |  autoincrement |
 + ------------ + ----------------------- + </pre><br>  This makes it easy to calculate the shard-ID by the primary key.  A request for any object can be sent to the correct shard simply through the primary key.  The simpler the system, the more reliable the work with it in the future. <br><br>  For example, the application's authentication level is able to convert hashed access tokens to an account ID for accessing the API.  The project team managed to shard the service without changing its key components.  Since the Nylas engine as well as the application is an open product, anyone can learn the <a href="https://github.com/nylas/sync-engine/blob/master/inbox/models/session.py">specifics of implementing</a> such a system on GitHub. <br><br><h4>  Creating new shards </h4><br>  Each logical shard is a separately numbered MySQL schema.  All shards have the same table structure and different shards are usually located in the same instance. <br><br>  When creating a new shard, calculate high order bits simply by: <br><br> <code>N = (shard_id&lt;&lt;48) + 1</code> <br> <br>  The value of the automatic finishing keys is calculated as follows: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mailsync_&lt;shard_id&gt;.&lt;tablename&gt; AUTO_INCREMENT=N</code> </pre><br>  The new rows in the table, respectively, will have primary keys N, N + 1, and so on.  In this case, the database tables have automatic keys starting with the value 1. Nylas engineers advise you to pay attention to the MySQL error <a href="https://bugs.mysql.com/bug.php%3Fid%3D199">number # 199</a> when using this method.  This bug is already 13 years old, but it is still not fixed.  To avoid problems with it, the application code should be protected from incorrect values ‚Äã‚Äãof automatic keys - <a href="https://github.com/nylas/sync-engine/blob/master/inbox/ignition.py">here</a> is a description of the solution to this problem (in English). <br><br><h4>  Minimize latency on failure </h4><br>  After sharding, another problem was discovered.  The mysqlfailover configuration used <a href="http://docs.aws.amazon.com/AmazonVPC/latest/UserGuide/vpc-ip-addressing.html">the Amazon VPC secondary IP address</a> as the virtual IP to send application traffic to the wizard site.  But detecting a failure in a node and switching traffic through this virtual ip took about 10 minutes.  All requests during this period, of course, were rejected. <br><br>  Therefore, it was necessary to implement a smooth failover.  Something like how HAProxy can hold requests when the application service restarts, only in the application to MySQL. <br><br>  Here you can use HAProxy in combination with a key value storage, or you can use MySQL cluster tools: <a href="https://github.com/outbrain/orchestrator">Orchestrator</a> or <a href="http://galeracluster.com/">Galera</a> .  In this case, the company chose the simplest solution available.  Ideally, so that there are no additional services that need to be serviced. <br><br><h4>  ProxySQL </h4><br>  This solution was found in <a href="https://github.com/sysown/proxysql">ProxySQL</a> - a new tool with an open license.  If you do not go into details, it can be considered as HAProxy, only sharpened by SQL queries.  After Nylas went to work with ProxySQL, the waiting time when switching nodes decreased from 10 minutes to 10 seconds. <br><br><img src="https://nylas.com/static/img/blog/growing-up-with-mysql/before_proxysql.png" alt="image"><br><br>  <i>Switching without ProxySQL (idle time 10 minutes)</i> <br><br><img src="https://nylas.com/static/img/blog/growing-up-with-mysql/after_proxysql.png" alt="image"><br><br>  <i>Switching from ProxySQL (idle time 10 seconds)</i> <br><br>  In the process, other advantages of working with ProxySQL were discovered: <br><br><ul><li>  dynamic routing; </li><li>  automatic restrictions on queries or transactions, preventing accidental drops in performance; </li><li>  query statistics: allows you to compare queries across application nodes, that is, understand how the load is distributed across shards; </li><li>  the ability to dramatically reduce the number of export connections to the current database of the machine. </li></ul><br>  Nylas engineers use ProxySQL locally for each service connecting to the database, including internal management tools and scripts.  Using proxy in local mode instead of centralized allows you to achieve built-in redundancy, and also minimizes the likelihood of traffic delays on the proxy.  As a result, shards in the system can dynamically shift between database instances ‚Äî the cluster idle time does not exceed 12 seconds. <br><br><h4>  Transfer data to another platform </h4><br>  In March 2016, the company migrated shard 0 (RDS) to in-house MySQL to EC2 through the <a href="http://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/MySQL.Procedural.Exporting.NonRDSRepl.html">replication</a> function.  This allowed us to update the primary keys for the largest table from 32 to 64 bits, which could not be imagined with RDS.  Primary key space (4 billion rows) was fully selected in a couple of months. <br><br><h4>  Plans </h4><br>  Cloud infrastructure Nylas continues to evolve.  After updating the database level, it's time to update the level of the application itself.  The current project includes the separation of synchronization logic across several microservices and updating the process topology with a main data source, such as Kafka.  There is also an option to implement the denormalization of schemas for the API storage level in order to make further work with the application more flexible. <br><br><h4>  Other technical articles from <a href="http://www.latera.ru/">Latera</a> : </h4><br><ul><li>  <a href="http://blog.hydra-billing.ru/stories/574">We automate the accounting of addresses and bindings in IPoE-networks</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/277331/">DoS on your own: What causes the uncontrolled growth of tables in the database</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/273283/">Open source application architecture: How nginx works</a> </li><li>  <a href="https://habrahabr.ru/company/latera/blog/267083/">How to improve resiliency of billing: The experience of "Hydra"</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/282798/">https://habr.com/ru/post/282798/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282786/index.html">Internet bees, or the green future of M2M applications</a></li>
<li><a href="../282788/index.html">Evolution of programming languages</a></li>
<li><a href="../282790/index.html">Security Week 17: Hacking SWIFT and cash registers, soliciting Android with exploits, bypassing AppLocker</a></li>
<li><a href="../282792/index.html">Disconnection of analog satellite TV: 4 years later (part 2)</a></li>
<li><a href="../282794/index.html">Two-headed monster in the world of viruses: GozNym</a></li>
<li><a href="../282800/index.html">Russian translation of the speech by Alex Ionescu "Crazy attempt to rewrite Windows from scratch"</a></li>
<li><a href="../282806/index.html">01100100 years since the birth of Claude Shannon</a></li>
<li><a href="../282808/index.html">UDP / TCP File System, Trivial Remote File System</a></li>
<li><a href="../282810/index.html">JPoint 2016 Java Conference Overview</a></li>
<li><a href="../282820/index.html">Google, along with Rackspace, is developing a new type of server on the IBM Power architecture for data centers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>