<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We build reliable data processing - lambda architecture inside Google BigQuery</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to share a way that allowed us to stop the chaos with data processing. I used to consider this chaos and subsequent re-processi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We build reliable data processing - lambda architecture inside Google BigQuery</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to share a way that allowed us to stop the chaos with data processing.  I used to consider this chaos and subsequent re-processing inevitable, but now we have forgotten what it is.  I give an example implementation on BiqQuery, but the trick is quite universal. <br><img src="https://habrastorage.org/files/572/716/ddc/572716ddc6a34cd0bfa19300f0cf613a.png"><br>  We have quite a standard process of working with data.  Source data in the most raw form is regularly loaded into a single repository, in our case in BigQuery.  From some sources (our own production), data comes every hour, from others (usually third-party sources), data is sent daily. <br><br>  Subsequently, data is processed to a usable state by various users.  These may be internal dashboards;  reports to partners;  results that go into production and influence the behavior of the product.  These operations can be quite complex and include several data sources.  But for the most part, we are coping with this inside BigQuery using SQL + UDF.  Results are stored in separate tables there. <br><a name="habracut"></a><br>  The obvious way to organize this processing is to create a schedule of operations.  If the data is loaded daily at one in the morning, we will set up the processing at 01:05.  If this data source is loaded around the 5th minute of each hour, then we set up the processing for 10th minute of each hour.  The intervals of 5 minutes for users are not critical and it is assumed that everything should work. <br>  But the world is cruel!  Data does not always come on time.  Or do not come at all if you do not fix it.  If your hourly load ended at the 11th minute, and the transformation was launched at the 10th minute - then please wait another hour to see this data in the deshborde.  And if the operation uses several sources, then the situation will be even more fun. <br><br>  Moreover, the raw data being loaded is not always correct (the data is generally not always correct!).  Periodically, data must be cleaned or reloaded.  And then you need to restart all operations and with the correct parameters so that everything can be fixed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      All this, of course, problems with the raw data and it is necessary to solve them.  But this is a war in which you can not finally win.  Something will still be broken.  If the data source is internal, then your developers will be busy with new cool features, not tracking reliability.  If it is third-party data, then generally a pipe.  I wish that at least the processing did not get in the way and as soon as the raw data was repaired, all customers immediately saw the correct results. <br><br>  This is really a big problem.  And how else to solve? <br><br><h4>  Solution # 1 - Remove Problem Details </h4><br>  If processing leads to problems, then do not do it!  Do not do any processing at all and store intermediate results.  As soon as the user needs results, everything must be calculated on the fly from raw data.  Given the speed of BigQuery, this is quite realistic.  Especially if all you do with the data is GROUP BY date and count (1), and only data from the last 14 days is needed. <br><br>  Most analytics work with just such queries.  Therefore, we are actively using this solution.  But this approach does not work with complex transformations. <br><br>  One problem is the complexity of the code.  If you add up all operations in a single SQL query, it will not be read.  Fortunately, this is solved by means of tables of type <a href="https://cloud.google.com/bigquery/querying-data">view</a> .  These are logical tables in BigQuery, data is not stored in them, but generated from a SQL query on the fly.  This greatly simplifies the code. <br><br>  But another problem is performance.  Everything is bad here.  No matter how fast and cheap modern databases are.  If you run a complex transformation in one year of historical data, it will take time and cost money.  There are no other options.  This problem makes this strategy inapplicable in a fairly large percentage of cases. <br><br><h4>  Decision number 2 - to build a complex system </h4><br>  If there is no possibility to do without a processing management system, then you need to build this system well.  Not just a script execution schedule in cron, but a data load monitoring system that determines when and what transformations to run.  Probably the <a href="https://en.wikipedia.org/wiki/Publish%25E2%2580%2593subscribe_pattern">pub / sub pattern is</a> very suitable here. <br><br>  But there is a problem.  If building a complex system is less simple, then it‚Äôs very difficult to maintain it and catch bugs.  The more code, the more problems. <br><br>  Fortunately, there is a third solution. <br><br><h4>  Solution number 3 - lambda architecture!  ‚Ä¶well something like that </h4><br>  <a href="https://en.wikipedia.org/wiki/Lambda_architecture">Lambda architecture</a> is a famous data processing approach that takes advantage of the processing of data on a schedule and in real time: <br><br><img src="https://habrastorage.org/files/3c8/2d6/bbc/3c82d6bbc126491c8705fc2fb0e474e8.png"><br>  <i>* How normally to translate into Russian I do not know, batch job is that a batch job?</i>  <i>Who knows, tell me!</i> <br><br>  Usually this is all built using multiple solutions.  But we use essentially the same trick just inside BigQuery. <br><br>  And this is how it works: <br><br>  <b>Scheduled processing (Batch layer).</b>  We perform daily SQL queries that transform the data currently available, and store the results in tables.  All requests have the following structure: <br><br><img src="https://habrastorage.org/files/99b/6e7/e7e/99b6e7e7eed04bb8b064154c77505b39.png"><br><br>  The results of this query will be stored in table_static (will overwrite it).  Yes, BigQuery allows you to save the results of the query in the table that was used in this query.  As a result, we take the old, already counted data (so as not to recalculate them) and connect with the new data.  X days is the selected period for which we want to recalculate the data to take into account all possible corrections of the raw data.  It is assumed that in X days (how many are individually for the source) all the adjustments will already be made, everything that is broken will be repaired and the data will no longer change. <br><br>  <b>Real-time access (Speed ‚Äã‚Äãlayer + Serving layer).</b>  Both of these tasks are combined into one SQL query: <br><br><img src="https://habrastorage.org/files/99b/6e7/e7e/99b6e7e7eed04bb8b064154c77505b39.png"><br><br>  Yes, this is the same query!  We save it as a view (view) with the name table_live and all users (dashboards, other requests, etc.) pull the results from this view.  Since representations in BigQuery are stored at a logical level (only a query, not data), each time it is accessed, it will recalculate the last X days on the fly and all changes in the initial data will be reflected in the results. <br><br>  Since the request is the same in both cases, in reality, in order to avoid duplication of the code, the daily request (from the batch layer) looks like this: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table_live</code> </pre>  (and save the results to table_static) <br><br>  This approach has several important advantages: <br><ul><li>  Each user gets up to date results, there is no resynchronization between raw data and aggregated data (this is on condition that all the jambs with raw data are resolved in X days) </li><li>  Users get results quickly.  No one recounts 2 years of data every time they are accessed.  Recalculation of the last X days in BigQuery occurs reasonably quickly.  X is chosen so as not to create performance problems.  It‚Äôs possible to switch to the clock instead of the days, of course, but we didn‚Äôt have to do this with our data. </li><li>  No need to even think about the schedule of daily operations.  You just need to do it once a day, but it does not depend on the time of loading the raw data.  In addition, there are no problems if the transformation falls in one day or if it is launched twice.  For the user to notice the problem, it is necessary that the processing "lay" more than X days. </li><li>  To build such a system, you need a minimum amount of code (read - problems).  The SQL query itself is 10 lines longer than the original and is now stored inside BigQuery as a view.  Plus, you need to run daily processing, but this is an elementary task. </li><li>  The cost of this system may be even less than when creating a complex system of schedules.  It seems that it should be more expensive, since we constantly recalculate X days.  But our experience shows the opposite.  If you load data every hour, you will have to do a recalculation every hour, including weekends.  And you have to recalculate, X days ago, to reflect the adjustments.  Total for the week will be typed 24 * 7 = 168 times.  But in reality, the user can open this dashboard only three times a week.  With our approach, we will have to recount 7 times on a daily schedule and plus 3 times on the fly.  Significantly less. </li></ul><br><br>  PS If you like to use tables divided by dates in BigQuery (we love very much), then there is a solution for that.  But this is a topic for another post.  Hint - the <a href="https://cloud.google.com/bigquery/query-reference">functions</a> for working with these tables do not swear, if part of the tables are only views. <br><br>  PPS If views in BigQuery supported caching (as it works with regular queries), that would be really cool.  This would essentially make them materialized views.  And the effectiveness of our approach would be even higher.  If you agree <a href="https://code.google.com/p/google-bigquery/issues/detail%3Fid%3D184">,</a> you can put an asterisk <a href="https://code.google.com/p/google-bigquery/issues/detail%3Fid%3D184">here</a> so that this feature will be implemented faster. </div><p>Source: <a href="https://habr.com/ru/post/279491/">https://habr.com/ru/post/279491/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279477/index.html">How to write custom activation for a business process for cloud Bitrix24</a></li>
<li><a href="../279479/index.html">Peculiarities of national support: in 6 languages ‚Äã‚Äãfrom Moscow, plus Delhi, Bangalore, Bucharest and Tokyo teams</a></li>
<li><a href="../279481/index.html">Interesting cases of work organization on the second line of technical support</a></li>
<li><a href="../279483/index.html">Critical vulnerabilities in the client and server side of Git allow remote code execution</a></li>
<li><a href="../279487/index.html">Dynamic code verification - minimizing fraud risk while maintaining the convenience of making purchases online</a></li>
<li><a href="../279493/index.html">The main tool of every UX expert</a></li>
<li><a href="../279495/index.html">Prototypes as a product presentiment</a></li>
<li><a href="../279497/index.html">Pwn2Own 2016: first results</a></li>
<li><a href="../279499/index.html">My bike or how I saved my nerve cells</a></li>
<li><a href="../279501/index.html">Multi-exclusion or Want to share one interesting architectural trick</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>