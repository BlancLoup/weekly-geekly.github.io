<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHPLego: Unobtrusive AJAX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello dear hablochiteli! 

 Have you ever thought about your site working equally well with JavaScript enabled and without JavaScript? So that if Java...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHPLego: Unobtrusive AJAX</h1><div class="post__text post__text-html js-mediator-article"><img src="http://2page.ru/_storage/2010_12_07__00_16_29__0.59913600.png"><br><br>  Hello dear hablochiteli! <br><br>  Have you ever thought about your site working equally well with JavaScript enabled and without JavaScript?  So that if JavaScript is enabled, the site blocks are overloaded with AJAX-catfish, and if JavaScript is not, then just a transition to a new page took place? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Hmm ... I think this is an interesting task, and this is what a simple solution I managed to come up with.  In this article I will try to describe in general terms the essence of this decision, without going into particular uninteresting details. <br><br>  For myself, I formulated the task according to the following criteria: <br><ul><li>  Navigation through the sections of the site inside and outside the blocks should be carried out with normal links, without any onclick = "...". </li><li>  When javascript is enabled, site blocks overload only their own page area (their own div).  With javascript disabled, the normal link should follow. </li><li>  There should be only one global handler for clicking on the links $ (‚Äúa‚Äù). Click (...), which does all the work of reloading the necessary elements of the page.  If JavaScript is disabled, this handler simply does not work, and the site continues to work as usual. </li><li>  Posting forms with JavaScript enabled also updates only the area in which this form is located.  When disabled, everything works as usual. </li><li>  It should be possible to prohibit AJAX preloading of certain areas of the page, for example, by setting them to some ‚Äúnoajax‚Äù class.  This is if after clicking on a link, too much data on the page changes, and they are all in different blocks.  Then it makes more sense to reload the entire page as a whole than to update each block separately.  It will be faster. </li><li>  It should be possible to specify a link block, which it should overload.  Suppose if we need to overload not only the current block, but also the parent block. </li><li>  If the block was loaded earlier, then it should be taken from the cache in order not to drive excess traffic and not to strain the server with an extra query. </li><li>  If the block is loaded from the cache, the user must somehow understand that this is not the most relevant information, and be able to update the block. </li><li>  No javascript a.  This is of course my personal opinion, but I hate writing in JavaScript.  So I added another item.  Its meaning is that when developing modules to the site I did not write a single line of JavaScript (well, a maximum of one or two per module, and then for some checkbosses in the form).  I don‚Äôt know how you, dear habrochtets, but I, your mother, better sell my soul to the devil, than I will debug my JavaScript in all varieties of browsers! <br></li></ul><br><br>  Well, here are all the wishes.  So let's get down to implementing ... <a name="habracut"></a><br><br>  To begin with, we will have to come up with a system of modules, and how they will be inserted into each other. <br>  The question is where to store the data on the status of each unit?  Where is it better to do this, in cookies, in the $ _SESSION variable, in the $ _GET array or in the database?  I chose the address bar, because  You can always send a link to a friend and be sure that he will see the same thing as we do. <br>  So, we decided that the state of each module should be reflected in the GET parameters.  Those.  According to the parameters in the GET line, each module will be able to determine what information it should display on this request. <br>  I called the modules Lego-objects, and decided to arrange them in the form of classes in PHP. <br><br>  The launch of each Lego object is as follows: <br><br><pre><code class="php hljs">$lego = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyLego(<span class="hljs-string"><span class="hljs-string">'my_name'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// -      // .   run()   GET-   : $lego-&gt;run(); echo $lego-&gt;getOutput(); //      Lego-</span></span></code> </pre> <br><br>  Let's think so that each Lego object listens to its variable from the address bar, which will tell it what to do, which class method to execute.  And to take from the variable the data he needs, if necessary, because actions are usually done for a reason, and over some data - aydishnikami photos, commentary, etc. <br><br>  And also let's agree that the address bar of the form: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// http://example.ru/?my_name[act]=index&amp;my_name[0]=1&amp;my_name[1]=abc</span></span></code> </pre><br>  will call the index () method of a Lego object named my_name, passing two arguments to this method, '1' and 'abc'. <br><br>  Thus, we will make with you such objects, the methods of which can be called directly from the address bar.  For security, of course, we give such methods a prefix in the object, for example action_.  This is so that the attacker could not call any system method and harm our site. <br><br>  In order not to write the same code for each class of a Lego object, let's move it into one base class.  Let's call it Lego.  And all the classes of modules will inherit from it. <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $output; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name = false)</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,        if(!$name) $name = get_class($this); $this-&gt;name = $name; } public function getName(){ return $this-&gt;name; } public function getOutput(){ return $this-&gt;output; } public function run(){ $action = $this-&gt;getAction(); //  , ,       action_ $method_name = 'action_'.$act; if(method_exists($this, $method_name)){ //    ,      GET !!! //  ,    ,    $this-&gt;output $this-&gt;output = call_user_func_array( array( $this, $method_name ), $this-&gt;getActionParams($action)); } else $this-&gt;output = "method {$action} does't exists"; //     AJAX.       ajax={_} if($this-&gt;_get("ajax") == $this-&gt;getName()){ echo $this-&gt;output; //        die; //   . } } //      (  my_name[act]=index); public function getAction(){ $lego_params = $this-&gt;getLegoParams(); if(!is_array($lego_params)) return; if(isset($lego_params["act"])) return $lego_params["act"]; return "default"; //     ,    GET   } //   ,    Lego    public function getLegoParams($lego_name = false){ if(!$lego_name) $lego_name = $this-&gt;getName(); return $this-&gt;_get($lego_name, array()); } //      (  &amp;my_name[0]=1&amp;my_name[1]=abc); public function getActionParams($action){ $lego_params = $this-&gt;getLegoParams(); if(!isset($lego_params[$action])) return array(); if(!is_array($lego_params[$action])) return array(); return $lego_params[$action]; } //     ,      GET static public function _get($key_name, $default_value = false){ return self::__get_from_array($_GET, $key_name, $default_value); } //  ,  ,    static private function __get_from_array($array, $key_name, $default_value = false){ if(!isset($array[$key_name])) return $default_value; return $array[$key_name]; } }</span></span></code> </pre><br><br>  Now, any Lego-module will look like this: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FotoLego</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      http://example.ru/?{lego_name}[act]=allfotos public function action_allfotos(){ $out = "     "; return $out; } //      http://example.ru/?{lego_name}[act]=onefoto&amp;{lego_name}[0]={id_} public function action_onefoto($foto_id){ $out = "        id=$foto_id"; return $out; } //      http://example.ru/?{lego_name}[act]=bestfotos public function action_bestfotos(){ $out = "      "; return $out; } }</span></span></code> </pre><br><br>  And also, it turned out that the Lego-object can contain as many child Lego-objects as it wishes: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeLego</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ .... .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">action_someMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   Lego- $lego = new SomeSublego("sublego_name1"); $lego-&gt;run(); //  return $lego-&gt;getOutput(); //     } public function action_someMethodElse(){ //    Lego- $lego = new SomeSublegoElse("sublegoelse_name1"); $lego-&gt;run(); // , ,      Lego : Smarty::assign("content", $lego-&gt;getOutput()); return Smarty::fetch("some_template.tpl"); //     } .... .... }</span></span></code> </pre><br><br>  And in order to get the output of only the desired Lego object, we just need to add the ajax parameter to the address bar <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// : // http://example.ru/?LegoSite=fotos&amp;ajax={______} //        Lego::run(),     </span></span></code> </pre><br><br>  Well, you can start building the site, at this stage without any AJAX, but quite workable <br><br>  We describe the class of the root lego controller itself: <br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LegoSite</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lego</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   public function action_default(){ //? Default ,        //        : $lego = new LegoAuth(); $lego-&gt;run(); //  Smarty::assign("auth_block", $lego-&gt;getOutput()); //  LegoAuth   //   : $lego = new LegoHotNews(); $lego-&gt;run(); //  Smarty::assign("hotnews_block", $lego-&gt;getOutput()); //  LegoHotNews   //  ,   , : $lego = new LegoArticles(); $lego-&gt;run(); //  Smarty::assign("articles_block", $lego-&gt;getOutput()); //  LegoArticles   //    -: Smarty::fetch("body.tpl"); //        } //   " ".      public function action_about(){ return Smarty::fetch("about_site.tpl"); //     } }</span></span></code> </pre><br><br>  Our entire site will consist of a single file - index.php: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">".common/autoload.php"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    $lego = new LegoSite(); //            $lego-&gt;run(); //   echo $lego-&gt;getOutput();// !     </span></span></code> </pre><br><br>  That's all, the site is ready, it remains only to decorate the templates (you are yourselves) and, most interestingly, add a bit of life-giving JavaScript-a.  I designed it as a jQuery plugin. <br><br>  Jquery.lego.js file: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,      jQuery.fn.lego.load = function(lego_name, url, data, nocache){ jQuery.fn.lego.lastLoadedUrl = urldecode(url); jQuery.fn.lego.loadedUrls[lego_name] = urldecode(url); var lego = $("div.lego[name="+lego_name+"]"); lego.addClass("loading"); var pellicle = $("&lt;div&gt;"); //  ,    pellicle.addClass('pellicle'); $(".lego[name="+lego_name+"]").prepend(pellicle); var no_ajax_url = jQuery.fn.lego.getNoAjaxUrl(url); //  -   ,      if($(".lego[name="+lego_name+"]").length != 1){ document.location = no_ajax_url; return; } location.hash = url; //      //   var from_cache = LegoCache.get(lego_name, url); if(from_cache &amp;&amp; data == null &amp;&amp; !nocache){ //    $(".lego[name="+lego_name+"]").replaceWith(from_cache); return; } $.ajax({ type: data == null ? "GET" : "POST", url: url, data: data, success: function(received){ $().lego.log(", : "+received.length+"    "+lego_name+"..."); if($(received).hasClass('lego')){ $(".lego[name="+lego_name+"]").replaceWith(received); //   LegoCache.put(lego_name, url, received); } else{ $().lego.log(lego_name+":     Lego: "+url); document.location = no_ajax_url; } }, error: function(x){ $().lego.log("   url: "+url); } }); } jQuery.fn.lego.ajaxEnable = function(selector){ jQuery.fn.lego.startProcessHash(); if(!selector) selector = ""; //    $(selector+":not(.noajax) a:not(.noajax)").live("click.myEvent", function(e){ var href = $(e.currentTarget).attr("href"); //    if(href.match(/^(http(s)?:\/\/)|(javascript)/i)) return true; var name = $(e.currentTarget).lego().attr("name"); var legotarget = $(e.currentTarget).attr("legotarget"); if(typeof legotarget == "undefined") legotarget = name; var ajax_url = jQuery.fn.lego.getAjaxUrl(href, legotarget); jQuery.fn.lego.load(legotarget, ajax_url); return false; }); //    $("form:not(.noajax)").livequery("submit", function(e){ var name = $(this).lego().attr("name"); var legotarget = $(this).attr("legotarget"); if(typeof legotarget == "undefined") legotarget = name; jQuery.fn.lego.load(legotarget, $().lego.getAjaxUrl($(this).attr("action"), legotarget), $(this).serialize()); return false; }); } //  var LegoCache = { cache: {}, put: function(lego_name, url, data){ this.cache[lego_name+url] = data; }, get: function(lego_name, url, data){ if(typeof this.cache[lego_name+url] != 'undefined'){ var ret = $(this.cache[lego_name+url]); var reload_block = $("&lt;a href='javascript:void(0)' onclick='jQuery.fn.lego.reload(this)' /&gt;"); reload_block.html("   , "); reload_block.addClass('reload_block'); try{ ret.prepend(reload_block); }catch(e){} return ret; } } }</span></span></code> </pre><br><br>  Of course, the full version still has a couple of minor functions that I did not include here, I'm afraid the article will become poorly readable because of this.  But they are always available in SVN, at your service. <br>  The full version of the PHPLego source code can be viewed in the repository on Google code: <br>  <a href="http://code.google.com/p/phplego/">code.google.com/p/phplego</a> <br>  There you can get invites to participate in the development. <br><br>  You can test how it works in practice <a href="http://xn--e1afggmlij4g.xn--p1ai/">here</a> . <br><br>  Thank you, I hope someone will come in handy.  Always yours, Jozhik. <br><br>  PS Anyone who wants to share their Lego-modules, write to me, I already have something to maintain the exchange :) </div><p>Source: <a href="https://habr.com/ru/post/109481/">https://habr.com/ru/post/109481/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../109475/index.html">Come in! Authentication without login and password, "remember me"</a></li>
<li><a href="../109476/index.html">Saving hypertext documents in different browsers</a></li>
<li><a href="../109477/index.html">JavaScript Performance Best Practices</a></li>
<li><a href="../109479/index.html">Long-liver</a></li>
<li><a href="../109480/index.html">Static analysis and regular expressions</a></li>
<li><a href="../109483/index.html">LibreOffice 3.3 RC1</a></li>
<li><a href="../109486/index.html">AndroidDev # 1. Create a file manager</a></li>
<li><a href="../109487/index.html">AOL may be sold piece by piece.</a></li>
<li><a href="../109488/index.html">Service counter cuts and rollbacks in public institutions</a></li>
<li><a href="../109492/index.html">Youtube Remote for Youtube Leanback</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>