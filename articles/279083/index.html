<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grid implementation for working with large tables. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous part of the article , the general principle of the system was disassembled: we saw that its two main blocks are an interpolator and a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grid implementation for working with large tables. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habr.com/post/278773/">previous part of the article</a> , the general principle of the system was disassembled: we saw that its two main blocks are an interpolator and a numerator.  We built the interaction scheme, and also fully discussed the implementation of the interpolator.  In this part, we will analyze the implementation of a numerator: a reversible function that translates a set of values ‚Äã‚Äãof key fields into a natural number (BigInteger) in such a way that the set <img src="https://tex.s2cms.ru/svg/%5Cinline%20%28K_1%2C%5Cldots%20K_n%29">  less set <img src="https://tex.s2cms.ru/svg/%5Cinline%20%28K%27_1%2C%5Cldots%20K%27_n%29">  from the point of view of a DBMS if and only if <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%28K_1%2C%5Cldots%20K_n%29%20%3C%20g%28K%27_1%2C%5Cldots%20K%27_n%29">  .  Simply put, let's learn how to interpolate sets of values ‚Äã‚Äãand, most interestingly, the lines: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7f0/d24/1d2/7f0d241d29704ace8161638ab97664ab.png" width="700"></div><br><a name="habracut"></a><br><br><h3>  Numerator for composite key </h3><br>  Let us call the power of the data type the number of different values ‚Äã‚Äãthat can be represented using this type.  The BIT type, for example, has a power of 2, and the type INT - 2 <sup>32</sup> .  Let the composite key data types have capacities <img src="https://tex.s2cms.ru/svg/%5Cinline%20N_1%2C%5Cldots%2C%20N_n">  .  Then the total number of possible combinations of the key field values ‚Äã‚Äãof the composite key is <img src="https://tex.s2cms.ru/svg/%5Cinline%20N_1N_2%5Cldots%20N_n">  .  Suppose we can already calculate the functions of the numerators for the value of each of the fields, <img src="https://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa_i">  - ordinal value <img src="https://tex.s2cms.ru/svg/%5Cinline%20i">  th field.  Then the function of the numerator of the composite key can be represented through the functions of the enumerators of each of the fields as 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0Ag%28K_1%2C%5Cldots%20K_n%29%20%3D%20%20%5Ckappa_n%20%2B%20N_n%5Ckappa_%7Bn-1%7D%20%2B%20N_nN_%7Bn-1%7D%5Ckappa_%7Bn-2%7D%20%2B%20%5Cldots.%0A"></div><br>  It is easy to verify that 1) the value <img src="https://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa_1">  has the greatest weight <img src="https://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa_n">  - the smallest, and the basic requirement for the function-numbering fulfilled, 2) <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%28N_1%20-%201%2C%20N_2-1%2C%5Cldots%20N_%7Bn-1%7D-1%29%20%3D%20N_1N_2%5Cldots%20N_n%20-%201">  . <br><br>  Immediately note that the calculation <img src="https://tex.s2cms.ru/svg/%5Cinline%20g">  directly by the above formula requires <img src="https://tex.s2cms.ru/svg/%5Cinline%20%28n-1%29n%2F2">  multiplication operations, and it is better to use the analog <a href="https://en.wikipedia.org/wiki/Horner%27s_method">of the Horner scheme</a> to reduce the number of multiplications to <img src="https://tex.s2cms.ru/svg/%5Cinline%20n-1">  with the same number of additions: <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0Ag%28K_1%2C%5Cldots%20K_n%29%20%3D%20%28%28%5Cldots%28%5Ckappa_1N_2%20%2B%20%5Ckappa_2%29%5Cldots%29N_%7Bn-1%7D%20%2B%20%5Ckappa_%7Bn-1%7D%29N_n%20%2B%20%5Ckappa_n.%0A"></div><br>  Now we need an algorithm for calculating the inverse function <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%5E%7B-1%7D">  .  Note that the value <img src="https://tex.s2cms.ru/svg/%5Cinline%20g">  similar to the interpretation of the number <img src="https://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa_1%5Ckappa_2%5Cldots%5Ckappa_n">  in the positional number system, only with a constantly changing from ‚Äúdigit‚Äù to ‚Äúdigit‚Äù basis.  Correspondingly, transform the value <img src="https://tex.s2cms.ru/svg/%5Cinline%20g">  back to the set of "numbers" is possible by the algorithm, which is a variation of the algorithm for representing a number in the number system with a given base (here value = <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa">  , keys [i] .cardinality () = <img src="https://tex.s2cms.ru/svg/%5Cinline%20N_i">  ): <br><br><pre><code class="java hljs">BigInteger v = value; BigInteger[] vr; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = keys.length - <span class="hljs-number"><span class="hljs-number">1</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { vr = v.divideAndRemainder(keys[i].cardinality()); keys[i].setOrderValue(vr[<span class="hljs-number"><span class="hljs-number">1</span></span>]); v = vr[<span class="hljs-number"><span class="hljs-number">0</span></span>]; }</code> </pre> <br><br><h3>  Numbering for primitive data types </h3><br>  With the composite key sorted out, it remains to build numbering for the types encountered in practice. <br><br><ol><li>  The numbering of <b>BIT</b> values ‚Äã‚Äãis trivial: false - 0, true - 1. </li><li>  The numbering of <b>INT</b> values ‚Äã‚Äãis slightly more complicated: an INT value (a 32-bit integer with a sign) is a number between -2147483648 and 2147483647. Thus, the numerator for the INT type is simply <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%28k%29%20%3D%20k%20%2B%202147483648">  .  Of course, one should perform addition, having already given <img src="https://tex.s2cms.ru/svg/%5Cinline%20k">  to type BigInteger.  Inverse function <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%5E%7B-1%7D%28%5Ckappa%29%20%3D%20%5Ckappa%20-%202147483648">  . </li><li>  Similarly, you can build a numerator for 64-bit signed integers (you need to add 9223372036854775808). </li><li>  <b>DOUBLE</b> (double precision floating point) numbers, presented in IEEE 754 format, have the property that they can (with minor exceptions like NaN and ¬± 0) be compared as signed 64-bit integers.  For example, in Java, you can get for a value of type double its 64-bit image in IEEE 754 format using the Double.doubleToLongBits method. </li><li>  Finally, <b>DATETIME</b> values ‚Äã‚Äãthat determine the time point with an accuracy of a millisecond can also be reduced to a 64-bit integer with a sign specifying the so-called ‚ÄúUNIX time‚Äù, i.e. the number of milliseconds from midnight on January 1, 1970.  For example, in Java this is done using the Date.getTime () method. </li><li>  Strings ( <b>VARCHAR</b> ) require a separate large conversation. </li></ol><br><br><h3>  Line numerator (first approximation) </h3><br><br>  If the length of the string is not limited, then the task of creating a numerator is impossible: between the lines 'a' and 'b' there are infinitely many lines 'aa', 'aaa', 'aaaa' ... in lexicographical order, and between any two natural numbers always a finite number of natural numbers.  The mathematician will say that the orders of a set of lexicographically ordered strings and sets of natural numbers are <i>non-isomorphic</i> .  Fortunately, in the known DBMS, an index can be built only on a string of limited length, and this fundamentally changes the situation. <br><br>  If the alphabet contains <img src="https://tex.s2cms.ru/svg/%5Cinline%20a">  characters, the total number of lines of length not more than <img src="https://tex.s2cms.ru/svg/%5Cinline%20m">  in this alphabet equals <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0A1%20%2B%20a%20%2B%20a%5E2%20%2B%20%5Cldots%20%2B%20a%5E%7Bm%7D%20%3D%20%5Cfrac%7Ba%5E%7Bm%2B1%7D-1%7D%7Ba-1%7D.%0A"></div><br>  Here, the unit corresponds to an empty string, <img src="https://tex.s2cms.ru/svg/%5Cinline%20a">  - the number of lines of one character, <img src="https://tex.s2cms.ru/svg/%5Cinline%20a%5E2">  - the number of lines of two characters, etc., and in the end it turns out the good old amount of a geometric progression. <br><br>  Imagine now an arbitrary string. <img src="https://tex.s2cms.ru/svg/%5Cinline%20c">  lengths <img src="https://tex.s2cms.ru/svg/%5Cinline%20l%20%5Cleq%20m">  as an array <img src="https://tex.s2cms.ru/svg/%5Cinline%20%28c_0%2C%20c_1%2C%5Cldots%20c_%7Bl-1%7D%29">  where <img src="https://tex.s2cms.ru/svg/%5Cinline%20c_i">  - number <img src="https://tex.s2cms.ru/svg/%5Cinline%20i">  th symbol of a line in the alphabet (counting from zero), positions of characters in a string are also considered from zero.  Then the string <img src="https://tex.s2cms.ru/svg/%5Cinline%20c">  in simple lexicographical order will have a number <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0Ag%28c%29%20%3D%20l%20%2B%20%5Cfrac%7Ba%5Em%20-%201%7D%7Ba%20-%201%7Dc_0%20%2B%20%5Cfrac%7Ba%5E%7Bm%20-1%7D%20-%201%7D%7Ba%20-%201%7Dc_1%20%2B%20%5Cldots%20%2B%20%5Cfrac%7Ba%5E%7Bm%20-%20l%20%2B%201%7D%20-%201%7D%7Ba%20-%201%7Dc_%7Bl-1%7D.%0A"></div><br><br><div class="spoiler">  <b class="spoiler_title">Proof of this formula</b> <div class="spoiler_text">  produced naturally by induction.  Indeed: if <img src="https://tex.s2cms.ru/svg/%5Cinline%20m%20%3D%200">  , the only option is an empty string with the number 0. <br><br>  If a <img src="https://tex.s2cms.ru/svg/%5Cinline%20m%20%3D%201">  , the empty line will have the number 0, and each single-character will have the number <img src="https://tex.s2cms.ru/svg/%5Cinline%201%20%2B%20c_0">  .  The unit is added because when comparing strings, an empty string will be less than any single-character string: 0 - '', 1 - 'a', 2 - 'b' ... <br><br>  If a <img src="https://tex.s2cms.ru/svg/%5Cinline%20l%20%5Cleq%201">  , <img src="https://tex.s2cms.ru/svg/%5Cinline%20m%20%5Cgeq%201">  , then still 0 - '', 1 - 'a'.  But now between the strings' a 'and' b 'in the space of lexicographically sorted strings are all possible strings of the form' 'a' plus any string no longer than <img src="https://tex.s2cms.ru/svg/%5Cinline%20m%20-%201">  ": 'A', 'aa', 'aaa' ..., 'aab' ...: <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0A%5Coverbrace%7Ba%5Cunderbrace%7B%5Csquare%5Csquare%5Csquare%20%5Cldots%20%5Csquare%7D_%7B%5Cleq%20m-1%7D%7D%5E%7B%5Cleq%20m%7D.%0A"></div><br>  The number of such lines is equal to <img src="https://tex.s2cms.ru/svg/%5Cinline%20%28a%5Em-1%29%2F%28a-1%29">  , and finally for single-character strings <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0Ag%28c%29%20%3D%201%20%2B%20%5Cfrac%7Ba%5Em%20-%201%7D%7Ba%20-%201%7Dc_0.%0A"></div><br>  Let one more character be added to the string, while still <img src="https://tex.s2cms.ru/svg/%5Cinline%20l%5Cleq%20m">  .  The number of this symbol with the corresponding weight (equal to the number of lines of length <img src="https://tex.s2cms.ru/svg/%5Cinline%20m%20-%20l">  ).  A unit is added to the first term for each additional symbol, due to the fact that the string obtained by dropping the last symbol will be less than any of the strings of a length in the lexicographical order <img src="https://tex.s2cms.ru/svg/%5Cinline%20l">  . <br></div></div><br>  To optimize the calculation <img src="https://tex.s2cms.ru/svg/%5Cinline%20g">  and the inverse function, you need to prepare in advance an array of coefficients <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0Aq_i%20%3D%20%5Cfrac%7Ba%5E%7Bm%20-%20i%7D%20-%201%7D%7Ba%20-%201%7D%2C%20i%20%3D%200%2C%5Cldots%20m-1.%0A"></div><br>  Of course, use this formula directly when storing values <img src="https://tex.s2cms.ru/svg/%5Cinline%20q_i">  no need: you can save on arithmetic operations by noticing that all <img src="https://tex.s2cms.ru/svg/%5Cinline%20q_i">  are partial sums of a geometric progression that can be calculated ‚Äúon the fly‚Äù when filling an array <img src="https://tex.s2cms.ru/svg/%5Cinline%20q_i">  . <br><br>  Algorithm to calculate the inverse function <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%5E%7B-1%7D">  , as in the case of a composite key numerator, is a variation of the algorithm for converting a number into a number system with an arbitrary base.  It is only necessary at each step to subtract the unit before receiving the next character, keeping in mind the first term in the formula for <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%28c%29">  : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; m; i++) { r = r.subtract(BigInteger.ONE); cr = r.divideAndRemainder(q[i]); r = cr[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c = cr[<span class="hljs-number"><span class="hljs-number">0</span></span>].intValue(); arr[i] = c; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.equals(BigInteger.ZERO)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i + <span class="hljs-number"><span class="hljs-number">1</span></span> &lt; m) arr[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = END_OF_STRING; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br><br><h3>  The line numerator for matching rules </h3><br>  The order in which the database sorts string values ‚Äã‚Äãis actually different from simple lexicographical and uses so-called <a href="http://www.unicode.org/reports/tr10/">Unicode collation rules</a> . <br><br>  When comparing strings based on these rules, the database is considered in three aspects: the character itself, its case (case), and its variant (accent).  For example, the Russian letter "e" in most cases is considered as having two spellings, each of which has two registers: e, E;  , . This allows for sorting, insensitive to the variant of writing (accent insensitive), not to distinguish between "e" and "", and when sorting to be case-insensitive, not to distinguish between uppercase and lowercase letters.  At the same time, what is considered a separate letter, and what is a variant of writing another letter, depends on cultural traditions and may differ even in languages ‚Äã‚Äãthat use the same alphabet. <br><br>  For example, if in the Russian cultural tradition there are still disagreements about the status of the letter "", then no one doubts that "and" and "d" are different letters.  In the alphabetical list of cities "Yoshkar-Ola" should follow after "Irkutsk", whatever the mode of sorting.  If, however, in the PostgreSQL database, you specify accent insensitive collation English-US and enter a list of cities in the table, then by sorting them by name, you may find that Yoshkar-Ola will follow ‚ÄúIrkutsk‚Äù, although after ‚ÄúIzhevsk ".  The reason, of course, is that the chosen set of matching rules considers the ‚Äúd‚Äù not an independent symbol, but a variant of writing the letter ‚Äúand‚Äù: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cc7/10e/983/cc710e983fb1409b93f7c1a50dad1d2d.png"></div><br><br>  The general algorithm for string comparison, taking into account matching rules, is as follows: <br><br><ol><li>  Strings are compared character by character without taking into account registers and variants.  If a difference is found, the result is returned (‚Äúmore‚Äù or ‚Äúless‚Äù). </li><li>  If the sorting is accent sensitive, the numbers of variants of each of the characters are compared.  If a difference is found, the result is returned. </li><li>  If sorting is case sensitive, the registers of each of the characters are compared.  If a difference is found, the result is returned. </li><li>  If the exit from the algorithm has not happened so far - the lines are equal. </li></ol><br><br>  All these subtleties are essential for the implementation of our task, since adequate work of the grid is possible only if the values ‚Äã‚Äãreturned by the numerator increase on an increasing set (from the point of view of the database!) Set of arguments. <br><br>  Thus, we, first, need to modify the algorithm of the numerator for strings so that it takes into account matching rules, and second, we need to be able to set different matching rules, ‚Äúteaching‚Äù the grid to work with this or that database. <br><br>  The first of these tasks is relatively simple considering the results already obtained.  Any string value must not be treated as a one-dimensional array of characters. <img src="https://tex.s2cms.ru/svg/%5Cinline%20c_i">  , and as an array of three-component values ‚Äã‚Äã(vectors, if you like) <img src="https://tex.s2cms.ru/svg/%5Cinline%20c_%7Bij%7D">  , <img src="https://tex.s2cms.ru/svg/%5Cinline%200%20%5Cleq%20j%20%5Cleq%202">  .  Here <img src="https://tex.s2cms.ru/svg/%5Cinline%20c_%7Bi0%7D">  - number <img src="https://tex.s2cms.ru/svg/%5Cinline%20i">  th symbol in the alphabet <img src="https://tex.s2cms.ru/svg/%5Cinline%20c_%7Bi1%7D">  - his spelling variant, <img src="https://tex.s2cms.ru/svg/%5Cinline%20c_%7Bi2%7D">  - his own register.  Then work with a string field can be done similarly to working with a composite key consisting of three fields. <br><br>  If known <img src="https://tex.s2cms.ru/svg/%5Cinline%20a_0">  - the number of characters in the alphabet, <img src="https://tex.s2cms.ru/svg/%5Cinline%20a_1">  - the maximum number of spellings and <img src="https://tex.s2cms.ru/svg/%5Cinline%20a_2">  - the maximum number of registers (in languages ‚Äã‚Äãknown to us <img src="https://tex.s2cms.ru/svg/%5Cinline%20a_2%20%3D%202">  : "Uppercase" and "lowercase"), then <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0Ag%20%3D%20%28k_0%20a_1%5Em%20%2B%20k_1%29%20a_2%5Em%20%2B%20k_2%2C%0A"></div><br>  Where <img src="https://tex.s2cms.ru/svg/%5Cinline%20k_0">  - the formula value calculated by the first components of the line <img src="https://tex.s2cms.ru/svg/%5Cinline%20g%28c%29">  ( <img src="https://tex.s2cms.ru/svg/%5Cinline%20a%20%3D%20a_0">  ), <br><br><div style="text-align:center;"><img src="https://tex.s2cms.ru/svg/%0A%5Cbegin%7Barray%7D%7Bl%7D%0Ak_1%20%3D%20a_1%5E%7Bm-1%7D%20c_%7B01%7D%20%2B%20a_1%5E%7Bm%20-2%20%7D%20c_%7B11%7D%20%2B%20%5Cldots%2C%5C%5C%0Ak_2%20%3D%20a_2%5E%7Bm-1%7D%20c_%7B02%7D%20%2B%20a_2%5E%7Bm%20-2%20%7D%20c_%7B12%7D%20%2B%20%5Cldots%0A%5Cend%7Barray%7D%0A"></div><br>  The inverse function is easy to build, using the principles already outlined above: first you need to divide <img src="https://tex.s2cms.ru/svg/%5Cinline%20g">  into three components <img src="https://tex.s2cms.ru/svg/%5Cinline%20k_1">  , <img src="https://tex.s2cms.ru/svg/%5Cinline%20k_2">  and <img src="https://tex.s2cms.ru/svg/%5Cinline%20k_3">  , then get an array of three-component values, on the basis of which the original string is restored. <br><br>  The standard Java library has an abstract class <a href="https://docs.oracle.com/javase/8/docs/api/java/text/Collator.html">java.text.Collator</a> and its implementation <a href="https://docs.oracle.com/javase/8/docs/api/java/text/RuleBasedCollator.html">java.text.RuleBasedCollator</a> .  The purpose of these classes is to compare strings, taking into account various matching rules.  An extensive library of ready-made rules is available.  Unfortunately, these classes are not suitable for use with any purpose other than string comparison: all information about matching rules is encapsulated and cannot be obtained using the system library in a regular manner. <br><br>  Therefore, in order to solve our problem, it was necessary to create an interpreter of matching rules independently. <br><br>  This task was facilitated by the study of the class RuleBasedCollator.  The main borrowed idea was the language for defining sorting rules, a formal description of which is given in the <a href="https://docs.oracle.com/javase/8/docs/api/java/text/RuleBasedCollator.html">documentation</a> .  It is easiest to understand how this language works by examining an example of a rule: <br><br><pre> <code class="hljs">&lt;,&lt;,&lt;,;,&lt;,&lt;,&lt;,;,&lt;,&lt;,</code> </pre><br><br>  The following characters are service marks in the language of matching rules: <br><br><ol><li>  &lt;- separation of characters </li><li>  ;  - separation of spelling options, </li><li>  - division of registers. </li></ol><br>  Using expressions like the above, you can define rules that correspond to different comparisons of different databases.  Since the matching rules language is rather primitive, there was enough algorithm for parsing expressions on it that works as a <a href="https://en.wikipedia.org/wiki/Deterministic_finite_automaton">deterministic finite state machine</a> .  As a result, for a given rule expression, we get an instance of a class capable of <br><br><ol><li>  by the given rules get values <img src="https://tex.s2cms.ru/svg/%5Cinline%20a%20%3D%20a_0">  (number of characters), and <img src="https://tex.s2cms.ru/svg/%5Cinline%20a_1">  (maximum number of options) and <img src="https://tex.s2cms.ru/svg/%5Cinline%20a_2">  (maximum number of registers) to calculate the direct and inverse functions of the enumerator, </li><li>  define three components by a given symbol (symbol number in the alphabet, variant number, register number), </li><li>  for a given three components to determine the symbol. </li></ol><br>  The numerator for string values ‚Äã‚Äãis built, you can assemble the system according to the scheme described <a href="https://habrahabr.ru/post/278773/">in the first part of the article</a> . <br><br><h3>  Finishing touches </h3><br><br>  Already after the system was assembled and testing began, features were discovered that entailed some improvements. <br><br>  First, an important nuance in the practical implementation was the need for a separate processing of the <i>scrolling slider movement for a small step</i> . <br><br>  Scrolling one line up or down happens when you click the up and down arrows on the vertical scroll bar.  When you click on the free field of the scroll bar at the top or bottom of the slider, it scrolls to a fixed (small) number of lines.  In these cases, the user expects to shift all visible lines on the screen by a fixed number of positions.  An interpolator that has not collected enough interpolation points may behave unpredictably, throwing the picture displayed to the user too far back or forward, and after specifying the position of the scrollbar will not correspond to what the user wanted. <br><br>  In this case, however, the use of an interpolator is not justified.  If you know the previous set of key field values, then you can get one previous (or one next) record by a quick query to the database.  Having done this several times, it is possible to obtain several previous or subsequent recordings, still in an inconspicuous time. <br>  After extracting this data, in addition to displaying it to the user, you can replenish the interpolation table with one more point, <i>without resorting to a request for counting records</i> , since the resulting record has a number that differs from the previous one by a known value. <br><br>  Another important nuance in the practical implementation was the need to fill the interpolation table with data before the user starts scrolling the grid. <br><br>  It is not surprising that the numbers of combinations <img src="http://tex.s2cms.ru/svg/%5Cinline%20%5Ckappa">  based on the data in a real table, the distribution on the number line is very uneven.  Therefore, if there are not enough points in the interpolation table, the user, having shifted the scroll bar to a certain distance, can get a strong ‚Äúbounce‚Äù forward or backward after specifying the position.  As a result, the real position of the data being viewed will move either much further, or, conversely, much closer than the user wanted. <br><br>  Tests show that an error of 20-25% of the length of the scroll bar when positioning is psychologically permissible, but no more.  Therefore, after displaying the grid, it is desirable for the user to ensure that the maximum length of the ‚Äúbounce‚Äù is no more than 20‚Äì25% of the length of the scroll bar even at the very beginning of work, when statistics in the interpolation table have not yet been accumulated. <br><br>  This can be done efficiently in a parallel execution thread launched after displaying the grid.  This stream runs a series of refinement queries, the results of which fill up the interpolation table.  The key combination value for the refinement query is selected each time as lying in the middle of the largest gap in the values ‚Äã‚Äãof the sequence numbers of the interpolation table entries.  The process is performed until the width of the maximum gap is reduced to the desired size, or until the limit on the number of iterations is reached. <br><br><h3>  Practical implementation </h3><br>  The grid based on the principles presented here was implemented in Java using PostgreSQL as a DBMS.  As one of the load test data sets, <a href="http://www.gnivc.ru/inf_provision/classifiers_reference/kladr/">the KLADR database</a> containing 1075429 street names of settlements in Russia is used, sorting is carried out according to various fields and their combinations.  All the principles outlined here work.  When the vertical scroll bar slider is constantly moved, a full illusion of real-time scrolling of all records is created for the user, a short time after the scrolling finishes (when the refinement is triggered and another point is added to the interpolation table), the scroll bar's slider position is refined by jumping a small distance.  Positioning allows you to instantly display the necessary records and immediately set the scroll bar slider approximately, after a short time its position is also specified.  As you work with the grid and accumulate interpolation points, the ‚Äúbounces‚Äù become less and less noticeable: <br><br><img src="https://habrastorage.org/files/6da/40f/36d/6da40f36d8d747f19a2d2fffe9980b93.gif"><br><br><h3>  *** </h3><br><br>  For the work done, I am preparing a scientific publication, and you can also read the <a href="http://arxiv.org/pdf/1603.01102v1.pdf">preprint of the scientific version of this article at arxiv.org</a> . </div><p>Source: <a href="https://habr.com/ru/post/279083/">https://habr.com/ru/post/279083/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279069/index.html">1.2 SFML and Code :: Blocks (MinGW)</a></li>
<li><a href="../279071/index.html">AlphaGo on the fingers</a></li>
<li><a href="../279073/index.html">Security Week 10: extortionist for OS X, iPhone passcode bypass, Facebook vulnerability and bug bounty benefits</a></li>
<li><a href="../279075/index.html">Android N Preview: API and Developer Tools</a></li>
<li><a href="../279081/index.html">4 ways to make game learning interesting</a></li>
<li><a href="../279085/index.html">About the importance of catching fleas. What is Global OpenStack Bug Smash for?</a></li>
<li><a href="../279087/index.html">Bitcoin Self-Regulation</a></li>
<li><a href="../279091/index.html">The new generation of UX or the most useful bots for Slack</a></li>
<li><a href="../279093/index.html">Does the programmer need to know the algorithms?</a></li>
<li><a href="../279095/index.html">Learning from machine learning (saturday, philosophical)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>