<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Calling to mobile phones from the browser with recording conversations</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In today's world of thin clients, the Internet, advanced web interfaces, there are more and more tasks related to the need to make calls from the brow...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Calling to mobile phones from the browser with recording conversations</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/23a/44c/d80/23a44cd80ec645f99413fff45b5b86c1.png"><br><br>  In today's world of thin clients, the Internet, advanced web interfaces, there are more and more tasks related to the need to make calls from the browser / take calls to the browser.  It is damn convenient!  An employee sits in front of the monitor, selects a client, presses a call ‚Äî and while dialing is in progress, looks at his card on the same page, refreshes the latest agreements and outlined steps. <br><br>  Or another scenario - the incoming call to the company.  How great it is when you, as a client, call the faceless 8800 and the girl on the other end of the phone answers you in a pleasant voice - hello, Alexey (substitute_ own_name)!  It makes a terrific effect.  When instead of ‚Äúname yourself, your passport number and cat's name, the information is loaded - listen to Mozart's sixth symphony‚Äù the operator already picks up the phone, knows your name and sees all the information on you.  Service, what to say. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But is it possible to implement such a system without plunging into the wilds of the PBX setting - as quickly as possible and with minimal blood?  It is also desirable that all conversations are recorded for the purpose of monitoring and training employees.  The answer - of course, drove under the cat. <a name="habracut"></a><br><br><h4>  Implementation options </h4><br>  So, today there are several options for solving the described task.  The first is, of course, to install the widely known <a href="http://www.asterisk.org/">Asterisk</a> in narrow circles or a <a href="https://ru.wikipedia.org/wiki/Asterisk">system</a> based on it, configure everything, then either buy a <a href="https://ru.wikipedia.org/wiki/VoIP-GSM_%25D1%2588%25D0%25BB%25D1%258E%25D0%25B7">VoIP-GSM gateway</a> ( <a href="http://habrahabr.ru/post/151011/">they</a> even <a href="http://habrahabr.ru/post/151011/">make</a> USB modems for 800 rubles), or send traffic through one of the many SIP providers , giving access to the PSTN (public telephone networks - including mobile phones).  Then write using WebRTC web interface to the dialer.  The option is probably the cheapest, but also the most costly in time and effort. <br><br>  The second way is the use of services that allow not to install Asterisk, which provide a convenient API for calls from the browser and having access to the PSTN.  In our Russian market, this is <a href="https://oktell.ru/">Oktell</a> and <a href="http://voximplant.com/">VoxImplant</a> .  To work with Oktell, you still need to install software on the server and purchase licenses - not my option.  It was decided to stop at VoxImplant, a wonderful project by Alexey Ailarov, the founder of Zingaya.  This platform will be discussed further. <br><br>  Looking ahead, I‚Äôll say that the start up page, by pressing the button on which the call goes to the mobile, will succeed in the case of VoxImplant within 10 minutes. Everything is really very simple and no dialplans or similar ip-telephony buzzwords.  Let us examine exactly the example of outgoing calls. <br><br><h4>  VoxImplant - preparing the site </h4><br>  The first thing to do is to register for VoxImplant, it's free + there are $ 5 on the account right away for test calls, it's nice.  The system will need to do 3 things - create a user who will call, create a script that describes the call processing logic, and create an application that unites the user (giving him access to calls) and the script. <br><br>  So, logging into your account, go to the Scripts tab.  Scenarios are actually what happens during various events in the system, how calls are handled.  For example, you can hang different processing scripts for different incoming numbers, or different scenarios for different outgoing, etc. <br><br>  In our case, the script will be very simple.  Click ‚ÄúCreate Script‚Äù, specify the name of the callToCustomer script and copy the code in the script input field (this is regular JavaScript using the VoxImplant API - everything is written in the system in the usual JS web developers): <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   VoxEngine.forwardCallToPSTN();</span></span></code> </pre> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0b1/90d/6d6/0b190d6d66c048c89a973e5ee0b8fa0b.png"></div><br><br>  After saving the script, go to the Users tab - you need to create an account of the person who will call.  Click ‚ÄúCreate user‚Äù, enter user name, for example, alexey.goloburdin, password, in my case testPassword, display name and click ‚ÄúSave‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cf7/ae2/d73/cf7ae2d736a64bb4ac7a3a6d5f67a957.png"></div><br><br>  Then go to the Applications tab, where we click, respectively, "Create an application."  Enter the name, in my case firstapp and click "Create". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2f5/426/55e/2f542655e62e4f3a8fa79267d1dfcd44.png"></div><br><br>  After that, select "Link users" - we bind the newly created user alexey.goloburdin. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/402/1ef/a97/4021efa972dd4665af62546aba209d68.png"></div><br><br>  Go to the Rules tab, click ‚ÄúAdd Rule‚Äù, drag the callToCustomer script created earlier to the Linked section, enter the name callToCustomerRule and click ‚ÄúAdd‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/9f4/2da/379/9f42da37939c408e841627dd4e12bd57.png"></div><br><br>  That's all - system setup is complete.  We proceed to writing a simple HTML page with a bell button. <br><br><h4>  Good old HTML / JS </h4><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://cdn.voximplant.com/voximplant.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> initialized = </span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">false</span></span></span><span class="actionscript">, </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// SDK  loggedIn = false, //   connected = false, //    VoxImplant  voxImplant = VoxImplant.getInstance(); //     //   SDK voxImplant.addEventListener(VoxImplant.Events.SDKReady, handleSDKReady); //      VoxImplant voxImplant.addEventListener(VoxImplant.Events.ConnectionEstablished, handleConnectionEstablished); //      VoxImplant voxImplant.addEventListener(VoxImplant.Events.AuthResult, handleAuthResult); // SDK ,   VoxImplant  function handleSDKReady() { initialized = true; voxImplant.connect(); } //   VoxImplant  ,   function handleConnectionEstablished() { connected = true; login(); } //    function handleAuthResult(e) { if (e.result) { //   loggedIn = true; makeCall(); } } //   function login(){ //      voxImplant.login("alexey.goloburdin@firstapp.sterx.voximplant.com", "testPassword"); } function makeCall(){ var call = voxImplant.call("79636722229"); //     } function testCall() { //  SDK   -   if (!initialized) voxImplant.init(); else { //       VoxImplant -  if (!voxImplant.connected()) voxImplant.connect(); else { //     - ,   -  if (!loggedIn) login(); else makeCall(); } } } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javascript:testCall()"</span></span></span><span class="hljs-tag">&gt;</span></span> , !<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">br</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The code is quite simple.  Download the VoxImplant SDK, establish a connection with the VoxImplant server, then authorize the user and call.  Here you should pay attention to the login function - do not forget to specify your username created in the first paragraph of the user before the dog sign (in my case, alexey.goloburdin), your application name (firstapp) and your account name (sterx), as well as your password (testPassword ).  In the function makeCall, do not forget to specify your phone number for the test - in the future application there will be the number of the client we are calling.  The address of the application can be viewed on the application page in the general list. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/8de/69f/2bb/8de69f2bb48948c2af80a8900ee1a513.png"></div><br><br>  We load the created HTML page onto the server, click on the link, allow the use of the microphone (of course, it should be present on the laptop / computer from which you are calling) and after a few seconds we hear the coveted call on the phone. <br><br>  So, the system works, the calls go, everything is in order.  But what about the recording of conversations? <br><br><h4>  We write conversations </h4><br>  To record conversations, you will need to make changes to the callToCustomer script: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    require(Modules.Recorder); //     -    VoxEngine.addEventListener(AppEvents.CallAlerting, function (e) { var call = e.call, //   recorder = VoxEngine.createRecorder(); //    "" //     -   call.addEventListener(CallEvents.Connected, function (callevent) { call.sendMediaTo(recorder); }); }); //    VoxEngine.forwardCallToPSTN();</span></span></code> </pre> <br>  Now the system not only calls, but also records all calls to MP3 files.  You can hear them from the VoxImpant interface from the Calls tab - a corresponding icon has appeared for recorded conversations. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bc0/f85/ada/bc0f85adab9e4a399fbb67b3c697736a.png"></div><br><br>  From the interface VoxImplant - well, but I would like to pull from my recording system.  To do this, each recorded conversation needs to be assigned its own unique ID - for example, in a real system it can be an internal user id, tagged with a time stamp.  In our case, let's just pass the string 'callStamp', for this we fix the function makeCall of our HTML file: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeCall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> call = voxImplant.call(<span class="hljs-string"><span class="hljs-string">"79636722229"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">'callStamp'</span></span>); }</code> </pre> <br>  The task of obtaining call records is implemented using the <a href="httpapi/">HTTP API</a> and its <a href="httpapi/GetCallHistory.html">GetCallHistory</a> method, which returns information about the calls made.  In general, through the HTTP API, you can create users in VoxImplant and perform other administrative tasks, it is very convenient to integrate with internal systems in the company.  To work with the HTTP API, you need to get the key api_key and account_id in the section "Access to the API" in the upper right corner of the VoxImplant interface. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/45b/a86/9a0/45ba869a0b6c458aa4ef37a756c625fc.png"></div><br><br>  To get a recording of our conversation, labeled callStamp, you need to run this GET request: <br><br>  <a href="https://api.voximplant.com/platform_api/GetCallHistory/%3Faccount_id%3D">api.voximplant.com/platform_api/GetCallHistory/?account_id=########&amp;api_key=############&amp;with_records=true&amp;call_session_history_custom_data=callStamp</a> <br><br>  The JSON array will come in response, the result [0] [records] [0] [record_url] property contains the URL of the MP3 file for the conversation recording. <br><br>  So, quickly and beautifully, we taught our web system to call mobile numbers and record all conversations.  If the topic turns out to be interesting, in the next article I will talk about receiving incoming calls - but in the meantime, everyone is happy with holidays and excellent communications! </div><p>Source: <a href="https://habr.com/ru/post/242191/">https://habr.com/ru/post/242191/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242175/index.html">Facebook, hidden services and https certificates</a></li>
<li><a href="../242179/index.html">REST / CRUD. Am I cooking it wrong?</a></li>
<li><a href="../242185/index.html">Unified dynamic corporate signature with Postfix + alterMIME + addAttachFilter + Active Directory or MySQL logo</a></li>
<li><a href="../242187/index.html">EyeCare - relieving eye strain, treatment of myopia, accommodation spasm</a></li>
<li><a href="../242189/index.html">Dark times are coming: HabraDarkAge theme</a></li>
<li><a href="../242193/index.html">Honeymoon Manager: how to spend it with benefit</a></li>
<li><a href="../242195/index.html">The digest of interesting materials for the mobile developer # 77 (October 26 - November 2)</a></li>
<li><a href="../242197/index.html">Cloud Connect: Private and Secure Surfing. Bye for free</a></li>
<li><a href="../242199/index.html">Why does the speed of writing to the RAID decrease as the SSD fills, or why do we need TRIM</a></li>
<li><a href="../242201/index.html">Pattern matching with macros</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>