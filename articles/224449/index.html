<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Doing Smart Point or ‚ÄúInternet thing‚Äù with your own hands</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will describe the concept and example of the practical implementation of a compact platform for creating solutions in the field of h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Doing Smart Point or ‚ÄúInternet thing‚Äù with your own hands</h1><div class="post__text post__text-html js-mediator-article">  In this article I will describe the concept and example of the practical implementation of a compact platform for creating solutions in the field of home automation and the Internet of Things. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b62/224/28f/b6222428f57b644933af959abad461d7.png" alt="image"><br><br>  Interested please under the cat. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Instead of introducing </h5><br>  Recently, there has been a pronounced tendency of growing interest in such an area of ‚Äã‚Äãinformation technology as the automation of vital activity.  Automation in itself is not a new phenomenon and for decades the majority of industrial production is not a whim, but a necessity, without which business survival in the face of fierce competition is unthinkable.  So why just now we hear so much about the Internet of Things, M2M (Machine-to-machine) communications and other ‚Äúsmart‚Äù technologies?  Perhaps the reason is that, as in many similar cases, some ‚Äúcritical mass‚Äù of innovation was accumulated along with the availability of the element base for the general public.  Just as the development of the Internet and the availability of Internet technologies once gave rise to a whole wave of information projects that are changing the world so far, now we are witnessing how many such building blocks as programming, microelectronics, the Internet creates interesting household solutions.  Not all of them will ‚Äúfly up‚Äù and this is absolutely normal, but many of them can be the basis (or inspiration) for something truly amazing. <br><br>  Personally, I have been very actively interested in this for more than a year, and perhaps some have heard about the open project of the Major DoMo Smart House, which I have the pleasure to create and work on.  But now it's not about him, but about some parallel project, another experiment, if you like, which I was fascinated with some time ago and the results of which I share in this article. <br><br>  Having in the ‚Äúbaggage‚Äù project of the Smart Home platform, I thought that although it is very flexible in use, but a large number of possibilities require appropriate equipment, which is not always convenient and practical.  For some tasks, ‚Äúsmall‚Äù automation can be managed with one microcontroller, but here we are already losing flexibility and raising demands on the user's qualifications.  It seemed obvious to me that there is a need for some intermediate version - quite compact and energy-efficient, but at the same time flexible in configuration and use.  We give the working title to this option ‚ÄúSmart Point‚Äù or SmartPoint.  Along the way, a whole wish list has been formed on the possibilities that it would be great to receive in this device. <br><br><h5>  Task </h5><br>  So, from the lyrics to the practice.  Here are the basic requirements for a SmartPoint device: <br><ul><li>  Flexible rules for responding to events from sensors </li><li>  Web interface for ‚Äúmanual‚Äù control </li><li>  HTTP API for integration into a more complex complex </li><li>  Work ONLINE - access to the web interface of the device via the Internet without static IP and ‚Äúforwarding‚Äù of ports on the router </li><li>  Work OFFLINE - the functioning of the configured device should not depend on the availability of Internet access </li></ul><br><br>  Additional (practical) wishes for the device: <br><ul><li>  Work on wifi </li><li>  The presence of built-in sensors and executive modules (the device should be of practical use immediately ‚Äúout of the box‚Äù and not ‚Äúin theory‚Äù) </li><li>  Wireless ‚Äúlocal‚Äù interface for interfacing with simpler sensors / actuating modules </li><li>  Internet service (personal account) for setting up and monitoring the operation of the device </li></ul><br><br><h5>  Controller, host, peripherals </h5><br>  Pondering over and over the concept, as well as a considerable set of ‚ÄúWishlist‚Äù, came to the conclusion that it would not be possible to manage with one microcontroller.  First of all, I still don‚Äôt know how to program them so well that I can realize everything that was planned at a low level, and secondly, not every controller will make such an appetite of wishes.  It was decided to follow the path of least resistance - to divide the device into two logical parts: one (‚Äúcontroller‚Äù) will be based on a microcontroller and responsible for elementary interaction with ‚Äúhardware‚Äù, and the second (‚Äúhost‚Äù) based on embedded Linux, be responsible for more high level (interface, rule system, API).  The Arduino microcontroller was selected as the first unit (guess!), And the TP-Link WR703N router with OpenWRT firmware went into operation as the second unit (note: a pair of similar devices were successfully assembled on the DLink Dir-320 router).  Anticipating righteous anger, I hasten to remind you that our task is first of all to check the viability of the concept on a prototype, and not to design and assemble a commercial device.  In addition, the use of these components facilitates the repetition of the device - long live open-source!  Using the same Arduino allows you to apply the experience of connecting an infinite variety of sensors and actuating modules to our device. <br><br>  TP-Link WR703N router: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d02/651/598/d02651598a35fc739cf58941eecf0df9.png" alt="image"><br><br>  Arduino Nano microcontroller: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cb2/91f/3ea/cb291f3eacacd00e88bf86cfe0ea5975.png" alt="image"><br><br>  The following elements were chosen as the initial set of peripherals: <br><ul><li>  Button <img src="https://habrastorage.org/getpro/habr/post_images/93d/ab5/cd2/93dab5cd249e8e260b839962f61f5674.png" alt="image"></li><li>  Motion Sensor <img src="https://habrastorage.org/getpro/habr/post_images/e27/e4d/916/e27e4d9160a3258424846e4d61b6af7f.png" alt="image"></li><li>  DS18B20 temperature sensor <img src="https://habrastorage.org/getpro/habr/post_images/4d8/3a7/33e/4d83a733e60dab86e28abdf6e452ec44.png" alt="image"></li><li>  433Mhz receiver <img src="https://habrastorage.org/getpro/habr/post_images/3ab/d6a/aa2/3abd6aaa2b32e98a9cf4eec08eb56723.png" alt="image"></li><li>  Noolite Light Control Transmitter <img src="https://habrastorage.org/getpro/habr/post_images/bbe/b4a/652/bbeb4a65240e9192975ee74e7a7d5b08.png" alt="image"></li></ul><br><br>  The set of peripherals, as you understand, may be different, but in this example I took this one on the basis of the principle of ‚Äúpractical utility‚Äù mentioned above.  Thus, our device will be able to respond to pressing the button, to movement, to temperature changes, as well as to receive data from external sensors (in this case, <a href="http://habrahabr.ru/post/182068/">the</a> protocol <a href="http://habrahabr.ru/post/182068/">described earlier in the Habr√©</a> protocol was used) and to control the power modules of the Noolite system (a separate history control module and the photograph is not a commercial copy of the module, but one of the earliest prototypes from the manufacturer that came to me for testing). <br><br>  Combining the sketches for the implementation and the initial requirements, we obtain the following block diagram of the device: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/34c/0e5/8df/34c0e58df0e1637bdca98bd830f132cb.png" alt="image"><br><br>  Explanation of the scheme: <br><ul><li>  The device consists of a microcontroller that interacts with wired / wireless peripherals, and a core responsible for the logic of processing incoming data and interfaces </li><li>  There is an API and a web interface for receiving commands from external "terminals" (computers, phones, etc.) </li><li>  Communicating with an external service to download rules, send notifications and receive commands </li></ul><br><br><h5>  Microcontroller preparation </h5><br>  The microcontroller has two main tasks: first, to issue events from external devices to the console, and, second, to receive commands from the console for transmission to the connected peripherals. <br><br>  Below is the text of the sketch, taking into account the specifics of the above-listed periphery.  In our case, the button is connected to PIN4, a motion sensor on PIN3, a temperature sensor on PIN9, a radio receiver on PIN8, and a Noolite module on PINs 10, 11. <br><br><div class="spoiler">  <b class="spoiler_title">Sketch for the controller</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;OneWire.h&gt; #include &lt;DallasTemperature.h&gt; #include &lt;VirtualWire.h&gt; #include &lt;EasyTransferVirtualWire.h&gt; #include &lt;EEPROM.h&gt; //Needed to access the eeprom read write functions #include &lt;SoftwareSerial.h&gt; #define PIN_LED (13) // INDICATOR #define PIN_PIR (3) // BUTTON #define PIN_BUTTON (4) // BUTTON #define PIN_LED_R (6) // INDICATOR RED #define PIN_LED_G (5) // INDICATOR GREEN #define PIN_LED_B (7) // INDICATOR BLUE #define PIN_RF_RECEIVE (8) // EASYRF RECEIVER #define PIN_TEMP (9) // TEMPERATURE SENSOR #define PIN_NOO_RX (10) // RX PIN (connect to TX on noolite controller) #define PIN_NOO_TX (11) // TX PIN (connect to RX on noolite controller) #define TEMP_ACC (0.3) // temperature accuracy #define PERIOD_READ_TEMP (20) // seconds #define PERIOD_SEND_TEMP (600) // seconds (10 minutes) #define PERIOD_SEND_UPTIME (300) // seconds (5 minutes) #define NOO_BUF_LEN (12) unsigned int unique_device_id = 0; long int uptime = 0; long int old_uptime = 0; float sent_temperature=0; int sent_pir=0; int sent_button=0; int sent_button_longlick=0; long int timeCheckedTemp=0; long int timeSentTemp=0; long int timeSentUptime=0; long int timeButtonPressed=0; String inData; //create objects SoftwareSerial mySerial(PIN_NOO_RX, PIN_NOO_TX); // RX, TX OneWire oneWire(PIN_TEMP); DallasTemperature sensors(&amp;oneWire); EasyTransferVirtualWire ET; unsigned int last_packet_id = 0; struct SEND_DATA_STRUCTURE{ //put your variable definitions here for the data you want to send //THIS MUST BE EXACTLY THE SAME ON THE OTHER ARDUINO //Struct can'e be bigger then 26 bytes for VirtualWire version unsigned int device_id; unsigned int destination_id; unsigned int packet_id; byte command; int data; }; //give a name to the group of data SEND_DATA_STRUCTURE mydata; //This function will write a 2 byte integer to the eeprom at the specified address and address + 1 void EEPROMWriteInt(int p_address, unsigned int p_value) { byte lowByte = ((p_value &gt;&gt; 0) &amp; 0xFF); byte highByte = ((p_value &gt;&gt; 8) &amp; 0xFF); EEPROM.write(p_address, lowByte); EEPROM.write(p_address + 1, highByte); } //This function will read a 2 byte integer from the eeprom at the specified address and address + 1 unsigned int EEPROMReadInt(int p_address) { byte lowByte = EEPROM.read(p_address); byte highByte = EEPROM.read(p_address + 1); return ((lowByte &lt;&lt; 0) &amp; 0xFF) + ((highByte &lt;&lt; 8) &amp; 0xFF00); } void nooSend(byte channel, byte buf[NOO_BUF_LEN]) { buf[0]=85; buf[1]=B01010000; // buf[4]=0; buf[5]=channel; buf[9]=0; int checkSum; for(byte i=0;i&lt;(NOO_BUF_LEN-2);i++) { checkSum+=buf[i]; } buf[10]=lowByte(checkSum); buf[11]=170; Serial.print("Sending: "); for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { Serial.print(buf[i]); if (i!=(NOO_BUF_LEN-1)) { Serial.print('-'); } } Serial.println(""); for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { mySerial.write(buf[i]); } } void noolitePair(byte channel) { byte buf[NOO_BUF_LEN]; for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { buf[i]=0; } buf[2]=15; buf[3]=0; nooSend(channel,buf); } void nooliteUnPair(byte channel) { byte buf[NOO_BUF_LEN]; for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { buf[i]=0; } buf[2]=9; buf[3]=0; nooSend(channel,buf); } void nooliteTurnOn(byte channel) { byte buf[NOO_BUF_LEN]; for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { buf[i]=0; } buf[2]=2; buf[3]=0; nooSend(channel,buf); } void nooliteTurnOff(byte channel) { byte buf[NOO_BUF_LEN]; for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { buf[i]=0; } buf[2]=0; buf[3]=0; nooSend(channel,buf); } void nooliteSwitch(byte channel) { byte buf[NOO_BUF_LEN]; for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { buf[i]=0; } buf[2]=4; buf[3]=0; nooSend(channel,buf); } void nooliteLevel(byte channel,byte level) { byte buf[NOO_BUF_LEN]; for(byte i=0;i&lt;(NOO_BUF_LEN);i++) { buf[i]=0; } buf[2]=6; buf[3]=1; buf[6]=level; nooSend(channel,buf); } void blinking(int count) { for(int i=0;i&lt;count;i++) { digitalWrite(PIN_LED, HIGH); delay(200); digitalWrite(PIN_LED, LOW); delay(200); } } void setColor(int r,int g, int b) { digitalWrite(PIN_LED_R, r); digitalWrite(PIN_LED_G, g); digitalWrite(PIN_LED_B, b); } void setup() { randomSeed(analogRead(0)); pinMode(PIN_LED, OUTPUT); pinMode(PIN_LED_R, OUTPUT); pinMode(PIN_LED_G, OUTPUT); pinMode(PIN_LED_B, OUTPUT); pinMode(PIN_PIR, INPUT); pinMode(PIN_BUTTON, INPUT); Serial.begin(9600); // Debugging only ET.begin(details(mydata)); // Initialise the IO and ISR vw_set_rx_pin(PIN_RF_RECEIVE); vw_setup(2000); // Bits per sec vw_rx_start(); // Start the receiver PLL running // Device ID Serial.print("Getting Device ID... "); unique_device_id=EEPROMReadInt(0); if (unique_device_id&lt;10000 || unique_device_id&gt;60000 || unique_device_id==26807) { Serial.print("N/A, updating... "); unique_device_id=random(10000, 60000); EEPROMWriteInt(0, unique_device_id); } Serial.println(unique_device_id); pinMode(PIN_NOO_RX, INPUT); pinMode(PIN_NOO_TX, OUTPUT); mySerial.begin(9600); } void loop() { uptime=round(millis()/1000); if (uptime!=old_uptime) { Serial.print("Up: "); Serial.println(uptime); old_uptime=uptime; if (((uptime-timeSentUptime)&gt;PERIOD_SEND_UPTIME) || (timeSentUptime&gt;uptime)) { timeSentUptime=uptime; Serial.print("P:"); Serial.print(random(65535)); Serial.print(";F:"); Serial.print("0"); Serial.print(";T:0;C:"); Serial.print("24"); Serial.print(";D:"); Serial.print(uptime); Serial.println(";"); } } int current_pir=digitalRead(PIN_PIR); if (current_pir!=sent_pir) { Serial.print(millis()/1000); Serial.print(" Motion sensor: "); Serial.println(current_pir); Serial.print("P:"); Serial.print(random(65535)); Serial.print(";F:"); Serial.print("0"); Serial.print(";T:0;C:"); Serial.print("12"); Serial.print(";D:"); Serial.print("1"); Serial.println(";"); sent_pir=(int)current_pir; } int current_button=digitalRead(PIN_BUTTON); if (current_button!=sent_button) { delay(50); int confirm_current_button=digitalRead(PIN_BUTTON); if (confirm_current_button==current_button) { if (current_button==1) { timeButtonPressed=millis(); sent_button_longlick=0; } if (current_button==0) { if (sent_button_longlick!=1) { Serial.print(millis()/1000); Serial.print(" Button press: "); Serial.println(current_button); Serial.print("P:"); Serial.print(random(65535)); Serial.print(";F:"); Serial.print("0"); Serial.print(";T:0;C:"); Serial.print("23"); Serial.print(";D:"); Serial.print("3"); Serial.println(";"); } } sent_button=(int)current_button; } } else { if (current_button==1) { int passed=millis()-timeButtonPressed; if ((passed&gt;3000) &amp;&amp; (sent_button_longlick!=1)) { sent_button_longlick=1; Serial.print(millis()/1000); Serial.print(" Button long press: "); Serial.println(current_button); Serial.print("P:"); Serial.print(random(65535)); Serial.print(";F:"); Serial.print("0"); Serial.print(";T:0;C:"); Serial.print("23"); Serial.print(";D:"); Serial.print("4"); Serial.println(";"); } } else { sent_button_longlick=0; } } if (((uptime-timeCheckedTemp)&gt;PERIOD_READ_TEMP) || (timeCheckedTemp&gt;uptime)) { // TEMP SENSOR 1 float current_temp=0; sensors.requestTemperatures(); current_temp=sensors.getTempCByIndex(0); if (current_temp&gt;-100 &amp;&amp; current_temp&lt;50) { timeCheckedTemp=uptime; Serial.print("Temp sensor: "); Serial.println(current_temp); float diff=(float)sent_temperature-(float)current_temp; if ((abs(diff)&gt;=TEMP_ACC) || ((uptime-timeSentTemp)&gt;PERIOD_SEND_TEMP)) { // timeSentTemp=uptime; sent_temperature=(float)current_temp; Serial.print("P:"); Serial.print(random(65535)); Serial.print(";F:"); Serial.print("0"); Serial.print(";T:0;C:"); Serial.print("10"); Serial.print(";D:"); Serial.print((int)(current_temp*100)); Serial.println(";"); } } else { //Serial.print("Incorrect T: "); //Serial.println(current_temp); } } if (Serial.available()) { char c=Serial.read(); if (c == '\n' || c == ';') { Serial.println(inData); int commandProcessed=0; if (inData.equals("blink")) { Serial.println("BLINKING!"); blinking(3); commandProcessed=1; } if (inData.startsWith("pair")) { commandProcessed=1; inData.replace("pair",""); noolitePair(inData.toInt()); } if (inData.startsWith("on")) { commandProcessed=1; inData.replace("on",""); nooliteTurnOn(inData.toInt()); } if (inData.startsWith("off")) { commandProcessed=1; inData.replace("off",""); nooliteTurnOff(inData.toInt()); } if (inData.startsWith("switch")) { commandProcessed=1; inData.replace("switch",""); nooliteSwitch(inData.toInt()); } if (inData.startsWith("level")) { commandProcessed=1; inData.replace("level",""); int splitPosition; splitPosition=inData.indexOf('-'); if(splitPosition != -1) { String paramString=inData.substring(0,splitPosition); int channel=paramString.toInt(); inData=inData.substring(splitPosition+1,inData.length()); nooliteLevel(channel,inData.toInt()); } } if (inData.startsWith("unpair")) { commandProcessed=1; inData.replace("unpair",""); nooliteUnPair(inData.toInt()); } if (inData.startsWith("color-")) { commandProcessed=1; inData.replace("color-",""); if (inData.equalsIgnoreCase("r")) { setColor(255,0,0); } if (inData.equalsIgnoreCase("g")) { setColor(0,255,0); } if (inData.equalsIgnoreCase("b")) { setColor(0,0,255); } if (inData.equalsIgnoreCase("w")) { setColor(255,255,255); } if (inData.equalsIgnoreCase("off")) { setColor(0,0,0); } } if (commandProcessed==0) { Serial.print("Unknown command: "); Serial.println(inData); } inData=""; Serial.flush(); } else { inData += (c); } } if(ET.receiveData()) { digitalWrite(PIN_LED, HIGH); if (last_packet_id!=(int)mydata.packet_id) { Serial.print("P:"); Serial.print(mydata.packet_id); Serial.print(";F:"); Serial.print(mydata.device_id); Serial.print(";T:"); Serial.print(mydata.destination_id); Serial.print(";C:"); Serial.print(mydata.command); Serial.print(";D:"); Serial.print(mydata.data); Serial.println(";"); last_packet_id=(int)mydata.packet_id; } digitalWrite(PIN_LED, LOW); } if (mySerial.available()) Serial.write(mySerial.read()); }</span></span></span></span></code> </pre> <br></div></div><br><br>  The controller‚Äôs operation with peripherals can be checked without connecting it to the host module, but simply start the port monitor after the firmware and see what is output to the console.  It is this data flow that the host module will receive, but it will still be able to respond to it in accordance with the established rules. <br><br><h5>  Preparing the host module (router) </h5><br>  I will not dwell on the firmware of the router with the OpenWRT system and the subsequent configuration in the framework of this article.  As a result, we should have a router in the client mode of the local WiFi-network with Internet access, as well as correctly determining the connected microcontroller as a COM port. <br><br>  The next step is to transform our router into a host module.  I used the Bash interpreter to write host module scripts, since  It seemed to me quite convenient and versatile, i.e.  not binding the host module platform to any particular ‚Äúhardware‚Äù implementation ‚Äî instead of a router with OpenWRT, there can be any device with a built-in Linux, if only there is Bash and drivers for connecting the microcontroller. <br><br>  The algorithm of the host module can be represented by the following points: <br><ol><li>  Initialization - loading the rules of operation of this device from an external web service (if it is available), as well as setting up a communication channel with a microcontroller </li><li>  Receiving data from the controller and processing them in accordance with the loaded rules </li></ol><br><br>  At the source code level, it looks like this: <br><br><div class="spoiler">  <b class="spoiler_title">Settings File (/ect/master/settings.sh)</b> <div class="spoiler_text"><pre> <code class="bash hljs">MASTER_ID=<span class="hljs-string"><span class="hljs-string">"AAAA-BBBB-CCCC-DDDD"</span></span> ARDUINO_PORT=/dev/ttyACM0 ARDUINO_PORT_SPEED=9600 UPDATES_URL=<span class="hljs-string"><span class="hljs-string">"http://connect.smartliving.ru/rules/"</span></span> DATA_PATH=<span class="hljs-string"><span class="hljs-string">"/etc/master/data"</span></span> WEB_PATH=<span class="hljs-string"><span class="hljs-string">"/www"</span></span> ONLINE_CHECK_HOST=<span class="hljs-string"><span class="hljs-string">"8.8.8.8"</span></span> LOCAL_BASE_URL=<span class="hljs-string"><span class="hljs-string">"http://connect.dev"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">The main processing script file (/etc/master/cycle.sh)</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # settings . /etc/master/settings.sh # STEP 0 # wait to be online COUNTER=0 while [ $COUNTER -lt 5 ]; do ping -c 1 $ONLINE_CHECK_HOST if [[ $? = 0 ]]; then echo Network available. break; else echo Network not available. Waiting... sleep 5 fi let COUNTER=COUNTER+1 done #--------------------------------------------------------------------------- # START if [ ! -d "$DATA_PATH" ]; then mkdir $DATA_PATH chmod 0666 $DATA_PATH fi while : do #--------------------------------------------------------------------------- # Downloading the latest rules from the web echo Getting rules from $UPDATES_URL?id=$MASTER_ID wget -O $DATA_PATH/rules_set.tmp $UPDATES_URL?id=$MASTER_ID if grep -Fq "Rules set" $DATA_PATH/rules_set.tmp then mv $DATA_PATH/rules_set.tmp $DATA_PATH/rules_set.sh else echo Incorrect rules file fi #--------------------------------------------------------------------------- # Reading all data and sending to the web ALL_DATA_FILE=$DATA_PATH/all_data.txt rm -f $ALL_DATA_FILE echo -n id=$MASTER_ID&gt;&gt;$ALL_DATA_FILE echo -n "&amp;data="&gt;&gt;$ALL_DATA_FILE FILES=$DATA_PATH/*.dat for f in $FILES do #echo "Processing $f file..." OLD_DATA=`cat $f` fname=${f##*/} PARAM=${fname/.dat/} echo -n "$PARAM|$OLD_DATA;"&gt;&gt;$ALL_DATA_FILE done ALL_DATA=`cat $ALL_DATA_FILE` echo Posting: $UPDATES_URL?$ALL_DATA wget -O $DATA_PATH/data_post.tmp $UPDATES_URL?$ALL_DATA rm -f $DATA_PATH/*.dat #--------------------------------------------------------------------------- # Downloading the latest menu from the web echo Getting menu from $UPDATES_URL/menu2.php?download=1\&amp;id=$MASTER_ID wget -O $DATA_PATH/menu.tmp $UPDATES_URL/menu2.php?download=1\&amp;id=$MASTER_ID if grep -Fq "stylesheet" $DATA_PATH/menu.tmp then mv $DATA_PATH/menu.tmp $WEB_PATH/menu.html else echo Incorrect menu file fi #--------------------------------------------------------------------------- START_TIME="$(date +%s)" # main cycle stty -F $ARDUINO_PORT ispeed $ARDUINO_PORT_SPEED ospeed $ARDUINO_PORT_SPEED cs8 ignbrk -brkint -imaxbel -opost -onlcr -isig -icanon -iexten -echo -echoe -echok -echoctl -echoke noflsh -ixon -crtscts #--------------------------------------------------------------------------- while read LINE; do echo $LINE PASSED_TIME="$(($(date +%s)-START_TIME))" # Processing incoming URLs from controller REGEX='^GET (.+)$' if [[ $LINE =~ $REGEX ]] then URL=$LOCAL_BASE_URL${BASH_REMATCH[1]} #-URL=$LOCAL_BASE_URL wget -O $DATA_PATH/http.tmp $URL echo Getting URL echo $URL fi PACKET_ID="" DATA_FROM="" DATA_TO="" DATA_COMMAND="" DATA_VALUE="" REGEX='^P:([0-9]+);F:([0-9]+);T:([0-9]+);C:([0-9]+);D:([0-9]+);$' if [[ $LINE =~ $REGEX ]] then PACKET_ID=${BASH_REMATCH[1]} DATA_FROM=${BASH_REMATCH[2]} DATA_TO=${BASH_REMATCH[3]} DATA_COMMAND=${BASH_REMATCH[4]} DATA_VALUE=${BASH_REMATCH[5]} DATA_FILE=$DATA_PATH/$DATA_FROM-$DATA_COMMAND.dat echo -n $DATA_VALUE&gt;$DATA_FILE fi if [ -f $DATA_PATH/incoming_data.txt ]; then echo "New incoming data:"; echo `cat $DATA_PATH/incoming_data.txt` cat $DATA_PATH/incoming_data.txt&gt;$ARDUINO_PORT rm -f $DATA_PATH/incoming_data.txt fi ACTION_RECEIVED="" if [ -f $DATA_PATH/incoming_action.txt ]; then ACTION_RECEIVED=`cat $DATA_PATH/incoming_action.txt` echo "New incoming action: $ACTION_RECEIVED" rm -f $DATA_PATH/incoming_action.txt fi . $DATA_PATH/rules_set.sh if [ -f $DATA_PATH/reboot ]; then echo "REBOOT FLAG" rm -f $DATA_PATH/reboot break; fi done &lt; $ARDUINO_PORT done #--------------------------------------------------------------------------- echo Cycle stopped.</span></span></code> </pre><br></div></div><br><br>  In the settings you can see that the device has a unique identifier (MASTER_ID), which is used to interact with the web service (recall that the presence of a permanent connection with it is not necessary). <br><br>  During the operation of the main script, the / etc / master / data / directory is used to store the loaded code of the rules, the values ‚Äã‚Äãof the last sensor readings, as well as for the operation of some structures of the rule system (for example, timers). <br><br>  A complete set of files can be downloaded from <a href="">this link</a> . <br><br><h5>  Rule system </h5><br>  The rule system was outlined above, so I‚Äôll dwell on it a bit more in detail.  In fact, each rule is a set of bash instructions.  The first part of this set, let's call it Activator, checks the incoming data for compliance with this rule, and the second part (the Contractor) directly performs some actions. <br><br>  Possible conditions for activating the rule: <br><ul><li>  Getting a string of a specific format from the microcontroller </li><li>  Receiving a command of a certain format from the internal (button, movement, temperature) or external (wireless) sensor </li><li>  ‚ÄúManual‚Äù activation via an API or other rule (running the script) </li></ul><br><br>  Possible actions: <br><ul><li>  Setting the variable value </li><li>  Sending a string / command to the sensor controller (for internal processing or for an external device) </li><li>  HTTP request to an external web system </li><li>  Running a shell command (Linux) </li><li>  Running script </li><li>  Deferred Timer Actions </li></ul><br><div class="spoiler">  <b class="spoiler_title">Rule Source Code Example</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># RULE 2 Forwarder RCSwitch (regex) MATCHED_RULE2='0' REGEX='^RCSwitch:(.+)$' if [[ $LINE =~ $REGEX ]] then MATCHED_RULE2="1" fi # RULE 2 ACTIONS if [[ "$MATCHED_RULE2" == "1" ]] then #Action 2.1 (http) echo "HTTP request: http://192.168.0.17/objects/?script=RCSwitch&amp;rcswitch=${BASH_REMATCH[1]}" wget -O $DATA_PATH/http.tmp http://192.168.0.17/objects/?script=RCSwitch\&amp;rcswitch=${BASH_REMATCH[1]} fi</span></span></code> </pre><br></div></div><br>  The rules are configured through the user's personal account after the device is registered in the web system (now the entire server component is implemented as part of the connect.smartliving.ru project).  There is no need to program it, the web system itself converts user-defined rules into bash commands.  From the user's side, the configuration interface looks like this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ad/41f/3fe/0ad41f3feb335a198f0a8feb194c2c07.jpg" alt="image"><br><br><h5>  Interface and API </h5><br>  In principle, the above is quite enough to create a standalone module, however, the wish list was long, as was the path to implementation.  The next step was to create a web interface and API.  This step is not complicated enough, as compared with the previous ones, and it was implemented by a similar principle.  There is already a web server on the host device, so another bash script was created to implement the API and placed in / www / cgi-bin / master <br><br><div class="spoiler">  <b class="spoiler_title">Script source code / www / cgi-bin / master</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash DATA_PATH="/etc/master/data" echo "Content-type: text/plain" echo "" # Save the old internal field separator. OIFS="$IFS" # Set the field separator to &amp; and parse the QUERY_STRING at the ampersand. IFS="${IFS}&amp;" set $QUERY_STRING Args="$*" IFS="$OIFS" # Next parse the individual "name=value" tokens. ARG_VALUE="" ARG_VAR="" ARG_OP="" ARG_LINE="" for i in $Args ;do # Set the field separator to = IFS="${OIFS}=" set $i IFS="${OIFS}" case $1 in # Don't allow "/" changed to " ". Prevent hacker problems. var) ARG_VAR="`echo -n $2 | sed 's|[\]||g' | sed 's|%20| |g'`" ;; # value) ARG_VALUE=$2 ;; line) ARG_LINE=$2 ;; op) ARG_OP=$2 ;; *) echo "&lt;hr&gt;Warning:"\ "&lt;br&gt;Unrecognized variable \'$1\' passed.&lt;hr&gt;" ;; esac done # Set value #ARG_OP="set" #echo $ARG_OP if [[ "$ARG_OP" == "set" ]] then # echo "Set operation&lt;br&gt;" echo -n "$ARG_VALUE"&gt;$DATA_PATH/$ARG_VAR.dat echo "OK" fi if [[ "$ARG_OP" == "get" ]] then # echo "Get operation&lt;br&gt;" cat $DATA_PATH/$ARG_VAR.dat fi if [[ "$ARG_OP" == "send" ]] then # echo "Send&lt;br&gt;" echo -n $ARG_LINE&gt;&gt;$DATA_PATH/incoming_data.txt echo "OK" fi if [[ "$ARG_OP" == "action" ]] then # echo "Action&lt;br&gt;" echo -n $ARG_LINE&gt;&gt;$DATA_PATH/incoming_action.txt echo "OK" fi if [[ "$ARG_OP" == "refresh" ]] then # echo "Send&lt;br&gt;" echo "Web"&gt;$DATA_PATH/reboot echo "OK" fi if [[ "$ARG_OP" == "run" ]] then # echo "Run&lt;br&gt;" echo `$ARG_LINE` fi</span></span></code> </pre><br></div></div><br><br>  This script provides the following API commands: <br><br>  <b>Setting the variable value</b> <br> <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/cgi-bin/master%3Fop%3Dset%26var%3DVariable1%26value%3DValue1"></a> _/cgi-bin/master?op=set&amp;var=Variable1&amp;value=Value1</code> <br>  Sets the value of variable Variable1 to Value1 <br><br>  <b>Getting variable value</b> <br> <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/cgi-bin/master%3Fop%3Dget%26var%3DVariable1"></a> _/cgi-bin/master?op=get&amp;var=Variable1</code> <br>  Returns the value of the variable Variable1 <br><br>  <b>Sending data to the controller</b> <br> <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/cgi-bin/master%3Fop%3Dsend%26line%3DSomeData"></a> _/cgi-bin/master?op=send&amp;line=SomeData</code> <br>  Sends the SomeData line to the connected controller <br><br>  <b>Activation action</b> <br> <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/cgi-bin/master%3Fop%3Daction%26line%3DSomeAction"></a> _/cgi-bin/master?op=action&amp;line=SomeAction</code> <br>  Initializes the action SomeAction, described in the rules (type "Active actions") <br><br>  <b>Force update rules</b> <br> <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/cgi-bin/master%3Fop%3Drefresh"></a> _/cgi-bin/master?op=refresh</code> <br>  Initializes a forced update (download) of the rules and the web interface without rebooting the device <br><br>  <b>System command</b> <br> <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/cgi-bin/master%3Fop%3Drun%26line%3DSomeCommand"></a> _/cgi-bin/master?op=run&amp;line=SomeCommand</code> <br>  Initializes SomeCommand execution in the system shell (for example, using "reboot" will restart the device) <br><br>  After the API was a web interface.  It was treated the same way as with the rules - we configure it on the web service and update it on the device at the same initialization stage.  Here is the interface for creating the control menu for the device: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/780/ed6/93c/780ed693c6031dcf115b4d2c4df1b8f1.png" alt="image"><br><br>  In order not to reinvent the wheel, the Kraken lightweight frontend framework was taken and thrown into the / www / kraken-master folder.  After initialization, the menu.html file appears in the / www / folder and, accordingly, you can access our customized web interface at <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/menu.html"></a> _/menu.html</code>  <code><a href="http://xn--_-7sbbhig3a3bpcjbdkej/menu.html"></a> _/menu.html</code> .  This type of address was chosen not by chance, but for compatibility with the MajorDroid mobile application (for the Android platform) - a small detail, but I am for the universality and compatibility of everything and everything, so that, why not. <br><br><h5>  Online operation </h5><br>  ‚ÄúUh, well, the sistemka turns out and it's not all?‚Äù - you ask.  Well, almost, it remains just a little.  More precisely, "a little" for the user, but a big stage for the developer (as often happens).  Namely - work with the device via the Internet.  It would seem that there is a web interface, send ports on the router and enjoy your health.  But these are not our methods, our methods in simplifying the lives of others (and complicating ourselves).  Suppose the worst - there is no possibility to change the settings of the router and make forward ports.  Or it is intended to use a variety of similar devices on the same network and each (hypothetically) wants to be able to access from the outside.  The solution was such - the device itself should initiate and maintain a channel with an external server for exchanging data and commands, while the external server duplicated the web interface specified for a specific device and organized the transmission of commands from the user through this channel.  The channel is a socket-connection, which on the one hand (on the device) creates a separate bash-script and on the other hand (on the server) a socket-server. <br><br>  On the device, the script is in / etc / master / socket_client <br><br><div class="spoiler">  <b class="spoiler_title">Script source code / etc / master / socket_client</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # settings . /etc/master/settings.sh # STEP 0 # wait to be online COUNTER=0 while [ $COUNTER -lt 5 ]; do ping -c 1 $ONLINE_CHECK_HOST if [[ $? = 0 ]]; then echo Network available. break; else echo Network not available. Waiting... sleep 5 fi let COUNTER=COUNTER+1 done #--------------------------------------------------------------------------- # START if [ ! -d "$DATA_PATH" ]; then mkdir $DATA_PATH chmod 0666 $DATA_PATH fi while : do TEST_FILE=$DATA_PATH/data_sent.txt touch $TEST_FILE SOCKET_HOST=connect.smartliving.ru SOCKET_PORT=11444 exec 3&lt;&gt;/dev/tcp/$SOCKET_HOST/$SOCKET_PORT NOW=$(date +"%H:%M:%S") echo -n $NOW echo " Sending: Hello!" echo "Hello!"&gt;&amp;3 read -t 60 ok &lt;&amp;3 NOW=$(date +"%H:%M:%S") echo -n $NOW echo -n " Received: " echo "$ok"; REGEX='^Please' if [[ ! $ok =~ $REGEX ]] then NOW=$(date +"%H:%M:%S") echo -n $NOW echo " Connection failed!" continue fi NOW=$(date +"%H:%M:%S") echo -n $NOW echo " Sending: auth:$MASTER_ID" echo "auth:$MASTER_ID"&gt;&amp;3 read -t 60 ok &lt;&amp;3 NOW=$(date +"%H:%M:%S") echo -n $NOW echo -n " Received: " echo "$ok"; REGEX='^Authorized' if [[ ! $ok =~ $REGEX ]] then NOW=$(date +"%H:%M:%S") echo -n $NOW echo " Authorization failed!" exit 0 fi NOW=$(date +"%H:%M:%S") echo -n $NOW echo " Sending: Hello again!" echo "Hello again!"&gt;&amp;3 read -t 60 ok &lt;&amp;3 NOW=$(date +"%H:%M:%S") echo -n $NOW echo -n " Received: " echo "$ok"; while read -t 120 LINE; do NOW=$(date +"%H:%M:%S") echo -n $NOW echo -n " Got line: " echo $LINE # Ping reply REGEX='^PING' if [[ $LINE =~ $REGEX ]] then echo -n $NOW echo " Sending: PONG!" echo PONG!&gt;&amp;3 fi # Run action REGEX='^ACTION:(.+)$' if [[ $LINE =~ $REGEX ]] then DATA_RECEIVED=${BASH_REMATCH[1]} NOW=$(date +"%H:%M:%S") echo -n $NOW echo -n " Action received: " echo $DATA_RECEIVED echo -n $DATA_RECEIVED&gt;&gt;$DATA_PATH/incoming_action.txt fi # Pass data REGEX='^DATA:(.+)$' if [[ $LINE =~ $REGEX ]] then DATA_RECEIVED=${BASH_REMATCH[1]} echo -n $NOW echo -n " Data received: " echo $DATA_RECEIVED echo -n $DATA_RECEIVED&gt;&gt;$DATA_PATH/incoming_data.txt fi # Pass data REGEX='^URL:(.+)$' if [[ $LINE =~ $REGEX ]] then DATA_RECEIVED=${BASH_REMATCH[1]} echo -n $NOW echo -n " URL received: " echo wget -O $DATA_PATH/data_post.tmp http://localhost$DATA_RECEIVED fi # Check files modified FILES=$DATA_PATH/*.dat for f in $FILES do if [ $f -nt $TEST_FILE ]; then echo "Processing $f ..." FNAME=${f##*/} PARAM=${FNAME/.dat/} CONTENT=`cat $f` echo -n $NOW echo " Sending: DATA:$PARAM|$CONTENT;" echo "data:$PARAM|$CONTENT;"&gt;&amp;3 fi done touch $TEST_FILE done &lt;&amp;3 done #--------------------------------------------------------------------------- echo Cycle stopped.</span></span></code> </pre><br></div></div><br><br>  The user from his account has a link and a QR code for working with the device.  One of the test examples below: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e9/c4f/5da/9e9c4f5da2fe93a25ba7faf7cac54043.png" alt="image"><br><br><h5>  Challenges for the future </h5><br>  All the described construction works quite stably - from the moment of launch and the time I decided to write an article, perhaps a couple of months have passed, and the device regularly performs its functions.  However, everything is implemented, as they say, without excesses.  To test the concept, this is enough, but for mass implementation of devices on this (or similar) platform, I would work in the following areas: <br><br><ul><li>  Security (encryption, interface access passwords, etc.) </li><li>  Performance on the server side (although there were no problems yet, but a homemade socket server is not the best implementation option) </li><li>  UI / UX (both for the device and for personal account) </li><li>  Iron (‚ÄúArduino? Router !? I beg you ...‚Äù) </li></ul><br><br><h5>  Conclusion </h5><br>  The article does not describe all the details of the settings and some things such as the settings for autorun scripts, I deliberately omitted, trying to convey the basic features and essence of the concept. <br><br>  Specifically, this device and the whole process of its creation was an experiment to test the operation of individual components and technologies.  In the process, ideas appeared in other devices and systems, and something migrated from outside to this project, so that, in general, time was spent for nothing.  I would be glad if my implementation experience would be useful. <br><br>  If we develop the topic of commercial application of the concept, then we can talk about less universal, but, rather, applied implementations.  For example: <br><br><ul><li>  Home Watchman - informs the owner that someone has come home and the room temperature </li><li>  Lighting Controller - light control on schedule / event </li><li>  Climate control - receiving information from external temperature / humidity sensors and controlling actuators </li><li>  Control of well-being - sending a notification when you click on the ‚Äúalarm‚Äù button or when there is no movement for a long time </li></ul><br><br>  Thus, having the same base, you can create many applied ‚Äúboxed‚Äù solutions, integrating such ‚ÄúInternet things‚Äù with information systems at a higher level. <br><br>  PS I thought for a long time whether to post a ‚Äúlive‚Äù photo of the resulting device, but I already warned about the experimental nature of the whole project, so the cardboard case (or its layout, if you like) is quite consistent: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/017/7ef/cfd/0177efcfdbc955b2e82563638a6a60a4.png" alt="image"><br><br>  PPS I almost forgot, the cost of this device with all the listed components is about $ 60, the time spent is priceless. </div><p>Source: <a href="https://habr.com/ru/post/224449/">https://habr.com/ru/post/224449/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../224435/index.html">Report on the first stage of the Geo-Hakaton</a></li>
<li><a href="../224437/index.html">How I ordered and collected PRUSA i3</a></li>
<li><a href="../224443/index.html">One essay on project portfolio management</a></li>
<li><a href="../224445/index.html">Yandex.Translate offline. How computers learned to translate well</a></li>
<li><a href="../224447/index.html">The future of scripts in unity 3d</a></li>
<li><a href="../224451/index.html">How much is the apple market today?</a></li>
<li><a href="../224453/index.html">Anatoly Wasserman: about the future, intelligence and socialism</a></li>
<li><a href="../224455/index.html">A simple way to make plain text marketing</a></li>
<li><a href="../224459/index.html">Wireless thermometer</a></li>
<li><a href="../224461/index.html">A / B testing errors in AirBnB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>