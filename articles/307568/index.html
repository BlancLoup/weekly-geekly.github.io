<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Search for invalid passports or learn how to prepare binary files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to the publication Why Go surpasses mediocrity , one of the habrayers suggested writing an algorithm for searching for a list of inval...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Search for invalid passports or learn how to prepare binary files</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/6ae/ab4/875/6aeab48753da440da7d782041199a841.png" align="left">  In the comments to the publication <a href="https://habrahabr.ru/post/260451/">Why Go surpasses mediocrity</a> , one of the habrayers suggested writing an algorithm for searching for a list of invalid passports as an example. <br>  One of the conditions of the task was not to use DBMS for this purpose.  Also, the solution should at a minimum use memory, disk space and CPU. <br><br>  To my surprise, I found out that most commentators suggested using a DBMS, despite the fact that a solution using standard databases would be quite cumbersome (except that for the data itself you need to use at least 5 bytes per record, so also almost as many places on indexes). <br><br>  Having experience working on binary databases for <a href="http://sypexgeo.net/">Sypex Geo</a> , I decided to try to sketch a binary file format and a search algorithm for it. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Data analysis </h3><br>  First of all, in order to create a special file format, you need to analyze the data itself. <br>  The initial data is a <a href="http://services.fms.gov.ru/info-service.htm%3Fsid%3D2000">CSV file</a> containing a list of invalid passports (series and number, separated by commas), we are only interested in Russian passports (4 digits of the series and 6 digits of the number). <br><br>  In the bz2 archive this list occupies 359 MB, in unpacked form 1.13 GB.  About 102 million records.  I loaded the data into MySQL (there is a convenient loading of a CSV file using LOAD DATA), and already in it I analyzed the data.  Without indexes, the table with the following structure hung at 680 MB. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-string"><span class="hljs-string">`pass`</span></span> ( <span class="hljs-string"><span class="hljs-string">`seria`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SMALLINT</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`num`</span></span> MEDIUMINT(<span class="hljs-number"><span class="hljs-number">8</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=MyISAM ROW_FORMAT=<span class="hljs-keyword"><span class="hljs-keyword">FIXED</span></span></code> </pre> <br>  If you add an index on the num column, it will be 1.5 GB, and if you make an index on two columns, then it will already be 1.7 GB. <br><br>  It turned out that: <br><br><ol><li>  For one series can be up to 600,000 numbers. </li><li>  At the time, as for a single number, a maximum of 200 series. </li></ol><br>  From here we conclude that searching immediately by number is more profitable, since this will greatly reduce further search.  So we make an index by passport number. <br><br><h3>  Create your own format </h3><br>  Our binary file will consist of two parts, the first part will be an index in which there will be a constant number of elements, namely a million values ‚Äã‚Äãfrom 000 000 to 999 999. Each index element occupies 4 bytes and contains an offset in the second part of the file, where series listings for the corresponding number.  The series itself is stored in the second part of the file as two-byte values.  The number of elements in the series for a particular number is the difference of the offsets (the desired number) and (the desired number + 1). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/382/867/1e1/3828671e18914aaa90d330559f9afa80.png"></div><br>  <font color="#999999"><i>Schematic display of the structure of the binary file to search for invalid passports.</i></font> <br><br>  To find out if there is a passport in the list of invalid, you need to perform the following simple steps. <br>  For example, take the number <b>2365 000002</b> . <br><br><ol><li>  According to the passport number, we determine the offset in the index, for this we multiply the number by 4 (the size of the index element).  <b>4 * 000002 = 8 bytes</b> (red block in the figure) </li><li>  Perform the offset and read 2 index elements (2 * 4 bytes) to know the beginning of the list of series and the end.  Convert them to 2 decimal 32-bit numbers.  In our case, it turns out <b>7 and 11</b> (for clarity, the display shows not the offset in bytes, but 1 unit offset = 1 series) </li><li>  We read data on the shift of the beginning of the list of series to the end of the list of series of the desired number, remember that the series are written in 2 bytes. </li><li>  Now we are looking for the series we need among two-byte sequences. </li><li>  If found, the passport is not valid, otherwise it is not listed as invalid in the database. </li></ol><br>  Since there are no more than 200 series for each number, you can search for the series by a simple search.  To speed up the process, you can use a binary search, pre-sorting the series.  But about any additional optimizations, probably, in another publication I will write if it is interesting. <br><br><h3>  And now testing </h3><br>  For example, I sketched a couple of test scripts in PHP.  One for converting a CSV file into our binary format.  The second to find the right passport.  Archive with scripts can be <a href="">downloaded here</a> . <br><br>  Also compare the resulting solution with the option in which the data in MySQL.  Data is stored on the SSD (in the case of storage on the HDD, the indicators will be worse), besides, there is enough memory on the server to cache all the tables in memory, i.e.  The most optimal option for MySQL. <br><br>  Testing was conducted on your favorite test site - Vultr.  Favorite because you can quickly raise a powerful VPS-ku with hourly pay and storage snapshots free (ie, you can delete, and then, when you need to quickly restore the test environment). <br><br><div class="spoiler">  <b class="spoiler_title">Bonus</b> <div class="spoiler_text">  Those who want to receive $ 20 to the account can use the <a href="http://www.vultr.com/%3Fref%3D6950313-3B">ref-link</a> (for new users only) to pay for Vultr services. </div></div><br>  For VPS, the selected plan is 6 CPU, 8 GB, 150 GB SSD, MariaDB 10.1.16, PHP 7.0.9. <br><br><h3>  So, to the numbers </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/files/473/7e4/a10/4737e4a10a55413b8222bbbd6b79f565.png"></div><br>  For each type of data storage, we checked two modes: single mode (when opening a file and connecting to the database is done for each number) and batch mode (opening the file and connecting to the database once). <table><tbody><tr><td></td><td>  Dat file </td><td>  Mysql <br>  without indexes </td><td>  Mysql <br>  index by numbers </td><td>  Mysql <br>  index by numbers and series </td></tr><tr><td>  DB size (including index) </td><td>  198 MB </td><td>  680 MB </td><td>  1.5 GB </td><td>  1.7 GB </td></tr><tr><td>  Index size </td><td>  4 MB </td><td>  0 MB </td><td>  893 MB </td><td>  1.07 GB </td></tr><tr><td>  Download CSV in DB (mm: ss) </td><td>  3: 54 * </td><td>  0:31 </td><td>  3:38 </td><td>  3:42 </td></tr><tr><td>  Single search speed (p / s) </td><td>  91 198 </td><td>  0.2 ** </td><td>  3,711 </td><td>  3,760 </td></tr><tr><td>  Search speed batch (p / sec) </td><td>  212,116 </td><td>  0.2 </td><td>  44 137 </td><td>  44,822 </td></tr></tbody></table>  <i>* The speed is not very, since the creation of the dat-file was done as simply and primitively as possible, so long as it worked.</i>  <i>If it is interesting, I will write how to significantly speed up the parsing time of CSV.</i> <i><br></i>  <i>** For all methods, 300,000 passports were run, except for MySQL without an index, since it takes up to 10 seconds to search for one passport.</i> <br><br><h3>  findings </h3><br>  As we see from the results of testing, the custom solution, sharpened for the desired task, can work much faster than general-purpose DBMS, besides, the format is 7-8 times more compact than the table in MySQL. <br><br>  And the script itself for searching the file takes less than 10 lines (without comments). <br><br><pre> <code class="php hljs">$pass = <span class="hljs-string"><span class="hljs-string">'0307,000000'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   $fn = fopen('passports.dat', 'rb'); //   //    2- ,     ,     $seria = pack('n', substr($pass, 0, 4)); $num = substr($pass, 5); //       fseek($fn, $num * 4); //   2   4  $seek = unpack('Nbegin/Nend', fread($fn, 8)); //      fseek($fn, $seek['begin']); $series = fread($fn, $seek['end'] - $seek['begin']); //     echo ($pos = strpos($series, $seria)) !== false &amp;&amp; $pos % 2 == 0 ? 'INVALID' : 'VALID';</span></span></code> </pre> <br>  PS The script is naturally maximally simplified, and is intended for training purposes, and not for production (but this concerns not so much the algorithm, as error handling). <br><br>  Translations to other programming languages ‚Äã‚Äãare welcome, it will be possible to measure :) </div><p>Source: <a href="https://habr.com/ru/post/307568/">https://habr.com/ru/post/307568/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../307556/index.html">Planning usability testing. Part 1</a></li>
<li><a href="../307558/index.html">Blend @PreAuthorize in Spring Security with arbitrary types and simple inspected DSL</a></li>
<li><a href="../307560/index.html">Use powershell scripts in icinga2</a></li>
<li><a href="../307562/index.html">Soprocess: -What, -how, -why?</a></li>
<li><a href="../307564/index.html">The Golden Key is an unavoidable possibility of a full bypass of Secure Boot on most Windows devices.</a></li>
<li><a href="../307570/index.html">The final release of Vivaldi 1.3</a></li>
<li><a href="../307572/index.html">33 ways to deal with uncertainty and anxiety like Madonna</a></li>
<li><a href="../307574/index.html">Random User-Agent - version two</a></li>
<li><a href="../307576/index.html">Voice "prints" now officially work (and how the implementation process at Priorbank looks like)</a></li>
<li><a href="../307578/index.html">From Slides Defined to Software Defined Networking. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>