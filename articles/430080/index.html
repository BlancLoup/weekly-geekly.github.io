<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moving to a cluster running "1C-Bitrix: Web Environment"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At a certain point, a task appeared - to transfer, an existing and actively working in production project to work in a cluster of servers. Since The p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moving to a cluster running "1C-Bitrix: Web Environment"</h1><div class="post__text post__text-html js-mediator-article">  At a certain point, a task appeared - to transfer, an existing and actively working in production project to work in a cluster of servers.  Since  The project was developed on the basis of 1C-Bitrix, it was decided to build a cluster using 1C-Bitrix: Web Environment.  The purpose of this event is to get the ability to withstand heavy loads with the influx of visitors to the site, as well as the ability to further scale horizontally faster. <br><a name="habracut"></a><br><p>  Actually, if we turn to <a href="https://www.1c-bitrix.ru/products/env/">the</a> vendor‚Äôs <a href="https://www.1c-bitrix.ru/products/env/">site</a> , we‚Äôll see that: <br><br>  <b>‚Äú1C-Bitrix‚Äù: Web Environment ‚Äù- Linux is used to quickly and easily install all the software required for the operation of 1C-Bitrix products and solutions on CentOS 6 (i386, x86_64) and CentOS 7 (x86_64) Linux platforms.</b>  <b>It is necessary to install on a ‚Äúclean‚Äù CentOS, without a web server already installed.</b> <br><br>  The structure of "1C-Bitrix: Web Environment" - Linux includes: mysql-server, httpd, php, nginx, nodejs push-server, memcached, stunnel, catdoc, xpdf, munin, nagios, sphinx. <br></p><br><p>  In fact, this software package contains a configured LAMP, a console control panel of the server, plus additional packages necessary for the operation of some 1C-Bitrix modules.  All software is configured with the features of 1C-Bitrix, namely: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </p><ul><li>  the necessary extensions are installed (gd, zip, socket, mbstring) </li><li>  support for short tags is included </li><li>  The required values ‚Äã‚Äãfor the parameters memory_limit, max_input_vars, safe mode, opcache.validate_timestamps, opcache.revalidate_freq, mbstring.func_overload, default_charset, display_errors, etc. are set. </li><li>  the same time zone is set for the database, php and on the server itself </li><li>  and etc. </li></ul><br>  This allows, in most cases, not to configure the server and its tuning. <br><br><p>  So, we had 2 app servers (let's call them app01 and app01), 2 db servers (db01, db02), 1 server for caching (cache01, you understand), or rather the idea was to implement the cluster structure in a similar way.  Under this plan, 5 servers were obtained, with the latest versions of centos7 installed on them (unfortunately, debian, ubuntu, fedora, rhel, and others are not suitable), except for os, nothing was installed on the servers. <br></p><br><p>  Since  we collect a cluster, it is necessary to determine which of the servers will be the main one.  Due to the peculiarities of balancing requests to the application, one of the servers where httpd will work will also contain nginx.  All incoming requests will also receive it, and then redirect the request to one of the available web nodes.  We chose the main app01 server. </p><br><p>  Further work went according to the following plan: <br><br></p><h4>  1. Install bitrixenv </h4><br><p>  Installation does not imply supernatural knowledge of linux or administration.  We go to each server via ssh and execute the following commands: <br><br></p><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~ wget http://repos.1c-bitrix.ru/yum/bitrix-env.sh chmod +x bitrix-env.sh ./bitrix-env.sh</code> </pre> <br>  Bitrixenv must be installed on all servers that you plan to use in a cluster.  Even if the server will only work as a memcached instance, bitrixenv is needed because  allows you to manage the entire cluster from the main server. <br><br><h4>  2. Configure bitrixenv </h4><br><p>  Since  we will use this whole zoo as a cluster, then we can configure the servers through the environment menu on app01.  To do this, go to the server via ssh, and run the file /root/menu.sh.  When you first start, you must set a password for the bitrix user (a similar operation must be performed on all servers where the site is planned to be launched): <br><br><img src="https://habrastorage.org/webt/wm/pg/-w/wmpg-wbh8y7kydfopv1nag4dyt0.png"><br><br>  Actually, this is the user under which the application will work.  After this we see a screen offering to create a pool of servers: <br><br><img src="https://habrastorage.org/webt/ey/v8/y7/eyv8y7mrpuze0gm0fmcnymzu6m4.png"><br><br>  Here we need to select the first menu item.  During the creation process, the environment will request the name of the current server, then we specify app01: <br><br><img src="https://habrastorage.org/webt/4e/zk/4e/4ezk4esmjjpyz8n3psrqxbkizqe.png"><br><br>  After the pool is created, we are returned to the first screen of the environment, but this time there are more items available: <br><br><img src="https://habrastorage.org/webt/cf/_5/ur/cf_5ur88xlgsyfo1wiisyxffoya.png"><br><br>  In general, the environment is ready and you can use it.  If we do not need a cluster, then we could end it, but we will go further. <br><br>  Now we need to add all available servers to the created pool.  To do this, use the first menu item and see the following options: <br><br><img src="https://habrastorage.org/webt/e1/f5/cw/e1f5cws72kp-8bmix8ljmhhxhg8.png"><br><br>  Again, select the first menu item, and specify the ip of the new server, its name in the cluster (the same app02, db01, db02, cache01) and the root password from the connected server.  Thus, we add each existing server in turn.  After all the servers are registered in the cluster, we should get something like this on the main screen of the environment: <br><br><img src="https://habrastorage.org/webt/e6/zg/-e/e6zg-exxnncdwnbvadgakhzoqe0.png"><br><br>  Setting server roles until the next step. </p><br><h4>  3. Transfer of the project </h4><br><p>  Since  our application initially runs on the same server, the cluster scaling and management module is disabled, the database is not replicated.  The transfer itself is nothing supernatural - packed bitrix and upload folders, removed the database dump. <br><br>  After the archives and dumps are ready, go to app01, and pull the project code into the default folder of the site in bitrixenv - / home / bitrix / www via git, download the archives and dump of the database, unpack the archives and fill in dump to db on app01, transfer cron entries. <br><br>  If your application uses additional software, then it's time to install and configure it.  In our case, supervisord and RabbitMQ were installed and configured, since  The application worked using queues. <br><br>  There is a small, but important, nuance.  When transferring a site to a cluster, it is necessary that the scale and cluster modules are disabled on the site, and in the environment of the cluster to which the transfer is planned, the pool servers are not involved.  Cluster servers need to be put into operation only after the site is moved and deployed on the main server.  Otherwise, the site will not be able to correctly identify the cluster servers. </p><br><h4>  4. Enabling cluster mode </h4><br><p>  After the application was transferred to app01, and we checked the correctness of its work, it‚Äôs time to do the most interesting thing - scaling.  First you need to install the scale and cluster modules in the 1C-Bitrix admin panel.  During installation, nothing special needs to be done, all the work goes on. <br><br>  Once the modules are installed, go to the ssh connection to the main server, and this is app01, and open the bitrixenv menu (here lies / root / menu.sh).  Before proceeding with further configuration, it is necessary to find out one important point - bitrixenv operates with the concept of ‚Äúserver role‚Äù.  It does not matter what the name of the server in the pool is, because  Each server contains all the software that is included in the bitrixenv package, we can always assign one or more roles to it, and we can remove them from it or change them for others.  The main roles are mgmt (balancer, i.e. nginx), web (i.e. httpd / apache), mysql_master and mysql_slave (database instance, the slave appears already when we start replication), memcached (server with memcached).  The overall picture is now clear, and we decided to start with a memcached server.  To do this, go to the point <br><br></p><pre> <code class="bash hljs">4. Configure memcahed servers &gt; 1. Configure memcached service</code> </pre> <br>  and see the request for the name of the server that will serve as the memcached server.  We already have a cache01 server prepared for this, so we are looking at the list of available servers.  If cache01 is in the list, then there are no problems with the installation, and we can give the server the selected role. <br><br><img src="https://habrastorage.org/webt/2h/dt/ri/2hdtris8zeqwuhnzh7dlhdgl2ok.png"><br><br>  Enter the name of cache01, we see that the task of installing the role is queued.  We wait for the end of the background work and see the server ready for work with the role we need. <br><br><img src="https://habrastorage.org/webt/pb/fl/8i/pbfl8ivpd6zfi_dyp1fuxnft0ye.png"><br><br>  It's time to add a second app server.  To do this, go on the way <br><pre> <code class="bash hljs">8. Manage web nodes <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the pool &gt; 1. Create web role on server,</code> </pre> <br><img src="https://habrastorage.org/webt/c2/gm/v4/c2gmv4dw0-6zlowpqxlbe7p1r5e.png"><br><br>  where we need to specify the server name and the method of synchronization between the main and new web nodes.  Based on the bitrixenv documentation and preliminary tests, it was enough for our project to select the first option (in one step, the project is copied and the node configuration is set up).  After the background work is over, we should see in the main menu something like this: <br><br><img src="https://habrastorage.org/webt/xr/jv/zq/xrjvzqpulix02m0-djnqpr5kfvm.png"><br><br>  Note that the Roles column opposite the app02 server indicates the web role. <br>  It remains to deal with the database, its configuration takes the most time.  To begin with, I will briefly explain how the roles of mysql are distributed in the context of bitrixenv.  By default, the master server is the master version of the database.  In our case, it was necessary to move the database to a separate server and add another server with a slave version of the database.  In bitrixenv you can‚Äôt just take and transfer master from one server to another) <br><br><img src="https://habrastorage.org/webt/_v/a5/re/_va5rev8p01txuvlp0dm7bvzusa.png"><br><br>  The sequence is as follows: <br><br><ol><li>  We give the role of mysql_slave to the server to which we plan to transfer the database </li><li>  On the target server, we change the role of mysql_slave to the role of mysql_master (the old mysql_master automatically switches to mysql_slave mode) </li><li>  Removing the mysql_slave role on the source server that was master </li><li>  ... </li><li>  PROFIT !!! </li></ol><br>  We followed this logic in this way: <br><br>  Switched to <br><br><pre> <code class="bash hljs">3. Configure MySQL servers &gt; 4. Create MySQL slave</code> </pre> <br><img src="https://habrastorage.org/webt/de/m8/00/dem800hstmjttip1emw8-rju_yy.png"><br><br>  Specified the server to which we want to give the role of mysql_slave - db01.  We are waiting for the end of the background work and see the following result: <br><br><img src="https://habrastorage.org/webt/lx/e8/0j/lxe80jzw6ldho2nxu_hzuzm-zhy.png"><br><br>  Great, now go to <br><br><pre> <code class="bash hljs">3. Configure MySQL servers &gt; 5. Change MySQL master</code> </pre> <br><img src="https://habrastorage.org/webt/y3/uo/zs/y3uozsxqidwvzayp1iw8ljw_u_q.png"><br><br>  Specify app01 and wait.  As a result, you should see something like this: <br><br><img src="https://habrastorage.org/webt/is/h7/5a/ish75a5cduszd7lle8e9gjl0kia.png"><br><br>  Slowly and inevitably, we approached the installation of the last role - mysql_slave.  To do this, you need to repeat the actions by which we have established such a role for db01, but specify already db02. <br><br>  Finally, all servers are connected and configured. <br><br><h4>  5. Tuning performance </h4><br><p>  After the cluster is ready, there are some features in the application setup that allow for additional optimization: <br><br></p><ul><li>  We are pumping work with sessions.  Described in detail <a href="https://dev.1c-bitrix.ru/community/blogs/rns/hidden-features-of-work-with-sessions.php">here</a> .  In short - we switch storage of sessions in memcached. </li><li>  Delete the files /bitrix/php_interface/after_connect_d7.php and /bitrix/php_interface/after_connect.php, because  commands from them terminate the cluster pipeline (if bitrixenv is not used, it is better to leave them). </li><li>  We increase the amount of memory allocated by memcached and set the percentage of utilization of servers with the memcached role to 100%. </li><li>  Disable php modules: apcu, ldap </li><li>  Disable modules Compression, and ‚ÄúWeb analytics‚Äù (if possible). </li><li>  Consider using a local cache.  Details are described <a href="https://dev.1c-bitrix.ru/community/blogs/rns/the-use-of-local-caches-in-the-cluster.php">here</a> .  In our case, there was no increase, but the idea is interesting.  The solution has a couple of features: <br><br><ul><li>  The number of memcached instances should be equal to the number of web nodes. </li><li>  To return the composite cache, nginx will have to dig the nginx config from the box directly from the local memcached, it does not work out of the box. </li></ul><br></li><li>  Transfer the execution of all agents to cron. </li></ul><br><br><h3>  findings </h3><br><p>  In this article, we have reviewed the sequence of actions required to configure a cluster of servers based on bitrixenv, as well as some possible pitfalls.  According to the results of work with bitrixenv, and the cluster on it, we can highlight the pros and cons of this approach: <br><br></p><h4>  Pros bitrixenv </h4><br><ul><li>  Installation time <br>  Installation and basic setup takes less than 30 minutes.  There is no need to configure LAMP elements (both the integration of these services with each other, and for the correct operation of projects on 1C-Bitrix). </li><li>  Services to speed up the site <br>  Installed and configured services that allow organizing faster caching through memcached, rather than files, search using the sphinx engine and functional video calls and chats on the building portal (nginx push &amp; pull module).  In addition, nginx in the environment is configured in such a way that when you enable the corresponding options on the website and in the bitrixenv menu, the cache is given using nginx immediately from memcached (bypassing httpd and php) </li><li>  Clustering <br>  Ability to enable database replication, without picking MySQL settings.  Connect an arbitrary number of web-nodes, which will be automatically synchronized with each other, and memcached-nodes.  Manage the distribution of the load on the web- and memcached-nodes both from the bitrixenv menu and through the admin panel of the project on 1C-Bitrix.  Plus, adding new servers and roles to them does not cause a simple project (except for the role of database servers) </li></ul><br><h4>  Cons bitrixenv </h4><br><ul><li>  The balancer is always together with the main web-node <br>  Since  we already had our own balancer, we were faced with the fact that it is impossible to abandon the balancer built into bitrixenv.  It is impossible including  place it separately from the main web node. </li><li>  A lot of extra software for some roles <br>  Since  each server in the pool contains the full version of the environment, it turns out that the db-nodes are httpd, memcached, sphinx, even if they are not used.  Similarly, you can find MySQL on the server, which deals only with caching, but in this case, MySQL can be stopped in the environment menu or the admin panel of the site. </li><li>  Php works in apache2handler mode <br>  There is no way to safely enable php to work in fcgi mode, not to mention the nginx + php-fpm mode.  It is also impossible to change the version of php, without dancing with a tambourine. </li></ul><br><br><h4>  Sources: </h4><br><p>  <a href="https://www.1c-bitrix.ru/products/env/">www.1c-bitrix.ru/products/env</a> <br>  <a href="https://dev.1c-bitrix.ru/community/blogs/rns/hidden-features-of-work-with-sessions.php">dev.1c-bitrix.ru/community/blogs/rns/hidden-features-of-work-with-sessions.php</a> <br>  <a href="https://dev.1c-bitrix.ru/community/blogs/rns/the-use-of-local-caches-in-the-cluster.php">dev.1c-bitrix.ru/community/blogs/rns/the-use-of-local-caches-in-the-cluster.php</a> <br>  <a href="https://dev.1c-bitrix.ru/learning/course/index.php%3FCOURSE_ID%3D32%26INDEX%3DY">dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=32&amp;INDEX=Y</a> <br>  <a href="https://dev.1c-bitrix.ru/learning/course/index.php%3FCOURSE_ID%3D37%26INDEX%3DY">dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=37&amp;INDEX=Y</a> <br></p></div><p>Source: <a href="https://habr.com/ru/post/430080/">https://habr.com/ru/post/430080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430068/index.html">Pupa order</a></li>
<li><a href="../430072/index.html">"Server-side Swift is underestimated": interview with Paul Hudson</a></li>
<li><a href="../430074/index.html">How I almost caught a virus trying to sell my boots</a></li>
<li><a href="../430076/index.html">Free broadcast DotNext 2018 Moscow</a></li>
<li><a href="../430078/index.html">How to control electrical appliances, radio-controlled models, motorized sidecar using a glance</a></li>
<li><a href="../430082/index.html">TravinaBivay: Habr and RUVDS are the sea wolves of Russian IT</a></li>
<li><a href="../430084/index.html">For Oracle JDK will need to pay. What are the options now?</a></li>
<li><a href="../430086/index.html">What's new in Android 9 Pie for Sony Xperia smartphones</a></li>
<li><a href="../430092/index.html">Banks Credit Suisse and UBS accused of coordinating a boycott of Apple Pay and Samsung Pay</a></li>
<li><a href="../430094/index.html">Shelf retroconsole arrived: PC Classic for those who cherish DOS-games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>