<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Machine intelligence in a Gboard keyboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most people spend a significant part of their time every day at the keyboard on their mobile device: composing letters, chat messages, social networks...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Machine intelligence in a Gboard keyboard</h1><div class="post__text post__text-html js-mediator-article">  Most people spend a significant part of their time every day at the keyboard on their mobile device: composing letters, chat messages, social networks, etc. However, mobile keyboards are still rather incoherent.  The average user types from a mobile keyboard about 35% slower than a physical one.  To change this, we recently introduced <a href="https://blog.google/products/search/gboard-android-gets-new-languages-and-tools/">many great improvements</a> to <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.google.android.inputmethod.latin">Gboard for Android</a> .  We strive to create a clever mechanism that allows you to quickly enter text, at the same time offering hints and correcting errors, in any language of your choice. <br><br>  Considering the fact that a mobile keyboard translates touch into text in much the same way that a voice recognition system translates voice into text, we used Speech Recognition.  First, we created robust spatial models that match fuzzy touch sequences to the touchscreen with keyboard keys, just like acoustic models match sound sequences with phonetic units.  Then we created a powerful decoding engine based on <a href="https://en.wikipedia.org/wiki/Finite-state_transducer">end transducers</a> (FST) to determine the most likely phrase for a given touch sequence.  We knew that with its mathematical formalism and broad success in voice applications, the FST decoder will provide the necessary flexibility to support a wide variety of complex input options, as well as language functions.  In this article we will tell in detail what was included in the development of both of these systems. <br><a name="habracut"></a><br><h3>  Neural Spatial Models </h3><br>  Entering from a mobile keyboard is subject to errors, commonly referred to as ‚Äúfat finger‚Äù (or tracing spatially similar words in a sliding set, as shown below), as well as motor and cognitive errors (as typed in typos, inserting extra characters, missing characters or changing characters in places).  A smart keyboard must take these errors into account and predict the implied word quickly and accurately.  Essentially, we created a spatial model for Gboard that eliminates these character-level errors by matching touch points on the screen with actual keys. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c97/c76/526/c97c765265c8a651fd66a78bdf0ab787.gif"></div><br>  <font color="gray">Average trajectory for two spatially similar words: ‚ÄúVampire‚Äù and ‚ÄúValue‚Äù</font> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Until recently, Gboard used 1) Gaussian model to determine the probability of pressing adjacent keys;  2) a rule-based model for representing motor and cognitive error.  These models were simple and intuitive, but they did not allow directly optimizing the metrics that correlate with the best quality of the set.  Based on our experience with <a href="https://research.googleblog.com/2015/09/google-voice-search-faster-and-more.html">Voice Search acoustic models</a> , we replaced both the Gaussian model and the rule-based model with a single high-performance <a href="https://en.wikipedia.org/wiki/Long_short-term_memory">long-term short-term memory</a> model (LSTM) that was trained with the CTR criterion for <a href="">associative transient classification</a> . <br><br>  However, learning this model turned out to be much more difficult than we expected.  While acoustic models were trained in audio data with accompanying text prepared by a person, it was difficult to prepare accompanying text for millions of touch-tone sequences and finger trajectories on the keyboard.  So the developers used the interaction signals from the users themselves - corrected auto-corrections and hints choices - as negative and positive signals in teaching with partial involvement of the teacher (semi-supervised learning).  So extensive data sets for training and testing were formed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/850/b22/680/850b226800ea061752f75a2b8e3b2d36.png"><br>  <font color="gray">Source data points corresponding to the word ‚Äúcould‚Äù (left) and normalized selected trajectories with deviations in the sample (right)</font> <br><br>  The brute force method has tried many techniques from the literature on speech recognition on neural spatial models (NSM) to make them compact and fast enough to work on any device.  Hundreds of models were trained on the <a href="https://www.tensorflow.org/">TensorFlow</a> infrastructure, optimizing various signals from the keyboard: autocompletions, hints, touchscreen slides, etc. After more than a year of work, finished models have become about 6 times faster and 10 times more compact than the original versions.  They also reduced the number of incorrect autocorrections by about 15% and the number of incorrectly recognized gestures on offline datasets decreased by 10%. <br><br><h3>  Final converters </h3><br>  While NSM uses spatial information to help identify keystrokes or keystrokes, there are additional language restrictions ‚Äî <i>lexical</i> and <i>grammatical</i> ‚Äî that can be used.  Lexicon tells us which words exist in a language, and probabilistic grammar - which words can follow which others.  To encode this information, we used finite transducers (FST).  They have long been a key component of Google‚Äôs speech recognition and synthesis systems.  FSTs provide a fundamental way of representing various probabilistic models (lexicons, grammars, normalizers, etc.) from natural language processing, as well as the mathematical framework necessary for influencing, optimizing, combining, and searching for models <a href="https://habr.com/ru/post/329884/">*</a> <a name="1_1"></a>  . <br><br>  In Gboard, the character-to-word converter is a compact keyboard lexicon, as shown in the illustration below.  It encodes ways to convert key sequences to words, allowing for alternative key sequences and arbitrary spaces. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a9c/09d/ae1/a9c09dae1da4ba23b6642986df235056.png"></div><br>  <font color="gray">The converter encodes ‚ÄúI‚Äù, ‚ÄúI've‚Äù, ‚ÄúIf‚Äù along trajectories from the initial state (bold circle with the designation ‚Äú1‚Äù) to the final states (circles in a double contour with the designations ‚Äú0‚Äù and ‚Äú1‚Äù).</font>  <font color="gray">Each arc is labeled with the key's input value (before the colon) and the corresponding result word (after the colon), where Œµ denotes an empty character.</font>  <font color="gray">The apostrophe in ‚ÄúI've‚Äù can be omitted.</font>  <font color="gray">The user can sometimes miss the space.</font>  <font color="gray">To take this into account, in the converter, the space between words is optional.</font>  <font color="gray">The Œµ character and backward arcs allow more than one word.</font> <br><br>  A n-gram probabilistic converter is used to represent the language model for the keyboard.  The state in the model represents (up to) n-1 vocabulary context.  The arc going out of this state is marked with the winning word and the probability with which it follows this context (based on textual data).  In combination with the spatial model, which gives the probabilities of sequences of keystrokes on the keys (discrete values ‚Äã‚Äãin the case of individual keystrokes or continuous gestures in a sliding set), this model is used in <a href="https://en.wikipedia.org/wiki/Beam_search">the ray search algorithm</a> . <br><br>  The general principles of FST - streaming, support for dynamic models and others - made it possible to make significant progress in developing a new keyboard decoder.  But it was necessary to add a few additional features.  When you speak out loud, you do not need a decoder to guess the end of a word or the next word - and save a few syllables in speech;  but when you type, help in autocompletions and predictions will be very helpful.  We also wanted the keyboard to provide organic multilingual support, as shown below. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4dc/a1d/e64/4dca1de6479b190685012999678b7b1b.gif"><br>  <font color="gray">Trilingual set in Gboard.</font> <br><br>  It took complex efforts to make the new decoder work, but the fundamental nature of the final converters has many advantages.  For example, transliteration support for languages ‚Äã‚Äãlike Hindi is a simple extension to the basic decoder. <br><br><h3>  Transliteration models </h3><br>  In many languages ‚Äã‚Äãwith complex alphabets, romanization systems have been developed to display characters in the Latin alphabet, often in accordance with their phonetic pronunciations.  For example, the pinyin ‚Äúxixixi‚Äù corresponds to the Chinese characters ‚ÄúË∞¢Ë∞¢‚Äù (‚Äúthank you‚Äù).  Pinyin keyboard allows you to conveniently type words in the QWERTY layout and automatically "translate" them into the desired alphabet.  In the same way, a Hindi keyboard allows you to type ‚Äúdaanth‚Äù for the word ‚Äú‡§¶‡§æ‡§Ç‡§§‚Äù (‚Äútooth‚Äù).  While pinyin have a common romanization system, Hindi transliteration is not so clear.  For example, ‚Äúdaant‚Äù would also be a valid alternative for ‚Äú‡§¶‡§æ‡§Ç‡§§‚Äù. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/55c/9df/68e/55c9df68e70b45743d66aa88d28e4e4c.gif"><br>  <font color="gray">Transliteration of sliding input in Hindi</font> <br><br>  When we had a converter that converts sequences of letters into words (lexicon) and an automatic weighted language model for sequences of words, we developed a weighted converter for converting 22 Indian languages ‚Äã‚Äãbetween Latin character sequences and alphabets.  Some languages ‚Äã‚Äãhave several scripts (for example, the Baudaux language can be written in Bengali or in devangari), so we have created 57 input methods in just a few months between transliteration and native writing. <br><br>  The universal nature of the FST decoder allowed us to use all the work done earlier to support autocompletions, predictions, sliding sets and many UI functions without any additional effort, so that our Indian users from the very beginning received an excellent quality program. <br><br><h3>  Smarter keyboard </h3><br>  In general, our last job reduced the decoding delay by 50%, reduced the proportion of words that users had to correct manually by 10%, enabled transliteration for the 22 official languages ‚Äã‚Äãof India, and led to the emergence of many new features that you might notice. <br><br>  We hope that the latest changes will help you type the text on the keyboard of your mobile device.  But we understand that this task is by no means solved.  Gboard can still make assumptions that seem strange or of little help, and gestures can be recognized in words that a person would never type.  However, our transition to powerful algorithms for machine intelligence opens up new possibilities that we are actively exploring in order to create more useful tools and products for our users around the world. <br><br><h3>  Thanks </h3><br>  This work was done by Cyril Allausen, Wise Alsharif, Lars Hellsten, Tom Ouyan, Brian Roark and David Rybach, with the assistance of the group Speech Data Operation.  Special thanks to Johan Shalkvik and Corinne Cortes for their help. <br><br><a name="1"></a>  * A set of relevant algorithms is available in the free <a href="http://www.openfst.org/">OpenFst</a> library.  <a href="https://habr.com/ru/post/329884/">‚Üë</a> </div><p>Source: <a href="https://habr.com/ru/post/329884/">https://habr.com/ru/post/329884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329874/index.html">Fifth generation of HPE MSA storage: twice the performance for the same price</a></li>
<li><a href="../329876/index.html">Limit the speed of processing requests in nginx</a></li>
<li><a href="../329878/index.html">The largest Git repository in the world</a></li>
<li><a href="../329880/index.html">JaCarta PKI and OpenVPN for Windows</a></li>
<li><a href="../329882/index.html">9 reasons that prevent you from becoming a timlid</a></li>
<li><a href="../329886/index.html">Delegates and Lambda Expressions in C # .Net - Cheat Sheet or Briefly</a></li>
<li><a href="../329888/index.html">ACM ICPC 2017: Final Results</a></li>
<li><a href="../329890/index.html">PHDays VII: Confrontation Chronicles</a></li>
<li><a href="../329892/index.html">What are women talking about? (Text mining of beauty blogs)</a></li>
<li><a href="../329894/index.html">Reactive Stream Log Processing with RxJava - Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>