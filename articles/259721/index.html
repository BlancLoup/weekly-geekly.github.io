<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SIP phone from stm32f4-discovery</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. 
 In this article I will tell you how we made a sip-phone based on stm32f4-discovery using our embedded OS Embox . The characteristics of stm32...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SIP phone from stm32f4-discovery</h1><div class="post__text post__text-html js-mediator-article">  Hello. <br>  In this article I will tell you how we made a sip-phone based on stm32f4-discovery using our embedded OS <a href="http://embox.github.io/">Embox</a> .  The characteristics of stm32f4-discovery (144MHz, 192Kb RAM, 1Mb ROM) may raise doubts about the possibility of such an implementation.  We wondered if it would work out.  As an answer, you can watch the video, and in the article itself - technical details. <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/y2Eg_zwuI7M%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjRNOwqsLYj5Wh0QDz_65IkEbsFJg" frameborder="0" allowfullscreen=""></iframe><br><br><a name="habracut"></a><br><h2>  How it works </h2><br>  The software of this device consists of a PJSIP soft-phone and the already mentioned Embox OS.  PJSIP is responsible for sip protocol support, audio decoding.  Embox provides the PJSIP standard library, pthread library, network stack, audio output drivers, and the rest of the OS features.  For this, a POSIX interface is used, which makes it possible to transfer a wide class of applications from unix-like operating systems to embedded systems with virtually no changes.  Transferring PJSIP to OS Embox was expectedly easy, but with the launch of PJSIP on a specific hardware platform, there were some difficulties.  About them - next. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who want to repeat our success, we have prepared a small instruction.  You will need stm32f4discovery + stm32dis-bb, a com-port connection to it (on the expansion card), a host with Linux, an ethernet connection between the card and the host. <br><br>  You need to take <a href="https://github.com/embox/pjsip">github.com/embox/pjsip</a> and go to this directory.  Here are the build scripts, applications and files that we used to prepare for the demonstration. <br><br>  The first simple step is to launch Embox on discovery.  We use ELF as the image format. <br>  You can take a pre-assembled image, the embox file. <br>  Or you can build Embox yourself.  For this: <br><ul><li>  clone <a href="https://github.com/embox/embox">github.com/embox/embox</a> <br></li><li>  upload the correct configs by running <br><pre><code class="bash hljs">make confload-platform/pjsip/stm32f4discovery</code> </pre> <br></li><li>  collect by doing <br><pre> <code class="bash hljs">make</code> </pre><br></li><li>  target image is on the build / base / bin / embox path </li></ul><br>  After the firmware, you need to connect via the serial port to the discovery, connect the terminal emulator, set the settings to 115200 8n1.  After launch, the system will display some status information, display and execute commands of the launch script, and provide a shell interface.  Further it is supposed that all commands need to be executed in the discovery console. <br><ul><li>  If the default IP address does not suit you, you should execute <br><pre> <code class="bash hljs">route del 192.168.1.0 dev eth0 ifconfig eth0 (ip-) netmask () up<span class="hljs-string"><span class="hljs-string">" route add () netmask () eth0</span></span></code> </pre><br></li><li>  run pjsip_simpleua </li></ul><br>  Next, you need to build and run the host client.  We return to the console on the host. <br><ul><li>  Download <a href="">www.pjsip.org/release/2.4/pjproject-2.4.tar.bz2</a> and put in the current directory (pjsip) </li><li>  to build the PJSIP host library, command <br><pre> <code class="bash hljs">./build_pjproject.sh</code> </pre><br></li><li>  In order to build directly the host client, command <br><pre> <code class="bash hljs">make</code> </pre><br></li><li>  run <br><pre> <code class="bash hljs">simpleua sip:<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>@(ip- )</code> </pre><br></li></ul><br><h2>  Why is this? </h2><br>  We really wanted to do something unusual on a regular embedded platform.  It was clear that the platform should be very popular and cheap, so we chose stm32f4-discovery - not an 8-bit controller, but not a gigahertz RaspberryPi or Beaglebone.  They began to look at the discovery: in addition to ethernet, we noticed the possibility of sound output. <br><br>  And then the stars came together: colleagues "on the shop floor" developed a sip-phone on OMAP137 with Linux.  And to write a special software there was some kind of anguish: bitbake, who for a minute thinks about what and how to collect, recommendations to clean the project for any reason, and the first build takes about several hours. <br><br>  Therefore, we have arranged for ourselves a challenge: a SIP-device, which is most similar in functionality to the phone, on a significantly weaker hardware. <br><br>  An additional point in this section was the <a href="https://habrahabr.ru/users/indemsys/" class="user_link">Indemsys</a> <a href="http://habrahabr.ru/company/embox/blog/255835/">comment</a> , in which he asked about software, which is only on Linux and not on the controllers (bare metal or classic RTOS). <br><br><h2>  Training </h2><br>  The first stage is the choice of third-party software to support sip-protocol and accompanying audio transmission.  The first in the results of issuing google was <a href="http://www.pjsip.org/">www.pjsip.org</a> , which knows everything it <a href="http://www.pjsip.org/">needs</a> , allows processing with an ax and a file on a large scale, is portable and has low requirements for the amount of RAM (150kb claimed). <br><br>  First you need to create the assembly description files.  For those who hear about Embox for the first time: we use our own build system ( <a href="http://habrahabr.ru/company/embox/blog/144935/">article on Habr√©</a> ), which operates with the concept of ‚Äúmodule‚Äù.  To facilitate the assembly of third-party software, we have introduced an extension that supports automatic downloading, application of patches, configuration, assembly and installation. <br><br>  The PJSIP library will be just a module.  The first <a href="https://github.com/embox/embox/commit/f6a2bd46ba9496e8c1bb60bec226c4710dadbe7c">commit commit</a> on this topic.  Here you can evaluate how the assembly description differs from the assembly for the host system <s>(in any way)</s> and what modifications are needed in PJSIP: disable positive applications for simplicity;  We report about absence of SOCK_RDM. <br><br>  In the future, these files certainly changed, but the basis remained the same.  Additionally, macro values ‚Äã‚Äãwere needed to reduce the amount of structures in memory, disable codecs, etc.  The modern look of the descriptions can be estimated under the spoiler. <br><div class="spoiler">  <b class="spoiler_title">PJSIP Modules</b> <div class="spoiler_text"><pre> <code class="bash hljs">package third_party.pjproject @Build(stage=2,script=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(EXTERNAL_MAKE)</span></span></span><span class="hljs-string">"</span></span>) @BuildDepends(third_party.STLport.core) module core { depends embox.net.lib.getifaddrs depends embox.compat.posix.pthreads depends embox.compat.posix.pthread_key depends embox.compat.posix.pthread_rwlock depends embox.compat.posix.semaphore depends embox.compat.posix.fs.fsop depends embox.compat.posix.idx.select depends embox.compat.posix.net.getaddrinfo depends embox.compat.posix.net.gethostbyname depends embox.compat.posix.util.gethostname depends embox.compat.posix.proc.pid depends embox.compat.posix.proc.exit depends embox.compat.libc.stdio.fseek depends embox.compat.libc.time depends third_party.STLport.core } @AutoCmd @Cmd(name=<span class="hljs-string"><span class="hljs-string">"streamutil"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span>, man=<span class="hljs-string"><span class="hljs-string">""</span></span>) @BuildDepends(core) @Build(stage=2,script=<span class="hljs-string"><span class="hljs-string">"true"</span></span>) module streamutil { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"^BUILD/extbld/third_party/pjproject/core/install/streamutil.o"</span></span> depends core } @AutoCmd @Cmd(name=<span class="hljs-string"><span class="hljs-string">"pjsua"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span>, man=<span class="hljs-string"><span class="hljs-string">""</span></span>) @BuildDepends(core) @Build(stage=2,script=<span class="hljs-string"><span class="hljs-string">"true"</span></span>) module pjsua { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"^BUILD/extbld/third_party/pjproject/core/install/pjsua.o"</span></span> depends core } @AutoCmd @Cmd(name=<span class="hljs-string"><span class="hljs-string">"pjsip_simpleua"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>=<span class="hljs-string"><span class="hljs-string">""</span></span>, man=<span class="hljs-string"><span class="hljs-string">""</span></span>) @BuildDepends(core) @Build(stage=2,script=<span class="hljs-string"><span class="hljs-string">"true"</span></span>) module simpleua { <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> <span class="hljs-string"><span class="hljs-string">"^BUILD/extbld/third_party/pjproject/core/install/simpleua.o"</span></span> depends core }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">PJSIP Build Description</b> <div class="spoiler_text"><pre> <code class="bash hljs">PKG_NAME := pjproject PKG_VER := 2.2.1 PKG_SOURCES := http://www.pjsip.org/release/$(PKG_VER)/$(PKG_NAME)-$(PKG_VER).tar.bz2 PKG_MD5 := 6ed4bb7750c827dc1d881e209a3b62db include $(EXTBLD_LIB) PKG_PATCHES := pjproject.patch \ simpleua_default_loglevel.patch \ mutex_loglevel_increase.patch \ kmalloc.patch DISABLE_FEATURES := \ l16-codec \ ilbc-codec \ speex-codec \ speex-aec \ gsm-codec \ g722-codec \ g7221-codec \ <span class="hljs-comment"><span class="hljs-comment">#g711-codec PJPROJECT_ROOT := $(ROOT_DIR)/third-party/pjproject PJSIP_CPPFLAGS := -I$(PJPROJECT_ROOT)/include $(EMBOX_DEPS_CPPFLAGS) -I$(SRC_DIR)/compat/cxx/include BUILD_ROOT := $(BUILD_DIR)/$(PKG_NAME)-$(PKG_VER) $(CONFIGURE) : export EMBOX_GCC_LINK=full; \ cd $(BUILD_ROOT) &amp;&amp; ( \ ./aconfigure \ CC=$(EMBOX_GCC) \ CXX=$(EMBOX_GXX) \ CPPFLAGS="$(PJSIP_CPPFLAGS)" \ --host=$(AUTOCONF_TARGET_TRIPLET) \ --target=$(AUTOCONF_TARGET_TRIPLET) \ --prefix=/ \ $(DISABLE_FEATURES:%=--disable-%) \ --with-external-pa; \ echo export CFLAGS+="$(PJSIP_CPPFLAGS)" &gt; user.mak; \ echo export CXXFLAGS+="$(PJSIP_CPPFLAGS)" &gt;&gt; user.mak; \ ) cp ./config_site.h $(BUILD_ROOT)/pjlib/include/pj/config_site.h touch $@ $(BUILD) : cd $(BUILD_ROOT) &amp;&amp; ( \ make -j1 dep; \ make -j1 MAKEFLAGS='$(EMBOX_IMPORTED_MAKEFLAGS)'; \ ) touch $@ $(INSTALL) : for f in $(BUILD_ROOT)/pjsip-apps/bin/samples/$(AUTOCONF_TARGET_TRIPLET)/*; do \ cp $$f $(PKG_INSTALL_DIR)/$$(basename $$f).o; \ done for f in $(BUILD_ROOT)/pjsip-apps/bin/*-$(AUTOCONF_TARGET_TRIPLET); do \ fn=$$(basename $$f); \ cp $$f $(PKG_INSTALL_DIR)/$${fn%-$(AUTOCONF_TARGET_TRIPLET)}.o; \ done touch $@</span></span></code> </pre><br></div></div><br><h2>  Sound </h2><br>  For the demonstration, we initially used an example called streamutil, which can transmit only the media stream. <br><br>  After we added the build scripts and waved the file a bit, streamutil began to stop with a message about the missing device for sound output.  There was no need to play from scratch, the manufacturer delivers demo applications for playing wav files from a flash drive.  This code served as the basis for future implementation. <br><br>  On the other hand, there was the question of which interface will be used for interaction: you can develop a sound plugin for PJSIP or use one of the existing ones for popular sound APIs.  Among them was portaudio, noticeably simpler than, for example, the ALSA API.  We have started implementing a driver with this interface. <br><br>  In a nutshell, the interface is described as follows: register a callback, which will be called when necessary, when the sound card's buffer is close to empty.  The remarkable simple API does not regulate the context in which the callback will be invoked, and in real systems a separate thread is started for this, which sleeps most of the time and performs the callback at the right time. <br><br>  With such a scheme, problems like ‚Äúleaky abstraction‚Äù arise: PJSIP clearly implies a separate stream.  Attempts to call a callback on a signal led to a deadlock.  It was necessary to do both in ‚Äúadult‚Äù systems, with streams.  At the end of this stage, the driver began to look like <a href="">this</a> . <br><br>  In the future, we are going, if possible, to abandon the use of conventional streams in favor of <a href="http://habrahabr.ru/company/embox/blog/256565">light streams</a> .  The main difference of a light thread is the absence of its own stack, calculations are performed on the stack of the last thread executed.  For easy streams, a pthread-compatible interface with available synchronization tools is provided.  In theory, this will allow them to be used as an implementation of a portaudio stream, and thereby reduce memory consumption. <br><br><h2>  Lack of memory </h2><br>  The main problem we were struggling with was a lack of dynamic memory. <br><br>  Here we need to make a remark about the dynamic selection in our system.  We use pool'y - reserved areas of static memory for a fixed number of objects of a fixed size.  The method is not the most flexible and sometimes makes writing some amount of boilerplate code, but in return we can control the memory consumption and catch the potential memory shortage at the compilation stage.  In fact, configuring pool sizes is much easier than it might seem. <br><br>  First, they are set in the global configuration file, where all other system parameters are described, such as: subsystems, commands, control policies, for example, the scheduler.  The size of this file rarely exceeds 100 lines, although this number can strongly depend on the composition of the system. <br><br>  Secondly, pool sizes are often the result of natural requirements, for example, in our stm32f4discovery there can be only 2 network adapters: onboard ethernet and loopback.  Surprisingly, this certainty can be observed in other subsystems: the number of open files, the scheduler priorities, the number of irq handlers, and much more ‚Äî all this can be easily analyzed in an embedded system. <br><br>  Returning to PJSIP, it uses its own library for dynamic memory allocation, which, in turn, is implemented over standard malloc / free calls.  Predicting the need for streamtuil in the amount of dynamic memory is quite difficult.  But since the entire heap is exclusively used by streamutil, we can control its size and expand it with system pools. <br><br>  One of the biggest pools in the system was the network packet buffer.  Here I made a small hack: I changed the maximum packet size from standard 1514 bytes to 214, but I increased the maximum number of packets.  The fact is that testing has shown: no more than 214 bytes go to / from streamutil, so this trick worked. <br><br>  It took us several iterations of the heap increase, but after them the streamutil began to produce a clear sound. <br><br><h2>  Sip phone </h2><br>  It is clear that streamutil is a demo application, a little like the desired phone.  It was necessary to take something more functional.  A good candidate is pjsua, the reference sip-phone on PJSIP.  Modified build scripts, started to run.  Not enough memory.  Okay, they've gotten pool sizes even tighter.  Not enough memory.  Here we began to torment vague doubts, and is it possible in principle to satisfy the requests of pjsua? <br><br>  The first attempt to find out was to trace pjsua requests to malloc / free on the host.  But, it turned out, the standard library is too actively using dynamic allocation for its own needs (for example, formatting a date into a string), so the trace output was heavily cluttered. <br><br>  We went another way: in our standard library we do not use malloc / free, so the track will be much more informative.  We added a trace to the memory allocation library, then we assembled the embox with pjsua for beagleboard and ran it on qemu.  The results we were somewhat upset, it turned out a little more than 200kb only on a heap, without taking into account the fragmentation and static memory of pjsua.  Such a volume in stm32f4 does not fit.  There were two possible ways out: to seriously modify pjsua, or to look for an easier alternative. <br><br>  Fortunately, there was an alternative - the simpleua demo application.  Tracing dynamic allocation simpleua showed the maximum size of a live heap of about 110kb.  If you add up with .data (~ 4kb) and .bss (~ 25kb), then there is enough space for the main stack and threads, the network packet buffer and the audio interface. <br><br>  During the implementation, we had to add support for several regions of memory for the heap, increase the packet size (810 bytes are required) and reduce their number. <br><br>  The result you saw on the video. <br><br><h2>  Conclusion </h2><br>  The article was written immediately after a successful launch.  We did not have time to catch possible bugs, so if you meet them, you are warned.  But seriously, we will welcome any feedback and comments.  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/259721/">https://habr.com/ru/post/259721/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259691/index.html">Battle "Listener vs Visitor" at the stadium antlr4</a></li>
<li><a href="../259701/index.html">Vim in full: Introduction</a></li>
<li><a href="../259709/index.html">Port i2cdevlib on STM32 HAL</a></li>
<li><a href="../259717/index.html">Start using GTKD</a></li>
<li><a href="../259719/index.html">OS Development on Go + asm Part 0x00</a></li>
<li><a href="../259723/index.html">How to create Pixel Perfect images in Adobe Illustrator</a></li>
<li><a href="../259725/index.html">Vim in full: Plugin Manager without fatal flaws</a></li>
<li><a href="../259727/index.html">Python and D</a></li>
<li><a href="../259729/index.html">SQL Server 2016 RC0</a></li>
<li><a href="../259737/index.html">Common Lisp IDE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>