<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Vacuuming IDEA Ultimate Code with Data Flow Analysis</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IntelliJ IDEA contains thousands of inspections for Java code. Most of them work as advanced regular expressions: according to a certain pattern, they...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Vacuuming IDEA Ultimate Code with Data Flow Analysis</h1><div class="post__text post__text-html js-mediator-article">  IntelliJ IDEA contains thousands of inspections for Java code.  Most of them work as advanced regular expressions: according to a certain pattern, they look for fragments of a program that look like typos, are redundant, ugly or may work slowly.  But there is an inspection of a completely different kind.  She has a somewhat strange name: "Constant conditions &amp; exceptions."  In fact, it performs the analysis of data streams in Java methods using the so-called ‚Äúsymbolic execution‚Äù.  As a result of this analysis, some suspicious facts may be revealed.  Here are some examples of such facts: <br><br><ul><li> Link dereferencing may result in a <code>NullPointerException</code> </li><li>  The condition is always true or false. </li><li>  The array index is always outside the range. </li><li>  Type <code>ClassCastException</code> may result in <code>ClassCastException</code> </li></ul><a name="habracut"></a><br>  These facts do not always indicate an error.  For example, sometimes you want to add a knowingly true condition for greater clarity of the code: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { ‚Ä¶ } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// : 'obj != null'   ‚Ä¶ }</span></span></code> </pre> <br>  However, often a warning from this inspection indicates a typo or says that the author of the code did not quite understand what he wrote.  And most importantly, this inspection is able to detect very strange errors that are not covered by any patterns.  Sometimes even we, the IDE authors, are surprised to look at the code in which the ‚ÄúConstant conditions &amp; exceptions‚Äù inspection worked. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Over the years, inspection has improved steadily.  Previously, it was mainly responsible for possible problems with null and type mismatch.  Later, it appeared to analyze the presence of a value in Optional, the analysis of integer ranges, and the analysis of the boundaries of arrays.  In the previous major release of 2017.3, we improved the analysis of integer ranges and added basic support for the Stream API and Optional chains. <br><br>  Every inspection improvement is the first thing we test on the IDEA Ultimate code.  This is a major project containing tens of thousands of classes that have been written for the second decade.  Not less than a hundred developers with different levels of knowledge and style had a hand in the code.  Therefore, it is always interesting to drive out ‚ÄúConstant conditions &amp; exceptions‚Äù and discover a new bug in the ancient class.  Let's see what the new inspection found after the improvements made for the upcoming release. <br><br>  One of the most interesting analysis improvements in 2018.1 is the tracking of the relationships between variables.  Previously, the inspection monitored only equality and inequality of variables.  For example, the condition <code>if(a == b &amp;&amp; a != b)</code> marked as always false.  When we began to track integer ranges, new warnings appeared in conditions like <code>if(a &gt; 0 &amp;&amp; a &lt;= 0)</code> , because the left part is true if the value of <code>a</code> lies in the range <code>[1..MAX_VALUE]</code> , and the right part - if range <code>[MIN_VALUE..0]</code> , and these ranges do not overlap.  However, until now there has been no warning on the condition <code>if(a &gt; b &amp;&amp; a &lt;= b)</code> , because here we do not know anything about ranges.  Now we are watching which value is greater, even if they are both unknown, so in 2018.1 this condition will also be highlighted.  It seems that the programmer himself will certainly notice such a trivial error, but do not forget that the analysis of data streams is not just looking for patterns. <br><br>  First, he also easily finds the opposite case.  And such an error was really revealed in our code for processing SQL tables: <br><br><img src="https://habrastorage.org/webt/i5/dz/b5/i5dzb5jfubzzoor3tm4stipcib4.png" alt="idx &amp; lt; myAncestorRefs.length || idx &amp; gt; = myAncestorRefs.length"><br><br>  Yes, the method begins with a condition that is always true, and therefore always returns an empty list, because the value of the <code>idx</code> variable is either less than the length of the <code>myAncestorRefs</code> array, or greater than or equal to it.  The next ten lines of code are never executed.  Obviously there is a typo: I mean <code>idx &lt; 0</code> instead of <code>idx &lt; myAncestorRefs.length</code> . <br><br>  By the way, about the length of the array.  A pleasant surprise turned out to be that this feature made friends with the existing checks of the lengths of the arrays.  We did not expect to find any errors like this one found in the Groovy plugin: <br><br><img src="https://habrastorage.org/webt/kp/88/h7/kp88h7zvtx9ymrfbugi-lopg-a0.png" alt="if (initializers.length &amp; lt; i) return initializers [i];"><br><br>  Now, when reading the array element, the inspection already knows that <code>i</code> in a given place is always greater than the number of elements in <code>initializers</code> .  Therefore, an <code>ArrayIndexOutOfBoundsException</code> exception <code>ArrayIndexOutOfBoundsException</code> unavoidable if the condition is ever met.  I think, in fact, it has never been executed, otherwise the exception would have been noticed.  Of course the condition was turned over by mistake. <br><br>  Another problem related to the array boundaries was found in the code of a single Java inspection, which handles catch blocks: <br><br><img src="https://habrastorage.org/webt/ly/xb/68/lyxb684mdarg147d2qo9n1mldyc.png" alt="while (catchSections [index]! = catchSection &amp; amp; &amp; amp; index &amp; lt; catchSections.length)"><br><br>  As you can see, the border of <code>index</code> values ‚Äã‚Äãis checked after this variable is used to access an array element.  The condition cannot be false: if it is false, then we would have already flown out of this code with an <code>ArrayIndexOutOfBoundsException</code> . <br><br>  In the new version, we sometimes track the values ‚Äã‚Äãfrom the array initializers.  This allowed us to detect redundant code like this: <br><br><img src="https://habrastorage.org/webt/0m/ug/hh/0mughhl2g7fxst1g0pbn8l1nwu4.png" alt="boolean [] result = new boolean [] {false}; &amp; lt; ... &amp; gt; if (result [0])"><br><br>  A long time ago, the single-element array <code>result</code> used inside the <code>command</code> lambda to fix the need to activate the editor.  Over time, the activation of the editor was no longer needed, but not a single existing inspection department noticed that the condition was redundant.  Now we see it. <br><br>  Now we think that Boolean methods without arguments, whose name starts with ‚Äúis‚Äù, return the same result if they were called twice with the same qualifier.  Yes, this is a heuristic, it is not necessarily true.  But if it caused a false positive in your code, think about it.  Perhaps this is a sign that the code is difficult to understand, not only for the IDE, but also for your colleagues.  But such a heuristic allows you to find real bugs.  For example, such code was found when processing CSS selectors: <br><br><img src="https://habrastorage.org/webt/-u/ll/lr/-ulllrayaulhglrvbxhqmjzrt4a.png" alt="localSelectorElement = (CssSimpleSelector) localElement; remoteSelectorElement = (CssSimpleSelector) localSelectorElement; if (localSelectorElement.isUniversalSelector ()! = remoteSelectorElement.isUniversalSelector ()"><br><br>  Although the qualifiers here are different, the same value is assigned to them above.  Therefore, the analyzer assumes that <code>isUniversalSelector</code> will return the same result.  And indeed it is!  A typo is not in the condition, but the line above: there must be, of course, <code>remoteSelectorElement = (CssSimpleSelector)remoteSelectorElements[j]</code> . <br><br>  Also in 2018.1, the inspectorate issues a new warning.  If a variable is assigned a value, and it has always had the same value in this place, we highlight it.  Again, this is not always an error, but the assignment is obviously redundant.  Real errors with this warning were also found.  For example, this is a unit test fragment checking HTML formatting: <br><br><img src="https://habrastorage.org/webt/s6/2v/zz/s62vzzw9pt6ccmpl8s6bxw4hsje.png" alt="int indentSize = htmlIndentOptions.INDENT_SIZE = 2;"><br><br>  The problem is three lines above the warning: there should not be ‚Äú <code>= 2</code> ‚Äù at the end.  As a result, the indent size is not restored after the test, as expected. <br><br>  This warning also revealed duplicates in the initialization chains of fields or array elements: <br><br><img src="https://habrastorage.org/webt/xz/0h/cm/xz0hcm_u2vqm5fopzjxehh2zc0w.png" alt="defaults [CONSTANT_Int] = ints; ... defaults [CONSTANT_Int] = ints;"><br><br>  Perhaps this line is simply redundant, but maybe something else was meant.  Anyway, this is obviously a mistake. <br><br>  A slight improvement in the processing of <code>this</code> revealed an error in the code processing tabbed controls: <br><br><img src="https://habrastorage.org/webt/pj/ji/y1/pjjiy1vbmwxcpyxzwaz8jqpqtim.png" alt="while (component! = this || component! = null)"><br><br>  If the left side is true, then the right one is not checked.  If the left is false, then the <code>component</code> is equal to <code>this</code> , and <code>this</code> is not exactly null, so the <code>component</code> not null.  Therefore, the whole condition is always true.  A very common mistake when using <code>||</code>  instead of <code>&amp;&amp;</code> or vice versa. <br><br>  Finally, we improved the handling of the Stream API.  In particular, it now works for unfinished chains (that is, not ending with a terminal operation).  This improvement did not reveal any errors in our code, but there were some redundant checks.  For example, such a method is available in processing code coverage results: <br><br><img src="https://habrastorage.org/webt/kh/qk/vk/khqkvk4k8cexpyv7fyq1unkd1n8.png" alt="mapToObj (idx - &amp; gt; Pair.create (...)). filter ((x) - &amp; gt; x! = null &amp; amp; &amp; amp; ...)); interesting, and the blind read this article? I am writing alternative text to all the pictures here, is there any benefit from this or not?"><br><br>  The <code>Pair.create</code> annotation <a href="http://blog.jetbrains.com/idea/2014/10/automatic-notnullnullablecontract-inference-in-intellij-idea-14/">is automatically output for the</a> <code>@NotNull</code> , so the <code>x != null</code> condition is redundant.  The inspectorate is aware that <code>x</code> has the same meaning that the previous lambda returned. <br><br>  The ‚ÄúConstant conditions &amp; exceptions‚Äù inspection surprisingly often finds mistakes that have been hidden in large projects for years.  It helps even more when you write new, untested code.  At first, some of the warnings of this inspection can be annoying, but over time you understand how to live together with them. <br><br>  We have already <a href="http://blog.jetbrains.com/idea/2018/01/intellij-idea-starts-2018-1-early-access-program/">started the EAP-program 2018.1</a> , so you can experience new features right now.  This inspection is constantly improving, the false gains disappear and useful ones are added.  We still have many ideas that can be improved in it, so stay tuned. </div><p>Source: <a href="https://habr.com/ru/post/347410/">https://habr.com/ru/post/347410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347400/index.html">Security Week 1: Witnesses do not steal, old deep exploits, Google Play against swinishness</a></li>
<li><a href="../347402/index.html">How can a beginner contribute to an open source project with 20K stars?</a></li>
<li><a href="../347404/index.html">Scrum implementation by techie: real experience, pitfalls, tips & tricks</a></li>
<li><a href="../347406/index.html">Python for teaching science informatics: Simulating Queuing Systems</a></li>
<li><a href="../347408/index.html">As we ivi rewrote etl: Flink + Kafka + ClickHouse</a></li>
<li><a href="../347412/index.html">Method for analyzing multichannel user interaction</a></li>
<li><a href="../347418/index.html">Intel warns users about the "malfunction" of Specter-Meltdown patches</a></li>
<li><a href="../347420/index.html">DevFest North in St. Petersburg. How it was</a></li>
<li><a href="../347422/index.html">Linux-2018: the most promising distributions</a></li>
<li><a href="../347424/index.html">UI, which itself teaches the player control</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>