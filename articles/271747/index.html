<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk: Prioritizing VoIP traffic and reserving Internet access from two providers on MikroTik</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It would seem that the things in the title are quite trivial and described in many places on the global network, but this is only at first glance. Hav...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk: Prioritizing VoIP traffic and reserving Internet access from two providers on MikroTik</h1><div class="post__text post__text-html js-mediator-article">  It would seem that the things in the title are quite trivial and described in many places on the global network, but this is only at first glance.  Having tried the most common advice, I found several ‚Äúpitfalls‚Äù, boulders and even rock formations. <br><br>  But these are all words, more to the point. <br>  A fairly common situation is Asterisk inside the LKS, behind the MikroTik router. <br>  In order to allocate traffic to the server where the PBX is installed, the administrator cuts off part of the provider's channel, allocating it exclusively for a specific IP. <br>  Or another implementation, when the necessary traffic is determined not only by the IP address of the PBX, but also by the packet size and protocol. <br>  Tried - it works.  Can I forget?  And no. <br><br>  What if the administrator wants to merge something from the Internet while in the server console, or vice versa, send a large amount of traffic to the Internet somewhere?  That's right - it is prioritized on MikroTik as well as the useful traffic from the PBX, which ultimately leads to problems with IP-telephony. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The solution here is as old as IPv4 itself - mark traffic on the server with Asterisk generated only by it, and so that MikroTik can ‚Äúsee‚Äù, kick off (sorry for such rude anglicism) and prioritize only it. <br><br>  The next item we have is reservation of channels from two Internet providers. <br>  I think that every system administrator who uses MikroTik routers on his farm is familiar with the script from the wiki - <a href="http://wiki.mikrotik.com/wiki/Failover_Scripting">wiki.mikrotik.com/wiki/Failover_Scripting</a> <br>  He is all good, but as in the previous situation there is a number of ‚Äúbuts‚Äù. <br>  The most significant of them is the name ‚ÄúConnection tracking‚Äù and it is this: <br>  when our main ISP deigns to rest from the works of the righteous, traffic switches to backup. <br><br>  Everyone seems to be happy, YouTube works, yap, too, but no matter how much we shout to the <s>expo</s> <br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sip</span></span> reload</code> </pre> <br>  and in desperation they did not try to use higher order magic <br><pre> <code class="hljs pgsql">core <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> now</code> </pre> <br>  SIP registrations do not rise. <br><br>  But the fact is that the records from the ‚Äúold‚Äù (main) Internet channel remained in the ‚ÄúConnection tracking‚Äù mechanism and need to be removed, after which the registrations will successfully rise and the calls will start to pass. <br><br>  If you are interested in how to prove to MikroTik who is still a camel, and also how to automate the reset of "old" connections in the script, then you are right under the cat. <br><a name="habracut"></a><br><br><h3>  Part 1. Proper prioritization of VoIP traffic. </h3><br>  From the very talkative introduction let's move on to the practical part. <br>  How to mark traffic so that MikroTik will recognize this tag? <br>  The answer is simple - DSCP! <br>  OK, but what about the traffic of a particular daemon, in this case Asterisk? <br>  And here without problems, sir (madam) - iptables --uid-owner! <br><br>  On the server with PBX, we will find out what user id our Asterisk has (asterisk is it) <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> -i asterisk /etc/passwd|cut -d: -f3 <span class="hljs-number"><span class="hljs-number">1001</span></span></code> </pre><br><br>  And we will add a rule to specify the DSCP value we need (for VoIP traffic, it is customary to specify CS5, or, in the numeric format, 40) <br>  comment from <a href="http://habrahabr.ru/users/ksg222/" class="user_link">ksg222</a> <br><blockquote>  I would like to note that usually voice traffic is ‚Äúpainted‚Äù with two DSCP values: CS5 (CS3 in the case of Cisco) for signaling and EF for RTP traffic.  Of course, in your example, this is not critical, since your main point in the configuration is to distinguish voice traffic from the rest.  Anyway, there will be no further prioritization of the DSCP field on the Internet. <br><br>  tools.ietf.org/html/rfc4594#section-2.3 <br><br>  <a href="http://www.cisco.com/c/en/us/td/docs/solutions/Enterprise/WAN_and_MAN/QoS_SRND/QoS-SRND-Book/QoSIntro.html">www.cisco.com/c/en/us/td/docs/solutions/Enterprise/WAN_and_MAN/QoS_SRND/QoS-SRND-Book/QoSIntro.html#pgfId-46256</a> <br><br></blockquote><br><pre> <code class="hljs pgsql">iptables -I OUTPUT <span class="hljs-number"><span class="hljs-number">1</span></span> -t mangle -m <span class="hljs-keyword"><span class="hljs-keyword">owner</span></span> <span class="hljs-comment"><span class="hljs-comment">--uid-owner 1001 -j DSCP --set-dscp 40</span></span></code> </pre><br>  <i>* for the curious - at the end of the article there will be links where you can find out where I got this from</i> <i><br></i> <br><br>  as suggested by <a href="http://habrahabr.ru/users/varnav/" class="user_link">varnav</a> in the comments, you can set the desired values ‚Äã‚Äãimmediately in sip.conf <br><blockquote>  And why put a DSCP tag through Iptables, if it can be done through sip.conf: <br><br>  tos_sip = cs3;  Sets TOS for SIP packets. <br>  tos_audio = ef;  Sets TOS for RTP audio packets. <br>  tos_video = af41;  Sets TOS for RTP video packets. <br></blockquote><br>  We will finish the sim on the server with IP PBX and proceed to the configuration of the router. <br>  I took this material as a basis - <a href="http://voxlink.ru/kb/voip-devices-configuration/mikrotik-voip-traffic-configuration/">voxlink.ru/kb/voip-devices-configuration/mikrotik-voip-traffic-configuration</a> <br>  I will not repost, everything is available there, I'll show only the listings. <br>  Table MANGLE firewall: <br><pre> <code class="hljs pgsql">/ip fm exp # nov/<span class="hljs-number"><span class="hljs-number">26</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> RouterOS <span class="hljs-number"><span class="hljs-number">6.21</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # software id = <span class="hljs-number"><span class="hljs-number">5</span></span>QIF-MH9A # /ip firewall mangle <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-packet chain=forward <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-packet-mark=def_out src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-packet chain=forward <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-packet-mark=def_out src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-packet chain=forward dst-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-packet-mark=def_in <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-packet chain=forward dst-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-packet-mark=def_in <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-packet chain=forward dscp=<span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-packet-mark=voip_out src-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> action=mark-packet chain=forward dscp=<span class="hljs-number"><span class="hljs-number">40</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>-packet-mark=voip_in</code> </pre><br>  As described in the introduction - match the necessary traffic over IP and across the DSCP field. <br><br>  And queues: <br><pre> <code class="hljs pgsql">/queue tree export # nov/<span class="hljs-number"><span class="hljs-number">26</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> RouterOS <span class="hljs-number"><span class="hljs-number">6.21</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # software id = <span class="hljs-number"><span class="hljs-number">5</span></span>QIF-MH9A # /queue tree <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> max-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=<span class="hljs-number"><span class="hljs-number">30</span></span>M <span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parent=<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> max-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=<span class="hljs-number"><span class="hljs-number">28</span></span>M <span class="hljs-type"><span class="hljs-type">name</span></span>=def-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> packet-mark=def_in parent=<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>-at=<span class="hljs-number"><span class="hljs-number">1</span></span>M max-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=<span class="hljs-number"><span class="hljs-number">2</span></span>M <span class="hljs-type"><span class="hljs-type">name</span></span>=voip-<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> packet-mark=voip_in parent=<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> priority=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> max-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=<span class="hljs-number"><span class="hljs-number">30</span></span>M <span class="hljs-type"><span class="hljs-type">name</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> parent=<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> max-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=<span class="hljs-number"><span class="hljs-number">28</span></span>M <span class="hljs-type"><span class="hljs-type">name</span></span>=def-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> packet-mark=def_out parent=<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>-at=<span class="hljs-number"><span class="hljs-number">1</span></span>M max-<span class="hljs-keyword"><span class="hljs-keyword">limit</span></span>=<span class="hljs-number"><span class="hljs-number">2</span></span>M <span class="hljs-type"><span class="hljs-type">name</span></span>=voip-<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> packet-mark=voip_out parent=<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> priority=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  By the way, the router should prioritize traffic with a large DSCP value, but I still separated a 2 Mb / s band for it. <br><br><h3>  Part 2. The failover script </h3><br>  Let's start from the very beginning, let me tell you how the provider links and routing are configured. <br>  There are two ISPs, one connects via ethernet, the second via PPPoE. <br>  For clarity, here are the listings.  Ethernet connection: <br><pre> <code class="hljs kotlin">[<span class="hljs-symbol"><span class="hljs-symbol">f@</span></span><span class="hljs-number"><span class="hljs-number">777777</span></span>] &gt; ip addr pr <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">=</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ether7</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Flags</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">X - disabled</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">I - invalid</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">D - dynamic # ADDRESS NETWORK INTERFACE 0 46.11.6.78/30 46.11.6.76 ether7</span></span></span></span></code> </pre><br>  PPPoE: <br><pre> <code class="hljs pgsql">[f@<span class="hljs-number"><span class="hljs-number">777777</span></span>] &gt; <span class="hljs-type"><span class="hljs-type">int</span></span> pppoe-cl pr Flags: X - disabled, R - running <span class="hljs-number"><span class="hljs-number">0</span></span> R <span class="hljs-type"><span class="hljs-type">name</span></span>="rtk" max-mtu=auto max-mru=auto mrru=disabled interface=ether8 <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>="f" <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>="w" profile=<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> keepalive-timeout=<span class="hljs-number"><span class="hljs-number">60</span></span> service-<span class="hljs-type"><span class="hljs-type">name</span></span>="" ac-<span class="hljs-type"><span class="hljs-type">name</span></span>="" <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-route=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> dial-<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-demand=<span class="hljs-keyword"><span class="hljs-keyword">no</span></span> use-peer-dns=yes allow=pap,chap,mschap1,mschap2</code> </pre><br>  note - I do not add a default route when raising the interface, it will be added manually, statically <br><br>  the next step is to configure the routing <br><pre> <code class="hljs lua">[f@<span class="hljs-number"><span class="hljs-number">777777</span></span>] &gt; ip rpdt <span class="hljs-number"><span class="hljs-number">0</span></span> AS comment=RTK_TABLE dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=rtk gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=rtk reachable distance=<span class="hljs-number"><span class="hljs-number">1</span></span> scope=<span class="hljs-number"><span class="hljs-number">30</span></span> target-scope=<span class="hljs-number"><span class="hljs-number">10</span></span> routing-mark=RTK_mark <span class="hljs-number"><span class="hljs-number">1</span></span> AS comment=GoodLine_TABLE dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span> gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span> reachable via ether7 distance=<span class="hljs-number"><span class="hljs-number">1</span></span> scope=<span class="hljs-number"><span class="hljs-number">30</span></span> target-scope=<span class="hljs-number"><span class="hljs-number">10</span></span> routing-mark=GoodLine_mark <span class="hljs-number"><span class="hljs-number">2</span></span> AS comment=MAIN_TABLE dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span> gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span> reachable via ether7 distance=<span class="hljs-number"><span class="hljs-number">1</span></span> scope=<span class="hljs-number"><span class="hljs-number">30</span></span> target-scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> S comment=MAIN_TABLE dst-address=<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> gateway=rtk gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=rtk reachable distance=<span class="hljs-number"><span class="hljs-number">2</span></span> scope=<span class="hljs-number"><span class="hljs-number">30</span></span> target-scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> ADC dst-address=<span class="hljs-number"><span class="hljs-number">10.155</span></span><span class="hljs-number"><span class="hljs-number">.177</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> pref-src=<span class="hljs-number"><span class="hljs-number">10.155</span></span><span class="hljs-number"><span class="hljs-number">.177</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span> gateway=pptp-out1 gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=pptp-out1 reachable distance=<span class="hljs-number"><span class="hljs-number">0</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> S dst-address=<span class="hljs-number"><span class="hljs-number">10.155</span></span><span class="hljs-number"><span class="hljs-number">.177</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> gateway=pptp-out1 gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=pptp-out1 reachable distance=<span class="hljs-number"><span class="hljs-number">1</span></span> scope=<span class="hljs-number"><span class="hljs-number">30</span></span> target-scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> ADC dst-address=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.76</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> pref-src=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.78</span></span> gateway=ether7 gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=ether7 reachable distance=<span class="hljs-number"><span class="hljs-number">0</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> ADC dst-address=<span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.79</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> pref-src=<span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.79</span></span><span class="hljs-number"><span class="hljs-number">.251</span></span> gateway=l2tp-out1 gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=l2tp-out1 reachable distance=<span class="hljs-number"><span class="hljs-number">0</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> ADC dst-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> pref-src=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> gateway=bridge-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=bridge-<span class="hljs-keyword"><span class="hljs-keyword">local</span></span> reachable distance=<span class="hljs-number"><span class="hljs-number">0</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> AS comment=thecall dst-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> gateway=<span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.79</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=<span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.79</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> reachable via l2tp-out1 distance=<span class="hljs-number"><span class="hljs-number">1</span></span> scope=<span class="hljs-number"><span class="hljs-number">30</span></span> target-scope=<span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> ADC dst-address=<span class="hljs-number"><span class="hljs-number">213.22</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.99</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> pref-src=<span class="hljs-number"><span class="hljs-number">217.11</span></span><span class="hljs-number"><span class="hljs-number">.15</span></span><span class="hljs-number"><span class="hljs-number">.125</span></span> gateway=rtk gateway-<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>=rtk reachable distance=<span class="hljs-number"><span class="hljs-number">0</span></span> scope=<span class="hljs-number"><span class="hljs-number">10</span></span></code> </pre><br>  there is a lot of superfluous, we are only interested in 0,1,2,3 <br>  2 and 3 are default routes, 2 with metric (distance) "1" and is currently active and 3 with metric "2", currently not used <br><br>  0 and 1 are needed so that the marshtutizer can respond from the same interface to which the request came, i.e.  no matter which route is active by default <br>  the same logic is served by the rules 0,1 from the following listing of the routing rules: <br><pre> <code class="hljs pgsql">[f@<span class="hljs-number"><span class="hljs-number">777777</span></span>] &gt; ip r ru pr Flags: X - disabled, I - inactive <span class="hljs-number"><span class="hljs-number">0</span></span> src-address=<span class="hljs-number"><span class="hljs-number">217.11</span></span><span class="hljs-number"><span class="hljs-number">.15</span></span><span class="hljs-number"><span class="hljs-number">.125</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span> action=lookup table=RTK_mark <span class="hljs-number"><span class="hljs-number">1</span></span> src-address=<span class="hljs-number"><span class="hljs-number">46.18</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span><span class="hljs-number"><span class="hljs-number">.78</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span> action=lookup table=GoodLine_mark <span class="hljs-number"><span class="hljs-number">2</span></span> dst-address=<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.77</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> action=lookup table=main</code> </pre><br>  Rule 2 is needed for LAN devices behind MikroTik. <br><br>  All this is called the capacious words ‚ÄúPolicy based routing‚Äù and at the end of the opus I will give some useful links for understanding the work of these mechanisms-rules. <br>  <i>* Yes, I realized the minimum, but this is what I need</i> <i><br></i> <br>  We dealt with the aperitif, we will deal with the main course. <br>  The script listing is packaged under the spoiler, because  too large (all UPDs are already included). <br>  <b>UPD1 - the script is fixed 11/28/2015</b> <b><br></b>  <b>changed the condition (true for ISP2):</b> <b><br></b> <pre> <b><code class="hljs perl">- :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP1 &lt; ($FailTreshold)) + :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP1 &lt; ($FailTreshold+<span class="hljs-number"><span class="hljs-number">1</span></span>))</code></b> </pre> <b><br></b>  <b>Also added route adding</b> <b><br></b> <pre> <b><code class="hljs bash">:<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/interface get value-name=running <span class="hljs-variable"><span class="hljs-variable">$InterfaceISP1</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /ip route add dst-address=<span class="hljs-variable"><span class="hljs-variable">$PingTarget</span></span> gateway=<span class="hljs-variable"><span class="hljs-variable">$GatewayISP1</span></span> :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingResult [ping <span class="hljs-variable"><span class="hljs-variable">$PingTarget</span></span> count=3]</code></b> </pre> <b><br></b>  <b>because</b>  <b>if you simply specify the desired interface, but at the moment the route is not active, then the ping will not pass</b> <b><br><br></b>  <b>at the end of each ISP check, the route is deleted</b> <b><br></b> <pre> <b><code class="hljs matlab">/ip route <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> dst-address=<span class="hljs-string"><span class="hljs-string">"$PingTarget"</span></span> . <span class="hljs-string"><span class="hljs-string">"/32"</span></span>]</code></b> </pre> <b><br></b> <br><br>  <b>UPD2 - the script successfully works on RouterOS version 6.33.1</b> <b><br></b> <br>  <b>UPD3</b> <b><br></b>  <b>PBXIP variable must be indicated in quotes</b> <b><br></b> <pre> <b><code class="hljs css"><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">PBXIP</span></span> "192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.77</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>"</code></b> </pre> <b><br></b>  <b>and each line of connection tracking deletion should be without quotes</b> <b><br></b> <pre> <b><code class="hljs lua">/ip firewall connection { <span class="hljs-built_in"><span class="hljs-built_in">remove</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] }</code></b> </pre> <b><br></b> <br><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs dos"># ------------------- header ------------------- # Script by Tomas Kirnak, version <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span> # <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> you use this script, or edit and # re-use it, please keep the header intact. # # <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-built_in"><span class="hljs-built_in">more</span></span> information and details about # this script please visit the wiki page <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> # http://wiki.mikrotik.com/wiki/Failover_Scripting # ------------------- header ------------------- #------------------- header_1 ------------------ # FessAectan has made some changes: # - add ISPs link state checking - # - add clearing connection tracking states <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> selected IP - # ------------------ header_1 ------------------ # ------------- <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> editing here ------------- # Edit the variables below to suit your needs # Please fill the WAN interface names :local InterfaceISP1 ether7 :local InterfaceISP2 rtk # Please fill the gateway IPs (or interface names <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> case of PPP) :local GatewayISP1 <span class="hljs-number"><span class="hljs-number">46</span></span>.<span class="hljs-number"><span class="hljs-number">18</span></span>.<span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">77</span></span> :local GatewayISP2 rtk # Please fill the <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> check host - currently: resolver1.opendns.com :local PingTarget <span class="hljs-number"><span class="hljs-number">21</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">77</span></span> # Please fill how many <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> failures are allowed before fail-over happends :local FailTreshold <span class="hljs-number"><span class="hljs-number">1</span></span> # Define the distance increase of a route when it fails :local DistanceIncrease <span class="hljs-number"><span class="hljs-number">2</span></span> # Editing the script after this point may <span class="hljs-built_in"><span class="hljs-built_in">break</span></span> it # -------------- stop editing here -------------- # Declare the global variables :global PingFailCountISP1 :global PingFailCountISP2 :global InterfaceFailISP1 :global InterfaceFailISP2 # This inicializes the PingFailCount variables, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> case this is the <span class="hljs-number"><span class="hljs-number">1</span></span>st <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> the script has ran :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:typeof $PingFailCountISP1] = "nothing") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingFailCountISP1 <span class="hljs-number"><span class="hljs-number">0</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:typeof $PingFailCountISP2] = "nothing") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingFailCountISP2 <span class="hljs-number"><span class="hljs-number">0</span></span>} # IntercaceFail variables. First <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> initialization. :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:typeof $InterfaceFailISP1] = "nothing") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> InterfaceFailISP1 <span class="hljs-number"><span class="hljs-number">0</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:typeof $InterfaceFailISP2] = "nothing") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> InterfaceFailISP2 <span class="hljs-number"><span class="hljs-number">0</span></span>} # This variable will be used to keep results of individual <span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> attempts :local PingResult # Your PBX IP :local PBXIP "<span class="hljs-number"><span class="hljs-number">192</span></span>.<span class="hljs-number"><span class="hljs-number">168</span></span>.<span class="hljs-number"><span class="hljs-number">77</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>" # Check ISP1 :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/interface get value-name=running $InterfaceISP1]) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /ip route add dst-address=$PingTarget gateway=$GatewayISP1 :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingResult [<span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> $PingTarget count=<span class="hljs-number"><span class="hljs-number">3</span></span> interface=$InterfaceISP1] :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingResult = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP1 &lt; ($FailTreshold+<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingFailCountISP1 ($PingFailCountISP1 + <span class="hljs-number"><span class="hljs-number">1</span></span>)} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP1 = $FailTreshold) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :log warning "ISP1 has a problem en route to $PingTarget - increasing distance of routes." :foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/ip route <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> gateway=$GatewayISP1 &amp;&amp; static &amp;&amp; comment=MAIN_TABLE] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>=\ {/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> $i distance=([/ip route get $i distance] + $DistanceIncrease)} :log warning "Route distance increase finished." /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($InterfaceFailISP1 = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> InterfaceFailISP1 <span class="hljs-number"><span class="hljs-number">1</span></span> :log warning "ISP1 intarface link is down - clear all connections from $PBXIP" /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/interface get value-name=running $InterfaceISP1]) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($InterfaceFailISP1 = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> InterfaceFailISP1 <span class="hljs-number"><span class="hljs-number">0</span></span> :log warning "ISP1 intarface link is up - clear all connections from $PBXIP" /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingResult &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP1 &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingFailCountISP1 ($PingFailCountISP1 - <span class="hljs-number"><span class="hljs-number">1</span></span>) :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP1 = ($FailTreshold -<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :log warning "ISP1 can reach $PingTarget again - bringing back original distance of routes." :foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/ip route <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> gateway=$GatewayISP1 &amp;&amp; static &amp;&amp; comment=MAIN_TABLE] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>=\ {/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> $i distance=([/ip route get $i distance] - $DistanceIncrease)} :log warning "Route distance decrease finished." /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } } /ip route <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> dst-address="$PingTarget" . "/<span class="hljs-number"><span class="hljs-number">32</span></span>"] # Check ISP2 :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/interface get value-name=running $InterfaceISP2]) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ /ip route add dst-address=$PingTarget gateway=$GatewayISP2 :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingResult [<span class="hljs-built_in"><span class="hljs-built_in">ping</span></span> $PingTarget count=<span class="hljs-number"><span class="hljs-number">3</span></span> interface=$InterfaceISP2] :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingResult = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP2 &lt; ($FailTreshold+<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingFailCountISP2 ($PingFailCountISP2 + <span class="hljs-number"><span class="hljs-number">1</span></span>)} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP2 = $FailTreshold) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :log warning "ISP2 has a problem en route to $PingTarget - increasing distance of routes." :foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/ip route <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> gateway=$GatewayISP2 &amp;&amp; static &amp;&amp; comment=MAIN_TABLE] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>=\ {/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> $i distance=([/ip route get $i distance] + $DistanceIncrease)} :log warning "Route distance increase finished." /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($InterfaceFailISP2 = <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> InterfaceFailISP2 <span class="hljs-number"><span class="hljs-number">1</span></span> :log warning "ISP2 interface link is down - clear all connections from $PBXIP" /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([/interface get value-name=running $InterfaceISP2]) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($InterfaceFailISP2 = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> InterfaceFailISP2 <span class="hljs-number"><span class="hljs-number">0</span></span> :log warning "ISP2 intarface link is up - clear all connections from $PBXIP" /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingResult &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP2 &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PingFailCountISP2 ($PingFailCountISP2 - <span class="hljs-number"><span class="hljs-number">1</span></span>) :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingFailCountISP2 = ($FailTreshold -<span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :log warning "ISP2 can reach $PingTarget again - bringing back original distance of routes." :foreach i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>=[/ip route <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> gateway=$GatewayISP2 &amp;&amp; static &amp;&amp; comment=MAIN_TABLE] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>=\ {/ip route <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> $i distance=([/ip route get $i distance] - $DistanceIncrease)} :log warning "Route distance decrease finished." /ip firewall connection { remove [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> src-address~$PBXIP] } } } } /ip route <span class="hljs-built_in"><span class="hljs-built_in">rem</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> dst-address="$PingTarget" . "/<span class="hljs-number"><span class="hljs-number">32</span></span>"]</code> </pre><br></div></div><br>  With the description of variables, everything is clear, further briefly the logic itself: <br>  1. Check if there is a link on the interface (does a PPPoE connection exist) <br>  2. Yes, we check availability of $ PingTarget <br>  2a  No - delete all connections from the src-address of our PBX.  The route with the metric ‚Äú2‚Äù becomes active, so that old connections need to be removed by SIP registrations. <br>  3. $ PingTarget is available - we are going to check ISP2 <br>  3a.  $ PingTarget is not available - reduce the route metric through ISP1 by 2 and delete the old connection from the ‚ÄúConnection tracking‚Äù <br><br>  Why did I add an interface status check? <br>  If there is no link on the port, then there is no point in sending ping. <br>  Or, in the case of PPP interfaces (like mine), ping will not work at all and the script logic will be broken. <br><pre> <code class="hljs xml">[f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> interface pppoe-cl di 0 [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> :if ([/ping 8.8.8.8 interface=rtk count=3]&gt;0) do={:put "Yes sir"} SEQ HOST SIZE TTL TIME STATUS <span class="hljs-comment"><span class="hljs-comment">&lt;!--         -    --&gt;</span></span> [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> interface pppoe-cl en 0 [f@777777] <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SAFE</span></span></span><span class="hljs-tag">&gt;</span></span> :if ([/ping 8.8.8.8 interface=rtk count=3]&gt;0) do={:put "Yes sir"} SEQ HOST SIZE TTL TIME STATUS 0 8.8.8.8 timeout 1 8.8.8.8 timeout 2 8.8.8.8 56 254 52ms sent=3 received=1 packet-loss=66% min-rtt=52ms avg-rtt=52ms max-rtt=52ms Yes sir</code> </pre><br><br>  Things are a matter of fact, add a task to the scheduler of the router. <br><pre> <code class="hljs pgsql">[f@<span class="hljs-number"><span class="hljs-number">777777</span></span>] &gt; sys sch exp # nov/<span class="hljs-number"><span class="hljs-number">26</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> RouterOS <span class="hljs-number"><span class="hljs-number">6.30</span></span> # software id = LY7Z<span class="hljs-number"><span class="hljs-number">-747</span></span>B # /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> scheduler <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-type"><span class="hljs-type">interval</span></span>=<span class="hljs-number"><span class="hljs-number">30</span></span>s <span class="hljs-type"><span class="hljs-type">name</span></span>=check_ISPs <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>-event=check_gateways <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>=ftp,reboot,<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>,test,<span class="hljs-keyword"><span class="hljs-keyword">password</span></span>,sniff,sensitive <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-<span class="hljs-type"><span class="hljs-type">date</span></span>=nov/<span class="hljs-number"><span class="hljs-number">20</span></span>/<span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>-<span class="hljs-type"><span class="hljs-type">time</span></span>=<span class="hljs-number"><span class="hljs-number">05</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span></code> </pre><br>  And here we finished, let's move on to the dessert - the resources used. <br><br><h3>  Part 3. Conclusion, resources used </h3><br>  If you want to read about DSCP, I advise you to use these links here: <br>  1. <a href="http://www.cisco.com/cisco/web/support/RU/9/92/92093_dscpvalues.html">cisco</a> <br>  2. <a href="https://ru.wikipedia.org/wiki/DiffServ_Code_Point">en.wikipedia</a> <br>  3. <a href="https://msdn.microsoft.com/ru-ru/library/cc787218(v%3Dws.10).aspx">msdn.microsoft</a> <br>  4. <a href="http://microsin.ru/content/view/254/43/">microsin</a> <br><br>  How packs go to MikroTik, how Policy routing is configured: <br>  1. <a href="http://wiki.mikrotik.com/wiki/Manual:Packet_Flow">wiki Manual: Packet_Flow</a> <br>  2. <a href="http://wiki.mikrotik.com/wiki/Policy_Base_Routing">wiki Policy_Base_Routing</a> <br>  3. <a href="http://nixman.info/%3Fp%3D133">nixman Policy_Base_Routing</a> <br>  4. <a href="http://blog.butchevans.com/2008/09/mikrotik-policy-routing-implementation-example/">blog.butchevans Policy_Base_Routing</a> <br><br>  A couple of useful, although I think well-known, manuals on iptables: <br>  1. <a href="https://ru.wikibooks.org/wiki/Iptables">ru.wikibooks.org/wiki/Iptables</a> <br>  2. <a href="https://www.opennet.ru/docs/RUS/iptables/">opennet iptables guid</a> <br><br>  Behind this otklanivayus, thanks to those who read it. <br>  I will be immensely happy if I find myself useful, because this is the essence. <br>  Good luck everyone, everyone! </div><p>Source: <a href="https://habr.com/ru/post/271747/">https://habr.com/ru/post/271747/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271735/index.html">Writing data to Teradata using DML</a></li>
<li><a href="../271737/index.html">Floating toolbar for text selection in Android Marshmallow: parsing innovations</a></li>
<li><a href="../271739/index.html">PostCSS quick start</a></li>
<li><a href="../271741/index.html">Welcome to GDG DevFest Omsk 2015</a></li>
<li><a href="../271745/index.html">Successful implementation of SIEM. Part 1</a></li>
<li><a href="../271749/index.html">DotNext - Conference on .NET-technologies, Moscow, December 11</a></li>
<li><a href="../271751/index.html">Deploy Drupal 8 with Docker</a></li>
<li><a href="../271755/index.html">MultiSim: technological SIM-phony for several operators and one subscriber</a></li>
<li><a href="../271757/index.html">Comparative analysis of shopping carts</a></li>
<li><a href="../271759/index.html">Creating The Blacksmith: Staging, Shading and Lighting</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>