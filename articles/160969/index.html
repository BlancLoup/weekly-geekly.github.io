<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic reception of Yandex.Money on the site on php</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Documentation on accepting Yandex.Money does not contain a specific example in PHP, so that you can fasten everything as quickly as possible without u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic reception of Yandex.Money on the site on php</h1><div class="post__text post__text-html js-mediator-article">  Documentation on accepting Yandex.Money does not contain a specific example in PHP, so that you can fasten everything as quickly as possible without understanding all the details of how Yandex.Money reception in PHP works.  Having made an automatic reception of Yandex.Money in <a href="http://itsoft.ru/">itsoft.ru</a> , our company, I would like to give step-by-step instructions with PHP code examples in order to significantly save time for other developers. <br><br>  Initially, the automatic reception Yandex. Money seemed to me very difficult.  But as it turned out, everything is easier than WebMoney. <br><br><h4>  Step 1: Create an HTML form for receiving payments </h4><br>  The form code itself can be generated here <a href="">money.yandex.ru/embed/quickpay/shop.xml</a> But since our goal is to accept payments automatically, in the HTML form we need to add the id of the account that the client pays us.  And most likely, we want to receive the full amount of the bill, i.e.  we want the Yandex commission to pay 0.05% for the client, therefore as a result the HTML form <br>  in our php script it will be generated like this: <br><a name="habracut"></a><br><pre><code class="php hljs">$sum = <span class="hljs-number"><span class="hljs-number">1.005</span></span>*$i-&gt;itsum; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> &lt;&lt;&lt;HTML &lt;p&gt;       . <span class="hljs-number"><span class="hljs-number">0.5</span></span>%.     , , ,     /<span class="hljs-number"><span class="hljs-number">1.005</span></span>.     ,         ,    . &lt;/p&gt; &lt;p&gt; &lt;b&gt;        online,      .&lt;/b&gt; &lt;/p&gt; &lt;iframe allowtransparency=<span class="hljs-string"><span class="hljs-string">"true"</span></span> src=<span class="hljs-string"><span class="hljs-string">"https://money.yandex.ru/embed/shop.xml?uid=4100138353971&amp;writer=seller&amp;targets=i$i-&gt;id&amp;default-sum=$sum&amp;button-text=01&amp;hint="</span></span> frameborder=<span class="hljs-string"><span class="hljs-string">"0"</span></span> height=<span class="hljs-string"><span class="hljs-string">"163"</span></span> scrolling=<span class="hljs-string"><span class="hljs-string">"no"</span></span> width=<span class="hljs-string"><span class="hljs-string">"450"</span></span>&gt;&lt;/iframe&gt; HTML;</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Notice the two variables $ sum and $ i-&gt; id <br>  We also added a warning that payments with a protection code cannot be credited automatically, since  our system, the protection code cannot guess at all <br><br>  By implementing this form on your website, you can already receive money on your Yandex.Walker and see by what account number the payment was made.  To automatically credit a payment, follow the steps below. <br><br><h4>  Step 2: Download the PHP library for working with the Yandex.Money API </h4><br>  You can get the library here <a href="https://github.com/melnikovdv/PHP-Yandex.Money-API-SDK">github.com/melnikovdv/PHP-Yandex.Money-API-SDK</a> <br>  Next, you need to unzip it and copy it to your site, for example, to the / invoice / ym / directory <br>  In your / invoice / ym / directory, the lib and sample folders should appear, respectively. <br><br><h4>  Step 3: Register the application for working with the Yandex.Money API </h4><br>  This can be done here <a href="">sp-money.yandex.ru/myservices/new.xml</a> <br><br>  For example, we have the following values: <br><br><br>  Name of your application: <br>  (users will see it, giving the application rights) ITSoft <br><br>  Your website address: <a href="http://itsoft.ru/">itsoft.ru</a> <br><br>  Redirect uri: <a href="https://itsoft.ru/invoice/ym/sample/index.php">itsoft.ru/invoice/ym/sample/index.php</a> <br>  (the address to which the Yandex.Money server will redirect after the user allows or denies access; corresponds to the redirect_uri parameter in the documentation) <br><br>  Use application authentication Yes <br>  - After registering the application, you will see the ‚ÄúApplication ID‚Äù and ‚ÄúOAuth2 client_secret:‚Äù <br>  If you lose them all of a sudden, you can always get them in the settings of your Yandex.Money account in the My Applications section <a href="">sp-money.yandex.ru/tunes.xml?from=bal</a> , on the right is the "Configure" button. <br><br>  The application identifier and ‚ÄúOAuth2 client_secret‚Äù must be copied to the file /invoice/ym/sample/consts.php <br>  In the same place, initialize REDIRECT_URI to <a href="https://yourdomain.ru/invoice/ym/sample/index.php">yourdomain.ru/invoice/ym/sample/index.php</a> <br><br><h4>  Step 4: Get the token to work with your Yandex.Koshelk using the PHP library </h4><br>  In the script <a href="https://yourdomain.ru/invoice/ym/sample/index.php">yourdomain.ru/invoice/ym/sample/index.php</a> you need to comment out <br>  following lines: <br>  //cm.  lines 10-16 and comment as shown below, we will not need these operations, so we will not request permission for them <br><pre> <code class="php hljs">$scope = <span class="hljs-string"><span class="hljs-string">"account-info "</span></span> . <span class="hljs-string"><span class="hljs-string">"operation-history "</span></span> . <span class="hljs-string"><span class="hljs-string">"operation-details "</span></span> <span class="hljs-comment"><span class="hljs-comment">/*. "payment.to-account(\"410011161616877\",\"account\").limit(30,10) " . "payment.to-pattern(\"337\").limit(30,10) " . "money-source(\"wallet\",\"card\") " */</span></span>; $authUri = YandexMoneyNew::authorizeUri(CLIENT_ID, REDIRECT_URI, $scope);</code> </pre><br>  And comment on the lines from 82nd to 131y. <br><br>  Now you need to call yourdomain.ru/invoice/ym/sample/index.php script in the browser, log in and save the received token.  Be careful, copy the token in its entirety, it is very long. <br><br>  We are already close to victory. <br><br><h4>  Step 5: Setting up a callback script that Yandex.Money will call upon receipt of payment to your wallet </h4><br>  On this page <a href="">sp-money.yandex.ru/myservices/online.xml</a> you must enter the address of the script, for example: <a href="https://itsoft.ru/invoice/ym/payment.php">itsoft.ru/invoice/ym/payment.php</a> <br><br>  You can press the test button, however, you do not yet have a handler script, and you have to test by paying 1 ruble from a wallet on your website. <br><br>  Check the ‚ÄúSend notifications‚Äù box and click Save. <br><br>  You will need the secret key from this page.  Save it. <br><br><br><h4>  Step 6: Processing and crediting payments </h4><br>  The script <a href="https://itsoft.ru/invoice/ym/payment.php">itsoft.ru/invoice/ym/payment.php</a> here looks like this, I removed a number of details that relate exclusively to the processing of customer orders. <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>($_SERVER[<span class="hljs-string"><span class="hljs-string">"DOCUMENT_ROOT"</span></span>].<span class="hljs-string"><span class="hljs-string">"/conf/config_db_ro_without_auth1.php"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/lib/YandexMoney.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span>(dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/sample/consts.php'</span></span>); main(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ob_start(); print_r($_POST); $message = ob_get_contents(); ob_end_clean(); <span class="hljs-comment"><span class="hljs-comment">//mail('igor@itsoft.ru', 'Notification details', $message); if($_POST['codepro']!='false') return mail('igor@itsoft.ru', 'We got YM with protection code', "We cannot automatically get this payment.\n\n $message"); $str=$_POST['notification_type'] . '&amp;' . $_POST['operation_id'] . '&amp;' . $_POST['amount'] . '&amp;' . $_POST['currency'] . '&amp;' . $_POST['datetime'] . '&amp;' . $_POST['sender'] . '&amp;' . $_POST['codepro'] . '&amp;    https://sp-money.yandex.ru/myservices/online.xml&amp;' . $_POST['label']; if(sha1($str)!=$_POST['sha1_hash']) return mail('igor@itsoft.ru', 'Fake notification', $message); $ym = new YandexMoneyNew(CLIENT_ID); $token='    4'; $resp = $ym-&gt;operationDetail($token, $_POST['operation_id']); $message .= "\r\n". var_export($_POST, 1) . var_export($resp); if($resp-&gt;isSuccess()) mail('igor@itsoft.ru', 'We got payment', $message . "\n\nmessage=" . $resp-&gt;getMessage() . "\n\ndetail=" . $resp-&gt;getDetail() . "\n\ntitle=" . $resp-&gt;getTitle()); else mail('igor@itsoft.ru', 'We did not get payment... Hm... Why?', $message); $operation_id = $_POST['operation_id']; $sender = $_POST['sender']; $amount = $_POST['amount']; $datetime = $_POST['datetime']; preg_match('/i(\d+);/', $resp-&gt;getMessage(), $m); $invoice_id = $m[1]; $r=mysql_query("INSERT INTO it_payment_ym VALUES('$operation_id', '$sender', '$amount', '$datetime', '$invoice_id')"); if(!$r) mail('igor@itsoft.ru', 'Problem to insert in it_payment_ym', $message . mysql_error()); }//main </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre><br><br>  Well, that's all.  There will be questions, ask here, I will try to answer all.  If you like it, you can send me money for a beer on my Yandex.Walker.  :) <br><br>  PS <br>  This article is devoted to how quickly to fasten the Yandex.Money reception.  PHP script code everyone can rewrite depending on their tasks and needs. </div><p>Source: <a href="https://habr.com/ru/post/160969/">https://habr.com/ru/post/160969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160957/index.html">Youtube again allows you to test the new interface by changing the cookie.</a></li>
<li><a href="../160959/index.html">Dell released for developers ultrabook with Ubuntu</a></li>
<li><a href="../160961/index.html">Solving the problem of connecting PPTP VPN via LTE from Yota</a></li>
<li><a href="../160963/index.html">A look into the future of MODX. 2013</a></li>
<li><a href="../160965/index.html">A little about the conference Microsoft TechEd 2012</a></li>
<li><a href="../160971/index.html">SMS messages are 20 years old</a></li>
<li><a href="../160973/index.html">Cyber ‚Äã‚ÄãWarlock - Stuxnet, Duqu, Flame, Gauss and everything, everything, everything ...</a></li>
<li><a href="../160979/index.html">Mini PC Raspberry Pi Model A for $ 25 has already been put into production</a></li>
<li><a href="../160981/index.html">Useful stuff for iOS application interface designer</a></li>
<li><a href="../160983/index.html">PengPod launches dualboot Linux / Android tablets in January</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>