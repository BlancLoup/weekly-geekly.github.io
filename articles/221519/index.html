<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sapper: Royal Engineer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habrarazrabotchiki, welcome! 

 In this post, I will tell you the ‚Äúhistory‚Äù of the development and publication of our first game: how the design was d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sapper: Royal Engineer</h1><div class="post__text post__text-html js-mediator-article">  Habrarazrabotchiki, welcome! <br><br>  In this post, I will tell you the ‚Äúhistory‚Äù of the development and publication of our first game: how the design was drawn, how it was developed, what difficulties it encountered, why StackOverflow is better than the Apple Dev Forums, etc. <br>  The game was made in order to form the mechanisms of interaction with the designer, to further accelerate the development of more complex games, so judge strictly (as much as possible). <br><br>  Pictures to attract attention: <br><img src="https://habrastorage.org/getpro/habr/post_images/4d1/9d1/798/4d19d179813519723c870d75635e800e.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/5cb/85a/5f9/5cb85a5f9b399c9b3bb6dbdaf701cb43.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/d4d/480/79d/d4d48079da67acb9e1024b4e3c1f2ccf.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/a2b/054/b2d/a2b054b2d03e0396196918f83a26abe1.jpg" alt="image"><br><br><a name="habracut"></a><br><br><h4>  How did it all start? </h4><br>  It so happened that the new job, for certain reasons, had to develop games for machine guns.  I worked with a talented designer who very much wanted to develop other games (for mobile platforms, for PC, XBox, etc.).  Here we are with him and decided in parallel to develop something interesting, but at the same time, not too complicated, so that our development does not take 4-5-6 months.  Neither I nor he were ready for such a long jump. <br><br>  The sapper was not the idea for which we wanted to start at the very beginning. <br><br>  This is what we wanted to tackle, but we are very glad that our forces correctly estimated in time: <br><br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><img width="520" src="https://habrastorage.org/getpro/habr/post_images/69b/373/512/69b373512bfe3d0f84ed1d0b37f18dc4.jpg" alt="image"><br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/899/2d3/351/8992d3351c30c2c24fae06c3cd531619.jpg" alt="image"><br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/980/166/4ef/9801664ef8d44386b3d4082565b21182.jpg" alt="image"><br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/9f0/4ef/31e/9f04ef31eb4a4ede343aa678c9b1857f.jpg" alt="image"><br></div></div><br><br>  First of all, I didn‚Äôt want to take a too complex game because I couldn‚Äôt yet appreciate the capabilities of SpriteKit and really didn‚Äôt want to be in the middle of development and understand that I could only implement a feature through a stump-deck. <br><br>  On StackOverflow, I saw that Cocos2D was very actively supported by the author himself (LearnCocos2D), but I really wanted to try SpriteKit after the Apple presentation and the <a href="https://developer.apple.com/Library/ios/documentation/GraphicsAnimation/Conceptual/CodeExplainedAdventure/AdventureArchitecture/AdventureArchitecture.html">Adventure</a> game.  I was grieved by the fact that particle visualization is built into XCode, but I want to open XCode less often. <br><br><h4>  Instruments </h4><br>  At the initial stages a bunch of Xcode + AppCode, Photoshop. <br>  Then only AppCode and Photoshop. <br><br>  About SpriteKit can be viewed <a href="https://developer.apple.com/library/ios/documentation/GraphicsAnimation/Conceptual/SpriteKit_PG/Introduction/Introduction.html">here</a> or <a href="">here</a> . <br><br><h4>  Design (retina, non retina, iPhone 4 and 5) </h4><br>  I immediately was in favor of the fact that we did not support 4 iPhones and did not steam with a bunch of images, which we already had enough because of the peculiarities of the application localization.  Once abandoned 4, and all that is lower, it is necessary to draw only under the retina - great! <br><br>  Here, for example, looked like our first option: <br><br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><img width="520" src="https://habrastorage.org/getpro/habr/post_images/12b/35f/e97/12b35fe972caf16f721cf59c0b12c89d.jpg"><br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/dce/9f3/93f/dce9f393fccd307da86f6301d42edd5e.jpg"><br></div></div><br><br>  Then we asked about such questions: <br><ul><li>  Should there be an advertisement on the game screen and close the playing field? </li><li>  Should we consider the size and position of the ad unit when rendering a background image? </li><li>  Should there be a ‚ÄúMenu‚Äù button or a ‚ÄúBack‚Äù button? </li><li>  What to show after the user won or lost? </li><li>  etc. </li></ul><br><br>  The following versions already looked like this: <br><br><div class="spoiler">  <b class="spoiler_title">Screenshots</b> <div class="spoiler_text"><img width="520" src="https://habrastorage.org/getpro/habr/post_images/bff/771/c28/bff771c282e3fe7efec9caae25744e83.jpg"><br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/296/ea0/25a/296ea025a7f1d5ce5f410eba7b744e24.jpg"><br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/fd9/a60/b9e/fd9a60b9ecaf1675717e5774a340c558.jpg"><br></div></div><br><br>  Let the designer have the will, but control.  The fact is that the font that he used for the time spent and the number of bombs on the field is not in the standard list, it means that you need to search the Internet.  But this is still nothing, the fact is that we need to find the __font font, taking into account that behind the inscription there is a background image with 4 gray numbers with certain distances between them, and in most cases we were faced with the fact that when changing the inscription with " 111 "to" 888 "the width of the text label (UILabel) changed and changed the distance between the characters themselves, which did not suit us ... however, the required font was found, thank God, otherwise I would have to make 10 images, position them and update the counter accordingly.  It would seem that a simple font, but alas, not everything is so simple (in the ‚ÄúDevelopment‚Äù section I will tell you what else was interesting with this font). <br><br>  There were no problems with sprites.  Most of all we enjoyed this switch: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/202/04e/7bb/20204e7bbba1246124323ce3742ca30f.png"><img src="https://habrastorage.org/getpro/habr/post_images/c7f/22c/5d1/c7f22c5d17c6ded0033679df4a1d41a2.png"><br><br>  Three things that the designer worked the longest: <br><ul><li>  Home screen background image </li><li>  Background image of settings screen </li><li>  Bomb explosion animation </li></ul><br><br>  The animation of a bomb explosion contains about 40 frames (in the screenshot below, two types of explosions). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e13/04b/e3d/e1304be3db43d314e7887943ed12221a.png"><br><br>  We faced the designer with one more problem - the positioning of elements and the indication of positions.  For him, this is completely irrelevant, a pixel to the left, a pixel to the right - it does not matter ... he draws everything without rulers, such a creative person :) <br>  This option did not suit me at all, because I somehow need to position it, which means we need at least some coordinates / dimensions. <br><br>  It turned out something like this: <br><br><img width="520" src="https://habrastorage.org/getpro/habr/post_images/18c/cb3/2b3/18ccb32b3deb5d894ea0d1f31a02d0df.jpg"><br><br>  Convenient, but something is wrong here, I do not leave such a feeling. <br><br><h4>  Sounds </h4><br><br>  I also had to deal with the sounds of the designer.  We found a suitable site <a href="http://www.freesound.org/">www.freesound.org</a> and used some sounds (it didn‚Äôt work at all without cutting - filtering): <br><br><ul><li>  Explosion </li><li>  Digging out </li><li>  Clicking on any "button" item </li></ul><br><br><h4>  Development </h4><br><br>  It all started with storyboards: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0f6/a05/fdb/0f6a05fdb85ea2cf70f18b291a5758e7.png"><br><br>  It ended: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b5d/bcb/f67/b5dbcbf67c6dfaed992b254feb874e26.png"><br><br>  Designing, designing, designing ... garbage is complete.  You create a skeleton, and then you start winding up the functionality, logic, graphics, etc.  From the beginning of the development to the end, my project structure has not changed, but the interaction schemes and logic of the controllers work many times. <br><br>  Let's start with the main screen.  Two buttons, tapu takes you to the game screen and settings.  Drum roll ... a sound is still played on tapu, which means either SystemSound or AVAudioPlayer (or something else), which means that preloading is needed, which means another class is needed that would be responsible for preloading all sounds and playing them.  And so it happened - BGAudioPreloader. <br><br><pre><code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BGResourcePreloader</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAudioPlayerDelegate</span></span></span><span class="hljs-class">&gt; + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instancetype</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shared</span></span></span><span class="hljs-class">; //         - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">preloadAudioResource</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">; //         </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">  //  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> // </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> -    - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAudioPlayer</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">playerFromGameConfigForResource</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">; //         </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">  //  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">.      - (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AVAudioPlayer</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">playerForResource</span></span></span><span class="hljs-class">:(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSString</span></span></span><span class="hljs-class"> *)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">; @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><br>  The implementation is as follows: <br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// // BGResourcePreloader.m // Miner // // Created by AndrewShmig on 4/5/14. // Copyright (c) 2014 Bleeding Games. All rights reserved. // #import "BGResourcePreloader.h" #import "BGSettingsManager.h" @implementation BGResourcePreloader { NSMutableDictionary *_data; } #pragma mark - Class methods static BGResourcePreloader *shared; + (instancetype)shared { static dispatch_once_t once; dispatch_once(&amp;once, ^{ shared = [[self alloc] init]; shared-&gt;_data = [[NSMutableDictionary alloc] init]; }); return shared; } #pragma mark - Instance methods - (void)preloadAudioResource:(NSString *)name { dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^{ NSString *soundPath = [[NSBundle mainBundle] pathForResource:name ofType:nil]; NSURL *soundURL = [NSURL fileURLWithPath:soundPath]; AVAudioPlayer *player = [[AVAudioPlayer alloc] initWithContentsOfURL:soundURL error:nil]; [player prepareToPlay]; _data[name] = player; }); } - (AVAudioPlayer *)playerFromGameConfigForResource:(NSString *)name { //   if ([BGSettingsManager sharedManager].soundStatus == BGMinerSoundStatusOff) return nil; return [self BGPrivate_playerForResource:name]; } - (AVAudioPlayer *)playerForResource:(NSString *)name { return [self BGPrivate_playerForResource:name]; } #pragma mark - AVAudioDelegate - (void)audioPlayerBeginInterruption:(AVAudioPlayer *)player { [player stop]; player.currentTime = 0.0; } #pragma mark - Private method - (AVAudioPlayer *)BGPrivate_playerForResource:(NSString *)name { return (AVAudioPlayer *) _data[name]; } @end</span></span></code> </pre><br><br>  On the main screen, nothing more interesting. <br><br>  Go to the settings screen. <br><br>  We immediately have a UISegmentedControl (similar) and a switch (UIButton). <br>  Before writing a bicycle with my own UISegmentedControl, I very carefully looked at StackOverflow and realized that it was better not to inherit, but to write a bicycle ... nothing complicated, but there are some features (the switch mechanism is such that even running fingers through it , the active option changes and depends not only on where you raised your finger, but also on where your finger is now located). <br><br>  The main processing of a switch state change is as follows: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - Touches - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event { [self updateSegmentedControlUsingTouches:touches]; } - (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event { [self updateSegmentedControlUsingTouches:touches]; } - (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event { [self updateSegmentedControlUsingTouches:touches]; } #pragma mark - Private method - (void)updateSegmentedControlUsingTouches:(NSSet *)touches { UITouch *touch = [touches anyObject]; CGPoint touchPoint = [touch locationInView:self]; for (NSUInteger i = 0; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; _selectedSegments.count; i++) { CGRect rect = ((UIImageView *) _selectedSegments[i]).frame; if (CGRectContainsPoint(rect, touchPoint)) { if (self.selectedSegmentIndex != i) { //    -      //  [[[BGResourcePreloader shared] playerFromGameConfigForResource:@"buttonTap.mp3"] play]; } self.selectedSegmentIndex = i; break; } } [_target performSelector:_action withObject:@(_selectedSegmentIndex)]; }</span></span></span></span></code> </pre><br><br>  There are no questions. <br><br>  Our favorite element is the switch.  At first, it worked like a normal button, but I was constantly enraged because it didn‚Äôt feel like it, and I want to feel that it is real and works the way it is. <br><br>  As a result, I received the following code to switch between states: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#pragma mark - Touches - (void)touchesBegan:(NSSet *)touches withEvent:(UIEvent *)event { //      } - (void)touchesMoved:(NSSet *)touches withEvent:(UIEvent *)event { BGLog(); [self updateActiveRegionUsingTouches:touches]; if ((self.isOn &amp;&amp; self.activeRegion == BGUISwitchLeftRegion) || (!self.isOn &amp;&amp; self.activeRegion == BGUISwitchRightRegion)) { [super touchesMoved:touches withEvent:event]; [self playSwitchSound]; [_target performSelector:_action withObject:self]; self.on = !self.on; } } - (void)touchesEnded:(NSSet *)touches withEvent:(UIEvent *)event { BGLog(); [self updateActiveRegionUsingTouches:touches]; if ((self.isOn &amp;&amp; self.activeRegion == BGUISwitchLeftRegion) || (!self.isOn &amp;&amp; self.activeRegion == BGUISwitchRightRegion)) { [super touchesEnded:touches withEvent:event]; [self playSwitchSound]; [_target performSelector:_action withObject:self]; self.on = !self.on; } } - (void)updateActiveRegionUsingTouches:(NSSet *)touches { UITouch *touch = [touches anyObject]; CGPoint touchPoint = [touch locationInView:self]; CGRect leftRect = CGRectMake(0, 0, self.bounds.size.width / 2, self.bounds.size.height); CGRect rightRect = CGRectMake(self.bounds.size.width / 2, 0, self.bounds.size.width / 2, self.bounds.size.height); if (CGRectContainsPoint(leftRect, touchPoint)) { _activeRegion = BGUISwitchLeftRegion; } else if (CGRectContainsPoint(rightRect, touchPoint)) { _activeRegion = BGUISwitchRightRegion; } else { _activeRegion = BGUISwitchNoneRegion; } }</span></span></code> </pre><br><br>  With each change of state, we save the new value of the settings in the settings manager.  The settings manager (which is in the application being released) turned out shitty, then I wrote a new one, but haven‚Äôt replaced it yet. <br><br>  Here is the source code for the new settings manager: <br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> kBGSettingManagerUserDefaultsStoreKeyForMainSettings = <span class="hljs-string"><span class="hljs-string">@"kBGSettingsManagerUserDefaultsStoreKeyForMainSettings"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> kBGSettingManagerUserDefaultsStoreKeyForDefaultSettings = <span class="hljs-string"><span class="hljs-string">@"kBGSettingsManagerUserDefaultsStoreKeyForDefaultSettings"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Class allows to work with app settings in a simple and flexible way. @interface BGSettingsManager : NSObject // Delimiters for setting paths. Defaults to "." (dot) character. @property (nonatomic, readwrite, strong) NSCharacterSet *pathDelimiters; // Boolean value which specifies if exception should be thrown if settings path // doesn't exist or they are incorrect. Defaults to YES. @property (nonatomic, readwrite, assign) BOOL throwExceptionForUnknownPath; + (instancetype)shared; // creates default settings which are not used as main settings until // resetToDefaultSettings method is called // example: [[BGSettingsManager shared] createDefaultSettingsFromDictionary:@{@"user":@{@"login":@"Andrew", @"password":@"1234"}}] - (void)createDefaultSettingsFromDictionary:(NSDictionary *)settings; // resets main settings to default settings - (void)resetToDefaultSettings; // clears/removes all settings - main and default - (void)clear; // adding new setting value for settingPath // example: [... setValue:@YES forSettingsPath:@"user.personalInfo.married"]; - (void)setValue:(id)value forSettingsPath:(NSString *)settingPath; // return setting value with specified type - (id)valueForSettingsPath:(NSString *)settingsPath; - (BOOL)boolValueForSettingsPath:(NSString *)settingsPath; - (NSInteger)integerValueForSettingsPath:(NSString *)settingsPath; - (NSUInteger)unsignedIntegerValueForSettingsPath:(NSString *)settingsPath; - (CGFloat)floatValueForSettingsPath:(NSString *)settingsPath; - (NSString *)stringValueForSettingsPath:(NSString *)settingsPath; - (NSArray *)arrayValueForSettingsPath:(NSString *)settingsPath; - (NSDictionary *)dictionaryValueForSettingsPath:(NSString *)settingsPath; - (NSData *)dataValueForSettingsPath:(NSString *)settingsPath; @end</span></span></code> </pre><br><br>  Part with the implementation: <br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// // Copyright (C) 4/27/14 Andrew Shmig ( andrewshmig@yandex.ru ) // Russian Bleeding Games. All rights reserved. // // Permission is hereby granted, free of charge, to any person // obtaining a copy of this software and associated documentation // files (the "Software"), to deal in the Software without // restriction, including without limitation the rights to use, // copy, modify, merge, publish, distribute, sublicense, and/or // sell copies of the Software, and to permit persons to whom the // Software is furnished to do so, subject to the following // conditions: // // The above copyright notice and this permission notice shall be // included in all copies or substantial portions of the Software. // // THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, // EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES // OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. // IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE // FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION // OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN // CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN // THE SOFTWARE. // #import "BGSettingsManager.h" @implementation BGSettingsManager { NSMutableDictionary *_defaultSettings; NSMutableDictionary *_settings; } #pragma mark - Class methods + (instancetype)shared { static dispatch_once_t once; static BGSettingsManager *shared; dispatch_once(&amp;once, ^{ shared = [[self alloc] init]; shared-&gt;_pathDelimiters = [NSCharacterSet characterSetWithCharactersInString:@"."]; shared-&gt;_throwExceptionForUnknownPath = YES; [shared BGPrivateMethod_loadExistingSettings]; }); return shared; } #pragma mark - Instance methods - (void)createDefaultSettingsFromDictionary:(NSDictionary *)settings { _defaultSettings = [self BGPrivateMethod_deepMutableCopy:settings]; [self BGPrivateMethod_saveSettings]; } - (void)resetToDefaultSettings { _settings = [_defaultSettings mutableCopy]; [self BGPrivateMethod_saveSettings]; } - (void)clear { _settings = [NSMutableDictionary new]; _defaultSettings = [NSMutableDictionary new]; [self BGPrivateMethod_saveSettings]; } - (void)setValue:(id)value forSettingsPath:(NSString *)settingPath { NSArray *settingsPathComponents = [settingPath componentsSeparatedByCharactersInSet:self .pathDelimiters]; __block id currentNode = _settings; [settingsPathComponents enumerateObjectsUsingBlock:^(id pathComponent, NSUInteger idx, BOOL *stop) { id nextNode = currentNode[pathComponent]; BOOL nextNodeIsNil = (nextNode == nil); BOOL nextNodeIsDictionary = [nextNode isKindOfClass:[NSMutableDictionary class]]; BOOL lastPathComponent = (idx == [settingsPathComponents count] - 1); if ((nextNodeIsNil || !nextNodeIsDictionary) &amp;&amp; !lastPathComponent) { [currentNode setObject:[NSMutableDictionary new] forKey:pathComponent]; } else if (idx == [settingsPathComponents count] - 1) { if ([value isKindOfClass:[NSNumber class]]) currentNode[pathComponent] = [value copy]; else currentNode[pathComponent] = [value mutableCopy]; } currentNode = currentNode[pathComponent]; }]; [self BGPrivateMethod_saveSettings]; } - (id)valueForSettingsPath:(NSString *)settingsPath { NSArray *settingsPathComponents = [settingsPath componentsSeparatedByCharactersInSet:self .pathDelimiters]; __block id currentNode = _settings; __block id valueForSettingsPath = nil; [settingsPathComponents enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) { // we have a nil node for a path component which is not the last one // or a node which is not a leaf node if ((nil == currentNode &amp;&amp; idx != [settingsPathComponents count]) || (currentNode != nil &amp;&amp; ![currentNode isKindOfClass:[NSDictionary class]])) { [self BGPrivateMethod_throwExceptionForInvalidSettingsPath]; } NSString *key = obj; id nextNode = currentNode[key]; if (nil == nextNode) { *stop = YES; } else { if (![nextNode isKindOfClass:[NSMutableDictionary class]]) valueForSettingsPath = nextNode; } currentNode = nextNode; }]; return valueForSettingsPath; } - (BOOL)boolValueForSettingsPath:(NSString *)settingsPath { return [[self valueForSettingsPath:settingsPath] boolValue]; } - (NSInteger)integerValueForSettingsPath:(NSString *)settingsPath { return [[self valueForSettingsPath:settingsPath] integerValue]; } - (NSUInteger)unsignedIntegerValueForSettingsPath:(NSString *)settingsPath { return (NSUInteger) [[self valueForSettingsPath:settingsPath] integerValue]; } - (CGFloat)floatValueForSettingsPath:(NSString *)settingsPath { return [[self valueForSettingsPath:settingsPath] floatValue]; } - (NSString *)stringValueForSettingsPath:(NSString *)settingsPath { return (NSString *) [self valueForSettingsPath:settingsPath]; } - (NSArray *)arrayValueForSettingsPath:(NSString *)settingsPath { return (NSArray *) [self valueForSettingsPath:settingsPath]; } - (NSDictionary *)dictionaryValueForSettingsPath:(NSString *)settingsPath { return (NSDictionary *) [self valueForSettingsPath:settingsPath]; } - (NSData *)dataValueForSettingsPath:(NSString *)settingsPath { return (NSData *) [self valueForSettingsPath:settingsPath]; } - (NSString *)description { return [_settings description]; } #pragma mark - Private methods - (void)BGPrivateMethod_saveSettings { [[NSUserDefaults standardUserDefaults] setValue:_settings forKey:kBGSettingManagerUserDefaultsStoreKeyForMainSettings]; [[NSUserDefaults standardUserDefaults] setValue:_defaultSettings forKey:kBGSettingManagerUserDefaultsStoreKeyForDefaultSettings]; [[NSUserDefaults standardUserDefaults] synchronize]; } - (void)BGPrivateMethod_loadExistingSettings { id settings = [[NSUserDefaults standardUserDefaults] valueForKey:kBGSettingManagerUserDefaultsStoreKeyForMainSettings]; id defaultSettings = [[NSUserDefaults standardUserDefaults] valueForKey:kBGSettingManagerUserDefaultsStoreKeyForDefaultSettings]; _settings = (settings ? settings : [NSMutableDictionary new]); _defaultSettings = (defaultSettings ? defaultSettings : [NSMutableDictionary new]); } - (NSMutableDictionary *)BGPrivateMethod_deepMutableCopy:(NSDictionary *)settings { NSMutableDictionary *deepMutableCopy = [settings mutableCopy]; [settings enumerateKeysAndObjectsUsingBlock:^(id key, id obj, BOOL *stop) { if ([obj isKindOfClass:[NSDictionary class]]) deepMutableCopy[key] = [self BGPrivateMethod_deepMutableCopy:obj]; else deepMutableCopy[key] = obj; }]; return deepMutableCopy; } - (void)BGPrivateMethod_throwExceptionForInvalidSettingsPath { if (self.throwExceptionForUnknownPath) [NSException raise:@"Invalid settings path." format:@"Some of your setting path components may intersect incorrectly or they don't exist."]; } @end</span></span></code> </pre><br><br>  It is very simple to use and, as I later found out and understood, it is convenient: <br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// CODE -- begin BGSettingsManager *settingsManager = [BGSettingsManager shared]; [settingsManager createDefaultSettingsFromDictionary:@{ @"user": @{ @"info":@{ @"name": @"Andrew", @"surname": @"Shmig", @"age": @22 } } }]; [settingsManager resetToDefaultSettings]; [settingsManager setValue:@"+7 920 930 87 56" forSettingsPath:@"user.info.contacts.phone"]; NSLog(@"%@", settingsManager); [settingsManager clear]; NSLog(@"%@", settingsManager); // CODE - end</span></span></code> </pre><br><br>  In the console we get the following output: <br><br><pre> <code class="objectivec hljs"><span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-30</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">03.842</span></span> BGUtilityLibrary[<span class="hljs-number"><span class="hljs-number">13730</span></span>:<span class="hljs-number"><span class="hljs-number">70</span></span>b] { user = { info = { age = <span class="hljs-number"><span class="hljs-number">22</span></span>; contacts = { phone = <span class="hljs-string"><span class="hljs-string">"+7 920 930 87 56"</span></span>; }; name = Andrew; surname = Shmig; }; }; } <span class="hljs-number"><span class="hljs-number">2014</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-30</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">45</span></span>:<span class="hljs-number"><span class="hljs-number">03.847</span></span> BGUtilityLibrary[<span class="hljs-number"><span class="hljs-number">13730</span></span>:<span class="hljs-number"><span class="hljs-number">70</span></span>b] { }</code> </pre><br><br>  Go to the game screen.  This screen became really ‚Äúbloody‚Äù for me ... the fact is that at the very beginning, when you clicked on the Play button, a transition to the game screen took place and there, the field (SKScene) was generated and filled in the viewDidLoad method, but the delay was so big that I had to ask questions: <br><br><ul><li>  Will preloading sprites help? </li><li>  Will creating a single SKNode help, adding sprites to it and only then adding to SKScene? </li></ul><br><br>  For both questions, the answer is "No."  The first question arises from the second ... the whole problem is that the addChild: method works extremely slowly, which is why you should try to keep as few nodes on the stage as possible.  By the way, the FPS on my simulator did not raise more than 30, the device produced a clean 60. <br><br>  Method of scientific poking and questions on SO: <br>  1. <a href="https://stackoverflow.com/questions/23027173/skspritenode-takes-too-much-time-to-be-created-from-texture">SKSpriteNode takes too much time to be created from texture</a> <br>  2. <a href="https://stackoverflow.com/questions/23070591/strange-thing-happens-with-skspritenode-with-transparent-borders">Strange thing happens with SKSpriteNode with transparent borders</a> (not quite on this issue, but also a very interesting point) <br><br>  He came to the fact that he created the game screen in the form of a singleton, which is initialized when the application starts, the field is filled only with grass (the bottom layer is generated only after the user has clicked on a cell ... this decision was also made because same pressing the user should not get on the mine). <br>  All the sprites are preloaded, then they are copied, and not re-created, because the process of creating a sprite from the texture already loaded into memory turned out to be very slow and loses to simple copying. <br>  Sounds are also loaded when the application is launched as follows: <br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//         NSArray *audioResources = @[@"switchON.mp3", @"switchOFF.mp3", @"flagTapOn.mp3", @"grassTap.mp3", @"buttonTap.mp3", @"flagTapOff.mp3", @"explosion.wav"]; for (NSString *audioName in audioResources) { [[BGResourcePreloader shared] preloadAudioResource:audioName]; }</span></span></code> </pre><br><br>  After each change of the settings, the field is updated (regenerated and filled with sprites) so that there is no delay during the quick transition. <br><br>  In the section on design, I mentioned that working with custom fonts is still fun - it is.  Not only is the font name! = The name of the font file, this infection also slows down well without preloading the font (unfortunately all the screens from the Instruments have been removed for a long time, but it will not be difficult to verify). <br><br>  My field is filled (generated) like this: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)generateFieldWithExcludedCellInCol:(<span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span>)cellCol row:(<span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span>)cellRow { BGLog(); <span class="hljs-comment"><span class="hljs-comment">//   NSMutableArray *cells = [NSMutableArray new]; //     _field = [NSMutableArray new]; for (NSUInteger i = 0; i &lt; self.cols; i++) { [_field addObject:[NSMutableArray new]]; for (NSUInteger j = 0; j &lt; self.rows; j++) { [_field[i] addObject:@(BGFieldEmpty)]; //    ,    "" if (!(i == cellCol &amp;&amp; j == cellRow)) [cells addObject:@(i * kBGPrime + j)]; } } //      sranddev(); for (NSUInteger i = 0; i &lt; self.bombs; i++) { NSUInteger index = arc4random() % [cells count]; NSUInteger randomCell = [cells[index] unsignedIntegerValue]; NSUInteger col = randomCell / kBGPrime; NSUInteger row = randomCell % kBGPrime; _field[col][row] = @(BGFieldBomb); //    [cells removeObjectAtIndex:index]; } //   _x = @[@0, @1, @1, @1, @0, @(-1), @(-1), @(-1)]; _y = @[@(-1), @(-1), @0, @1, @1, @1, @0, @(-1)]; for (NSUInteger i = 0; i &lt; self.cols; i++) { for (NSUInteger j = 0; j &lt; self.rows; j++) { NSInteger cellValue = [_field[i][j] integerValue]; NSInteger count = 0; if (cellValue == BGFieldEmpty) { for (NSUInteger k = 0; k &lt; _x.count; k++) { NSInteger newY = i + [_x[k] integerValue]; NSInteger newX = j + [_y[k] integerValue]; if (newX &gt;= 0 &amp;&amp; newY &gt;= 0 &amp;&amp; newX &lt; self.rows &amp;&amp; newY &lt; self.cols) { if ([_field[(NSUInteger) newY][(NSUInteger) newX] integerValue] == BGFieldBomb) { count++; } } } _field[i][j] = @(count); } } } }</span></span></code> </pre><br><br>  Aside, there are details of working with SKAction, which at first glance seem convenient, but in the sapper I was faced with the need to combine them in such a way as to preserve the readable code, but alas ... it worked out with great difficulty. <br><br><h4>  App Store </h4><br>  Briefly and clearly: <br><br><img src="//habrastorage.org/files/c9c/6fc/a6b/c9c6fca6bf704358ba2c50eecf4f911e.png"><br><br><h4>  the end </h4><br>  Thank you all for your attention. <br><br>  Any questions in the comments and happy to answer them.  If you forgot to specify in the article - write. <br><br>  In the near future I plan to open the project completely and put it on GitHub, but first the things planned will be implemented. </div><p>Source: <a href="https://habr.com/ru/post/221519/">https://habr.com/ru/post/221519/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../221505/index.html">How I bought the camera</a></li>
<li><a href="../221509/index.html">As we opened and then closed the anti-cafe, people-oriented network</a></li>
<li><a href="../221511/index.html">Samsung launches SSD technology on 3 bits per cell for data centers</a></li>
<li><a href="../221513/index.html">Solving the problem with non-bootable configs in Thinstation 5</a></li>
<li><a href="../221515/index.html">Long ago, when Habr was without invites, and Bash could be read completely in 2 days, we did satellite Internet in Astrakhan</a></li>
<li><a href="../221521/index.html">Asynchronous Php extension to work with Cassandra without Thrift</a></li>
<li><a href="../221525/index.html">One approach to debugging solutions for SharePoint</a></li>
<li><a href="../221527/index.html">Is fundamental education in CS important and a view from Yandex on professions in the world of information technology?</a></li>
<li><a href="../221529/index.html">The seventh issue of TsODY.RF magazine</a></li>
<li><a href="../221531/index.html">Linux for professionals: video editing (and a bit of compositing)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>