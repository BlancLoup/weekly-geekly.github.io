<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RBAC Authorization in YII and LDAP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="RBAC is a simple and powerful way to centrally control access to a web application. Its main advantage is that with the right understanding and applic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RBAC Authorization in YII and LDAP</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/storage2/959/c1e/e6f/959c1ee6fb41883031ffb7a3eff4e80c.png"><br>  <a href="http://ru.wikipedia.org/wiki/Rbac">RBAC</a> is a simple and powerful way to centrally control access to a web application.  Its main advantage is that with the right understanding and application of the authorization hierarchy, you can very flexibly control access without changing the code of the controllers. <br><br>  Unfortunately, the standard RBAC manual in YII leaves more questions than answers.  I intend to correct this situation. <br>  I will talk about creating the ‚Äúright‚Äù hierarchy: how to do it is not worth it.  And in the end, I saved the instruction on how to make LDAP authorization (from ActiveDirectory) friends with Yii and RBAC. <br><br>  All who are interested, welcome under the cat! <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      RBAC <i>(Role Based Access Control) Role-based access</i> system.  The basis of this system in Yii consists of three main links: <br><ul><li>  Role </li><li>  Task (Task) </li><li>  Operation (Operaton) </li></ul><br>  I assume that the reader has already briefly familiarized himself with the <a href="">page of the official textbook YII</a> and knows the basic principles of the authorization mechanism in Yii. <br><br>  Therefore, we proceed immediately to building the correct hierarchy of authorization elements. <br><br><h4>  Role hierarchy </h4><br>  The most important, and the most confusing, is the hierarchy of elements in RBAC.  It depends on how well it is thought out how flexible you can manage roles in the system, and how often you will have to change the controller code. <br><br>  Let's take a closer look at each authorization element: <br><ul><li>  <b>The operation</b> is the lowest element of authorization.  That is what we should check in the code of our controllers.  In other words: an operation is something that clings to code. </li><li>  <b>Role</b> is the opposite, the highest element of authorization, which groups in itself operations and tasks.  And that is the role we should attach to users. </li><li>  <b>Task</b> - This is an optional element between the operation and the role, and narrows the rights of the operation using bizRule.  To facilitate understanding, let's call it a <b>filter</b> . </li></ul><br><img src="https://habrastorage.org/storage2/5f3/6c2/ac1/5f36c2ac124609f3e99233da7d9d6720.png"><br><br>  The diagram above shows a typical hierarchy, where controllers check operations, and roles are attached to users.  However, YII does not prevent you from checking something else in the controller, for example, the user's role. <br>  But you must remember that this is WRONG and leads to the fact that you lose the benefits of centralized management. <br><br>  Consider an example: <br>  We have news, to the management of which we want to differentiate access. <br>  The first thing we have to do when designing RBAC is to consider possible OPERATIONS (and not user roles, as it seems at first glance). <br><br>  News can usually be <b>deleted</b> , <b>created</b> , <b>read</b> and <b>edited</b> .  <b>Let's</b> transform these actions into operations: <b>deleteNews</b> , <b>createNews</b> , <b>readNews</b> , <b>updateNews</b> . <br><br>  In the code, you can check any of these operations: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Yii::app()-&gt;user-&gt;checkAccess(<span class="hljs-string"><span class="hljs-string">'createNews'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//   } // if(Yii::app()-&gt;user-&gt;checkAccess('updateNews')) { //   }</span></span></code> </pre> <br>  After the operations are thought out, you can move on to the roles (I deliberately skip tasks, we'll talk about them a bit later): <br><br>  From the available operations we can distinguish the following roles: <br>  <b>newsReader</b> , <b>newsManager</b> , <b>newsAuthor</b> . <br><br>  The hierarchy of elements will be as follows: <br><ul><li>  newsReader <ul><li>  readNews </li></ul></li><li>  newsAuthor <ul><li>  readNews </li><li>  createNews </li></ul></li><li>  newsManager <ul><li>  readNews </li><li>  createNews </li><li>  deleteNews </li><li>  updateNews </li></ul></li></ul><br>  These roles can be attached to specific users.  But it is better to create one more abstraction of roles more generalized, and attach it to users, for example: <br><br><ul><li>  guest <ul><li>  newsReader </li></ul></li><li>  authorized <ul><li>  newsAuthor </li></ul></li><li>  moderator <ul><li>  newsManager </li></ul></li></ul><br>  Such an abstraction is convenient if we have to manage not only the news, but also, say, pictures in the photo gallery or goods in the store.  Then for each such section of your system you need to create your ‚Äúintermediate‚Äù roles, for example, <i>photoReader (showPhoto)</i> , <i>photographer (showPhoto, addPhoto)</i> , <i>photoManager (showPhoto, addPhoto, deletePhoto)</i> and attach them to generic roles: <br><br><ul><li>  guest <ul><li>  newsReader </li><li>  photoReader </li></ul></li><li>  authorized <ul><li>  newsAuthor </li><li>  photographer </li></ul></li><li>  moderator <ul><li>  newsManager </li><li>  photoManager </li></ul></li></ul><br>  Those.  it can be read as: a guest can read the news and watch a photo;  authorized user can write news and add photos;  the moderator can do all of the above, as well as edit and delete someone else's photos and news. <br><br>  You have probably noticed that the update operation is not available for the newsAuthor and the photographer roles.  That's right, because if at this stage we give them the updateNews or updatePhoto operations, then they will be able to manage all the photos indiscriminately.  And we need that the authors could edit only their elements. <br><br>  That is what created the problem.  Tasks are filters that can clarify rights.  Create an <b>updateOwnNews</b> task, with a descendant of which we assign <b>updateNews</b> .  From the title of the task it is clear that it will allow you to edit your own news, and bizRule will help us in this. <br><br>  <b>bizRule</b> is a certain PHP code, the result of which should be the answer: whether to apply this rule to this user or not. <br><br>  The bizRule for our updateOwnNews task will look like this: <br><pre> <code class="php hljs">$bizRule=<span class="hljs-string"><span class="hljs-string">'return Yii::app()-&gt;user-&gt;id==$params["news"]-&gt;authID;'</span></span>;</code> </pre><br>  Where we check if the news author‚Äôs id is the same as the current authorized user. <br><br>  To get the current news item in a business rule, you must first pass it there: <br><br><pre> <code class="php hljs">$params=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'news'</span></span>=&gt;$post); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Yii::app()-&gt;user-&gt;checkAccess(<span class="hljs-string"><span class="hljs-string">'updateNews'</span></span>,$params)) { <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre><br>  Note that we are not checking for a specific task ( <i>updateOwnNews</i> ), but for the <i>updateNews</i> operation (the lowest element of the hierarchy). <br><br>  Thanks to the hierarchy, which after the creation of the updateOwnNews task has become such: <br><br><ul><li>  newsAuthor <ul><li>  readNews </li><li>  createNews </li><li>  updateOwnNews <ul><li>  updateNews </li></ul></li></ul></li></ul><br>  Yii will start the access check from the bottom and go up the hierarchy, i.e.  will check updateNews, then go to updateOwnNews.  At each stage of the check, Yii will check whether the bizRule is set, and if set, it will pass to it the parameters specified in the checkAccess function. <br><br>  Schematically, the test can be represented as: <br><br><img src="https://habrastorage.org/storage2/c39/9f4/6b5/c399f46b52fd88489ed7b805d9279c6d.png"><br><br>  The diagram shows 3 verification scripts: <br>  The first scenario is when an authorized user tries to edit their news.  In this case, checking up from the bottom up goes through <i>updateOwnNews</i> .  And since the user IDs are the same, they succeed. <br><br>  In the second case, the user has the role of moderator.  There is no <i>updateOwnNews</i> task in its hierarchy, so only the existence of the updateNews operation is checked. <br>  Verification is successful. <br><br>  In the third case, an authorized user tries to edit someone else's article, and at the <i>updateOwnNews</i> stage <i>, the</i> check fails, because  not satisfied bizRule task. <br><br>  The examples above demonstrate centralized rights management. <br>  Having written a check on the execution of the operation once in the controller and passing the parameter there, all further work on access control falls on RBAC. <br>  Therefore, if possible, you should <b>always</b> pass parameters to the <i>checkAccess</i> function (even if the element being checked does not have a bizRule), and check the operation, not the role. <br><br>  If the controller in one condition you want to write more than one check - you know, you are going in the wrong direction - you have problems with the organization of the hierarchy. <br><br>  For example: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Yii:app()-&gt;user-&gt;checkAccess(<span class="hljs-string"><span class="hljs-string">'moderator'</span></span>) &amp;&amp; Yii:app()-&gt;user-&gt;checkAccess(<span class="hljs-string"><span class="hljs-string">'administrator'</span></span>)) { <span class="hljs-comment"><span class="hljs-comment">//delete smth }</span></span></code> </pre><br>  It is not right.  With this approach, you can not centrally manage rights.  Each time you have to edit the code and add a new condition here. <br><br><h4>  Ways to verify rights in controllers </h4><br>  There are 2 ways to verify rights. <br>  The first method we have already considered.  This is the <i>checkAccess ()</i> method of the <i>CWebUser</i> component. <br><br>  But for those who care that their controllers are not ‚Äúplumper‚Äù, there is another <a href="http://habrahabr.ru/post/165329/">aspect-oriented</a> way to verify rights. <br><br>  The method is to connect to the controller filter 'accessControl'. <br><br>  This filter will do all the dirty work for you: it will check for the access rights and, if necessary, send the user to page 403. Thus, you will not have to duplicate the code of checks in each action. <br><br>  Consider the filter operation on the example of the news controller: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewsController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CController</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'accessControl'</span></span>, ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accessRules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'allow'</span></span>, <span class="hljs-string"><span class="hljs-string">'actions'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'create'</span></span>), <span class="hljs-string"><span class="hljs-string">'roles'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'createNews'</span></span>), ), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'allow'</span></span>, <span class="hljs-string"><span class="hljs-string">'actions'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'delete'</span></span>), <span class="hljs-string"><span class="hljs-string">'roles'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'deleteNews'</span></span>), ), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'allow'</span></span>, <span class="hljs-string"><span class="hljs-string">'actions'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'view'</span></span>), <span class="hljs-string"><span class="hljs-string">'roles'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'readNews'</span></span>), ), <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'allow'</span></span>, <span class="hljs-string"><span class="hljs-string">'actions'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'update'</span></span>), <span class="hljs-string"><span class="hljs-string">'roles'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'updateNews'</span></span>), ), ); } ... }</code> </pre><br>  In the <i>accessRules</i> function <i>,</i> we specify 4 rules, each of which is an array.  Where the <b><i>actions</i></b> key indicates for which Actions we apply the rule, and the <b><i>roles</i></b> key for which roles. <br><br>  It should be noted that in spite of the fact that the key is called 'roles', any element of authorization can be entered there, be it an operation or a task.  But as we all know, in the controllers we need to check <u>only the</u> operations, therefore, they are written in the example above. <br><br>  This filter helps us get rid of many lines of pass-through code in actions.  However, there is a problem: we need to transfer the current news to 'updateNews', so that the bizRule defined in updateOwnNews will work correctly. <br><br>  To understand how you can pass parameters to the filter, I had to get into the framework code and peep there.  Fortunately, with version 1.1.11 this possibility has appeared. <br><br>  To pass parameters, you need to write a rule like this: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'roles'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'newsUpdate'</span></span>=&gt;<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'news'</span></span>=&gt;$news))</code> </pre><br>  However, the problems do not end there.  The filter is launched BEFORE any action, which means we have not yet created a news item that we could transmit. <br><br>  The solution may be the following approach: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $model; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accessRules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( ... <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'allow'</span></span>, <span class="hljs-string"><span class="hljs-string">'actions'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'update'</span></span>), <span class="hljs-string"><span class="hljs-string">'roles'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'updateNews'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'news'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;news )), ), ... ); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNews</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;actionParams[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;loadModel(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;actionParams[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model = News::model()-&gt;findByPk($id); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">'The requested page does not exist.'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;model; }</code> </pre><br>  Here I create a getter for the news field in which I get the news model via the loadModel function.  But in order not to pull the base several times (at the beginning when checking the rights, and then in the action itself), I created a closed $ model field into which I cached the model. And the next time the loadModel function is called, the model will be obtained from the property, and not from the base. <br><br>  Unfortunately, this method is not suitable if you need to send parameters to the rule that require more complex logic.  Therefore, it remains to use checkAccess () for such cases; <br><br><h4>  RBAC Yii and LDAP </h4><br>  LDAP is the Lightweight Directory Access Protocol, the ‚Äúlightweight directory access protocol,‚Äù Wikipedia tells us.  In our case, we will get access to the ActiveDirectory directory, in order to authorize users from the corporate network using their login and password. <br><br>  PHP has built-in support for LDAP, and therefore you don‚Äôt have to invent anything, and there are also many ready-made components that provide a convenient interface for accessing directories. <br><br>  I used the <a href="http://adldap.sourceforge.net/">adLdap</a> component because  it is sharpened exactly under ActiveDirectory, it provides a simple and convenient OOP API and it‚Äôs just a pleasure to work with it. <br><br>  First, I connected adLdap to Yii as an application component, i.e .: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//protected/config/main.php 'components' =&gt; array( ... 'ldap' =&gt; array( 'class' =&gt; 'LdapComponent', 'baseDn' =&gt; 'DC=example,DC=org', //example.org 'accountSuffix' =&gt; '@example.org', 'domainControllers' =&gt; array('dc.example.org'), 'adminUsername' =&gt; 'username', 'adminPassword' =&gt; 'password' ), .. )</span></span></code> </pre><br>  The LdapComponent class itself: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//protected/components/LdapComponent.php Yii::import('application.vendors.adLDAP.adLDAP'); class LdapComponent extends adLDAP { public $baseDn; public $accountSuffix; public $domainControllers; public $adminUsername; public $adminPassword; public function __construct() { } public function init() { parent::__construct(); } }</span></span></code> </pre><br>  Configuring adLdap is done by overriding its properties.  I wanted to bring the settings of this component to the config in the usual format for the Yii programmer. Therefore, I redefined the required fields, changing their visibility attribute (so that Yii could configure the component) and transfer the constructor to the init () method so that the constructor is called AFTER The object will be configured (fields are filled). <br><br>  Next, we can simply use this component like all the others in Yii: <br><pre> <code class="php hljs">Yii::app()-&gt;ldap</code> </pre><br>  For authorization using LDAP, you need to create the standard components required for authorization in Yii: <i>UserIdentity</i> and <i>WebUser</i> : <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//protected/components/LdapIdentity.php class LdapIdentity extends CUserIdentity { protected $_id; /** * Authenticates a user via LDAP. * @return boolean whether authentication succeeds. */ public function authenticate() { $ldap = Yii::app()-&gt;ldap; $result = $ldap-&gt;authenticate($this-&gt;username, $this-&gt;password); $ldapUserInfo = $ldap-&gt;user()-&gt;infoCollection($this-&gt;username, array("mail", "displayname")); $this-&gt;setState('fullname', $ldapUserInfo-&gt;displayname); $this-&gt;setState('email', $ldapUserInfo-&gt;mail); if (!$result) { $this-&gt;errorCode = self::ERROR_USERNAME_INVALID; } else { $dbUser = User::model()-&gt;findByAttributes(array('ldap' =&gt; $this-&gt;username)); if (!$dbUser) { $dbUser = new User(); $dbUser-&gt;ldap = $this-&gt;username; $dbUser-&gt;save(); } $this-&gt;_id = $dbUser-&gt;primaryKey; $this-&gt;errorCode = self::ERROR_NONE; } return !$this-&gt;errorCode; } public function getId() { return $this-&gt;_id; } }</span></span></code> </pre><br>  In the code above, we override the methods authenticate of the CUserIdentity class in order to implement our authorization logic.  We are trying to authorize this user in AD through adLdap, and if successful, then enter his name and email in the permanent storage. <br><br>  In addition to LDAP, I decided to keep additional information about users in the database, so after successful authorization, it is checked whether there is already a row in the database for this user, and if not, it is created. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//protected/components/LdapUser.php class LdapUser extends CWebUser { protected $_groups = null; protected $_model; /** * * @return type */ public function getGroups() { if ($this-&gt;_groups === null) { if ($user = $this-&gt;getModel()) { $this-&gt;_groups = Yii::app()-&gt;ldap-&gt;user()-&gt;groups($user-&gt;ldap); } } return $this-&gt;_groups; } /** * * @return User */ public function getModel() { if (!$this-&gt;isGuest &amp;&amp; $this-&gt;_model === null) { $this-&gt;_model = User::model()-&gt;findByPk($this-&gt;id); } return $this-&gt;_model; } }</span></span></code> </pre><br>  The LdapUser class is almost the same as the standard, except for the function LdapUser :: getGroups (), which is important for us.  This function, as it is not difficult to guess, returns all groups from this user from AD. <br><br>  I decided to make user groups in ActiveDirectory roles in the Yii application. <br>  Those.  We will assign roles not to specific users, but to groups.  And which group to assign to will be managed centrally through AD. <br>  This is very convenient in corporate portals and other internal resources, since  together with the rights to printers, folders, and other office infrastructure, the user will immediately be given rights to sections in the corporate website.  At the same time, the IT department specialists do not need to explain anything, they just do their job ‚Äúas usual‚Äù. <br><br>  In order to assign roles to users, I redefined the CPhpAuthManager class: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PhpAuthManager</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CPhpAuthManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      auth.php   config  if ($this-&gt;authFile === null) { $this-&gt;authFile = Yii::getPathOfAlias('application.config.auth') . '.php'; } parent::init(); //          guest. if (!Yii::app()-&gt;user-&gt;isGuest) { //    AD     $existingRoles = $this-&gt;getRoles(); if (Yii::app()-&gt;user-&gt;groups) { foreach (Yii::app()-&gt;user-&gt;groups as $group) { if ($existingRoles[$group]) { $this-&gt;assign($group, Yii::app()-&gt;user-&gt;id); } } } } } }</span></span></code> </pre><br>  In the code above, we take a list of groups in which the user is a member, check whether the role of the same name exists, and if it exists, then assign this role to the user. <br><br>  An example of an authentication configuration file with LDAP looks like this: <br><br><pre> <code class="php hljs"> ... <span class="hljs-comment"><span class="hljs-comment">/************************************ ***************ROLES**************** ************************************/</span></span> <span class="hljs-string"><span class="hljs-string">'newsReader'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; CAuthItem::TYPE_ROLE, <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'bizRule'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'readNews'</span></span>, ), ), <span class="hljs-string"><span class="hljs-string">'newsAuthor'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; CAuthItem::TYPE_ROLE, <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'bizRule'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'newsReader'</span></span>, <span class="hljs-string"><span class="hljs-string">'createNews'</span></span>, <span class="hljs-string"><span class="hljs-string">'updateOwnNews'</span></span>, <span class="hljs-string"><span class="hljs-string">'deleteOwnNews'</span></span> ), ), <span class="hljs-string"><span class="hljs-string">'newsManager'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'type'</span></span> =&gt; CAuthItem::TYPE_ROLE, <span class="hljs-string"><span class="hljs-string">'description'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'bizRule'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'data'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">'children'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'newsReader'</span></span>, <span class="hljs-string"><span class="hljs-string">'createNews'</span></span>, <span class="hljs-string"><span class="hljs-string">'updateNews'</span></span>, <span class="hljs-string"><span class="hljs-string">'deleteNews'</span></span>, ), ), <span class="hljs-comment"><span class="hljs-comment">// 'requestCreator' =&gt; array( 'type' =&gt; CAuthItem::TYPE_ROLE, 'description' =&gt; '', 'bizRule' =&gt; NULL, 'data' =&gt; NULL, 'children' =&gt; array( 0 =&gt; 'createRequest', ), ), 'requestManager' =&gt; array( 'type' =&gt; CAuthItem::TYPE_ROLE, 'description' =&gt; '', 'bizRule' =&gt; NULL, 'data' =&gt; NULL, 'children' =&gt; array( 'createRequest', 'viewRequests', 'manageRequests', ), ), /************************************ **********ROLES ASSIGMENTS********** ************************************/ 'developers' =&gt; array( 'type' =&gt; CAuthItem::TYPE_ROLE, 'description' =&gt; '', 'bizRule' =&gt; NULL, 'data' =&gt; NULL, 'children' =&gt; array( 'newsManager', 'requestManager', ), ), 'departamentBoss'=&gt; array( 'type' =&gt; CAuthItem::TYPE_ROLE, 'description' =&gt; '', 'bizRule' =&gt; NULL, 'data' =&gt; NULL, 'children' =&gt; array( 'requestCreator' , ), ),</span></span></code> </pre><br>  In the ROLES section, we describe ‚Äúintermediate‚Äù roles.  Then in the ROLES ASSIGMENTS section, we describe groups from AD, and assign intermediate roles to them. <br><br>  The above config can be read like this: <br>  All actions with news (newsManager) and with requests (requestManager) will be available for the <i>developers</i> group, and only the creation of applications will be available for the <i>departamentBoss</i> group. <br><br><h4>  Conclusion </h4><br>  The role mechanism in Yii is truly flexible if used correctly. <br>  Future plans include the creation or adaptation of a GUI solution for managing roles, since  even with a small number of actions, the system becomes confusing, and the amount of writings is unjustified. <br>  I urge all users to discuss: how did they implement the rights management system in Yii projects, and what advice from personal experience might be useful to others? <br><br><h4>  What else to read: </h4><br><ul><li>  <a href="">Yii Official Guide</a> </li><li>  <a href="http://phptime.ru//yii/2012/12/05/perevod-kak-razobratsya-v-ierarhicheskoy-sisteme-rbac.html">A good article on how the hierarchy of rights + experience from another person works.</a> </li><li>  <a href="http://www.yiiframework.com/forum/index.php/topic/8381-%25D1%2580%25D0%25B5%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F-rbac-%25D0%25B2-yii/">Discussion on the forum, from which I once learned a lot of useful things (read posts creocoder)</a> </li><li>  <a href="http://ru.wikipedia.org/wiki/LDAP">LDAP on Wikipedia</a> </li><li>  <a href="http://adldap.sourceforge.net/wiki/doku.php%3Fid%3Ddocumentation">AdLdap manual</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/177873/">https://habr.com/ru/post/177873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../177857/index.html">Swype keyboard release for Android</a></li>
<li><a href="../177859/index.html">How the glasses are arranged Google Glass</a></li>
<li><a href="../177861/index.html">Upgrade to Android 4.1 on Xperia P, Xperia go and Xperia E dual</a></li>
<li><a href="../177863/index.html">DIY: Mobile Testing</a></li>
<li><a href="../177869/index.html">Apple sent out invitations to WWDC 2013</a></li>
<li><a href="../177875/index.html">Do you plan to leave Russia forever before 2017?</a></li>
<li><a href="../177879/index.html">We read Habr, xkcd and rss on kindle</a></li>
<li><a href="../177881/index.html">Unity3d stops supporting Flash</a></li>
<li><a href="../177883/index.html">Avast! removes sndvol32.exe (volume control) as a virus</a></li>
<li><a href="../177885/index.html">We configure Windows for programming of OpenGL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>