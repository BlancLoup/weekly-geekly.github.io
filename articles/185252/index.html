<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>C ++ notification area icon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Let's write together a small utility in C ++. Let our program track something in the system and show an icon in the notification area when something h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>C ++ notification area icon</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/b1b/56b/a5f/b1b56ba5f69dec105d9cbd790b163bb4.png"><br>  Let's write together a small utility in C ++.  Let our program track something in the system and show an icon in the notification area when something happened.  For example, the check will be for the presence of a file or a mounted drive.  No file - one icon, a file appeared - the icon has changed. <br>  I have such an icon that monitors the connection of an encrypted disk.  Maybe someone needs to monitor the appearance of a protocol file with errors or the presence of a connection to a network drive. <br><a name="habracut"></a><br>  For development, you can use the free Visual C ++ Express Edition. <br>  Choose to create a new Win32 Project and name the project ‚ÄúTray.‚Äù  Click the Next button to go to the project settings and check the Empty Project box. <br><br><h4>  Let's start with a greeting </h4><br>  Add a file (.cpp) to the C ++ project and name it ‚ÄúTray‚Äù.  Let's start with a practically minimal program.  Try to enter its text and run. <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;tchar.h&gt; //   int APIENTRY _tWinMain(HINSTANCE instance, HINSTANCE, LPTSTR, int) { MessageBox(0, TEXT(""), TEXT(""), 0); return 0; }</span></span></span></span></code> </pre> <br>  Calling MessageBox () shows a greeting, and then the program exits.  If you succeed, move on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Main window </h4><br>  We don‚Äôt need a window in principle - the user interface is represented by an icon.  But a window is required to create an icon and process its messages. <br>  To create a window, you need to define the WndProc () message handling function, register the window class in the WNDCLASSEX structure, and actually create the window using the CreateWindowEx () function. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;tchar.h&gt; //   LRESULT CALLBACK WndProc(HWND window, UINT message, WPARAM wParam, LPARAM lParam) { switch (message) { //    case WM_DESTROY: PostQuitMessage(0); break; default: return DefWindowProc(window, message, wParam, lParam); } return 0; } //   int APIENTRY _tWinMain(HINSTANCE instance, HINSTANCE, LPTSTR, int) { //    WNDCLASSEX main = { 0 }; main.cbSize = sizeof(WNDCLASSEX); main.hInstance = instance; main.lpszClassName = TEXT("Main"); main.lpfnWndProc = WndProc; RegisterClassEx(&amp;main); //    HWND window = CreateWindowEx(0, TEXT("Main"), NULL, 0, 0, 0, 0, 0, NULL, NULL, instance, NULL); MessageBox(0, TEXT(""), TEXT(""), 0); return 0; }</span></span></span></span></code> </pre><br>  Our main window will never be displayed, so all the parameters are filled to the minimum.  Try to start the program - nothing has changed in its work. <br><br><h4>  Display icon </h4><br>  The actual output of the icon is performed by the Shell_NotifyIcon () function.  She needs the NOTIFYICONDATA structure as a parameter, and this structure should have a window handle. <br>  We will store the NOTIFYICONDATA structure in the global variable Icon, since  She still useful to us.  We will create the icon before the welcome window, and before leaving the program, delete it. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;tchar.h&gt; //   NOTIFYICONDATA Icon = { 0 }; //   //   ... //   int APIENTRY _tWinMain(HINSTANCE instance, HINSTANCE, LPTSTR, int) { //    ... //    ... //   Icon.cbSize = sizeof(NOTIFYICONDATA); Icon.hWnd = window; Icon.uVersion = NOTIFYICON_VERSION; Icon.uCallbackMessage = WM_USER; Icon.hIcon = LoadIcon(NULL, IDI_SHIELD); Icon.uFlags = NIF_MESSAGE | NIF_ICON; Shell_NotifyIcon(NIM_ADD, &amp;Icon); MessageBox(0, TEXT(""), TEXT(""), 0); //   Shell_NotifyIcon(NIM_DELETE, &amp;Icon); return 0; }</span></span></span></span></code> </pre><br>  Now run the program for execution.  Our icon appears on startup and then disappears when you click OK in the dialog box.  What the icon looks like is indicated in the hIcon parameter.  We put the standard icon IDI_SHIELD there using the LoadIcon () function. <br><br><h4>  Message loop </h4><br>  It is time to remove the welcome dialog.  When you start the program, we will only have an icon in the notification area.  Exit the program will do by right-clicking on the icon.  A window should appear asking you to close the program. <br>  Processing the message from the icon that the mouse button is pressed will be added to the message handling function.  And we will insert the message processing loop where the greeting was. <br><br><pre> <code class="cpp hljs">... <span class="hljs-comment"><span class="hljs-comment">//   LRESULT CALLBACK WndProc(HWND window, UINT message, WPARAM wParam, LPARAM lParam) { switch (message) { //    case WM_USER: if (lParam == WM_RBUTTONDOWN) if (MessageBox(NULL, TEXT(" ?"), TEXT("Tray"), MB_YESNO) == IDYES) DestroyWindow(window); break; //    ... } return 0; } //   int APIENTRY _tWinMain(HINSTANCE instance, HINSTANCE, LPTSTR, int) { //    ... //    ... //   ... //    MSG message; while (GetMessage(&amp;message, NULL, 0, 0)) { TranslateMessage(&amp;message); DispatchMessage(&amp;message); } //   Shell_NotifyIcon(NIM_DELETE, &amp;Icon); return 0; }</span></span></code> </pre><br>  After starting the program shows only the icon, waiting for a mouse button. <br><br><h4>  Timer check </h4><br>  Now it remains to do the things for which everything was started.  Once a second, a file will be checked.  If such a file appears, the icon should change.  The timer is activated by the SetTimer () function, for which the time interval should be specified in milliseconds. <br>  The function itself of checking the existence of a file can be implemented in various ways.  Here's a way to check through getting attributes. <br><br><pre> <code class="cpp hljs">/    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FileExists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PTSTR path)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetFileAttributes(path) != INVALID_FILE_ATTRIBUTES; }</code> </pre><br>  If the GetFileAttributes () function fails to read the file attributes in the specified path, then there is no file.  As a path, you can specify the path to the file, and then we check the existence of the file.  And if you specify the path to the disk, then we check the presence of the disk.  Suppose we check for the presence of the ‚ÄúP:‚Äù drive. <br>  In order not to redraw the icon every time, we will save the previous state in the global variable, and we will call Shell_NotifyIcon () with the new image only if the state has changed.  Here is the full version of the program. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;tchar.h&gt; //   NOTIFYICONDATA Icon = { 0 }; //   bool State = false; //   //    bool FileExists(PTSTR path) { return GetFileAttributes(path) != INVALID_FILE_ATTRIBUTES; } //   LRESULT CALLBACK WndProc(HWND window, UINT message, WPARAM wParam, LPARAM lParam) { switch (message) { //    case WM_TIMER: { bool check = FileExists(TEXT("P:\\")); if (State != check) { if (State) Icon.hIcon = LoadIcon(NULL, IDI_SHIELD); else Icon.hIcon = LoadIcon(NULL, IDI_WARNING); Icon.uFlags = NIF_ICON; Shell_NotifyIcon(NIM_MODIFY, &amp;Icon); State = check; } break; } //    case WM_USER: if (lParam == WM_RBUTTONDOWN) if (MessageBox(NULL, TEXT(" ?"), TEXT("Tray"), MB_YESNO) == IDYES) DestroyWindow(window); break; //    case WM_DESTROY: PostQuitMessage(0); break; default: return DefWindowProc(window, message, wParam, lParam); } return 0; } //   int APIENTRY _tWinMain(HINSTANCE instance, HINSTANCE, LPTSTR, int) { //    WNDCLASSEX main = { 0 }; main.cbSize = sizeof(WNDCLASSEX); main.hInstance = instance; main.lpszClassName = TEXT("Main"); main.lpfnWndProc = WndProc; RegisterClassEx(&amp;main); //    HWND window = CreateWindowEx(0, TEXT("Main"), NULL, 0, 0, 0, 0, 0, NULL, NULL, instance, NULL); //   Icon.cbSize = sizeof(NOTIFYICONDATA); Icon.hWnd = window; Icon.uVersion = NOTIFYICON_VERSION; Icon.uCallbackMessage = WM_USER; Icon.hIcon = LoadIcon(NULL, IDI_SHIELD); Icon.uFlags = NIF_MESSAGE | NIF_ICON; Shell_NotifyIcon(NIM_ADD, &amp;Icon); //   SetTimer(window, 0, 1000, NULL); //    MSG message; while (GetMessage(&amp;message, NULL, 0, 0)) { TranslateMessage(&amp;message); DispatchMessage(&amp;message); } //   Shell_NotifyIcon(NIM_DELETE, &amp;Icon); return 0; }</span></span></span></span></code> </pre><br>  In the Release configuration, the Tray.exe program turned out to be 8 KB in size. </div><p>Source: <a href="https://habr.com/ru/post/185252/">https://habr.com/ru/post/185252/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185242/index.html">Comparison of services for monitoring client sites or insurance for SEO paranoia</a></li>
<li><a href="../185244/index.html">Checkbox "Enable JavaScript" removed from the settings of Firefox 23</a></li>
<li><a href="../185246/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Session 15</a></li>
<li><a href="../185248/index.html">Authentication in a new way, or superkuki</a></li>
<li><a href="../185250/index.html">Summer, vacation, asterisk or your own VoIP operator</a></li>
<li><a href="../185256/index.html">Weekday rdp or modest RDCMan say a word</a></li>
<li><a href="../185260/index.html">Implementation of work with faxes in asterisk</a></li>
<li><a href="../185264/index.html">UAC, let's be friends!</a></li>
<li><a href="../185266/index.html">Plasmoid in pure QML and JavaScript</a></li>
<li><a href="../185268/index.html">Drawings in SVG format. Part 2. - Draft Standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>