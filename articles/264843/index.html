<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Exploring OpenWRT: what is the difference between the uImage and sysupgrade images</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the comments to the article ‚ÄúWe are flashing the Upvel UR-313N4G router on OpenWRT‚Äù between your humble servant and the respected Maysoft there was...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Exploring OpenWRT: what is the difference between the uImage and sysupgrade images</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d90/9e5/26b/d909e526b8034f0bb821806160cc0c32.jpg"><br>  In the comments to the article <a href="http://habrahabr.ru/post/264025/">‚ÄúWe are flashing the Upvel UR-313N4G router on OpenWRT‚Äù</a> between your humble servant and the respected <a href="http://habrahabr.ru/users/maysoft/" class="user_link">Maysoft there was</a> a dispute about the differences in the structure of the uImage and sysupgrade images of the OpenWRT firmware.  I promised <a href="http://habrahabr.ru/users/maysoft/" class="user_link">Maysoft to</a> sort out the problem, and here is this article. <br><br>  As you know, in the download directory of OpenWRT, there are, for the most part, two types of firmware, uImage and sysupgrade, for example: <br><br>  openwrt-15.05-rc3-ramips-rt305x-dir-320-b1-initramfs-uImage.bin <br>  openwrt-15.05-rc3-ramips-rt305x-dir-320-b1-squashfs-sysupgrade.bin 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://wiki.openwrt.org/doc/faq/before.installation">The official FAQ</a> writes very briefly about their differences: <br><blockquote>  What is the difference between the different image formats? <br>  a factory image is one built for the bootloader flasher or stock software flasher <br>  a sysupgrade image (previously named trx image) is designed to be flashed from within openwrt itself <br>  Whatever is the platform needs.  Generally speaking, it can be used with the OEM GUI or OEM flashing tool.  After that, use the sysupgrade images. </blockquote><br>  According to the documentation, the content of the images is identical, except that the image of the factory contains additional headers so that this image can be flashed through the web interface of the original firmware. <br><a name="habracut"></a><br>  Ok, let's compare the size of the firmware: <br><br>  openwrt-15.05-rc3-ramips-rt305x-dir-320-b1-initramfs-uImage.bin - <i>3253035 bytes.</i> <br><br>  openwrt-15.05-rc3-ramips-rt305x-dir-320-b1-squashfs-sysupgrade.bin - <i>3407876 bytes.</i> <br><br>  Wow, the sysupgrade firmware is almost 140 Kb larger than the uImage, and according to the documentation they should be about the same size, and the uImage at the expense of this ‚Äúextra header information‚Äù itself is a bit larger. <br><br>  Of course, it is enough to look at the build scripts to understand the difference between uImage and sysupgrade-images, but this, you see, is unsportsmanlike.  Today we will analyze the firmware ‚Äúhead on‚Äù, as if we do not have the source code, and at the end we will look at the assembly scripts to confirm our guesses. <br><br>  The main tool for analyzing the firmware at the moment is the binwalk utility, available under Linux.  Rename the firmware files shorter for us to be more convenient, and begin the analysis. <br><br><pre><code class="bash hljs">&gt; binwalk ./uImage.bin DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 uImage header, header size: 64 bytes, header CRC: 0x19DE1499, created: Fri Jul 3 22:16:00 2015, image size: 3252971 bytes, Data Address: 0x80000000, Entry Point: 0x80000000, data CRC: 0x886ADE01, OS: Linux, CPU: IPS, image <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: OS Kernel Image, compression <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: lzma, image name: <span class="hljs-string"><span class="hljs-string">"MIPS OpenWrt Linux-3.18.17"</span></span> 64 0x40 LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 5479932 bytes</code> </pre> <br>  It seems that the entire firmware is an uImage image - at the beginning there is a header 64 (0x40) bytes in length, and after us is the data stream compressed by the LZMA algorithm, 3252971 bytes in size.  Fold 64 and 3252971, we get 3253035 bytes, that is, the size of the downloaded image.  Consequently, apart from the uImage image, there is nothing else in the file.  Binwalk can unpack found LZMA streams.  In principle, you can manually cut off the first 64 bytes from the file and unpack the rest with the lzma -d command, but why, when there is such a handy tool? <br><br><pre> <code class="bash hljs">&gt; binwalk -e ./uImage.bin</code> </pre><br>  Let's see what we have <br><pre> <code class="bash hljs">&gt; ls -l ./_uImage.bin.extracted/  8532 -rw-r--r-- 1 user user 5479932  8 23:10 40 -rw-r--r-- 1 user user 3252971  8 23:10 40.7z</code> </pre><br>  The file named 40 (offset in the source file) is the unpacked stream.  Set binwalk on it: <br><br><pre> <code class="bash hljs">binwalk ./_uImage.bin.extracted/40 DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 2812692 0x2AEB14 Linux kernel version <span class="hljs-string"><span class="hljs-string">"3.18.17 (buildbot@builder1) (gcc version 4.8.3 (OpenWrt/Linaro c version 4.8.3 (OpenWrt/Linaro GCC 4.8-2014.04 r46018) ) #2 Fr"</span></span> 2932132 0x2CBDA4 LZMA compressed data, properties: 0x5D, dictionary size: 16777216 bytes, missing uncompressed size 2936592 0x2CCF10 xz compressed data 3400392 0x33E2C8 LZMA compressed data, properties: 0x6D, dictionary size: 1048576 bytes, uncompressed size: -1 bytes</code> </pre><br>  And here we have something, at first glance, incomprehensible - binwalk discovered the Linux kernel at offset 0x2AEB14 and three compressed data streams following the kernel.  The fact is that binwalk uses heuristics for analysis and what comes out of it at the output is not the ultimate truth, but information for consideration. <br>  Common sense dictates that the kernel must start at offset 0, and the compressed stream must be one and contain initramfs the initial file system loaded into RAM.  The <a href="https://www.kernel.org/doc/Documentation/filesystems/ramfs-rootfs-initramfs.txt">documentation</a> on the core says the same thing: <br><blockquote>  What is initramfs? <br>  - All 2.6 Linux kernels contain a gzipped "cpio" format archive, which is the root boots up.  If you‚Äôre running a PID 1. </blockquote><br>  and further <br><blockquote>  Populating initramfs: <br>  - The 2.6 kernel build process will be created.  By default, this archive is empty (consuming 134 bytes on x86). </blockquote><br>  The stream format is also mentioned here - CPIO. <br><br>  Let's see what binwalk can extract from our image: <br><br><pre> <code class="bash hljs">&gt; binwalk -e ./_uImage.bin.extracted/40 ls -l ./_uImage.bin.extracted/_40.extracted/  14028 -rw-r--r-- 1 user user 2547808  8 23:25 2CBDA4.7z -rw-r--r-- 1 user user 2543340  8 23:25 2CCF10.tar -rw-r--r-- 1 user user 7186944  8 23:25 33E2C8 -rw-r--r-- 1 user user 2079540  8 23:25 33E2C8.7z</code> </pre><br>  So, only the stream at offset 33E2C8 was successfully unpacked.  If we do everything right, then this should be a CPIO container with the file system: <br><br><pre> <code class="bash hljs">&gt; binwalk _uImage.bin.extracted/_40.extracted/33E2C8 DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x00000004"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 116 0x74 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"dev/console"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000000C"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 240 0xF0 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"lib"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x00000004"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 356 0x164 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"lib/netifd"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000000B"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 480 0x1E0 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"lib/netifd/netifd-wireless.sh"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000001E"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00001638"</span></span> *********** *********** 7186416 0x6DA7F0 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"dev/urandom"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000000C"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 7186540 0x6DA86C ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"dev/pts"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x00000008"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 7186660 0x6DA8E4 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"TRAILER!!!"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000000B"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span></code> </pre><br>  At the end of the archive we see a file named TRAILER !!! .. which.  according to the <a href="https://www.kernel.org/doc/Documentation/early-userspace/buffer-format.txt">documentation</a> , is the end of archive label. <br><br>  Hence, the structure of the firmware initramfs-uImage is as follows: <br><br><img src="https://habrastorage.org/files/4a1/1dc/cfa/4a11dccface14747906267e1cddd283b.png"><br><br>  Now let's take on the image of squashfs-sysupgrade.  The name implies that the image contains (except for the kernel) the squashfs file system.  Let's see if this is so: <br><br><pre> <code class="bash hljs">&gt; binwalk -e ./sysupgrade.bin DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 0 0x0 uImage header, header size: 64 bytes, header CRC: 0x66CC90D2, created: Mon Jul 6 21:54:35 2015, image size: 1142606 bytes, Data Address: 0x80000000, Entry Point: 0x80000000, data CRC: 0x91B77696, OS: Linux, CPU: MIPS, image <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: OS Kernel Image, compression <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: lzma, image name: <span class="hljs-string"><span class="hljs-string">"MIPS OpenWrt Linux-3.18.17"</span></span> 64 0x40 LZMA compressed data, properties: 0x6D, dictionary size: 8388608 bytes, uncompressed size: 3396940 bytes 1142670 0x116F8E Squashfs filesystem, little endian, version 4.0, compression:lzma (non-standard <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> definition), size: 2221946 bytes, 1132 inodes, blocksize: 262144 bytes, created: Mon Jul 6 21:54:02 2015</code> </pre><br><br>  Let's take up arithmetic: 64 + 1142606 (image size) = 1142670, the squashfs image begins exactly at this offset, and it ends at the offset 1142670 + 2221946 = 3364616. The image size, meanwhile, is 3407876 bytes, which means we still have 3407876 - 3364616 = 43260 bytes of unidentified information.  Let's see what's in there, hexdump <br><pre> <code class="bash hljs">&gt; hexdump -s 3364616 ./sysupgrade.bin 0335708 ffff ffff ffff ffff ffff ffff ffff ffff * 0335ff8 ffff ffff ffff ffff adde dec0 ffff ffff 0336008 ffff ffff ffff ffff ffff ffff ffff ffff * 0337ff8 ffff ffff ffff ffff adde dec0 ffff ffff 0338008 ffff ffff ffff ffff ffff ffff ffff ffff * 033fff8 ffff ffff ffff ffff adde dec0 0340004</code> </pre><br>  There is clearly some kind of stub.  We return to it later. <br><br>  Let's see what we have in the directory with the unpacked image: <br><br><pre> <code class="bash hljs">&gt; ls -l _sysupgrade.bin.extracted/  8820 -rw-r--r-- 1 user user 2221946  8 23:40 116F8E.squashfs -rw-r--r-- 1 user user 3396940  8 23:40 40 -rw-r--r-- 1 user user 3407812  8 23:40 40.7z</code> </pre><br>  Extract the LZMA stream at offset 40: <br><br><pre> <code class="bash hljs">binwalk -e _sysupgrade.bin.extracted/40 DECIMAL HEXADECIMAL DESCRIPTION -------------------------------------------------------------------------------- 2812644 0x2AEAE4 Linux kernel version <span class="hljs-string"><span class="hljs-string">"3.18.17 (buildbot@builder1) (gcc version 4.8.3 (OpenWrt/Linaro c version 4.8.3 (OpenWrt/Linaro GCC 4.8-2014.04 r46018) ) #1 Fr"</span></span> 2932068 0x2CBD64 LZMA compressed data, properties: 0x5D, dictionary size: 16777216 bytes, missing uncompressed size 2936444 0x2CCE7C xz compressed data 3396424 0x33D348 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"dev"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x00000004"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 3396540 0x33D3BC ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"dev/console"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000000C"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 3396664 0x33D438 ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"root"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x00000005"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span> 3396780 0x33D4AC ASCII cpio archive (SVR4 with no CRC), file name: <span class="hljs-string"><span class="hljs-string">"TRAILER!!!"</span></span>, file name length: <span class="hljs-string"><span class="hljs-string">"0x0000000B"</span></span>, file size: <span class="hljs-string"><span class="hljs-string">"0x00000000"</span></span></code> </pre><br>  Here we have a Linux kernel and a small initramfs image with four files.  The rest, apparently, moved to the image of squashfs: <br><br><pre> <code class="bash hljs">&gt; unsquashfs -i ./_sysupgrade.bin.extracted/116F8E.squashfs Parallel unsquashfs: Using 4 processors 1033 inodes (1034 blocks) to write squashfs-root squashfs-root/bin squashfs-root/bin/ash squashfs-root/bin/board_detect squashfs-root/bin/busybox *********** *********** squashfs-root/www/luci-static/resources/load.svg squashfs-root/www/luci-static/resources/wifirate.svg squashfs-root/www/luci-static/resources/wireless.svg squashfs-root/www/luci-static/resources/xhr.js created 848 files created 99 directories created 184 symlinks created 0 devices created 0 fifos</code> </pre><br>  Indeed, the main file system is contained in the squashfs image. <br><br>  Now let's deal with the stub at the end of the image.  There is a suspicion that it somehow relates to the JFFS2 file system, because when you flash the sysupgrade image and then boot into dmesg, the lines appear: <br><br><pre> <code class="bash hljs">[ 29.550000] jffs2_scan_eraseblock(): End of filesystem marker found at 0x0 [ 29.580000] jffs2_build_filesystem(): unlocking the mtd device... <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>. [ 29.590000] jffs2_build_filesystem(): erasing all blocks after the end marker...</code> </pre><br>  and when flashing and loading the uImage image, there are no these lines.  A search in the ‚Äúvanilla‚Äù core along these lines does not give anything, but there are such lines in the <a href="http://git.openwrt.org/%3Fp%3D15.05/openwrt.git%3Ba%3Dblob%3Bf%3Dtarget/linux/generic/patches-3.18/532-jffs2_eofdetect.patch%3Bh%3D9cbe183138889dc558857d2d565562acfcbd7afa%3Bhb%3DHEAD">OpenWRT source tree</a> : <br><br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- a/fs/jffs2/build.c +++ b/fs/jffs2/build.c @@ -114,6 +114,16 @@ static int jffs2_build_filesystem(struct dbg_fsbuild("scanned flash completely\n"); jffs2_dbg_dump_block_lists_nolock(c); + if (c-&gt;flags &amp; (1 &lt;&lt; 7)) { + printk("%s(): unlocking the mtd device... ", __func__); + mtd_unlock(c-&gt;mtd, 0, c-&gt;mtd-&gt;size); + printk("done.\n"); + + printk("%s(): erasing all blocks after the end marker... ", __func__); + jffs2_erase_pending_blocks(c, -1); + printk("done.\n"); + } + dbg_fsbuild("pass 1 starting\n"); c-&gt;flags |= JFFS2_SB_FLAG_BUILDING; /* Now scan the directory tree, increasing nlink according to every dirent found. */ --- a/fs/jffs2/scan.c +++ b/fs/jffs2/scan.c @@ -148,8 +148,14 @@ int jffs2_scan_medium(struct jffs2_sb_in /* reset summary info for next eraseblock scan */ jffs2_sum_reset_collected(s); - ret = jffs2_scan_eraseblock(c, jeb, buf_size?flashbuf:(flashbuf+jeb-&gt;offset), - buf_size, s); + if (c-&gt;flags &amp; (1 &lt;&lt; 7)) { + if (mtd_block_isbad(c-&gt;mtd, jeb-&gt;offset)) + ret = BLK_STATE_BADBLOCK; + else + ret = BLK_STATE_ALLFF; + } else + ret = jffs2_scan_eraseblock(c, jeb, buf_size?flashbuf:(flashbuf+jeb-&gt;offset), + buf_size, s); if (ret &lt; 0) goto out; @@ -561,6 +567,17 @@ full_scan: return err; } + if ((buf[0] == 0xde) &amp;&amp; + (buf[1] == 0xad) &amp;&amp; + (buf[2] == 0xc0) &amp;&amp; + (buf[3] == 0xde)) { + /* end of filesystem. erase everything after this point */ + printk("%s(): End of filesystem marker found at 0x%x\n", __func__, jeb-&gt;offset); + c-&gt;flags |= (1 &lt;&lt; 7); + + return BLK_STATE_ALLFF;```` + } + /* We temporarily use 'ofs' as a pointer into the buffer/jeb */ ofs = 0; max_ofs = EMPTY_SCAN_SIZE(c-&gt;sector_size);</span></span></code> </pre><br>  Yeah, that's our stub 0xDEADCODE.  If the JFFS2 driver finds this label, then it considers it to be the end of the previous file system and erases everything from the zero byte of the label to the end of the drive.  Thus the label itself is also overwritten. <br>  After that, the driver creates a new instance of JFFS2 in this place. <br>  So, we have the following image structure: <br><br><img src="https://habrastorage.org/files/3d8/10d/495/3d810d4959f94827b32755ac1cb90686.png"><br><br>  In this way: <br><ol><li>  uImage contains the minimum necessary functionality for running OpenWRT and due to this, its structure can be easily changed so that it passes validation checks in the Web interfaces of the original firmware. </li><li>  Sysupgrade is more complex and uses Linux-specific tools - SquashFS and JFFS2. </li><li>  Both types of images do not contain a bootloader (and should not) </li><li>  When flashing through the bootloader (via UART or disaster recovery), you can immediately sew sysuprade. </li><li>  With firmware via mtd_write, if this utility is available via telnet from the official firmware, you can also immediately sew sysupgrade. </li></ol><br><br>  In conclusion, let's take a look at the OpenWRT build scripts to make sure of your conclusions.  Let's start with the file <a href="https://dev.openwrt.org/browser/trunk/target/linux/ramips/image/Makefile">/ target / linux / ramips / Makefile</a> .  But if you think that this is a regular GNU Makefile, it is not.  Here is how the developers themselves <a href="http://wiki.openwrt.org/doc/devel/packages">describe the</a> improved Makefile: <br><blockquote>  Looking at one of the package makefiles  This is a pattern that has been transformed, making it easier to use it. </blockquote><br>  It seems that the image build runs on line 564: <br><br><pre> <code class="bash hljs">Image/Build/Profile/DIR-320-B1=$(call BuildFirmware/Default8M/$(1),$(1),dir-320-b1,DIR-320-B1)</code> </pre><br>  The goal of BuildFirmware / Default8M is described in lines 195 and 196: <br><br><pre> <code class="bash hljs">BuildFirmware/Default8M/squashfs=$(call BuildFirmware/OF,$(1),$(2),$(3),$(ralink_default_fw_size_8M),$(4)) BuildFirmware/Default8M/initramfs=$(call BuildFirmware/OF/initramfs,$(1),$(2),$(3),$(4))</code> </pre><br>  It consists of two positions: squashfs and initramfs.  The goals of BuildFirmware / OF and BuildFirmware / OF / initramfs are described in the same file just above <br><br><pre> <code class="bash hljs">149 <span class="hljs-comment"><span class="hljs-comment"># $(1), Rootfs type, eg squashfs 150 # $(2), lowercase board name 151 # $(3), DTS filename without .dts extension 152 # $(4), maximum size of sysupgrade image 153 # $(5), uImage header's ih_name field 154 define BuildFirmware/OF 155 $(call MkImageLzmaDtb,$(2),$(3),$(5)) 156 $(call MkImageSysupgrade/$(1),$(1),$(2),$(4),$(6)) 157 endef</span></span></code> </pre><br>  and <br><br><pre> <code class="bash hljs">169 <span class="hljs-comment"><span class="hljs-comment"># $(1), squashfs/initramfs 170 # $(2), lowercase board name 171 # $(3), DTS filename without .dts extension 172 # $(4), ih_name field of uImage header 173 define BuildFirmware/OF/initramfs 174 $(call MkImageLzmaDtb,$(2),$(3),$(4),-initramfs) 175 $(CP) $(KDIR)/vmlinux-$(2)-initramfs.uImage $(call imgname,$(1),$(2))-uImage.bin 176 endef</span></span></code> </pre><br>  By the name of the target MkImageLzmaDtb, you can guess that it creates an uImage image from the description from the DTS file.  For the purpose of BuildFirmware / OF / initramfs, the initramfs partition with the main file system is added to this image, after which the image is copied to the output directory.  For the purpose of BuildFirmware / OF, the source image is processed by the MkImageSysupgrade function, which with the help of the ‚Äúcat‚Äù command attaches the squashfs section to it, and then calls the prepare_generic_squashfs function defined in the <a href="">image.mk</a> file. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># pad to 4k, 8k, 16k, 64k, 128k, 256k and add jffs2 end-of-filesystem mark 110 define prepare_generic_squashfs 111 $(STAGING_DIR_HOST)/bin/padjffs2 $(1) 4 8 16 64 128 256 112 endef</span></span></code> </pre><br>  And the padjffs2 utility <a href="">written in C</a> writes the 0xDEADCODE mark to the end of the image file: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> eof_mark[<span class="hljs-number"><span class="hljs-number">4</span></span>] = {<span class="hljs-number"><span class="hljs-number">0xde</span></span>, <span class="hljs-number"><span class="hljs-number">0xad</span></span>, <span class="hljs-number"><span class="hljs-number">0xc0</span></span>, <span class="hljs-number"><span class="hljs-number">0xde</span></span>}; *** <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *pad = eof_mark; *** <span class="hljs-comment"><span class="hljs-comment">/* write out the JFFS end-of-filesystem marker */</span></span> t = write(fd, pad, pad_len); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t != pad_len) { ERRS(<span class="hljs-string"><span class="hljs-string">"Unable to write to %s"</span></span>, name); <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> close; }</code> </pre><br>  In general, the world of OpenWRT is beautiful and amazing, especially deliver comments like: <br><blockquote>  # The real magic happens inside these templates </blockquote><br>  or <br><blockquote>  / * vodoo from original driver * / </blockquote><br>  In conclusion, I would like to say that when building OpenWRT from source codes, you need to pay attention to the build environment, for example, in <a href="https://github.com/utessel/edimax">this repository</a> on my Debian 8 + Sid, even the cross-compilation tool is not going to.  But on Debian 7, all this wealth is going to be amazing, if you do not edit the initial configuration.  If it is corrected, it may turn out that some Web sources, from which the assembly script downloads source codes, are already ‚Äúspoiled‚Äù, you need to look for new sources, correct the script, and so on. </div><p>Source: <a href="https://habr.com/ru/post/264843/">https://habr.com/ru/post/264843/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264823/index.html">We write Observer implementation over KVO on objective-c</a></li>
<li><a href="../264827/index.html">Training in the field of practical information security: "Corporate laboratories". New set</a></li>
<li><a href="../264829/index.html">Mobile printing</a></li>
<li><a href="../264839/index.html">15 Important Developer Career Tips</a></li>
<li><a href="../264841/index.html">How to write software for the whole world</a></li>
<li><a href="../264845/index.html">The digest of interesting materials for the mobile # 116 developer (on August 10-16)</a></li>
<li><a href="../264849/index.html">Megaphone - anyone can manage your account</a></li>
<li><a href="../264851/index.html">How to fix the error in Node.js and inadvertently raise performance by 2 times</a></li>
<li><a href="../264853/index.html">mhddfs - Mounting multiple partitions in one directory</a></li>
<li><a href="../264855/index.html">How we created the new VoxImplant logo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>