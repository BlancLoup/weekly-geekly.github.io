<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>"Peeped" - the path from the idea for the VK Mobile Challenge to the real product</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Three months of driving and overtime. Nervous tension sometimes went off scale, but optimism did not run out. We set ourselves difficult tasks and tri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>"Peeped" - the path from the idea for the VK Mobile Challenge to the real product</h1><div class="post__text post__text-html js-mediator-article">  Three months of driving and overtime.  Nervous tension sometimes went off scale, but optimism did not run out.  We set ourselves difficult tasks and tried to solve them in a non-standard way.  And we did it. <br><br><img src="https://habrastorage.org/files/d2f/7f5/036/d2f7f503679b49ec8c4ab6335a01ba35.png"><br><a name="habracut"></a><br><br>  My name is Alexey, I will tell you about our experience of participating in the VC competition on the development of mobile applications for Android, iOS and Windows Phone platforms.  I think my article will help beginners to soberly assess their strength and know what awaits them. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Competition terms, if interested, <a href="https://vk.com/vkmc">here</a> , and a couple of words about our product.  We decided to enter the contest with the project ‚ÄúPeeped - the city in the palm of your hand‚Äù.  We had about 50 public "Peeped" in different cities, but we wanted to create something that unites all the city news in one place.  And we got to work.  It was necessary to make a functional mobile application in which all the events and news of the city (aggregated from Vkontakte) would be maximally accessible to each user. <br><br>  For the main indicator of the success of the application ‚ÄúPeeped‚Äù, we took the reaction of users (Retention) and an understanding of whether the product will form a new habit of people to use the application. <br><br>  Presently: <br><br><ul><li>  Retention of 1 day at the level of 30% (not much, good practice 50%), </li><li>  Retention 3 days - 18% </li><li>  Retention 7 days - 15% </li></ul><br>  Of course, I want more impressive figures, but for an application that is only 4 months old, these are quite good results. <br>  During these three months that we ‚Äúsawed‚Äù the project, naturally, various difficulties arose.  Our developers will share with you the experience of solving problems. <br><br><h3>  Case from iOS developer </h3><br>  ‚ÄúDifficulties in the work on‚Äú Peeped ‚Äùarose enough.  Here is one of them.  I was tasked with shoving vertically scrolling content into categories that can be switched with a scroll.  Do not svaypom, namely scrolling.  At first, it was decided to use UIPageViewController.  Inner flair did not let me down, after a while there were suspensions with horizontal scrolling.  I had to redo the UICollectionView, the cells of which are UIScrollView with content.  Thus, I achieved a smooth switching between categories, but the vertical scroll showed no signs of life.  I had to rewrite touch processing so that gestures are passed down the hierarchy. <br><br><pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)touchesMoved:(<span class="hljs-built_in"><span class="hljs-built_in">NSSet</span></span> *)touches withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_isHorizontalScroll &amp;&amp; !_isMultitouch) { <span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span> point = [[touches anyObject] locationInView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fabs(_originalPoint.x - point.x) &gt; kThresholdX &amp;&amp; fabs(_originalPoint.y - point.y) &lt; kThresholdY) { _isHorizontalScroll = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; [_currentChild touchesCancelled:[event touchesForView:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>] withEvent:event]; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isHorizontalScroll){ [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> touchesMoved:touches withEvent:event]; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ [_currentChild touchesMoved:touches withEvent:event]; } }</code> </pre> <br><img src="https://habrastorage.org/files/ed0/bdb/1f8/ed0bdb1f8e7945979c04991517102241.png"><br><br><h3>  Case from Android developer </h3><br>  When choosing the architecture of the application, I stopped at Clean Architecture (https://github.com/android10/Android-CleanArchitecture).  This architecture is built on the principles formulated by Bob Martin.  It makes no sense to describe the architecture itself and the benefits derived from its use, many excellent articles have been written on this topic (for example: <a href="https://habrahabr.ru/post/250659/">‚ÄúArchitecture of Android Applications ... The Right Way?‚Äù</a> And ‚Äú <a href="https://habrahabr.ru/post/269589/">Pure Architecture</a> ‚Äù), but to understand what is going on further, I advise you to read them.  Immediately go to the problem encountered in the development of our application. <br><br>  ‚ÄúPeeped - the city in the palm of your hand‚Äù is a kind of platform for viewing actual information about a particular city.  In order to save users from manual search in a large list of cities, we need to determine the current location of the user.  At first I worked in the old fashioned way: I used the system LocationManager, I got a list of providers from it, and from them a specific location.  The standard way to solve a problem, I think everyone is familiar with it.  Everything worked fine.  But there were a few problems. <br><br>  1. The Android API&gt; = 23 introduced Runtime Permossions.  This means that on devices with Android 6.0 you need to request some permissions in runtime, in our case, to determine the coordinates.  We determine the current location is done immediately - on the first screen.  We considered that such a request might scare some users away. <br><br>  2. LocationManager lay in the presentation layer, which is very much contrary to the principles embodied in Clean Architecture. <br><br>  To solve the first problem, I resorted to the service from Yandex: Locator (https://tech.yandex.ru/locator/).  With this service, you can determine the current location of the nearest Wi-Fi access points and mobile cells, without using GPS.  Thus, we will get rid of the annoying dialogue.  But this service, for various reasons, does not always produce the correct result.  On the site of the service itself is written: <br><br>  &gt; In some cases, Yandex. Locator reports an accuracy of 100,000 meters, which means that it was not possible to reliably determine the location.  This happens if the location is not determined by the IP address of the mobile device, but by the IP address of a public server or proxy server. <br><br>  In this case, we cannot rely on the result obtained.  So we need to go back to the LocationManager.  Thus, the algorithm is as follows: We made a request to the Yandex locator, if he did not return anything, or if the accuracy of a specific location is&gt; = 100000 meters, we request it from the system LocationManager. <br><br>  Let me turn to the solution of the second problem: we are responsible for issuing the current coordinate to the data layer, as it is responsible for managing the data in the application. <br><br>  But first, go to the domain layer.  I created the LocationService interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Observable&lt;LocationEntity&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  And used it in UseCase: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetCurrentLocationUseCase</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UseCase</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationEntity</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String CASE_NAME = <span class="hljs-string"><span class="hljs-string">"get_current_location"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocationService mLocationService; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCurrentLocationUseCase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocationService locationService, ThreadExecutor threadExecutor, PostExecutionThread postExecutionThread)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(threadExecutor, postExecutionThread); mLocationService = locationService; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Observable&lt;LocationEntity&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">buildUseCaseObservable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mLocationService.getCurrentLocation(); } }</code> </pre><br>  Now this UseCase can be easily ‚Äúinjected‚Äù into Presenter, with the help of Dagger2, thus abstracting from the specific implementation of the service. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YandexLocationService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationService</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MAX_PRECISION = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> YandexLocatorService mYandexLocatorService; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YandexLocationService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RestAdapter restAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestAdapter.Builder() .setEndpoint(BASE_URL_LOCATOR) .setLogLevel(RETROFIT_LOG_LEVEL) .build(); mYandexLocatorService = restAdapter.create(YandexLocatorService.class); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;LocationEntity&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getCurrentLocationByIp() .timeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS) .filter(yandexLocation -&gt; yandexLocation.getPrecision() &lt; MAX_PRECISION) .map(LocationTransformer::transformToLocationEntity); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;YandexLocation&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentLocationByIp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mYandexLocatorService.getLocation(getLocatorRequestObject()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> YandexRequest </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLocatorRequestObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YandexRequest(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Common(LOCATOR_VERSION, LOCATOR_API_KEY)); } }</code> </pre><br>  In this example, the definition of coordinates is made only by IP address.  Here I filter the coordinates with poor accuracy (&gt; = 100000) and convert the resulting YandexLocation entity into LocationEntity.  Next, we turn to the system service coordinate determination.  It is a little more difficult for him, since he uses Runtime Permissions, and, therefore, he has to request permissions.  I made the interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PermissionsRequester</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Observable&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... permissions)</span></span></span></span>; }</code> </pre><br>  We will implement this interface in the presentation layer using the RxPermissions library: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PermissionsRequesterImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PermissionsRequester</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RxPermissions mRxPermissions; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PermissionsRequesterImpl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ mRxPermissions = RxPermissions.getInstance(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;Boolean&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String... permissions)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mRxPermissions.request(permissions); } }</code> </pre><br>  Now you can easily use this interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SystemLocationService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocationManager mLocationManager; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PermissionsRequester mPermissionsRequester; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SystemLocationService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocationManager locationManager, PermissionsRequester permissionsRequester)</span></span></span><span class="hljs-function"> </span></span>{ mLocationManager = locationManager; mPermissionsRequester = permissionsRequester; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;LocationEntity&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getCurrentGpsLocation() .map(LocationTransformer::transformToLocationEntity); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;Location&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentGpsLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mPermissionsRequester .request(Manifest.permission.ACCESS_COARSE_LOCATION, Manifest.permission.ACCESS_FINE_LOCATION) .flatMap(granted -&gt; granted ? findLastLocation() : Observable.error(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException())); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Observable&lt;Location&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findLastLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Observable.OnSubscribe&lt;Location&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscriber&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Location&gt; subscriber)</span></span></span><span class="hljs-function"> </span></span>{ Location lastLocation = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; List&lt;String&gt; providers = mLocationManager.getAllProviders(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (providers != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !providers.isEmpty()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (String provider : providers) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mLocationManager.isProviderEnabled(provider)) { Location auxLocation = mLocationManager.getLastKnownLocation(provider); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (auxLocation != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastLocation == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { lastLocation = auxLocation; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (auxLocation.getTime() &gt; lastLocation.getTime()) { lastLocation = auxLocation; } } } } } subscriber.onNext(lastLocation); subscriber.onCompleted(); } }); } }</code> </pre><br>  So I made 2 services.  But you need to use both.  How to solve this problem?  I created a CompositeLocationService, which receives several implementations of the LocationService interface and starts each of them in turn, until I get a specific location: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompositeLocationService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DEFAULT_TIMEOUT = <span class="hljs-number"><span class="hljs-number">30</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> LocationService[] mLocationServices; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompositeLocationService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocationService... services)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (services == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || services.length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompositeLocationEmptyException(); } mLocationServices = services; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Observable&lt;LocationEntity&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentLocation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Observable.concat( Observable.from(mLocationServices) .map(locationService -&gt; locationService .getCurrentLocation() .onErrorReturn(throwable -&gt; <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) .timeout(DEFAULT_TIMEOUT, TimeUnit.SECONDS, Observable.empty()) ) ) .first(location -&gt; location != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre><br>  In the getCurrentLocation method, we sequentially query the services one after another, and if a non-zero result is obtained, we give it out, ignoring the remaining services.  Thus, we can use an unlimited number of services.  Next, in the presentation layer, combine these classes in the LocationModule module using Dagger2: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocationModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PubApplication mPubApplication; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LocationModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PubApplication pubApplication)</span></span></span><span class="hljs-function"> </span></span>{ mPubApplication = pubApplication; } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">Context </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">providesApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mPubApplication; } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">LocationManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">providesLocationManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (LocationManager) mPubApplication.getSystemService(Context.LOCATION_SERVICE); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">PermissionsRequester </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">providesRxPermissions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PermissionsRequesterImpl(context); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">YandexLocationService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideYandexLocationService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> YandexLocationService(); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">SystemLocationService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideSystemLocationService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LocationManager locationManager, PermissionsRequester permissionsRequester)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SystemLocationService(locationManager, permissionsRequester); } <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-function"><span class="hljs-function">LocationService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideLocationService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(YandexLocationService yandexLocationService, SystemLocationService systemLocationService)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompositeLocationService(yandexLocationService, systemLocationService); } }</code> </pre><br>  All is ready!  Now you can safely use GetCurrentLocationUseCase in our presenter.  Thus, albeit partially, but some problems with determining the location have been resolved.  A dialog with a location request will appear much less frequently, and, therefore, will scare away far fewer users.  And from the point of view of architecture, now everything is much better, the presentation layer is responsible for the display, data for the information.  This example is not perfect, but I think it allows you to understand the general principle of solving these problems in the context of "pure architecture". <br><br><img src="https://habrastorage.org/files/de0/62b/31e/de062b31eedc42fd9d7a0257866b921f.png"><br><br><h3>  Briefly about technology </h3><br>  To make it clearer, here are some more explanations of what technologies we used.  The server part is located on two DigitalOcean servers with a configuration of 1 core / 1Gb RAM. <br><br>  The backend is written in PHP7 using the Yii2 framework. <br><br>  1 server - db-master, synchronization script with VKontakte. <br>  2 server - db-slave, rest api, web client. <br>  The web client is written using the AngularJS v1.5.2 framework. <br>  Geolocation is determined using the service Geolocator from Yandex. <br><br>  And at the end of a bit of statistics.  Currently, there are about 3200 groups (public) in the system, synchronization with Vkontakte is carried out in several streams.  With the current server configuration, the average queue for updating all groups is 6 minutes.  Over the past month, about 2 million new posts have been uploaded.  We update these posts only if they are not older than 1 month and not more than 100 last in the group. <br><br>  And yes, we are proud that among the nearly 130 projects our ‚ÄúPeeped‚Äù is one of the few presented on 2 platforms. <br><br>  Thanks to participation in the competition, we were able to test our strength and take a more objective look at our project.  They experienced incredible excitement and drive and even more united the team with one idea. </div><p>Source: <a href="https://habr.com/ru/post/282193/">https://habr.com/ru/post/282193/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282181/index.html">Features of national management</a></li>
<li><a href="../282183/index.html">3D printer calibration</a></li>
<li><a href="../282187/index.html">VoIP Part 1</a></li>
<li><a href="../282189/index.html">Graphic VGA-controller on SoC without HDL knowledge</a></li>
<li><a href="../282191/index.html">Rendering UTF-8 text using an SDF font</a></li>
<li><a href="../282195/index.html">On the way to creating your own online store engine</a></li>
<li><a href="../282197/index.html">The release of Ubuntu 16.04 LTS - Snap, OpenStack and other innovations. There may be problems with AMD video cards</a></li>
<li><a href="../282199/index.html">Robokassa stopped working with individual entrepreneurs and individuals</a></li>
<li><a href="../282203/index.html">Pavel Durov will distribute $ 1 000 000 to Telegram bots developers</a></li>
<li><a href="../282205/index.html">Backdrop Licensing FAQ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>