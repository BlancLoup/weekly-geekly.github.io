<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rekko Challenge - how to take 2nd place in the competition for the creation of recommendation systems</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. My team in Tinkoff builds recommender systems. If you are satisfied with your monthly cashback, then this is our doing. We also built a recomme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rekko Challenge - how to take 2nd place in the competition for the creation of recommendation systems</h1><div class="post__text post__text-html js-mediator-article"><p>  Hello.  My team in Tinkoff builds recommender systems.  If you are satisfied with your monthly cashback, then this is our doing.  We also built a recommendation system of special offers from partners and deal with individual collections of Stories in the Tinkoff application.  We also love to participate in machine learning competitions to keep ourselves in good shape. </p><br><p>  For two months from February 18 to April 18, a <a href="https://boosters.pro/championship/rekko_challenge/overview">competition</a> to build a recommender system based on real data of one of the largest Russian online cinemas <a href="https://okko.tv/">Okko</a> took place on <a href="https://okko.tv/">Boosters.pro</a> .  The organizers aimed to improve the existing recommendation system.  At the moment, the competition is <a href="https://boosters.pro/championship/rekko_sand/overview">available in sandbox mode</a> , in which you can test your approaches and hone your skills in building recommender systems. </p><br><p><img src="https://habrastorage.org/webt/lv/1c/rj/lv1crjkiorbmthzwkmprnoqdusa.png" alt="alt_text"></p><a name="habracut"></a><br><h1 id="opisanie-dannyh">  Data description </h1><br><p>  Access to the content in Okko is carried out through the application on a TV or smartphone, or through a web interface.  Content can be leased¬Æ, purchased (P) or viewed by subscription (S).  The organizer of the competition provided data on views for N days (N&gt; 60), information about the ratings and bookmarks was additionally available.  It is necessary to keep in mind one important detail; if a user watched one movie several times or several episodes of a series, then only the date of the last transaction and the total time spent per content unit will be recorded in the tablet. </p><br><p><img src="https://habrastorage.org/webt/qy/w5/2z/qyw52zw89wafhju80zo73p3uxya.png" alt="alt_text"></p><br><p>  It was given about 10 million transactions, 450 thousand estimates and 950 thousand facts bookmarked by 500 thousand users. </p><br><p><img src="https://habrastorage.org/webt/nz/g6/_g/nzg6_gexjoxdvmsng8lkjcm9_m8.png" alt="alt_text"></p><br><p>  The sample contains not only active users, but also users who have watched a couple of films for the entire period. </p><br><p>  The Okko directory contains three types of content: movies (movie), series (serials) and multi-part films (multipart_movie), a total of 10,200 objects.  For each object, a set of anonymized attributes (attributes) and attributes (feature_1, ..., feature_5), availability by subscription, rental or purchase, and duration were available. </p><br><p><img src="https://habrastorage.org/webt/ww/z3/wj/wwz3wjub5-tgvdrpjkinmi8ojgg.png" alt="alt_text"></p><br><h1 id="celevaya-peremennaya-i-metrika">  Target variable and metric </h1><br><p>  The task required to predict a lot of content that the user will consume over the next 60 days.  A user is considered to consume content if he: </p><br><ul><li>  Buy it or rent it </li><li>  Watch more than half of the movie by subscription </li><li>  Watch more than a third of the series by subscription </li></ul><br><p><img src="https://habrastorage.org/webt/hs/62/an/hs62anr4vai9g-7aivjqq8gfjek.png" alt="alt_text"></p><br><ul><li>  <strong>r_u (i)</strong> - whether the user u consumed the content predicted to him in place i (1 or 0) </li><li>  <strong>n_u</strong> - the number of items that the user consumed during the test period </li><li>  <strong>U</strong> - a lot of test users </li></ul><br><p>  Learn more about the metrics for the ranking task in this <a href="https://habr.com/ru/company/econtenta/blog/303458/">post</a> . </p><br><p>  Most users watch movies to the end, so the transaction share of the positive class is 65%.  The quality of the algorithm was evaluated by a subset of 50 thousand users from the presented sample. </p><br><h1 id="agregirovannyy-reyting">  Aggregated rating </h1><br><p>  The decision of the competition began with the aggregation of all interactions of users with content into a single rating scale.  It was assumed that if the user bought the content, it means the maximum interest.  The film is shorter than the series, therefore for watching the entire series you need to give more points.  As a result, the aggregated rating was formed according to the following rules: </p><br><ul><li>  Share movie viewing * 5 </li><li>  Watch TV show share * 10 </li><li>  [Bookmark movie] * 0.5 </li><li>  [Bookmark TV Show] * 1.5 </li><li>  [Buying / renting content] * 15 </li><li>  Rating + 2 </li></ul><br><h1 id="model-pervogo-urovnya">  First level model </h1><br><p>  The organizers provided a basic solution based on collaborative filtering with Tf-IDF weights.  Adding all types of interactions to the aggregated rating, increasing the number of nearest neighbors from 20 to 150 and replacing Tf-IDF with BM25 weights knocked out about <strong>0.03</strong> per LB (Leader Board). </p><br><p>  Inspired by the <a href="https://habr.com/ru/company/avito/blog/439206/">post of the team that took 3rd place at the RecSys Challenge 2018</a> , I chose the <a href="https://lyst.github.io/lightfm/docs/home.html">LightFM</a> model with the <a href="https://lyst.github.io/lightfm/docs/examples/warp_loss.html">WARP</a> <a href="https://lyst.github.io/lightfm/docs/home.html">Loss</a> as the second base model.  LightFM with selected hyper-parameters: learning_rate, no_components, item_alpha, user_alpha, max_sampled gave <strong>0.033</strong> on LB. </p><br><p><img src="https://habrastorage.org/webt/le/km/ak/lekmakeznlccijkuu24mnvqlcsm.png" alt="alt_text"></p><br><p>  Validation of the model was carried out in time: the first 80% of the interactions fell into the train, the remaining 20% ‚Äã‚Äãwere validated.  For a submission on LB, the model on all datasets with parameters selected for validation was separately studied. </p><br><h1 id="blending-modeley">  Blending models </h1><br><p>  In the previous stage, it turned out to build two strong baselines, moreover, their recommendations intersected on average 60 percent of the recommended content.  If there are two strong and at the same time weakly correlated models, then a reasonable step is their blending. </p><br><p><img src="https://habrastorage.org/webt/2-/5x/ya/2-5xyaedg2u-tqzbjr80v-49j38.png" alt="alt_text"></p><br><p>  In this case, model skors belong to different distributions and have a different scale, so it was decided to use the sum of ranks to combine the two models.  The model blending gave <strong>0.0347</strong> on LB. </p><br><p><img src="https://habrastorage.org/webt/b4/8e/m4/b48em4d9um22gvkdttdp8i-heco.png" alt="alt_text"></p><br><h1 id="model-vtorogo-urovnya">  Second level model </h1><br><p>  In recommender systems, a two-tier approach is often used to build models: first, top candidates are selected by a simple first-level model, then the selected top is re-ranked by a more complex model with the addition of a large number of features. </p><br><p><img src="https://habrastorage.org/webt/e5/ll/db/e5lldbt4k4ncxq5uiqbk61l8doc.png" alt="alt_text"></p><br><p>  Dataset was broken down into training and validation parts.  For the validation part, a selection of recommendations was collected for each user, consisting of combining top200 predictions of first-level models with the exception of already watched films.  Further, it was required to teach the model to rearrange the resulting top for each user.  The problem was formulated in terms of a binary classification.  The pair (user, content) belonged to the positive class only if the user consumed the content during the validation period.  As a model of the second level, gradient boosting was used, namely the LightGBM package. </p><br><h2 id="priznaki">  Signs of </h2><br><p>  Models of the first level for couples (user, content) evaluate relevance in the form of skor, sorting out which in descending order you can get rank.  The model, trained on the signs of rank and speed, in combination with the signs, knocked out <strong>0.0359</strong> from the content catalog from LB. </p><br><p>  From the form of distribution of the first of the anonymized features, it was concluded that it is the date the film appeared in the catalog, therefore the model was strongly retrained for this feature with the selected validation scheme.  Removing a trait from the sample increased on LB to <strong>0.0367</strong> </p><br><p>  In addition to predicting content relevance for a user, the LightFM model returns two vectors: item bias and user bias, correlating with the degree of popularity of the content and the number of films viewed by the user, respectively.  Adding signs raised fast on LB to <strong>0.0388</strong> . </p><br><p>  You can assign a rank for a couple (user, content) either before or after deleting already watched movies.  A change in the method to the latter provided an increase in LB to <strong>0.0395</strong> . </p><br><p><img src="https://habrastorage.org/webt/dm/ux/h_/dmuxh_6p9obkaumaeimtritdre0.png" alt="alt_text"></p><br><p>  Almost no one watched a significant part of the movie catalog.  Content that was viewed by less than 100 users was removed from the sample for learning the second-level model, which reduced the catalog by half.  Removing unpopular content made the selection from first-level models more relevant and only after that the vectors of users from LightFM improved the validation rate and gave an increase on LB to <strong>0.0429</strong> . </p><br><p>  Further, a sign was added - the user added the movie to the bookmarks, but did not watch it during the training period, which raised the speed on LB to <strong>0.0447</strong> .  Signs about the date of the first and last transactions were also added, they raised <strong>speed</strong> to <strong>0.0457</strong> on LB. </p><br><p><img src="https://habrastorage.org/webt/jy/4_/0v/jy4_0vcyt5ndutilvgqmbcivlkq.png" alt="alt_text"></p><br><p>  We will consider this model final.  The most significant were signs from the first-level models and anonymized signs from the content catalog. </p><br><p>  The following features did not give rise to the final model: </p><br><ul><li>  number of bookmarks + share of browsed content from bookmarks - <strong>0.0453</strong> LB </li><li>  number of purchased films <strong>0.0451</strong> LB </li></ul><br><p>  But when blending with the final model, <strong>0.0465 was</strong> knocked out on the LB.  Inspired by the result of blending, the following models were separately trained: </p><br><ul><li>  with different training sample fractions for the first level model.  A split of 90% / 10% gave an increase, in contrast to partitions of 95% / 5% and 70% / 30%. </li><li>  with a modified rating aggregation method. </li><li>  with the addition of unpopular films in the training sample for the model of the second level.  For each unit of content was compiled from 1000 users. </li></ul><br><p>  The final blending of 6 models allowed achieving <strong>0.0469678</strong> on LB, which corresponded to the 5th place. </p><br><p><img src="https://habrastorage.org/webt/zu/tk/zm/zutkzmaxdgaatxyk5qddhdo5dda.png" alt="alt_text"></p><br><p>  On the private side, a shake-up happened, throwing the decision to 2nd place.  I think that the solution turned out to be stable due to the blending of a large number of models. </p><br><p><img src="https://habrastorage.org/webt/rm/qo/8q/rmqo8ql3pgwas205pr5peg49hoy.png" alt="alt_text"></p><br><h1 id="ne-zashlo">  Did not go </h1><br><p>  In the process of resolving the competition, many signs were generated that seemed to come in exactly, but alas.  Signs and approaches that were believed the most: </p><br><ul><li>  Anonymized content attributes.  It was not known for certain what they contain, but all participants of the competition thought that they contained information about actors, directors, composers ... In my solution I tried to add them in several formats: top popular as binary signs, to decompose the content matrix attributes using LightFM and BigARTM, and then dragging out vectors and adding to the second-level model. </li><li>  Content vectors from the LigthFM model in the second level model. </li><li>  Attributes of the devices from which the user viewed the content. </li><li>  Lowering the weights of popular content for the second level model. </li><li>  Share movies / series in relation to the total number of viewed content. </li><li>  Ranking Metrics from CatBoost. </li></ul><br><h1 id="interesnye-fakty-o-sorevnovanii">  Interesting facts about the competition </h1><br><ul><li>  Top1 solution was worse than the product model okko 0.048 vs 0.062.  It should be borne in mind that the product model has already been launched at the time of sampling. </li><li>  About a week after the start of the competition, datasets were changed, those who participated from the outset added 30 submissions, which suddenly burned down after the merge of the teams. </li><li>  Validation did not always correlate with LB, which indicated a possible shake up. </li></ul><br><h1 id="kod-resheniya">  Decision code </h1><br><p>  The solution is available on <a href="https://github.com/smirnovevgeny/RekkoChallenge">github</a> in the form of two jupyter laptops: rating aggregation, training of models of the first and second levels. <br>  A 3rd place solution is also available on <a href="https://github.com/smileyarik/rekko">github</a> . </p><br><h1 id="reshenie-organizatorov">  The decision of the organizers </h1><br><p> Instead of a thousand words, I attach the top features of the organizers. </p><br><p><img src="https://habrastorage.org/webt/xa/yg/gx/xayggxsl3bpargxaeinl8wgsbhy.jpeg" alt="alt_text"></p><br><p>  In addition, the guys from Okko <a href="https://habr.com/ru/company/okko/blog/454224/">released an article</a> in which they talk about the stages of development of their recommendation engine. </p><br><p>  PS <a href="https://www.youtube.com/watch%3Fv%3DSOEPNYu6Yzc%26feature%3Dyoutu.be%26t%3D1658">here you can see the</a> presentation on Data Fest 6 about this solution to the problem. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/454818/">https://habr.com/ru/post/454818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45480/index.html">Automate client optimization</a></li>
<li><a href="../454804/index.html">Create your component with micro templates</a></li>
<li><a href="../454806/index.html">Training Cisco 200-125 CCNA v3.0. Day 9. The physical world of switches. Part 1</a></li>
<li><a href="../454808/index.html">About spaceships and "space". How to make a feature by changing the whole product on the way</a></li>
<li><a href="../454810/index.html">Fresh air on Mars: bend a CO2 molecule and get oxygen</a></li>
<li><a href="../45482/index.html">HTTP_StaticMerger - automatic gluing of CSS and JS files for quick loading</a></li>
<li><a href="../454824/index.html">The simplest opamp on discrete elements</a></li>
<li><a href="../454828/index.html">Creating a mosaic image</a></li>
<li><a href="../45483/index.html">Cartoon "Gypsy": You are not filmed in cartoons?</a></li>
<li><a href="../454832/index.html">Why a four-day work week is a bad fairy tale.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>