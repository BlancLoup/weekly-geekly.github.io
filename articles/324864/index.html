<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The fastest way to take 35 billboards in Moscow</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ideas to do on the weekends, IT is drawn from hundreds of different sources. I, for example, recently saw the competition of the Open School Champions...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The fastest way to take 35 billboards in Moscow</h1><div class="post__text post__text-html js-mediator-article">  Ideas to do on the weekends, IT is drawn from hundreds of different sources.  I, for example, recently saw the competition of the Open School Championship in Economics, which is to <b>photograph the maximum number of Championship billboards</b> .  The organizers have kindly provided the addresses.  And despite the fact that the prize for an adult does not shine there (this is a school competition), it would nevertheless be extremely interesting to find out in what minimum time such a task can be solved. <br><br><img src="https://habrastorage.org/files/90f/2aa/e20/90f2aae201004f00a2cff411368b1a88.png"><br><a name="habracut"></a><br><h2>  So what do we have? </h2><br>  3 hours on weekends, 35 billboard addresses <a href="https://vk.com/doc37216554_443517692%3F">in the form of quite controversially injected addresses</a> (for some reason, the UNOM registry fights badly with familiar maps), 1 Jupyter with the second ( <i>sorry</i> ) python and many API of various services ready to work. <br><br>  For a start, it would be convenient to present the scale of the disaster on the map.  It would be possible to use something automatic, but it‚Äôs faster to manually kill 35 addresses in the Yandex.Maps Constructor, he will lead them to the coordinate.  The result was a <a href="https://yandex.ru/maps/-/C6E~jH8E">picture of kata</a> , from which it became clear that 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Three points are located in Zelenograd and Khimki, they will clearly increase the time on the way. </li><li>  Few billboards in the city center </li><li>  The points are quite chaotic, and manually build a good route connecting them is unlikely to work. </li></ul><br>  Actually all the options to continue this route <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mn>35</mn><mo>!</mo><mo>=</mo><mn>1.03</mn><msup><mi>e</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="13.164ex" height="2.419ex" viewBox="0 -935.7 5667.9 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-33"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-35" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-21" x="1001" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-3D" x="1557" y="0"></use><g transform="translate(2613,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-31"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-2E" x="500" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-30" x="779" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-33" x="1279" y="0"></use></g><g transform="translate(4393,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMATHI-65" x="0" y="0"></use><g transform="translate(466,362)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://habr.com/ru/post/324864/&amp;xid=17259,15700002,15700023,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGIz6cussOciHDqLHeWC6Vkk9GJA#MJMAIN-30" x="500" y="0"></use></g></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mn>35</mn><mo>!</mo><mo>=</mo><mn>1.03</mn><msup><mi>e</mi><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 35! = 1.03e ^ {40} </script>  , which is roughly comparable to the <a href="https://en.wikipedia.org/wiki/Shannon_number">number of unique chess positions</a> on the board.  So we need to understand a little about the achievements of the national economy in the field of <a href="https://en.wikipedia.org/wiki/P_versus_NP_problem">P-NP tasks</a> . <br><br><h2>  Collect time matrix between points </h2><br>  It becomes clear that our task is an example of the classic <a href="https://en.wikipedia.org/wiki/Travelling_salesman_problem">traveling salesman</a> (TSP) <a href="https://en.wikipedia.org/wiki/Travelling_salesman_problem">problem</a> .  In order to solve it (approximately), we need to build a distance matrix (in our case, time) between each point.  To solve this problem, we will use the Google Maps API, namely, the insanely simple and clear <b>googlemaps</b> library.  Working with this library is simple and elegant. You can get time between two points on the map so simply: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> googlemaps <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime gmaps = googlemaps.Client(key=<span class="hljs-string"><span class="hljs-string">'AIxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span></span>) resp = gmaps.directions( origin=<span class="hljs-string"><span class="hljs-string">'55.71802 37.573753'</span></span>, destination=<span class="hljs-string"><span class="hljs-string">'55.73481 37.66521'</span></span>, mode=<span class="hljs-string"><span class="hljs-string">'driving'</span></span>, <span class="hljs-comment"><span class="hljs-comment">#  'transit'    region='ru', language='en', departure_time=datetime.datetime.now(), ) distance_time = resp[0]['legs'][0]['duration_in_traffic']['value'] #   print resp[0]['legs'][0]['duration_in_traffic'] # Out[]: {u'text': u'49 mins', u'value': 2917}</span></span></code> </pre> <br>  So, it remains to fill the matrix of 36 √ó 36 all distances.  Note that getting from point A-&gt; B does NOT take as much time as from B-&gt; A, so reducing the work by two times will not work (although the diagonal is of course filled with zeros).  It would be possible to just go through the previously created empty matrix and fill it, but I prefer the approach when I first store all the elements of the matrix as a list <code>[[x,y,value]]</code> , and then I do <code>.pivot</code> , ‚Äú <code>.pivot</code> ‚Äù the matrix . <br><br><pre> <code class="python hljs">distances = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> origin,destination <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> permutations(points[<span class="hljs-string"><span class="hljs-string">'lat lng'</span></span>], <span class="hljs-number"><span class="hljs-number">2</span></span>): resp = gmaps.directions( origin=origin, destination=destination, mode=<span class="hljs-string"><span class="hljs-string">'driving'</span></span>, region=<span class="hljs-string"><span class="hljs-string">'ru'</span></span>, language=<span class="hljs-string"><span class="hljs-string">'en'</span></span>, departure_time=now, ) distance_time = resp[<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'legs'</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>][<span class="hljs-string"><span class="hljs-string">'duration_in_traffic'</span></span>][<span class="hljs-string"><span class="hljs-string">'value'</span></span>] <span class="hljs-comment"><span class="hljs-comment">#   distances.append( [origin,destination,distance_time] ) distances = pd.DataFrame(distances, columns='origin,destination,distance_time'.split(',')) distances_matrix = distances.pivot_table( index='origin', columns='destination', values='distance_time' ).fillna(0)</span></span></code> </pre><br>  Here you can immediately note that I am a big fan of Pandas Dataframes, and with them life becomes better.  If you have not heard, be sure to read, you will like it.  And, of course, how good it is to write on Python, in which the wonderful function <code>itertools.permutations</code> is already ready, which returns all pairs (triples, quadruples, as needed) of the elements of a given list.  No crutches! <br><br>  The final matrix turned out like this: <br><br><img src="https://habrastorage.org/files/c63/05f/493/c6305f493a6246558e8fe5702c395439.png"><br><br>  By the way, here you can immediately explore, and how close are our points at all?  In other words, look at the distribution of travel time between all points: <br><br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/files/b70/117/0c2/b701170c266c4d789cba4eb2830d95b4.png"></div><br>  Although in general, everything is quite expected.  Many points are very close, the distribution is quite ‚Äúnormal‚Äù, all due to the fact that by car you can move in any direction.  Looking ahead, here is the same distribution, only for public transport: <br><br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/files/0f5/a3a/20d/0f5a3a20d3e14974b27a404ff0fb0c99.png"></div><br>  A completely different picture: the distribution is much more ‚Äústretched‚Äù to the right, that is, there are relatively few points between which one can quickly (faster than 40 minutes) move by public transport.  And of course, the time spent on transport in general is more (more or less twice). <br><br><h2>  Tsp </h2><br>  So, now on the matrix it is necessary to build the best route.  I must say that this task has already been studied quite well, for example, there is a very good google library <a href="https://developers.google.com/optimization/">ortools</a> , which allows you to <a href="https://developers.google.com/optimization/">iterate</a> through routes on thousands and tens of thousands of points. <br><br>  However, in our case there are only a dozen points. There is no need for complex algorithms.  You can use the greedy algorithm of double pass, and get the result almost no different from the "canonical". <br><br>  So, the algorithm will be like this: <br><br>  1. We initiate the initial and final points. <br>  2. We take two points with the shortest distances from the initiated ones, add them to the route. <br>  3. Postorim until we get the full route. <br><br>  It is obvious here that the algorithm is very dependent on the selected initial points (and generally on the order of the points), so there is a fairly simple way to avoid local optima: ‚Äúmix‚Äù the points several times and post the work of the greedy algorithm. <br><br>  I borrowed the software implementation of this algorithm from the <a href="https://github.com/dmishin/tsp-solver">library of</a> Dmitry Shinyakov from the library. <br><br>  The library accepts the <code>numpy</code> square matrix as input, and the output produces <code>path</code> : an array of indices of points in the order along the route.  Interestingly, Google Maps does not allow you to build routes with more than 23 waypoints, so you cannot build a route on one map.  I went to the trick, and with the help of the same <code>googlemaps</code> simply split the route into two and built it. <br><br><pre> <code class="python hljs">coords_path = distances_matrix.index[path] <span class="hljs-comment"><span class="hljs-comment">#      # Latitude-longitude pairs start = map(float, coords_path[0].split(' ')) waypoints = map(lambda p: map(float, p.split()), coords_path[1:24]) #  24  end = map(float, coords_path[24].split()) m = gmaps.Map(height='650px') ochDirections = gmaps.directions_layer(start, end, waypoints=waypoints) m.add_layer(ochDirections) start = map(float, coords_path[24].split(' ')) waypoints = map(lambda p: map(float, p.split()), coords_path[25:-1]) end = map(float, coords_path[-1].split()) ochDirections = gmaps.directions_layer(start, end, waypoints=waypoints) m.add_layer(ochDirections) m</span></span></code> </pre><br>  The same can be done using Yandex.Maps, without breaking into two pieces. <br><br><pre> <code class="python hljs">base_yandex = <span class="hljs-string"><span class="hljs-string">'https://yandex.ru/maps/213/moscow/?ll=37.519600%2C55.819741&amp;z=10&amp;mode=routes&amp;rtext={rtext}&amp;rtt=mt&amp;rtm=atm'</span></span> rtext = <span class="hljs-string"><span class="hljs-string">'~'</span></span>.join(i.replace(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">'%2C'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> coords_path) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> base_yandex.format(rtext=rtext)</code> </pre><br>  I laid out all the code <a href="https://github.com/apetrin/och_billboards/blob/master/emsch_och_billboards-export.ipynb">on my github</a> as a jupyter notebook so that I could quickly try to do something similar. <br><br><h2>  The result is </h2><br>  So, in the end, the algorithm gave an estimate of time at 8 o'clock (without traffic jams for 6 hours).  At that moment, I wanted to get out of the comfort zone of the cute online, and really take a ride and take a picture of all the billboards.  Things are easy: the company was found, and we drove strictly in accordance with the constructed route. <br><br>  The final journey took only 10 hours.  Taking into account the stops and the search for many billboards, it seems to me that the ‚Äúextra‚Äù 25% of the time is fully justified.  We managed to drive through all the points in the list, but found only 23 of 35 billboards.  At the same time, it is interesting that we found 19 out of 24 billboards of 6x3 format, and only 4 of 11 cityboards. Most likely this is due to the fact that city formats in general are more attractive to advertisers (because they are located closer to the center), and therefore they are removed faster .  I do not exclude the banal version that billboards, in principle, did not hang. <br><br>  As a result, it seems to me, it turned out to be a rather interesting mix of a simple algorithm that simplifies the routine and gives a much better result than a person, and a real use of it on the roads of Moscow.  We did not win the children's competition of the Open School Championship in Economics, but it seemed that we found an order of magnitude more billboards than the most active participant. </div><p>Source: <a href="https://habr.com/ru/post/324864/">https://habr.com/ru/post/324864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324852/index.html">Pygest # 6. Releases, articles, interesting projects from the world of Python [March 14, 2017 - March 27, 2017]</a></li>
<li><a href="../324854/index.html">How to escape from the plane: a review of the book "Presentation of Information" by Edward Tufti (1990)</a></li>
<li><a href="../324856/index.html">The Pitch Canvas - template for short presentations.</a></li>
<li><a href="../324858/index.html">Alignment in Bootstrap</a></li>
<li><a href="../324862/index.html">An example of creating a single chrome extension</a></li>
<li><a href="../324866/index.html">Introduction to cryptography and encryption, part one. Lecture in Yandex</a></li>
<li><a href="../324868/index.html">Read configuration files without problems</a></li>
<li><a href="../324870/index.html">The digest of interesting materials for the mobile # 196 developer (March 20-26)</a></li>
<li><a href="../324872/index.html">Roads that change us</a></li>
<li><a href="../324874/index.html">The proximity theory: the main rule of design, which helps to move from subjective feelings to specifics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>