<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Weekday cloud development, part one</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I will continue to continue the series of official posts in the company's blog about how to work with the cloud, but in parallel I want to tell you ab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Weekday cloud development, part one</h1><div class="post__text post__text-html js-mediator-article">  I will continue to continue the series of official posts in the company's blog about how to work with the cloud, but in parallel I want to tell you about the problems we encountered while adapting the Xen Cloud Platform to our cloud model.  These posts will be a bit more complicated and suggest that the reader at least in general knows how Xen works. <br><br>  When the concept of ‚Äúpayment by consumption‚Äù was just taking shape, and I frantically searched for ‚Äúhow to count‚Äù, it seemed to me that the processor and memory are the two simplest resources. <br><br>  Indeed, we have xencontrol (the Xen hypervisor management library), which can accurately tell about each domain (running virtual machine), how much memory it has, how many nanoseconds of time was spent.  This library requests information directly (via xenbus) from the hypervisor and subject it to minimal processing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This information looks something like this (outputting xencontrol for python): <br><pre> {
     'paused': 0, 
     'cpu_time': 1038829778010L, 
     'ssidref': 0, 
     'hvm': 0, 
     'shutdown_reason': 0, 
     'dying': 0, 
     'mem_kb': 262144L, 
     'domid': 3, 
     'max_vcpu_id': 7, 
     'crashed': 0, 
     'running': 0, 
     'maxmem_kb': 943684L, 
     'shutdown': 0, 
     'online_vcpus': 8, 
     'handle': [148, 37, 12, 110, 141, 24, 149, 226, 8, 104, 198, 5, 239, 16, 20, 25], 
     'blocked': 1
 }
</pre><br><br>  As we see, there is a mem_kb field corresponding to the allocated memory for the virtual machine and there is a cpu_time field containing some kind of mind-blowing number (although in reality it is only 17 minutes).  cpu_time considers up to nanoseconds (more precisely, the value that is stored here is considered to be in nanoseconds, the real accuracy is about a microsecond).  Memory, as is clear, in kilobytes (although the internal unit of account is that the hypervisor, that the linux kernel is the <em>page</em> - its default size is 4 kilobyte). <br><br>  It would seem ‚Äútake it and count‚Äù, however, the devil is in the details ... <br><br>  Sorry for the yellow caption below, but that was exactly the question in the debate during the discussion of one of the problems: <br><br><h1>  Hyper-threading + Xen = stealing money from customers </h1><br><a name="habracut"></a><br>  Question: Does Xth include hyperthreading or not?  Its inclusion allows the client to offer more cores.  For two Zeons, 4 cores each, this will give 16 cores, and if we reserve a couple for our own needs, then 14 cores.  14 cooler than 8?  Cooler  So it should be 14. <br><br>  In addition, if you run the multithread application, then it will calculate one and a half times faster on 14 "fake" kernels than on 7 real ones.  This is true, I tested on tests on the "bare" Linux on one of the test servers. <br><br>  ... Stop.  In a half?  That is, 14 cores will work one and a half times less with twice the number of cores? <br><br>  Yes, that is exactly what happened.  The situation became especially dramatic at the moment when I tried to run a numerically crusher with a maximum load in one virtual machine and a task that was obviously not solved within a few hours, and in another I launched an application that considers a computational problem fixed in volume.  And compared how much time it took when calculating with hyper-trading turned off and with it turned on. <br><br><table><tbody><tr><td>  Load level </td><td>  CPU time without HT </td><td>  With HT </td></tr><tr><td>  neighbors idle, 1 core </td><td>  313.758 </td><td>  313.149 </td></tr><tr><td>  idle neighbors, 4 cores </td><td>  79.992 * 4 </td><td>  80.286 * 4 </td></tr><tr><td>  idle neighbors, 8 cores </td><td>  40.330 * 8 </td><td>  40.240 * 8 </td></tr><tr><td>  idle neighbors, 16 cores </td><td>  - </td><td>  29.165 * 16 </td></tr><tr><td>  fully loaded neighbors, 1 core </td><td>  313.958 </td><td>  469.510 </td></tr><tr><td>  fully loaded neighbors, 4 cores </td><td>  79.812 * 4 </td><td>  119.33 * 4 </td></tr><tr><td>  fully loaded neighbors, 8 cores </td><td>  40.119 * 8 </td><td>  59.376 * 8 </td></tr><tr><td>  fully loaded neighbors, 16 cores </td><td>  - </td><td>  29.634 * 16 </td></tr></tbody></table><br><br>  Easy to see, 29.6 * 16 is 473.6, as well as 59.376 * 8 (475).  And this is one and a half times more than 40.119 * 8 (320). <br><br>  In other words, hyper-threading slows down processors by one and a half times when their number doubles. <br><br>  It helps if the processor is entirely yours.  And if processor time is paid and there are not even ‚Äúcolleagues‚Äù nearby, but simply ‚Äúoutsiders‚Äù? <br><br>  After that, we had a big discussion (it took about three days with interruptions) - do you want HT to do cloud on clients for clients?  In addition to the obvious ‚Äúhonestly dishonest‚Äù and ‚Äúno one will know‚Äù there were much more serious arguments: <br><ul><li>  One server will generate more processor resources (something for which Intel did this technology) </li><li>  We can take this ‚Äúperformance loss‚Äù into account in reducing the price of machine time. </li><li>  We can monitor the host load and avoid overloading above 50%, but we can provide the client with more cores </li></ul><br><br>  After the discussion, we came to the following set of arguments: We cannot control and really (not statistically) predict the consumption of computer time.  Migration, although it is a way out, is partial, because the migration reaction should be about 30-40 seconds minimum, and loading trips can be instantaneous (less than a second).  In this regard, we do not know what machine time (full or not) we provided to the client, and in any case the client will face unjustified loss of productivity for no apparent reason due to the fact that his neighbor wanted to find something heavy. <br><br>  Due to the inability to ensure constant performance of a virtual machine with hyper-threading, we still won the view that HT in the cloud with computer time must be turned off (hence the limit of 8 cores per virtual machine). <br><br><h1>  Migration: copy and delete </h1><br>  The second ridiculous moment was the problem of resource accounting during migration.  By default, it is assumed that a handle (aka uuid) is a proof of the uniqueness of an object, and there can be no two virtual machines with one uuid.  Indeed it is.  However, this applies to virtual machines, not domains.  During migration, the contents of the domain (RAM) are copied, launched on the new node, and only after that is deleted on the old one.  All this is accompanied by numerous re-copies of domain fragments (since the virtual machine continues to work at the same time).  In any case, we have TWO domains from ONE virtual machine.  If we count roughly (to sum up) roughly and in the forehead, then in the total counters we will get completely incorrect numbers.  (By the way, this problem was discovered rather late and was one of the reasons for the launch delay). <br><br>  The solution to the problem was elegant and architecturally beautiful.  Only one copy of the domain can work at a time, all others are in pause mode.  This is very important, because if two domains work for us, they can break up rare firewood.  Thus, the solution looks like this: a stopped (paused) domain is not counted.  It has several minor negative effects: <br><ul><li>  We could not offer our clients a spectacular ‚Äúpause‚Äù button (in this mode, the domain exists, but is not executed).  Since such a domain consumes memory, we cannot afford to ignore it if the client pauses the virtual machine and goes on vacation.  We cannot distinguish between a ‚Äúpause during migration‚Äù and simply a ‚Äúpause‚Äù (at least without very large and nontrivial dances with states and databases). </li><li>  When the client reboots the machine, there is a small moment when the domain already exists, but still paused - we do not consider it (thus, the client, constantly rebooting the machine will be able to unrecordedly consume a small amount of memory).  It is possible that it is even more honest, because these are our problems - where there is what is being built, until the machine starts to work, the client has no reason to pay for it. </li></ul><br><br>  But otherwise this solution has no side effects.  A few were discussed: the presence of blocking in the accounting database, accounting for the life of the domain, etc.  All of them against the background of the elegance of the solution without taking into account the stopped domains look cumbersome and ugly (no one will praise himself, alas). <br><br><h1>  Who will pay for dom0? </h1><br>  Another giant problem was the dom0 boot problem.  When a user makes a request over the network or performs disk operations, the request is transferred from the domU (the domain, which is the running virtual machine) to the second half of the driver in dom0.  The driver thinks about the request, passes it to the real drivers of real hardware.  And I must say, with intensive disk operations, he thinks oh how.  See us under 50-80% - how to make figs.  And most of this number is OVS, blktap, xenstore, etc.  (the rest is xapi, squeezed, stunnel, which are part of the cloud management system).  Who to charge for this machine time?  And most importantly, how to separate one user from another?  At the driver level, this is perhaps even possible, but more ... <br>  The same OVS (Open vSwitch, a program that provides a virtual network) switches frames, and it doesn‚Äôt matter what domain they belong to. <br><br>  Zenovtsy (the developers of the hypervisor and his strapping) broke his head over this issue.  I also began to think, but I came to my senses in time.  If disk operations are paid, then in their price, in fact, laid the cost of processing the request.  These are not only IOPS disks, load on raid controllers, SAN, depreciation of 10G cards, etc.  This and (quite insignificant for the price against the above) machine time dom0.  Everything is logical and decided by itself. </div><p>Source: <a href="https://habr.com/ru/post/112227/">https://habr.com/ru/post/112227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112215/index.html">Windows Phone 7 Games Review (Part 1)</a></li>
<li><a href="../112216/index.html">Simple things with difficult AppEngine</a></li>
<li><a href="../112217/index.html">The book "Branding and identification of the present and the future"</a></li>
<li><a href="../112221/index.html">Reflections on the implementation of the social graph</a></li>
<li><a href="../112222/index.html">Data structures: binary heap</a></li>
<li><a href="../112229/index.html">The amendment to allow free copying of books for libraries really gave a red light</a></li>
<li><a href="../112230/index.html">Search Trends at Euronews</a></li>
<li><a href="../112232/index.html">Americans bought 15% of Kaspersky Lab shares</a></li>
<li><a href="../112233/index.html">If I lived in another country ...</a></li>
<li><a href="../112235/index.html">"Planet Pile of Iron" # 3: Assorted Iron</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>