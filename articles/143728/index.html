<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Drag and drop images in Flash in the browser</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="During the testing of your service, there was a sufficient amount of feedback that the old-school method of uploading files to the application does no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Drag and drop images in Flash in the browser</h1><div class="post__text post__text-html js-mediator-article">  During the testing of your service, there was a sufficient amount of feedback that the old-school method of uploading files to the application does not take away.  People wanted to drag and drop and tried to drag pictures right from the desktop.  The application occupies our entire browser screen and is written on a flash, so there was no direct way to solve the problem. <br><br>  After thinking and googling decided to implement D &amp; D at least for chrome like this: <br>  When the user switches from the tab with the application, i.e.  it loses focus, on top of the flash drive a div is placed on which the event of catching dropped files is hung. <br>  Then, through the ExternalInterface, the image in the form of a ByteArray is transmitted to flash, where it is decoded and displayed. <br><a name="habracut"></a><br><br>  <b>Display div over flash</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="html hljs xml">#over_holder_full { background-color: #eee; opacity: 0.6; position: absolute; width: 100%; height: 100%; z-index: 7; display: none; } #flash_conainer { width: 100%; height: 100%; position: absolute; z-index: 0; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"over_holder_full"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"flash_conainer"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myContent"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Alternative content<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Showing #over_holder_full when losing focus, which is drag and drop <br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'blur'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ fullDragArea.style.display = <span class="hljs-string"><span class="hljs-string">"block"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"not focused"</span></span>); }); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'focus'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ fullDragArea.style.display = <span class="hljs-string"><span class="hljs-string">"none"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"focus"</span></span>); });</code> </pre><br><br>  <b>Catching a file dropped by #over_holder_full</b> <br><br><pre> <code class="javascript hljs">fullDragArea = $id(<span class="hljs-string"><span class="hljs-string">"over_holder_full"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// is XHR2 available? var xhr = new XMLHttpRequest(); if (xhr.upload) { fullDragArea.addEventListener("dragover", FileDragHover, false); fullDragArea.addEventListener("drop", FileSelectHandler, false); // &lt;--     //.... }</span></span></code> </pre><br><br>  <b>Image transfer in flash</b> <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// file selection function FileSelectHandler(e) { fullDragArea.style.display = "none"; // fetch FileList object var files = e.target.files || e.dataTransfer.files; //set grey preview in flash setPreview(pageX, pageY); // process all File objects setTimeout(function(){//&lt;--     setPreview     for (var i = 0, f; f = files[i]; i++) { ParseFile(f); }}, 100); } // output file information function ParseFile(file) { var arrBuffer; if (file.type.indexOf("image") == 0) { var reader = new FileReader(); reader.onload = function(e) { //console.log("arrBuffer + " + e.target.result.byteLength); var dataview = new DataView(e.target.result); var ints = new Int32Array(e.target.result.byteLength / 4); //&lt;--       for (var i = 0; i &lt; ints.length; i++) { ints[i] = dataview.getInt32(i * 4);//&lt;--    4  (        ByteArray) } console.log("ints" + ints.length); // display an image setImage(pageX, pageY, ints); } reader.readAsArrayBuffer(file); } }</span></span></code> </pre><br><br>  Functions connecting JavaScript and Flash <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pageX, pageY, int32Arr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swfReady){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; int32Arr.length; i++) { res[i] = int32Arr[i]; <span class="hljs-comment"><span class="hljs-comment">//&lt;--   ..  externalinterface      ,  Int32Array   } getSWF("DefaultLauncher").setImage(pageX, pageY, res);//    -   } } function setPreview(pageX, pageY) { if (swfReady) { console.log("setPreview"); getSWF("DefaultLauncher").setPreview(pageX, pageY); } }</span></span></code> </pre><br><br>  Take the image on the flush side <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exManager:EXManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EXManager(); exManager.setImageCallback = function(pageX:Number, pageY:Number, listBytes:Array):<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ba:ByteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i:<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;listBytes.length; i++){ ba.writeInt(listBytes[i]); <span class="hljs-comment"><span class="hljs-comment">//  ByteArray } var myDecoder:JPEGDecoder = new JPEGDecoder(); //        ByteArray myDecoder.parse(ba); var colorComponents:uint = myDecoder.colorComponents; var numComponents:uint = myDecoder.numComponents; var pixels:Vector.&lt;uint&gt; = myDecoder.pixels; var width:uint = myDecoder.width; var height:uint = myDecoder.height; var bitmap:BitmapData = new BitmapData ( width, height, false ); bitmap.setVector ( bitmap.rect, pixels ); var bmp:Bitmap = new Bitmap(bitmap); var oldW:Number = bmp.width; bmp.width = bmp.width &gt; 500 ? 500 : bmp.width; bmp.height = bmp.height*(bmp.width / oldW); bmp.x = pageX; bmp.y = pageY; stage.addChild(bmp); } exManager.setPreviewCallback = function(pageX:Number, pageY:Number):void{ var sp:Sprite = new Sprite(); sp.graphics.beginFill(0x666666, 0.8); sp.graphics.drawRect(0,0,100,80); sp.x = pageX; sp.y = pageY; stage.addChild(sp); }</span></span></code> </pre><br><br>  <b>Sources</b> can be downloaded <a href="http://webfile.ru/5950322">here.</a> <br><br>  <b>Comment:</b> <br>  This example only works with images with a JPG extension, but it can be easily extended to any other formats. <br><br>  Because of the wmode: opaque property, which is necessary to display a div on top of it, the scroll doesn't work in the flash drive.  If there are solutions I will be glad to hear them. <br><br>  To run the example you need to place it at least on the local server. <br><br>  <b>Update:</b> <br>  As suggested, in order to overcome the glitch with the mouseWheel event, you need to add the following to js: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wheel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> delta = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!event) event = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.event; <span class="hljs-comment"><span class="hljs-comment">//  IE. //   delta if (event.wheelDelta) { // IE, Opera, safari, chrome -    120 delta = event.wheelDelta/120; } else if (event.detail) { // Mozilla,    3 delta = -event.detail/3; } //    mousewheel if (delta &amp;&amp; typeof wheelHandle == 'function') { wheelHandle(delta); //    -   ( ). if (event.preventDefault) event.preventDefault(); event.returnValue = false; //  IE } } function wheelHandle(delta){ if (swfReady){ getSWF("DefaultLauncher").externalMouseWheelHandler(delta); } } function pageInit() { jsReady = true; //   mousewheel if (window.addEventListener) // mozilla, safari, chrome window.addEventListener('DOMMouseScroll', wheel, false); // IE, Opera. window.onmousewheel = document.onmousewheel = wheel; }</span></span></code> </pre><br><br>  And also add in flash: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> function </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">externalMouseWheelHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(delta:</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> globalPoint:Point = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(stage.mouseX, stage.mouseY); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objects:Array = stage.getObjectsUnderPoint(globalPoint); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!objects || !objects.length) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> target:DisplayObject = objects[objects.length - <span class="hljs-number"><span class="hljs-number">1</span></span>] as DisplayObject; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!target) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } target = (target is InteractiveObject) ? target : target.parent; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!target) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> localPoint:Point = target.globalToLocal(globalPoint); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mouseEvent:MouseEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MouseEvent(MouseEvent.MOUSE_WHEEL); mouseEvent.localX = localPoint.x; mouseEvent.localY = localPoint.y; mouseEvent.delta = delta; target.dispatchEvent(mouseEvent); }</code> </pre><br><br>  <b>Update 2:</b> <br>  After some experiments, it became clear that it is better to transfer data in chunks, as well as read from the buffer not via <code>getInt32</code> but through <code>getInt8</code> , since  the length of the file is not necessary to be a multiple of 4, as expected in the first case <br><br>  <i>Javascript</i> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setImage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bufer</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (swfReady){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataview = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DataView</span></span>(bufer); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteLength = bufer.byteLength; <span class="hljs-comment"><span class="hljs-comment">//    4 var numBytes = 10000; var startPos = 0; var finishPos; var i = 0; while(i &lt; byteLength){ finishPos = ((startPos + numBytes) &gt; byteLength) ? byteLength : startPos + numBytes; var res = []; for (i = startPos; i &lt; finishPos; i++) { res[i - startPos] = dataview.getInt8(i); //  getInt32  getInt8 } startPos = finishPos; getSWF().sendData(res); } getSWF().sendDataFinish(); } } function setPreview(pageX, pageY, fileName) { if (swfReady){ getSWF().sendDataStart(pageX, pageY, fileName); } }</span></span></code> </pre><br><br>  <i>ActionScript</i> <br><pre> <code class="actionscript hljs">_exManager.sendDataStartCb = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pageX:Number, pageY:Number, fileName:String)</span></span></span><span class="hljs-function">:void </span></span>{ prevtime = getTimer(); }; _exManager.sendDataCb = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(listBytes:Array)</span></span></span><span class="hljs-function">:void </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i:int = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; listBytes.length; i++) { ba.writeByte(listBytes[i]);<span class="hljs-comment"><span class="hljs-comment">//      } }; _exManager.sendDataFinishCb = function():void { loadFromByteArray(ba); ba.clear(); };</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/143728/">https://habr.com/ru/post/143728/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143722/index.html">Teach Liferay Portal 6.0 EE SP2 to understand license files for version 6.1</a></li>
<li><a href="../143723/index.html">Development of the Russian-language analogue ‚ÄúSiri‚Äù: epilogue</a></li>
<li><a href="../143724/index.html">The history of our gaming startup or "What to do ???"</a></li>
<li><a href="../143726/index.html">"Debriefing" - episode 17 - Sometimes they come back ...</a></li>
<li><a href="../143727/index.html">The decision of "Drop quest 2012"</a></li>
<li><a href="../143729/index.html">Examination completed, the computers returned</a></li>
<li><a href="../143730/index.html">Best Free GIF Animation Software for Windows</a></li>
<li><a href="../143731/index.html">I'm tired of registering</a></li>
<li><a href="../143732/index.html">iPad Wi-Fi + 4G renamed to iPad Wi-Fi + Cellular</a></li>
<li><a href="../143733/index.html">Descriptions of audio editors under Windows. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>