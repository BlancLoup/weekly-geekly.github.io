<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Replication Framework ‚Ä¢ deep copying and generalized comparison of connected object graphs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings reader! 

 I want to introduce you to the young but promising Replication Framework library for the .NET platform (perhaps, if there is enou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Replication Framework ‚Ä¢ deep copying and generalized comparison of connected object graphs</h1><div class="post__text post__text-html js-mediator-article">  Greetings reader! <br><br>  I want to introduce you to the young but promising <i>Replication Framework</i> library for the <i>.NET</i> platform (perhaps, if there is enough interest in the topic, the <i>Java</i> version will also be implemented in the future).  The library is portable ( <i>portable</i> ) and can be used in any project under <i>Microsoft .NET</i> or <i>Mono</i> . <br><br>  The purpose of the library is in-depth copying of any objects and arbitrarily complex graphs, their generalized comparison, serialization and deserialization without distortion, tracking mutations, and state manipulation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/aa9/ee6/91b/aa9ee691ba4fa5fdd3d5550c3dc4f66d.jpg" alt="image"><br><a name="habracut"></a><br><br>  <b>First of all, we define the terminology and basic entities.</b> <br><br>  ‚Ä¢ <u>A snapshot</u> is an instant snapshot of the state of an object, isolated from the source and quite static during the execution of a program, thereby protected from accidental mutations.  It is like a drawing or a sketch according to which you can later recreate a new object [graph] with the previous state, or you can set a specific state to an existing one. <br><br>  You can take pictures from different angles, that is, interpret the state of objects differently, for example, collect values ‚Äã‚Äãof absolutely all properties and fields of instances, or only public, but often only those members that are marked with the special attribute <i>DataMember</i> .  The way in which to take a snapshot depends on the <i>ReplicationProfile</i> [replication profile] and in particular on its internal list <i>MemberProviders</i> [member providers]. <br><br><blockquote>  <i>* By default, if a class has <i>DataContract</i> or <i>CollectionDataContract</i> attributes, then only members with the <i>DataMember</i> attribute are translated to the snapshot; otherwise, all fields and properties of the class are public or not.</i> </blockquote><br><div class="spoiler">  <b class="spoiler_title">A small example of using replication profiles</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = instance0.CreateSnapshot(); <span class="hljs-comment"><span class="hljs-comment">/* use default ReplicationProfile */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customReplicationProfile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplicationProfile { MemberProviders = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;MemberProvider&gt; { <span class="hljs-comment"><span class="hljs-comment">//new MyCustomMemberProvider(), /* you may override and customize MemberProvider class! */ new CoreMemberProviderForKeyValuePair(), //new CoreMemberProvider(BindingFlags.Public | BindingFlags.Instance, Member.CanReadWrite), new ContractMemberProvider(BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance, Member.CanReadWrite) } }; var snapshot1 = instance1.CreateSnapshot(customReplicationProfile ); Snapshot.DefaultReplicationProfile = customReplicationProfile;</span></span></code> </pre> <br></div></div><br>  In general, a snapshot is a <i>json</i> -like data structure in which complex composite objects are parsed into primitives and converted into dictionaries, where the key is the name of a member (property or field) and the value is the corresponding primitive ( <i>string</i> , <i>int</i> , <i>DateTime</i> , etc.). ).  All collections, including arrays, are a special kind of objects that, in addition to the usual properties, have one more implicit for the enumeration operation ( <i>foreach</i> ), and its value is equivalent to a <i>json-</i> array. <br><br>  ‚Ä¢ <u>Reconstruction</u> - the operation of converting the object graph to its original state on the basis of a snapshot and already existing cached instances of objects.  Usually, in the course of program execution, objects and graphs consisting of them are modified, that is, mutated, but sometimes it is useful to be able to return [roll back] the graph and its objects to some specific state fixed earlier. <br><br><div class="spoiler">  <b class="spoiler_title">The reconstruction is as follows</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = graph0.CreateSnapshot(cache); <span class="hljs-comment"><span class="hljs-comment">/* modify 'graph0' by any way */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> graphX = snapshot0.ReconstructGraph(cache); <span class="hljs-comment"><span class="hljs-comment">/* graphX is the same reference that graph0, all items of the graph reverted to the previous state */</span></span></code> </pre> <br></div></div><br><blockquote>  <i>* It should be remembered that cached objects are kept from garbage collection, and during the reconstruction all of them return to their original state.</i> </blockquote><br>  ‚Ä¢ <u>Replication</u> - the operation of deep copying of the object graph on the basis of a snapshot, as a result of which a new copy of the graph is created isolated from the original one. <br><br><div class="spoiler">  <b class="spoiler_title">Replication is done as follows.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = graph0.CreateSnapshot(cache); <span class="hljs-comment"><span class="hljs-comment">/* modify 'graph0' by any way */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> graph1 = snapshot0.ReplicateGraph(cache); <span class="hljs-comment"><span class="hljs-comment">/* graph1 is a deep copy of the source graph0 */</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <i><b class="spoiler_title">* Difference between shallow and deep copying</b></i> <div class="spoiler_text"><blockquote>  <i>Copying is of two types - superficial and deep.</i>  <i>Let objects A and B be given, moreover, A contains a reference to B (column A =&gt; B).</i>  <i>At the surface copying of object A, object A 'will be created, which will also refer to B, that is, in the end, we get two columns A =&gt; B and A' =&gt; B.</i>  <i>They will have a common part B, so when changing object B in the first column, its state will automatically mutate in the second one.</i>  <i>Objects A and A 'will remain independent.</i>  <i>But the most interesting are the graphs with closed (cyclic) links.</i>  <i>Let A refer to B and B refer to A (A &lt;=&gt; B), when copying object A to A, we get a very unusual graph A '=&gt; B &lt;=&gt; A, that is, the original object got into the final graph subjected to cloning.</i>  <i>Deep copying involves the cloning of all objects included in the graph.</i>  <i>For our case, A &lt;=&gt; B is converted to A '&lt;=&gt; B', as a result, both graphs are completely isolated from each other.</i>  <i>In some cases, superficial copying is sufficient, but not always.</i> </blockquote> <i><br></i> </div></div><br>  ‚Ä¢ <u><i>Juxtaposition</i></u> - a recursive operation of comparing a reference image of an object with a snapshot of the current sample. <br><br><div class="spoiler">  <b class="spoiler_title">Example of matching two snapshots</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = instance0.CreateSnapshot(); <span class="hljs-comment"><span class="hljs-comment">/* etalon */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot1 = instance1.CreateSnapshot(); <span class="hljs-comment"><span class="hljs-comment">/* sample */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> juxtapositions = snapshot0.Juxtapose(snapshot1).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> differences = juxtapositions.Where(j=&gt;j.State == Etalon.State.Different);</code> </pre> <br></div></div><br>  Comparison of objects is an extensive topic in programming, and comparisons are an attempt to generalize it to the whole class of problems.  How successful the attempt is, you can evaluate it yourself. <br><br>  Let us have an instance of any object.  At the initial moment of time, we take a snapshot of its state, after some time we can repeat the snapshot and, comparing both snapshots, identify all mutations of interest to us that have occurred with this instance, that is, implement state tracking.  It is worth noting that in practice it is not always possible to copy an object or simply to keep track of changes, but it is always easy to take a picture of it. <br><br>  In the case when we have two or more instances of objects, for example: reference and workers, they can be either of the same type or different.  Their pictures can be taken at arbitrary points in time and compared in any combination without restrictions.  Matching is done by member names (properties and fields). <br><br><blockquote>  <i>* Importantly, the result of the mapping operation is <code>IEnumerable&lt;Juxtaposition&gt;</code> , which makes it possible to interrupt the recursive mapping process at any time after certain conditions are reached, rather than producing it completely, which in turn is significant for performance.</i> </blockquote><br>  <b>We turn to practice and pay attention to the key points.</b> <br><br><div class="spoiler">  <b class="spoiler_title">Code to generate diagnostic object graph</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Runtime.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Art.Replication.Diagnostics</span></span> { [DataContract] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Role</span></span> { [DataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> CodePhrase; [DataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime LastOnline = DateTime.Now; [DataMember] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Person Person; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Person</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FirstName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LastName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Birthday; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Role&gt; Roles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Role&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DiagnosticsGraph</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Person </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Person { FirstName = <span class="hljs-string"><span class="hljs-string">"Keanu"</span></span>, LastName = <span class="hljs-string"><span class="hljs-string">"Reeves"</span></span>, Birthday = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1964</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span> ,<span class="hljs-number"><span class="hljs-number">2</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roleA0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Role { Name = <span class="hljs-string"><span class="hljs-string">"Neo"</span></span>, CodePhrase = <span class="hljs-string"><span class="hljs-string">"The Matrix has you..."</span></span>, LastOnline = DateTime.Now, Person = person0 }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roleB0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Role { Name = <span class="hljs-string"><span class="hljs-string">"Thomas Anderson"</span></span>, CodePhrase = <span class="hljs-string"><span class="hljs-string">"Follow the White Rabbit."</span></span>, LastOnline = DateTime.Now, Person = person0 }; person0.Roles.Add(roleA0); person0.Roles.Add(roleB0); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> person0; } } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Namespaces that may come in handy</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Art; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Art.Replication; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Art.Replication.Replicators; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Art.Replication.MemberProviders; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Art.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Art.Serialization.Converters;</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Creating a snapshot and serializing it into a string without distortion with default settings</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateAndSerializeSnapshot</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person0 = DiagnosticsGraph.Create(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = person0.CreateSnapshot(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> rawSnapsot0 = snapshot0.ToString(); Console.WriteLine(rawSnapsot0); Console.ReadKey(); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Result of work (the full structure of the image is clearly visible)</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">{ <span class="hljs-symbol"><span class="hljs-symbol">#Id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#Type</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Art.Replication.Diagnostics.Person, Art.Replication.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span></span>, <span class="hljs-type"><span class="hljs-type">FirstName</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Keanu"</span></span>, <span class="hljs-type"><span class="hljs-type">LastName</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Reeves"</span></span>, <span class="hljs-type"><span class="hljs-type">Birthday</span></span>: <span class="hljs-comment"><span class="hljs-comment">"1964-09-02T00:00:00.0000000+03:00"</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DateTime</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">Roles</span></span>: { <span class="hljs-symbol"><span class="hljs-symbol">#Id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#Type</span></span>: <span class="hljs-comment"><span class="hljs-comment">"System.Collections.Generic.List`1[[Art.Replication.Diagnostics.Role, Art.Replication.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null]], mscorlib, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#Set</span></span>: [ { <span class="hljs-symbol"><span class="hljs-symbol">#Id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#Type</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Art.Replication.Diagnostics.Role, Art.Replication.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span></span>, <span class="hljs-type"><span class="hljs-type">Name</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Neo"</span></span>, <span class="hljs-type"><span class="hljs-type">LastOnline</span></span>: <span class="hljs-comment"><span class="hljs-comment">"2017-06-14T14:42:44.0000575+03:00"</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DateTime</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">Person</span></span>: { <span class="hljs-symbol"><span class="hljs-symbol">#Id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } }, { <span class="hljs-symbol"><span class="hljs-symbol">#Id</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">#Type</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Art.Replication.Diagnostics.Role, Art.Replication.Diagnostics, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null"</span></span>, <span class="hljs-type"><span class="hljs-type">Name</span></span>: <span class="hljs-comment"><span class="hljs-comment">"Thomas Anderson"</span></span>, <span class="hljs-type"><span class="hljs-type">LastOnline</span></span>: <span class="hljs-comment"><span class="hljs-comment">"2017-06-14T14:42:44.0000575+03:00"</span></span>&lt;<span class="hljs-type"><span class="hljs-type">DateTime</span></span>&gt;, <span class="hljs-type"><span class="hljs-type">Person</span></span>: { <span class="hljs-symbol"><span class="hljs-symbol">#Id</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> } } ] } }</code> </pre><br></div></div><br>  ‚Ä¢ The Person class has the <i>DataContract</i> attribute, so all its fields with the <i>DataMember attribute</i> , except for <i>CodePhrase</i> , are in the snapshot. <br><br>  ‚Ä¢ Each object is assigned its own identifier <i>#Id: 0</i> , if the link to the object is found in the object graph more than once, then the following construction is substituted instead of replication. <br><br><pre> <code class="javascript hljs"> Person: { #Id: <span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br>  This protects against multiple replication of the same object instance, and in cases of cyclic references from entering endless recursion and <i>Stack Overflow Exception</i> ( <i>note</i> : not all serializers can cope with such situations). <br><br>  ‚Ä¢ To each object, complete type information is added by the <i>#Type</i> key. <br>  ‚Ä¢ Some primitives also contain information about the type of <code>Birthday: "1964-09-02T00:00:00.0000000+03:00"&lt;DateTime&gt;</code> .  It is necessary to restore (deserialize) the image without distortion. <br>  ‚Ä¢ The List &lt;Role&gt; collection is serialized as an object, but it has the <i>#Set</i> property, which is used to list nested objects. <br><br>  However, one should not think that seralization and deserialization are supported by the library only in such a full format, it is also possible to use more classic <i>json</i> by adjusting the replication and saving profiles (there may be minor distortions inherent in ordinary serializers). <br><br><div class="spoiler">  <b class="spoiler_title">Serialization of an object into classic json and its successful deserialization</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseClassicalJsonSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Snapshot.DefaultReplicationProfile.AttachId = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Snapshot.DefaultReplicationProfile.AttachType = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Snapshot.DefaultReplicationProfile.SimplifySets = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Snapshot.DefaultReplicationProfile.SimplifyMaps = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; Snapshot.DefaultKeepProfile.SimplexConverter.AppendTypeInfo = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Snapshot.DefaultKeepProfile.SimplexConverter.Converters .OfType&lt;NumberConverter&gt;().First().AppendSyffixes = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateAndSerializeSnapshotToClassicJsonStyle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { UseClassicalJsonSettings(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person0 = DiagnosticsGraph.Create(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = person0.CreateSnapshot(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> rawSnapsot0 = snapshot0.ToString(); Console.WriteLine(rawSnapsot0); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person0A = rawSnapsot0.ParseSnapshot().ReplicateGraph&lt;Person&gt;(); Console.WriteLine(person0A.FirstName); Console.ReadKey(); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Classic json</b> <div class="spoiler_text"><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">FirstName</span></span>: <span class="hljs-string"><span class="hljs-string">"Keanu"</span></span>, LastName: <span class="hljs-string"><span class="hljs-string">"Reeves"</span></span>, Birthday: <span class="hljs-string"><span class="hljs-string">"1964-09-02T00:00:00.0000000+03:00"</span></span>, Roles: [ { Name: <span class="hljs-string"><span class="hljs-string">"Neo"</span></span>, LastOnline: <span class="hljs-string"><span class="hljs-string">"2017-06-14T18:31:20.0000205+03:00"</span></span>, Person: { #Id: <span class="hljs-number"><span class="hljs-number">0</span></span> } }, { <span class="hljs-attribute"><span class="hljs-attribute">Name</span></span>: <span class="hljs-string"><span class="hljs-string">"Thomas Anderson"</span></span>, LastOnline: <span class="hljs-string"><span class="hljs-string">"2017-06-14T18:31:20.0000205+03:00"</span></span>, Person: { #Id: <span class="hljs-number"><span class="hljs-number">0</span></span> } } ] }</code> </pre> <br></div></div><br>  <b>About saving and restoring state without distortion</b> <br><br>  Of course, it is always convenient to be able to save the state of objects (graphs) into a string or an array of bytes for later recovery.  As a rule, serialization mechanisms are used for this.  They are quite functional, but upon their close inspection a number of hard restrictions are often revealed that are imposed by a specific serializer on objects, for example, attributes or annotations, special methods, the absence of closed references in the graph, the presence of a constructor without parameters, or something else may be necessary. <br><br>  But there are also two implicit minuses that are common to many serializers.  First, as mentioned earlier, if there are several references to the same instance of an object in the graph, some serializers save it again, which is why deserialization already produces several copies of the same object (the graph is significantly modified).  Secondly, in some cases there can be a loss of information about the type of the object, which leads to a distorted restoration of the types of objects during deserialization, for example, <i>long</i> turns into <i>int</i> , <i>Guid</i> into a string or vice versa. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Distorsion</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] AnyObjects = { Guid.NewGuid(), Guid.NewGuid().ToString(), DateTime.Now, DateTime.Now.ToString(<span class="hljs-string"><span class="hljs-string">"O"</span></span>), <span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">123L</span></span>, }; }</code> </pre> <br>  <i>Replication Framework</i> uses its own <i>json-</i> serializer, which saves metadata about object types, supports multiple and cyclic references in a graph, which makes it possible to complete deserialization without distortion. <br><br>  <b>Key Usage Scenarios</b> <br><br>  Replication: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Replicate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person0 = DiagnosticsGraph.Create(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> snapshot0 = person0.CreateSnapshot(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person1 = snapshot0.ReplicateGraph&lt;Person&gt;(); person1.Roles[<span class="hljs-number"><span class="hljs-number">1</span></span>].Name = <span class="hljs-string"><span class="hljs-string">"Agent Smith"</span></span>; Console.WriteLine(person0.Roles[<span class="hljs-number"><span class="hljs-number">1</span></span>].Name); <span class="hljs-comment"><span class="hljs-comment">// old graph value: Thomas Anderson Console.WriteLine(person1.Roles[1].Name); // new graph value: Agent Smith Console.ReadKey(); }</span></span></code> </pre> <br>  Reconstruction: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reconstract</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> person0 = DiagnosticsGraph.Create(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s = person0.CreateSnapshot(cache); Console.WriteLine(person0.Roles[<span class="hljs-number"><span class="hljs-number">1</span></span>].Name); <span class="hljs-comment"><span class="hljs-comment">// old graph value: Thomas Anderson Console.WriteLine(person0.FirstName); // old graph value: Keanu person0.Roles[1].Name = "Agent Smith"; person0.FirstName = "Zion"; person0.Roles.RemoveAt(0); var person1 = (Person)s.ReconstructGraph(cache); Console.WriteLine(person0.Roles[1].Name); // old graph value: Thomas Anderson Console.WriteLine(person1.Roles[1].Name); // old graph value: Thomas Anderson Console.WriteLine(person0.FirstName); // old graph value: Keanu Console.WriteLine(person1.FirstName); // old graph value: Keanu Console.ReadKey(); // result: person0 &amp; person1 is the same one reconstructed graph }</span></span></code> </pre> <br>  Matching: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Justapose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// set this settings for less details into output Snapshot.DefaultReplicationProfile.AttachId = false; Snapshot.DefaultReplicationProfile.AttachType = false; Snapshot.DefaultReplicationProfile.SimplifySets = true; Snapshot.DefaultReplicationProfile.SimplifyMaps = true; var person0 = DiagnosticsGraph.Create(); var person1 = DiagnosticsGraph.Create(); person0.Roles[1].Name = "Agent Smith"; person0.FirstName = "Zion"; var snapshot0 = person0.CreateSnapshot(); var snapshot1 = person1.CreateSnapshot(); var results = snapshot0.Juxtapose(snapshot1); foreach (var result in results) { Console.WriteLine(result); } Console.ReadKey(); } &lt;Different&gt; [this.FirstName] {Zion} {Keanu} &lt;Identical&gt; [this.LastName] {Reeves} {Reeves} &lt;Identical&gt; [this.Birthday] {9/2/1964 12:00:00 AM} {9/2/1964 12:00:00 AM} &lt;Identical&gt; [this.Roles[0].Name] {Neo} {Neo} &lt;Identical&gt; [this.Roles[0].LastOnline] {6/14/2017 9:34:33 PM} {6/14/2017 9:34:33 PM} &lt;Identical&gt; [this.Roles[0].Person.#Id] {0} {0} &lt;Different&gt; [this.Roles[1].Name] {Agent Smith} {Thomas Anderson} &lt;Identical&gt; [this.Roles[1].LastOnline] {6/14/2017 9:34:33 PM} {6/14/2017 9:34:33 PM} &lt;Identical&gt; [this.Roles[1].Person.#Id] {0} {0}</span></span></code> </pre> <br>  <b>About performance</b> <br><br>  Currently, the library has fairly good performance, but it is worth understanding that the use of a generalized intermediate snapshot mechanism imposes additional costs in terms of both memory and execution speed in some tasks.  However, in reality, not everything is so unequivocal, since the snapshot mechanism can also give a gain in a number of scenarios. <br><br>  Loss: <br><br>  - more memory consumption when serializing objects <br>  - approximately 2-2.5 times lower speed of serialization and subsequent deserialization (depends on the serialization settings and the type of tests) <br><br>  Winning: <br><br>  - copying a graph using a snapshot without using serialization and deserialization (no need to convert primitives into a string or an array of bytes, due to which acceleration is achieved) <br>  - better memory usage when partially storing the state of large objects in snapshots instead of copying them completely <br><blockquote>  <i>* Performance comparison was made with <i>BinaryFormatter</i> , <i>Newtonsoft.Json</i> , and also with <i>DataContractJsonSerializer</i> .</i> </blockquote><br>  <b>A few words in conclusion about the <i>Replication Framework</i></b> <br><br>  Developed a solution in a small creative studio "Meykloft" <a href="http://makeloft.xyz/workroom/replication-framework">[</a> <a href="http://makeloft.xyz/ru/">Makeloft</a> <a href="http://makeloft.xyz/workroom/replication-framework">]</a> .  Now the project is at the stage of preliminary version, but its capabilities are impressive, although only the basic functionality has been implemented.  A lot of time and effort was spent on development, therefore the <u>framework is free only for educational and non-commercial projects</u> . <br><br>  Currently, a commercial license for use in a separate project costs $ 15 ( <u>when purchasing a license, access to source codes is provided</u> , and if necessary, more detailed advice on technical subtleties, for example, how to replicate objects with parameterized constructors).  Probably in the future with the development of the solution the price will increase.  If you plan to use the framework on an ongoing basis in a variety of projects, then the cost of such a license can be negotiated in person. <br><br>  <a href="https://www.nuget.org/packages/Art.ReplicationFramework.Trial/">You can download the trial version from Nuget</a> , <u>it is functional until September 2017</u> .  The project with code examples from the article can be downloaded <a href="https://1drv.ms/u/s!AvvcPQX44tbIhc8gGoWUey0kUeQ09g">from here</a> .  If the library leaves a good impression and you decide to use it in any of your decisions, please send a request for a free or paid license to <a href="http://makeman%40tut.by/">makeman@tut.by.</a>  In the request, indicate the name and type of the project in which you plan to use the library. <br><br>  Thank you very much for your attention!  Feel free to ask questions and write wishes! </div><p>Source: <a href="https://habr.com/ru/post/330294/">https://habr.com/ru/post/330294/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330284/index.html">Memory leaks in Android and how to localize them</a></li>
<li><a href="../330286/index.html">HP DL120 G7 - the second life of the server</a></li>
<li><a href="../330288/index.html">Swift Playgrounds 1.5. Programming Sphero and more.</a></li>
<li><a href="../330290/index.html">Preview RamblerElixir # 3</a></li>
<li><a href="../330292/index.html">WWDC 2017. Let's poke a little bit</a></li>
<li><a href="../330296/index.html">Tips for engineers from Google manager</a></li>
<li><a href="../330298/index.html">WWDC - what does Apple bet on in 2017?</a></li>
<li><a href="../330300/index.html">Fairy tales that cloud providers will tell you</a></li>
<li><a href="../330302/index.html">Hacker, hack yourself</a></li>
<li><a href="../330304/index.html">IBM introduced the world's first 5-nanometer chip</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>