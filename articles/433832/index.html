<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Formatting Linux source code with ClangFormat: problems and solution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Agree, it is pleasant and useful when in the project the source code looks nice and consistent. This facilitates his understanding and support. We sho...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Formatting Linux source code with ClangFormat: problems and solution</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/bo/sx/sk/bosxskxlbpvscptb3sw0tmuhp_u.png"><br><br>  Agree, it is pleasant and useful when in the project the source code looks nice and consistent.  This facilitates his understanding and support.  We show and tell you how to implement the formatting of the source code using <em>clang-format</em> , <em>git</em> and <em>sh</em> . <br><a name="habracut"></a><br><h3>  Formatting problems and how to solve them </h3><br><p>  In most projects, there are certain rules for code design.  How to make so that all participants performed them?  Special programs come to the rescue - <em>clang-format, astyle, uncrustify,</em> but they have their drawbacks. <br><br>  The main problem with formatters is that they change entire files, not just changed lines.  Let us tell you how we coped with this using ClangFormat in one of the projects for developing embedded software for electronics, where C ++ was the main language.  The team employed several people, so it was important for us to ensure a uniform style of code.  Our solution can be suitable not only for C ++ programmers, but also for those who write code in C, Objective-C, JavaScript, Java, Protobuf. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For formatting, we used <em>clang-format-diff-6.0</em> .  At the start of the run command <br><br>  <em>git diff -U0 --no-color |</em>  <em>clang-format-diff-6.0 -i -p1</em> , but problems arose with it: <br></p><br><ol><li>  The program defined file types only by extension.  For example, files with the ts extension, which we had in xml format, perceived as javascript and dropped during formatting.  Then, for some reason, she tried to fix the pro-files of Qt projects, probably, like Protobuf. </li><li>  The program had to be run manually before adding files to the git index.  It was easy to forget about it. </li></ol><br><h4>  Decision </h4><br>  The result is the following sh script, run as a <em>pre-commit</em> hook for git: <br><br><pre><code class="cpp hljs">#!/bin/sh CLANG_FORMAT=<span class="hljs-string"><span class="hljs-string">"clang-format-diff-6.0 -p1 -v -sort-includes -style=Chromium -iregex '.*\.(cxx|cpp|hpp|h)$' "</span></span> GIT_DIFF=<span class="hljs-string"><span class="hljs-string">"git diff -U0 --no-color "</span></span> GIT_APPLY=<span class="hljs-string"><span class="hljs-string">"git apply -v -p0 - "</span></span> FORMATTER_DIFF=$(eval ${GIT_DIFF} --staged | eval ${CLANG_FORMAT}) echo <span class="hljs-string"><span class="hljs-string">"\n------Format code hook is called-------"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [ -z <span class="hljs-string"><span class="hljs-string">"${FORMATTER_DIFF}"</span></span> ]; then echo <span class="hljs-string"><span class="hljs-string">"Nothing to be formatted"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> echo <span class="hljs-string"><span class="hljs-string">"${FORMATTER_DIFF}"</span></span> echo <span class="hljs-string"><span class="hljs-string">"${FORMATTER_DIFF}"</span></span> | eval ${GIT_APPLY} --cached echo <span class="hljs-string"><span class="hljs-string">" ---Format of staged area completed. Begin format unstaged files---"</span></span> eval ${GIT_DIFF} | eval ${CLANG_FORMAT} | eval ${GIT_APPLY} fi echo <span class="hljs-string"><span class="hljs-string">"------Format code hook is completed----\n"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  What the script does: <br>  <b>GIT_DIFF = "git diff -U0 --no-color"</b> - changes in the code that will be input to <i>clang-format-diff-6.0.</i> <br><br><ul><li>  <strong>-U0</strong> : usually git diff outputs the so-called ‚Äúcontext‚Äù: a few unchanged lines of code around those that have been changed.  But <em>clang-format-diff-6.0</em> formats them too!  Therefore, the context in this case is not needed. </li></ul><br>  <b>CLANG_FORMAT = "clang-format-diff-6.0 -p1 -v -sort-includes -style = Chromium -iregex '. * \. (Cxx | cpp | hpp | h) $'"</b> - the command to format the diff received through the standard input <br><br><ul><li>  <strong>clang-format-diff-6.0</strong> is a script from the <em>clang-format-6.0</em> package.  There are other versions, but all tests were only on this one. </li><li>  <strong>-p1 is</strong> taken from the examples in the <a href="http://clang.llvm.org/docs/ClangFormat.html">documentation</a> , provides compatibility with the <em>git diff</em> output. </li><li>  <strong>-style = Chromium</strong> - ready preset for formatting code.  Other possible values: <em>LLVM, Google, Mozilla, WebKit</em> . <br></li><li>  <strong>-sort-includes</strong> - the option to sort alphabetically the <em>#include</em> directives (optional). </li><li>  <strong>-iregex '. * \. (cxx | cpp | hpp | h) $'</strong> is a regular expression that filters file names by extensions.  Only those extensions that need to be formatted are listed here.  This will save the program from falling and unexpected glitches.  Most likely the list will need to be added to new projects.  In addition to C ++, you can format <em>C / Objective-C / JavaScript / Java / Protobuf</em> .  Although we did not test these types of files. </li></ul><br>  <strong>GIT_APPLY = "git apply -v -p0 -" ‚Äîapplies the</strong> patch code issued by the previous command to the code. <br><br><ul><li>  <strong>-p0</strong> : by default, <em>git apply</em> skips the first component in the file path, this is incompatible with the format that <em>clang-format-diff-6.0</em> produces.  This transmission is disabled here. </li></ul><br>  <strong>FORMATTER_DIFF = $ (eval $ {GIT_DIFF} --staged | eval $ {CLANG_FORMAT})</strong> - changes the formatter for the index. <br><br>  <strong>echo "$ {FORMATTER_DIFF}" |</strong>  <strong>eval $ {GIT_APPLY} --cached</strong> formats the source code in the index (after <em>git add</em> ).  Unfortunately, there is no such hook that would work before adding files to the index.  Therefore, formatting is divided into two parts: what is in the index and what is not added to the index is formatted separately. <br><br>  <strong>eval $ {GIT_DIFF} |</strong>  <strong>eval $ {CLANG_FORMAT} |</strong>  <strong>eval $ {GIT_APPLY}</strong> - code formatting is not in the index (it starts only when something has been formatted in the index).  It formats all current changes in the project in general (under version control), and not just from the previous step.  This is a controversial, at first glance, decision.  But it turned out to be convenient, since  Sooner or later, other changes need to be formatted too.  You can replace <em>"| eval $ {GIT_APPLY}"</em> with the <em>-i</em> option, which will force <em>$ {CLANG_FORMAT}</em> to change files by itself. <br><br><h3>  Demonstration of work </h3><br><ol><li>  Install <em>clang-format-6.0</em> <br></li><li>  <strong>cd / tmp &amp;&amp; mkdir temp_project &amp;&amp; cd temp_project</strong> <br></li><li>  <strong>git init</strong> <br></li><li>  Add under version control and commit any C ++ file named <em>wrong.cpp</em> .  Preferably&gt; 50 lines of unformatted code. <br></li><li>  Make the <em>.git / hooks / pre-commit</em> script shown above. <br></li><li>  Assign launch permissions to the script (for git): <strong>chmod + x .git / hooks / pre-commit</strong> . <br></li><li>  To manually start the <strong>.git / hooks / pre-commit</strong> script, it should be run with the message <em>‚ÄúNothing to be formatted‚Äù</em> , without interpreter errors. <br></li><li>  Create <em>file.cpp</em> with the contents of <em>int main () {for (int i = 0; i &lt;100; ++ i) {std :: cout &lt;&lt; "First case" &lt;&lt; std :: endl;</em>  <em>std :: cout &lt;&lt; "Second case" &lt;&lt; std :: endl;</em>  <em>std :: cout &lt;&lt; "Third case" &lt;&lt; std :: endl;</em>  <em>}} in</em> one line or with another bad formatting.  At the end - a line break! <br></li><li>  <strong>git add file.cpp &amp;&amp; git commit -m "file.cpp"</strong> should be messages from a script like <em>"Patch file.cpp applied without errors</em> . <em>"</em> <br></li><li>  <strong>git log -p -1</strong> should show adding a formatted file. <br></li><li>  If <em>file.cpp</em> hit the commit is really formatted, then you can test formatting only in diff.  Modify a couple of lines of <em>wrong.cpp</em> so that the formatter <em>responds</em> to them.  For example, add inadequate indentation in the code along with other changes.  <strong>git commit -a -m "Format only diff"</strong> should fill in the formatted changes, but not affect other parts of the file. <br></li></ol><br><h3>  Disadvantages and problems </h3><br>  <em>git diff --staged</em> (which here is <em>$ {GIT_DIFF} --staged</em> ) gives diff only those files that have been added to the index.  And <em>clang-format-diff-6.0</em> refers to full versions of files outside of it.  Therefore, if you change a file, make <em>git add</em> , and then change the same file, <em>clang-format-diff-6.0</em> will generate a patch for formatting the code (in the index) based on a different file.  Thus, it is better not to edit the file after <em>git add</em> and before the commit. <br><br>  Here is an example of such an error: <br><p></p><ol><li>  Add an extra <em>std :: endl</em> to <em>file.cpp</em> , <em>"Second case"</em> .  <em>(std :: cout &lt;&lt; "Second case" &lt;&lt; std :: endl &lt;&lt; std :: endl;)</em> and several tabs of extra indentation before the line. <br></li><li>  <strong>git add file.cpp</strong> </li><li>  Clear the line (in the same file) with <em>"First case"</em> so that in its place there would be (!) Only the line break. </li><li>  <strong>git commit -m "Formatter error on commit"</strong> . </li></ol><br>  The script should report <em>"error: when searching:"</em> , i.e.  <em>git apply</em> did not find the context of the patch issued by <em>clang-format-diff-6.0</em> .  If you do not understand what the problem is, just do not change the files after <em>git add</em> them and before <em>git commit</em> .  If you need to change, you can make a commit (without push) and then <em>git commit --amend</em> with new changes. <br><br><p>  The most serious limitation is the need to have a newline at the end of each file.  This is an old git feature, so most code editors support the automatic insertion of such a translation at the end of the file.  Without this, the script will fall when a new file is commited, but this will not do any harm. </p><br><p>  Very rarely <em>does clang-format-diff-6.0</em> format the code inadequately.  In this case, you can add any useless elements to the code, such as a semicolon.  Or, surround the problem code with comments, <em>/ * clang-format off * /</em> and <em>/ * clang-format on * /</em> . <br></p><br><p>  Also, <em>clang-format-diff-6.0</em> may issue an inadequate patch.  This ends with <em>git apply</em> not accepting it, and the code of the commit part remains unformatted.  The reason is inside <em>clang-format-diff</em> .  No time to understand all the errors of the program.  In this case, you can look at the formatting patch with the <strong>git diff -U0 command - no-color HEAD ^ |</strong>  <strong>clang-format-diff-6.0 -p1 -v -sort-includes -style = Chromium -iregex '. * \. (cxx | cpp | hpp | h) $'</strong> .  The easiest solution is to add the -i option to the previous command.  In this case, the utility will not issue a patch, but will format the code.  If it does not help, you can try formatting for individual files as a whole <strong>clang-format-6.0 -i -sort-includes -style = Chromium file.cpp</strong> .  Next, <strong>git add file.cpp</strong> and <strong>git commit --amend</strong> . <br><br>  There is an assumption that the closer your <em>.clang-format</em> config to one of the presets, the less such errors you will see.  (This is replaced by the option <em>-style = Chromium</em> ). <br></p><br><h3>  Debugging </h3><br>  If you want to see what changes the script makes on your current edits (not in the index), use <strong>git diff -U0 --no-color |</strong>  <strong>clang-format-diff-6.0 -p1 -v -sort-includes -style = Chromium -iregex '. * \. (cxx | cpp | hpp | h) $'</strong> You can also check how the script will work on recent commits, for example , at thirty: <strong>git filter-branch -f --tree-filter "$ {PWD} /. git / hooks / pre-commit" --prune-empty HEAD ~ 30..HEAD</strong> .  This command should have formatted previous commits, but in fact only changes their id.  Therefore it is worth carrying out such experiments in a separate copy of the project!  After it becomes unsuitable for work. <br><br><h3>  Conclusion </h3><br>  Subjectively, from such a decision is much more benefit than harm.  But it is necessary to test the behavior of <em>clang-format-diff of</em> different versions on the code of your project, with a config for your code style. <br><br>  Unfortunately, we didn‚Äôt do the same git-hook for Windows.  Suggest in the comments how to do it there.  And if you need an article for a quick start with <em>clang-format</em> , we advise you to look at the <a href="http://clang.llvm.org/docs/ClangFormat.html">description of ClangFormat</a> . </div><p>Source: <a href="https://habr.com/ru/post/433832/">https://habr.com/ru/post/433832/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../433822/index.html">The complete guide to CMake. Part Three: Testing and Packaging</a></li>
<li><a href="../433824/index.html">Habro suicide. Why 1C programmers will save the world</a></li>
<li><a href="../433826/index.html">Persimmon 2.0 Instructions for use</a></li>
<li><a href="../433828/index.html">Using QML Map to Build Airways - Part 1</a></li>
<li><a href="../433830/index.html">New LED Lamp Diall</a></li>
<li><a href="../433834/index.html">How Ivan metrics DevOps did. Start</a></li>
<li><a href="../433836/index.html">Byte-machine for the fort (and not only) in Indian (Part 2)</a></li>
<li><a href="../433838/index.html">Biohacker Joshua Seiner Public Letter</a></li>
<li><a href="../433842/index.html">[Friday] ASCII graffiti on retro monitors and other surfaces</a></li>
<li><a href="../433844/index.html">About the three components necessary for the success of IT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>