<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitor AD users on your knee for free</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="With the growth of the company and the emergence of a large number of workplaces, an idea arose to make a resource where you can quickly find informat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitor AD users on your knee for free</h1><div class="post__text post__text-html js-mediator-article">  With the growth of the company and the emergence of a large number of workplaces, an idea arose to make a resource where you can quickly find information on the user, PC and make some reports. <br><br>  There is software, it is complex and usually costs money.  We will rivet his and his knee. <br><br>  Also a number of restrictions are imposed due to: <br><ul><li>  performance domain controllers </li><li>  Software security (nefig here run the left exe and services), in their software is not allowed. </li><li>  network settings (complex architecture based on VLAN, ACL and prohibitions of everything that can connect somewhere) </li><li>  not prod resource on prod system </li><li>  security requirements and software usage policy </li></ul><br><img src="https://habrastorage.org/files/de1/0a6/06c/de10a606cbce4e6ab3c0b155e16e01bc.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Set goals: <br>  1. Where do users go <br>  2. Where do they forget to go <br>  3. Who can log in with their / not their login on one / several PCs <br>  4. Seating in places <br>  5. Display on floor layout <br>  6. Report on working time (including how much the user was ‚Äúactive‚Äù in the system) <br>  7. Delegation of rights for engineers to simplify diagnostics. <br><br><a name="habracut"></a><br><br>  A little about the network: <br>  On the network, there are user VLANs with authorization in AD, a bunch of Computer + User.  When authorization fails, users enter guest VLANs, where they have no access other than to log out. <br>  VLAN max / 23 <br><br>  A bit about DNS: <br>  DNS AD integrated.  DNS scavenging is disabled.  Accordingly, in view of the point above, there are many problems with finding a PC by DNS, duplication of A, PTR records. <br><br>  A little bit about GPO: <br>  The blocking of the station by not active = 5 minutes. <br>  The logon / logoff scripts section is used. <br><br>  About AD: <br>  Access based on security groups.  Step aside is considered an escape. <br>  2 domain + domain trust <br><br>  I have at my disposal: <br><ul><li>  Ball, where everyone can write (only create, write) </li><li>  Virtual Server based on Windows Server 2012R2 </li></ul><br><br>  List of software used: <br>  Windows Server 2012R2 (IIS) <br>  Visual Studio 2012 (Software development for managers and users) <br>  Mysql 5.6 (Database in which I store data) <br>  Mysql Work Bench (Building a database on the knee) <br>  Perl for Windows (Portal + web service) <br><br>  And programming languages: <br>  Perl <br>  C # <br>  Powershell <br><br>  First we need a database: <br><div class="spoiler">  <b class="spoiler_title">Tear out the eye</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a6a/69b/9d3/a6a69b9d36924a45a4faa038f89ea87d.jpg"><br><div class="spoiler">  <b class="spoiler_title">SQL</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- -- Database: `logon` -- -- -------------------------------------------------------- -- -- Table structure for table `bcs` -- CREATE TABLE IF NOT EXISTS `bcs` ( `id` int(11) NOT NULL, `bc` text NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `computers` -- CREATE TABLE IF NOT EXISTS `computers` ( `id` int(11) NOT NULL, `domain_id` int(11) DEFAULT NULL, `samaccountname` varchar(15) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `domains` -- CREATE TABLE IF NOT EXISTS `domains` ( `id` int(11) NOT NULL, `name` varchar(15) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `events` -- CREATE TABLE IF NOT EXISTS `events` ( `id` int(11) NOT NULL, `event` varchar(8) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `groups` -- CREATE TABLE IF NOT EXISTS `groups` ( `id` int(11) NOT NULL, `name` varchar(64) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `ipnets` -- CREATE TABLE IF NOT EXISTS `ipnets` ( `id` int(11) NOT NULL, `bc_id` int(11) NOT NULL, `ipnet1` varchar(3) NOT NULL DEFAULT '172', `ipnet2` varchar(3) NOT NULL DEFAULT '16', `ipnet3` varchar(3) NOT NULL, `mask` int(11) NOT NULL DEFAULT '24', `vid` mediumint(4) DEFAULT NULL, `name` varchar(20) DEFAULT NULL, `description` varchar(50) DEFAULT NULL, `tplname` varchar(20) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `ips` -- CREATE TABLE IF NOT EXISTS `ips` ( `id` int(11) NOT NULL, `ip` varchar(15) NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `latestdata` -- CREATE TABLE IF NOT EXISTS `latestdata` ( `domain_id` int(11) NOT NULL, `computer_id` int(11) NOT NULL, `computer_event_id` int(11) DEFAULT NULL, `computer_dt` datetime DEFAULT NULL, `ip_id` int(11) DEFAULT NULL, `user_id` int(11) DEFAULT NULL, `user_event_id` int(11) DEFAULT NULL, `user_dt` datetime DEFAULT NULL, `logonid` tinyint(4) DEFAULT NULL, `logon_dt` datetime DEFAULT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `latestlogons` -- CREATE TABLE IF NOT EXISTS `latestlogons` ( `domain_id` int(11) NOT NULL, `computer_id` int(11) NOT NULL, `ip_id` int(11) DEFAULT NULL, `user_id` int(11) NOT NULL, `user_event_id` int(11) DEFAULT NULL, `user_dt` datetime DEFAULT NULL, `processlogoff` tinyint(4) DEFAULT '0' ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `logoncomputers` -- CREATE TABLE IF NOT EXISTS `logoncomputers` ( `id` int(11) NOT NULL, `domain_id` int(11) NOT NULL, `computer_id` int(11) NOT NULL, `event_id` int(11) NOT NULL, `ip_id` int(11) NOT NULL, `dt` datetime DEFAULT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `logonusers` -- CREATE TABLE IF NOT EXISTS `logonusers` ( `id` int(11) NOT NULL, `domain_id` int(11) NOT NULL, `user_id` int(11) NOT NULL, `computer_id` int(11) NOT NULL, `event_id` int(11) NOT NULL, `ip_id` int(11) NOT NULL, `dt` datetime DEFAULT '0000-00-00 00:00:00', `dtnow` datetime DEFAULT CURRENT_TIMESTAMP ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `membership` -- CREATE TABLE IF NOT EXISTS `membership` ( `uid` int(11) NOT NULL, `gid` int(11) NOT NULL, `used` tinyint(4) NOT NULL, `user_dt` datetime NOT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -------------------------------------------------------- -- -- Table structure for table `users` -- CREATE TABLE IF NOT EXISTS `users` ( `id` int(11) NOT NULL, `domain_id` int(11) NOT NULL, `samaccountname` varchar(20) NOT NULL, `name` varchar(50) DEFAULT NULL ) ENGINE=InnoDB DEFAULT CHARSET=utf8; -- -- Indexes for dumped tables -- -- -- Indexes for table `bcs` -- ALTER TABLE `bcs` ADD PRIMARY KEY (`id`); -- -- Indexes for table `computers` -- ALTER TABLE `computers` ADD PRIMARY KEY (`id`), ADD UNIQUE KEY `samaccountname` (`samaccountname`); -- -- Indexes for table `domains` -- ALTER TABLE `domains` ADD PRIMARY KEY (`id`), ADD UNIQUE KEY `name` (`name`); -- -- Indexes for table `events` -- ALTER TABLE `events` ADD PRIMARY KEY (`id`), ADD UNIQUE KEY `event` (`event`); -- -- Indexes for table `groups` -- ALTER TABLE `groups` ADD PRIMARY KEY (`id`,`name`), ADD UNIQUE KEY `name` (`name`); -- -- Indexes for table `ipnets` -- ALTER TABLE `ipnets` ADD PRIMARY KEY (`id`); -- -- Indexes for table `ips` -- ALTER TABLE `ips` ADD PRIMARY KEY (`id`), ADD UNIQUE KEY `ip` (`ip`); -- -- Indexes for table `latestdata` -- ALTER TABLE `latestdata` ADD PRIMARY KEY (`computer_id`); -- -- Indexes for table `latestlogons` -- ALTER TABLE `latestlogons` ADD PRIMARY KEY (`computer_id`,`user_id`); -- -- Indexes for table `logoncomputers` -- ALTER TABLE `logoncomputers` ADD PRIMARY KEY (`id`); -- -- Indexes for table `logonusers` -- ALTER TABLE `logonusers` ADD PRIMARY KEY (`id`); -- -- Indexes for table `membership` -- ALTER TABLE `membership` ADD PRIMARY KEY (`uid`,`gid`); -- -- Indexes for table `templatedata` -- ALTER TABLE `templatedata` ADD PRIMARY KEY (`template_id`,`row_id`); -- -- Indexes for table `templates` -- ALTER TABLE `templates` ADD PRIMARY KEY (`id`); -- -- Indexes for table `users` -- ALTER TABLE `users` ADD PRIMARY KEY (`id`); -- -- AUTO_INCREMENT for dumped tables -- -- -- AUTO_INCREMENT for table `bcs` -- ALTER TABLE `bcs` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `computers` -- ALTER TABLE `computers` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `domains` -- ALTER TABLE `domains` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `events` -- ALTER TABLE `events` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `groups` -- ALTER TABLE `groups` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `ipnets` -- ALTER TABLE `ipnets` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `ips` -- ALTER TABLE `ips` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `logoncomputers` -- ALTER TABLE `logoncomputers` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `logonusers` -- ALTER TABLE `logonusers` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `templates` -- ALTER TABLE `templates` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT; -- -- AUTO_INCREMENT for table `users` -- ALTER TABLE `users` MODIFY `id` int(11) NOT NULL AUTO_INCREMENT;</span></span></code> </pre> <br></div></div><br></div></div><br><br>  Next, you need to write data about user logins. <br>  Let's make 2 scripts (in each domain) <br><br>  For the user: <br><blockquote>  set t =% 1 <br>  ipconfig |  find "IPv4"&gt;% temp% \ tempip.txt <br>  for / f "tokens = 1 * delims = .:" %% a in (% temp% \ tempip.txt) do (echo% USERNAME%;% COMPUTERNAME%; %% b;% t%;% DATE%;% TIME% &gt;&gt; \\ nas \ log $ \ users \% USERNAME% .domain1.ru.txt) <br>  del% temp% \ tempip.txt </blockquote><br><br>  usage \\ domain \ netlogon \ logon.cmd logon / logoff <br><br>  For PC: <br><blockquote>  set t =% 1 <br>  ipconfig |  find "IPv4"&gt;% temp% \ tempip.txt <br>  for / f "tokens = 1 * delims = .:" %% a in (% temp% \ tempip.txt) do (echo% COMPUTERNAME%; %% b;% t%;% DATE%;% TIME% &gt;&gt; \\ nas \ log $ \ computers \% COMPUTERNAME% .domain1.ru.txt) <br>  del% temp% \ tempip.txt </blockquote><br><br>  It remains to parse the data and save somewhere. <br>  (2 modules: PC and users. Code without comments.) <br><div class="spoiler">  <b class="spoiler_title">And write to the database using powershell</b> <div class="spoiler_text"><pre> <code class="cs hljs">import-module activedirectory [<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>][system.reflection.Assembly]::LoadWithPartialName(<span class="hljs-string"><span class="hljs-string">"MySql.Data"</span></span>) $server= <span class="hljs-string"><span class="hljs-string">"localhost"</span></span> $username= <span class="hljs-string"><span class="hljs-string">"logon"</span></span> $password= <span class="hljs-string"><span class="hljs-string">""</span></span> $database= <span class="hljs-string"><span class="hljs-string">"logon"</span></span> Set-<span class="hljs-function"><span class="hljs-function">Variable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SqlConnection</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">New-Object MySql.Data.MySqlClient.MySqlConnection</span></span></span><span class="hljs-function">) -Scope Global -Option AllScope -Description "Personal variable </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">for</span></span></span><span class="hljs-function"> Sql Query functions" $SqlConnection.ConnectionString</span></span> = <span class="hljs-string"><span class="hljs-string">"server=$server;user id=$username;password=$password;database=$database;pooling=false;Allow Zero Datetime=True;"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not ($SqlConnection.State -like <span class="hljs-string"><span class="hljs-string">"Open"</span></span>)) { $SqlConnection.Open() } function <span class="hljs-keyword"><span class="hljs-keyword">global</span></span>:Get-SqlDataTable( $Query = $(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not ($Query -gt $<span class="hljs-literal"><span class="hljs-literal">null</span></span>)) {Read-Host <span class="hljs-string"><span class="hljs-string">"Query to run"</span></span>}) ) { <span class="hljs-meta"><span class="hljs-meta"># </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (-not ($SqlConnection.State -like "Open")) { $SqlConnection.Open() } $SqlCmd = New-Object MySql.Data.MySqlClient.MySqlCommand $Query, $SqlConnection $SqlAdapter = New-Object MySql.Data.MySqlClient.MySqlDataAdapter $SqlAdapter.SelectCommand = $SqlCmd $DataSet = New-Object System.Data.DataSet $SqlAdapter.Fill($DataSet) | Out-Null return $DataSet.Tables[0] } function global:Insert-SqlDataTable( $Query = $(</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (-not ($Query -gt $null)) {Read-Host "Query to run"}) ) { # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (-not ($SqlConnection.State -like "Open")) { $SqlConnection.Open() } $SqlCmd = New-Object MySql.Data.MySqlClient.MySqlCommand $Query, $SqlConnection $SqlAdapter = New-Object MySql.Data.MySqlClient.MySqlDataAdapter $SqlAdapter.InsertCommand = $SqlCmd $SqlAdapter.InsertCommand.ExecuteNonQuery() } $events = Get-SqlDataTable 'select * from events' $domain = 1; $fusers = $null </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((get-childitem \\nas\log$\users | measure).count -gt 0){ $fusers += get-childitem \\nas\log$\users } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((get-childitem \\nas.d2.local\auth_log$\users | measure).count -gt 0){ $fusers += get-childitem \\nas.d2.local\auth_log$\users } foreach ($fuser in $fusers){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($fuser.name -match "domain1"){ $domain = 1 } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($fuser.name -match "domain2"){ $domain = 2 } write-host domain $domain -foregroundcolor blue write-host ":" $fuser.BaseName -foregroundcolor green </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!(test-path $fuser.fullname)){continue} $ustr = get-content $fuser.fullname $error_code = $null $res_sql_user = $null $res_sql_latestdata = $null $res_sql_latestlogons = $null foreach ($</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> in $ustr){ $line1 = $</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> -replace "['|()]" $arr = $line1.split(";") </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($arr[0]){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($domain -eq 1){ $uname = (get-aduser $arr[0]).name } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($domain -eq 2){ $uname = (get-aduser $arr[0] -server dc.domain2).name } $sql_str = "select id from users where lower(samaccountname) = lower('" + $arr[0] + "') and domain_id = $domain order by id limit 1;"; $userid = (Get-SqlDataTable $sql_str).id </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$userid){ $sql_str = "insert into users (domain_id, samaccountname, name) values ($domain, '" + $arr[0] + "', '$uname'); select id from users where lower(samaccountname) = lower('" + $arr[0] + "') and domain_id = $domain order by id limit 1;"; $userid = (Get-SqlDataTable $sql_str).id } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($arr[1]){ $compname = $arr[1] $cdomain = 1 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($compname -match "cn1"){ $cdomain = 1 } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($compname -match "cn2"){ $cdomain = 2 } $sql_str = "select id from computers where lower(samaccountname) = lower('" + $arr[1] + "') order by id limit 1;"; $computerid = (Get-SqlDataTable $sql_str).id </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$computerid){ $sql_str = "insert into computers (domain_id, samaccountname) values ($cdomain, '" + $arr[1] + "'); select id from computers where lower(samaccountname) = lower('" + $arr[1] + "') order by id limit 1;"; $computerid = (Get-SqlDataTable $sql_str).id write-host $sql_str -foregroundcolor yellow } } $ev = $events | ?{$_.event -eq $arr[3]} switch(($ev | measure).count){ 0 { write-host $arr[3] "</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">" -foregroundcolor red exit write-host $arr[3] "will be added" -foregroundcolor yellow $sql_str = "insert into events (event) values ('" + $arr[3] + "')" Insert-SqlDataTable $sql_str $events = Get-SqlDataTable 'select * from events' $sql_str | out-file sql.txt -append } 1 { #write-host $arr[3] "select as current" -foregroundcolor white } default: {$error_code = 3; write-host $arr[3] "</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">" -foregroundcolor red; exit} } $curip = $arr[2] -replace "Address. . . . . . . . . . . :","" -replace "IPv4 Address. . : ","" -replace "IPv4- ¬§“ê . . . . : ","" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($curip){ $sql_str = "select id from ips where lower(ip) = lower('$curip') order by id limit 1;" $ipid = (Get-SqlDataTable $sql_str).id </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$ipid){ $sql_str = "insert into ips (ip) values ('$curip'); select id from ips where lower(ip) = lower('$curip') order by id limit 1;"; write-host $sql_str -foregroundcolor yellow $ipid = (Get-SqlDataTable $sql_str).id } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$userid){write-host u userid null; exit;} </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$computerid){write-host u computerid null; exit;} </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$ipid){write-host u ipid null; exit;} $eventid = ($events | ?{$_.event -eq $arr[3]}).id | select -first 1 #$ip = $arr[2] -replace "Address. . . . . . . . . . . :","" -replace "IPv4 Address. . : ","" #$dt = "{0:yyyy-MM-dd HH:mm:ss}" -f [datetime](($arr[4] + " " + $arr[5]) -replace '^(.*),.*$','$1') #$dt = get-date(($arr[4] + " " + $arr[5]) -replace '^(.*),.*$','$1') -format "yyyy-MM-dd hh:mm:ss zzz" #$dt = get-date(($arr[4] + " " + $arr[5])) -format "yyyy-MM-dd hh:mm:ss zzz" $t = ($arr[5] -replace '^(.*),.*$','$1').split(":") $dt = get-date((get-date($arr[4])).Addhours($t[0]).AddMinutes($t[1]).Addseconds($t[2])) -format "yyyy-MM-dd HH:mm:ss" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($arr[0]){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($domain -eq 1){ $groups = ((Get-ADuser $arr[0] -Property memberof).memberof | %{Get-ADGroup -Identity $_} | sort name).name } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($domain -eq 2){ $groups = ((Get-ADuser $arr[0] -server dc.domain2 -Property memberof).memberof | %{Get-ADGroup -Identity $_ -server dc.domain2 } | sort name).name } #$groups = ((Get-ADuser $arr[0] -Property memberof).memberof | %{Get-ADGroup -Identity $_} | sort name).name $val1 = "" $val2 = "" $groupscnt = ($groups | measure).count #write-host $groupscnt -foregroundcolor red for ($i = 0; $i -lt $groupscnt; $i++){ $gr = $groups[$i] -replace "'","\'" $sql_str = "select id from groups where name = '$gr'" $groupid = (Get-SqlDataTable $sql_str).id </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$groupid){ $sql_str = "insert into groups (name) values ('$gr');" $res = Get-SqlDataTable $sql_str } $val2 = $val2 + "'" + $gr + "'" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($i -lt $groupscnt - 1){$val2 = $val2 + ","} } $sql_str = "select id from groups where name in ($val2);" $groupsid = (Get-SqlDataTable $sql_str).id $groupscnt = ($groupsid | measure).count $val3 = "" for ($i = 0; $i -lt $groupscnt; $i++){ $val3 = $val3 + "($userid, " + $groupsid[$i] + ", 1, '$dt')" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($i -lt $groupscnt - 1){$val3 = $val3 + ","} } $sql_str = "insert into membership (uid, gid, used, user_dt) values $val3 on duplicate key update used=values(used), user_dt=values(user_dt); update membership SET used=0 WHERE uid = $userid and user_dt != '$dt'" #$sql_str $res = Get-SqlDataTable $sql_str #$res } # $datetime = "{0:yyyy-MM-dd hh:mm:ss}" -f [datetime]$dt #::ParseExact($dt, "dd.MM.yyyy hh:mm:ss",$null) #$datetime = get-date($dt) # $datetime $res_sql_user += "insert into logonusers (domain_id, user_id, computer_id, event_id, ip_id, dt) values ($domain, $userid, $computerid, $eventid, $ipid, '$dt');" $res_sql_latestdata += "insert into latestdata (domain_id, computer_id, user_id, user_event_id, ip_id, user_dt) values ($domain, $computerid, $userid, $eventid, $ipid, '$dt') on duplicate key update computer_id=values(computer_id), user_id=values(user_id), user_event_id=values(user_event_id), user_dt=values(user_dt), ip_id=values(ip_id);" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($eventid -eq 2){ $res_sql_latestlogons += "insert into latestlogons (domain_id, computer_id, user_id, user_event_id, ip_id, user_dt, processlogoff) values ($domain, $computerid, $userid, $eventid, $ipid, '$dt', 0) on duplicate key update computer_id=values(computer_id), user_id=values(user_id), user_event_id=values(user_event_id), user_dt=values(user_dt), ip_id=values(ip_id), processlogoff=values(processlogoff);" } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($eventid -eq 1){ $res_sql_latestlogons += "delete from latestlogons where computer_id = $computerid and user_id = $userid limit 1;" } # $sql = "insert into logon () values"; } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$error_code){ $out = Insert-SqlDataTable $res_sql_user $res_sql_user $out = Insert-SqlDataTable $res_sql_latestdata $res_sql_latestdata $out = Insert-SqlDataTable $res_sql_latestlogons $res_sql_latestlogons remove-item $fuser.fullname -force } } ###################################################################### ###################################################################### ###################################################################### ###################################################################### ###################################################################### $fcomputers = $null </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((get-childitem \\nas\log$\computers | measure).count -gt 0){ $fcomputers += get-childitem \\nas\log$\computers } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ((get-childitem \\nas.d2.local\auth_log$\computers | measure).count -gt 0){ $fcomputers += get-childitem \\nas.d2.local\auth_log$\computers } foreach ($fcomputer in $fcomputers){ </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($fcomputer.name -match "domain1"){ $domain = 1 } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($fcomputer.name -match "domain2"){ $domain = 2 } write-host domain $domain -foregroundcolor blue write-host ":" $fcomputer.BaseName -foregroundcolor green $cstr = get-content $fcomputer.fullname $error_code = $null $res_sql_computer = $null $res_sql_latestdata = $null foreach ($</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta"> in $cstr){ $arr = $</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">.split(";") </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($arr[0]){ $sql_str = "select id from computers where lower(samaccountname) = lower('" + $arr[0] + "') order by id limit 1;"; $computerid = (Get-SqlDataTable $sql_str).id </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$computerid){ $sql_str = "insert into computers (domain_id, samaccountname) values ($domain, '" + $arr[0] + "'); select id from computers where lower(samaccountname) = lower('" + $arr[0] + "') order by id limit 1;"; $computerid = (Get-SqlDataTable $sql_str).id } } $ev = $events | ?{$_.event -eq $arr[2]} switch(($ev | measure).count){ 0 { write-host $arr[2] "will be added" -foregroundcolor yellow #$sql_str = "insert into events (event) values ('" + $arr[2] + "')" Insert-SqlDataTable $sql_str $events = Get-SqlDataTable 'select * from events' $sql_str | out-file sql.txt -append } 1 { #write-host $arr[3] "select as current" -foregroundcolor white } default: {$error_code = 3; write-host $arr[2] "</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">" -foregroundcolor red} } $curip = $arr[1] -replace "Address. . . . . . . . . . . :","" -replace "IPv4 Address. . : ","" -replace "IPv4- ¬§“ê . . . . : ","" #write-host $arr[1] $curip #$error_code = 4 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> ($curip){ $sql_str = "select id from ips where lower(ip) = lower('$curip') order by id limit 1;" $ipid = (Get-SqlDataTable $sql_str).id </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$ipid){ $sql_str = "insert into ips (ip) values ('$curip'); select id from ips where lower(ip) = lower('$curip') order by id limit 1;"; $ipid = (Get-SqlDataTable $sql_str).id } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$error_code){ $eventid = ($events | ?{$_.event -eq $arr[2]}).id | select -first 1 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$computerid){write-host c computerid null; exit;} </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$ipid){write-host c ipid null; exit;} $t = ($arr[4] -replace '^(.*),.*$','$1').split(":") $dt = get-date((get-date($arr[3])).Addhours($t[0]).AddMinutes($t[1]).Addseconds($t[2])) -format "yyyy-MM-dd HH:mm:ss" $res_sql_computer += "insert into logoncomputers (domain_id, computer_id, event_id, ip_id, dt) values ($domain, $computerid, $eventid, $ipid, '$dt');" $res_sql_latestdata += "insert into latestdata (domain_id, computer_id, computer_event_id, computer_dt, ip_id) values ($domain, $computerid, $eventid, '$dt', $ipid) on duplicate key update computer_id=values(computer_id), computer_event_id=values(computer_event_id), computer_dt=values(computer_dt), ip_id=values(ip_id);" } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!$error_code){ $res_sql_computer $out = Insert-SqlDataTable $res_sql_computer $res_sql_latestdata $out = Insert-SqlDataTable $res_sql_latestdata remove-item $fcomputer.fullname -force } } $SqlConnection.Close()</span></span></code> </pre><br></div></div><br><br>  Now we have the data stored in the database.  Then we can do anything with them: <br><div class="spoiler">  <b class="spoiler_title">For example, draw a floor plan and display statistics</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/4fe/c6f/24c/4fec6f24cf5e471a8a3b220b865dfed3.jpg"><br>  Dynamically formed their Excel files on the file file. <br>  Search is possible by: <br><ul><li>  Username </li><li>  IP </li><li>  Pc name </li><li>  Group </li></ul><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Portal example</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/581/09a/90b/58109a90bad74f8287749705cc082563.jpg"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Reports we can get</b> <div class="spoiler_text"><div class="spoiler">  <b class="spoiler_title">Employees with logins on different PCs except administrators</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> latestlogons t <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t.user_id = ll.user_id) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cnt, u.samaccountname, ll.user_id, u.name, c.samaccountname, ll.computer_id, i.ip, ll.user_dt, bc.bc, ipn.tplname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> latestlogons ll <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> membership m <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> m.uid = u.id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> gr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> gr.id = m.gid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> gr.name <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-string"><span class="hljs-string">'Domain Admins'</span></span>))) u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = ll.user_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> computers c <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = ll.computer_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ips i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.id = ll.ip_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> cnt <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> , u.samaccountname</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">or just cumulatively for active sessions</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cnt, u.samaccountname, ll.user_id, u.name, c.samaccountname, ll.computer_id, i.ip <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> latestlogons ll <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = ll.user_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> computers c <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = ll.computer_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ips i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.id = ll.ip_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> user_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> cnt <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Entry / Exit of staff for the past day (from 00:00:00 to 23:59:59)</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> d.name, u.samaccountname, u.name, c.samaccountname, e.event, lu.dt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> logonusers lu <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = lu.user_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> computers c <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = lu.computer_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ips i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> i.id = lu.ip_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> e.id = lu.event_id <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> domains d <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> d.id = lu.domain_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (i.ip <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'172.16.16.%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> i.ip <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'172.16.32%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> i.ip <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'172.16.33%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> i.ip <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'172.16.34%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> i.ip <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'172.16.35%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> lu.dt &gt;= <span class="hljs-keyword"><span class="hljs-keyword">CURDATE</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">INTERVAL</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> lu.dt &lt;= <span class="hljs-keyword"><span class="hljs-keyword">CURDATE</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> lu.dt</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Find everyone with a specific group</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> c.samaccountname, u.samaccountname, u.name, i.ip <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">`latestdata`</span></span> ld <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> computers c <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.id = ld.computer_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> u.id = ld.user_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`events`</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> e.id = ld.computer_event_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`events`</span></span> e2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> e2.id = ld.user_event_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">`ips`</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ld.ip_id = i.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> membership m <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> m.uid = u.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">groups</span></span> g <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> g.id = m.gid <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(g.name) = <span class="hljs-keyword"><span class="hljs-keyword">LOWER</span></span>(<span class="hljs-string"><span class="hljs-string">'$key'</span></span>)</code> </pre><br></div></div><br></div></div><br><br>  How to determine the locked screen of the user <br>  Without auditing screen lock events, you can do this as follows (write to a file or use a web service) <br><div class="spoiler">  <b class="spoiler_title">C #</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SystemEvents_SessionSwitch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, SessionSwitchEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (e.Reason) { <span class="hljs-comment"><span class="hljs-comment">// ... case SessionSwitchReason.SessionLock: // Do whatever you need to do for a lock // ... write_event("locked"); //MessageBox.Show("Locked" + DateTime.Now); break; case SessionSwitchReason.SessionUnlock: // Do whatever you need to do for an unlock // ... write_event("unlocked"); //MessageBox.Show("UnLocked" + DateTime.Now); break; //case SessionSwitchReason. // ... } } void write_event (string e){ string computer = System.Environment.MachineName; string user = Environment.UserName; try { StreamWriter w = File.AppendText(@"\\nas\log$\events\" + user + @".domain1.ru.txt"); w.WriteLine(computer + ";" + user + ";" + e + ";" + DateTime.Now); w.Close(); } catch {} } private void Form1_Load(object sender, EventArgs e) { this.Opacity = 0; this.ShowInTaskbar = false; SystemEvents.SessionSwitch += new SessionSwitchEventHandler(SystemEvents_SessionSwitch); }</span></span></code> </pre><br></div></div><br>  This application will still have to be started by users, so we will add the ability to update the application on the fly: <br><div class="spoiler">  <b class="spoiler_title">C #</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> source = <span class="hljs-string"><span class="hljs-string">@"\\nas\userstat$\Data\active_ws.exe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> tempdir = System.IO.Path.GetTempPath(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> destFile = System.IO.Path.Combine(tempdir, <span class="hljs-string"><span class="hljs-string">"active_ws.exe"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(source)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { System.IO.File.Copy(source, destFile, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); Process.Start(destFile); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Let's give the user a warning that he is logged in on several machines and the ability to exit</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/d4b/b46/7f2/d4bb467f2b3d4d3c98dcf8c1f6239dca.jpg"><br><br>  res = GET (" <a href="http://api/">api</a> ?", "s = status"); <br><div class="spoiler">  <b class="spoiler_title">Draw buttons and hang event</b> <div class="spoiler_text"><pre> <code class="cs hljs">System.Windows.Forms.Label label = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Windows.Forms.Label(); label.Text = reader.Value.ToString(); label.Name = <span class="hljs-string"><span class="hljs-string">"c_"</span></span> + label.Text; label.Width = <span class="hljs-number"><span class="hljs-number">200</span></span>; label.Height = <span class="hljs-number"><span class="hljs-number">50</span></span>; label.Top = <span class="hljs-number"><span class="hljs-number">2</span></span> + (label.Height * label_cnt); label.Left = <span class="hljs-number"><span class="hljs-number">2</span></span>; label.Font = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Drawing.Font(<span class="hljs-string"><span class="hljs-string">"Calibri"</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, System.Drawing.FontStyle.Underline, System.Drawing.GraphicsUnit.Point, ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(<span class="hljs-number"><span class="hljs-number">0</span></span>))); label.ForeColor = Color.Red; panel1.Controls.Add(label); System.Windows.Forms.Button button = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Windows.Forms.Button(); button.Name = reader.Value.ToString(); button.Text = <span class="hljs-string"><span class="hljs-string">"    "</span></span>; button.Left = <span class="hljs-number"><span class="hljs-number">210</span></span>; button.Top = label.Top; button.Font = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Drawing.Font(<span class="hljs-string"><span class="hljs-string">"Calibri"</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, System.Drawing.FontStyle.Underline, System.Drawing.GraphicsUnit.Point, ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(<span class="hljs-number"><span class="hljs-number">0</span></span>))); button.Width = <span class="hljs-number"><span class="hljs-number">250</span></span>; button.Height = <span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (button.Name == System.Environment.MachineName) { button.Enabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; button.Text = <span class="hljs-string"><span class="hljs-string">" "</span></span>; } button.Click += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EventHandler(btn_Click); panel1.Controls.Add(button);</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Button handler</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btn_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> res = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Control item <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> panel1.Controls.OfType&lt;Control&gt;()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (item.Tag == sender || item == sender) { item.Enabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; item.Text = <span class="hljs-string"><span class="hljs-string">"     2- "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = POST(<span class="hljs-string"><span class="hljs-string">"http://api/?"</span></span>, <span class="hljs-string"><span class="hljs-string">"s=logout&amp;c="</span></span> + item.Name); <span class="hljs-comment"><span class="hljs-comment">//item.Name -    } catch (Exception exception) { } } } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">And do not forget to check that you need to go out.</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c_logoff == System.Environment.MachineName) { Process.Start(<span class="hljs-string"><span class="hljs-string">"shutdown"</span></span>, <span class="hljs-string"><span class="hljs-string">"-l -f"</span></span>); }</code> </pre><br></div></div><br></div></div><br><br>  Start is given, then only flight of fancy. </div><p>Source: <a href="https://habr.com/ru/post/253937/">https://habr.com/ru/post/253937/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253921/index.html">Conference ProfsoUX 2015: Review of applications for speeches</a></li>
<li><a href="../253923/index.html">DlangUI - Cross-platform GUI for D (Part 1)</a></li>
<li><a href="../253925/index.html">Create your own weather station, integrated with the Wolfram Cloud</a></li>
<li><a href="../253929/index.html">How to configure Android and RAD Studio XE7 (Delphi, C ++ Builder)</a></li>
<li><a href="../253935/index.html">Overview of the new version of EOS for SharePoint 2013</a></li>
<li><a href="../253941/index.html">Gravatar: How to decrypt email addresses of all users?</a></li>
<li><a href="../253943/index.html">Critical security vulnerability on fl.ru</a></li>
<li><a href="../253947/index.html">Homemade Fourier Spectrometer</a></li>
<li><a href="../253949/index.html">Lenovo and IBM x86: what to expect in the near future?</a></li>
<li><a href="../253953/index.html">The era of phablets: Designing for large screens</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>