<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Increase Docker Container Security</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="- Sir, how did you get hacked? 
 - Not a way, but a container. 
 Old joke 

 All unnecessary components of a computer system can be a source of comple...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Increase Docker Container Security</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/d3a/993/1fe/d3a9931febfd4aa093d434b5d60a885c.jpeg"><br><br><blockquote>  - Sir, how did you get hacked? <br>  - Not a way, but a container. <br>  <em>Old joke</em> </blockquote><p>  All unnecessary components of a computer system can be a source of completely unnecessary vulnerabilities.  Therefore, images of containers should, if possible, contain only what the application needs.  And their size matters not only in terms of ease of distribution, but also cost of ownership and security.  In this article we will talk about how to minimize the size and attack surface of Docker images, as well as about the tools to scan them for vulnerabilities. </p><a name="habracut"></a><br><p>  Anyone who has worked at least a little with Docker has probably heard about the <a href="https://hub.docker.com/_/alpine/">alpine</a> image.  It is based on the <a href="https://alpinelinux.org/">Alpine Linux distribution</a> , which, compared to, for example, Debian or Ubuntu, with a basic image size of 5 MB leaves hackers with far fewer opportunities to attack.  If the application can work in alpine, it will be a great way to optimize. </p><br><p> What about binary files?  Can the application work autonomously?  If yes, then there is reason to expect an additional reduction in size.  As a base for images such as Debian and Ubuntu, <code>scratch</code> is usually used, but it can also make an application on golang.  Gianluca Arbezzano has created a <a href="">repository</a> with minimal ready-made binary files.  Let's try linux_386. </p><br><img src="https://habrastorage.org/files/8aa/746/80d/8aa74680d97b44b59e97bf4cf8dc6ff2.jpeg"><br><br><pre> <code class="bash hljs">curl -SsL https://github.com/gianarb/micro/releases/download/1.0.0/micro_1.0.0_linux_386 &gt; micro</code> </pre> <br><p>  We can include this binary file in the scratch image using the Dockerfile like this: </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> scratch <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> ./micro /micro EXPOSE <span class="hljs-number"><span class="hljs-number">8000</span></span> CMD ["/micro"]</code> </pre> <br><pre> <code class="bash hljs">docker build -t micro-scratch . docker run -p 8000:8000 micro-scratch</code> </pre> <br><p>  As a result, we managed to launch the http application in an image of only 5 MB in size, that is, we reduced it more than twice compared to the 12 MB that the image created on the basis of alpine occupies. </p><br><p>  Scratch-image can not be used with any applications, but for the sake of reducing overhead costs should try. </p><br><p>  For Ruby, <a href="https://microbadger.com/images/ruby:2.3-alpine">ruby: 2.3-alpine</a> can be used as the base.  Ruby is installed from sources, not from the Alpine package.  With <a href="http://semver.org/">semantic versioning,</a> release 2.3 will receive security updates directly from developers. </p><br><p>  Otherwise, you would have to independently install Ruby from source and monitor the release of new versions or use the package from Alpine and monitor its update by the developers of the distribution. </p><br><h2 id="uvedomleniya-i-veb-huki">  Notifications and Web Hooks </h2><br><p>  If a security update is issued for the base image, you need to update those images that are based on it.  This is where <a href="https://microbadger.com/">MicroBadger notifications</a> can help, which can be sent, for example, to Slack, as the guys from Microscaling do for official alpine and ruby ‚Äã‚Äãimages. </p><br><img src="https://habrastorage.org/files/71b/d0c/160/71bd0c1602064835bd96169a5bf22a90.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>  They also use alerts to automatically start the build / reassembly procedure in the event of baseline changes.  This functionality is also found in the Docker Hub, but Microscaling claims that MicroBadger is better, since it can be used with any system that supports web hooks (for example, CI or a security scanner). </p><br><h2 id="obychnyy-polzovatel">  Normal user </h2><br><p>  One of the key differences between virtual machines and containers is the use of the latest core system kernels.  By default, Docker containers run as root, which can lead to serious problems in case of isolation breakthrough, since a compromised container running under root can get root access to the main system. </p><br><p>  However, risks can be reduced by running the container as a regular user.  Here's how to do this for a Rails application: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    WORKDIR /app #   Rails-   COPY . ./ #   ,      RUN addgroup rails &amp;&amp; adduser -D -G rails rails \ &amp;&amp; chown -R rails:rails /app USER rails</span></span></code> </pre> <br><h2 id="skanirovanie-bezopasnosti">  Security scan </h2><br><p>  In addition to directly storing, container registries can scan images loaded into them for vulnerabilities.  For example, Docker <a href="https://docs.docker.com/docker-cloud/builds/image-scan/">scans the security of</a> official as well as custom images uploaded to the Docker Cloud. </p><br><p>  To scan the security of the images, Quay.io uses <a href="https://github.com/coreos/clair">Clair</a> , an open source product from CoreOS.  More recently, Alpine support has been <a href="https://github.com/coreos/clair/pull/272">added</a> to Clair, which is actually very cool.  Hopefully, this functionality will soon be available in Quay.  In addition to Clair, there are <a href="https://www.twistlock.com/">TwistLock</a> and <a href="https://www.aquasec.com/">Aqua</a> scanners, but in most cases you have to pay to use them. </p><br><p>  Clair is an application on Golang that implements a set of HTTP APIs for uploading, downloading, and analyzing images.  Vulnerability data is downloaded from various sources, such as <a href="https://security-tracker.debian.org/tracker">Debian Security Tracker</a> or <a href="https://www.redhat.com/security/data/metrics/">RedHat Security Data</a> , and stored in Postgres.  Clair works on the principle of a static analyzer, therefore, in order to scan a container, it does not need to be started - only the image file system is checked. </p><br><pre> <code class="bash hljs">docker run -it -p 5000:5000 registry</code> </pre> <br><p>  Using this command, we launched our own registry to use as a source of images for scanning.  Let's try uploading a <code>micro</code> image from <a href="">Gianluca Arbezzano</a> : </p><br><pre> <code class="bash hljs">docker pull gianarb/micro:1.0.0 docker tag gianarb/micro:1.0.0 localhost:5000/gianarb/micro:1.0.0 docker push localhost:5000/gianarb/micro:1.0.0</code> </pre> <br><p>  Next, install Clair. </p><br><pre> <code class="bash hljs">mkdir <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/clair-test/clair_config <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$HOME</span></span>/clair-test curl -L https://raw.githubusercontent.com/coreos/clair/v1.2.2/config.example.yaml -o clair_config/config.yaml curl -L https://raw.githubusercontent.com/coreos/clair/v1.2.2/docker-compose.yml -o docker-compose.yml</code> </pre> <br><p>  Register in <code>$HOME/clair_config/config.yml</code> your database connection settings <code>postgresql://postgres:password@postgres:5432?sslmode=disable</code> </p><br><p>  To run Postgres and Clair, run the following command: </p><br><pre> <code class="bash hljs">docker-compose up</code> </pre> <br><p>  To facilitate the testing procedure, we will use a CLI called Hyperclair (this is the client for working with Clair).  The following are commands for Mac OS (if you are using another OS, see <a href="https://github.com/wemanity-belgium/hyperclair/releases">https://github.com/wemanity-belgium/hyperclair/releases</a> ): </p><br><pre> <code class="bash hljs">curl -SSl https://github.com/wemanity-belgium/hyperclair/releases/download/0.5.2/hyperclair-darwin-386 &gt; ~/hyperclair chmod 755 ~/hyperclair</code> </pre> <br><p>  Now we have an executable file in ~ / hyperclair: </p><br><pre> <code class="bash hljs">~/hyperclair pull localhost:5000/gianarb/micro:1.0.0 ~/hyperclair push localhost:5000/gianarb/micro:1.0.0 ~/hyperclair analyze localhost:5000/gianarb/micro:1.0.0 ~/hyperclair report localhost:5000/gianarb/micro:1.0.0</code> </pre> <br><p>  The generated report looks like this: </p><br><img src="https://habrastorage.org/files/898/023/548/898023548f8e4f5b89d2a0c5e0b96aff.jpeg"><br><br><h2 id="udalenie-potencialno-uyazvimyh-sborochnyh-zavisimostey-rails-prilozheniya">  Remove potentially vulnerable build dependencies of a Rails application </h2><br><p>  Since Ruby is an interpreted language, when using the application written on it we get a decent amount of dependencies.  We need to install all the Ruby gems that are needed for our application, and all the operating system packages needed for these gems. </p><br><p>  Suppose a scan reveals critical vulnerabilities in libxml2 and libxslt.  These are the buildtime dependencies of the Nokogiri heme, which is an XML and JSON parser.  In order to increase performance, this heme uses extensions written in C that require compilation.  But after the gem is installed, libxml2 and libxslt are no longer needed. </p><br><p>  Let's remove all buildtime dependencies: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     WORKDIR /tmp ADD Gemfile* /tmp/ #       #         apk- RUN apk update &amp;&amp; apk upgrade &amp;&amp; \ apk add --no-cache $RUBY_PACKAGES &amp;&amp; \ apk add --no-cache --virtual build-deps $BUILD_PACKAGES &amp;&amp; \ bundle install --jobs 20 --retry 5 &amp;&amp; \ apk del build-deps</span></span></code> </pre> <br><p>  Due to <a href="https://medium.com/%40fbzga/how-to-cache-bundle-install-with-docker-7bed453a5800">caching of Gemfile and Gemfile.lock in / tmp</a> , the <code>bundle install</code> command will be launched only if the Gemfile changes.  Otherwise, the Docker cache will be used.  Such optimization allows to reduce the execution time and the load on the network, which can be quite large when installing gems. </p><br><p>  Notice that the <code>run</code> command is multi-line, and therefore only one layer is added to the image.  Packages required for building are installed with the --virtual key, and they are easy to remove after the process is complete. </p><br><h2 id="avtomatizirovannaya-sborka">  Automated build </h2><br><p>  From the point of view of container security, it is extremely important to reassemble them every time an update of the image itself or one of those that underlies it appears.  Automation of this procedure can be based on binding to the git repository: in this case, the build starts after creating a new commit in the monitored branch.  As mentioned above, an assembly can also be run on a base image change event. </p><br><p>  In the case of Ruby, the situation is simplified, since we can take the same Dockerfile files that were used in the creation process.  For Go programs, you first need to compile a binary file, and then add it to the image.  You can use makefiles locally for this. </p><br><p>  An alternative would be to compile a binary file for an event in a docker container.  I recommend looking at a couple of golang-builder images from <a href="https://github.com/CenturyLinkLabs/golang-builder">CenturyLinkLabs</a> and <a href="https://github.com/prometheus/golang-builder">Prometheus</a> . </p><br><p>  To start the build process, you can use build hooks, which are also convenient for <a href="https://medium.com/microscaling-systems/labelling-automated-builds-on-docker-hub-f3d073fb8e1">adding dynamic metadata to images</a> . </p><br><img src="https://habrastorage.org/files/003/36c/40a/00336c40abaf43ab9c60ba9d3bb389f2.jpeg"><br><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  So, we briefly examined how to minimize Docker images for Go and Ruby applications, learn how to run containers as a regular user, set up a security scan using Clair, and talked a little about automatic reassembly.  I hope these simple steps will help improve the security of your Docker containers.  That's all for now.  Thanks for attention! </p><br><p>  List of sources: </p><br><ol><li>  <a href="https://medium.com/microscaling-systems/dockerfile-security-tuneup-166f1cdafea1">https://medium.com/microscaling-systems/dockerfile-security-tuneup-166f1cdafea1#.a24qq9tv7</a> </li><li>  <a href="http://gianarb.it/blog/about-your-images-security-tips">http://gianarb.it/blog/about-your-images-security-tips</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/320552/">https://habr.com/ru/post/320552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320542/index.html">Hibernate for beginners</a></li>
<li><a href="../320544/index.html">Azure in plain language [Cheat Sheet]</a></li>
<li><a href="../320546/index.html">Huawei Agile Distributed Wi-Fi Solution: What is it? Part one</a></li>
<li><a href="../320548/index.html">The reverse side of Agile - sorting out other people's mistakes</a></li>
<li><a href="../320550/index.html">Cryptographers sell tools to attack systems using MongoDB, Hadoop and ElasticSearch</a></li>
<li><a href="../320558/index.html">33 ways to speed up your frontend in 2017</a></li>
<li><a href="../320560/index.html">Bushed Bricks Game: Second Wind</a></li>
<li><a href="../320562/index.html">OpenStreetMap, how to get address coordinates, part is simple</a></li>
<li><a href="../320564/index.html">Dive into the Depth: how to fit reality into a small box</a></li>
<li><a href="../320566/index.html">How to make a new Trello and sell it for $ 425 million: why Atlassian has posted such a sum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>