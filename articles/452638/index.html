<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How we launched 2GIS under CarPlay and are still unraveling</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Vanya, I am writing a 2GIS mobile application for iOS. Today there will be a story about how our navigator appeared in CarPlay. I'll...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How we launched 2GIS under CarPlay and are still unraveling</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/tt/jg/a3/ttjga3qmefdwknrbj1i351exs3m.jpeg"></p><br><p>  Hello!  My name is Vanya, I am writing a 2GIS mobile application for iOS.  Today there will be a story about how our navigator appeared in CarPlay.  I'll tell you how with such documentation and unfinished tools we created a work product and placed it in the AppStore. </p><a name="habracut"></a><br><h2 id="para-slov-o-carplay">  A few words about CarPlay </h2><br><p><img src="https://habrastorage.org/webt/hq/vu/xw/hqvuxwo3ms1ivfppuaojrfscvh0.jpeg"></p><br><p>  First, some materials to understand some aspects of the work of CarPlay and the reasons why we made certain decisions. </p><br><p>  CarPlay is not an OS inside another OS, as many articles write about it.  If roughly, then CarPlay is a protocol for working with an external display of the screen of the head unit;  sound from car speakers;  touch screens, touch panels, washers and other input devices. </p><br><p>  That is, the entire executable code is located directly in the main application (not even in a separate extension!) This is very cool: to get new features, you do not need to update the radio or even the car, you just need to update iOS. </p><br><p>  At WWDC 2018 Keynote, we were presented with the possibility of creating navigation applications for CarPlay, which made us very happy.  Immediately after the presentation, we sent a <a href="https://developer.apple.com/carplay/">request</a> for authorization of development for CarPlay.  In the request it was necessary to show that our application can navigate. </p><br><p>  While we were waiting for a response from Apple, a <a href="https://developer.apple.com/videos/play/wwdc2018/213/">lecture</a> was published in which, using the example of the CountryRoads sample application, they talked about working with CarPlay.framework.  The lecture did not tell about the pitfalls and intricacies when working with CarPlay, but they mentioned that after connecting to the CarPlay radio tape recorder, the application will run in background mode. </p><br><h2 id="pervaya-palka-v-kolyosa">  The first stick in the wheels </h2><br><p>  The work of the application in the background has disappointed us.  There were two reasons for this: </p><br><ol><li>  We do not work in the background.  Once left this limitation for technical reasons and for the sake of energy saving. </li><li>  Our map is written in OpenGL (yes, deprecated, yes, not Metal, we all know that), and OpenGL does not work in the background state.  At best, you get a black view, and at worst, crash. </li></ol><br><p>  With the work in the background, it was still possible to cope, but definitely it was necessary to solve something with the map.  That's when the idea came to make it through the standard MKMapView.  Until you started throwing stones at us for the idea of ‚Äã‚Äãusing standard Apple maps, I will explain: we were going to use MKMapView, but not Apple maps. </p><br><p>  The fact is that MKMapView can load third-party tiles.  Tiles are special rectangular containers for textures.  We just had a servachok who knows how to give tiles.  On GitHub <a href="https://github.com/2gis/iOS-SDKs-for-tiles">there is a code</a> with implementation. </p><br><h2 id="otvet-ot-apple">  Apple's answer </h2><br><p> We received a response from Apple, in which, in addition to the development permission, we also received the documentation for the elect, the CountryRoads sample code (it was shown at the WWDC lecture) and, most importantly, the private capability-key <code>com.apple.developer.carplay-maps</code> .  This key is set in the entitlements file with a value of YES, so that the system understands that you can handle events from CarPlay when you start your application. </p><br><p>  Without waiting for the sprint with the development of the story, I climbed to download Xcode Beta.  The first attempt to collect 2GIS was a failure.  But the draft sample application CoutryRoads managed to build a simulator. </p><br><p>  Before each opening of the CarPlay window, the latter had to be customized through this window: </p><br><p><img src="https://habrastorage.org/webt/3p/xn/rf/3pxnrf5dlvtq7n8qkuovquqgbbi.png"></p><br><p>  To do this, it was necessary to write a line in the terminal: <code>defaults write com.apple.iphonesimulator CarPlayExtraOptions -bool YES</code> </p><br><p>  For some reason, this did not work - I had to run almost on the smallest simulator with a resolution of 800 √ó 480 points and a scale √ó 2.  At the moment, this setting works and helps a lot. </p><br><p>  Having created my sample project and armed myself with documentation, I began to figure out what was happening. <br>  The first thing I realized: navigation applications for CarPlay consist of base view and templates layers. </p><br><p><img src="https://habrastorage.org/webt/hf/t2/rw/hft2rwp8m2d71popp3tus4dif20.jpeg"></p><br><p>  Base view is your map.  On this layer there should be only a map, no other views and controls. </p><br><p>  Templates is an almost non-customizable mandatory set of UI elements for displaying routes, maneuvers, lists of all sorts, and so on. </p><br><h2 id="razrabotka-bety">  Beta Development </h2><br><p>  Let's move on to writing code.  The first thing to do is to implement a couple of required CPApplicationDelegate methods in the ApplicationDelegate file. </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application: UIApplication, didConnectCarInterfaceController controller: CPInterfaceController, to window: CPWindow )</span></span></span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application: UIApplication, didDisconnectCarInterfaceController controller: CPInterfaceController, from window: CPWindow )</span></span></span></span> {}</code> </pre> <br><p>  Let's look at the signature: </p><br><p>  With UIApplication, everything is clear. <br>  CPWindow - the heir of UIWindow, the window for the external display of the head unit of the radio. <br>  CPInterfaceController is something like an analogue of a UINavigationController, only from CarPlay.framework. </p><br><p>  We now turn directly to the implementation of the method. </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> application: UIApplication, didConnectCarInterfaceController controller: CPInterfaceController, to window: CPWindow )</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> carMapViewController = <span class="hljs-type"><span class="hljs-type">CarMapViewController</span></span>( interfaceController: controller ) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> navigationController = <span class="hljs-type"><span class="hljs-type">UINavigationController</span></span>( rootViewController: carMapViewController ) window.rootViewController = navigationController }</code> </pre> <br><p>  In didConnect, you need to write code similar to the one we used to see in didFinishLaunching.  CarMapViewController is a base view (controller actually, but ok), as per documentation. </p><br><p>  Here is a picture I finally got: </p><br><p><img src="https://habrastorage.org/webt/vv/l1/xx/vvl1xxebjbdb9ahiuucw1db_rzg.png"></p><br><p>  Somewhere around this time it dawned on me that in the new Xcode the new build system is enabled by default and most likely because of this 2GIS is not going to. </p><br><p>  I opened Xcode, put legacy (or rather stable, let's call things by their proper names) build system, and my theory was confirmed: 2GIS gathered. </p><br><p>  Having set the same capability-key, I launched 2GIS under CarPlay and did not see any logs about switching the application to background mode.  It became even more incomprehensible, because Apple engineers from the scene said about the background-mode, but, on the other hand, we were promised a contentView from UIAlertView, and as a result, UIAlertView became deprecated. </p><br><p>  Deciding that it should be so, I did not bother with MKMapView.  She would have deprived us of offline and made us re-write route drawing. </p><br><h2 id="problema-odnoy-karty">  Single card problem </h2><br><p>  I didn‚Äôt have time to rejoice at the news that there would be our map in CarPlay, as the following problem arose before me: because of the technical features, there could be only one card. <br>  A quick solution to this problem was, though not very elegant. </p><br><p>  Usually at the time of using 2GIS on CarPlay, the phone is locked and lies somewhere on the shelf.  This means that the map is not very necessary on the phone at that moment (it doesn‚Äôt hurt to search, of course).  Therefore, we decided to take the card from the main application when connecting the phone to CarPlay and display it on the CarPlay radio screen.  And when disconnected, respectively, return back to the application on the phone. </p><br><p>  Yes, the solution is this itself, but it is fast, it still works and did not have to kick a couple of other teams to rivet the MVP. </p><br><h2 id="kontroly-na-karte">  Controls on the map </h2><br><p>  So, we got our map on the screen of the radio.  Now it was necessary to do the first and obvious things for any map: controls of the zoom, current location and movement of the map. </p><br><p><img src="https://habrastorage.org/webt/c2/ql/u8/c2qlu8wi-sbkh5zizb7mjab-n7w.png"></p><br><p>  Let's start with the zoom and the current location, because these controls are on the map itself and these are not ordinary UIControl.  As I wrote above, on the base view there is only a map. </p><br><p>  In order to put these controls on the card, I had to climb into the documentation and sample application again.  There I read about the first template - CPMapTemplate. </p><br><p><img src="https://habrastorage.org/webt/5d/xn/26/5dxn263mlspdif8eqhxgc8wjgmc.png"></p><br><p>  CPMapTemplate - a transparent template for displaying some controls on the map and an analog navigationBar.  It is created and exhibited as follows: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> mapTemplate = <span class="hljs-type"><span class="hljs-type">CPMapTemplate</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.interfaceController.setRootTemplate(mapTemplate, animated: <span class="hljs-literal"><span class="hljs-literal">false</span></span>)</code> </pre> <br><p>  Next, you need to create these controls and put them on the map. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> zoomInButton = <span class="hljs-type"><span class="hljs-type">CPMapButton</span></span>(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> zoomOutButton = <span class="hljs-type"><span class="hljs-type">CPMapButton</span></span>(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> myLocationButton = <span class="hljs-type"><span class="hljs-type">CPMapButton</span></span>(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mapTemplate.mapButtons = [ zoomInButton, zoomOutButton, myLocationButton ]</code> </pre> <br><p>  But the mapButtons array turned out to be a joke, because how many items do you need for it, it will take only the first three elements and display them on the screen.  You will not get any errors in the log or asserts. </p><br><p>  Then I climbed up to look at how to make the map move, and I found this in the documentation: </p><br><pre> <code class="plaintext hljs">Navigation apps are designed to work with a variety of car input devices, and CarPlay does not support direct user interaction in the base view (apps do not directly receive tap or drag events).</code> </pre> <br><p>  Strange, I thought, and it was useful to watch how it was done in the CountryRoads sample application.  The answer is through this interface: </p><br><p><img src="https://habrastorage.org/webt/o0/wa/v6/o0wav6ogb8ofbx7-xqxsamjd6g4.png"></p><br><p>  It is not very convenient, but there is no other way, the documentation will not lie, right? </p><br><p>  Since the location for the controls on the map was over, it was necessary to make a button for transferring the map to the ‚Äúdragging‚Äù mode in this analog navigationBar. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> panButton = <span class="hljs-type"><span class="hljs-type">CPBarButton</span></span>(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mapTemplate.leadingNavigationBarButtons = [panButton] <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mapTemplate.trailingNavigationBarButtons = []</code> </pre> <br><p>  But here the leadingNavigationBarButtons and trailingNavigationBarButtons arrays were also not without a joke: how many elements in them or shove, they take only the first two.  Also without errors in the log and asserts. </p><br><p>  And to activate and deactivate the mode of dragging the card, you must write: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mapTemplate.showPanningInterface(animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mapTemplate.dismissPanningInterface(animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>)</code> </pre> <br><h2 id="postroenie-i-otobrazhenie-marshrutov-na-karte">  Building and displaying routes on the map </h2><br><p>  Next, I proceeded to reuse our already existing API to build routes. </p><br><p>  Just for the demo and understanding what and how to do, I decided to take two points and build a route between them.  Point A was the user's location, and Point B was our head office in Novosibirsk. </p><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> choice0 = <span class="hljs-type"><span class="hljs-type">CPRouteChoice</span></span>( summaryVariants: [<span class="hljs-string"><span class="hljs-string">"46 "</span></span>], additionalInformationVariants: [<span class="hljs-string"><span class="hljs-string">"  "</span></span>], selectionSummaryVariants: [<span class="hljs-string"><span class="hljs-string">"1  7 "</span></span>] ) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> choice1 = <span class="hljs-type"><span class="hljs-type">CPRouteChoice</span></span>( summaryVariants: [<span class="hljs-string"><span class="hljs-string">"46 "</span></span>], additionalInformationVariants: [<span class="hljs-string"><span class="hljs-string">"  "</span></span>], selectionSummaryVariants: [‚Äú<span class="hljs-number"><span class="hljs-number">1</span></span>  <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-string"><span class="hljs-string">"] ) let startItem = MKMapItem(‚Ä¶) let endItem = MKMapItem(‚Ä¶) endItem.name = "</span></span>,  ‚Äù <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> trip = <span class="hljs-type"><span class="hljs-type">CPTrip</span></span>( origin: startItem, destination: endItem, routeChoices: [choice0, choice1] ) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> tripPreviewTextConfiguration = <span class="hljs-type"><span class="hljs-type">CPTripPreviewTextConfiguration</span></span>( startButtonTitle: <span class="hljs-string"><span class="hljs-string">" ‚Äù, additionalRoutesButtonTitle: ‚Äú‚Äù, overviewButtonTitle: "</span></span><span class="hljs-string"><span class="hljs-string">" ) self.mapTemplate.showTripPreviews( [trip], textConfiguration: tripPreviewTextConfiguration )</span></span></code> </pre> </div></div><br><p>  On the screen we got a control with a description of the route: </p><br><p><img src="https://habrastorage.org/webt/wi/on/5r/wion5rbc8wx75tqwxzn-x72zsqw.png"></p><br><h2 id="rezhim-navigacii">  Navigation mode </h2><br><p>  Routes are good, but the main feature of the navigator is still in navigation.  To make it appear, you need to write the following: </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mapTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> mapTemplate: CPMapTemplate, startedTrip trip: CPTrip, using routeChoice: CPRouteChoice )</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationSession = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.mapTemplate.startNavigationSession(<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: trip) }</code> </pre> <br><p>  CPNavigationSession is a class with which you can display some UI elements that are needed only in navigation mode. </p><br><p>  To display the maneuver, you must: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> maneuver = <span class="hljs-type"><span class="hljs-type">CPManeuver</span></span>() maneuver.symbolSet = <span class="hljs-type"><span class="hljs-type">CPImageSet</span></span>( lightContentImage: icon, darkContentImage: darkIcon ) maneuver.instructionVariants = [<span class="hljs-string"><span class="hljs-string">". "</span></span>] maneuver.initialTravelEstimates = <span class="hljs-type"><span class="hljs-type">CPTravelEstimates</span></span>(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationSession?.upcomingManeuvers = [maneuver]</code> </pre> <br><p>  After that, on the screen of the radio, we get this: </p><br><p><img src="https://habrastorage.org/webt/30/uj/tp/30ujtpqhaaqkgx1oon7mjxpxiq8.png"></p><br><p>  To update the footage to the maneuver, you must: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> estimates = <span class="hljs-type"><span class="hljs-type">CPTravelEstimates</span></span>(‚Ä¶) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.navigationSession?.updateEstimates(estimates, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: maneuver)</code> </pre> <br><h2 id="it-just-works">  It just works! </h2><br><p>  When the main functionality for the navigator was ready, I decided to show this craft on the inside presentation.  The presentation was a success: everyone was excited about the idea of ‚Äã‚Äãfinishing, testing and launching the navigator as soon as possible. </p><br><p>  First of all, we ordered a real head unit with CarPlay support.  And here, as they say, the heat has gone. </p><br><p><img src="https://habrastorage.org/webt/wz/2-/cj/wz2-cjj1rusmnd270gkr5h8tdj0.jpeg" alt="PIONEER AVH-Z500BT"></p><br><h3 id="provision-profiles">  Provision Profiles </h3><br><p>  Because of the addition of a new capability-key, profiles need to be regenerated.  In normal development, we do not think about it, because Xcode will do everything by itself.  But not in the case of a private key. </p><br><pre> <code class="plaintext hljs">Code Signing Error: Automatic signing is unable to resolve an issue with the "v4ios" target's entitlements. Automatic signing can't add the com.apple.developer.carplay-maps entitlement to your provisioning profile. Switch to manual signing and resolve the issue by downloading a matching provisioning profile from the developer website.</code> </pre> <br><p>  It also broke our CI, as for the local distribution of application versions we use an enterprise account, to which we did not request permission to develop an application for CarPlay.  But that's another story. </p><br><h3 id="debugging">  Debugging </h3><br><p>  Connect to CarPlay via Bluetooth or Lightning.  Practice shows that the second method is much more popular.  Our Bluetooth radio tape recorder did not know how, so during development we had to use Wi-Fi debug.  If you have tried it on projects harder than hello world, then you know what kind of hell it is. </p><br><div class="spoiler">  <b class="spoiler_title">And for those who have not tried, I tell:</b> <div class="spoiler_text"><p>  I collected the application over the wire to the phone, and only then, connecting the phone to CarPlay, via Wi-Fi, poured it onto the phone and started up for a few minutes. <br>  Copying the application to the phone was about 3 minutes, launching the application for about a minute and only then, after starting, the stop at breakpoint was only 15 seconds later. </p></div></div><br><p>  And then it became very interesting to me why Apple did not do any DevKit (so that Apple-way, it just works and that's all).  Without it, collecting a test stand was not very convenient.  So far, once in a couple of weeks, something falls off - you have to remember from the pics what to stick with.  It is good that the administrator during the assembly of this stand told what and why. </p><br><h2 id="the-best-framework-we-ever-made">  The best framework we ever made </h2><br><p>  In the end, when everything was assembled on a real device, it became clear that the ‚Äú2GIS under CarPlay‚Äù feature would definitely be.  It is time to do beauty. </p><br><h3 id="problemy-s-vyuportom">  Viewport issues </h3><br><p>  It was necessary to set up the map viewport in order to draw routes in the area without extra controls, and not just in the middle.  In short, to make it look wrong: </p><br><p><img src="https://habrastorage.org/webt/ns/-k/gw/ns-kgwhubcu9cdqybc4nierpkqe.png"></p><br><p>  And so: </p><br><p><img src="https://habrastorage.org/webt/tl/sg/i3/tlsgi347mdeagljpg7i8ojxcjxc.png"></p><br><p>  I expected to get some layoutguide with the current visible area.  So that it takes into account both the navigationBar, the view with the route, and the controls on the map.  In fact, I got nothing.  It is still not clear how to set up a viewport, so we have a hardcode in our code like: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> routeControlsWidth = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view.frame.width * <span class="hljs-number"><span class="hljs-number">0.48</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> zoomControlWidth = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view.frame.width * <span class="hljs-number"><span class="hljs-number">0.15</span></span></code> </pre> <br><h3 id="postroenie-proezda-ne-tolko-mezhdu-dvumya-tochkami">  Building a passage not only between two points </h3><br><p>  In the first release, we decided to take our rubricator made via CPGridTemplate: </p><br><p><img src="https://habrastorage.org/webt/co/ri/ec/coriec6zvpz0pg5uy72kontsmc8.png"></p><br><p>  Favorites and Home / Work via CPListTemplate. </p><br><p><img src="https://habrastorage.org/webt/mh/iu/le/mhiulexz-l0j4snzfhdx8pvx8pa.png"></p><br><p>  And keyboard search through CPSearchTemplate: </p><br><p><img src="https://habrastorage.org/webt/gj/jp/co/gjjpcobjxxf3q_u3gdcoscfclda.png"></p><br><p>  I will not show the code about templates, since it is simple and the documentation about it is well written (at least about something). </p><br><div class="spoiler">  <b class="spoiler_title">However, it is worth mentioning what problems were found when working with them.</b> <div class="spoiler_text"><p>  CPInterfaceController can in a navigation similar to UIKit.  i.e. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.interfaceController.pushTemplate(listTemplate, animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.interfaceController.presentTemplate(alertTemplate, animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>)</code> </pre> <br><p>  But if you try to launch, for example, CPAlertTemplate, you will get an assertion in the logs that CPAlertTemplate can only be presented modally. </p><br><p>  It is not clear why Apple did not hide the logic of transients under the hood, without making an interface like: </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.interfaceController.showTemplate(listTemplate, animated: <span class="hljs-literal"><span class="hljs-literal">true</span></span>)</code> </pre> <br><p>  It also broke the ability to use CPTemplate heirs, like controllers in UIKit. </p><br><p>  If you try, for example, to put your heir to the stack of templates, you will get this: </p><br><pre> <code class="plaintext hljs">Terminating app due to uncaught exception 'NSInvalidArgumentException', reason: 'Unsupported object &lt;YourAwesomeGridTemplate: 0x60000060dce0&gt; &lt;identifier: 6CAC7E3B-FE70-43FC-A8B1-8FC39334A61D, userInfo: (null)&gt; passed to pushTemplate:animated:. Allowed classes: {( CPListTemplate, CPGridTemplate, CPSearchTemplate, CPMapTemplate )}'</code> </pre> </div></div><br><h3 id="testirovanie-i-bagi">  Testing and bugs </h3><br><p>  Testing involved <a href="https://habr.com/ru/users/artemenko-a-a/" class="user_link">artemenko-aa</a> .  One of the first bugs that he found, we still can not fix it. </p><br><p>  The fact is that when you disconnect the phone from the CarPlay radio tape recorder, we are sporadically beat Watchdog - without explaining the reason.  Even syslogs opened, nothing is clear.  So if you have an idea how to fix or understand the cause, then we would like to comment. </p><br><p>  The next bug was in the same place, but with a special behavior.  I wrote above that the CPApplicationDelegate method didDisconnect is called when the phone is disconnected from CarPlay.  And in this method we return the map from the screen of the radio tape recorder back to the main application.  Imagine how many problems we would have had if this method had not been called at least once out of five. </p><br><p>  It became clear that this is a problem of iOS, and not specifically our application, since the entire system believed that it was connected to CarPlay. </p><br><p><img src="https://habrastorage.org/webt/nh/3v/tc/nh3vtc2h-zlu5jutajc6-oyoca4.jpeg"></p><br><p>  I even wrote it as a radar (like all the other bugs).  I was asked to drop logs with such a profile, but I could not respond to support for some time, so they closed the radar. </p><br><p>  Once Apple did not plan to do anything, the problem had to be circumvented on its own, as it was reproduced quite often. </p><br><p>  And then I remembered that the lion's share of connections to CarPlay goes through Lightning.  This means that the phone is charging at the time of connection, and at the time of shutdown it stops charging.  And if so, then you can subscribe to the state of the battery and find out exactly when the phone stopped charging and disconnected from CarPlay. </p><br><p>  The scheme is tiny, but we had no choice.  We went this way, and everything worked! </p><br><p><img src="https://habrastorage.org/webt/ql/1h/j0/ql1hj02fnqottbo5fstubt65pss.jpeg"></p><br><p>  Fortunately, this crutch from the code has long been removed: Apple developers have fixed everything in one of the iOS releases. </p><br><h2 id="istoriya-dvuh-redzhektov">  The story of two rejects </h2><br><p>  <strong>The first reject</strong> was associated with the metadata.  The text of the redesign said that our description (not release notes) did not say that we support CarPlay.  As you can guess, neither in the review guidelines, nor the same Google Maps had such a thing.  We did not argue (because it is usually longer than editing the metadata), copied the line from the Release Notes in the Description and waited for a new review. </p><br><p>  <strong>The second rejection</strong> was due to the list of cities.  2GIS has a very cool feature - full offline mode.  This feature shot us in the leg. </p><br><p>  When connecting the application without a set city to CarPlay, we do not show the map, because there is nothing to show.  For this, we and zredzhektili.  The solution was simple: an alert without buttons, which says that you need to download the city. </p><br><p><img src="https://habrastorage.org/webt/uf/t7/rx/uft7rxuuaqu7ape9ehifdi6r6ki.png"></p><br><h2 id="to-o-chyom-nelzya-govorit">  What can not talk </h2><br><h3 id="peremeschenie-karty-zhestami">  Moving the map with gestures </h3><br><p>  Around the same time, the navigator came out under the CarPlay from Google Maps - and there it was possible to move the map with gestures on the screen.  Private APIs, I thought, that's obvious!  The guys from Google just came from a nearby building and said they need it.  After all, the documentation reads as follows: </p><br><pre> <code class="plaintext hljs">Navigation apps are designed to work with a variety of car input devices, and CarPlay does not support direct user interaction in the base view (apps do not directly receive tap or drag events).</code> </pre> <br><p>  However, I decided to make sure and went to Google, although it was almost meaningless, because there were no technical articles about CarPlay Navigation Apps.  However, I managed to find something useful and, EXTREMELY, <a href="https://developer.apple.com/design/human-interface-guidelines/carplay/interaction/touchscreen/">on the Apple site</a> . </p><br><p>  In the guidelines, I found a video that says the documentation is blatantly lying.  The video shows how the map can still be dragged with gestures.  I realized that I did not understand anything, and the only thing left for me was to open CarPlay.framework and revise all .h files. </p><br><p>  And lo and behold!  I find in CPMapTemplate his delegate CPMapTemplateDelegate, in which there are 3 methods that seem to shout that if you implement them, you can get control of the map gestures. </p><br><div class="spoiler">  <b class="spoiler_title">3 methods</b> <div class="spoiler_text"><p>  / * <em>Called when a pan gesture begins.</em>  <em>May not be called when connected to some CarPlay systems.</em> <em><br></em>  / <br>  optional public func mapTemplateDidBeginPanGesture (_ mapTemplate: CPMapTemplate) </p><br><p>  / * <em>Called when a pan gesture changes.</em>  <em>May not be called when connected to some CarPlay systems.</em> <em><br></em>  / <br>  optional public func mapTemplate (_ mapTemplate: CPMapTemplate, didUpdatePanGestureWithTranslate translation: CGPoint, velocity: CGPoint) </p><br><p>  / * <em>Called when a pan gesture ends.</em>  <em>May not be called when connected to some CarPlay systems.</em> <em><br></em>  / <br>  optional public func mapTemplate (_ mapTemplate: CPMapTemplate, didEndPanGestureWithVelocity velocity: CGPoint <br>  ) </p></div></div><br><p>  I implemented them and launched the application on the simulator - nothing worked.  Not having time to get upset, I realized that the simulator can be of the same quality as the documentation, and assembled on the device.  Everything started, fortunately there was no limit! </p><br><p>  Fun fact: CarPlay-radio tape recorder needs a quarter of the screen to understand that a pan-gesture has begun.  I want to note that UIPanGestureRecognizer needs only 10 points. </p><br><h3 id="neodinakovost-ui-na-raznyh-magnitolah">  The dissimilarity of the UI on different tape recorders </h3><br><p>  We received a message of support: the user gets only one sadgest in the search, although it could have been more.  Strange, I thought, because on all screens fit only one line.  Request a screenshot: </p><br><p><img src="https://habrastorage.org/webt/_t/k7/u6/_tk7u6wbcv55zig2n-b1dlbm9hu.png"></p><br><p>  And this is completely different from the UI CPSearchTemplate, which I showed above.  And this should be taken into account when developing, although it is impossible to understand how many cells in the plate below can fit into the screen. </p><br><h3 id="kontrol-ogranicheniya-skorosti">  Speed ‚Äã‚ÄãLimit Control </h3><br><p>  We looked at the statistics and realized that the navigator for CarPlay is used and it is necessary to bring it at least to the level of the navigator in the main application.  First decided to add a speed limit control.  No problem, of course, not done. </p><br><p>  Question number one: where to post? </p><br><p>  Rummaging through the .h files in the CPWindow again, I found a curious layoutGuide: <br>  var mapButtonSafeAreaLayoutGuide: UILayoutGuide </p><br><p>  And it turned out to be the right thing.  Our control fit in perfectly there: </p><br><p><img src="https://habrastorage.org/webt/vo/m7/qw/vom7qwpkpnxqf9a7wk6arc8-gtm.png"></p><br><p><img src="https://habrastorage.org/webt/q7/kq/fh/q7kqfhk7rrtwdzmergpd9yobbz0.png"></p><br><p>  Question number two: is this, in general, legal? </p><br><p>  The fact is that the technical control is on the base view.  And according to the documentation, the base view cannot contain anything but a map: </p><br><pre> <code class="plaintext hljs">The base view is where the map is drawn. The base view must be used exclusively to draw a map, and may not be used to display other UI elements. Instead, navigation apps overlay UI elements such as the navigation bar and map buttons using the provided templates.</code> </pre> <br><p>  But the reviewers missed us in the AppStore, which means that the controls that relate to navigation can still be embedded. </p><br><h3 id="golosovoy-poisk">  Voice search </h3><br><p><img src="https://habrastorage.org/webt/di/tt/ov/dittovwssqwrbku8rfd7fxpqlqo.png"></p><br><p><img src="https://habrastorage.org/webt/td/co/z-/tdcoz-1fk1-x880os0muqc_2iso.png"></p><br><p>  In an amicable way, this feature had to be done first of all, but we have accumulated a few technical debt tasks that prevented the voice search for CarPlay from being implemented.  And this task was not as simple as it seemed. </p><br><p>  <strong>Problem one: animation.</strong>  The fact is that in CPVoiceControlTemplate there is no possibility to make standard animations.  Animation for speech recognition and search had to be collected frame by frame from the pictures and indicate how much they go on time. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>...<span class="hljs-number"><span class="hljs-number">12</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> image = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>(named: <span class="hljs-string"><span class="hljs-string">"carplay_searching_\(i)"</span></span>) { images.append(image) } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> image = <span class="hljs-type"><span class="hljs-type">UIImage</span></span>.animatedImage(with: images, duration: <span class="hljs-number"><span class="hljs-number">0.96</span></span>)</code> </pre> <br><p>  It looks like you can guess, not really, but you do not want to inflate the size of the application. </p><br><p>  <strong>Problem two: access.</strong>  Alerts on access to the microphone and speech recognition appear on the phone display.  I had to write on the display of the radio tape recorder that the user needed to take the phone in hand, give permission, and only then use the navigator on the radio tape recorder.  Very comfortably! </p><br><h3 id="pravorulnye-avtomobili">  Right-hand drive cars. </h3><br><p>  We were sent a screenshot in which the UI of the entire application was turned over! </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e5c/b97/dc2/e5cb97dc248ebb9ffa0ff46147c290d7.jpg"></p><br><p>  And, of course, the viewport of the card remained the same as we used it, because no one expected that there is a separate setting for right-hand drive cars.  I didn‚Äôt find how to get around this ‚Äúcorrectly‚Äù, but noticed that since our control of the speed limit lies in the layoutGuide for the map controls, it moved to the left side. </p><br><p>  Ultrafix was not long in coming.  They did it rough, but it works. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isLeftWheelCar = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.speedControlViewController.view.frame.origin.x &gt; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.view.frame.size.width / <span class="hljs-number"><span class="hljs-number">2.0</span></span></code> </pre> <br><p>  ,    ,     . </p><br><p>     .        CarPlay, ,     .   ,    ,  Apple    . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/452638/">https://habr.com/ru/post/452638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452614/index.html">How to start programming in Adobe Illustrator. Part two</a></li>
<li><a href="../452618/index.html">What did Google I / O 2019 talk about: Android 10, AR apps and more</a></li>
<li><a href="../452622/index.html">An introduction to genomics for programmers</a></li>
<li><a href="../452624/index.html">Introduction to Spring Boot Actuator</a></li>
<li><a href="../452636/index.html">‚ÄúI am inevitability myself‚Äù: how do ecosystems appear and what can we expect from them</a></li>
<li><a href="../45264/index.html">SearchWiki</a></li>
<li><a href="../452644/index.html">DevConf X Web Developers Conference - June 21</a></li>
<li><a href="../452646/index.html">What the neural network saw on the first photo of a black hole</a></li>
<li><a href="../452648/index.html">PHP: How to parse a complex XML file and not drown in your own code</a></li>
<li><a href="../45265/index.html">Convenient Backup</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>