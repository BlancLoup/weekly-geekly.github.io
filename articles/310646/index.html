<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Run individual applications through OpenVPN without containers and virtualization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One fine morning I was telling in a telegram to my former friend and colleague what Linux network namespaces is and what it eats with. A colleague adm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Run individual applications through OpenVPN without containers and virtualization</h1><div class="post__text post__text-html js-mediator-article">  One fine morning I was telling in a telegram to my former friend and colleague what Linux network namespaces is and what it eats with.  A colleague admired, just as I did at one time, but it occurred to me that I should not crush the script, as I did before, but automate the launch of a separate network namespace and OpenVPN in it.  Since I use Debian Sid and Ubuntu 16.04 LTS, I made automation for myself in the form of systemd units, but this is at the end of the article.  After I told another person, this time far from IT, about the possibility of running only one application, such as a browser, for VPN, and the others, as before, he said, ‚ÄúJust for the sake of it, it is worth switching to Linux on your computer‚Äù , and I decided to write an article on how to do it. <br><a name="habracut"></a><br>  Much has been written about Linux network namespaces, but for those who don‚Äôt know, I will briefly quote the description in Russian: <br><br>  ‚ÄúIn linux, such a remarkable thing as namespaces appeared relatively long ago.  The main application of this technology is container virtualization, but on the router you can come up with many different applications, since there are ‚Äúnetwork namespaces‚Äù among neymspaces.  Network namespaces allow within one machine in each namespace to have: <br><br><ul><li>  own set of routing tables (and there are 2 ^ 31-1 items) </li><li>  own arp table </li><li>  iptables rules </li><li>  own devices (and therefore qdisc + tc'y classes) ‚Äù </li></ul><br>  And now we come to the topic of our article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Script for manually raising the network namespace and running OpenVPN in it with commenting <br><blockquote><pre><code class="hljs pgsql">#!/bin/bash sudo ip netns <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> vpn #  namespace   vpn sudo ip netns exec vpn ip addr <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span> dev lo #     lo sudo ip netns exec vpn ip link <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> lo up #  loopback-  netns sudo ip link <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> vpn0 <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> veth peer <span class="hljs-type"><span class="hljs-type">name</span></span> vpn1 #     ,    netns     sudo ip link <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vpn0 up #    sudo ip link <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> vpn1 netns vpn up #   netns       sudo ip addr <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dev vpn0 #       sudo ip netns exec vpn ip addr <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dev vpn1 #      netns sudo ip netns exec vpn ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> VPN_IP via <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> dev vpn1 #    VPN-( VPN_IP    ) sudo ip netns exec vpn ip route <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> via <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span> dev vpn1 #           ,   OpenVPN       (    ,  OpenVPN               ) sudo iptables -A <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span> ! -i vpn0 -s <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -j <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> sudo iptables -t nat -A POSTROUTING -s <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -o en+ -j MASQUERADE #  ,  en+  wl+    wifi-     sudo sysctl -q net.ipv4.ip_forward=<span class="hljs-number"><span class="hljs-number">1</span></span> #    sudo mkdir -p /etc/netns/vpn #         resolv.conf   netns echo "nameserver 8.8.8.8" |sudo tee /etc/netns/vpn/resolv.conf #   <span class="hljs-number"><span class="hljs-number">8.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span>    sudo ip netns exec vpn /usr/sbin/openvpn <span class="hljs-comment"><span class="hljs-comment">--daemon --writepid /run/openvpn/vpn.pid --cd /etc/openvpn/ --config vpn.conf #  OpenVPN  - /etc/openvpn/vpn.conf  netns</span></span></code> </pre> </blockquote><br>  Having executed this script we can with the help of the command: <br><br><pre> <code class="bash hljs">$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> vpn curl http://ifconfig.me</code> </pre> <br>  To make sure that inside netns we have OpenVPN raised and we go to the network inside netns through our OpenVPN.  Now with the command: <br><br><pre> <code class="bash hljs">$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> vpn su - USER_NAME -c firefox</code> </pre> <br>  we can launch the browser and get the browser working through the VPN, while the rest of the system works with us, as before, and everything else goes directly (in the command, replace USER_NAME with the name of your user).  An example of launching a browser is based on the fact that the user has sudo on his desktop.  If someone can tell how to use ip netns exec without sudo I would be grateful. <br><br>  Similar to the browser, you can launch IM clients, torrent clients and everything else.  In case firefox swears at startup, that it cannot connect to dbus, put dbus-launch in front of its command in front of sudo. <br><br>  Script to stop our netns: <br><blockquote><pre> <code class="hljs pgsql">#!/bin/bash sudo ip netns pids vpn | xargs -rd<span class="hljs-string"><span class="hljs-string">'\n'</span></span> sudo kill sudo rm -rf /etc/netns/vpn sudo sysctl -q net.ipv4.ip_forward=<span class="hljs-number"><span class="hljs-number">0</span></span> sudo iptables -D <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span> ! -i vpn0 -s <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -j <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> sudo iptables -t nat -D POSTROUTING -s <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -o en+ -j MASQUERADE sudo ip link del vpn0 sudo ip netns <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> vpn</code> </pre> </blockquote><br>  Units for systemd raising everything indicated on the machine at boot.  Unit for netns: <br><br><blockquote><pre> <code class="hljs ruby">[Unit] Description=Network namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VPN After=syslog.target network.target StopWhenUnneeded=<span class="hljs-literal"><span class="hljs-literal">true</span></span> RefuseManualStart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> RefuseManualStop=<span class="hljs-literal"><span class="hljs-literal">true</span></span> [Service] EnvironmentFile=<span class="hljs-regexp"><span class="hljs-regexp">/etc/netns</span></span><span class="hljs-regexp"><span class="hljs-regexp">/vpn.env Type=oneshot RemainAfterExit=true ExecStart=/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ip netns add vpn ExecStart=/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ip netns exec vpn ip addr add 127.0.0.1/</span></span><span class="hljs-number"><span class="hljs-number">8</span></span> dev lo ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> netns exec vpn ip link set lo up ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> link add vpn<span class="hljs-number"><span class="hljs-number">0</span></span> type veth peer name vpn1 ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> link set vpn<span class="hljs-number"><span class="hljs-number">0</span></span> up ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> link set vpn1 netns vpn up ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> addr add ${NETWORK}.<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dev vpn<span class="hljs-number"><span class="hljs-number">0</span></span> ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> netns exec vpn ip addr add ${NETWORK}.<span class="hljs-number"><span class="hljs-number">2</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> dev vpn1 ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> netns exec vpn ip route add ${VPN_SERVER} via ${NETWORK}.<span class="hljs-number"><span class="hljs-number">1</span></span> dev vpn1 ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> netns exec vpn ip route add default via ${NETWORK}.<span class="hljs-number"><span class="hljs-number">254</span></span> dev vpn1 ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/iptables</span></span> -A INPUT ! -i vpn<span class="hljs-number"><span class="hljs-number">0</span></span> -s ${NETWORK}.<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -j DROP ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/iptables</span></span> -t nat -A POSTROUTING -s ${NETWORK}.<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -o wl+ -j MASQUERADE ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/sysctl</span></span> -q net.ipv4.ip_forward=<span class="hljs-number"><span class="hljs-number">1</span></span> ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/mkdir</span></span> -p /etc/netns/vpn ExecStart=<span class="hljs-regexp"><span class="hljs-regexp">/bin/sh</span></span> -c <span class="hljs-string"><span class="hljs-string">"echo 'nameserver 8.8.8.8' &gt; /etc/netns/vpn/resolv.conf"</span></span> ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/bin/rm</span></span> -rf /etc/netns/vpn ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/sysctl</span></span> -q net.ipv4.ip_forward=<span class="hljs-number"><span class="hljs-number">0</span></span> ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/iptables</span></span> -D INPUT ! -i vpn<span class="hljs-number"><span class="hljs-number">0</span></span> -s ${NETWORK}.<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -j DROP ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/sbin/iptables</span></span> -t nat -D POSTROUTING -s ${NETWORK}.<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> -o wl+ -j MASQUERADE ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> link del vpn<span class="hljs-number"><span class="hljs-number">0</span></span> ExecStop=<span class="hljs-regexp"><span class="hljs-regexp">/bin/ip</span></span> netns delete vpn [Install] WantedBy=multi-user.target</code> </pre> </blockquote><br>  Unit for OpenVPN: <br><br><blockquote><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">Unit</span></span>] Description=OpenVPN inside network <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">Requires</span></span>=vpnns.service After=syslog.target network.target vpn-ns.service [Service] PrivateTmp=<span class="hljs-literal"><span class="hljs-literal">true</span></span> Type=forking PIDFile=/<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/openvpn/%i.pid ExecStart=/bin/ip netns exec vpn /usr/sbin/openvpn --daemon --writepid /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/run/openvpn/%i.pid --cd /etc/openvpn/ --config %i.conf [Install] WantedBy=multi-user.target</code> </pre> </blockquote><br>  And the file with variables in which I set the address of the VPN server and the network used by netns: <br><br><blockquote><pre> <code class="hljs pgsql">VPN_SERVER=<span class="hljs-number"><span class="hljs-number">1.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> # Change IP <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> your OpenVPN-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> IP NETWORK=<span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span></code> </pre> </blockquote><br>  By copying the files for systemd to their places on the file system with the command <br><br><pre> <code class="bash hljs">$ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> openvpn-ns@NAME.service</code> </pre> <br>  where NAME is the same name for your OpenVPN config file.  After that, you can run <br><br><pre> <code class="bash hljs">$ sudo systemctl start openvpn-ns@NAME.service</code> </pre> <br>  OpenVPN starts in a dedicated network namespace named vpn. <br><br>  By team <br><br><pre> <code class="bash hljs">$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> vpn curl http://ifconfig.me</code> </pre> <br>  You can check that inside netns there is now a VPN and you leave from the address of your server. <br><br>  ¬ª <a href="https://github.com/Ernillew/netns-vpn">Systemd units on github</a> . <br>  ¬ªScripts <a href="https://gist.github.com/Ernillew/aa0a13e738d2165878111801c5144d18">vpnns_up.sh</a> and <a href="https://gist.github.com/Ernillew/8b1d9f410806a56f374d5183c304ffcf">vpnns_down.sh</a> on gist.gihub.com <br><br>  Two links helped me in preparing this article: <br>  ¬ª <a href="https://schnouki.net/posts/2014/12/12/openvpn-for-a-single-application-on-linux/">Schnouki.net/posts/2014/12/12/openvpn-for-a-single-application-on-linux</a> <br>  ¬ª <a href="https://www.linux.org.ru/forum/admin/11591881">Www.linux.org.ru/forum/admin/11591881</a> <br><br>  Special thanks to Sergey Voronov, aka Raist, after a conversation with which I decided to make configs and write an article. <br><br>  <b>PS</b> Launching a VPN in a dedicated network namespace can be used not only as a circumvention of censorship, but also for work purposes. After I made a unit for OpenVPN, I made myself a similar VPN raising to the client‚Äôs network, which could be started with access to it network only individual applications. </div><p>Source: <a href="https://habr.com/ru/post/310646/">https://habr.com/ru/post/310646/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../310636/index.html">"Effective Leader". We talk about the book by Peter Drucker (+ audio version)</a></li>
<li><a href="../310638/index.html">About new successes of confrontation (SR UHF! *)</a></li>
<li><a href="../310640/index.html">September. Emptying apple orchard</a></li>
<li><a href="../310642/index.html">Which OS could be a replacement for Windows - expert opinions</a></li>
<li><a href="../310644/index.html">Poll: which features of Vivaldi do you like best?</a></li>
<li><a href="../310648/index.html">Translation of excerpts from Robert Heinlein‚Äôs book, Take Your Government Back - part 16</a></li>
<li><a href="../310654/index.html">Lengthening gameplay and creating replayability</a></li>
<li><a href="../310656/index.html">Michael Pryor, Trello: How to build a mass market product</a></li>
<li><a href="../310658/index.html">Checking the mobile application for legality</a></li>
<li><a href="../310660/index.html">Space Computing with a clear example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>