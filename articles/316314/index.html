<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FIAS addresses in the PostgreSQL environment. Part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No matter how we treat the quality of FIAS addresses, it is necessary to work with them, because this is the only all-Russian reference book of addres...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FIAS addresses in the PostgreSQL environment. Part 1</h1><div class="post__text post__text-html js-mediator-article">  No matter how we treat the quality of FIAS addresses, it is necessary to work with them, because this is the only all-Russian reference book of addresses.  Therefore, sooner or later, it is necessary to solve the problem of associating the location of real estate objects, legal and physical addresses with the address from FIAS. <br><div style="text-align:center;"><img src="https://habrastorage.org/files/90f/3f4/68a/90f3f468a89b4002ad9d9ec27665cba5.png"></div><br>  This article describes the experience with the list of FIAS addressing elements loaded into the database running PostgreSQL.  To work with FIAS addressing elements, several functions have been created in the PL / pgSQL language. <br><a name="habracut"></a><br>  The full text of the article consists of 4 parts.  The first half of this part of the article contains comments on the implementation of the function.  The second is the source text of the function.  For those readers who are interested only in the source code, we suggest that you go straight to the <a href="https://habr.com/ru/post/316314/">Appendix</a> . <br><br><a name="AO_AOT_def"></a><br><h2>  Pedigree addressing element </h2><br>  Let's start with an example.  A call to the fstf_AddressObjects_AddressObjectTree function ('bfc1236d-b5d2-4734-a238-3b1e4830e963') will result in the following list of entries. <br><br>  <strong>Table 1. Result of executing the fstf_AddressObjects_AddressObjectTree function</strong> <br><table><tbody><tr><th>  AOGUID </th><th>  CurrStatus </th><th>  Actstatus </th><th>  AOLevel </th><th>  ShortName </th><th>  FormalName </th></tr><tr><td>  db9c4f8b-b706-40e2-b2b4-d31b98dcd3d1 </td><td>  0 </td><td>  one </td><td>  one </td><td>  edge </td><td>  Krasnoyarsk </td></tr><tr><td>  625497d3-22de-4390-b4b4-2febfbfc15ce </td><td>  0 </td><td>  one </td><td>  3 </td><td>  rn </td><td>  Balakhtinsky </td></tr><tr><td>  39da6405-b3e6-4baf-b332-d47b73b4d5fb </td><td>  0 </td><td>  one </td><td>  6 </td><td>  P </td><td>  Mighty </td></tr><tr><td>  bfc1236d-b5d2-4734-a238-3b1e4830e963 </td><td>  0 </td><td>  one </td><td>  7 </td><td>  street </td><td>  New </td></tr></tbody></table><br>  On closer examination, you can see that the element identifier (AOGUID) ‚ÄúNovaya Street‚Äù was passed as the function argument, as a result, four entries were received: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  record with the characteristics of the street itself; </li><li>  Three parent records of the village, district and region, which owns the street. </li></ul><br>  The function has one more optional parameter sign of relevance (CurrStatus), with which you can view the pedigree not only of the current address-forming element, but also already outdated. <br><br>  The full text of the function is given in the Appendix in the subsection <a href="https://habr.com/ru/post/316314/">Creating a function fstf_AddressObjects_AddressObjectTree</a> <br><a name="ADDROBJ_def"></a><br><h3>  From the very beginning </h3><br>  If you know how FIAS tables are arranged, then this section can be skipped. <br><br>  The need for such a function is dictated by the fact that the list of FIAS addressing elements (ADDROBJ) is a tree structure, by which each element refers to the identifier (AOGUID) of the parent record by the value of the ParentGUID field.  Those.  looking through the records of the original list, you usually observe a long list of streets.  In order to determine in which locality a street is located, it is necessary by the value of the ParentGUID to find records with such an element identifier. <br><br><img src="https://habrastorage.org/files/265/39e/533/26539e533de04eb1b2e1983a6977d4ac.png"><br><br>  <strong>Fig.</strong>  <strong>1. The hierarchy of the addressing elements of FIAS.</strong> <br><br>  This is not a slip of the pen and not a reservation.  According to the value of ParentGUID, not one, but several records can be found.  From which it follows that the identifier of the address-forming element is not the primary key for the table containing the list ADDROBJ. <br><br>  The fact is that the list of address-forming elements, together with each element, stores the history of its ‚Äúrenaming‚Äù.  Those.  under one element identifier is stored not only the current name of the element, but its former names.  That is, a separate entry in the ADDROBJ list stores data about the addressing element, as well as the characteristics of the calendar period during which the name of the element was relevant. <br><br>  <strong>Table 2. History of the street "Krasnoyarsk Territory, Taimyr District, Dolgano-Nenetsky, Dudinka City, Levinsky Peski, Beregovaya Street"</strong> <br><table><tbody><tr><th>  AOID record ID </th><th>  Previous PrevID ID </th><th>  ID of the next record NextID </th><th>  Sign on KLADR CurrStatus </th><th>  Sign of Actuality ActStatus </th><th>  Start Date StartDate </th><th>  EndDate Period End Date </th></tr><tr><td>  fcf51361-5494-4edc-a6bc-d5c0d471c729 </td><td>  2a993f3b-5743-426c-8b7d-b5c7affe49cd </td><td></td><td>  0 </td><td>  one </td><td>  11/25/2015 0:00 </td><td>  06.06.2079 0:00 </td></tr><tr><td>  2a993f3b-5743-426c-8b7d-b5c7affe49cd </td><td>  9199c92b-18a5-431a-8b13-f54abe36e84f </td><td>  fcf51361-5494-4edc-a6bc-d5c0d471c729 </td><td>  7 </td><td>  0 </td><td>  09/30/2015 0:00 </td><td>  11/25/2015 0:00 </td></tr><tr><td>  9199c92b-18a5-431a-8b13-f54abe36e84f </td><td>  b06ff65e-aadb-42eb-9c70-a8548a40645c </td><td>  2a993f3b-5743-426c-8b7d-b5c7affe49cd </td><td>  6 </td><td>  0 </td><td>  09/28/2015 0:00 </td><td>  09/30/2015 0:00 </td></tr><tr><td>  b06ff65e-aadb-42eb-9c70-a8548a40645c </td><td>  a997aa7c-f2b1-4b7e-9471-5fc1f51a6752 </td><td>  9199c92b-18a5-431a-8b13-f54abe36e84f </td><td>  five </td><td>  0 </td><td>  04/08/2013 0:00 </td><td>  09/28/2015 0:00 </td></tr><tr><td>  a997aa7c-f2b1-4b7e-9471-5fc1f51a6752 </td><td>  b27d8e44-ade1-4dd0-b4b5-5eaa7205ff0b </td><td>  b06ff65e-aadb-42eb-9c70-a8548a40645c </td><td>  four </td><td>  0 </td><td>  01.11.2013 0:00 </td><td>  04/08/2013 0:00 </td></tr><tr><td>  b27d8e44-ade1-4dd0-b4b5-5eaa7205ff0b </td><td>  327b28cc-5171-43c6-bd88-a0a2172bbf71 </td><td>  a997aa7c-f2b1-4b7e-9471-5fc1f51a6752 </td><td>  3 </td><td>  0 </td><td>  12/07/2012 0:00 </td><td>  01.11.2013 0:00 </td></tr><tr><td>  327b28cc-5171-43c6-bd88-a0a2172bbf71 </td><td>  fb7b54db-7efb-4aaf-b4cb-2364b35b80b3 </td><td>  b27d8e44-ade1-4dd0-b4b5-5eaa7205ff0b </td><td>  2 </td><td>  0 </td><td>  01.02.2012 0:00 </td><td>  12/07/2012 0:00 </td></tr><tr><td>  327b28cc-5171-43c6-bd88-a0a2172bbf71 </td><td>  fb7b54db-7efb-4aaf-b4cb-2364b35b80b3 </td><td>  b27d8e44-ade1-4dd0-b4b5-5eaa7205ff0b </td><td>  one </td><td>  0 </td><td>  01.02.2012 0:00 </td><td>  12/07/2012 0:00 </td></tr></tbody></table><br>  The order of the periods of the relevance of the name of the address-forming element can be determined by viewing two multidirectional lists.  To do this, each entry on the period of the relevance of the element contains two pointers to the previous one (PrevID) and subsequent periods (NextID).  The first period of the address-forming element does not have a pointer to the previous period, while the last (current) one does not have a pointer to the next period. <br><br><img src="https://habrastorage.org/files/431/731/bbd/431731bbdce647b382d21552b74bfcb3.png"><br><br>  <strong>Fig.</strong>  <strong>2. The main fields of the entry of the FIAS addressing element.</strong> <br><br>  The period of relevance is characterized by the dates of the beginning and end of the period, respectively StartDate and EndDate.  In this case, the dates of the beginning of the first period and the end of the last have conditional values.  The date of the beginning of the first period is taken as ‚Äú01/01/1900 0:00‚Äù, and the date of the end of the last (current) period is taken as ‚Äú06/06/2079 0:00‚Äù. <br><br>  The current (currently valid) name of the address-forming element is indicated in the record of the last period, provided that it is not completed, i.e.  The end date of the period is greater than or equal to the current date. <br><br>  To simplify the search for an entry about the current period of an item, in addition to the start and end date of the period, two more fields are entered: CurrStatus and ActStatus. <br><br>  ActStatus takes quite expected values: ‚Äú1‚Äù is the current version of the characteristics of the element, ‚Äú0‚Äù is not the current or historical version, as indicated in the directory. <br><br>  With the values ‚Äã‚Äãof the CurrStatus field, the situation is more complicated.  Using its values, two are solved. <br>  Tasks at the same time: the identifier of each version of the record about the address-forming element is set and the sign of the relevance of the record is assigned.  Therefore, the last actual entry about the element contains the value ‚Äú0‚Äù in this field, and all historical records are numbered in the order of appearance - ‚Äú1‚Äù is the earliest entry, following it in time - ‚Äú2‚Äù, etc. <br><br>  Table 2 contains a list of records with versions of the description of the Beregovaya village, the village of Levinsky Peski.  In this list, the previous to the current record contains ‚Äú7‚Äù in the CurrStatus field. <br><br><h3>  How it works </h3><br><img src="https://habrastorage.org/files/910/b6a/a8d/910b6aa8dbd4446e87da1356db9e1208.png"><br><br>  <strong>Fig.</strong>  <strong>3. Simplified implementation of the fstf_AddressObjects_AddressObjectTree function.</strong> <br><br>  To implement the function, it is suggested to use a recursive query similar to the one shown in Fig.  3, where a_AOGUID is the identifier of the address-forming element, a_CurrStatus is the sign of relevance according to KLADR.  Both values ‚Äã‚Äãare passed to the function via parameters.  Like any recursive query, this consists of two parts: the first part contains the first record of the element with the identifier a_AOGUID, the next recursive part sequentially contains all the actual parent records with respect to the records obtained by the process of the previous iterations.  The transition to the parent element is performed via the ParentGUID link of the current record. It is important here that each iteration results in only one record.  For this, a limit is imposed on the value of the CurrStatus feature. <br><br>  An example of the result of applying a recursive query in the absence of a unique record at least at one iteration step is given in Fig.  3 <br><br>  The question arises - why is the restriction on the CurrStatus value implemented through the nested subquery, and not by assigning actual values? <br><br>  Firstly, because CurrStatus = 0 is not always in the current item record, as Table 4 demonstrates. <br><br>  Secondly, it is necessary that the function returns the result for irrelevant element names.  Including, even in the case when on the way between the initial and final elements there is an element for which no actual record is declared. <br><br>  <strong>Table 3. The result of performing the function on an element with a non-unique sign of the choice of record</strong> <br><table><tbody><tr><th>  AOGUID </th><th>  CurrStatus </th><th>  Actstatus </th><th>  AOLevel </th><th>  ShortName </th><th>  FormalName </th></tr><tr><td>  db9c4f8b-b706-40e2-b2b4-d31b98dcd3d1 </td><td>  0 </td><td>  one </td><td>  one </td><td>  edge </td><td>  Krasnoyarsk </td></tr><tr><td>  db9c4f8b-b706-40e2-b2b4-d31b98dcd3d1 </td><td>  0 </td><td>  one </td><td>  one </td><td>  edge </td><td>  Krasnoyarsk </td></tr><tr><td>  3d4c8618-9e22-4838-8f89-80da6851da90 </td><td>  0 </td><td>  one </td><td>  3 </td><td>  rn </td><td>  Rybinsk </td></tr><tr><td>  719b789d-2476-430a-89cd-3fedc643d821 </td><td>  51 </td><td>  0 </td><td>  four </td><td>  g </td><td>  Zaozerny </td></tr><tr><td>  719b789d-2476-430a-89cd-3fedc643d821 </td><td>  51 </td><td>  one </td><td>  four </td><td>  g </td><td>  Zaozerny </td></tr></tbody></table><br>  If a_CurrStatus = 0 is used as a condition for selecting a single record for an element, the function will not return Zaozerny for city records whose entries are given in Table 4. If you set a_CurrStatus = 51, then the result will be as shown in Table 3 . <br><br>  Condition: <br><br><pre><code class="sql hljs">ao.currstatus = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MIN</span></span>(iao.currstatus) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid)</code> </pre> <br>  ... which is present in the second part of the recursive query is not entirely correct, if we proceed from the rule of assigning values ‚Äã‚Äãfor the CurrStatus attribute.  Indeed, if among the records of the address-forming element there is no actual (CurrStatus = 0), then the most recent is the record with the maximum, i.e.  the last used value of the CurrStatus attribute. <br><br>  When the above condition is used, the oldest is selected from the records of the irrelevant element. <br><br>  <strong>Table 4. An element with a recurring non-zero value CurrStatus.</strong> <br><table><tbody><tr><th>  AOGUID </th><th>  CurrStatus </th><th>  Actstatus </th><th>  AOLevel </th><th>  ShortName </th><th>  FormalName </th></tr><tr><td>  719b789d-2476-430a-89cd-3fedc643d821 </td><td>  51 </td><td>  0 </td><td>  four </td><td>  g </td><td>  Zaozerny </td></tr><tr><td>  719b789d-2476-430a-89cd-3fedc643d821 </td><td>  51 </td><td>  one </td><td>  four </td><td>  g </td><td>  Zaozerny </td></tr></tbody></table><br>  Therefore, a more correct solution would be to use the following condition: <br><br><pre> <code class="sql hljs">ao.currstatus = CASE WHEN 0 &lt; ALL(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> iao.currstatus <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(iao.currstatus) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> fias_AddressObjects iao <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ao.aoguid = iao.aoguid) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br>  But, in this condition there are two subqueries.  So you have to choose between semantic severity. <br>  request and the effectiveness of its implementation. <br><br>  The justification for the use of the first variant of the condition is the actual absence of differences in the names of the address-forming element in the historical records. <br><br>  So as of October 13, 2016, out of 26,728 address-forming elements of the Krasnoyarsk Territory in 19865 there are historical records.  However, only for 1350 elements (6.8% of the number of elements with a history) there are differences in the names of the same element.  Those.  for 93.2% of the elements, the first and second conditions will return the same list of names.  Differences are possible only in the values ‚Äã‚Äãof the CurrStatus attribute, which, given the purpose of the function, can be neglected. <br><br>  Fully replacing the CurrStatus feature with ActStatus is not possible.  By the condition ActStatus = 1, the current item record is definitely selected, but you must use both features to work with historical records.  Such a solution is given in the Appendix <a href="https://habr.com/ru/post/316314/">Creating the function fstf_AddressObjects_AddressObjectTree</a> . <br><br><h2>  ATTACHMENT </h2><br><a name="Script1"></a><h3>  Creating the function fstf_AddressObjects_AddressObjectTree </h3><br><p>  A detailed description of the function can be found <a href="https://habr.com/ru/post/316314/">here.</a> </p><br><div class="spoiler">  <b class="spoiler_title">function code</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> fstf_AddressObjects_AddressObjectTree(a_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), a_CurrStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*************************************************************************/</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   (  )   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*************************************************************************/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> fstf_AddressObjects_AddressObjectTree( a_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> a_CurrStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    4: */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 0 - , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 1-50 - , .. */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    , */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* 51 -  */</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> (rtf_AOGUID <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">36</span></span>), rtf_CurrStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtf_ActStatus <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>, rtf_AOLevel <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>,rtf_ShortTypeName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>), rtf_AddressObjectName <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c_ActualStatusCode <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span> :=<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> c_NotActualStatusCode CONSTANT INTEGER :=0; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_AOGUID VARCHAR(36); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_ParentGUID VARCHAR(36); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_CurrStatus INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*    4*/</span></span> v_ActStatus INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">/*   . */</span></span> v_AOLevel INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> v_ShortName VARCHAR(10); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> v_FormalName VARCHAR(120); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> v_Return_Error INTEGER; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-comment"><span class="hljs-comment">--*********************************************************************** --*********************************************************************** BEGIN IF a_CurrStatus IS NOT NULL THEN SELECT INTO v_AOGUID,v_ParentGUID,v_CurrStatus,v_ActStatus,v_AOLevel, v_ShortName, v_FormalName ao.AOGUID,ao.ParentGUID,ao.CurrStatus,ao.ActStatus,ao.AOLevel, ao.ShortName, ao.FormalName FROM fias_AddressObjects ao WHERE ao.AOGUID=a_AOGUID AND ao.CurrStatus=a_CurrStatus; ELSE SELECT INTO v_AOGUID,v_ParentGUID,v_CurrStatus,v_ActStatus,v_AOLevel, v_ShortName, v_FormalName ao.AOGUID,ao.ParentGUID,ao.CurrStatus,ao.ActStatus,ao.AOLevel, ao.ShortName, ao.FormalName FROM fias_AddressObjects ao WHERE ao.AOGUID=a_AOGUID AND ao.ActStatus=c_ActualStatusCode; IF NOT FOUND THEN SELECT INTO v_AOGUID,v_ParentGUID,v_CurrStatus,v_ActStatus,v_AOLevel, v_ShortName, v_FormalName ao.AOGUID,ao.ParentGUID,ao.CurrStatus,ao.ActStatus,ao.AOLevel, ao.ShortName, ao.FormalName FROM fias_AddressObjects ao WHERE ao.AOGUID=a_AOGUID AND ao.ActStatus=c_NotActualStatusCode AND ao.currstatus = (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid); END IF; END IF; RETURN QUERY SELECT v_AOGUID,v_CurrStatus,v_ActStatus,v_AOLevel, v_ShortName,v_FormalName; WHILE v_ParentGUID IS NOT NULL LOOP SELECT INTO v_AOGUID,v_ParentGUID,v_CurrStatus,v_ActStatus,v_AOLevel, v_ShortName, v_FormalName ao.AOGUID,ao.ParentGUID,ao.CurrStatus,ao.ActStatus,ao.AOLevel, ao.ShortName,ao.FormalName FROM fias_AddressObjects ao WHERE ao.AOGUID=v_ParentGUID AND ao.ActStatus=c_ActualStatusCode; IF NOT FOUND THEN SELECT INTO v_AOGUID,v_ParentGUID,v_CurrStatus,v_ActStatus,v_AOLevel, v_ShortName,v_FormalName ao.AOGUID,ao.ParentGUID,ao.CurrStatus,ao.ActStatus,ao.AOLevel, ao.ShortName, ao.FormalName FROM fias_AddressObjects ao WHERE ao.AOGUID=v_ParentGUID AND ao.ActStatus=c_NotActualStatusCode AND ao.currstatus = (SELECT MAX(iao.currstatus) FROM fias_AddressObjects iao WHERE ao.aoguid = iao.aoguid); END IF; RETURN QUERY SELECT v_AOGUID,v_CurrStatus,v_ActStatus,v_AOLevel,v_ShortName, v_FormalName; END LOOP; END; $BODY$ LANGUAGE plpgsql; COMMENT ON FUNCTION fstf_AddressObjects_AddressObjectTree(a_AOGUID VARCHAR(36), a_CurrStatus INTEGER) IS '  (  )    '; --ROLLBACK TRANSACTION; COMMIT TRANSACTION; SELECT * FROM fstf_AddressObjects_AddressObjectTree('719b789d-2476-430a-89cd-3fedc643d821',51) ORDER BY rtf_AOLevel; SELECT * FROM fstf_AddressObjects_AddressObjectTree('719b789d-2476-430a-89cd-3fedc643d821') ORDER BY rtf_AOLevel;</span></span></code> </pre><br></div></div><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/316314/">https://habr.com/ru/post/316314/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316304/index.html">How to make PostgreSQL read faster</a></li>
<li><a href="../316306/index.html">[Peter, Announcement] Meeting JUG.ru with Andrei Ershov: ‚ÄúHow we made a phone platform using GridGain‚Äù</a></li>
<li><a href="../316308/index.html">Modular CSS: - The toolkit that we have now in the arsenal is just a fairy tale</a></li>
<li><a href="../316310/index.html">From an arbitrator to a company owner with a turnover of $ 100 million</a></li>
<li><a href="../316312/index.html">Apple Watch Application Market: Forecasts and Facts</a></li>
<li><a href="../316316/index.html">11 types of caching for a modern site</a></li>
<li><a href="../316318/index.html">Why do I need to reboot domain controllers once a month</a></li>
<li><a href="../316320/index.html">Moving to Swift 3 using the migratory ‚Äúrobot‚Äù in Xcode 8.1 and 8.2</a></li>
<li><a href="../316322/index.html">ZeroNet - Truly Distributed Network: Social Network, Wiki Engine (changes for half a year)</a></li>
<li><a href="../316324/index.html">SDN & NFV and what's the Cloud?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>