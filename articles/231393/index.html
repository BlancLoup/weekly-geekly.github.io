<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Similar search queries in hh.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Most major search engines and services have a mechanism for similar search queries, when the user is offered options that are thematically close to wh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Similar search queries in hh.ru</h1><div class="post__text post__text-html js-mediator-article">  Most major search engines and services have a mechanism for similar search queries, when the user is offered options that are thematically close to what he was looking for.  So do in google, yandex, bing, amazon, a few days ago it appeared and on hh.ru! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aa9/137/85a/aa913785af9ef88b41e659e619cc463a.png"></div><br><br>  In this article I will tell about how we extracted similar search queries from the logs of the site hh.ru. <br><a name="habracut"></a><br>  First, a few words about what ‚Äúrelated queries‚Äù are (why) and why they are needed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  First, not all job seekers represent exactly what they want to find.  Often, they simply examine offers in several areas of activity, introducing different requests.  This behavior is particularly pronounced for students starting their careers, and for applicants without a specific specialty.  For such a surf will be useful hints for the correct requests. </li><li>  Often, applicants enter too general a request, for example, a ‚Äú <a href="http://hh.ru/search/vacancy%3Farea%3D1%26text%3D%25D0%25BC%25D0%25B5%25D0%25BD%25D0%25B5%25D0%25B4%25D0%25B6%25D0%25B5%25D1%2580%2B%25D0%25B2%2B%25D0%25BC%25D0%25BE%25D1%2581%25D0%25BA%25D0%25B2%25D0%25B5">manager in Moscow</a> ‚Äù, who has more than 18,000 vacancies.  Of these, it is difficult to choose something suitable, so the request should be narrowed down, for example, to ‚Äú <a href="http://hh.ru/search/vacancy%3Farea%3D1%26text%3D%25D0%259C%25D0%25B5%25D0%25BD%25D0%25B5%25D0%25B4%25D0%25B6%25D0%25B5%25D1%2580%2B%25D0%25BF%25D0%25BE%2B%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B4%25D0%25B0%25D0%25B6%25D0%25B0%25D0%25BC%2B%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C%25D0%25BD%25D1%258B%25D1%2585%2B%25D0%25BC%25D0%25B0%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D0%25B0%25D0%25BB%25D0%25BE%25D0%25B2">sales manager of building materials</a> ‚Äù. </li><li>  Too narrow requests, on the contrary, can lead to a blank issue.  For example, the query ‚Äú <a href="http://hh.ru/search/vacancy%3Ftext%3D%25D1%2581%25D1%2582%25D0%25B0%25D0%25B6%25D0%25B5%25D1%2580%2B%25D0%25B1%25D1%2583%25D1%2585%25D0%25B3%25D0%25B0%25D0%25BB%25D1%2582%25D0%25B5%25D1%2580%2B%25D0%25BF%25D0%25BE%2B%25D1%2580%25D0%25B0%25D1%2581%25D1%2587%25D0%25B5%25D1%2582%25D1%2583%2B%25D0%25B7%25D0%25B0%25D1%2580%25D0%25B0%25D0%25B1%25D0%25BE%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B9%2B%25D0%25BF%25D0%25BB%25D0%25B0%25D1%2582%25D1%258B">trainee accountant for payroll accounting</a> ‚Äù is not found, but if it is corrected for the more general ‚Äú <a href="http://hh.ru/search/vacancy%3Fclusters%3Dtrue%26text%3D%25D0%25B1%25D1%2583%25D1%2585%25D0%25B3%25D0%25B0%25D0%25BB%25D1%2582%25D0%25B5%25D1%2580%2B%25D1%2581%25D1%2582%25D0%25B0%25D0%25B6%25D0%25B5%25D1%2580">accountant trainee</a> ‚Äù, several results appear. </li><li>  Sometimes job seekers and employers speak different languages.  For example, a vacancy is called an ‚Äútruck mixer driver‚Äù, and the applicant is looking for a ‚Äúmixer driver‚Äù.  Usually we try to solve this problem with the help of synonyms, but this is not always possible.  Related queries should help the user formulate a search in the language of employers. </li><li>  The most interesting case, in my opinion, when the applicant knows what he wants to find, and clearly articulates his request.  But he can not guess about the existing area of ‚Äã‚Äãactivity that could interest him.  For example, ‚Äúsoil scientist‚Äù will want to do ‚Äúecology‚Äù.  This problem is usually solved by personal recommendations, but similar requests may push such a specialist to interesting vacancies, ‚Äúmove‚Äù him to another area of ‚Äã‚Äãjob search. </li></ul><br><br>  We have long thought about this feature, but the final push was given by a great article from LinkedIn about their implementation of similar queries - <a href="http://mitultiwari.net/docs/papers/related_search_cikm2012.pdf">metaphor</a> .  It describes three methods for extracting such queries from the search activity of users, which we have implemented. <br><br><h4>  Methods for determining similar queries </h4><br>  The simplest and most obvious of the related query extraction algorithms is <b>overlap</b> or search for intersecting queries. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d5/7d7/cf9/1d57d7cf995595a48c8c4c9e376374e6.png"></div><br><br>  We split all search phrases into tokens and find queries with common tokens.  In reality, such requests can be very much, so the question arises about choosing the most appropriate.  Following common sense, you can define two rules: the more tokens intersect, the closer the requests, and the intersection in rare tokens is more powerful than in widely used tokens.  From here we get the formula: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08c/184/cfe/08c184cfeb19ca4ccc2417c418641bec.png" height="70"></div><br><br>  where <i>overlap</i> is the number of common tokens in <i>q1</i> and <i>q2</i> queries, <br>  <i>Q (t)</i> - the number of requests from tokens t, <br>  <i>N</i> is the number of unique queries. <br><br>  The next way is <b>collaborative filtering (CF)</b> .  It is often used in recommender systems and is well suited for recommending similar requests.  Behind the complex name is a simple assumption that during one session the user makes related requests.  Moreover, when looking for a job, a long session can be neglected, because user preferences change slowly.  It is hard to imagine that the applicant, who is currently making the request ‚Äúpersonal driver‚Äù, will be looking for job openings for ‚Äújava developer‚Äù tomorrow.  But this assumption is not true for employers, they can look for candidates for very different jobs even for one hour. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b3d/cf7/efe/b3dcf7efead3da48b0f238b7281323f8.png"></div><br><br>  So, with collaborative filtering, for each user we find all the requests made by him for a certain period and form pairs of them.  To select the most frequent pairs we use the variation of the formula tf-idf. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fb/a45/3db/5fba453db4e2981d72fdf9674a68a02a.png" height="70"></div><br><br>  where <i>tf</i> is the number of pairs of queries <i>q1</i> and <i>q2</i> , <br>  <i>df</i> is the number of pairs containing the <i>q2</i> query, <br>  <i>N</i> is the number of unique queries, <br>  <i>c</i> = 0.1, this value is still hardcoded, but it can be chosen from user behavior. <br><br>  df does not allow the most common requests like ‚Äúmanager‚Äù and ‚Äúaccountant‚Äù to appear in recommendations too often. <br><br>  The third <b>QRQ</b> algorithm (query-result-query) is similar to CF, but we build pairs of queries not by user, but by job. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/19b/151/6ee/19b1516ee5fb2df5a94192a374c649cb.png"></div><br><br>  Those.  We consider similar requests for which they go to the same vacancy.  Having found all the pairs of requests, it remains for us to choose the most suitable of them.  To do this, we need to find the most popular pairs, not forgetting to reduce the weight of frequency requests and vacancies.  LinkedIn in its article offers the following formulas, and they provide interesting results even for rare requests: for example, for ‚Äúprobability theory‚Äù, related queries are ‚Äúalgorithmic trading‚Äù and ‚Äúfutures‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/530/310/a58/530310a584b2a228efea01e98ad84788.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b07/f8f/c9e/b07f8fc9e8e1a7ef4ff2147de325ed9b.png" height="70"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/727/d99/e9b/727d99e9b5ecc871d88f60f620e19f36.png" height="70"></div><br><br>  Despite the fact that the formulas look complicated, there are simple things behind them.  <i>V</i> is the contribution of the vacancy to the total rank: the ratio of the number of views of a vacancy on request <i>q</i> to the total number of views of this vacancy.  Similarly, <i>Q</i> is the contribution of a query: the ratio of the number of views of a vacancy for a query <i>q</i> to the number of views of other vacancies for that query. <br><br>  It should be noted that the last two methods are not symmetrical, i.e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/acc/696/2f1/acc6962f1af86c55f6e8f38d5984cdbd.png" height="35"></div><br><br><h4>  Implementation </h4><br>  We implemented the above algorithms with hadoop and hive.  Hadoop is a system for distributing ‚Äúbig data‚Äù storage, managing a cluster, and performing distributed computing.  Every night we upload access logs of the site for the past day, while transforming them into a convenient structure for analysis. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7fd/8e2/765/7fd8e2765f0f2870fccb2d049a2afcfd.png"></div><br><br>  We also use Apache Hive, an add-on for Hadoop, which allows us to formulate queries to data in the form of HiveQL (SQL-like language of zaros).  HiveQL does not conform to SQL standards, but allows you to do join and subselect, contains many functions for working with strings, dates, numbers and arrays.  Able to do Group By and supports various aggregate functions and window-functions.  Allows you to write your map, reduce and transform functions in any programming language.  For example, in order to get the most popular search queries per day, you need to run this HiveQL: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(query_all_values[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]), <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) c <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> access_raw <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">year</span></span>=<span class="hljs-number"><span class="hljs-number">2014</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>=<span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">day</span></span>=<span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">path</span></span>=<span class="hljs-string"><span class="hljs-string">'/search/vacancy'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> query_all_values[<span class="hljs-string"><span class="hljs-string">'text'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lower</span></span>(query_all_values[<span class="hljs-string"><span class="hljs-string">'text'</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LiMIT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>;</code> </pre> <br><br>  Before you start ‚Äúmining‚Äù similar requests, they need to be cleaned of garbage and normalized.  We did the following: <br><ul><li>  threw out long requests (more than 5 words and 100 characters), </li><li>  removed the garbage symbols and words of the grammar query </li><li>  applied stemming </li><li>  combined synonyms </li><li>  sorted words. </li></ul><br><br>  After such a modification, the request ‚Äútender department chief‚Äù turned into ‚Äú# 0d26431546 head department‚Äù.  You can‚Äôt show this to users, so we‚Äôll change this code to the most popular request form ‚ÄúTender Manager‚Äù. <br><br>  Then we proceed to the implementation of the algorithms described above, which consists in applying several successive transformations of the original logs.  All transformations are written in HiveQL, which is probably not very optimal in terms of performance, but it is simple, visual, and takes up a few lines of code.  The figure shows the data transformations for collaborative filtering.  QRQ is implemented similarly. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d82/b96/ae5/d82b96ae5ab35fa44dd845d1c69472a0.png" width="600"></div><br><br>  In order not to recommend ‚Äújunk‚Äù requests, we drove each request through the search for vacancies on hh.ru and threw out all for which there are less than 5 results. <br><br>  The final stage of the task is to combine the results of the three algorithms.  We considered two options: show users three top queries from each method or try to sum up the weights.  We chose the second method, normalizing before summing the weight: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/91d/a81/41d/91da8141df65bb50f14a5e293ab34dd3.png" height="70"></div><br><br>  And everything seemed to work out quite well, but for some queries strange results came out: ‚Äúnovice specialist‚Äù -&gt; ‚Äúcareer head‚Äù.  First, here we were summed up by stemming, which ‚Äúcareer‚Äù and ‚Äúcareer‚Äù leads to one form.  And secondly, it turned out that the three weights found had a different distribution and simply cannot be summed up. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3f5/d57/c08/3f5d57c08e086b1a6a40f6d956623a2e.png"></div><br><br>  I had to bring them to the same scale.  To do this, each weight was sorted in ascending order, numbered, and the resulting sequence number was divided by the total number of pairs of queries for a particular algorithm.  This number has become a new weight, the problem with the ‚Äúboss of the pit‚Äù has disappeared. <br><br><h4>  results </h4><br>  To find similar search queries, we used hh.ru logs for 4 months, which is 270 million searches and 1.2 billion page views of vacancies.  In total, users made about 1.5 million unique text queries, after cleaning and normalization, we left a little over 70 thousand. <br><br>  Already for the first day of this feature, about 50 thousand people took advantage of the correction of requests.  Most popular fixes: <br><br>  <i>driver -&gt; personal driver</i> <i><br></i>  <i>administrator -&gt; beauty salon administrator</i> <i><br></i>  <i>driver -&gt; driver with private car</i> <i><br></i>  <i>Accountant -&gt; Accountant for primary documentation</i> <i><br></i>  <i>Accountant -&gt; Deputy Chief Accountant</i> <br><br>  Corrections of popular queries in the it sphere: <br><table><tbody><tr><td>  System Administrator </td><td>  system administrator assistant, helpdesk, windows system administrator </td></tr><tr><td>  programmer </td><td>  C ++ programmer, remote programmer, c # programmer </td></tr><tr><td>  Technical Director </td><td>  Director of Operations, Deputy Technical Director, Technical Manager </td></tr><tr><td>  tester </td><td>  testing specialist, game tester, remote tester </td></tr><tr><td>  junior </td><td>  java junior, junior c ++, junior qa </td></tr></tbody></table><br><br>  It was interesting to see in which professional areas this feature is most in demand: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/50d/fc3/015/50dfc30157480c139791434375519b89.png"></div><br><br>  It is seen that more than half of the students who were looking for jobs, tried other requests.  The least popular feature is IT and Consulting. <br><br><h4>  Todo </h4><br>  What else would like to do: <br><ul><li>  Automate  Now related requests are built once for the period from January 1 to May 1, 2014.  When automating, you need not forget about protection against vulnerabilities, because, knowing the algorithms, it is easy to create advertisements or simply hooligans instead of related queries. </li><li>  Experiment with algorithm weights and conduct AB testing to show the most useful queries. </li><li>  Consider the number of results for the query: suggest only those queries for which there are guaranteed results.  Even with a large number of vacancies found, it will be useful to show narrowing requests, and for small ones, expanding ones. </li><li>  Related queries in resume search. </li><li>  Use in suggest. </li></ul><br><br><h5>  Links </h5><br>  <a href="http://mitultiwari.net/docs/papers/related_search_cikm2012.pdf">Metaphor: A System for Related Search Recommendations</a> <br>  <a href="http://hadoop.apache.org/">Apache hadoop</a> <br>  <a href="https://hive.apache.org/">Apache heve</a> </div><p>Source: <a href="https://habr.com/ru/post/231393/">https://habr.com/ru/post/231393/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231377/index.html">Honda's smart home in the US is ready for testing.</a></li>
<li><a href="../231381/index.html">First look at Avocode</a></li>
<li><a href="../231383/index.html">We make video chat in a web browser with a minimum of labor costs</a></li>
<li><a href="../231389/index.html">Amazon is preparing its own card reader for release in August</a></li>
<li><a href="../231391/index.html">Welcome to Moscow Django Meetup July 31</a></li>
<li><a href="../231395/index.html">Battery Tracking for Personal Analytics Laptop</a></li>
<li><a href="../231399/index.html">NASA tested the prototype of the European ice drilling system, Jupiter‚Äôs satellite</a></li>
<li><a href="../231405/index.html">5 signs of a good illustration for kids</a></li>
<li><a href="../231407/index.html">Chris Bird appointed new Mozilla CEO</a></li>
<li><a href="../231411/index.html">Understanding bind and bindAll in Backbone.js</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>