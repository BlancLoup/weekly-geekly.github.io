<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Push mailings on PHP (Android and IOS). Minimum ready solution</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About push notification notifications have already been written many times on Habr√©, for example, here and here , but there is still no direct guide t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Push mailings on PHP (Android and IOS). Minimum ready solution</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a77/808/f37/a77808f377cfde949305804118c5de6f.png" alt="GCM"><br><br>  About push notification notifications have already been written many times on Habr√©, for example, <a href="http://habrahabr.ru/post/157481/" title="Features of work with Apple push notification service">here</a> and <a href="http://habrahabr.ru/post/200216/" title="About the problems and the solution of the task of delivering push notifications to millions of devices on various platforms">here</a> , but there is still no direct guide to action.  So, if you're interested, I ask under the cat. <br><a name="habracut"></a><br><h1>  Device Token Registration </h1><br>  First of all, the application developer creates magic in which the registration address is specified, it can be like this: htpp: //test.ru/secret/android? Token = value and htpp: //test.ru/secret/ios? Token = value . <br>  The most remarkable thing is that there is simply no protection against left registrations, although it may be the magic that failed or was not of very high quality, if there is still protection, write in the comments, I will definitely supplement the article with useful advice. <br><br>  At the input we get the value of the token that comes when installing the application, there may be some delays, but literally 10-20 seconds.  Tokens are unique, but you can also make a check for uniqueness when writing to the database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An example of a token for android: <br><br><blockquote>  APA91bFY <br></blockquote><br><br>  Ios: <br><br><blockquote>  628a3f4a28bb994bb7c9a4143950d240c6d5a1dab8621e9ed61a2109a074f832 <br></blockquote><br><br>  In this step, with the registration of devices, we are finished. <br><br><h1>  Newsletter Notifications </h1><br>  Apple uses the <a href="https://developer.apple.com/library/ios/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/Chapters/ApplePushService.html" title="APNS">APNS</a> service, and Google <a href="http://developer.android.com/google/gcm/index.html" title="GCM">GCM</a> (C2DM is considered obsolete, keep this in mind) and after reading the documentation you can go to your favorite business, namely, cycling, but the budget was limited and I began to search for ready-made solutions.  The most <a href="https://github.com/duccio/ApnsPHP" title="ApnsPHP">useful</a> thing that met is <a href="https://github.com/duccio/ApnsPHP" title="ApnsPHP">ApnsPHP</a> and <a href="https://github.com/CodeMonkeysRu/GCMMessage" title="GCMMessage">GCMMessage</a> , they work on both 5.3+ and 5.4+. <br><br>  When using libraries, the most important thing is to get the right certificates and the secret phrase in the case of APNS and the secret token to work with GCM. <br><br>  An example of a ready-made code for sending notifications for GCM, tokens are advised to send in a pack, even with large quantities, work pretty quickly, the service returns invalid tokens (users deleted the application), they should be deleted immediately. <br><br><pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fnSendAndroid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($tokens, $text, $config)</span></span></span><span class="hljs-function"> </span></span>{ $sender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CodeMonkeysRu\GCM\Sender($config[<span class="hljs-string"><span class="hljs-string">'androidTokenAuth'</span></span>]); $message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CodeMonkeysRu\GCM\Message($tokens, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">"message"</span></span> =&gt; $text)); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $response = $sender-&gt;send($message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($response-&gt;getFailureCount() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { $invalidRegistrationIds = $response-&gt;getInvalidRegistrationIds(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($invalidRegistrationIds <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $invalidRegistrationId) { <span class="hljs-comment"><span class="hljs-comment">//Remove $invalidRegistrationId from DB //    APS91bFY-2CYrriS-Dt6y9_dGHhkPVwy7njqFpfgpzGYlDT4l0SQeqKr-lc1OM0a2DQ33S3EKwy2YJn-upKxOT6rNwgk350xUM3g8VX65rkGocOQX80Ta34pwXo6fyn-usoaGUAm4lzsqbCL-gkzHZZXRX39kUQfnA fnDeleteToken($invalidRegistrationId); } } if ($response-&gt;getSuccessCount()) { echo '   ' . $response-&gt;getSuccessCount() . ' '; } } catch (CodeMonkeysRu\GCM\Exception $e) { switch ($e-&gt;getCode()) { case CodeMonkeysRu\GCM\Exception::ILLEGAL_API_KEY: case CodeMonkeysRu\GCM\Exception::AUTHENTICATION_ERROR: case CodeMonkeysRu\GCM\Exception::MALFORMED_REQUEST: case CodeMonkeysRu\GCM\Exception::UNKNOWN_ERROR: case CodeMonkeysRu\GCM\Exception::MALFORMED_RESPONSE: fnLog('    ' . $e-&gt;getCode() . ' ' . $e-&gt;getMessage()); break; } } }</span></span></code> </pre> <br><br>  Everywhere they write that APNS is very easy to use, in principle, this is true, if you consider that there are certificates for the test and production, you should pay attention, you need a certificate, a secret phrase and root certificate, it all happens in the personal account of the developer. <br><br>  Users have the ability to delete particularly annoying applications, so before sending it is worth removing dead tokens. <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">feedback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($config)</span></span></span><span class="hljs-function"> </span></span>{ $feedback = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApnsPHP_Feedback( ApnsPHP_Abstract::ENVIRONMENT_PRODUCTION, $config[<span class="hljs-string"><span class="hljs-string">'apn'</span></span>][<span class="hljs-string"><span class="hljs-string">'sert'</span></span>] ); $feedback-&gt;setProviderCertificatePassphrase($config[<span class="hljs-string"><span class="hljs-string">'apn'</span></span>][<span class="hljs-string"><span class="hljs-string">'passphrase'</span></span>]); $feedback-&gt;setRootCertificationAuthority($config[<span class="hljs-string"><span class="hljs-string">'apn'</span></span>][<span class="hljs-string"><span class="hljs-string">'RootCertificat'</span></span>]); $feedback-&gt;connect(); $aDeviceTokens = $feedback-&gt;receive(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($aDeviceTokens)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($aDeviceTokens <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $DeviceToken) { <span class="hljs-comment"><span class="hljs-comment">/** *  * [timestamp] =&gt; 1406040206 * [tokenLength] =&gt; 32 * [deviceToken] =&gt; 738d005a11bca268e2f1bffbfed88a456e261020b9277883cde14d9c8f47cde0 */</span></span> <span class="hljs-comment"><span class="hljs-comment">//'DELETE LOW_PRIORITY FROM tokens WHERE token=:token'; fnLog('Feedback -   ' . $DeviceToken[deviceToken]); } } $feedback-&gt;disconnect(); }</span></span></code> </pre><br><br>  Then the sending itself: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fnSendIos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($tokens, $text, $config)</span></span></span><span class="hljs-function"> </span></span>{ $push = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApnsPHP_Push( ApnsPHP_Abstract::ENVIRONMENT_PRODUCTION, $config[<span class="hljs-string"><span class="hljs-string">'apn'</span></span>][<span class="hljs-string"><span class="hljs-string">'sert'</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// Set the Provider Certificate passphrase $push-&gt;setProviderCertificatePassphrase($config['apn']['passphrase']); $push-&gt;setRootCertificationAuthority($config['apn']['RootCertificat']); $message = new ApnsPHP_Message(); $listTokens = array(); foreach ($tokens as $token) { $message-&gt;addRecipient($token); $listTokens[] = $token; } $push-&gt;connect(); $message-&gt;setText($text); $push-&gt;add($message); $push-&gt;send(); $push-&gt;disconnect(); $aErrorQueue = $push-&gt;getErrors(); if (!empty($aErrorQueue)) { fnLog('  ios - ' . print_r($aErrorQueue, true)); if (is_array($aErrorQueue)) { foreach($aErrorQueue as $error) { if (isset($error['ERRORS']) &amp;&amp; is_array($error['ERRORS'])) { foreach ($error['ERRORS'] as $m) { if (isset($m['statusMessage']) &amp;&amp; $m['statusMessage'] == 'Invalid token') { $arrayID = $m['identifier'] - 1; if (isset($listTokens[$arrayID])) { //DELETE LOW_PRIORITY FROM tokens WHERE token=:token' fnLog('   ' . $listTokens[$arrayID]); } } } } } } } }</span></span></code> </pre><br><br>  If you are not confused with certificates, then the distribution will be successful. <br><br>  Here is a condo turned out. </div><p>Source: <a href="https://habr.com/ru/post/231727/">https://habr.com/ru/post/231727/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231715/index.html">Show Sound # 13 - Podcast on audio equipment, components, formats and technologies</a></li>
<li><a href="../231717/index.html">IBM poll: analytics for managing business processes in your company</a></li>
<li><a href="../231719/index.html">WordPress Optimization. Competition "UPU for the year for the best ideas!"</a></li>
<li><a href="../231723/index.html">[Translation] 10 commandments that storage manufacturers want to hide</a></li>
<li><a href="../231725/index.html">nooLite: new PT112 temperature sensor and RX2132 USB receiver</a></li>
<li><a href="../231729/index.html">How to make the Galaxy S4 work with a Pioneer radio. Switch selinux to permissive</a></li>
<li><a href="../231731/index.html">Library for automating acceptance testing in mobile applications</a></li>
<li><a href="../231733/index.html">History of Audiomania. Part 1</a></li>
<li><a href="../231735/index.html">Connecting the display of the DVD player to the microcontroller</a></li>
<li><a href="../231739/index.html">Classes in Swift [Part 1]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>