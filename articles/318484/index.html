<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fast Data Mining or C # vs Python Performance Comparison (pandas-numpy-skilearn)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! Understanding Spark Apache, I faced the fact that after a rather small complication of data preparation algorithms, calculations began to be pe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fast Data Mining or C # vs Python Performance Comparison (pandas-numpy-skilearn)</h1><div class="post__text post__text-html js-mediator-article">  Hello!  Understanding Spark Apache, I faced the fact that after a rather small complication of data preparation algorithms, calculations began to be performed extremely slowly.  Therefore, I wanted to implement something in C # and compare performance with a solution similar in class on the python stack (pandas-numpy-skilearn).  Similarly, because they are executed on the local machine.  Data preparation in C # was carried out with in-built tools (linq), the calculation of linear regression by the library of <a href="http://www.extremeoptimization.com/">extremeoptimization</a> . <br><br>  The ‚ÄúB.  Predicting customer spending ‚Äùfrom the November <a href="https://sdsj.ru/contest.html">Sberbank Data Science Journey</a> competition. <br><br>  Immediately it should be emphasized that this article describes only the aspect of comparing the performance of platforms, and not the quality of the model and predictions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, first a brief description of the sequence of actions implemented in C # (pieces of code will be lower): <br><br>  1. Download data from csv.  Used library <a href="https://www.codeproject.com/Articles/9258/A-Fast-CSV-Reader">Fast Csv Reader</a> . <br>  2. Filter expense transactions and group by month. <br>  3. Add to each client the categories for which he had no operations.  In order to avoid a lengthy iteration cycle-in-cycle used <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D0%25B8%25D0%25BB%25D1%258C%25D1%2582%25D1%2580_%25D0%2591%25D0%25BB%25D1%2583%25D0%25BC%25D0%25B0">Bloom filter</a> .  Found implementation on C # <a href="https://gist.github.com/richardkundl/8300092">here</a> . <br>  4. Formation array <a href="https://en.wikipedia.org/wiki/Feature_hashing">Hashing trick</a> .  Since the finished implementation under C # could not be found, I had to implement it myself.  To do this, download and finish <a href="https://gist.github.com/automatonic/3725443">the</a> hashing <a href="https://gist.github.com/automatonic/3725443">implementation</a> murmurhash3 <br>  5. Actually regression calculation. <br><a name="habracut"></a><br>  The solution on Jupyter Notebook (hereinafter referred to as JN) looks like this (I omit connecting libraries, because it was not included in the measured time): <br><br><pre><code class="python hljs">%%time <span class="hljs-comment"><span class="hljs-comment">#       transactions = pd.read_csv('.//JN//SBSJ//transactions.csv') all_cuses = transactions.customer_id.unique() #     mcc = pd.read_csv('.//JN//SBSJ//tr_mcc_codes.csv', sep=';') all_mcc = mcc.mcc_code.unique() #   transactions = transactions[transactions.amount &lt; 0].copy() transactions['day'] = transactions.tr_day.apply(lambda dt: dt.split()[0]).astype(int) transactions.day += 29 - transactions['day'].max()%30 #    transactions['month_num'] = (transactions.day) // 30 train_transactions = transactions[transactions.month_num &lt; 15] #         (     ) grid = list(product(*[all_cuses, all_mcc, range(11, 15)])) train_grid = pd.DataFrame(grid, columns = ['customer_id', 'mcc_code', 'month_num']) train = pd.merge(train_grid, train_transactions.groupby(['month_num', 'customer_id', 'mcc_code'])[['amount']].sum().reset_index(), how='left').fillna(0) #       for month_shift in range(1, 3): train_shift = train.copy() train_shift['month_num'] = train_shift['month_num'] + month_shift train_shift = train_shift.rename(columns={"amount" : 'amount_{0}'.format(month_shift)}) train_shift = train_shift[['month_num', 'customer_id', 'mcc_code', 'amount_{0}'.format(month_shift)]] train = pd.merge(train, train_shift, on=['month_num', 'customer_id', 'mcc_code'], how='left').fillna(0) train['year_num'] = (train.month_num) // 12 #  hashier trick hasher = FeatureHasher(n_features=6, input_type='string') train_sparse = \ hasher.fit_transform(train[['year_num', 'month_num', 'customer_id', 'mcc_code']].astype(str).as_matrix()) train_sparse2 = sparse.hstack([train_sparse, np.log(np.abs(train[['amount_1', 'amount_2']]) + 1).as_matrix(),]) #       d = list(train_sparse2.toarray()) #  clf = LinearRegression() clf.fit(d, np.log(np.abs(train['amount']) + 1)) # print('Coefficients: \n', clf.coef_) print('Intercept: \n', clf.intercept_) print("\nRMSLE: ") np.sqrt(mse(np.log(np.abs(train['amount']) + 1),clf.predict(d)))</span></span></code> </pre> <br>  Now more about the implementation of C #.  Experiments have shown that classes like DataTable and others are very wasteful with respect to memory.  Therefore, a simple list of elements of the Client class was used: <br><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Client</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Int32 name; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Int16 period; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Int16 year; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Int16 mcc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> amount; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> amount1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> amount2; <span class="hljs-comment"><span class="hljs-comment">//  get/set ...</span></span></code> </pre><br>  Further, data reading and grouping: <br><br><pre> <code class="cs hljs"> <span class="hljs-comment"><span class="hljs-comment">//    List&lt;Client&gt; lTransGrouped = lClientsTrans.AsParallel() .Where(row =&gt; row.getAmount() &lt; 0) .GroupBy(row =&gt; new { month = (row.getPeriod() + 29 - Convert.ToInt16(maxNumDay) % 30) / 30, //     mcc = row.getMcc(), cid = row.getName() }) .Select(grp =&gt; new Client( grp.Key.cid, Convert.ToInt16(grp.Key.month), grp.Key.mcc, Math.Log(Math.Abs(grp.Sum(r =&gt; r.getAmount())) + 1))).ToList(); lClientsTrans = null;</span></span></code> </pre> <br>  Then add the missing operation types using the Bloom filter.  It could have been possible without it, but then the execution time would increase (full search for each type) or the amount of memory used (if all the types are added in a row, and then aggregated). <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;Client&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addPeriodMcc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;Client&gt; lTransGrouped, Int16 maxNumMon</span></span></span><span class="hljs-function">)</span></span> { List&lt;Client&gt; lMcc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Client&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fnameMcc = <span class="hljs-string"><span class="hljs-string">@"j:\hadoop\Contest\Contest\tr_mcc_codes.csv"</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  mcc_code CsvReader csvMccReader = new CsvReader(new StreamReader(fnameMcc), true, ';'); //    while (csvMccReader.ReadNextRecord()) { Int16 mcc = Convert.ToInt16(csvMccReader[0]); lMcc.Add(new Client(0, 0, mcc, 0)); } //     mcc    List&lt;Client&gt; lNewMcc = new List&lt;Client&gt;(); //       ID  var lTransCID = lTransGrouped.AsParallel().Select(a =&gt; a.getName()).Distinct(); Console.WriteLine("Unique CID: " + lTransCID.Count()); //    int capacity = lTransGrouped.Count() * 6; //   ,     var filter = new Filter&lt;string&gt;(capacity); //   //   foreach (var i in lTransGrouped) filter.Add(i.getName().ToString() + i.getPeriod() + i.getMcc()); //        ,   foreach (var cid in lTransCID) for (Int16 m = 0; m &lt;= maxNumMon; m++) foreach (var mcc in lMcc) if (filter.Contains(cid.ToString() + m.ToString() + mcc.getMcc().ToString()) != true) lNewMcc.Add(new Client(cid, m, mcc.getMcc(), 0)); lTransCID = lMcc = null; Console.WriteLine("Count lNewMcc: " + lNewMcc.Count); Console.WriteLine("Count lTransGrouped: " + lTransGrouped.Count); //  List&lt;Client&gt; lTransFull = lNewMcc.Union(lTransGrouped).ToList(); Console.WriteLine("Count lTransFull: " + lTransFull.Count); lTransGrouped = lNewMcc = null; return lTransFull; }</span></span></code> </pre> <br>  Stage of adding operations for previous months: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> List&lt;Client&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAmounts</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;Client&gt; lTransFull</span></span></span><span class="hljs-function">)</span></span> { List&lt;Client&gt; lTransFullA2; <span class="hljs-comment"><span class="hljs-comment">//         lTransFullA2 = lTransFull.OrderBy(a =&gt; a.getName()) .ThenBy(a =&gt; a.getMcc()) .ThenBy(a =&gt; a.getYear()) .ThenBy(a =&gt; a.getPeriod()).ToList(); int name = 0; int month = 0; int year = 0; int mcc = 0; int i = 0; foreach (var l in lTransFullA2) { name = l.getName(); mcc = l.getMcc(); year = l.getYear(); month = l.getPeriod(); //   if (i &gt; 0 &amp;&amp; name == lTransFullA2[i - 1].getName() &amp;&amp; mcc == lTransFullA2[i - 1].getMcc() &amp;&amp; year == lTransFullA2[i - 1].getYear() &amp;&amp; month == lTransFullA2[i - 1].getPeriod() + 1) { l.setAmount1(lTransFullA2[i - 1].getAmount()); } //   if (i &gt; 1 &amp;&amp; name == lTransFullA2[i - 2].getName() &amp;&amp; mcc == lTransFullA2[i - 2].getMcc() &amp;&amp; year == lTransFullA2[i - 2].getYear() &amp;&amp; month == lTransFullA2[i - 2].getPeriod() + 2) { l.setAmount2(lTransFullA2[i - 2].getAmount()); } i++; } return lTransFullA2; }</span></span></code> </pre> <br>  Next, filling in the hashing trick array and preparing the data in a format understandable model and the actual calculation <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n_features = <span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    Extreme.Mathematics.LinearAlgebra.SparseVector&lt;double&gt; v = Vector.CreateSparse&lt;double&gt;(lTransFullA2.Count); //   (hash +   ) md = Matrix.Create&lt;double&gt;(lTransFullA2.Count, n_features + 2); //  Hashing trick Parallel.For(0, lTransFullA2.Count(), i =&gt; hashing_vectorizer(lTransFullA2[i], i, n_features)); for (int i = 0; i &lt; lTransFullA2.Count; i++) { md[i, n_features] = lTransFullA2[i].getAmount1(); md[i, n_features + 1] = lTransFullA2[i].getAmount2(); v.AddAt(i, lTransFullA2[i].getAmount()); } lTransFullA2 = null; GC.Collect(2, GCCollectionMode.Forced); var model = new LinearRegressionModel(v, md); //   model.MaxDegreeOfParallelism = 8; model.Compute(); //  Console.WriteLine(model.Summarize()); //    GC.Collect(2, GCCollectionMode.Forced);</span></span></code> </pre><br>  And finally, the implementation of Hashing trick: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hashing_vectorizer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Client f, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] x = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[n]; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s = f.getYear().ToString(); <span class="hljs-comment"><span class="hljs-comment">// int idx = getIndx(s, n); x[idx] += calcBit(s); md[i,idx] = x[idx]; s = f.getPeriod().ToString(); idx = getIndx(s, n); x[idx] += calcBit(s); md[i, idx] = x[idx]; s = f.getName().ToString(); idx = getIndx(s, n); x[idx] += calcBit(s); md[i, idx] = x[idx]; s = f.getMcc().ToString(); idx = getIndx(s, n); x[idx] += calcBit(s); md[i, idx] = x[idx]; } //     public static int calcBit(string s) { byte b = 0; b = Convert.ToByte(s[0]); for (int i = 1; i &lt; s.Count(); i++) b ^= Convert.ToByte(s[0]); bool result = true; while (b &gt;= 1) { result ^= (b &amp; 0x01) != 0; b = Convert.ToByte(b &gt;&gt; 1); } if (result) return -1; else return 1; } public static int getIndx(string str, int n) { Encoding encoding = new UTF8Encoding(); byte[] input = encoding.GetBytes(str); uint h = MurMurHash3.Hash(input); return Convert.ToInt32(h % n); }</span></span></code> </pre> <br>  The results of the programs are almost identical (RMSLE about 1.6).  Here's what it looks like: <br><br><img src="https://habrastorage.org/files/af9/dfb/ea2/af9dfbea26724ee3ac9428fd7156746e.png"><br><br>  Now we come to the most interesting - the test results.  All tests were run on i7-2600 (8 threads, but most of the time it worked 1-2).  RAM 12 GB, OS Win7. <br><br>  To determine the dependence of the execution time on the data volume, the calculations were run on 1.7, 3.4, 5.1, and 6.8 million source records (the contents of the file transactions.csv).  But since during the preparation of the data, filtering occurred for 11-14 months, the graph shows the amount of data already after filtering. <br><br><img src="https://habrastorage.org/files/bc9/983/147/bc9983147fff40a9a7682bba0400a729.png"><br><br>  As you can see, the C # version is approximately 2 times faster.  A similar situation with memory consumption.  It does not take into account the memory occupied by Visual Studio (C # was launched in debug mode) and the browser (localhost: 8888).  For the evaluation, a peak value was taken: <br><br><img src="https://habrastorage.org/files/3f3/95a/906/3f395a906c2d4b1aa704b6f9f0b5ae88.png"><br><br>  With a further increase in the sample, JN was already starting to use the paging file, with the result that everything slowed down dramatically. <br><br>  Thus, we see that using C # allows you to process a larger amount of data much faster than JN, since the RAM is a hard limiter here. <br><br>  On the other hand, the matplotlib visualization tools allow you to analyze the data almost on the fly, and you need to write much more C # code.  Therefore, in case of insufficient memory / speed, the best option is to use the JN stack for debugging a model on a limited sample and the final implementation is already in C #. </div><p>Source: <a href="https://habr.com/ru/post/318484/">https://habr.com/ru/post/318484/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318474/index.html">Framework for working with Telegraph API</a></li>
<li><a href="../318476/index.html">Shielded VM Technology in Windows Server 2016</a></li>
<li><a href="../318478/index.html">Microsoft‚Äôs .NET open source translation brought tangible benefits</a></li>
<li><a href="../318480/index.html">ASP.NET Core, Angular 2, SignalR for Dummies</a></li>
<li><a href="../318482/index.html">Developing an Android widget to display a bitcoin course</a></li>
<li><a href="../318486/index.html">The operating temperature range of the Raspberry Pi. Test results</a></li>
<li><a href="../318488/index.html">How IT professionals celebrate New Year (survey infographic)</a></li>
<li><a href="../318494/index.html">Uninitialized variables: look for errors</a></li>
<li><a href="../318496/index.html">Simple framework UI ERP with Vaadin</a></li>
<li><a href="../318498/index.html">Liveedu.tv - streaming service for programmers and designers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>