<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Strike ddos ‚Äã‚Äãbotnet in the home</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear habrosoobschestvu, at the request of habrovchan decided to share some of their best practices in the fight against ddos ‚Äã‚Äãon the basis ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Strike ddos ‚Äã‚Äãbotnet in the home</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/98c69f4e/f5d61135/04f45973/e0d49a48.png"><br><br>  Good day, dear habrosoobschestvu, at the request of habrovchan decided to share some of their best practices in the fight against ddos ‚Äã‚Äãon the basis of personal practical experience of repelling attacks. <br>  This article will not be another new way to protect yourself from ddos ‚Äã‚Äãon your own, there is plenty of information on this.  We will go a little on the other side. <br>  As they say the best defense is attack.  So we will be with you to strike at the most painful place of ddosers - at bots.  An additional nice bonus for us is that we will do a good deed and free at least some of the infected machines from the captivity of the evil botnetchik. <br>  It is clear that we can‚Äôt kill the botnet, but sometimes it is possible to inflict quite substantial blow, especially if the main part of the botnet is Dedik with rootkits, which sometimes create the main problem in repelling the attack.  Well, a kulhatskeru vase with his hundred blood and then extracted bots can also be very bad for mischief.  For bots, especially on good channels and from good regions, cost money and sometimes considerable ones.  If they start to breathe from the abuses that have fallen down, it may be unprofitable for ddosers to continue to do you and they can raise the price for the customer or even stop the attack altogether.  It is much easier to do that from whom there will be no excess noise. <br><br><a name="habracut"></a><br><h4>  How to kill a bot? </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, how can we kill a bot, or at least try to free its soul from the evil forces that have settled? <br><br>  <b>For this you need:</b> <br><br>  one).  Determine the ip address of the attacking bots <br>  2).  Determine who owns these IP addresses (parent organization: DC, provider, institution ...), from whois get a list of contact abuse email, which we will send complaints <br>  3).  Prepare logs confirming the fact of the attack. <br>  four).  Send log email abuse lists <br><br>  If there are few bots, you can of course do all this with your hands, but we will automate this process. <br><br><h4>  Ddos is different </h4><br>  We remember that DDoS can be different and there are no universal ways to determine malicious addresses, in each case there will be a different algorithm and other sources. <br><br>  In general, this is a topic for a separate article, but I will try to choose an easy and accessible way for everyone to understand. <br>  So, let's say we have TCP / UDP flood on different ports, some methods restrict ddos, access to the machine is there, but we want to reduce the attack power and prevent it from increasing, well, or just foul up ddoseram. <br>  The task is to inflict a counterstrike, to deprive the botnet of the most active bots. <br><br><h4>  We collect logs </h4><br>  There are many options, again a topic for a separate article.  There are many different ways to log traffic, for example, tcpdump, iptrtaf, netflow ... <br>  I somehow historically had most of the logs taken off using iptraf, which was used to monitor the attack, and all the scripts were configured to parse them.  The solution may not be the most beautiful, but quite universal.  With the most minimal modification, you can use any logs and perform all the following manipulations in real time. <br><br>  So, the ddos ‚Äã‚Äãstarted, we launch iptraf, in the settings (Configure) we enable logging (Logging), now when we start the IP traffic monitor, it will ask which file to save the log for, for example <br>  /var/log/iptraf/iptraf.log <br>  Now iptraf for us will record basic information about each package (including the one dropped). <br>  By personal observation, the server will not get worse from this; this logging almost does not waste any useful server resources. <br><br><h4>  Send abuses </h4><br>  When there is a log, we can proceed with its processing and sending letters of happiness to providers of infected machines, so that they understand the owners. <br>  For this I propose several self-written scripts intended for this. <br>  The scripts were written in a very difficult time, so there was no talk about beauty and optimization, now I have modified them a little, have spiced them up with comments. <br>  Specially broke all the work into several modules, each of which is responsible for its task.  This will allow to adapt them to your case and control each step. <br><br><h4>  Scripts </h4><br>  All scripts can be downloaded here: <a href="https://github.com/Ajex/AntiDdosAbuse">github.com/Ajex/AntiDdosAbuse</a> <br><br>  <b>Below I will describe each.</b> <br><br>  one).  <b>show_ips.sh</b> - displays a list of ip addresses from the log and the number of packets that passed during the collection interval. <br><br>  <b>Launch parameters:</b> <br><pre><code class="bash hljs">./show_ips.sh iptraf.log <span class="hljs-string"><span class="hljs-string">"Dec 12"</span></span> &gt; ddos_ips.txt</code> </pre> <br>  After this, the script will parse the file using the <b>iptraf.log</b> file and the filter ‚ÄúDec 12‚Äù as the source log, and output the result to the <b>ddos_ips.txt</b> file for further analysis by other scripts. <br><br>  * You can apply any of your filters, choosing data for example for a specific hour. <br><br>  <b>Its output will be the following:</b> <br><br><pre> <code class="html hljs xml"> 3 1.1.1.1. 3 1.1.1.2. 3 1.1.2.1. 10 2.3.2.2. 10 2.3.2.2. .... 7833 xxxx 19343 yyyy 58234 zzzz</code> </pre><br><br>  Given that this log will be made at the time of the attack, there will be a very strong gap between the smallest and largest values.  Sometimes thousands and tens of thousands of times.  Here, again, there are no universal algorithms on what grounds to consider traffic anomalous, you need to look and think with your head. <br>  But as a rule, the file will be very clearly visible, because a normal user cannot send several tens of thousands of requests in a few minutes. <br>  Based on this log, we define the border from which to consider aypishniki bots.  You can additionally carry out a manual check of some addresses from the tops using the apache / nginx logs and the ipraf log. <br>  For example, the bot was bursting over UDP, and you only had a webserver or TCP gobbled up on some kind of left ports that you have tightly closed. <br>  It is very important to include the head at this step, for I repeat, there are no universal methods, it all depends on what server is under attack, what services are running, what load. <br>  You can modify the script and, together with the number, display, for example, another region of the address and count the number of closed ports on which the bot was breaking, add information from the web server logs ... <br>  There is a whole field for mental activity that goes beyond the scope of this article. <br><br>  2).  <b>get_info.sh</b> - extracts the abuse of email from whois information for each IP address received by the show_ips.sh script in step 1. <br>  <b>Launch parameters:</b> <br><pre> <code class="bash hljs">./get_info.sh ddos_ips.txt &gt; abuse_email.txt</code> </pre> <br>  where, <b>ddos_ips.txt</b> is the file created in step 1 <br>  After that, <b>abuse_email.txt</b> will contain a list of email addresses to send emails. <br><br>  <b>Its output will be the following:</b> <br><br><pre> <code class="html hljs xml">xxxx abuse@aaa.com master@aaa.com yyyy abuse@bbb.com zzzz abuse@ccc.com ....</code> </pre><br><br>  <i>It is important that the script has the configuration parameter <b>th_limit</b> , it means from how many connections it is considered to be a bot, this boundary is determined at the previous step.</i> <br><br>  3).  <b>get_logs.sh</b> - the script extracts information for each specific ip address from the iptraf log, saves it in a separate file and packs it into Gzip <br><br>  <b>Launch parameters:</b> <br><br><pre> <code class="bash hljs">./get_logs.sh ddos_ips.txt iptraf.log <span class="hljs-string"><span class="hljs-string">"Nov 20"</span></span> pref</code> </pre> <br>  where, <b>pref</b> prefix created logs for easy sorting <br><br>  It is necessary to specify th_limit in the parameters, this is again the number of connections from the ddos_ips.txt file separating good ip addresses from bots. <br>  At the output in the current folder will be created Gzip files containing logs for each individual Ip. <br><br>  four).  <b>mail_send.sh</b> - script sending out letters to the lists obtained from step 2. <b>using get_info.sh</b> script <br><br>  <b>Launch parameters:</b> <br><br><pre> <code class="bash hljs">./mail_send.sh abuse_email.txt pref</code> </pre> <br><br>  where the abuse_email.txt file obtained in step 2 <br><br>  Inside the script is the title and body of the letter, which you customize to fit your needs.  You can scare all sorts of heavenly punishments and threats to go to the police, etc., for some it even acts. <br><br> <code><a href="http://yourcompany.com/abuse/"></a> echo "Hi, today, our server xxxx was attacked from your or your c$ip <br> Here are the logs yourcompany.com/abuse$pref$ip.txt.gz (TZ - Europe/Moscow) ... bla bla bla ... The Company Name Ltd." | mail -s "[Abuse] ddos attack from your $ip" $email_row</code> <br>  <i>(I don‚Äôt specifically give my text so that they do not send it according to a template and do not fall into the spam filter)</i> <i><br></i> <br>  In the script, in the sending template, there is a link to the file with logs.  I tried to attach files directly to the letter, but, firstly, they are often voluminous, and secondly, they are often cut by spam filters and are suspicious, in the third it is sometimes difficult to send them from a machine under DDoS, and the link to the corporate site looks more weighty and safer. <br>  Therefore, I simply copied the logs to another machine with a raised web server using a simple script, and in the body of the letter I simply indicated a link to the log. <br><br>  <b>do_all.sh</b> - this script performs all actions consistently, but more has been done to demonstrate, because before running it, you need to tune the script parameters, especially <b>th_limit</b> for your own case <br><br>  <b>Here are its parameters:</b> <br><br>  <b>parse_date</b> - Grep log will be made by this expression, if you need to select records for a certain number or hour <br>  <b>pref</b> - prefix for created files, for example, the same date <br>  <b>iptraf_raw_file</b> - where to get the iptrafa log <br><br>  It is clear that it was possible to make scripts through streams, but for an article and an understanding of the work did as it is, the scope for fantasy is endless.  You can modify and automate all processes, for example, automatically enable logging after the start of an attack, make a more accurate analyzer for step 1. <br><br>  If you act wisely, you can inflict a sufficiently significant blow to the botnet, especially if the number of bots is small, but they mostly consist of dedik on rootkits.  I say this from personal experience. <br><br><h4>  And what is the result?  Does it really work? </h4><br>  What happens to the resulting abuse?  Perhaps, of course, it will be ignored, but, for example, the next day, the IP address will again fall into the black list and again an abusa will leave, etc., perhaps sometime they will react. <br>  If an un is some kind of a VPS / VDS server and the abusa falls for example into a DC with detailed logs, it is normally framed, then it will most likely be studied, and if the logs are very compelling and converge with DC statistics, then there may be a block.  It's about 50/50, which is generally not bad either. <br>  If this comes to the provider, he will most likely notify the subscriber (he communicated with some friends, they said they would do just that), and if there are several complaints, and again they are reasoned, they may be blocked until the client installs a normal anti-virus. <br><br>  After our mailing around the world, there will be a whole chain of events that we may never know about, and they may not have a decisive impact, but in any case it‚Äôs better than not to do anything and hope that tomorrow there will be someone else and not you. <br>  If such actions will produce the majority and abuses will be strewed from different IPs, the providers will have to take measures, each such abuser is a nail in the coffin of the botnet. <br><br>  Thank you for your attention, this is my first article on Habr√©, please do not strongly scold if something goes wrong.  If the subject matter is of interest, I‚Äôll share my practical experience, as I don‚Äôt have serious resources, having 3 rubles in my bosom can withstand strong enough attacks.  Sometimes cunning and ingenuity can give more than a powerful iron or a wide channel. <br><br>  UPD: By the way, there are times when the method described in the article can be a real salvation from ddos.  For example, if the entire width of the port is overwhelmed with a relatively small number of bots on wide channels or the network does not cope with the flow of requests.  In this case, either the unit on the side of the upstream router will help, which is very often not possible in many DCs, or wrestling with abuz.  The latter, apart from its simplicity and accessibility, makes it possible to foul up and disarm them so well. </div><p>Source: <a href="https://habr.com/ru/post/134359/">https://habr.com/ru/post/134359/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134352/index.html">Using Octave to calculate the center of rotation of a star field</a></li>
<li><a href="../134353/index.html">Samsung NC215 Green Netbook Review</a></li>
<li><a href="../134354/index.html">7app chart # 6</a></li>
<li><a href="../134357/index.html">tma (Part 3) Why you can't automate financial accounting</a></li>
<li><a href="../134358/index.html">Imposing MT Subscriptions</a></li>
<li><a href="../134363/index.html">Google Schemer</a></li>
<li><a href="../134364/index.html">ASUS ZENBOOK UX31E Review (Version 2.0)</a></li>
<li><a href="../134365/index.html">Jobs in new projects - we need you tomorrow!</a></li>
<li><a href="../134367/index.html">Star Wars through the prism of infographics</a></li>
<li><a href="../134368/index.html">Scheduled message service</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>