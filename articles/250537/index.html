<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PIC16F1503. Wheelbarrow for pumping - 3. Power</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It used to be about sound and light . 

 Finally, there is nowhere else to retreat and the time has come to assemble the machine into something whole ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PIC16F1503. Wheelbarrow for pumping - 3. Power</h1><div class="post__text post__text-html js-mediator-article">  It used to be about <a href="http://habrahabr.ru/post/250123/">sound</a> and <a href="http://habrahabr.ru/post/250229/">light</a> . <br><br>  Finally, there is nowhere else to retreat and the time has come to assemble the machine into something whole and almost indivisible.  There was only one tiny question: how will this machine turn on and off?  And what about the tradition to continue in the next post the topic of the previous one? <br><br><img src="https://habrastorage.org/files/d11/3a2/be4/d113a2be49fd4cf2a1b2fa9dec2b0f21.jpg">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order not to violate the tradition, I will continue the topic from the previous post: blinking LEDs.  What is wrong with them? <br><br><a name="habracut"></a><br>  Not so much with them, starting from the curve of the delay time and ending with a terrible timer interrupt handler. <br><br>  First you need to make a normal delay function.  We put TMR1 for a period of 1ms and add to the code <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> millis=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DelayMS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> m)</span></span></span><span class="hljs-function"> </span></span>{ millis=<span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(millis&lt;m); } ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TMR1_ISR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ millis++; ...</code> </pre> <br>  In this simple way, we will get the delay function (no matter what the timer ticked), which does not depend on the frequency / presence of another code, up to 65 seconds.  Enough for our purposes with a large margin. <br><br>  Now look at the ignition code of the LEDs.  Somehow it is ugly to interrupt to do delays (and even a cycle), plus a bunch of comparisons that you should take away in a good way somewhere.  No, it‚Äôs quite a home project, but no good for an industrial project. <br><br>  Let's change the algorithm again.  What is the point?  Consider the example of the port C, which is entirely given under the LEDs. <br><br>  The younger 3 bits are responsible for the colors.  Older 3 - for the first 3 LEDs.  Mentally turn on the first LED to red, the second to green, and the third to "orange" (or red + green).  What will be in port? <br><br>  The first step, the "red" channel <br>  0b00101001 <br>  The second step, the "green" channel <br>  0b00110010 <br>  The third step, the "blue" channel <br>  0b00000100 <br><br>  As we see, in principle, it is enough for us to send to the port one by one over and over again in order to get the same functionality.  And the formation of these bytes will be given to the setLed function - it is called much less frequently than the code in the interrupt and can afford all sorts of calculations, cycles and other excesses. <br><br>  It‚Äôs good that we know that we can shove anything into port C - it has 2 high-order bits that are not connected anywhere (judging by the datasheet and code).  But what to do with port A, in which we need to change only one bit, without touching the rest?  To do this, you can use the remarkable function "bit AND" and "bit OR." <br><br>  To make it clearer, I'll sign an example: <br><br>  0b00 <b>0</b> 01010 We read the current value from the port.  I selected the bit we need - we only need to change its value.  The rest is randomly placed. <br><br>  We do a ‚Äúbitwise OR‚Äù (somewhere there should be 1, so that the result would also be 1) with the mask set in advance by the setLed function.  To enable a bit, it must be 0b00 <b>1</b> 00000. Let's say we need to turn on the bit <br><br>  0b00 <b>0</b> 01010 |  0b00 <b>1</b> 0000 = 0b00 <b>1</b> 01010 <br><br>  Everything, the necessary bit is set, the rest are untouched, so that we can write the resulting value back to the port. <br><br>  And now the same bit will be reset with the help of ‚Äúbit-AND‚Äù (and there and there should be 1, so that the output is also 1) <br><br>  0b00101010 &amp; 0b11011111 = 0b00 <b>0</b> 01010 <br><br>  It seems everything is logical.  Rewrite the code. <br><br>  In general, the setLed function is assigned to prepare 6 bytes of what we will send to the port.  Change led.c and led.h <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// basic colors #define RED 1 #define GREEN 2 #define BLUE 3 #define OFF 0 extern volatile uint8_t lc[3]; extern volatile uint8_t la[3]; void setLed(uint8_t n,uint8_t c) { uint8_t b; if(n==0) b=0b11110111; if(n==1) b=0b11101111; if(n==2) b=0b11011111; if(c&gt;0) { c--; if(n==3) { la[0]=1; la[1]=1; la[2]=1; la[c]=0; } else { lc[c]=lc[c]&amp;b; } } else { // turn off channel N b=b^0xff; if(n==3) { la[0]=1; la[1]=1; la[2]=1; } else { lc[0]=lc[0]|b; lc[1]=lc[1]|b; lc[2]=lc[2]|b; } }</span></span></code> </pre><br>  And in the interrupt handler we register <br><br><pre> <code class="cpp hljs">LATC=lc[current_led]; _LED4_ = la[current_led]; current_led++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(current_led==<span class="hljs-number"><span class="hljs-number">3</span></span>) current_led=<span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre><br><br>  Agree, much shorter than the previous version (although I left working with bits for port C, and port A turned out to be easier to pull by hand).  If shorter, it means that it runs faster.  And if it runs faster, then the overall performance of the controller is also higher.  Solid bonus from all sides.  True, to get "white" now you have to call setLed three times, but these are trifles. <br><br>  Now it remains to solve the most important question: how to turn it on and how to turn it off? <br><br>  In principle, I have the option proposed by the original creators of the typewriter - a button on the door.  But before you engage in applied art, you need to estimate "is it worth it"? <br><br>  We write the following code <br><br><pre> <code class="cpp hljs">setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>, RED); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>, BLUE); PWM3_LoadDutyValue(<span class="hljs-number"><span class="hljs-number">49</span></span>*<span class="hljs-number"><span class="hljs-number">2</span></span>); TMR2_LoadPeriodRegister(<span class="hljs-number"><span class="hljs-number">49</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> c,q; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(q=<span class="hljs-number"><span class="hljs-number">0</span></span>;q&lt;<span class="hljs-number"><span class="hljs-number">1</span></span>;q++) { setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, RED); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, OFF); DelayMS(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = <span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; c++) { setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, OFF); DelayMS(<span class="hljs-number"><span class="hljs-number">50</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, RED); DelayMS(<span class="hljs-number"><span class="hljs-number">50</span></span>); } setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, BLUE); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, OFF); DelayMS(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c = <span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; c++) { setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, OFF); DelayMS(<span class="hljs-number"><span class="hljs-number">50</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, BLUE); DelayMS(<span class="hljs-number"><span class="hljs-number">50</span></span>); } } PWM3_LoadDutyValue(<span class="hljs-number"><span class="hljs-number">0</span></span>); TMR2_LoadPeriodRegister(<span class="hljs-number"><span class="hljs-number">0</span></span>); setLed(<span class="hljs-number"><span class="hljs-number">0</span></span>, OFF); setLed(<span class="hljs-number"><span class="hljs-number">1</span></span>, OFF); setLed(<span class="hljs-number"><span class="hljs-number">2</span></span>, OFF); setLed(<span class="hljs-number"><span class="hljs-number">3</span></span>, OFF); DelayMS(<span class="hljs-number"><span class="hljs-number">10</span></span>); SLEEP();</code> </pre><br>  Pay attention to the last instruction - SLEEP () pushes the microcontroller into hibernation, when everything is off and only some interruption can get out of this state.  Interrupts have not yet been delivered to us, so I simply turn it on and off manually when measuring. <br><br>  Connect a multimeter to measure current consumption.  My bet is that when the LEDs are lit and the speaker is whining, then the current consumption is 2.97-3 mA.  If you do not pick the speaker, then 2.85-2.9.  And when everything ends, then 0.01mA and less (just my multimeter 0.01mA has a lower measurement limit).  The difference between the clock frequency of 1 MHz and 4 MHz is also minimal - literally 0.2 mA. <br><br>  Agree, smart numbers for 12 flashing LEDs?  If we connected them ‚Äúas usual‚Äù, we would get a current of 30-40mA. <br><br>  Since I will have 2 AAA batteries (their average capacity is 1000 mAh), it is easy to estimate how long the machine will live. <br><br>  If all the time will squeak and blink - 1000mAh / 3mA / 24h = 13 days. <br>  And if you sleep all the time - 1000 / 0.1 / 24 = 416 days. <br><br>  It is clear, in reality, the numbers will be less, since not a single battery will allow itself to be discharged "to zero."  But even so - a year in hibernation for cars is very good.  In general, there is no need for a separate switch and therefore I decide to use the already prepared blank for the button.  I connect the button between RA4 and the ‚Äúminus‚Äù, in the Code Configurator we enable this leg for reading and do not forget to turn on the pull-up resistor and generate interrupts for this leg. <br><br>  For some reason, we forgot to add code in the Code Configurator to enable interrupts (although the checkboxes are set) and because of this I have to open the datasheet on the processor and look for which bits are responsible for what (actually this is a very useful activity).  We enable the resolution of interrupts from the periphery and allow the ones connected to port A4 to generate them. <br><br><pre> <code class="cpp hljs">INTCONbits.IOCIE =<span class="hljs-number"><span class="hljs-number">1</span></span>; IOCANbits.IOCAN4 =<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br><br>  And check again.  As a result, when we press the button, everything wakes up, blinks and falls asleep a couple of times. <br><br>  There is already a beautiful flasher (code above), and with the siren frequencies they helped me in the comments.  <i>Ambulance siren: triangular frequency-modulated signal, with time-varying generation frequency from 850 Hz to 1550 Hz.</i>  <i>with a speed of 0.2 hertz.</i>  <i>Militia siren from 650 Hz.</i>  <i>up to 1350 Hz.</i>  And do not ask me how speed can be measured in hertz :) But the sound is very similar. <br><br>  Now it remains to collect all the accumulated (sound, flashers, sleep) into one piece of code.  In the best traditions of tutorials, I will leave it to you. <br><br>  <i>Almost</i> ready, you can take as usual, I have <a href="">multik.org/pic/policecar.rar</a> </div><p>Source: <a href="https://habr.com/ru/post/250537/">https://habr.com/ru/post/250537/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250525/index.html">Another plugin manager for Vim</a></li>
<li><a href="../250527/index.html">Basic statistics: just about complex formulas</a></li>
<li><a href="../250529/index.html">Mobile App Distribution Services for iOS. Part 2: HockeyApp</a></li>
<li><a href="../250531/index.html">Antivirus, Android and x86. Interaction features</a></li>
<li><a href="../250535/index.html">Annual Review: What's new for eBay?</a></li>
<li><a href="../250539/index.html">Making an online cinema for the blind (WCAG 2.0 AAA)</a></li>
<li><a href="../250541/index.html">Wiring diagrams with LaTeX and TikZ</a></li>
<li><a href="../250545/index.html">Intel¬Æ Graphics Technology. Part II: ‚Äúunload‚Äù calculations on graphics</a></li>
<li><a href="../250549/index.html">The boot server - as a bootable USB flash drive, only the server and the network</a></li>
<li><a href="../250551/index.html">Overview of the site for testing web vulnerabilities OWASP Top-10 for example bWAPP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>