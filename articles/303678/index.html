<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zend loop traversal macros (HashTable Iteration)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuing my superficial study of the PHP source code (7.0.7) and writing the simplest extension to it, I would like to go a little deeper this time ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zend loop traversal macros (HashTable Iteration)</h1><div class="post__text post__text-html js-mediator-article">  Continuing my superficial study of the PHP source code (7.0.7) and <a href="https://habrahabr.ru/post/303572/">writing the simplest extension</a> to it, I would like to go a little deeper this time and describe techniques for traversing the array through the accepted function argument, which I learned while implementing the simple PHP function median ().  The task of this function is simple - to return the arithmetic mean value.  It is possible this publication will be useful to other PHP developers, just like me, who decided in my spare time to study the architecture of my favorite language, which makes money.  In a previous post, I was quick to describe how to quickly create an extension in PHP with implementations of the factorial calculation function.  It is simple to the extent that it takes a simple integer parameter and then recursively called.  The implementation of the median () function is complicated by the fact that the received parameter is an array, you need to walk through it to sum up the total value, and also to calculate the total number of elements in the array. <br><a name="habracut"></a><br>  At the moment I have simplified the task also by the fact that I think that all the adopted elements of the array are numbers.  The source code for PHP extensions is amazing because here ‚Äúeverything is written‚Äù through the use of macros.  At the very least, this initial opinion is created.  It turns out that macros are also used to traverse the list of elements in the array.  For clarity, I will cite immediately the function code followed by a short description. <br><br>  The function is described in the same file - mathstat.c of the mathstat extension.  <a href="https://github.com/eugenekurilov/mathstat">Link</a> to github. <br><br>  Listing mathstat extension features: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> zend_function_entry mathstat_functions[] = { PHP_FE(confirm_mathstat_compiled, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-comment"><span class="hljs-comment">/* For testing, remove later. */</span></span> PHP_FE(ms_factorial, arginfo_ms_factorial) PHP_FE(ms_median, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) PHP_FE_END <span class="hljs-comment"><span class="hljs-comment">/* Must be the last line in mathstat_functions[] */</span></span> };</code> </pre> <br><br>  The definition of the function body itself: <br><br><pre> <code class="cpp hljs">PHP_FUNCTION(ms_median) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> argc = ZEND_NUM_ARGS(); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> total = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = <span class="hljs-number"><span class="hljs-number">0</span></span>; zval *<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>, *value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_parse_parameters(argc, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, &amp;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>) == FAILURE) { RETURN_DOUBLE(<span class="hljs-number"><span class="hljs-number">0</span></span>); } ZEND_HASH_FOREACH_VAL(Z_ARRVAL_P(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>), value) { total = total + zval_get_double (value); count += <span class="hljs-number"><span class="hljs-number">1</span></span>; } ZEND_HASH_FOREACH_END(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count == <span class="hljs-number"><span class="hljs-number">0</span></span> || total == <span class="hljs-number"><span class="hljs-number">0</span></span>) { RETURN_DOUBLE(<span class="hljs-number"><span class="hljs-number">0</span></span>); } RETURN_DOUBLE(total/count); }</code> </pre><br><br>  If you look at the body of the function, then, just like last time, the function of checking the parameter is called, where you set the value ‚Äúa‚Äù (array) as the template of the type of argument being received <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_parse_parameters(argc, <span class="hljs-string"><span class="hljs-string">"a"</span></span>, &amp;<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>) == FAILURE) { RETURN_DOUBLE(number); }</code> </pre><br><br>  Now the most interesting thing is that the loop is implemented through the macro ZEND_HASH_FOREACH_VAL.  I found 7 macros in total which pass through the array in the references.  At the same time, the term HashTable is used instead of an array everywhere.  For our case, I chose the simplest macro.  The first argument is the received array itself via the function, and the second argument is zval (the basic data structure that stores the value and data type for itself is the <a href="https://www.youtube.com/watch%3Fv%3D6yYBr09BbqI">video</a> for this part of Dmitry Stogov).  In this case, I simply call the zval_get_double function, which, roughly speaking, returns the value from the array itself.  If you rewrite it into plain PHP code, you get: <br><br><pre> <code class="php hljs"> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> $array = [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> $number = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">5</span></span> $count = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($array <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $val) { <span class="hljs-number"><span class="hljs-number">8</span></span> $number += $val; <span class="hljs-number"><span class="hljs-number">9</span></span> $count += <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-number"><span class="hljs-number">10</span></span> } <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"cnt: "</span></span>.$count.<span class="hljs-string"><span class="hljs-string">" total: "</span></span>.$number.<span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br>  That is, in fact, nothing complicated, the same record, only using a macro.  If you look at another more advanced macro, <br><br><pre> <code class="cpp hljs">ZEND_HASH_FOREACH_STR_KEY_VAL(ht, key, val)</code> </pre><br><br>  then without the code it is already clear that this is an analog of the php cycle: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($array <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { }</code> </pre><br><br>  For clarity, I will cite all macros from the reference book: <br><br><pre> <code class="bash hljs">ZEND_HASH_FOREACH_VAL(ht, val) ZEND_HASH_FOREACH_KEY(ht, h, key) ZEND_HASH_FOREACH_PTR(ht, ptr) ZEND_HASH_FOREACH_NUM_KEY(ht, h) ZEND_HASH_FOREACH_STR_KEY(ht, key) ZEND_HASH_FOREACH_STR_KEY_VAL(ht, key, val) ZEND_HASH_FOREACH_KEY_VAL(ht, h, key, val)</code> </pre><br><br>  That's all.  Thanks for taking the time and losing money on mobile traffic. </div><p>Source: <a href="https://habr.com/ru/post/303678/">https://habr.com/ru/post/303678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303668/index.html">Solving common business problems: there are no magic recipes</a></li>
<li><a href="../303670/index.html">How to make Intel Edison and Galileo iBeacon-beacons</a></li>
<li><a href="../303672/index.html">From the communication tool of scientists to the world standard: A brief history of e-mail</a></li>
<li><a href="../303674/index.html">The book ‚ÄúSwift 2.2. Basics of developing applications for iOS and OS X ¬ª</a></li>
<li><a href="../303676/index.html">Servers in the Netherlands with 1 Gbit / s and 100TB traffic from $ 58.25 / month + bonus for readers habrahabr 1-3 months for free</a></li>
<li><a href="../303680/index.html">‚Äú12 hours, 10 interviewers‚Äù: How to get a job in finance on the example of an interview at Goldman Sachs</a></li>
<li><a href="../303682/index.html">How I downloaded Comdi online broadcast (Startup village)</a></li>
<li><a href="../303684/index.html">Profiling in R</a></li>
<li><a href="../303686/index.html">Dirty Mobile Development Tricks from J2ME to Android</a></li>
<li><a href="../303688/index.html">Lecture 3 out of 10. Work Growth Team (Growth Team)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>