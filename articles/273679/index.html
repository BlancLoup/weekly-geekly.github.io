<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Networks for the smallest. Part eleven. MPLS L3VPN</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Last time we left no stone unturned when parsing MPLS. And this is probably good. 

 But so far, only real-life application of it is drawn. And that's...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Networks for the smallest. Part eleven. MPLS L3VPN</h1><div class="post__text post__text-html js-mediator-article">  Last time we left no stone unturned when parsing MPLS.  And this is probably good. <br><br>  But so far, only real-life application of it is drawn.  And that's bad. <br><br>  This article will begin to correct the situation.  In general, the reader is waiting for a series of three articles: L3VPN, L2VPN, Traffic Engineering, where we will try to fully tell why MPLS is needed in practice. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, linkmeup is no longer an outsourcing of support for a large but single company, we are a provider.  You can even say the federal provider, because our optics leads to all parts of the country.  And our numerous clients want not only high-speed Internet access, they want VPN. <br>  Today we will understand what will have to be done on our network (on which MPLS is already set up in the meantime) in order to satisfy these rampant appetites. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ba/212/bf9/7ba212bf9a6fcdc4ce1a3c444d5371b0.jpg" title="SDSM11-L3VPN" alt="SDSM11-L3VPN"><br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Issue content</b> <div class="spoiler_text"><ul><li>  <a href="https://habr.com/ru/post/273679/">VRF, VPN Instance, Routing Instance</a> </li><li>  &gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">VRF-Lite</a> </li><li>  <a href="https://habr.com/ru/post/273679/">MPLS L3VPN</a> </li><li>  &gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Data Plane or transfer of user data</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">The Role of MPLS Tags</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Transport Tag</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Service Tag</a> </li><li>  &gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Terminology</a> </li><li>  &gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Control Plane or transfer of service (routing) information</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Routing Protocols</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">MBGP</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Route Distinguisher</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">Route Target</a> </li><li>  <a href="https://habr.com/ru/post/273679/">Practice</a> </li><li>  &gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">VRF-Lite</a> </li><li>  &gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">MPLS L3VPN</a> </li><li>  &gt;&gt;&gt;&gt;&gt;&gt; <a href="https://habr.com/ru/post/273679/">VPN Interaction</a> </li><li>  <a href="https://habr.com/ru/post/273679/">Tracing MPLS L3VPN</a> </li><li>  <a href="https://habr.com/ru/post/273679/">Q &amp; A</a> </li><li>  <a href="https://habr.com/ru/post/273679/">useful links</a> </li></ul><br></div></div><br><br>  Traditional video: <br><iframe width="560" height="315" src="https://www.youtube.com/embed/mkL6MWopUos" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  How to organize the interaction of two remote sites on the Internet?  Very simple, if they have public addresses - the IP for this was invented.  They can communicate directly.  In any case, to connect two points on the Internet, you need two public addresses - one on each side.  And if we have private addresses (10/8, 172.16 / 20, 192.168 / 16)? <br>  Then they will "pull on" on the one hand, and then "spread out" on the other.  And NAT is a thing, I tell you, oh, how nasty. <br><br>  Therefore, there is a VPN.  Virtual Private Network is a set of technologies and protocols that allows you to connect something to your private network through someone else's network, in particular, through the Internet. <br>  For example, the Tomsk branch of the company linkmeup can be connected to the head office in Moscow using VPN over the Internet, as we did in <a href="http://linkmeup.ru/blog/50.html">the VPN issue</a> . <br>  That is, you will see other branches through VPN as if they were in the next room and you are connected to them through a cord, switch or router.  Accordingly, the nodes can communicate at their private addresses, rather than publicly. <br><br>  In this case, your personal data with private addresses are packaged in packages with public addresses and how in the tunnel they fly over the Internet. <br><br>  This is called <b>client VPN</b> , because the client is concerned about its configuration and elevation.  His only agent is the Internet. <br>  We analyzed it in the 7th edition and there is a huge <a href="http://linkmeup.ru/blog/152.html">article</a> about it on the linkmeup blog by our reader, Vadim Semyonov. <br><br>  Another possible option is <b>provider VPN</b> .  In this case, the provider provides the client with several connection points, and within its network builds channels between them. <br>  The client is then only required to pay the provider this channel. <br>  Provider VPN, unlike client, allows to provide a certain quality of services.  Usually, when concluding an agreement, an <a href="http://lookmeup.linkmeup.ru/">SLA is</a> signed, where the delay level, jitter, percentage of packet loss, the maximum period of unavailability of services, etc. are specified.  And if in the client VPN you can only hope that everything is calm on the Internet now, and your data will reach in perfect order, then in the provider, you have someone to ask. <br><br>  This time we will focus on the provider VPN. <br><blockquote>  This is about Layer 3 VPN - L3VPN, when we need to route network traffic.  L2VPN is the topic of the next issue. <br></blockquote><br><br><a name="VRF"></a><br><h1>  VRF, VPN-Instance, Routing-instance </h1><br>  When it comes to VPN, the question of traffic isolation arises.  No one else should receive it, and your private addresses should not appear where they are not supposed to - that is, on the Internet, on our provider's network and on other customers' VPNs. <br>  When you set up a GRE tunnel via the Internet (or OpenVPN, to your taste), your data is automatically segregated - no one can see your private addresses on the Internet, and traffic will not fall into the wrong hands (unless you raise the issue of a targeted attack). <br>  That is, there is a tunnel between two public addresses, which is in no way connected with your provider or with other transit tunnels.  Two different VPNs ‚Äî two completely different tunnels ‚Äî and only your traffic flows through your tunnel. <br>  Quite different is the question in the provider VPN - the same backbone network must transfer data from hundreds of clients.  How to be here? <br>  No, you can, of course, and here GRE, OpenVPN, L2TP and others like them, but then all that the operating engineers will do is tune the tunnels and shovel millions of configuration lines. <br>  But the problem is deeper - the question of organizing such a universal channel for all is secondary: the main thing now is how to isolate two clients connected to the same router?  If, for example, both use a 10.0.0.0/8 network, how to prevent traffic from being routed between them? <br><br>  Here we come to the concept of <b>VRF</b> - Virtual Routing and Forwarding instance.  The terminology is not settled here: in Cisco - this is VRF, in Huawei - VPN instance, in Juniper - Routing Instance.  All names have the right to life, but the essence is the same - the virtual router.  This is something like a virtual machine in some VirtualBox - there are many virtual servers on one physical server, and here there are many virtual routers on one physical router. <br>  Each such virtual marsurcher is essentially a separate VPN.  Their routing tables, FIB, interface list and other parameters do not overlap - they are strictly individual and isolated.  Exactly the same way they are separated from the physical router itself.  But as in the case of virtual servers, communication is possible between them. <br><br>  VRF - it is strictly local to the router - there is no VRF outside of it.  Accordingly, the VRF on one router is in no way associated with the VRF on the other. <br>  <i>Since we are reviewing all the examples on Cisco equipment, we will stick to their terminology.</i> <br><br><a name="VRF-LITE"></a><br><h2>  VRF Lite </h2><br>  This is the name of creating a provider VPN without MPLS. <br>  For example, this is how you can configure VPN within the same router: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/47d/db8/c0d/47ddb8c0d99bae588b2cc4e2d23ddd43.png"><br><br>  Here we have two clients - TAR's Robotics and C3PO Electronic. <br><br>  The FE0 / 0 and FE0 / 1 interfaces belong to VPN C3PO Electronic, the FE1 / 0 and FE1 / 1 interfaces are VPN TAR's Robotics.  Inside one VPN, the nodes communicate without problems, among themselves - nothing at all. <br><br><img src="https://habrastorage.org/files/653/737/2f1/6537372f1cb54a18a00363408c99ba67.gif"><br><br>  This is how their routing tables on the provider router look like: <br><img src="https://habrastorage.org/getpro/habr/post_images/a85/fb5/d04/a85fb5d040af71e84b2ce7df8c86cef0.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/af7/df5/a84/af7df5a8465d5882ce4a928dae2f2bd6.png"><br><br>  C3PO Electronic routes will not fall into the TARS 'Robotics network and vice versa. <br><br>  Client interfaces here are tied to a specific VRF. <br>  One interface cannot be a member of two VRFs at once or a member of both the VRF and the global routing table. <br><hr><br>  Using VRF Lite, you can <i>easily</i> forward a VPN between different ends of the network.  To do this, you need to configure the same VRF on all intermediate nodes and correctly bind them to the interfaces: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2c6/63d/e8f/2c663de8f891ebef02b2cfc45a5e7a34.png"><br>  That is, R1 and R2 will communicate with each other through one pair of interfaces in the global routing table, through another pair in VRF TARS 'Robotics and through the third one in VRF C3PO Electronic.  Of course, it can be subinterfaces. <br>  Similarly between R2-R3. <br>  Thus, two virtual networks are obtained that do not intersect with each other.  Given this fact, in each such network, you need to raise your IGP process to ensure connectivity. <br>  In this case, there will be one process for the physical router, one for TARS 'Robotics, one for C3PO Electric.  Accordingly, each of them will be signaled separately from the others through its own interfaces. <br><br>  If we talk about data transfer, the packet, coming from the node from the TARS's Robotics network, immediately falls into the corresponding VRF, because the input interface R1 is a member of it.  According to the FIB of this VRF, it is directed to R2 via the output interface.  In the area between R1 and R2 go the most common IP-packets, which do not suspect that they belong to different VPN.  The only difference is that they go through different physical interfaces, or carry a different tag in the 802.1q header.  R2 accepts this package by an interface that is also a member of TARS's Robotics VRF. <br>  R2 brews the packet in the desired FIB and sends it further, according to IGP.  And so on until the very release of the package to the other side of the network. <br><br>  How does the host determine that the received packet belongs to a particular VPN?  Very simple: this interface is tied (‚Äúpribinden‚Äù) to a specific VRF. <br>  As you have probably noticed, these interfaces are marked with rings of the corresponding color in the illustration. <br><br>  Let's turn on a little imagination: <br>  If the package passes through the gray ring, it <s>goes to the gray side and</s> turns gray.  Further, it will be checked on the gray routing table. <br>  Similarly, when a packet passes through a gold ring, it is covered with a noble gilding and is checked against a gold routing table. <br><br>  Similarly, the output interfaces are tied to the VPN, and the corresponding routing tables know what networks they are behind. <br>  Keep in mind that everything we are talking about routing tables applies to the <a href="http://lookmeup.linkmeup.ru/">FIB</a> - each VPN has its own FIB. <br>  Between routers packets are <i>not painted</i> .  Packages of different VPNs do not mix, because they go either through different physical interfaces, or one by one, but they have different VLAN tags (each VRF has its own output sub-interface). <br><br>  Here it is a simple and transparent VPN - a private network has been formed for the client. <br><img src="https://habrastorage.org/files/129/d0e/654/129d0e65435149f59d2e1748fb72a43f.gif"><br><br>  But this method is convenient, as long as you have 2-3 clients and 2-3 routers.  It is completely unscalable, because one new VPN means a new VRF at each node, a new interface, a new pool of link IP addresses, a new IGP / BGP process. <br>  And if the connection points are not 2-3, but 10, and if you need more redundancy, what is it like to raise the IGP with the client and maintain its routes on each of its nodes? <br><br>  And here we come to MPLS VPN. <br><br><a name="MPLS_L3VPN"></a><br><h1>  MPLS L3VPN </h1><br>  MPLS VPN allows you to get rid of these unpleasant steps: <br>  1) Configure the VRF on each node between the connection points <br>  2) Configure separate interfaces for each VRF on each node. <br>  3) Configure separate IGP processes for each VRF on each node. <br>  4) The need to maintain a routing table for each VRF on each node. <br><br>  How is that? <br><br>  Consider what is MPLS L3VPN on the example of such a network: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/597/b8e/4f7/597b8e4f713eb7e847057f54b2492350.png" title="It is convenient: when you read further"></a> <br><br>  So, these are the three branches of our client TARS 'Robotics: the head office in Moscow and the offices in Novosibirsk and Krasnoyarsk are quite distant to reach their own optical fiber.  And we already have channels there. <br><br>  The central cloud is us - linkmeup - the provider that provides the L3VPN service. <br><br>  Generally speaking, TARS Robotics as a customer, absolutely no difference how we organize L3VPN - so that we can take their packages by train, if only we could fit in the <a href="http://lookmeup.linkmeup.ru/">SLA</a> .  But within this article, of course, MPLS works within our network. <br><br><a name="DATA_PLANE"></a><br><h2>  Data Plane or transfer of user data </h2><br>  First, one should say that in MPLS VPN, a VRF is created only on those routers to which client networks are connected.  In our example, this is R1 and R3.  Any intermediate nodes do not need to know anything about the VPN. <br>  And between them, you need to somehow provide an isolated transfer of packets of different VPNs. <br><br>  This is the approach that MPLS VPN offers: switching within the backbone network is carried out, as we described in the <a href="http://linkmeup.ru/blog/154.html">previous article</a> , by one MPLS tag, and belonging to a particular VPN is determined by another - an additional tag. <br><br>  More details: <br><br>  1) Here the client sends a packet from the network 172.16.0.0/24 to the network 172.16.1.0/24. <br>  2) While it is moving within its branch (client network), it is the most common IP packet, in which Source IP is 172.16.0.2, Destination IP is 172.16.1.2. <br>  3) The branch office network knows that it is possible to get to 172.16.1.0/24 through the provider's network. <br>  Until now, this is the most common package, because the junction is on pure IP with private addresses. <br>  4) Next, R1 (the provider‚Äôs router), receives this packet, knows that it belongs to a certain VRF (the interface is tied to VRF TARS), checks the routing table of this VRF ‚Äî which branch to send the packet to ‚Äî and encapsulates it into an MPLS packet. <br>  The MPLS label on this packet means that it belongs to a particular VPN.  This is called a <b>‚ÄúService Tag</b> . <b>‚Äù</b> <br>  5) Next, our router must send a packet to R3 - behind it is the desired office of the client.  Naturally, by MPLS.  For this, when exiting from R1, the <b>MPLS transport label is</b> hung on it.  That is, at this moment on the package two tags. <br>  Promotion of the MPLS package to the cloud occurs exactly as described in <a href="http://linkmeup.ru/blog/154.html">the basic MPLS release</a> .  In particular, R2 replaces the transport label - SWAP Label. <br>  6) R3 eventually receives the packet, discards the <b>transport</b> label, and by <b>service it</b> understands that it belongs to the VPN TARS 'Robotics. <br>  7) It removes all MPLS headers and sends the packet to the interface as it came to R1 initially. <br><br>  The <s>iron-carbon</s> diagram shows how the package is transformed as it travels from PC1 to PC2: <br><img src="https://habrastorage.org/files/7fc/c5b/5dc/7fcc5b5dcd884a6295a649cfadd9c96e.gif"><br><br>  Remember what good MPLS is?  The fact that no one cares about what is under the label.  Therefore, within the backbone network, it does not matter which address spaces the client has, that is, which IP packet is hidden under the MPLS header. <br>  Since the packet is switched by tags, and not routed by IP addresses - there is no need to maintain a VPN routing table on intermediate nodes. <br><br>  That is, we get such a convenient MPLS-tunnel, which is signaled, as you will see further, automatically. <br><br>  So, in the interval between R1 and R3 (that is, in the MPLS cloud), no one has an understanding of what a VPN is - VPN packets move along labels to their destination, and only he has to worry about what to do with them further.  This removes the need to raise the VRF on each node and, accordingly, maintain the routing table, FIB, list of interfaces, etc. <br>  Considering that the entire further packet path is defined on the first MPLS router (R1), there is no need for an individual routing protocol in each VPN, although the question remains how to find the output router, which we will answer later. <br><hr><br><img src="https://habrastorage.org/getpro/habr/post_images/f75/277/654/f75277654f58b3cf0acfb19d7cc723f6.png" width="300"><br><br>  To better understand how traffic is transmitted, you need to figure out the meaning of the tags in the packet. <br><br><a name="LABEL_ROLES"></a><br><h2>  The role of MPLS tags </h2><br>  If we return to the initial scheme with <a href="">VRF-Lite</a> , the problem is that the gray color of the IP packet (VPN TARS 'Robotics membership indicator) exists only within the node, and when it is transferred to another, this information is carried in the VLAN tags.  And if we refuse subinterfaces on intermediate nodes, porridge will begin.  And this must be done for the good of all that is good. <br>  To prevent this from happening in a scenario with MPLS, the Ingress LSR per packet <b>places a</b> special MPLS label - <b>Service</b> - it is a VPN identifier.  Egress LSR (the last router is R3) understands from this label that the IP packet belongs to VPN TARS's Robotics and reviews the corresponding FIB. <br>  That is very similar to VLAN, with the difference that only the first router should take care of this. <br><br>  But based on the service tag, the packet cannot be switched over the MPLS network ‚Äî if we change it somewhere, then Egress LSR will not be able to recognize which VPN it belongs to. <br><br>  And here comes to the rescue a stack of tags that we so carefully avoided in the last issue. <br>  The service tag turns out to be internal - the first one in the stack, and the transport one is still hung on top of it. <br>  That is, the MPLS package travels with two labels - top - transport and bottom - service). <br><br>  Why do you need two tags, why can not you do one service?  Let, for example, one label on the Ingress LSR ask one VPN, the other - another.  Accordingly, further along the way, they would also switch as usual, and the Egress LSR would know exactly which VRF to transmit the packet to. <br>  Generally speaking, this could be done, and it would work, but then there would be a separate LSP for each VPN on the backbone network.  And if, for example, you have a bundle of 20 VPN from R1 to R3, then you would have to create 20 LSPs.  And it is more difficult to maintain, it is an overspending of tags, it is an extra load on transit LSR.  And, strictly speaking, this is what we're trying to get away from here. <br>  In addition, for different prefixes of the same VPN there may be different labels - this also significantly increases the number of LSPs. <br>  Where is it easier to create one LSP that will tunnel all 20 VPNs at once? <br><br><a name="TRANSPORT_LABEL"></a><br><h5>  Transport tag </h5><br>  Thus, we need a transport label.  She is top on the stack. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fec/f8e/703/fecf8e703f011cc6e860fe642ec8c7bf.png" title="Transport tag" alt="Transport tag"><br><br>  It defines the LSP and changes at each node. <br>  It is added (PUSH) Ingress LSR and removed (POP) Egress LSR (or Penultimate LSR in the case of <a href="http://lookmeup.linkmeup.ru/">PHP</a> ).  On all intermediate nodes, it changes from one to another (SWAP). <br>  LDP and RSVP-TE protocols are involved in the propagation of transport labels.  We also talked about this very well in the last article and will not stop now. <br>  In general, the transport tag is of little interest to us, since everything is already clear, except for one detail - FEC. <br>  The FEC is no longer the destination network of the packet (the client‚Äôs private address), this is the address of the last LSR in the MPLS network where the client is connected. <br>  This is very important because the LSP is not aware of any VPN there, and therefore does not know anything about their private routes / prefixes.  But he knows the addresses of the Loopback interfaces of all LSRs well.  So exactly what LSR this client prefix is ‚Äã‚Äãconnected to will be prompted by BGP - this will be the FEC for the transport label. <br>  In our example, R1, based on the destination address of the client packet, must understand that you need to select the LSP that leads to R3. <br>  We will return to this question a little later. <br><br><a name="SERVICE_LABEL"></a><br><h5>  Service Tag </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/f31/cc9/7be/f31cc97bea4120c44d94c68f035cbbec.png" title="Service Tag" alt="Service Tag"><br><br>  The bottom label on the stack is a service tag.  It is the unique identifier for the prefix in a particular VPN. <br>  It is added to Ingress LSR and does not change anywhere else until the Egress LSR itself, which eventually removes it. <br>  <a href="http://lookmeup.linkmeup.ru/">The FEC</a> for the Service Tag is the prefix in the VPN, or, roughly speaking, the destination subnet of the original packet.  In the example below, the FEC is 192.168.1.0/24 for VRF C3PO and 172.16.1.0/24 for VRF TARS. <br>  That is, the Ingress LSR must know which label is allocated for this VPN.  How this happens is the subject of our further research. <br>  This is how the whole packet transfer process in different VPNs looks like: <br><img src="https://habrastorage.org/files/f63/cf2/405/f63cf240583245b5b2318be5786f6c79.gif"><br><br>  Note that for two different VPNs, the service tags are different - by them the output router will know which VRF to transmit the packet to. <br>  And the transport in this case is the same for the packets of both VRFs, because they use the same LSP - R1R2R3. <br><br><a name="TERMS"></a><br><h2>  Terminology </h2><br>  Before we go too far, we need to introduce terminology. <br>  When it comes to MPLS VPN, several new terms appear, which, by the way, are quite obvious: <br>  <b>CE - <u>Customer Edge router</u></b> - client's border router, which is connected to the provider's network. <br>  <b>PE - <u>Provider Edge router</u></b> - provider's edge router.  Actually, CE is connected to it.  VPN is born on PE, and it ends there.  This is where the VPN-specific interfaces are located.  It is PE that assigns and removes service tags.  PEs are Ingress LSR and Egress LSR. <br>  PEs need to know the routing tables of each VPN, because they decide where to send the packet, both within the provider network and in terms of client interfaces. <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provider router</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a transit router that is not a connection point - VPN packets pass through it without any additional processing, in other words, they are simply switched by the transport label. No need to know the VPN routing tables or service tags. On P, there are no VPN-related interfaces. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In fact, the role of P-PE is individual for VPN. If in one VPN R1 and R3 are PE and R2 is P, then in the other they can change their roles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, in the diagram below, the roles of the blue routers are different for the green client and for the violet: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/b1e/bfa/ec4/b1ebfaec406db9a4c7c36fc5cfe4f377.png"><br><br> <b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Label stack</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - a set of MPLS headers hung on one packet. Each of them performs some of its own role. In our reality, few vendors support more than six tags on the stack.</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There will be a number of terms, but it is too early to enter them.</font></font></i> <br><hr><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, we are done with the way data is transmitted, that is, how Forwading Plane works. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's summarize: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The PE router places two tags on client traffic ‚Äî an internal service that does not change until the very end of the journey and the last PE understands which VRF the package belongs to and the external transport one that transfers the packet through the provider‚Äôs network ‚Äî this label changes to Each P-router is removed on the last PE or the second-to-last P. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Due to the presence of the service tag and the VRF, the traffic of different VPNs is isolated from each other both within routers and in channels. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And actually, now it is possible to formulate a number of troubling questions: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) How are MPLS tags distributed?</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) How is the routing information distributed for each VPN? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3) How are the routes of different VPNs isolated from each other and not mixed? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These and other questions are answered below.</font></font><br><br><a name="CONTROL_PLANE"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Control Plane or transfer of service (routing) information </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Answering them, let's talk about how this entire environment is prepared in which data packets will be successfully walked. </font></font><br><br><a name="ROUTING_PROTOCOLS"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Routing protocols </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So, we have two types of networks and the joints between them: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Client IP network; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Provider's backbone network with MPLS running on it. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The boundary of these networks is on PE. That is, one of its half is already client, and the other is provider. It is not in vain that popular wisdom exists: No matter how you tune up PE, it still looks at customers. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MPLS is configured only on trunk interfaces. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/eaf/d53/e2a/eafd53e2aaab057c1cd8b523322a44b2.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I remind you, speech about L3VPN. And here you need to take care of IP connectivity. And now we have a lot of restrictions. We will understand what protocols in which areas will be useful to us. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , you need to provide basic IP connectivity within the provider‚Äôs backbone network. So that all Loopback addresses, link networks, service prefixes, possibly some exits outside are known. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For this, IGP (ISIS, OSPF) is started. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Already on top of the connected network rises MPLS.</font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So we have ensured the operability of the backbone network</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secondly</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the client in the branches may have not one router, but some networks. These networks also need to be routed inside at least. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviously, within its own network, the client is free to distribute route information as he pleases. We as a provider cannot influence this, and we do not care. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This ensures the transfer of routes within customer networks</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thirdly</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , the client needs to somehow communicate its routes to the provider. At the junction of CE-PE, the client and the provider already need to agree on which protocol will be used.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Although, the client has hardly any self-written IGP protocol. </font><font style="vertical-align: inherit;">Surely this is OSPF / ISIS / RIP. </font><font style="vertical-align: inherit;">Therefore, usually the provider goes forward and chooses the one that is convenient for the client. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we must understand that this client interaction protocol works in a VPN and does not overlap with the provider‚Äôs IGP. </font><font style="vertical-align: inherit;">These are different independent processes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Often, BGP works at this interface, since it allows flexible filtering of prefixes by various attributes. </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So the provider receives routes of clients</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Until now, everything was clear.</font></font></b> <div class="spoiler_text"> <i>     .</i> <br></div></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fourth</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , and this is the most interesting - it remains to transfer the routes of one branch to another through the backbone network. At the same time they should not be lost along the way, not to be confused with strangers, to be delivered safe and sound. Here we will be helped by the extension of the protocol BGP - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MBGP - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Multiprotocol BGP</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (Often called MP-BGP). We will talk about it now. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But first look at what works where:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/708/648/0c7/7086480c78127bc00bd490c8993a3cdf.png"><br><br><blockquote> ,        . <br> ,          . <br> 1)   ,            (IGP  ). <br> 2)   ,       (IGP/BGP  ). <br> 3)       ,    (  ).       (VPN). <br> 4)     ,        ‚Äî       (BGP),             (    ‚Äî PUSH Label ‚Äî     ) <br> ,    .       ,   ‚Äî .      ,    . <br> 5)        ,   .     ,      .          . (     ‚Äî SWAP Label).    ‚Äî   -    . <br> 6)       (POP Label)       ‚Äî      (  VPN). <br> 7)        (IGP/BGP  ). <br> 8)         ,   (IGP  ). <br><br> ,   ‚Äî  PE/Ingress LSR,   ‚Äî   PE/Egress LSR,   ‚Äî P/Intermediate LSR. <br> <i>    PHP   </i> . <br></blockquote><br><br><a name="MBGP"></a><br><h2> MBGP </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we will answer two questions: how are the routes transmitted in the provider network from one PE to another and how is the isolation ensured. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, so far, nothing better has been invented for transferring routes to remote sites than BGP: both the flexibility of transferring the routes themselves, and the mass of tools to influence the choice of route, and the policies for receiving and transmitting routes, and the Community, which greatly simplifies group actions. over routes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you suddenly </font></font><a href="http://linkmeup.ru/blog/65.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">forget</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , here is the usual BGP Update message: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/29c/69a/39f/29c69a39f26efbf19a81ec72f966afda.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NLRI</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section, </font><font style="vertical-align: inherit;">it transfers the prefix itself. And in other sections of the mass of its parameters. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To his help and resort to the implementation of MPLS L3VPN. Therefore, his middle name is MPLS BGP VPN.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You remember how this happens? BGP establishes a session with its neighbors via TCP on port 179. This allows you to choose not a directly connected router as neighbors, but those that are in several hopes. This is how IBGP works, where ‚Äúevery with every‚Äù connection is assumed within the backbone network. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When several routes leading to the same network arrive at the site, BGP simply selects the best one and installs it into the routing table. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, in general, it does not cost us anything to pass the VPN route through the network to the other end. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BGP must take routes from a VRF on one node, deliver them to another and export to the correct VRF there.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The only catch is that BGP is initially focused on working with public addresses that are assumed to be unique throughout the world. But </font></font><a href="https://tools.ietf.org/html/rfc1918"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rogue</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> clients usually want to transfer routes to private networks ( </font><a href="https://tools.ietf.org/html/rfc1918"><font style="vertical-align: inherit;">RFC1918</font></a><font style="vertical-align: inherit;"> ) and, </font><a href="https://tools.ietf.org/html/rfc1918"><font style="vertical-align: inherit;">unfortunately</font></a><font style="vertical-align: inherit;"> , they can easily intersect with both networks of other VPNs and the internal address space of the provider. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, if, for example, R3 receives two routes to the network on 10.10.10.10/32 (one from TARS's Robotics, the other from C3PO Electronic), he will choose only one - with the best indicators, as the standard prescribes - he thinks that these are two routes into the same network. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9ed/531/8b5/9ed5318b5d8cfb16c5ffbd38faf8d6c3.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Naturally, this does not suit us. It is necessary that two conditions be fulfilled: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1) Routes of different VPNs were unique and did not mix in transmission between PEs.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2) Routes at the end point must be transferred to the correct VRF. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These problems found an elegant solution. </font><font style="vertical-align: inherit;">Let's start with item 1 - the uniqueness of the routes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In our example 10.10.10.10/32 from TARS's Robotics should differ in some way from 10.10.10/32 from C3PO Electronic. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BGP is an incredibly flexible protocol (no wonder that it became the only external gateway protocol). </font><font style="vertical-align: inherit;">It is easily scaled and with the help of the so-called </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Address Family,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it can transmit routes not only IPv4, but also IPv6 and IPX (but only to whom it is needed). </font><font style="vertical-align: inherit;">If you want to transfer something new, get your Address Family, </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And IETF created a new Address Family. </font><font style="vertical-align: inherit;">And he gave him the name VPNv4 (or VPN-IPv4).</font></font><br><br><a name="RD"></a><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Route Distinguisher </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order to distinguish between different VPN routes, the usual IPv4 prefix is ‚Äã‚Äãsupplemented with a special prefix 8 bytes long - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RD - </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Route Distinguisher</font></font></u></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then the route from C3PO will look like this: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64500: </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">100</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.10.10.10/32, and from TARS like this: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">64500: </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">200</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10.10.10 </font><font style="vertical-align: inherit;">/ </font><b><font style="vertical-align: inherit;">32</font></b><font style="vertical-align: inherit;"> . And now these are completely different things that the BGP process can distinguish from each other. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Let's figure out what RD is and how to define it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There are 3 types of RD: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/1dc/1d2/0a6/1dc1d20a66f2f8b02997c0d2dd1f45e7.png" title="RD Types" alt="RD Types"><br> <i><a href="http://packetlife.net/blog/2013/jun/10/route-distinguishers-and-route-targets/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inspired</font></font></a></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first part</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the type itself (0, 1 or 2); </font></font><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second part of</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Administrative field (Administrator field) is always a public parameter - public IP-address or public AS number. It is necessary so that your RDs are unique not only within the network, but also within the planet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, in the Administrative part, the IP address 172.16.127.2 or AS 65001 should not appear by chance. This can be useful if the VPN needs to be transferred to the network of another provider (and this is also possible in our insane time, and it even carries the name Inter -AS VPN). </font></font><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The third part</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - Assigned Number - this is what you assign. This part allows the RD to be unique within your network and, in fact, define a VPN. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, RD is unique within the planet.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Here are two examples of converting a regular IPv4 prefix 10.10.10.10/32 to VPNv4: </font></font><br><pre><code class="bash hljs">0:64500:100:10.10.10.10/32</code> </pre> <br>  or <br><pre> <code class="bash hljs">1:100.0.0.1:100:10.10.10.10/32.</code> </pre> <br>  Which one you choose does not matter, even if within the network you use both approaches at the same time.  Even for one VRF on different routers.  The main task of RD is to separate the prefixes. <br>  That is, if in a very simple language: it doesn't matter at all what you configure, the main thing is that you are sure that BGP will never confuse the routes of different VPNs. <br>  Although the systematization still no one interfered. <br><br>  Typically, type 0 is used, the Administrative field is the AS number of the provider, and you select the Dedicated number yourself.  When configuring RD, the first "0:" or "1:" (type RD) are reduced and it turns out like this: <i>64500: 100</i> and <i>100.0.0.1:100</i> . <br>  Cisco allows you to use types 0 and 1. <br><br>  Yes, RD will have to be configured manually and you should follow its uniqueness yourself.  But it will not work out differently here - the routers themselves do not know how to track whether there is already such an RD on other nodes or not.  And if there is, then is this the same VPN? <br><br>  And what do we get? <br><br>  <b>1)</b> Comes from CE announcement of the new network.  Let it be 10.10.10.10/32, as we agreed.  PE adds this route to the specific VRF routing table.  Notice that the normal IPv4 route is stored in the routing table ‚Äî no VPNv4.  And this is not necessary: ‚Äã‚ÄãVRFs are isolated from each other, as we have said before - this is a separate, albeit virtual, router. <br>  <b>2)</b> BGP noticed that a new prefix appeared in the VPN.  From the VRF configuration, it sees which RD should be used.  Compiles from the RD and the new IPv4 prefix, a VPNv4 prefix.  It turns out like this: <br>  <i>C3PO: 64500: 100: 10.10.10.10/32</i> <br>  or so: <br>  <i>TARS: 64500: 200: 10.10.10.10/32</i> <i><br></i> <br>  <b>3)</b> When creating BGP Update, the router inserts the received VPNv4 prefix, the address of Next Hop and other BGP attributes there.  But among other things, he adds information about the <b>label</b> in the NLRI field.  This label is tied to the route, or more precisely, the VPNv4 prefix is ‚Äã‚Äãan FEC, and in the NLRI a bunch of the given FEC and the label is transmitted. <br>  In English, this is called <b>Labeled Route</b> - in Russian, perhaps, a <i>route marked with a label</i> .  So this PE notifies its neighbors that if they received an IP packet from the CE into this network, they need to assign such a <b>service</b> tag. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/250/0cf/35d/2500cf35d040b290e486380650472906.png" title="BGP Update with RD" alt="BGP Update with RD"><br><br>  Also note the Next Hop address is Loopback PE.  And this is very correct - Ingress PE should know to which Egress PE the incoming data packet should be sent, that is, to know its Loopback, and then at least the flood. <br><br>  <b>4)</b> Next, BGP Update is transmitted to all neighbors configured in the VPNv4 family section. <br><br>  <b>5)</b> Remote PE receives this Update, sees in the NLRI that it is not a normal IPv4 route, but VPNv4.  Remember, yes: if two routes come to the same network from different clients - they will not be confused, because they have different RDs.  Further, Egress PE <i>determines which VRF this route should be exported to</i> and actually does it.  So the route appears in the routing table and FIB of the desired VRF, and from there it goes to the client‚Äôs network. <br><br>  Now, when PE receives a data packet from CE that follows the 10.10.10.10/32 network, it finds the service tag (22) and Next-Hop (1.1.1.1) in the FIB of this VPN.  Encapsulates IP in MPLS, further searches in the already global FIB transport label for Next Hop. <br>  The transport label itself is still delivered by the LDP or RSVP-TE protocols, and the service label is delivered by MBGP. <br><br>  Compare the NLRI field in normal BGP and in MP-BGP. <br><img src="https://habrastorage.org/getpro/habr/post_images/8db/8bb/5ac/8db8bb5ac7670d118099131bcf25e5de.png" title="NLRI" alt="NLRI"><br><br><img src="https://habrastorage.org/files/bb5/f93/ae1/bb5f93ae1dd544319d7bdeec3a6b248c.gif"><br><hr><br><a name="RT"></a><br><h3>  Route target </h3><br>  It‚Äôs not for nothing that in the fifth paragraph I highlighted the phrase <i>‚Äúdetermines which VRF this route should be exported‚Äù</i> in italics.  Behind this simplicity is another thing - <b>RT - <u>Route Target</u></b> . <br><br>  The fact is that the only role of RD is to diversify the life of BGP, that is, to make routes unique.  Despite the fact that it is configured for VRF, it is not some unique identifier of it and at all points of connection this value may even be different.  Therefore, PE cannot determine in which VRF a route is thrust based on RD. <br>  Yes, and it would not be entirely in the tradition of BGP - to parse the transmitted address, analyze it before announcing somewhere.  For these purposes we have policies. <br>  That is, in a classic BGP, you would have to hang policies for exporting routes to the VRF for each one separately.  And we would manually filter out where you need to attach each route. <br>  One step towards simplification is to use the community.  When sending a route from one PE to another, you can set up a certain community - a different one for each VRF, and on the remote one for this community you can set up export to the corresponding VRF.  It already looks comfortable and convincing. <br>  MBGP went a little further - the idea of ‚Äã‚Äãthe community was developed to the concept of Route Target.  In fact, this is the same community - RT is even transmitted in the Extended Community attribute, only all policies work automatically. <br>  The RT format is exactly the same as the ordinary Extended Community.  For example: <br>  <i>64500: 100</i> <br><br>  That is, it looks like the first type of RD.  This is partly why RD and RT are so often confused. <br><br>  On one side of the VRF, RT is configured to export the route - the RT with which it will travel to the remote PE.  On the other, the exact same RT value is set for import.  And vice versa. <br>  Usually, if the task is to simply organize a VPN service for one client, then RT for export and import coincide at all connection points. <br><br>  Returning to our example: <br>  R1 sends the R3 route to the network on 10.10.10.10/32 (TARS 'Robotics), specifies the label and all other parameters, and among other things, it writes RT to the Extended Community attribute on the route export configured for this VRF: 64500: 200. <br>  R3 receives this announcement, checks the community, sees 64500: 200, and from the configuration it knows that routes with this RT need to be imported into VRF TARS. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f1/486/14e/7f148614efffeb4b99ee925b9ffd933b.png"><br><br>  Handsomely?  Elegantly?  But that is not all.  The flexibility of BGP is here again.  With the help of the RT mechanism, you can import routes as you like, both within the same VPN and between different VPNs. <br><br>  Here are two scenarios: <br><blockquote>  1) The client wants to organize the topology of the star, and not everyone with each.  That is, the central point must know the routes to all connection points, but they must know only the routes to the center.  Thus, any interactions between separated client networks will be carried out through the central site.  Without any action from the client - it is convenient! <br>  Solution: Each branch has its own RT for export.  In branches, RT for import is equal to RT for export, which is configured at the central site - that is, they can receive routes from the center.  At the same time, there are no other branches of RT for import - accordingly, they do not see their routes directly.  But in the center of the import RT are configured for all branches, that is, it will receive everything, everything. <br></blockquote><br><br><blockquote>  2) Suppose, in addition to our two VPNs, a third appeared - R2D2.  He has his own tasks, but they also support servers with microprocessor firmware, templates, additional modules, etc., which are necessary for C3PO Electronic.  At the same time, he does not want to shine his servers into the world, but to provide access for customers through the provider's network. <br>  And then with the help of RT you can provide interaction between different VPNs.  To do this, in C3PO Electronic we configure such RT for import, which in VPN R2D2 was specified for export.  And, accordingly, vice versa. <br>  However, in this case, you need to monitor whether the used subnets do not overlap.  Indeed, despite all the RDs and RTs, BGP will select only one route to each subnet in the VRF. <br></blockquote><br><br><img src="https://habrastorage.org/files/22e/567/263/22e56726398c4019b14c22cfd71f2d75.gif"><br><br>  It remains to see the process of transferring the route from and to: <br><img src="https://habrastorage.org/files/976/2f9/581/9762f958192f43e38371c55f296322b8.gif"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/600/c8a/1a7/600c8a1a72c0ae03b17ae2e93fbff757.png"><br><hr><br><br><a name="PRACTICE"></a><br><h1>  Practice </h1><br>  Traditionally, in practice, we repeat everything that was still in theory. <br><br><a name="PRACTICE_VRF_LITE"></a><br><h2>  VRF-Lite </h2><br>  So let's go from simple to complex.  Let's start with the situation when one client has two connections to one router: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/456/255/f80/456255f8069bf65c614dbe95095e92de.png"><br><br>  First, let's try to set everything up the way we did before: <br><br>  <b>Linkmeup:</b> <br><pre> <code class="bash hljs">Linkmeup(config)<span class="hljs-comment"><span class="hljs-comment"># interface FastEthernet0/0 Linkmeup(config-if)# description To C3PO_1 Linkmeup(config-if)# ip address 192.168.0.1 255.255.255.0 Linkmeup(config)# interface FastEthernet0/1 Linkmeup(config-if)# description To C3PO_2 Linkmeup(config-if)# ip address 192.168.1.1 255.255.255.0</span></span></code> </pre><br><br>  <b>C3PO_1:</b> <br><pre> <code class="bash hljs">C3PO_1(config)<span class="hljs-comment"><span class="hljs-comment"># interface FastEthernet0/0 C3PO_1(config-if)# description To Linkmeup C3PO_1(config-if)# ip address 192.168.0.2 255.255.255.0 C3PO_1(config)#ip route 0.0.0.0 0.0.0.0 192.168.0.1</span></span></code> </pre><br><br><br>  <b>C3PO_2:</b> <br><pre> <code class="bash hljs">C3PO_2(config)<span class="hljs-comment"><span class="hljs-comment"># interface FastEthernet0/0 C3PO_2(config-if)# description To Linkmeup C3PO_2(config-if)# ip address 192.168.1.2 255.255.255.0 C3PO_2(config)# ip route 0.0.0.0 0.0.0.0 192.168.1.1</span></span></code> </pre><br><br>  Ping between branches appears - they see each other. <br><img src="https://habrastorage.org/getpro/habr/post_images/0ee/509/4dc/0ee5094dc7c659ea73efc8f5f6716904.png"><br><br>  But they also see, for example, the address of Loopback R1: <br><img src="https://habrastorage.org/getpro/habr/post_images/d54/741/874/d54741874e776bc2b2cbff9aa133fdc9.png"><br><br>  Accordingly, they see the entire network of the provider and will see the networks of other customers. <br><br>  Therefore, we configure VRF: <br><pre> <code class="bash hljs">Linkmeup(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf C3O</span></span></code> </pre><br>  To place clients in this VRF, you need to bind their interfaces to the VRF: <br><pre> <code class="bash hljs">Linkmeup(config)<span class="hljs-comment"><span class="hljs-comment"># interface FastEthernet0/0 Linkmeup(config-if)# ip vrf forwarding C3PO % Interface FastEthernet0/0 IP address 192.168.0.1 removed due to enabling VRF C3PO</span></span></code> </pre><br>  Please note that after executing the <b>ip vrf forwarding C3PO</b> command, IOS removed the IP addresses from the interfaces, now they need to be reconfigured.  This happened in order to remove the specified subnets from the global routing table. <br><br><pre> <code class="bash hljs">Linkmeup(config)<span class="hljs-comment"><span class="hljs-comment"># interface FastEthernet0/0 Linkmeup(config-if)# ip address 192.168.0.1 255.255.255.0 Linkmeup(config-if)#interface FastEthernet0/1 Linkmeup(config-if)# ip vrf forwarding C3PO % Interface FastEthernet0/0 IP address 192.168.1.1 removed due to enabling VRF C3PO Linkmeup(config-if)# ip address 192.168.1.1 255.255.255.0</span></span></code> </pre><br><br>  After reconfiguring the address, these subnets will appear in the VRF routing table. <br><img src="https://habrastorage.org/getpro/habr/post_images/aa8/f7f/f43/aa8f7ff43a5453eaec7148b6b04bf74e.png"><br><br>  Check ping again: <br><img src="https://habrastorage.org/getpro/habr/post_images/046/e41/bf1/046e41bf1d43ba9d16baf5071498ab9c.png" width="672"><br><br>  But before the internal address of the provider will not be: <br><img src="https://habrastorage.org/getpro/habr/post_images/c86/3ac/325/c863ac325c746aafc9674e8122e36525.png"><br><br>  Similar settings need to be made for the TARS client: <br><pre> <code class="bash hljs">Linkmeup(config)<span class="hljs-comment"><span class="hljs-comment"># ip vrf TARS Linkmeup(config-if)# interface FastEthernet1/0 Linkmeup(config-if)# ip vrf forwarding TARS Linkmeup(config-if)# ip address 100.0.0.1 255.255.255.252 Linkmeup(config-if)#interface FastEthernet1/1 Linkmeup(config-if)# ip vrf forwarding TARS Linkmeup(config-if)# ip address 100.0.1.1 255.255.255.252</span></span></code> </pre><br><br>  Well, fine.  VRF TARS and C3PO are completely isolated from the provider‚Äôs network and from each other: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a4a/aef/fd4/a4aaeffd4685b7637dde5d7bc326fe78.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e55/08e/674/e5508e6747763e018e7f53c216937291.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b80/2cd/1d1/b802cd1d1fd859ab2b5db46e525cc729.png"><br><br><hr><br>  Now we stretch the fun to the network linkmeup: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e95/abe/dc9/e95abedc99516280347c32d6be52c2d2.png"><br><br>  <u><b>The first</b></u> configuration <u><b>step</b></u> is <b>to create a VRF</b> on each node from R1 to R3: <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf C3PO Linkmeup_R1(config)#ip vrf TARS</span></span></code> </pre><br><pre> <code class="bash hljs">Linkmeup_R2(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf C3PO Linkmeup_R2(config)#ip vrf TARS</span></span></code> </pre><br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf C3PO Linkmeup_R3(config)#ip vrf TARS</span></span></code> </pre><br>  * It should be understood that VRF is a strictly local concept for a node.  It is possible to set different VRF names on different routers. <br><br>  <u><b>The second step</b></u> is <b>to create a chain of link networks between all nodes</b> and <b>bind each pair of interfaces to the desired VRF</b> . <br><blockquote>  We did not indicate link addresses on the scheme in order not to clutter it.  For the order, choose the prefixes 10.0 / 16 for the provider‚Äôs own network (VLAN1), 192.168 / 16 for C3PO Electronic (Vlan 2) and 100.0 / 16 for TARS 'Robotics (Vlan 3). <br></blockquote><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#interface FastEthernet0/0 Linkmeup_R1(config-if)#description To C3PO_Electronic_1 Linkmeup_R1(config-if)#ip vrf forwarding C3PO Linkmeup_R1(config-if)#ip address 192.168.0.1 255.255.255.0 Linkmeup_R1(config)#interface FastEthernet0/1 Linkmeup_R1(config-if)#description To Linkmeup_R2 Linkmeup_R1(config-if)#ip address 10.0.12.1 255.255.255.0 Linkmeup_R1(config)#interface FastEthernet0/1.2 Linkmeup_R1(config-subif)#description to Linkmeup_R2_vrf_C3PO Linkmeup_R1(config-subif)#encapsulation dot1Q 2 Linkmeup_R1(config-subif)#ip vrf forwarding C3PO Linkmeup_R1(config-subif)#ip address 192.168.12.1 255.255.255.0 Linkmeup_R1(config)#interface FastEthernet0/1.3 Linkmeup_R1(config-subif)#description To Linkmeup_R2_in_TARS Linkmeup_R1(config-subif)#encapsulation dot1Q 3 Linkmeup_R1(config-subif)#ip vrf forwarding TARS Linkmeup_R1(config-subif)#ip address 100.0.12.1 255.255.255.0 Linkmeup_R1(config)#interface FastEthernet1/0 Linkmeup_R1(config-if)#description To TARS_1 Linkmeup_R1(config-if)#ip vrf forwarding TARS Linkmeup_R1(config-if)#ip address 100.0.0.1 255.255.255.0</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Configuration of other nodes</b> <div class="spoiler_text">  <b><i>Linkmeup_R2:</i></b> <br><pre> <code class="bash hljs">Linkmeup_R2(config)<span class="hljs-comment"><span class="hljs-comment">#interface FastEthernet0/0 Linkmeup_R2(config-if)#description To Linkmeup_R1 Linkmeup_R2(config-if)#ip address 10.0.12.2 255.255.255.0 Linkmeup_R2(config)#interface FastEthernet0/0.2 Linkmeup_R2(config-subif)#description To Linkmeup_R1_vrf_C3PO Linkmeup_R2(config-subif)#encapsulation dot1Q 2 Linkmeup_R2(config-subif)#ip vrf forwarding C3PO Linkmeup_R2(config-subif)#ip address 192.168.12.2 255.255.255.0 Linkmeup_R2(config)#interface FastEthernet0/0.3 Linkmeup_R2(config-subif)#description To Linkmeup_R1_vrf_TARS Linkmeup_R2(config-subif)#encapsulation dot1Q 3 Linkmeup_R2(config-subif)#ip vrf forwarding TARS Linkmeup_R2(config-subif)#ip address 100.0.12.2 255.255.255.0 Linkmeup_R2(config)#interface FastEthernet0/1 Linkmeup_R2(config-if)#description To Linkmeup_R3 Linkmeup_R2(config-if)#ip address 10.0.23.2 255.255.255.0 Linkmeup_R2(config)#interface FastEthernet0/1.2 Linkmeup_R2(config-subif)#description To Linkmeup_R3_vrf_C3PO Linkmeup_R2(config-subif)#encapsulation dot1Q 2 Linkmeup_R2(config-subif)#ip vrf forwarding C3PO Linkmeup_R2(config-subif)#ip address 192.168.23.2 255.255.255.0 Linkmeup_R2(config)#interface FastEthernet0/1.3 Linkmeup_R2(config-subif)#description To Linkmeup_R3_vrf_TARS Linkmeup_R2(config-subif)#encapsulation dot1Q 3 Linkmeup_R2(config-subif)#ip vrf forwarding TARS Linkmeup_R2(config-subif)#ip address 100.0.23.2 255.255.255.0</span></span></code> </pre><br><br>  <b><i>Linkmeup_R3:</i></b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#interface FastEthernet0/0 Linkmeup_R3(config-if)#description To Linkmeup_R2 Linkmeup_R3(config-if)#ip address 10.0.23.3 255.255.255.0 Linkmeup_R3(config)#interface FastEthernet0/0.2 Linkmeup_R3(config-subif)#description To Linkmeup_R2_vrf_C3PO Linkmeup_R3(config-subif)#encapsulation dot1Q 2 Linkmeup_R3(config-subif)#ip vrf forwarding C3PO Linkmeup_R3(config-subif)#ip address 192.168.23.3 255.255.255.0 Linkmeup_R3(config)#interface FastEthernet0/0.3 Linkmeup_R3(config-subif)#description To Linkmeup_R2_vrf_TARS Linkmeup_R3(config-subif)#encapsulation dot1Q 3 Linkmeup_R3(config-subif)#ip vrf forwarding TARS Linkmeup_R3(config-subif)#ip address 100.0.23.3 255.255.255.0 Linkmeup_R3(config)#interface FastEthernet0/1 Linkmeup_R3(config-if)#description To C3PO_2 Linkmeup_R3(config-if)#ip vrf forwarding C3PO Linkmeup_R3(config-if)#ip address 192.168.1.1 255.255.255.0 Linkmeup_R3(config)#interface FastEthernet1/0 Linkmeup_R3(config-if)#description To TARS_2 Linkmeup_R3(config-if)#ip vrf forwarding TARS Linkmeup_R3(config-if)#ip address 100.0.1.1 255.255.255.0</span></span></code> </pre><br></div></div><br><br>  <u><b>The third</b></u> is <b>to raise the IGP in the VRF</b> . <br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 vrf C3PO Linkmeup_R1(config-router)#network 192.168.0.0 0.0.255.255 area 0 Linkmeup_R1(config)#router ospf 3 vrf TARS Linkmeup_R1(config-router)#network 100.0.0.0 0.0.255.255 area 0 Linkmeup_R1(config)#router isis 1 Linkmeup_R1(config-router)#net 10.0000.0000.0001.00 Linkmeup_R1(config)#interface FastEthernet0/1 Linkmeup_R1(config-if)#ip router isis 1</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Configuration of other nodes</b> <div class="spoiler_text">  <b><i>Linkmeup_R2</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R2(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 vrf C3PO Linkmeup_R2(config-router)#network 192.168.0.0 0.0.255.255 area 0 Linkmeup_R2(config)#router ospf 3 vrf TARS Linkmeup_R2(config-router)#network 100.0.0.0 0.0.255.255 area 0 Linkmeup_R2(config)#router isis 1 Linkmeup_R2(config-router)#net 10.0000.0000.0001.00 Linkmeup_R2(config)#interface FastEthernet0/0 Linkmeup_R2(config-if)#ip router isis 1 Linkmeup_R2(config)#interface FastEthernet0/1 Linkmeup_R2(config-if)#ip router isis 1</span></span></code> </pre><br><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 vrf C3PO Linkmeup_R3(config-router)#network 192.168.0.0 0.0.255.255 area 0 Linkmeup_R3(config)#router ospf 3 vrf TARS Linkmeup_R3(config-router)#network 100.0.0.0 0.0.255.255 area 0 Linkmeup_R3(config)#router isis 1 Linkmeup_R3(config-router)#net 10.0000.0000.0001.00 Linkmeup_R3(config)#interface FastEthernet0/0 Linkmeup_R3(config-if)#ip router isis 1</span></span></code> </pre><br></div></div><br><blockquote>  ISIS for connectivity of the internal network provider, OSPF for VPN. <br>  OSPF rises with customers so that they learn routes dynamically.  Accordingly, they should have a structure like this: <br><pre> <code class="bash hljs">C3PO_1(config)<span class="hljs-comment"><span class="hljs-comment"># router ospf 1 C3PO_1(config-router)# network 192.168.0.0 0.0.255.255 area 0</span></span></code> </pre></blockquote><br><br>  Actually everything.  Now each network knows its routes: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a9/9dc/e95/7a99dce9511b20bb235a9030aa0c4bfb.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ef1/937/836/ef1937836b36309efc7fd7d3925d44b5.png"><br><br>  In principle, on the basis of a single physical network, we have created three completely independent virtual networks, within which you can do almost anything you want - at least to raise your MPLS. <br><br>  But, as it was said before, this is a very inert solution, so we turn to MPLS BGP VPN. <br><br><a name="PRACTICE_MPLS_L3VPN"></a><br><h2>  MPLS L3VPN </h2><br>  I propose this time not to take a ready-made network, where everything is already pre-configured.  Now it will be more interesting to go this way from scratch, even if only by milestones, without going into details. <br><br>  So, we are torturing the same network, but simplify it by removing one branch: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c2f/32c/c19/c2f32cc198581960f75958489f9edf55.png" title="It is convenient: when you read further"></a> <br><br>  Let's start with one client and two connection points. <br><br>  Client routers have a very simple configuration: <br><br>  <b>C3PO_1:</b> <br><pre> <code class="bash hljs">C3PO_1(config)<span class="hljs-comment"><span class="hljs-comment"># interface Loopback0 C3PO_1(config-if)# ip address 192.168.255.1 255.255.255.255 C3PO_1(config)# interface FastEthernet0/0 C3PO_1(config-f)# description To Linkmeup C3PO_1(config-if)# ip address 192.168.0.2 255.255.255.0 C3PO_1(config)# router ospf 1 C3PO_1(config-router)# network 192.168.0.0 0.0.255.255 area 0</span></span></code> </pre><br><br>  <b>C3PO_2:</b> <br><pre> <code class="bash hljs">C3PO_1(config)<span class="hljs-comment"><span class="hljs-comment"># interface Loopback0 C3PO_1(config-if)# ip address 192.168.255.2 255.255.255.255 C3PO_1(config)# interface FastEthernet0/0 C3PO_1(config-f)# description To Linkmeup C3PO_1(config-if)# ip address 192.168.1.2 255.255.255.0 C3PO_1(config)# router ospf 1 C3PO_1(config-router)# network 192.168.0.0 0.0.255.255 area 0</span></span></code> </pre><br>  Link addresses with the provider and the Loopback interface are configured on the client nodes (as before, we use this interface to simulate the network so as not to produce routers).  That is, if at <i>C3PO_2</i> we see the network 192.168.255.1/32, this means that we would see the entire network completely. <br>  OSPF is used as the local dynamic routing protocol.  Actually, it is he who will let the interested party know the address of the Loopback interface. <br><br>  <b>As for the network provider.</b> <br><br>  First, we will give a brief setup procedure, and then we will show with an example. <br><ul><li>  Setting up the basic connectivity of the backbone network: IP addresses, IGP. </li><li>  Enable MPLS and LDP </li><li>  Creating a VRF and binding to interfaces. </li><li>  Configure the routing protocol with CE. </li><li>  Configure BGP and MBGP </li></ul><br><br>  <b>1)</b> Configure IP-addresses: link and loopback.  We do not touch the client yet. <br><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#interface Loopback0 Linkmeup_R1(config-if)#ip address 1.1.1.1 255.255.255.255 Linkmeup_R1(config)#interface FastEthernet0/1 Linkmeup_R1(config-if)#description To Linkmeup_R2 Linkmeup_R1(config-if)#ip address 10.0.12.1 255.255.255.0</span></span></code> </pre><br>  <b><i>Linkmeup_R2</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R2(config)<span class="hljs-comment"><span class="hljs-comment">#interface Loopback0 Linkmeup_R2(config-if)#ip address 2.2.2.2 255.255.255.255 Linkmeup_R2(config)#interface FastEthernet0/0 Linkmeup_R2(config-if)#description To Linkmeup_R1 Linkmeup_R2(config-if)#ip address 10.0.12.2 255.255.255.0 Linkmeup_R2(config)#interface FastEthernet0/1 Linkmeup_R2(config-if)#description To &lt;i&gt;Linkmeup_R3&lt;/i&gt; Linkmeup_R2(config-if)#ip address 10.0.23.2 255.255.255.0</span></span></code> </pre><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#interface Loopback0 Linkmeup_R3(config-if)#ip address 3.3.3.3 255.255.255.255 Linkmeup_R3(config)#interface FastEthernet0/0 Linkmeup_R3(config-if)#description To Linkmeup_R2 Linkmeup_R3(config-if)#ip address 10.0.23.3 255.255.255.0</span></span></code> </pre><br>  <a href="https://docs.google.com/document/d/1K8rsLsuXT8lJ0g-_BawXojVFmd462ItpovLJLrOvz5Q/pub">Initial configuration file.</a> <br><br>  <b>2)</b> Now we are raising ISIS as IGP - it will link the entire network linkmeup, distributing route information about link and Loopback addresses. <br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#router isis 1 Linkmeup_R1(config-router)#net 10.0000.0000.0001.00 Linkmeup_R1(config)#interface FastEthernet 0/1 Linkmeup_R1(config-if)#ip router isis 1</span></span></code> </pre><br>  <b><i>Linkmeup_R2</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R2(config)<span class="hljs-comment"><span class="hljs-comment">#router isis 1 Linkmeup_R2(config-router)#net 10.0000.0000.0002.00 Linkmeup_R2(config)#interface FastEthernet 0/0 Linkmeup_R2(config-if)#ip router isis 1 Linkmeup_R2(config)#interface FastEthernet 0/1 Linkmeup_R2(config-if)#ip router isis 1</span></span></code> </pre><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#router isis 1 Linkmeup_R3(config-router)#net 10.0000.0000.0002.00 Linkmeup_R3(config)#interface FastEthernet 0/0 Linkmeup_R3(config-if)#ip router isis 1</span></span></code> </pre><br><br>  At this step, we got a global routing table - the necessary platform for the next step. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/447/017/1cc/4470171cc590fa86e35b72d72dd699a7.png"><br><br>  <b>3)</b> Turn on MPLS and LDP: <br><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#mpls ip Linkmeup_R1(config)#interface FastEthernet 0/1 Linkmeup_R1(config-if)#mpls ip</span></span></code> </pre><br>  <b><i>Linkmeup_R2</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R2(config)<span class="hljs-comment"><span class="hljs-comment">#mpls ip Linkmeup_R2(config)#interface FastEthernet 0/0 Linkmeup_R2(config-if)#mpls ip Linkmeup_R2(config)#interface FastEthernet 0/1 Linkmeup_R2(config-if)#mpls ip</span></span></code> </pre><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#mpls ip Linkmeup_R3(config)#interface FastEthernet 0/0 Linkmeup_R3(config-if)#mpls ip</span></span></code> </pre><br>  In this step, we have built LSPs between all LSR pairs: <br><img src="https://habrastorage.org/getpro/habr/post_images/1d8/f67/d77/1d8f67d77d1efb557a0fcec57e4304c8.png"><br>  <i>* An example of tag allocation on <i>Linkmeup_R1</i> .</i> <br><br>  This is the basis for VPN.  These LSPs are a set of transport labels. <br><blockquote>  We chose LDP here to keep the configuration simple.  With RSVP-TE we will also look into an article about Traffic Engineering. <br></blockquote><br><br>  <b>4)</b> Create a VRF on two nodes: <i>Linkmeup_R1</i> and <i>Linkmeup_R3</i> . <br><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf C3PO Linkmeup_R1(config-vrf)# rd 64500:100 Linkmeup_R1(config-vrf)# route-target both 64500:100</span></span></code> </pre><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf C3PO Linkmeup_R3(config-vrf)# rd 64500:100 Linkmeup_R3(config-vrf)# route-target both 64500:100</span></span></code> </pre><br>  This allows us to isolate all the data of one client from others and from the network of the provider. <br>  Here we indicate RD and RT.  Since we have a simple task - to connect all the branches of C3PO Electronic, we will make the RD and RT the same.  Moreover, RT on Import and RT on Export will also be the same.  Since this is a common practice, there is even a special directive - <b>both</b> - then both RTs are created immediately the same. <br>  In the 8th release, we chose the AS number for the network linkmeup - 64,500. It is used as an administrative field. <br>  The selected number is chosen arbitrarily, but is tracked so that there is no coincidence with another, already used. <br><br>  <b>5)</b> Bind the interfaces to the VRF and point them to the IP addresses. <br><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#interface FastEthernet0/0 Linkmeup_R1(config-if)# description To C3PO_Electronic_1 Linkmeup_R1(config-if)# ip vrf forwarding C3PO Linkmeup_R1(config-if)#ip address 192.168.0.1 255.255.255.0</span></span></code> </pre><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#interface FastEthernet0/1 Linkmeup_R3(config-if)# description To C3PO_Electronic_2 Linkmeup_R3(config-if)# ip vrf forwarding C3PO Linkmeup_R3(config-if)#ip address 192.168.1.1 255.255.255.0</span></span></code> </pre><br>  In the routing tables of VRF C3PO, configured networks should appear as Directly connected. <br><img src="https://habrastorage.org/getpro/habr/post_images/c18/0c5/d4e/c180c5d4e187f32c91f2b3d4a463153a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/754/f61/2a4/754f612a4f1ec39143a273e4cfa551f6.png"><br><br>  <b>6)</b> It is necessary to raise the routing protocol with the client.  In our case, it will be OSPF, although it could be ISIS or EBGP with equal success.  This process should not intersect with the global routing table, so we put it in the VRF: <br><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 vrf C3PO Linkmeup_R1(config-router)# network 192.168.0.0 0.0.255.255 area 0</span></span></code> </pre><br>  <b><i>Linkmeup_R3</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 vrf C3PO Linkmeup_R3(config-router)# network 192.168.0.0 0.0.255.255 area 0</span></span></code> </pre><br>  Given that the OSPF client is already configured, we should see the addresses of the Loopback interfaces in the routing table. <br><img src="https://habrastorage.org/getpro/habr/post_images/902/b1e/e2d/902b1ee2daa0d52f6c39d193711c7698.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/6df/662/950/6df662950304a5b78b96ebd1f5f38d4b.png"><br><br>  As you can see, <i>Linkmeup_R1</i> sees 192.168.255.1, but does not see the remote Loopback - 192.168.255.2.  Similarly, <i>Linkmeup_R3</i> sees only routes for its part.  This is because the client‚Äôs routes are not transmitted through the provider‚Äôs network yet. <br><br>  <b>7)</b> So it's MBGP time. <br>  Remember, we talked about <a href="http://linkmeup.ru/blog/154.html">BGP Free Core</a> in the last issue?  We can use this technique here.  Without need of BGP on <i>Linkmeup_R2</i> , we will not raise it there. <br><br>  <u>The first part</u> is the basic setting of iBGP neighbors. <br><br>  <b><i>Linkmeup_R1</i> :</b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#router bgp 64500 Linkmeup_R1(config-router)# neighbor 3.3.3.3 remote-as 64500 Linkmeup_R1(config-router)# neighbor 3.3.3.3 update-source Loopback0</span></span></code> </pre><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#router bgp 64500 Linkmeup_R3(config-router)# neighbor 1.1.1.1 remote-as 64500 Linkmeup_R3(config-router)# neighbor 1.1.1.1 update-source Loopback0</span></span></code> </pre><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second part</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ‚Äî setting the Address Family VPNv4 ‚Äî is what allows </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to transfer client routes. </font><font style="vertical-align: inherit;">Notice that we activate the transfer community, because this attribute is used by RT. </font></font><br><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R1(config-router)<span class="hljs-comment"><span class="hljs-comment"># address-family vpnv4 Linkmeup_R1(config-router-af)# neighbor 3.3.3.3 activate Linkmeup_R1(config-router-af)# neighbor 3.3.3.3 send-community both</span></span></code> </pre><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R3(config-router)<span class="hljs-comment"><span class="hljs-comment"># address-family vpnv4 Linkmeup_R3(config-router-af)# neighbor 1.1.1.1 activate Linkmeup_R3(config-router-af)# neighbor 1.1.1.1 send-community both</span></span></code> </pre><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The third part</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is the Address Family for this particular VRF. </font><font style="vertical-align: inherit;">It works with regular IPv4 prefixes, but from VRF C3PO Electronic. </font><font style="vertical-align: inherit;">It is needed in order to transfer routes between MBGP and OSPF. </font></font><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R1(config-router)<span class="hljs-comment"><span class="hljs-comment"># address-family ipv4 vrf C3PO Linkmeup_R1(config-router-af)# redistribute connected Linkmeup_R1(config-router-af)# redistribute ospf 2 vrf C3PO</span></span></code> </pre><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R3(config-router)<span class="hljs-comment"><span class="hljs-comment"># address-family ipv4 vrf C3PO Linkmeup_R3(config-router-af)# redistribute connected Linkmeup_R3(config-router-af)# redistribute ospf 2 vrf C3PO</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, route import from OSPF process number 2 is configured here. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Accordingly, you need to configure and import routes to OSPF from BGP: </font></font><br><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 Linkmeup_R1(config-router)# redistribute bgp 64500 subnets</span></span></code> </pre><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#router ospf 2 Linkmeup_R3(config-router)# redistribute bgp 64500 subnets</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now everything is wrapped, twisted. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Routes on PE: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/33a/180/09b/33a18009b7d0ecd7f26566477004f606.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3b/38b/31b/b3b38b31b6486b5a9e47beaa120e1462.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Routes on CE: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/812/5be/816/8125be816d033ad447dacb1282056103.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ping between client networks: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/a6f/7fd/281/a6f7fd281d30665c02b38fed37a20fed.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Attempting to ping provider network: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/23f/172/a3c/23f172a3c7b3c4b232c95b9a386c8803.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's nice.</font></font><br><hr><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Connecting a client via BGP</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Now connect the TAR'S Robotics client. </font><font style="vertical-align: inherit;">Routes between CE and PE will be sent over BGP or, in other words, we are raising EBGP with a client router. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Steps 4 and 5 will not be different. </font><font style="vertical-align: inherit;">We present the configuration of only one side:</font></font><br><pre> <code class="bash hljs">Linkmeup_R1(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf TARS Linkmeup_R1(config-vrf)#rd 64500:200 Linkmeup_R1(config-vrf)#route-target export 64500:200 Linkmeup_R1(config-vrf)#route-target import 64500:200 Linkmeup_R1(config)#interface FastEthernet1/0 Linkmeup_R1(config-if)#description To TARS_1 Linkmeup_R1(config-if)#ip vrf forwarding TARS Linkmeup_R1(config-if)#ip address 100.0.0.1 255.255.255.0</span></span></code> </pre><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> On CE, EBGP is configured in the most usual way. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARS_1:</font></font></b> <br><pre> <code class="bash hljs">TARS_1(config)<span class="hljs-comment"><span class="hljs-comment">#router bgp 64510 TARS_1(config-router)#network 172.16.255.1 mask 255.255.255.255 TARS_1(config-router)#neighbor 100.0.0.1 remote-as 64500</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is stated that TARS 'Robotics will announce its network 172.16.255.1/32. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSPF may still be needed, but it will already be used for routing within this branch and only. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">On PE, everything is the same, only there will not be a new OSPF process (because now the client has EBGP, instead of OSPF) and the address family is changing ipv4 vrf TARS: </font></font><br><br> <b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font></b> <br><pre> <code class="bash hljs">Linkmeup_R1(config-router)<span class="hljs-comment"><span class="hljs-comment">#address-family ipv4 vrf TARS Linkmeup_R1(config-router-af)#redistribute connected Linkmeup_R1(config-router-af)#neighbor 100.0.0.2 remote-as 64510 Linkmeup_R1(config-router-af)#neighbor 100.0.0.2 activate</span></span></code> </pre><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is </font><font style="vertical-align: inherit;">now </font><font style="vertical-align: inherit;">a BGP neighbor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARS_1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/780/fcd/edb/780fcdedbf441e3d11eb5b5724b25ec4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It will receive client networks with Update messages from CE. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Everything related to MBGP is the same. From the fact that we changed the client interaction protocol, nothing will turn over in it. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That is, now everything should work (if, of course, the second side is configured): The </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c4b/2d3/139/c4b2d313941886fe0de325ba8ec10f3b.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/664/353/f39/664353f39a5d84e1f8508d06ff12ddd9.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/61b/831/4c5/61b8314c577f663e45d548942891be27.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">complete configuration of all nodes </font></font><a href="https://docs.google.com/document/d/1KLzGUfB5j-DczWDnUyz_3ql7Zx7KO3pn_IOaxv_FSus/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">with</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="https://docs.google.com/document/d/1DbvOE2SanX1LPuuQ286jgqcxKCCVW7gxcfRPXJc4jJg/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">without </font></font></a><font style="vertical-align: inherit;"><a href="https://docs.google.com/document/d/1KLzGUfB5j-DczWDnUyz_3ql7Zx7KO3pn_IOaxv_FSus/pub"><font style="vertical-align: inherit;">comments</font></a><font style="vertical-align: inherit;"> .</font></font><br><hr><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What have we done?</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's now trace the distribution of tags. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's what gave </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> node </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/f00/2fb/15f/f002fb15f86bc70476e241441b8d0927.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You see mark 22 here for FEC 192.168.255.1 and Next Hop address 1.1.1.1. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How does the router understand it? </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In TM VRF C3PO, it enters information on which Next Hop: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/6e1/0f7/ad3/6e10f7ad34e8d84910212da16684221a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recursively calculate how 1.1.1.1 is available: The </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/e34/713/5c6/e347135c66baee42d75d77adc5e56bac.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">service label can be seen in the BGP table for VRF C3PO: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/e2c/8b4/4b7/e2c8b44b72c5e3e998a310cf553f93a7.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, Next Hop is also visible here. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transport label for FEC 1.1.1.1: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/e81/056/d36/e81056d368a0ad036bdf697ebae71462.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, as usual, the FIB contains all the relevant information without multiple appeals to the TM: the </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/182/ee9/92d/182ee992dd95714604c90fb9ec462def.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FIB tells us: pack a package with </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DIP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">192.168.255.1 to the stack of tags {17, 22} and send it towards 10.0.23.2 to the interface FE0 / 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Everything here is extremely clear and deterministic.</font></font><br><hr><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's summarize the L3VPN configuration steps from scratch in the correct order from general to specific. </font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure the IP addresses of the provider: link and loopback. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All nodes configured and forgotten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure IGP on the provider's network to provide internal connectivity. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All nodes configured and forgotten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure MPLS + LDP (or RSVP TE, if necessary). </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All nodes configured and forgotten</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure MBGP within the provider network. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only those PE, where there are customers, set up and forget</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure client VRFs, assign RD, RT. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only those PEs where there are customers will be personalized for everyone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add client interfaces to VRF, configure IP addresses on them. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only those PEs where there are customers will be personalized for everyone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If necessary, raise IGP / BGP with the client to exchange routes. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Only those PEs where there are customers will be personalized for everyone</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li><li>  Is done </li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">These were necessary and sufficient actions to configure the basic L3VPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, the last scenario in the framework of practice is</font></font><br><br><a name="VRF_INTERCONNECTION"></a><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPN interconnection </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Somewhere there - far above - we assumed the existence of a certain third client - R2D2, which has some views on C3PO - and in particular they have to exchange routes, while being in different VPNs. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here is the scheme: </font><font style="vertical-align: inherit;">Here we will work with RT - we will make the routes from VPN C3PO be transferred to R2D2 by BGP protocol. </font><font style="vertical-align: inherit;">Well, and back - where without it? </font><i><font style="vertical-align: inherit;">R2D2</font></i><font style="vertical-align: inherit;"> router configuration </font><font style="vertical-align: inherit;">:</font></font><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/c2f/32c/c19/c2f32cc198581960f75958489f9edf55.png" title="Click to open in a new tab - this is convenient: when you read further, you do not need to return to the top"></a> <br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><pre> <code class="bash hljs">R2D2(config)<span class="hljs-comment"><span class="hljs-comment">#interface Loopback0 R2D2(config-if)#ip address 10.22.22.22 255.255.255.255 R2D2(config)#interface FastEthernet0/0 R2D2(config-if)#description To Linkmeup R2D2(config-if)#ip address 10.22.22.2 255.255.255.252 R2D2(config)#router ospf 1 R2D2(config-router)#network 10.22.22.0 0.0.0.255 area 0</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuring VRF on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><pre> <code class="bash hljs">Linkmeup_R3(config)<span class="hljs-comment"><span class="hljs-comment">#ip vrf R2D2 Linkmeup_R3(config-vrf)#rd 64500:300 Linkmeup_R3(config-vrf)#route-target both 64500:300 Linkmeup_R3(config-vrf)#route-target import 64500:100 Linkmeup_R3(config-router)#interface FastEthernet1/1 Linkmeup_R3(config-if)#ip vrf forwarding R2D2 Linkmeup_R3(config-if)#ip address 10.22.22.1 255.255.255.252 Linkmeup_R3(config-vrf)#router ospf 3 vrf R2D2 Linkmeup_R3(config-router)#redistribute bgp 64500 subnets Linkmeup_R3(config-router)#network 10.22.22.0 0.0.0.3 a 0 Linkmeup_R3(config)#router bgp 64500 Linkmeup_R3(config-router)#address-family ipv4 vrf R2D2 Linkmeup_R3(config-router-af)#redistribute ospf 3</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, there is nothing new here, except for setting the route-target in the VRF. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, besides the usual command ‚Äúroute-target both 64500: 300‚Äù we also gave ‚Äúroute-target import 64500: 100‚Äù. </font><font style="vertical-align: inherit;">It means that you need to import routes from RT 645500: 100, that is, from VPN C3PO to VRF, as we wanted. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Immediately after this, the routes appear on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2D2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/461/a9d/8e9/461a9d8e914fdcf07f8934839a7fc292.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">After that, the ping successfully passes to 192.168.255.2: </font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/653/436/a56/653436a56b2f3c51ea2567f2e0d1b4f2.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, if you run the ping to the address 192.168.255.1, it will not pass.</font></font> Why? <br><img src="https://habrastorage.org/getpro/habr/post_images/1df/aee/a9c/1dfaeea9c968c363db58226c99df1fc2.png" width="644" title="WTF ?!"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For interest, you can add </font><font style="vertical-align: inherit;">Loopback 1 with address 10.20.22.22/32 </font><font style="vertical-align: inherit;">on </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARS_2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the same as Loopback 0 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">R2D2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and see what happens. </font></font><br><br> <a href="https://docs.google.com/document/d/1f1hnbKvHMrhkC3aY5tB_RzUs5kBZFaxh1yEB1YKGWP4/pub"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Complete configuration of all nodes for a VPN VPN interaction scenario.</font></font></a> <br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> VPN access to the Internet </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It may be that the provider in the same VPN also provides access to the Internet. </font><font style="vertical-align: inherit;">It is in the VPN, not a separate cable, not a separate VLAN, but access to the Internet through the same connection, through the same addresses. </font><font style="vertical-align: inherit;">This may also be the caprice of the customer. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The topic is interesting, but big, so I will reveal it a little later in a separate micro issue.</font></font><br><hr><br><br><a name="MPLS_TRACE"></a><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tracing MPLS L3VPN </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About a year ago I had a small article with tricky questions. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Among them was </font></font><a href="http://linkmeup.ru/blog/84.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> very relevant for us. </font></font><br><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's time to make it out better. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If suddenly, you didn‚Äôt know how regular tracing works, then </font><font style="vertical-align: inherit;">I‚Äôll briefly tell </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">you shame</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You send packets to the recipient with a gradually increasing TTL value. This is usually UDP, but it can be ICMP and even TCP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">First it is 1. The packet reaches the directly connected router, it reduces the TTL, sees that it is now zero, forms the message </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äútime exceeded in transit‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and sends it back to you. So at the address of the sender you know the first hop.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then it is 2. The packet reaches the second router. </font><font style="vertical-align: inherit;">The same thing happens, so you learned the next hop.</font></font><br><br>  ... <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, the TTL reaches N, the destination node receives the packet, sees that it is to it, forms the answer (in accordance with the protocol), by which you understand that everything is over and ends to the console. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition, you can add that at each iteration you send not one, but several packets (usually three). </font></font><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">What is special about tracing via L3VPN? </font></font></u> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As long as the packet is switched by labels, the values ‚Äã‚Äãof any fields of any headers deeper than MPLS have no meaning. </font><font style="vertical-align: inherit;">Including TTL. </font><font style="vertical-align: inherit;">Routers are oriented on the TTL in the MPLS header. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And when PE receives a packet from CE, there are two options:</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copy TTL value from IP header to MPLS (This is </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uniform</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mode </font><font style="vertical-align: inherit;">).</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Write in the TTL field of the MPLS 255 header (This is the </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pipe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Short-Pipe</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> mode </font><font style="vertical-align: inherit;">).</font></font></li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the first scenario, you can see each router on its way to the destination. </font><font style="vertical-align: inherit;">The result of the trace will be as follows: The </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b9c/5e4/48d/b9c5e448d78dab095bee18cb1293f986.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mechanics are as follows:</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the first step, nothing changes. </font><font style="vertical-align: inherit;">TARS_1 sends an ICMP request with TTL = 1. </font><font style="vertical-align: inherit;">R1 receives it, reduces the TTL to zero and sends </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äútime exceeded in transit‚Äù</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> to TARS_1 </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">The first hop (R1) is ready.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> TARS_1 sends an ICMP request with TTL = 2. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARS_1 sends an ICMP request with TTL = 3. </font><font style="vertical-align: inherit;">It reaches R3, which sees an MPLS TTL value of 1 at the moment, reduces it to 0 and returns </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"time exceeded in transit"</font></font></i> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TARS_1 sends an ICMP request with TTL = 4. </font><font style="vertical-align: inherit;">R3 reduces MPLS TTL to 1, removes the label, copies MPLS TTL value to IP TTL. </font><font style="vertical-align: inherit;">And then the package safely comes to TARS_2, he sends a response on the successful completion. </font><font style="vertical-align: inherit;">Tracing finished.</font></font></li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And what if I have a logical desire for customers not to see the topology of my network with their own traces? </font><font style="vertical-align: inherit;">We must ban, you say. </font><font style="vertical-align: inherit;">As the father of a two-year-old daughter, I tell you: no need to ban. </font><font style="vertical-align: inherit;">It is possible and necessary to act smarter - I simply will not reduce the TTL MPLS to zero inside my network. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The second scenario is used for this - set the MPLS TTL to 255. In this case, when tracing from TARS_1, you will see the following path: R1R3TARS_2.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/285/c4b/716/285c4b7160c774e1d146ae9fdcb4b262.png"><br><br><ol><li> TARS_1  ICMP-  TTL=1. R1  ,  TTL      TARS_1 <i>¬´time exceeded in transit¬ª</i> .   (R1) . </li><li> TARS_1  ICMP-  TTL=2. </li><li> TARS_1  ICMP-  TTL=3.     TARS_2,    .  . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And no matter how many transit P routers, TTL = 3 will always suffice when tracing from TARS_1 to TARS_2. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The default behavior is different for vendors. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tsisk believes that the engineer knows what he is doing and what he faces every action, so he chooses the first path, and, for example, Huawei prefers to play it safe - it‚Äôs better to ban it first, so that it does not work out, and then the engineer will allow if necessary. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In any case, the mode can always be changed - in our case, in the global configuration mode, you need to give the command ‚Äúno mpls ip propagate-ttl‚Äù for this. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A wonderful fifty- </font></font><a href="http://www.nanog.org/meetings/nanog47/presentations/Sunday/RAS_Traceroute_N47_Sun.pdf"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">three-page</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tracing document at </font><a href="http://www.nanog.org/meetings/nanog47/presentations/Sunday/RAS_Traceroute_N47_Sun.pdf"><font style="vertical-align: inherit;">nano.org</font></a><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, for MPLS there are </font></font><a href="http://blog.ine.com/2008/11/24/mpls-ping-and-traceroute/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">special utilities of ping and tracing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><a name="FAQ"></a><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Q &amp; A </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wonderful chapter Questions and Answers. </font><font style="vertical-align: inherit;">I really like it, because here you can shove everything that was not enough space in the main article. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q1:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Can we say that P is Intermediate LSR, and PE is LER?</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Strictly speaking, no. </font><font style="vertical-align: inherit;">At a minimum, because the concepts LER, LSR are basic MPLS and relate to the LSP, and P, PE, CE are only in a VPN. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Although, of course, usually the node to which the client is connected performs the role of Ingress / Egress LSR in MPLS and the role of PE in VPN.</font></font><br></blockquote><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q2:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Why is MBGP a MultiProtocol BGP, and not, for example, MPLS BGP? </font><font style="vertical-align: inherit;">What is multiprotocol in it?</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The BGP task is to transmit routes. </font><font style="vertical-align: inherit;">Historically and classically, this is IPv4. </font><font style="vertical-align: inherit;">But in addition to the usual prefixes, BGP can transmit a lot of others: IPv6, IPX, Multicast, VPN. </font><font style="vertical-align: inherit;">Each type of prefix is ‚Äã‚Äãconfigured as a separate Address Family - that is, a group of addresses of the same type. </font><font style="vertical-align: inherit;">Actually, it is for this opportunity to transmit routing data of different protocols of such BGP and received the name MBGP.</font></font><br></blockquote><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q3:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Where are the routes, RDs and their attributes in MBGP transmitted?</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RD is part of the VPNv4 route and is transmitted along with it in the NLRI section - Network Layer Reachability Information. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RT is transmitted in the Extended Community section, as it is inherently. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In general, many of the attributes of the VPN route in the BGP Update message are moved to a special section - MP_REACH_NLRI, of which the usual NLRI and Next-Hop are a part.</font></font><br></blockquote><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q4:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> So what's the difference between RD and RT? Why is not enough just one of them? And I understood correctly: RD is not a VPN identifier, like RT?</font></font><br><blockquote> ,  RD,  RT    VPN.    VPN        RD/RT,          RD/RT. <br><br>  : <br> RD ‚Äî Route Distinguisher ‚Äî      ‚Äî  ,      MBGP ‚Äî      VPN      . RD   PE,      /    . <br> RT ‚Äî Route Target.       VPN,        VRF,   .           VRF         VRF      .   Extended Community. <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">One RD is not enough, because PE will not know how to properly manage routes. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And one RT is not enough, because the routes will mix during transmission and all but one will be lost. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It would be possible to leave only the RD, for example, and on its basis decide where the route should go, but this is not flexible and goes against the principles of BGP.</font></font><br></blockquote><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q5:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Young, man, we are a large operator, we are doing serious things - we are building Adnvanced LTE, while we support 2G, we do not have clients who want a VPN, your giant article is useless for us.</font></font><br><blockquote>   .      ‚Äî          . <br> ,           2G, 3G, 4G     5G,    Mobile Backhaul ( <a href="http://lookmeup.linkmeup.ru/">MBH</a> )     5 VPN:            .         ,  ,   .        Traffic Engineering‚Ä¶ <br>          VPN   MBH ‚Äî       Core Network:  2G    BSC,  3G ‚Äî RNC,  4G ‚Äî MME.             . <br><br>    :     MVNO ‚Äî Mobile Virtual Network Operator ‚Äî    MBH      .       <s> </s> . <br><br>    , , MPLS VPN ‚Äî  -       . <br></blockquote><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">B6:</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I will not understand: how Egress PE, having received a packet with one label, that is, if PHP occurred, determines that this VPN label is not a transport tag, and, accordingly, that the label needs to be sent to the VRF, and not to be connected where next?</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It's very simple - the label space for VPN, for LSP, for all sorts of FRR and CSC is common. </font><font style="vertical-align: inherit;">It cannot be that for the VPN and for the LSP the same tag has been allocated. </font><font style="vertical-align: inherit;">Well, each tag when it is created is assigned its role and actions when it is received.</font></font><br></blockquote><br><br><hr><br><br><a name="LINKS"></a><br><h1>  useful links </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I keep on saying that all terms and abbreviations used in the article can be found in the </font></font><a href="http://lookmeup.linkmeup.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lookmeup</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> glossary </font><font style="vertical-align: inherit;">. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Okay, I dissemble: not all, but only the majority</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Beloved by me Jeff Doyle: VPN in two parts: </font></font><a href="http://www.networkworld.com/article/2350732/cisco-subnet/understanding-mpls-vpns--part-i.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part I</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><a href="http://www.networkworld.com/article/2350840/cisco-subnet/understanding-mpls-vpns--part-ii.html"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Part II</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jeremy Stretch: </font></font><a href="http://packetlife.net/blog/2013/jun/10/route-distinguishers-and-route-targets/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Route Distinguishers and Route Targets</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> writes about the differences between RD and RT </font><font style="vertical-align: inherit;">.</font></font><br><br><hr><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As you can see, creating L3VPN is a lot of manual work. And if necessary, to organize the interaction between the VPN, you have to configure not only one Internet gateway, even in the most correct and beautiful way, but also client PE. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But all this work is necessary, there is no redundancy. For contrast, remember what setup you get up to, VPN with GRE or VRF-Lite. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And note that the P- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Linkmeup_R2</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> router has </font><font style="vertical-align: inherit;">remained completely unchanged during all stages of configuration since the initial inclusion of MPLS on it. Isn't that pretty ?!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is not to say that we embraced the whole L3VPN with this small article, in particular, such interesting things as Inter-AS VPN, of which 3 types, and CSC (Carrier Support Carrier) remained outside the general picture. </font><font style="vertical-align: inherit;">But I hope to write a separate article specifically on these two mechanisms. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">L3VPN is a mature, well thought out and standardized thing. </font><font style="vertical-align: inherit;">All manufacturers, it works plus / minus the same. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But ahead there is another article about L2VPN, which will include AToM, VLL, PWE3 and VPLS. </font><font style="vertical-align: inherit;">In it we learn the role played by Cisco and Juniper in the development of this direction, what </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in our lives bring services such as CES or EoMPLS. </font><font style="vertical-align: inherit;">Be patient - this year I will try to increase the pace, gain momentum, unwind and increase efficiency.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The video used podsafe-music</font></font></b> <div class="spoiler_text"> <a href="http://promodj.com/FROSTMILES/tracks/5445278/FROST_MILES_There_is_no_escape">FROST MILES-There is no escape</a> <br> <a href="http://promodj.com/FROSTMILES/tracks/5627654/FROST_MILES_SUNSHINE_ORIGINAL_MIX">FROST MILES-SUNSHINE(ORIGINAL MIX)</a> <br> <a href="http://promodj.com/FROSTMILES/tracks/3153289/FROST_MILES_NAChALNII_PUNKT_KONEChNII_PUNKT">FROST MILES- ‚Ä¶  </a> <br> <a href="http://promodj.com/antonsavelyev/tracks/5627755/Dj_Anton_Savelyev_Illusion">Dj Anton Savelyev ‚Äî Illusion</a> <br> <a href="http://promodj.com/znsoft/tracks/5598578/recca2">znsoft-recca2</a> <br> <a href="http://promodj.com/konnorkreed/tracks/5576807/2_K_K_Koncovka_igri_Game_8_bit_world">[K][K] ‚Äî   [Game ¬´8-bit world¬ª]</a> <br></div></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Project illustrator - </font></font><a href="https://www.instagram.com/pogo.possum/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anastasia Metzler</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For assistance in preparing the article, thank you </font></font><a href="http://habrahabr.ru/users/jdima/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JDima</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Stay in touch.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All issues</font></font></b> <div class="spoiler_text"> <a href="http://linkmeup.ru/blog/154.html">10.    .  .  MPLS</a> <br> <a href="http://linkmeup.ru/blog/129.html">9.    .  . </a> <br> <a href="http://linkmeup.ru/blog/92.html">8.1    .  ‚Ññ3. IBGP</a> <br> <a href="http://linkmeup.ru/blog/65.html">8.    .  . BGP  IP SLA</a> <br> <a href="http://linkmeup.ru/blog/50.html">7.    .  .</a>  <a href="http://linkmeup.ru/blog/50.html">VPN</a> <br> <a href="http://linkmeup.ru/blog/33.html">6.    .  .  </a> <br> <a href="http://linkmeup.ru/blog/16.html">5.    :  . NAT  ACL</a> <br> <a href="http://linkmeup.ru/blog/15.html">4.    :  . STP</a> <br> <a href="http://linkmeup.ru/blog/14.html">3.    :  .  </a> <br> <a href="http://linkmeup.ru/blog/13.html">2.    .</a>  <a href="http://linkmeup.ru/blog/13.html">Part two.</a>  <a href="http://linkmeup.ru/blog/13.html">Switching</a> <br> <a href="http://linkmeup.ru/blog/12.html">1.    .</a>  <a href="http://linkmeup.ru/blog/12.html">Part one.</a> <a href="http://linkmeup.ru/blog/12.html">   cisco</a> <br> <a href="http://linkmeup.ru/blog/11.html">0.    .  .</a>  <a href="http://linkmeup.ru/blog/11.html">Planning</a> <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/273679/">https://habr.com/ru/post/273679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273667/index.html">A bit about trends in the field of supercomputers</a></li>
<li><a href="../273669/index.html">An attempt to measure talent failed ...</a></li>
<li><a href="../273671/index.html">Seven things useful to know about programmers</a></li>
<li><a href="../273673/index.html">Relocation of IT-person to Germany: from A to Z</a></li>
<li><a href="../273677/index.html">Layout letters: 60 useful resources, guides and research</a></li>
<li><a href="../273681/index.html">HPE offers Composable Infrastructure</a></li>
<li><a href="../273683/index.html">Java instead of groovy</a></li>
<li><a href="../273685/index.html">40 books and educational resources for the study of the stock market and algorithmic trading</a></li>
<li><a href="../273687/index.html">Data structure 2-3-4 tree</a></li>
<li><a href="../273689/index.html">Forecast 2016: Android attacks and large-scale infections are among the main security threats.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>