<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Quick helpers for your Asterisk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article summarizes the intermediate results in developing my applications for asterisk. It all started during the New Year holidays, when I wante...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Quick helpers for your Asterisk</h1><div class="post__text post__text-html js-mediator-article">  This article summarizes the intermediate results in developing my applications for asterisk.  It all started during the New Year holidays, when I wanted to make a <a href="http://habrahabr.ru/post/248263/">quick voice dialing on asterisk</a> .  Then the <a href="http://habrahabr.ru/post/252733/">search for the direction by caller number</a> was implemented (useful thing for incoming calls to 8-800 numbers).  Then there was a pair of custom projects.  And recently also <a href="http://habrahabr.ru/post/258971/">LCR for asterisk</a> .  All these applications are developed using the <a href="https://github.com/antirek/ding-dong">ding-dong</a> library, which allows you to work with AGI (Asterisk Gateway Interface) in the node.js application. <br><br>  Next, I would like to show that using node.js and ding-dong, you can quickly develop useful applications for asterisk. <br><a name="habracut"></a><br>  During these six months, <a href="https://github.com/antirek/ding-dong">ding-dong</a> (fork of the <a href="https://github.com/brianc/node-agi">node-agi</a> project) began to support the promise style (thanks to my colleague Denis), as well as the full range of AGI functions. <br><br>  But before writing the application I want to talk a little about the other first.  Next, a little in the format of the conversation "with himself." 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <strong>What is the problem, bro?</strong> <br><br>  I configure asterisks a lot.  Often, customers require interesting pieces that are quite realistic for themselves to implement using an asterisk.  Moreover, it is often possible to implement the required functionality in different ways.  But often the addition of this functionality complicates the asterisk dialplan so much that it becomes difficult to maintain all the chips in working condition. <br><br>  Moreover, if one person has somehow been configured and configured, then it is fit to write a manual on how to figure out the other one and correct or reconfigure something. <br><br>  Here is <a href="http://habrahabr.ru/post/244131/">an example of a great recipe</a> for single playback.  And you want to come up with a chip, develop, test, and only then put on the client's working system, and even quickly and with minimal changes.  And all other customers to put one little finger. <br><br>  Many people use products like FreePBX or Elastix, where typical things are performed in a typical way.  But if something is non-standard, then "scripting" in files of the type "* _custom.conf" begins <br><br>  <strong>And what do you suggest?</strong> <br><br>  Not a silver bullet, of course.  Roughly speaking, the asterisk dialplan can be divided into two parts: the actual routing of the call and the accompanying auxiliary calculations, the result of which determines the further route of the call. <br><br>  So we must bring these calculations beyond the limits of the asterisk dialplan. <br><br>  This approach is very well illustrated by the applications agi-number-archer and lcr-finder, i.e.  at the entrance we give the phone number, at the exit we get the name or code. <br><br>  lcr-finder: as a result, it gives the name of the operator with the lowest cost of the call for the called number. <br>  agi-number-archer: as a result, gives the region by caller number. <br><br>  The dialplan of the asterisk that uses such an application absolutely does not know how this service works, it works on node.js or twisted, the MySQL or MongoDB database is used.  Moreover, the dialplan should be written in such a way as to have the option of passing the call in the absence of data from the service. <br><br>  For example, in the lcr-finder it became possible to disconnect the operator from the least cost search, but from the point of view of the asterisk dialplan, nothing has changed, the application has updated, and in a working asterisk even the 'dialplan reload' was not done. <br><br>  Still as an example.  The first version of voicer sent a command to call the asterisk by the number found.  The current version of voicer simply returns the number found, allowing the dialplan to analyze the result, make the call, handle the call status. <br><br>  <b>OK, AGI is cool.</b>  <b>And why the server, and not the script?</b> <br><br>  Because it is a fully working service that is ready at any moment to respond to an AGI request that keeps logs about its work. <br><br>  I also have several asterisks working on the same network, for each of them to raise my own server to determine the direction is somehow redundant, updating the script also on all the machines was more time-consuming task than on one. <br><br>  Moreover, the presence of the monitoring system and the process manager also help.  The monitoring system will monitor the server that is running, detailed logs will help to clarify the details, and restart the process manager (such as pm2) in the event of a crash due to errors in processing requests. <br><br>  * It should be noted on the whole of this approach was influenced by the <a href="http://12factor.net/">manifest of 12 factorial applications</a> ( <a href="http://habrahabr.ru/post/258739/">translation</a> ). <br><br>  <b>OK, server.</b>  <b>And why node.js?</b> <br><br>  Mmm, should have taken php?  But seriously, the same <a href="http://enricosimonetti.com/asterisk-fastagi-with-php/">can be done in php</a> .  But I liked the use of npm to quickly develop and distribute the application.  Initially, the callback functions were strained, but now the ding-dong supports the promise style, so you can write neat scripts, including cyclic ones (see the voicer code). <br><br>  Maybe something more productive than node.js?  I do not have millions of requests per second, everything works ok.  Perhaps, on more loaded systems it is necessary to use something else (although the asterisk also may have to be changed). <br><br>  <b>Are there alternatives to ding-dong?</b> <br><br>  Of course, for example, recently there was a <a href="https://github.com/tcncloud/agi-node">great option for an agi-server</a> on js.  It has a mapper of requests to AGI, i.e.  You can describe several scenarios and hang them on different uri_string on the same port, for php there are phpagi, <a href="https://github.com/marcelog/FastPAGI">fast-pagi</a> .  In general, the point is not in the programming language, but in the approach. <br><br>  <b>Can we already write helloWorld using AGI?</b> <br><br>  So.  Let's see how ding-dong can help us quickly develop an application. <br><br>  The main feature of using AGI is the transfer of the work of managing a dialplan to a third-party application, i.e.  our server.  Let's write such a simple dialplan. <br><br><pre><code class="bash hljs">extensions.conf [default] exten =&gt; _X.,1,AGI(agi://localhost:3000) exten =&gt; _X.,n,Verbose(DIALPLAN_VARIABLE)</code> </pre> <br><br>  Your subscriber's call to the default context will be monitored by an AGI server.  Let's write a simple AGI server. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> AGIServer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'ding-dong'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handler = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="hljs-function">) </span></span>{ context.onEvent(<span class="hljs-string"><span class="hljs-string">'variables'</span></span>) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">vars</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.answer(); }) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.streamFile(<span class="hljs-string"><span class="hljs-string">'beep'</span></span>); }) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.setVariable(<span class="hljs-string"><span class="hljs-string">'DIALPLAN_VARIABLE'</span></span>, <span class="hljs-string"><span class="hljs-string">'helloWorld'</span></span>); }) .then(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> context.end(); }); }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> agi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AGIServer(handler); agi.start(<span class="hljs-number"><span class="hljs-number">3000</span></span>);</code> </pre><br><br>  Now, saving and reloading the dialplan, launching the AGI server, make a call.  We have to hear the "beep", and in the asterisk console in verbose helloWorld should be displayed. <br><br>  To our AGI server, which is running on port 3000, we have to give the handler function, which will drive the call.  To interact with the channel there is a context.  When a call arrives at the AGI server, the variables event occurs.  When calling, the vars data set is also transmitted.  It contains time, dialed number, peer caller and more. <br><br>  Also further through context we can send commands to the call channel, here in the example context loses the sound beep with the streamFile command. <br><br>  At the end, we do context.end (), which closes the session.  Dialplan asterisk passes on. <br><br>  The example also has context.setVariable (), a function that sets a dialplan variable.  Those.  we can save our result to the dialplan variable, and then the dialplan itself will decide what to do with it.  This variable may have a peer name, where to call, or an order number, or something else. <br><br>  Also using context we can send commands to receive DTMF, write to the file, pronunciation of numbers and other functions of the asterisk. <br><br>  And, of course, in the handler, we have to do all the useful work for which we sent the call control to AGI, be it data retrieval in the database, speech recognition, something else. <br><br>  This example is on github: <a href="https://github.com/antirek/ding-dong-sample">github.com/antirek/ding-dong-sample</a> <br><br>  <b>Disadvantages?</b> <br><br>  Overall, quite comfortable.  Perhaps the most inconvenient thing you had to deal with was the impossibility of transferring files via AGI.  Those.  if an asterisk knew how to write a file, and then transfer it via AGI, then voicer would be a bit easier to configure. <br><br>  <b>What else can be realized with this approach?</b> <br>  For example, I suppose that some of the tasks ( <a href="http://asterisk-support.ru/question/50392/premium-rates-numbers/">one</a> , <a href="http://asterisk-support.ru/question/58730/avtomaticheskoe-perekliuchenie-ivr-v-elastix/">two</a> , <a href="http://asteriskforum.ru/viewtopic.php%3Fp%3D80493">three</a> , <a href="http://asteriskforum.ru/viewtopic.php%3Fp%3D80494">four</a> ) could be solved by writing a small AGI server and giving it a search for a solution, rather than writing scripts in bash.  And it would be more convenient to use. <br><br>  Also, for example, you can implement an alert on the status of the order when you enter the order number by the DTMF, gather information about completed work on requests, listen to files.  Those.  for writing small, simple and functional scripts is enough. <br><br>  <b>And in the end?</b> <br><br>  Of course, AGI is not the first day.  And there are already many scripts and applications that use this method of interaction with the asterisk, sharing with it the tasks it performs.  I hope that these applications, as well as the information presented in the note, will be useful. <br><br>  <a href="https://github.com/antirek/ding-dong">ding-dong</a> , <a href="https://github.com/antirek/voicer">voicer</a> , <a href="https://github.com/antirek/agi-number-archer">agi-number-archer</a> , <a href="https://github.com/antirek/lcr-finder">lcr-finder</a> <br>  <a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk%2B13%2BAGI%2BCommands">AGI</a> functions <a href="https://wiki.asterisk.org/wiki/display/AST/Asterisk%2B13%2BAGI%2BCommands">on the Asterisk site</a> <br><br>  I would be happy to comment on the article, proposals for the development, constructive criticism. </div><p>Source: <a href="https://habr.com/ru/post/260851/">https://habr.com/ru/post/260851/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../260839/index.html">Metalworking - 2015, part two: welding, roboruki, manipulators, tumbling</a></li>
<li><a href="../260841/index.html">Google Cloud Messaging: ‚ÄúOwl, discover! Push has come! ‚Äù</a></li>
<li><a href="../260845/index.html">Stream data processing with Akka</a></li>
<li><a href="../260847/index.html">Hosting for business. The story of one move</a></li>
<li><a href="../260849/index.html">WorkFlowSoft - a tool for organizing the work of the company</a></li>
<li><a href="../260855/index.html">How DIY robots will change education by 2035</a></li>
<li><a href="../260859/index.html">Hola prizes: consolatory and not only</a></li>
<li><a href="../260861/index.html">Dirty reverse engineering solutions</a></li>
<li><a href="../260863/index.html">SED: path from easy to hard</a></li>
<li><a href="../260865/index.html">Choosing a text editor or "I want everything in one"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>