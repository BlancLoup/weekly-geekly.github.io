<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How not to write too much. No magic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go 
 Recently I published my first article on Habr√©. And the first pancake flew right to my head. 12k views and plus 4 stars on the githaba ... Well, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How not to write too much. No magic</h1><div class="post__text post__text-html js-mediator-article"><p>  Go <img src="https://habrastorage.org/getpro/habr/post_images/5ca/895/c98/5ca895c98b635c172f3a79fa4d883d1f.png" alt="img"><br>  Recently I published my <a href="https://habrahabr.ru/post/317970">first article</a> on Habr√©.  And the first pancake flew right to my head.  12k views and plus 4 stars on the githaba ... Well, I‚Äôm guilty myself, I shouldn‚Äôt have to do nonsense on the lessons of Russian language and literature.  If I understood correctly, the problem was that I immediately got to the bottom.  He poured everything in the forehead.  Not met with parents, so to speak.  And what about <a href="http://jeta.brooth.org/">Jeta</a> , how does it work, what happens behind the scenes?  <a href="https://projectlombok.org/">Magic is what I am</a> ... Nobody needs magic in projects, right? </p><br><p>  <em>"From where do you have confidence that someone needs your library at all?"</em>  ask the <a href="https://habrahabr.ru/post/317880">average habrochanin</a> .  From there, that every day, hanging up another annotation or just looking at the code, I think, <em>"God, this is great!"</em>  .  Who will refuse this? </p><br><p>  Okay, let's do it first and in order. </p><a name="habracut"></a><br><p> <a href="http://jeta.brooth.org/">Jeta</a> is a framework for generating source code from annotations, built on <code>javax.annotation.processing</code> .  What is <em>Annotation Processing</em> can be read, for example, <a href="https://habrahabr.ru/company/e-Legion/blog/206208">here</a> or <a href="https://habrahabr.ru/post/200354">here</a> .  In short, this is a poorly documented technology, available with Java 1.5 (but better than 1.6), which allows you to walk through the <a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">AST of</a> your project, with your processor, to process your annotations in a way that is pleasing to you.  And do all this just before compiling.  Monsters like <a href="http://square.github.io/dagger">dagger</a> , <a href="https://google.github.io/dagger">dagger 2</a> , <a href="http://jeta.brooth.org/">jeta</a> , <a href="http://androidannotations.org/">android annotations</a> and others are built on this.  In my opinion, <em>Java Annotation Processing</em> is undervalued technology, and for reflexes like me, this is the only way to program a programmer.  Fortunately, with the advent of Android, the situation began to change.  It's time to join the beautiful! </p><br><p>  Here are the goals I pursued while working on the project: </p><br><ul><li>  Ease of writing custom annotation processors. </li><li>  Finding errors at compile time (if possible). </li><li>  Each component of the framework must be replaceable.  Don't like how <code>FooController</code> works?  Write your implementation!  And do not forget to share with the community, pull requests are welcome! </li><li>  Work speed  I wanted to minimize overhead as much as possible - thereby personally hammering the nail in <del>  head </del>  <em>Java</em> coffin lid <em>reflection</em> . </li></ul><br><p>  But this is not all, "batteries included"!  All that is necessary for comfortable work is already written: <a href="http://jeta.brooth.org/guide/inject.html">Dependecy Injection</a> , <a href="http://jeta.brooth.org/guide/event-bus.html">Event Bus</a> , <a href="http://jeta.brooth.org/guide/validator.html">Validators</a> , <a href="http://jeta.brooth.org/guide.html">etc.</a>  All in accordance with the principles described above.  And yet, <a href="http://jeta.brooth.org/guide/collector.html">Collectors</a> are available from the box.  It is by their example that we will deal with how the framework works. </p><br><h2 id="spherical-cow">  Spherical cow </h2><br><p>  Suppose there is an event handler in our project.  Now it does not matter what kind of events, it can be push-messages, state-machine states or commands from the user.  ABOUT!  let's get these commands from the user.  Moreover, the topic of writing chat bots is now relevant. </p><br><p>  So, we need handlers: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GreetingCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ System.out.print(<span class="hljs-string"><span class="hljs-string">"Hi! How are you?"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExitCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ System.out.print(<span class="hljs-string"><span class="hljs-string">"Bye!"</span></span>); System.exit(<span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre> <br><p>  CPU: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, CommandHandler&gt; handlers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"Input command. Type 'exit' to finish."</span></span>); Scanner input = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Scanner(System.in); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { String command = input.next(); CommandHandler handler = handlers.get(command); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(handler == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) System.out.println(<span class="hljs-string"><span class="hljs-string">"Unknown command '"</span></span> + command + <span class="hljs-string"><span class="hljs-string">"'. Try again"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> handler.handle(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandProcessor().loop(); } }</code> </pre> <br><p>  Now we need to associate user commands with the appropriate handlers.  I know that the fashion for XML has died down, but nevertheless, it is with the help of XML that most programmers solve such problems.  Well, XML is so XML .. </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"greet"</span></span></span><span class="hljs-tag">&gt;</span></span>org.brooth.jeta.samples.command_handler.commands.GreetingCommand<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hanler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"exit"</span></span></span><span class="hljs-tag">&gt;</span></span>org.brooth.jeta.samples.command_handler.commands.ExitCommand<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hanler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  parsim! </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, CommandHandler&gt; handlers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CommandProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ parseHandlers(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseHandlers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { DocumentBuilder documentBuilder = DocumentBuilderFactory.newInstance().newDocumentBuilder(); Document document = documentBuilder.parse(<span class="hljs-string"><span class="hljs-string">"handlers.xml"</span></span>); NodeList nodes = document.getDocumentElement().getElementsByTagName(<span class="hljs-string"><span class="hljs-string">"handler"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; nodes.getLength(); i++) { Node node = nodes.item(i); handlers.put(node.getAttributes().getNamedItem(<span class="hljs-string"><span class="hljs-string">"command"</span></span>).getTextContent(), (CommandHandler) Class.forName(node.getTextContent()).newInstance()); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Failed to parse handlers.xml"</span></span>, e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{...} }</code> </pre> <br><p>  Run, check! </p><br><pre> <code class="markdown hljs">Input command. Type 'exit' to finish. greet Hi! How are you? fine! Unknown command 'fine!'. Try again exit Bye!</code> </pre> <br><p>  Works great!  Let's write something else!  We will display the current time using the <code>time</code> command! </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimeCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">"It's "</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">"HH:mm"</span></span>).format(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date())); } }</code> </pre> <br><p>  Run .. </p><br><pre> <code class="markdown hljs">Input command. Type 'exit' to finish. time Unknown command 'time'. Try again</code> </pre> <br><p>  Heck!  Well, no need to be nervous.  Now I‚Äôll quickly add a new handler to <code>handers.xml</code> and restart.  Delov then!  Same not real Enterprise project which gathers 5 minutes and as much more is started!  <em>Well, you understand ...</em> </p><br><h2 id="jeta-in-action">  Jeta in action </h2><br><p>  And what does Jeta offer us?  Jeta offers <a href="http://jeta.brooth.org/guide/collector.html">collectors</a> !  Handlers will be automatically compiled at any time, I guarantee it! </p><br><p>  <a href="http://jeta.brooth.org/guide/install.html">Connect the</a> library ( <code>build.gradle</code> ): </p><br><pre> <code class="hljs cs">buildscript { repositories { maven { url <span class="hljs-string"><span class="hljs-string">'https://plugins.gradle.org/m2/'</span></span> } } dependencies { classpath <span class="hljs-string"><span class="hljs-string">'net.ltgt.gradle:gradle-apt-plugin:0.9'</span></span> } } apply plugin: <span class="hljs-string"><span class="hljs-string">'java'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'net.ltgt.apt'</span></span> repositories { jcenter() } dependencies { apt <span class="hljs-string"><span class="hljs-string">'org.brooth.jeta:jeta-apt:+'</span></span> compile <span class="hljs-string"><span class="hljs-string">'org.brooth.jeta:jeta:+'</span></span> }</code> </pre> <br><p>  Create a <code>Command</code> annotation and hang it on our handlers: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> Command { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Command</span></span>(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExitCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{...} <span class="hljs-meta"><span class="hljs-meta">@Command</span></span>(<span class="hljs-string"><span class="hljs-string">"greet"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GreetingCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{...} <span class="hljs-meta"><span class="hljs-meta">@Command</span></span>(<span class="hljs-string"><span class="hljs-string">"time"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TimeCommand</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandHandler</span></span></span><span class="hljs-class"> </span></span>{...}</code> </pre> <br><p>  We finish <code>CommandProcessor</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@TypeCollector</span></span>(Command.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, CommandHandler&gt; handlers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CommandProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//parseHandlers(); collectHandlers(); } private void collectHandlers() { Metasitory metasitory = new MapMetasitory(""); List&lt;Class&lt;?&gt;&gt; types = new TypeCollectorController(metasitory, getClass()).getTypes(Command.class); for (Class handlerClass : types) { try { Command command = (Command) handlerClass.getAnnotation(Command.class); handlers.put(command.value(), (CommandHandler) handlerClass.newInstance()); } catch (Exception e) { throw new RuntimeException("Failed to collect handlers", e); } } } private void parseHandlers() {...} public void loop() {...} public static void main(String[] args) {...} }</span></span></code> </pre> <br><p>  AND... </p><br><pre> <code class="markdown hljs">Input command. Type 'exit' to finish. greet Hi! How are you? fine Unknown command 'fine'. Try again time It's 16:28 exit Bye!</code> </pre> <br><br><h2 id="behind-the-scenes">  Behind the scenes </h2><br><p><img src="https://raw.githubusercontent.com/brooth/jeta-site/master/mysite/static/images/at_runtime.png" alt="runtime"><br>  I promised without magic?  So, in order: </p><br><h3 id="master">  Master </h3><br><p>  There is nothing complicated in the context of the framework, the master is the class for which the metocode is generated.  In our <code>CommandProcessor</code> , this is the <code>CommandProcessor</code> , since  it uses the <code>@TypeCollector</code> annotation. </p><br><h3 id="metacode">  Metacode </h3><br><p>  Metacode - generated (for the master) class.  It is located in the same package as its master (calm, not physically), and has a <code>&lt;Master name&gt; + "_Metacode"</code> name: <code>&lt;Master name&gt; + "_Metacode"</code> .  In our example, this is <code>CommandProcessor_Metacode</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandProcessor_Metacode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Metacode</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CommandProcessor</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeCollectorMetacode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Class&lt;CommandProcessor&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMasterClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CommandProcessor.class; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Class&lt;?&gt;&gt; getTypeCollection(Class&lt;? extends Annotation&gt; annotation) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(annotation == org.brooth.jeta.samples.command_handler.Command.class) { List&lt;Class&lt;?&gt;&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;Class&lt;?&gt;&gt;(<span class="hljs-number"><span class="hljs-number">3</span></span>); result.add(org.brooth.jeta.samples.command_handler.commands.ExitCommand.class); result.add(org.brooth.jeta.samples.command_handler.commands.TimeCommand.class); result.add(org.brooth.jeta.samples.command_handler.commands.GreetingCommand.class); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br><h3 id="metasitory">  Metasitory </h3><br><p>  <em>Strange name, I know.</em>  <em>But I don‚Äôt want to say ‚ÄúMetacode Repository‚Äù every time.</em> </p><br><p>  <em>Metasitory</em> , as it is not difficult to guess, is a repository of metacode references.  Although, in the figure it looks like <em>DB2</em> , you should not be afraid, by default it is <code>IdentityHashMap</code> (however, as mentioned at the beginning, you can write a implementation on <em>DB2</em> . Only please, without pull request-s).  More specifically, the default <em>Metasitory</em> implementation is <a href="">MapMetasitory</a> .  This you might have noticed in the source code of <code>CommandProcessor</code> .  <em>MapMetasitory</em> uses the so-called <em>MetasitoryContainers</em> , which, like <em>Metacode</em> , are generated automatically during compilation.  And here they already store contexts with metacode in <code>IdentityHashMap</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MetasitoryContainer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MapMetasitoryContainer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map&lt;Class&lt;?&gt;, MapMetasitoryContainer.Context&gt; get() { Map&lt;Class&lt;?&gt;, MapMetasitoryContainer.Context&gt; result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityHashMap&lt;&gt;(); result.put(org.brooth.jeta.samples.command_handler.CommandProcessor.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MapMetasitoryContainer.Context( org.brooth.jeta.samples.command_handler.CommandProcessor.class, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> org.brooth.jeta.Provider&lt;org.brooth.jeta.samples.command_handler.CommandProcessor_Metacode&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> org.brooth.jeta.samples.command_handler.<span class="hljs-function"><span class="hljs-function">CommandProcessor_Metacode </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> org.brooth.jeta.samples.command_handler.CommandProcessor_Metacode(); }}, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[] { org.brooth.jeta.collector.TypeCollector.class })); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre> <br><p>  The context consists of three fields: Wizard class, <em>Metacode Provider</em> (creates meta- <em>code</em> instances) and a list of annotations used.  This set is enough to search by <em>Criteria</em> : </p><br><h3 id="criteria">  Criteria </h3><br><p>  Everything is clear, with the help of <em>Criteria</em> , a request to <em>Metasitory is described</em> .  The current version (2.3) supports searching by the following criteria: </p><br><ul><li>  <code>masterEq(Class&lt;?&gt; masterClass)</code> - search for the metacode by its master (and the master class is the key of the <code>IdentityHashMap</code> , that is, quickly). </li><li>  <code>masterEqDeep(Class&lt;?&gt; masterClass)</code> - search for metacode not only for the master but also for its descendants (called once in the base class and locked <del>  and </del>  They were). </li><li>  <code>usesAny(Set&lt;Class&lt;? extends Annotation&gt;&gt; annotationList)</code> - the wizard uses any annotation from the list. </li><li>  <code>usesAll(Set&lt;Class&lt;? extends Annotation&gt;&gt; annotationList)</code> - the wizard uses all the annotations from the list. </li></ul><br><p>  In our example, <code>masterEq</code> is enough - because  we are only interested in <em>CommandProcessor_Metacode</em> . </p><br><h3 id="controller">  Controller </h3><br><p>  The last element (and by the way optional) is the controller.  You access the controller you need, using <em>Criteria</em> , it requests the appropriate <em>Metacode from Metasitory</em> and "pulls" the necessary methods.  Perhaps he does some other transformations or checks, it all depends on the implementation.  In our example, we used <code>TypeCollectorController</code> (also featured in the <em>CommandProcessor</em> -a source code): </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeCollectorController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Collection&lt;Metacode&lt;?&gt;&gt; metacodes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeCollectorController</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Metasitory metasitory, Class&lt;?&gt; masterClass)</span></span></span><span class="hljs-function"> </span></span>{ metacodes = metasitory.search(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Criteria.Builder() .masterEq(masterClass) .build()); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Class&lt;?&gt;&gt; getTypes(Class&lt;? extends Annotation&gt; annotation) { <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> annotation != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (metacodes.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((TypeCollectorMetacode) metacodes.iterator().next()).getTypeCollection(annotation); } }</code> </pre> <br><p>  <em>Nuff say</em> </p><br><h2 id="ps">  PS </h2><br><p>  If this time there is interest in the library, the next article will be about <em>Jeta Dependency Injection</em> .  There will be something to tell. </p><br><p>  <a href="https://habrahabr.ru/post/317970/">Do not write too much</a> , good luck! </p><br><p>  ‚Üí <a href="https://github.com/brooth/jeta-samples/tree/master/command-handler">Sample source code</a> <br>  ‚Üí <a href="http://jeta.brooth.org/">Official website</a> <br>  ‚Üí <a href="https://github.com/brooth/jeta">Jeta on GitHub</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/318020/">https://habr.com/ru/post/318020/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318010/index.html">Hello dear Megaphone</a></li>
<li><a href="../318012/index.html">Intel Software Guard Extensions tutorial. Part 3, Design for Intel SGX</a></li>
<li><a href="../318014/index.html">Huawei router + hypervisor in one package. Starting from scratch</a></li>
<li><a href="../318016/index.html">Consumer psychology - free book and lecture with HSE</a></li>
<li><a href="../318018/index.html">Entertaining tasks and an excerpt from the book "Career Programmer"</a></li>
<li><a href="../318022/index.html">Calendar functions in MySQL and MariaDB</a></li>
<li><a href="../318024/index.html">Interface designer on Habr√© - the results of my first year</a></li>
<li><a href="../318026/index.html">How to write your own ‚Äúsandbox‚Äù: an example of the simplest ‚Äúsandbox‚Äù. Part II</a></li>
<li><a href="../318028/index.html">Lord of Wi-Fi: Aruba ClearPass</a></li>
<li><a href="../318030/index.html">New Year's Release SBM 11.2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>