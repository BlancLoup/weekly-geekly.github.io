<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How protocols are arranged in Elixir</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In our company, we actively use Erlang, but often we consider other alternative languages ​​and approaches to improve the quality of our own code. 


...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">🔎</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">📜</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">⬆️</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">⬇️</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How protocols are arranged in Elixir</h1><div class="post__text post__text-html js-mediator-article"><p>  In our company, we actively use Erlang, but often we consider other alternative languages ​​and approaches to improve the quality of our own code. </p><br><p>  <a href="http://elixir-lang.org/">Elixir</a> is a general-purpose functional programming language that runs on the BeamVM virtual machine.  It differs from Erlang in syntax more similar to Ruby and advanced metaprogramming features. </p><br><p>  Elixir also has a great mechanism for polymorphism called <a href="http://elixir-lang.org/getting-started/protocols.html">Protocols</a> , but Erlang does not have a syntax for dynamic dispatching that is necessary for their implementation. </p><br><p>  Then how are they arranged inside?  What overhead gives code using protocols?  Let's try to figure it out. </p><br><p><img src="https://habrastorage.org/web/843/b2e/cc9/843b2ecc941746bda0cb17e37262e76b.jpg"></p><a name="habracut"></a><br><p>  There are two ways to understand what is happening inside: </p><br><p>  - deal with how Elixir Compiler <a href="">generates</a> code for BeamVM, <br>  - decompile the beam files and see what happened. </p><br><p>  The second method is much simpler, we will use it. </p><br><p>  First, create a new project. </p><br><pre><code class="bash hljs">mix new proto <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> proto</code> </pre> <br><p>  Now let's edit the file <code>lib/proto.ex</code> with a fairly simple example. </p><br><pre> <code class="hljs sql">defprotocol Double <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">input</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defimpl <span class="hljs-keyword"><span class="hljs-keyword">Double</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defimpl <span class="hljs-keyword"><span class="hljs-keyword">Double</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">List</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> ++ <span class="hljs-keyword"><span class="hljs-keyword">list</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Here we announced the <code>Double</code> protocol with a <code>double/1</code> interface and two implementations of this protocol for <code>Integer</code> and <code>List</code> . </p><br><p>  Check performance: </p><br><pre> <code class="hljs pgsql">iex(<span class="hljs-number"><span class="hljs-number">1</span></span>)&gt; <span class="hljs-type"><span class="hljs-type">Double</span></span>.double(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-number"><span class="hljs-number">4</span></span> iex(<span class="hljs-number"><span class="hljs-number">2</span></span>)&gt; <span class="hljs-type"><span class="hljs-type">Double</span></span>.double([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]) [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] iex(<span class="hljs-number"><span class="hljs-number">3</span></span>)&gt; <span class="hljs-type"><span class="hljs-type">Double</span></span>.double(:atom) ** (Protocol.UndefinedError) protocol <span class="hljs-type"><span class="hljs-type">Double</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> implemented <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> :atom (proto) lib/proto.ex:<span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-type"><span class="hljs-type">Double</span></span>.impl_for!/<span class="hljs-number"><span class="hljs-number">1</span></span> (proto) lib/proto.ex:<span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-type"><span class="hljs-type">Double</span></span>.double/<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br><p>  Now look at the structure of the compiled files. </p><br><pre> <code class="bash hljs">$ tree _build/dev/ _build/dev/ ├── consolidated │ ├── Elixir.Collectable.beam │ ├── Elixir.Double.beam │ ├── Elixir.Enumerable.beam │ ├── Elixir.IEx.Info.beam │ ├── Elixir.Inspect.beam │ ├── Elixir.List.Chars.beam │ └── Elixir.String.Chars.beam └── lib └── proto └── ebin ├── Elixir.Double.beam ├── Elixir.Double.Integer.beam ├── Elixir.Double.List.beam └── proto.app</code> </pre> <br><p>  The first thing that catches your eye is the presence of modules with the same names in the consolidated and lib / proto / ebin directories.  Consider their contents. </p><br><p>  To begin, the beam files need to be decompiled.  To do this, create an escript file <code>beam_to_erl</code> </p><br><pre> <code class="erlang hljs">#!/usr/bin/env escript main([BeamFile]) -&gt; {ok,{_,[{abstract_code,{_,AC}}]}} = beam_lib:chunks(BeamFile,[abstract_code]), io:fwrite(<span class="hljs-string"><span class="hljs-string">"~s~n"</span></span>, [erl_prettypr:format(erl_syntax:form_list(AC))]).</code> </pre> <br><p>  and run through all the beam files. </p><br><pre> <code class="bash hljs">$ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $(find _build/ -name <span class="hljs-string"><span class="hljs-string">"*.beam"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ./beam_to_erl <span class="hljs-variable"><span class="hljs-variable">$f</span></span> &gt; <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${f%.beam}</span></span></span><span class="hljs-string">.erl"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><pre> <code class="bash hljs">$ tree _build/dev/ | grep -v <span class="hljs-string"><span class="hljs-string">".beam"</span></span> _build/dev/ ├── consolidated │ ├── Elixir.Collectable.erl │ ├── Elixir.Double.erl │ ├── Elixir.Enumerable.erl │ ├── Elixir.IEx.Info.erl │ ├── Elixir.Inspect.erl │ ├── Elixir.List.Chars.erl │ └── Elixir.String.Chars.erl └── lib └── proto └── ebin ├── Elixir.Double.erl ├── Elixir.Double.Integer.erl ├── Elixir.Double.List.erl └── proto.app</code> </pre> <br><p>  Consider the contents of the file <code>lib/proto/ebin/Elixir.Double.erl</code> . </p><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-compile</span></span><span class="hljs-params"><span class="hljs-params">(no_auto_import)</span></span>. -file(<span class="hljs-string"><span class="hljs-string">"lib/proto.ex"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>). -module('Elixir.Double'). -compile(debug_info). -compile({inline, [{any_impl_for, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {struct_impl_for, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {'impl_for?', <span class="hljs-number"><span class="hljs-number">1</span></span>}]}). -protocol([{fallback_to_any, false}]). -export_type([t/<span class="hljs-number"><span class="hljs-number">0</span></span>]). -type t() :: term(). -spec '__protocol__'('consolidated?') -&gt; boolean(); (functions) -&gt; [{double, <span class="hljs-number"><span class="hljs-number">1</span></span>}, ...]; (module) -&gt; 'Elixir.Double'. -spec impl_for(term()) -&gt; atom() | nil. -spec 'impl_for!'(term()) -&gt; atom() | no_return(). -callback double(t()) -&gt; term(). -export(['__info__'/<span class="hljs-number"><span class="hljs-number">1</span></span>, '__protocol__'/<span class="hljs-number"><span class="hljs-number">1</span></span>, double/<span class="hljs-number"><span class="hljs-number">1</span></span>, impl_for/<span class="hljs-number"><span class="hljs-number">1</span></span>, 'impl_for!'/<span class="hljs-number"><span class="hljs-number">1</span></span>]). -spec '__info__'(attributes | compile | exports | functions | macros | md5 | module | native_addresses) -&gt; atom() | [{atom(), any()} | {atom(), byte(), integer()}]. '__info__'(functions) -&gt; [{'__protocol__', <span class="hljs-number"><span class="hljs-number">1</span></span>}, {double, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {impl_for, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {'impl_for!', <span class="hljs-number"><span class="hljs-number">1</span></span>}]; '__info__'(macros) -&gt; []; '__info__'(info) -&gt; erlang:get_module_info('Elixir.Double', info). '__protocol__'(module) -&gt; 'Elixir.Double'; '__protocol__'(functions) -&gt; [{double, <span class="hljs-number"><span class="hljs-number">1</span></span>}]; '__protocol__'('consolidated?') -&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>. any_impl_for() -&gt; nil. double(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; ('impl_for!'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>)):double(_@<span class="hljs-number"><span class="hljs-number">1</span></span>). impl_for(#{'__struct__' := _@<span class="hljs-number"><span class="hljs-number">1</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_atom(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; struct_impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>); impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_tuple(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Tuple') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Tuple':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_atom(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Atom') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Atom':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_list(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.List') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.List':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_map(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Map') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Map':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_bitstring(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.BitString') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.BitString':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_integer(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Integer') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Integer':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_float(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Float') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Float':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_function(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Function') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Function':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_pid(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.PID') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.PID':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_port(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Port') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Port':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_reference(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'('Elixir.Double.Reference') <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Double.Reference':'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; impl_for(_) -&gt; any_impl_for(). 'impl_for!'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> _@<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (_@<span class="hljs-number"><span class="hljs-number">2</span></span> =:= nil) or (_@<span class="hljs-number"><span class="hljs-number">2</span></span> =:= <span class="hljs-literal"><span class="hljs-literal">false</span></span>) -&gt; erlang:error('Elixir.Protocol.UndefinedError':exception([{protocol, 'Elixir.Double'}, {value, _@<span class="hljs-number"><span class="hljs-number">1</span></span>}])); _@<span class="hljs-number"><span class="hljs-number">3</span></span> -&gt; _@<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. 'impl_for?'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'Elixir.Code':'ensure_compiled?'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Kernel':'function_exported?'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>, '__impl__', <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _@<span class="hljs-number"><span class="hljs-number">2</span></span> -&gt; erlang:error({badbool, 'and', _@<span class="hljs-number"><span class="hljs-number">2</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. struct_impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; _@<span class="hljs-number"><span class="hljs-number">2</span></span> = 'Elixir.Module':concat('Elixir.Double', _@<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'impl_for?'(_@<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; _@<span class="hljs-number"><span class="hljs-number">2</span></span>:'__impl__'(target); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; any_impl_for() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br><p>  And here is all the magic.  Let's take a look at the <code>double/1</code> function. </p><br><pre> <code class="erlang hljs"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">double</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_@</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> -&gt;</span></span> ('impl_for!'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>)):double(_@<span class="hljs-number"><span class="hljs-number">1</span></span>).</code> </pre> <br><p>  It searches for a module that is suitable for the passed argument, via <code>impl_for/1</code> and calls its implementation. </p><br><p>  And how to find a module for an argument?  Very simple: </p><br><p>  - if it is a primitive or bif-type, then simply look for a module with the name 'Elixir. {ProtocolName}. {TypeName}', where ProtocolName is the name of the protocol, TypeName is the name of the type.  Load it, if not already loaded, via <code>'Elixir.Code':'ensure_compiled?'/1</code> .  We check whether the module is a protocol implementation through the presence of the function <code>'__impl__'/1</code> , and we get the module of the implementation <code>'__impl__'(target)</code> , <br>  - if it is a structure, then we look at the <code>__struct__</code> service field and in the same way look for the module 'Elixir. {ProtocolName}. {StructName}', <br>  - if the implementation is not found, check the presence of the default implementation for any type or return an error. </p><br><p>  The implementation of the protocol remains almost unchanged.  Only a few system functions are added.  For example: <code>'Elixir.Double.Integer'</code> . <code>'Elixir.Double.Integer'</code> . </p><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-compile</span></span><span class="hljs-params"><span class="hljs-params">(no_auto_import)</span></span>. -file(<span class="hljs-string"><span class="hljs-string">"lib/proto.ex"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>). -module('Elixir.Double.Integer'). -behaviour('Elixir.Double'). -impl([{protocol, 'Elixir.Double'}, {for, 'Elixir.Integer'}]). -spec '__impl__'(protocol) -&gt; 'Elixir.Double'; (target) -&gt; 'Elixir.Double.Integer'; (for) -&gt; 'Elixir.Integer'. -export(['__impl__'/<span class="hljs-number"><span class="hljs-number">1</span></span>, '__info__'/<span class="hljs-number"><span class="hljs-number">1</span></span>, double/<span class="hljs-number"><span class="hljs-number">1</span></span>]). -spec '__info__'(attributes | compile | exports | functions | macros | md5 | module | native_addresses) -&gt; atom() | [{atom(), any()} | {atom(), byte(), integer()}]. '__info__'(functions) -&gt; [{'__impl__', <span class="hljs-number"><span class="hljs-number">1</span></span>}, {double, <span class="hljs-number"><span class="hljs-number">1</span></span>}]; '__info__'(macros) -&gt; []; '__info__'(info) -&gt; erlang:get_module_info('Elixir.Double.Integer', info). '__impl__'(for) -&gt; 'Elixir.Integer'; '__impl__'(target) -&gt; 'Elixir.Double.Integer'; '__impl__'(protocol) -&gt; 'Elixir.Double'. double(int@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; int@<span class="hljs-number"><span class="hljs-number">1</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span>.</code> </pre> <br><p>  In other words, all dynamic dispatching is reduced to finding a module by name, knowing the algorithm for composing this name to implement the protocol.  This approach has one non-essential minus - you cannot define several protocol implementations for the same type. </p><br><p>  Overhead at the same time is not so small, especially for high-load systems.  The point is to constantly check for module availability at runtime. </p><br><p>  To eliminate this drawback, the ability to “sew” routing for protocol implementations known at the compilation stage was added directly to the dispatching function <code>impl_for/1</code> <br>  This compiler function is called <a href="http://elixir-lang.org/getting-started/protocols.html">consolidated protocols</a> and, with Elixir v1.2, is performed automatically during release build via mix. </p><br><p>  <code>consolidated/Elixir.Double.erl</code> look at <code>consolidated/Elixir.Double.erl</code> . </p><br><pre> <code class="erlang hljs"><span class="hljs-keyword"><span class="hljs-keyword">-compile</span></span><span class="hljs-params"><span class="hljs-params">(no_auto_import)</span></span>. -file(<span class="hljs-string"><span class="hljs-string">"lib/proto.ex"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>). -module('Elixir.Double'). -compile(debug_info). -compile({inline, [{any_impl_for, <span class="hljs-number"><span class="hljs-number">0</span></span>}, {struct_impl_for, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {'impl_for?', <span class="hljs-number"><span class="hljs-number">1</span></span>}]}). -protocol([{fallback_to_any, false}]). -export_type([t/<span class="hljs-number"><span class="hljs-number">0</span></span>]). -type t() :: term(). -spec '__protocol__'('consolidated?') -&gt; boolean(); (functions) -&gt; [{double, <span class="hljs-number"><span class="hljs-number">1</span></span>}, ...]; (module) -&gt; 'Elixir.Double'. -spec impl_for(term()) -&gt; atom() | nil. -spec 'impl_for!'(term()) -&gt; atom() | no_return(). -callback double(t()) -&gt; term(). -export(['__info__'/<span class="hljs-number"><span class="hljs-number">1</span></span>, '__protocol__'/<span class="hljs-number"><span class="hljs-number">1</span></span>, double/<span class="hljs-number"><span class="hljs-number">1</span></span>, impl_for/<span class="hljs-number"><span class="hljs-number">1</span></span>, 'impl_for!'/<span class="hljs-number"><span class="hljs-number">1</span></span>]). -spec '__info__'(attributes | compile | exports | functions | macros | md5 | module | native_addresses) -&gt; atom() | [{atom(), any()} | {atom(), byte(), integer()}]. '__info__'(functions) -&gt; [{'__protocol__', <span class="hljs-number"><span class="hljs-number">1</span></span>}, {double, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {impl_for, <span class="hljs-number"><span class="hljs-number">1</span></span>}, {'impl_for!', <span class="hljs-number"><span class="hljs-number">1</span></span>}]; '__info__'(macros) -&gt; []; '__info__'(info) -&gt; erlang:get_module_info('Elixir.Double', info). '__protocol__'(module) -&gt; 'Elixir.Double'; '__protocol__'(functions) -&gt; [{double, <span class="hljs-number"><span class="hljs-number">1</span></span>}]; '__protocol__'('consolidated?') -&gt; <span class="hljs-literal"><span class="hljs-literal">true</span></span>. any_impl_for() -&gt; nil. double(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; ('impl_for!'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>)):double(_@<span class="hljs-number"><span class="hljs-number">1</span></span>). impl_for(#{'__struct__' := x}) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_atom(x) -&gt; struct_impl_for(x); impl_for(x) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_list(x) -&gt; 'Elixir.Double.List'; impl_for(x) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> erlang:is_integer(x) -&gt; 'Elixir.Double.Integer'; impl_for(_) -&gt; nil. 'impl_for!'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> impl_for(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> _@<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (_@<span class="hljs-number"><span class="hljs-number">2</span></span> =:= nil) or (_@<span class="hljs-number"><span class="hljs-number">2</span></span> =:= <span class="hljs-literal"><span class="hljs-literal">false</span></span>) -&gt; erlang:error('Elixir.Protocol.UndefinedError':exception([{protocol, 'Elixir.Double'}, {value, _@<span class="hljs-number"><span class="hljs-number">1</span></span>}])); _@<span class="hljs-number"><span class="hljs-number">3</span></span> -&gt; _@<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. 'impl_for?'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> 'Elixir.Code':'ensure_compiled?'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span> -&gt; 'Elixir.Kernel':'function_exported?'(_@<span class="hljs-number"><span class="hljs-number">1</span></span>, '__impl__', <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-literal"><span class="hljs-literal">false</span></span> -&gt; <span class="hljs-literal"><span class="hljs-literal">false</span></span>; _@<span class="hljs-number"><span class="hljs-number">2</span></span> -&gt; erlang:error({badbool, 'and', _@<span class="hljs-number"><span class="hljs-number">2</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>. struct_impl_for(_) -&gt; nil.</code> </pre> <br><p>  The module code is significantly smaller than the original and, importantly, <code>impl_for</code> works in one step without checking for the presence of the module. </p><br><h3 id="itogo">  Total </h3><br><p>  Sometimes it is useful to look at the inside of the tool.  This enables us to better understand its advantages and disadvantages. </p><br><p>  The implementation of protocols is quite simple and when using consolidated protocols, it gives a slight overhead, while providing a good abstraction over data structures.  However, a similar mechanism can easily be added to Erlang, but this will require the manual writing of a dynamic dispatch function. </p><br><p>  To use Elixir or not - the choice is yours.  But we are still staying at Erlang. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/328528/">https://habr.com/ru/post/328528/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../328516/index.html">Using NES-game research tools on the example of parsing the Felix The Cat compression format</a></li>
<li><a href="../328518/index.html">Preview Rambler.iOS # 9</a></li>
<li><a href="../328520/index.html">Zero-day vulnerabilities in Wordpress and Vanilla Forums allow you to hack sites remotely</a></li>
<li><a href="../328522/index.html">Where is the money on the road (an algorithm that allows one and a half times to reduce costs in a taxi)</a></li>
<li><a href="../328526/index.html">WebGL Application Performance</a></li>
<li><a href="../328530/index.html">Why don't you answer my question?</a></li>
<li><a href="../328532/index.html">Heisenbag 2017 Piter: Call for Testing</a></li>
<li><a href="../328534/index.html">Video shooting training with a mentor</a></li>
<li><a href="../328536/index.html">Voting started for YiiConf reports</a></li>
<li><a href="../328538/index.html">Ransomware day: Wana Decrypt0r mass infection</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>