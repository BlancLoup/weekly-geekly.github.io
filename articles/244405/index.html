<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Expressive JavaScript: Project: Platformer game</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Content 


- Introduction 
- Values, Types and Operators 
- Program structure 
- Functions 
- Data Structures: Objects and Arrays 
- Higher order func...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Expressive JavaScript: Project: Platformer game</h1><div class="post__text post__text-html js-mediator-article"><h4>  Content </h4><br><ul><li>  <a href="http://habrahabr.ru/post/240219/">Introduction</a> </li><li>  <a href="http://habrahabr.ru/post/240223/">Values, Types and Operators</a> </li><li>  <a href="http://habrahabr.ru/post/240225/">Program structure</a> </li><li>  <a href="http://habrahabr.ru/post/240349/">Functions</a> </li><li>  <a href="http://habrahabr.ru/post/240813/">Data Structures: Objects and Arrays</a> </li><li>  <a href="http://habrahabr.ru/post/241155/">Higher order functions</a> </li><li>  <a href="http://habrahabr.ru/post/241587/">The secret life of objects</a> </li><li>  <a href="http://habrahabr.ru/post/241776/">Project: e-life</a> </li><li>  <a href="http://habrahabr.ru/post/242609/">Search and error handling</a> </li><li>  <a href="http://habrahabr.ru/post/242695/">Regular expressions</a> </li><li>  <a href="http://habrahabr.ru/post/243273/">Modules</a> </li><li>  <a href="http://habrahabr.ru/post/243277/">Project: programming language</a> </li><li>  <a href="http://habrahabr.ru/post/243311/">Javascript and browser</a> </li><li>  <a href="http://habrahabr.ru/post/243815/">Document Object Model</a> </li><li>  <a href="http://habrahabr.ru/post/244041/">Event handling</a> </li><li>  <a href="http://habrahabr.ru/post/244405/">Project: Platform Game</a> </li><li>  <a href="http://habrahabr.ru/post/244545/">Drawing on canvas</a> </li><li>  <a href="http://habrahabr.ru/post/245145/">HTTP</a> </li><li>  <a href="http://habrahabr.ru/post/245731/">Forms and form fields</a> </li><li>  <a href="http://habrahabr.ru/post/245767/">Project: Paint</a> </li><li>  <a href="http://habrahabr.ru/post/245775/">Node.js</a> </li><li>  <a href="http://habrahabr.ru/post/246331/">Project: website sharing experience</a> </li><li>  <a href="http://eloquentjavascript.net/code">Sandbox for code</a> </li></ul><br><br>  <i>Our whole life is a game.</i> <i><br></i>  <i>Iyen Banks, Player</i> <br><br>  For the first time I was fascinated by computers, like most children, through computer games.  I was drawn into the universe of simulated worlds that could be controlled and told stories - it seems to me more because they gave my imagination more space than because of the real possibilities that they provided. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      No one would have wished a career as a game programmer.  As in the music industry, the discrepancy between the number of young people who want to get there and the real demand for them creates an unhealthy environment.  But writing games for fun is great. <br><br>  In this chapter, we will explore the implementation of a simple platformer.  In platformers (or ‚Äújump and run‚Äù), the player is required to move the figure in a (usually) two-dimensional world, which we see from the side, and often jump over different things. <br><a name="habracut"></a><br><h4>  A game </h4><br>  Our game will be roughly based on the game Dark Blue by Thomas Palef.  I chose it because it is both entertaining and minimalist, and it can be done with a minimum of code.  It looks like this: <br><br>  The black box represents the player whose task is to collect yellow squares (coins), avoiding the red areas (lava?).  The level ends when the player has collected all the coins. <br><br>  The player can go left and right with the keys and jump up with the key.  Jumping is a specialty of our character.  He can jump several times higher than his height and change the direction of movement in the air.  This is not very realistic, but it helps the player to feel complete control over his screen avatar. <br><br>  The game has a fixed background in the form of a grid, where moving elements are superimposed on the background.  Each grid cell is either empty, either a wall or lava.  The moving elements are player, coins, and some pieces of lava.  Unlike the life simulation from chapter 7, the positions of these elements are not tied to the grid.  Their coordinates can be fractional, providing smooth movement. <br><br><h4>  Technology </h4><br>  We use the browser's DOM for graphics, and read user input by serving keyboard events. <br><br>  The code relating to the screen and the keyboard is a small part of the work that we have to do to create the game.  Since everything consists of colored squares, drawing is simple: we create DOM elements and use styles to set the background color, size and location. <br><br>  We present the background as a table, since this is a fixed grid of squares.  Freely moving elements can be superimposed on top using absolute positioning. <br><br>  In games and other interactive programs with graphic animation, which must respond to user actions without delay, efficiency is very important.  Although the DOM was not designed to produce high-speed graphics, it does it better than you would expect.  In chapter 13, you saw a little animation.  On a modern computer, such a simple game is going well, even if you don‚Äôt suffer much with optimization. <br><br>  In the next chapter, we will explore another browser technology, a tag that provides a more traditional way to draw, and works with shapes and pixels instead of DOM elements. <br><br><h4>  Levels </h4><br><br>  In chapter 7, we used arrays of strings to describe a two-dimensional lattice.  We can do the same here.  This will allow us to develop levels without first writing a level editor. <br><br>  A simple level might look like this: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> simpleLevelPlan = [ <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">" x = x "</span></span>, <span class="hljs-string"><span class="hljs-string">" xoox "</span></span>, <span class="hljs-string"><span class="hljs-string">" x @ xxxxx x "</span></span>, <span class="hljs-string"><span class="hljs-string">" xxxxx x "</span></span>, <span class="hljs-string"><span class="hljs-string">" x!!!!!!!!!!!!x "</span></span>, <span class="hljs-string"><span class="hljs-string">" xxxxxxxxxxxxxx "</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span> ];</code> </pre> <br><br>  Fixed grid and moving elements included.  The x indicates walls, spaces are empty spaces, and exclamation marks indicate fixed lava. <br><br>  @ marks the place where the player starts.  o - coins, equal sign = means a block of moving lava that moves horizontally to and fro.  Note that the grid at these positions will contain empty space, and another data structure is used to track the position of these moving elements. <br><br>  We will support two more types of lava: vertical bar |  - for pieces moving vertically, and v for dripping lava.  She will move down, but not bounce back, but simply jump to the starting position to reach the floor. <br><br>  The game consists of several levels that must be completed.  The level is completed when all the coins are collected.  If a player touches lava, the current level returns to its original state, and the player starts over. <br><br>  Reading level <br><br>  The following constructor creates a level object.  The argument must be an array of strings specifying the level. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Level</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">plan</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.width = plan[<span class="hljs-number"><span class="hljs-number">0</span></span>].length; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.height = plan.length; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.grid = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.actors = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.height; y++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> line = plan[y], gridLine = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.width; x++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = line[x], fieldType = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Actor = actorChars[ch]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Actor) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.actors.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Actor(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(x, y), ch)); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"x"</span></span>) fieldType = <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"!"</span></span>) fieldType = <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; gridLine.push(fieldType); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.grid.push(gridLine); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.player = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">actor</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.type == <span class="hljs-string"><span class="hljs-string">"player"</span></span>; })[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finishDelay = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br><br>  For brevity, the code does not validate incoming data.  He assumes that the level plan is acceptable, that there is a player‚Äôs starting position and other necessary things. <br><br>  The level retains its width and height and two more arrays - one for the grid, and one for moving parts.  A grid is represented by an array of arrays, where each nested array represents a horizontal line, and each square contains either null for empty squares, or a line reflecting the type of square - ‚Äúwall‚Äù or ‚Äúlava‚Äù. <br><br>  The actors array contains objects that track the positions and states of dynamic elements.  Each of them should have a pos property containing a position (coordinates of the upper left corner), a size property with a size, and a type property with a line describing its type ("lava", "coin" or "player"). <br><br>  After building the grid, we use the filter method to find the player object stored in the level property.  The status property tracks whether a player has won or lost.  When this happens, finishDelay is used, which keeps the level active for a while to show a simple animation.  (Just immediately restore the state of the level or start the next one - it looks ugly).  You can use this method to find out if the level is complete: <br><br><pre> <code class="javascript hljs">Level.prototype.isFinished = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finishDelay &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>; };</code> </pre><br><br><h4>  Actors (actors) </h4><br>  To store the position and size of our actors, we will return to our correct type, Vector, which groups the x and y coordinates into an object. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Vector</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; } Vector.prototype.plus = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">other</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x + other.x, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y + other.y); }; Vector.prototype.times = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">factor</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x * factor, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y * factor); };</code> </pre><br><br>  The times method multiplies the scaled vector by the specified amount.  It will be convenient when we need to multiply the velocity vector by the time interval to find out the distance traveled during this time. <br><br>  In the previous section, the Level constructor used the actorChars object to associate characters with constructor functions.  The object looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> actorChars = { <span class="hljs-string"><span class="hljs-string">"@"</span></span>: Player, <span class="hljs-string"><span class="hljs-string">"o"</span></span>: Coin, <span class="hljs-string"><span class="hljs-string">"="</span></span>: Lava, <span class="hljs-string"><span class="hljs-string">"|"</span></span>: Lava, <span class="hljs-string"><span class="hljs-string">"v"</span></span>: Lava };</code> </pre><br><br>  Three characters refer to Lava.  The Level constructor passes the original character of the actor as the second argument of the constructor, and the Lava constructor uses it to adjust its behavior (jump horizontally, jump vertically, drip). <br><br>  The player type is built by the following constructor.  It has a speed property that stores its current speed, which will help us simulate momentum and gravity. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Player</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pos</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pos = pos.plus(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">-0.5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0.8</span></span>, <span class="hljs-number"><span class="hljs-number">1.5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } Player.prototype.type = <span class="hljs-string"><span class="hljs-string">"player"</span></span>;</code> </pre><br><br>  Since a player is one and a half square tall, his starting position is set half a square above the position where the ‚Äú@‚Äù character is located.  Thus its bottom coincides with the bottom of the square in which it appears. <br><br>  When creating a dynamic Lava object, we need to initialize the object depending on the character.  Dynamic lava moves at a given speed until it encounters an obstacle.  Then, if she has a repeatPos property, she will jump back to the starting position (dripping).  If not, it inverts the speed and continues to move in the opposite direction (bounces off).  The constructor sets only the necessary properties.  Later we will write a method that deals with the movement itself. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lava</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pos, ch</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pos = pos; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"="</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"|"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ch == <span class="hljs-string"><span class="hljs-string">"v"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repeatPos = pos; } } Lava.prototype.type = <span class="hljs-string"><span class="hljs-string">"lava"</span></span>;</code> </pre><br><br>  Coins are easy to implement.  They just sit still.  But to revive the game, they will tremble, slightly moving vertically back and forth.  To track this, the coin object stores the main position along with the wobble property, which tracks the movement phase.  Together they determine the position of the coin (stored in the pos property). <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Coin</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">pos</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.basePos = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.pos = pos.plus(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0.2</span></span>, <span class="hljs-number"><span class="hljs-number">0.1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector(<span class="hljs-number"><span class="hljs-number">0.6</span></span>, <span class="hljs-number"><span class="hljs-number">0.6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wobble = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI * <span class="hljs-number"><span class="hljs-number">2</span></span>; } Coin.prototype.type = <span class="hljs-string"><span class="hljs-string">"coin"</span></span>;</code> </pre><br><br>  In Chapter 13, we saw that Math.sin gives the y coordinate of a point on a circle.  It moves back and forth in the form of a smooth wave while we move in a circle, which makes the sine function suitable for modeling wave motion. <br><br>  To avoid the case when all the coins move synchronously, the initial phase of each will be random.  The phase of the wave is Math.sin and the wave width is 2œÄ.  We multiply the value returned by Math.random by this number to set the coin to a random starting position in the wave. <br><br>  Now we have written everything that is needed to represent the level state <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> simpleLevel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Level(simpleLevelPlan); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(simpleLevel.width, <span class="hljs-string"><span class="hljs-string">"by"</span></span>, simpleLevel.height); <span class="hljs-comment"><span class="hljs-comment">// ‚Üí 22 by 9</span></span></code> </pre><br><br>  We have to display these levels on the screen and simulate the time and movement inside them. <br><br><h4>  Encapsulation burden </h4><br>  In most cases, the code in this chapter does not care about encapsulation.  First, encapsulation requires extra effort.  Programs are getting bigger, they require more concepts and interfaces.  And since the reader's eyes are too glassy because of too much code, I tried to keep the program small. <br><br>  Secondly, the various elements of the game are so connected together that if the behavior of one of them changes, it is unlikely that the remaining code would remain unchanged.  Creating interfaces between elements would lead to using too many assumptions about how the game works.  And then they would be inefficient - by changing one part of the system, you would have to think about how it affects other parts, because their interfaces would not cover the new situation. <br><br>  Some parts of the system can be well divided into pieces with strictly defined interfaces, while others are not.  In attempts to encapsulate something that does not have clear boundaries, you are guaranteed to spend a lot of energy.  Having made such an error, you will see that the interfaces become too large and detailed, and that they need to be changed frequently in the process of program evolution. <br><br>  One thing we still encapsulate - the drawing subsystem.  This is done specifically so that in the next chapter we can display the same game in a different way.  By hiding the drawing for the interface, we can simply load the same program and connect a new display module to it. <br><br><h4>  Drawing </h4><br>  We will encapsulate the drawing code by entering a display object that displays the level on the screen.  The type of screen that we define is called DOMDisplay, because it uses DOM elements to show the level. <br><br>  We use a style sheet to define the colors and other fixed properties of the elements that make up the game.  It would be possible to directly assign a style to an element through the style property when it was created, but in this case the program would become unnecessarily wordy. <br><br>  The following helper function provides an easy way to create an element with a class assignment. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name, className</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> elt = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (className) elt.className = className; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> elt; }</code> </pre><br><br>  We create the screen by passing to it the parent element to which you want to connect, and the level object. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DOMDisplay</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parent, level</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wrap = parent.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"game"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.level = level; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wrap.appendChild(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.drawBackground()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.actorLayer = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.drawFrame(); }</code> </pre><br><br>  Using the fact that appendChild returns the added element, we create the surrounding wrapper element and store it in the wrap property. <br><br>  Unchanged background level is drawn once.  Actors are redrawn every time the screen is updated.  The actorLayer property is used in drawFrame to track the element containing the actor ‚Äî so that they can be easily removed and replaced. <br><br>  Coordinates and dimensions are measured in units relative to the size of the grid, so that a distance of one means one element of the grid.  When we set the dimensions in pixels, we will need to scale the coordinates - the game would be very small if one square were set by one pixel.  The variable scale gives the number of pixels that one grid element occupies. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scale = <span class="hljs-number"><span class="hljs-number">20</span></span>; DOMDisplay.prototype.drawBackground = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> table = elt(<span class="hljs-string"><span class="hljs-string">"table"</span></span>, <span class="hljs-string"><span class="hljs-string">"background"</span></span>); table.style.width = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.level.width * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.level.grid.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rowElt = table.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"tr"</span></span>)); rowElt.style.height = scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; row.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">type</span></span></span><span class="hljs-function">) </span></span>{ rowElt.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"td"</span></span>, type)); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> table; };</code> </pre><br><br>  As we mentioned, the background is drawn through the element. <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h4> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h5> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h5> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <h5> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </h5> <code><code><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(52, 166, 251); table-layout: fixed; border-spacing: 0; } .background td { padding: 0; } .lava { background: rgb(255, 100, 100); } .wall { background: white; }</code> <br> <br>    (table-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          0  255.  ,   rgb(52, 166, 251)    52,  166   251.     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = function() { var wrap = elt("div"); this.level.actors.forEach(function(actor) { var rect = wrap.appendChild(elt("div", "actor " + actor.type)); rect.style.width = actor.size.x * scale + "px"; rect.style.height = actor.size.y * scale + "px"; rect.style.left = actor.pos.x * scale + "px"; rect.style.top = actor.pos.y * scale + "px"; }); return wrap; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(241, 229, 89); } .player { background: rgb(64, 64, 64); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = function() { if (this.actorLayer) this.wrap.removeChild(this.actorLayer); this.actorLayer = this.wrap.appendChild(this.drawActors()); this.wrap.className = "game " + (this.level.status || ""); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(160, 64, 64); } .won .player { box-shadow: -4px -7px 8px white, 4px -7px 8px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; max-width: 600px; max-height: 450px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = function() { var width = this.wrap.clientWidth; var height = this.wrap.clientHeight; var margin = width / 3; // The viewport var left = this.wrap.scrollLeft, right = left + width; var top = this.wrap.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(0.5)) .times(scale); if (center.x &lt; left + margin) this.wrap.scrollLeft = center.x - margin; else if (center.x &gt; right - margin) this.wrap.scrollLeft = center.x + margin - width; if (center.y &lt; top + margin) this.wrap.scrollTop = center.y - margin; else if (center.y &gt; bottom - margin) this.wrap.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  -10,    0. <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = function() { this.wrap.parentNode.removeChild(this.wrap); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code>   rel="stylesheet"</code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = function(pos, size) { var xStart = Math.floor(pos.x); var xEnd = Math.ceil(pos.x + size.x); var yStart = Math.floor(pos.y); var yEnd = Math.ceil(pos.y + size.y); if (xStart &lt; 0 || xEnd &gt; this.width || yStart &lt; 0) return "wall"; if (yEnd &gt; this.height) return "lava"; for (var y = yStart; y &lt; yEnd; y++) { for (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; if (fieldType) return fieldType; } } };</code> <br> <br>      ,  Math.floor  Math.ceil   . ,    ‚Äì 11 .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = function(actor) { for (var i = 0; i &lt; this.actors.length; i++) { var other = this.actors[i]; if (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) return other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = 0.05; Level.prototype.animate = function(step, keys) { if (this.status != null) this.finishDelay -= step; while (step &gt; 0) { var thisStep = Math.min(step, maxStep); this.actors.forEach(function(actor) { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     status  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  while       .  ,      maxStep.  ,   0.12        0.05    0.02 <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = function(step, level) { var newPos = this.pos.plus(this.speed.times(step)); if (!level.obstacleAt(newPos, this.size)) this.pos = newPos; else if (this.repeatPos) this.pos = this.repeatPos; else this.speed = this.speed.times(-1); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  -1),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = 8, wobbleDist = 0.07; Coin.prototype.act = function(step) { this.wobble += step * wobbleSpeed; var wobblePos = Math.sin(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(0, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.sin   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = 7; Player.prototype.moveX = function(step, level, keys) { this.speed.x = 0; if (keys.left) this.speed.x -= playerXSpeed; if (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, 0); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) level.playerTouched(obstacle); else this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = 30; var jumpSpeed = 17; Player.prototype.moveY = function(step, level, keys) { this.speed.y += step * gravity; var motion = new Vector(0, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); if (obstacle) { level.playerTouched(obstacle); if (keys.up &amp;&amp; this.speed.y &gt; 0) this.speed.y = -jumpSpeed; else this.speed.y = 0; } else { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = function(step, level, keys) { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); if (otherActor) level.playerTouched(otherActor.type, otherActor); // Losing animation if (level.status == "lost") { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = function(type, actor) { if (type == "lava" &amp;&amp; this.status == null) { this.status = "lost"; this.finishDelay = 1; } else if (type == "coin") { this.actors = this.actors.filter(function(other) { return other != actor; }); if (!this.actors.some(function(actor) { return actor.type == "coin"; })) { this.status = "won"; this.finishDelay = 1; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       "keydown"  "keyup",         ,  . <br> <br> <code class="java">var arrowCodes = {37: "left", 38: "up", 39: "right"}; function trackKeys(codes) { var pressed = Object.create(null); function handler(event) { if (codes.hasOwnProperty(event.keyCode)) { var down = event.type == "keydown"; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener("keydown", handler); addEventListener("keyup", handler); return pressed; }</code> <br> <br>  ,         .    type  , ,       true ("keydown")  false ("keyup"). <br> <br>   <br>  requestAnimationFrame,      13,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  false,  . <br> <br> <code class="javascript">function runAnimation(frameFunc) { var lastTime = null; function frame(time) { var stop = false; if (lastTime != null) { var timeStep = Math.min(time - lastTime, 100) / 1000; stop = frameFunc(timeStep) === false; } lastTime = time; if (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        100  (1/10 ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript">function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      5.   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     17,         20. <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... function runGame(plans, Display) { function startLevel(n) { runLevel(new Level(plans[n]), Display, function(status) { if (status == "lost") startLevel(n); else if (n &lt; plans.length - 1) startLevel(n + 1); else console.log("You win!"); }); } startLevel(0); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel="stylesheet" href="css/game.css"&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... function runLevel(level, Display, andThen) { var display = new Display(document.body, level); runAnimation(function(step) { level.animate(step, arrows); display.drawFrame(step); if (level.isFinished()) { display.clear(); if (andThen) andThen(level.status); return false; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> <pre> <code class="hljs lua"><code><code><code class="css">.     ,       ‚Äì        ( ).         ().  CSS       : <br> <br> .background { background: rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout: fixed; border-spacing: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .background td { padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; } .lava { background: rgb(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); } .wall { background: white; }</code> <br> <br>    (<span class="hljs-built_in"><span class="hljs-built_in">table</span></span>-layout, border-spacing  padding)       .  ,       ,          . <br> <br>  background   . CSS     (white)    rgb(R, G, B),  ,          <span class="hljs-number"><span class="hljs-number">0</span></span>  <span class="hljs-number"><span class="hljs-number">255.</span></span>  ,   rgb(<span class="hljs-number"><span class="hljs-number">52</span></span>, <span class="hljs-number"><span class="hljs-number">166</span></span>, <span class="hljs-number"><span class="hljs-number">251</span></span>)    <span class="hljs-number"><span class="hljs-number">52</span></span>,  <span class="hljs-number"><span class="hljs-number">166</span></span>   <span class="hljs-number"><span class="hljs-number">251.</span></span>     ,    .   ,       .lava ‚Äì . <br> <br>      DOM     ,    .      scale,       . <br> <br> <code class="javascript">DOMDisplay.prototype.drawActors = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span> = elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>); this.level.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { var rect = <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(elt(<span class="hljs-string"><span class="hljs-string">"div"</span></span>, <span class="hljs-string"><span class="hljs-string">"actor "</span></span> + actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>)); rect.style.width = actor.size.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.height = actor.size.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.left = actor.pos.x * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; rect.style.top = actor.pos.y * scale + <span class="hljs-string"><span class="hljs-string">"px"</span></span>; }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>; };</code> <br> <br>      ,     .   CSS  actor   absolute.         .       lava,          ,    . <br> <br> <code class="css">.actor { position: absolute; } .coin { background: rgb(<span class="hljs-number"><span class="hljs-number">241</span></span>, <span class="hljs-number"><span class="hljs-number">229</span></span>, <span class="hljs-number"><span class="hljs-number">89</span></span>); } .player { background: rgb(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); }</code> <br> <br>     drawFrame    ,   ,       .    DOM   ,                 .        DOM,           .        ,     . <br> <br> <code class="javascript">DOMDisplay.prototype.drawFrame = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.actorLayer) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.removeChild(this.actorLayer); this.actorLayer = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.appendChild(this.drawActors()); this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.className = <span class="hljs-string"><span class="hljs-string">"game "</span></span> + (this.level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> || <span class="hljs-string"><span class="hljs-string">""</span></span>); this.scrollPlayerIntoView(); };</code> <br> <br>    wrapper      ,     -    ,    .    CSS,  ,         . <br> <br> <code class="css">.lost .player { background: rgb(<span class="hljs-number"><span class="hljs-number">160</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>); } .won .player { box-shadow: <span class="hljs-number"><span class="hljs-number">-4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white, <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">-7</span></span>px <span class="hljs-number"><span class="hljs-number">8</span></span>px white; }</code> <br> <br>        -,   .    ,        . <br> <br>  ,       .    scrollPlayerIntoView ‚Äì     ,       ,   ,       .  CSS    ,  ,       .      relative,          . <br> <br> <code class="css">.game { overflow: hidden; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-width: <span class="hljs-number"><span class="hljs-number">600</span></span>px; <span class="hljs-built_in"><span class="hljs-built_in">max</span></span>-height: <span class="hljs-number"><span class="hljs-number">450</span></span>px; position: relative; }</code> <br> <br>   scrollPlayerIntoView          .   ,    scrollLeft  scrollTop,      . <br> <br> <code class="javascript">DOMDisplay.prototype.scrollPlayerIntoView = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { var width = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientWidth; var height = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.clientHeight; var margin = width / <span class="hljs-number"><span class="hljs-number">3</span></span>; // The viewport var left = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft, right = left + width; var top = this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop, bottom = top + height; var player = this.level.player; var center = player.pos.plus(player.size.times(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) .times(scale); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &lt; left + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.x &gt; right - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollLeft = center.x + margin - width; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &lt; top + margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y - margin; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (center.y &gt; bottom - margin) this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.scrollTop = center.y + margin - height; };</code> <br> <br>     ,     Vector   ,   , .    ,     (   )   .     ,       ,        . <br> <br>    ,       .        ,    ,    .     ‚Äì DOM     .   scrollLeft  <span class="hljs-number"><span class="hljs-number">-10</span></span>,    <span class="hljs-number"><span class="hljs-number">0.</span></span> <br> <br>             ‚Äì      .          .    ¬´¬ª    ,   ,   . <br> <br>     ,        . <br> <br> <code class="javascript">DOMDisplay.prototype.clear = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>.parentNode.removeChild(this.<span class="hljs-built_in"><span class="hljs-built_in">wrap</span></span>); };</code> <br> <br>      . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;script&gt; var simpleLevel = new Level(simpleLevelPlan); var display = new DOMDisplay(document.body, simpleLevel); &lt;/script&gt;</code> <br> <br>  <code><code>   rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span></code>     CSS.  game.css     . <br> <br>    <br>       ‚Äì    .  ,     ‚Äì     ,        ,    (  ),      ( ). <br> <br>  .   ,     .      ,     .   ,            .   ,  ,   . <br> <br>        .   ,   ¬´ ¬ª,          .      ,         . <br> <br>  ,      ,  ,         .   ‚Äì   .         ‚Äì  ,  . <br> <br>      ,     .     ,     .        ‚Äì        .   ,    ,    . <br> <br>  ,     (   )  -    . <br> <br> <code class="javascript">Level.prototype.obstacleAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(pos, size)</span></span></span></span> { var xStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.x); var xEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.x + size.x); var yStart = Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>(pos.y); var yEnd = Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>(pos.y + size.y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || xEnd &gt; this.width || yStart &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"wall"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yEnd &gt; this.height) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"lava"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var y = yStart; y &lt; yEnd; y++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var x = xStart; x &lt; xEnd; x++) { var fieldType = this.grid[y][x]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldType) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fieldType; } } };</code> <br> <br>      ,  Math.<span class="hljs-built_in"><span class="hljs-built_in">floor</span></span>  Math.<span class="hljs-built_in"><span class="hljs-built_in">ceil</span></span>   . ,    ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">1</span></span> .      ,      ,   . <br> <br>     <br>     ,    ‚Äúwall‚Äù       ‚Äúlava‚Äù  .         .    ,       ,   ,      . <br> <br>      (,  )    .       ,    (   ). <br> <br>     ,   ,     : <br> <br> <code class="javascript">Level.prototype.actorAt = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (var i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; this.actors.length; i++) { var other = this.actors[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (other != actor &amp;&amp; actor.pos.x + actor.size.x &gt; other.pos.x &amp;&amp; actor.pos.x &lt; other.pos.x + other.size.x &amp;&amp; actor.pos.y + actor.size.y &gt; other.pos.y &amp;&amp; actor.pos.y &lt; other.pos.y + other.size.y) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other; } };</code> <br> <br>    <br>  animate  Level      .  step   .  keys     ,  . <br> <br> <code class="javascript">var maxStep = <span class="hljs-number"><span class="hljs-number">0.05</span></span>; Level.prototype.animate = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, keys)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> != null) this.finishDelay -= step; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (step &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { var thisStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(step, maxStep); this.actors.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { actor.act(thisStep, this, keys); }, this); step -= thisStep; } };</code> <br> <br>     <span class="hljs-built_in"><span class="hljs-built_in">status</span></span>  ,   null (  ,     ),      finishDelay,    ,       ,     . <br> <br>  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>       .  ,      maxStep.  ,   <span class="hljs-number"><span class="hljs-number">0.12</span></span>        <span class="hljs-number"><span class="hljs-number">0.05</span></span>    <span class="hljs-number"><span class="hljs-number">0.02</span></span> <br> <br>      act,    ,  level   keys.     Lava,    key: <br> <br> <code class="javascript">Lava.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level)</span></span></span></span> { var newPos = this.pos.plus(this.speed.times(step)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!level.obstacleAt(newPos, this.size)) this.pos = newPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (this.repeatPos) this.pos = this.repeatPos; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed = this.speed.times(<span class="hljs-number"><span class="hljs-number">-1</span></span>); };</code> <br> <br>    ,           .      ,  .   ,      .      repeatPos,          .      (  <span class="hljs-number"><span class="hljs-number">-1</span></span>),      . <br> <br>    act,  .   ,       ,        act . <br> <br> <code class="javascript">var wobbleSpeed = <span class="hljs-number"><span class="hljs-number">8</span></span>, wobbleDist = <span class="hljs-number"><span class="hljs-number">0.07</span></span>; Coin.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { this.wobble += step * wobbleSpeed; var wobblePos = Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>(this.wobble) * wobbleDist; this.pos = this.basePos.plus(new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, wobblePos)); };</code> <br> <br>  wobble ,    ,      Math.<span class="hljs-built_in"><span class="hljs-built_in">sin</span></span>   ,      . <br> <br>  .       ,          ,     ‚Äì   .      . <br> <br> <code class="javascript">var playerXSpeed = <span class="hljs-number"><span class="hljs-number">7</span></span>; Player.prototype.moveX = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.x = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.left) this.speed.x -= playerXSpeed; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.right) this.speed.x += playerXSpeed; var motion = new Vector(this.speed.x * step, <span class="hljs-number"><span class="hljs-number">0</span></span>); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.pos = newPos; };</code> <br> <br>       ¬´¬ª  ¬´¬ª.       ,    playerTouched,        .       . <br> <br>      ,     . <br> <br> <code class="javascript">var gravity = <span class="hljs-number"><span class="hljs-number">30</span></span>; var jumpSpeed = <span class="hljs-number"><span class="hljs-number">17</span></span>; Player.prototype.moveY = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.speed.y += step * gravity; var motion = new Vector(<span class="hljs-number"><span class="hljs-number">0</span></span>, this.speed.y * step); var newPos = this.pos.plus(motion); var obstacle = level.obstacleAt(newPos, this.size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obstacle) { level.playerTouched(obstacle); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (keys.up &amp;&amp; this.speed.y &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) this.speed.y = -jumpSpeed; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> this.speed.y = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { this.pos = newPos; } };</code> <br> <br>       ,   . ,              .    ,     . <br> <br>     .    ,   .    ¬´¬ª,     ( ,    -,    ),      .    .   ,    -    . <br> <br>   act : <br> <br> <code class="javascript">Player.prototype.act = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step, level, keys)</span></span></span></span> { this.moveX(step, level, keys); this.moveY(step, level, keys); var otherActor = level.actorAt(this); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherActor) level.playerTouched(otherActor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, otherActor); // Losing animation <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) { this.pos.y += step; this.size.y -= step; } };</code> <br> <br>      ,    ,    playerTouched,   .         actor,       ,  playerTouched  ,     . <br> <br>  ,    (  ),    , -    ( ),    player. <br> <br>  ,       : <br> <br> <code class="javascript">Level.prototype.playerTouched = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(type, actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"lava"</span></span> &amp;&amp; this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == null) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"lost"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>) { this.actors = this.actors.filter(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(other)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> other != actor; }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!this.actors.some(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(actor)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> actor.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"coin"</span></span>; })) { this.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> = <span class="hljs-string"><span class="hljs-string">"won"</span></span>; this.finishDelay = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } };</code> <br> <br>    ,     ‚Äúlost‚Äù.   ,     ,      ‚Äì     ‚Äúwon‚Äù.     ,   .    ,  . <br> <br>   <br>       ,      keypress.   ,   ,    ( ) <br> <br>     ,     ,    .       preventDefault,     . <br> <br>  ,                 ,   ,     .       <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>  <span class="hljs-string"><span class="hljs-string">"keyup"</span></span>,         ,  . <br> <br> <code class="java">var arrowCodes = {<span class="hljs-number"><span class="hljs-number">37</span></span>: <span class="hljs-string"><span class="hljs-string">"left"</span></span>, <span class="hljs-number"><span class="hljs-number">38</span></span>: <span class="hljs-string"><span class="hljs-string">"up"</span></span>, <span class="hljs-number"><span class="hljs-number">39</span></span>: <span class="hljs-string"><span class="hljs-string">"right"</span></span>}; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">trackKeys</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(codes)</span></span></span></span> { var pressed = Object.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(null); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(event)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (codes.hasOwnProperty(event.keyCode)) { var down = event.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == <span class="hljs-string"><span class="hljs-string">"keydown"</span></span>; pressed[codes[event.keyCode]] = down; event.preventDefault(); } } addEventListener(<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>, handler); addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, handler); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pressed; }</code> <br> <br>  ,         .    <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>  , ,       <span class="hljs-literal"><span class="hljs-literal">true</span></span> (<span class="hljs-string"><span class="hljs-string">"keydown"</span></span>)  <span class="hljs-literal"><span class="hljs-literal">false</span></span> (<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>). <br> <br>   <br>  requestAnimationFrame,      <span class="hljs-number"><span class="hljs-number">13</span></span>,     .     ‚Äì       ,        ,   requestAnimationFrame     . <br> <br>    ,       ,      runAnimation,   ,         .   frame  <span class="hljs-literal"><span class="hljs-literal">false</span></span>,  . <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runAnimation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frameFunc)</span></span></span></span> { var lastTime = null; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">frame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(time)</span></span></span></span> { var stop = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastTime != null) { var timeStep = Math.<span class="hljs-built_in"><span class="hljs-built_in">min</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">time</span></span> - lastTime, <span class="hljs-number"><span class="hljs-number">100</span></span>) / <span class="hljs-number"><span class="hljs-number">1000</span></span>; stop = frameFunc(timeStep) === <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } lastTime = <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!stop) requestAnimationFrame(frame); } requestAnimationFrame(frame); }</code> <br> <br>        <span class="hljs-number"><span class="hljs-number">100</span></span>  (<span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span> ).      ,  requestAnimationFrame ,        .   ,   lastTime       ,      .            (     animate). <br> <br>        ,   ,  . <br> <br>  runLevel   Level,   display, ,   ‚Äì .     document.body      .    (  ), runLevel  ,  ,     andThen,     . <br> <br> <code class="javascript">var arrows = trackKeys(arrowCodes); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); }</code> <br> <br>  ‚Äì   .   ,   .   ,    .     ,     ( )   display <br> <br> <code class="javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> <br> <br>      .   runAnimation  runLevel ‚Äì   ,     ,      <span class="hljs-number"><span class="hljs-number">5.</span></span>   ,   ,   -  ,      .   ‚Äì  .     ,     ,        . <br> <br>      .   ‚Äì    ,        ,     ,       ‚Äì ,     <span class="hljs-number"><span class="hljs-number">17</span></span>,         <span class="hljs-number"><span class="hljs-number">20.</span></span> <br> <br>   GAME_LEVELS    .      runGame,    . <br> <br> <code class="html">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  .   ,  . <br> <br>  <br>   <br>  ,      ,         .   ,   . <br> <br>  runGame,    .     . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runGame ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(plans, Display)</span></span></span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(n)</span></span></span></span> { runLevel(new Level(plans[n]), Display, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(status)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == <span class="hljs-string"><span class="hljs-string">"lost"</span></span>) startLevel(n); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; plans.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) startLevel(n + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> console.<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-string"><span class="hljs-string">"You win!"</span></span>); }); } startLevel(<span class="hljs-number"><span class="hljs-number">0</span></span>); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code> <br> <br>  <br>            Esc. <br> <br>   ,   runLevel,       ,        Esc. <br> <br>     ,   runAnimation     ‚Äì        runLevel,  . <br> <br>  ,    -.         .  arrows ‚Äì  ,       ,     .  ,    .  trackKeys,         runLevel,      ,    . <br> <br> <code class="javascript">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"css/game.css"</span></span>&gt; &lt;body&gt; &lt;script&gt; //   runLevel ‚Äì  ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runLevel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(level, Display, andThen)</span></span></span></span> { var display = new Display(document.body, level); runAnimation(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(step)</span></span></span></span> { level.animate(step, arrows); display.drawFrame(step); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (level.isFinished()) { display.clear(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (andThen) andThen(level.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }); } runGame(GAME_LEVELS, DOMDisplay); &lt;/script&gt; &lt;/body&gt;</code></code></code></code></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/244405/">https://habr.com/ru/post/244405/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244387/index.html">We introduce material design</a></li>
<li><a href="../244389/index.html">Flash Drive OneDrive - portable version for OneDrive</a></li>
<li><a href="../244391/index.html">Prepare a sleigh in the summer: Check your readiness for holiday sales (before customers do this)</a></li>
<li><a href="../244395/index.html">Samsung EYECAN + - mouse for people with disabilities</a></li>
<li><a href="../244397/index.html">Monetization of Oculus Rift and Leap motion in quests in reality</a></li>
<li><a href="../244407/index.html">We build robotboks with Wifi control, camera, gun, blackjack, etc.</a></li>
<li><a href="../244413/index.html">Update the app and get a comprehensive promotion package.</a></li>
<li><a href="../244415/index.html">Project Miranda NG receives the ‚ÄúWild Signs‚Äù award (part two)</a></li>
<li><a href="../244417/index.html">Development of the game in 115 kb - hacks, bugs and annoyance</a></li>
<li><a href="../244419/index.html">Productivity without slaps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>