<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write the first microservice on Node.js with communication through RabbitMQ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Over time, each project grows and it becomes more difficult, longer and more expensive for the business to implement the new functionality into the ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write the first microservice on Node.js with communication through RabbitMQ</h1><div class="post__text post__text-html js-mediator-article"><p>  Over time, each project grows and it becomes more difficult, longer and more expensive for the business to implement the new functionality into the existing monolith. </p><br><p>  One of the solutions to this problem is the use of microservice architecture.  For beginners or for those who first encounter this architecture, it can be difficult to understand where to start, what to do and what not to do. </p><a name="habracut"></a><br><p>  In this article, the simplest microservice will be written on Nodejs &amp; RabbitMQ, and the process of monolith migration to microservices is also shown. </p><br><h1 id="chto-est-v-mikroservisnoy-arhitekture">  What is in microservice architecture? </h1><br><ol><li>  Gateway  The main server that accepts requests and redirects them to the desired microservice.  Most often, there is no business logic in gateway. </li><li>  Microservice.  Microservice itself, which handles user requests with clearly defined business logic. </li><li>  Transport.  This is the part through which Gateway &amp; Microservice will communicate.  HTTP, gRPC, RabbitMQ, etc. can act as a transport. </li></ol><br><h1 id="pochemu-imenno-rabbitmq">  Why use RabbitMQ? </h1><br><p>  Of course, you can not use RabbitMQ, there are other options for communication between microservices.  The easiest one is HTTP, there is gRPC from Google. </p><br><p>  I use RabbitMQ, because I consider it simple enough to start writing microservices, reliable and convenient in the sense that sending a message to a queue, you can be sure that the message will reach the microservice (even if it is turned off at the moment and then turned on ).  Thanks to these advantages, you can write reliable microservices and use seamless deploy. </p><br><h2 id="nachalo">  Start </h2><br><p>  To begin with, we will implement a simple gateway that will accept HTTP requests while listening to a specific port. </p><br><p>  We deploy RabbitMQ (through it our microservices and gateway will communicate): </p><br><pre><code class="plaintext hljs">$ docker run -d -p 5672:5672 rabbitmq</code> </pre> <br><p>  Initialize the project and install the <a href="https://github.com/bifot/micromq">micromq</a> NPM package: </p><br><pre> <code class="plaintext hljs">$ npm init -y $ npm i micromq -S</code> </pre> <br><h3 id="pishem-gateway">  We write gateway </h3><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Gateway     micromq const Gateway = require('micromq/gateway'); //    Gateway const app = new Gateway({ //  ,      microservices: ['users'], //  rabbitmq rabbit: { //     rabbitmq (default: amqp://guest:guest@localhost:5672) url: process.env.RABBIT_URL, }, }); //    /friends &amp; /status   GET app.get(['/friends', '/status'], async (req, res) =&gt; { //     users await res.delegate('users'); }); //    app.listen(process.env.PORT);</span></span></code> </pre> <br><p>  <strong>How it will work:</strong> </p><br><ol><li>  The server starts, it starts listening to the port and receiving requests </li><li>  User sends a request to <a href="https://mysite.com/friends">https://mysite.com/friends</a> </li><li>  Gateway, according to the logic we described, delegates the request: <br>  3.1. The message is being sent (request parameters, headers, connection information, etc.) to the RabbitMQ queue <br>  3.2.  Microservice listens to this queue, processes a new request. <br>  3.3.  Microservice sends a response to the queue <br>  3.4.  Gateway listens to the response queue, receives a response from microservice <br>  3.5.  Gateway sends a response to the client. </li><li>  User gets answer </li></ol><br><h3 id="pishem-mikroservis">  We write microservice </h3><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   MicroService     micromq const MicroMQ = require('micromq'); //    MicroService const app = new MicroMQ({ //   (    ,    Gateway) name: 'users', //  rabbitmq rabbit: { //     rabbitmq (default: amqp://guest:guest@localhost:5672) url: process.env.RABBIT_URL, }, }); //   /friends   GET app.get('/friends', (req, res) =&gt; { //  json  res.json([ { id: 1, name: 'Mikhail Semin', }, { id: 2, name: 'Ivan Ivanov', }, ]); }); //   /status   GET app.get('/status', (req, res) =&gt; { //  json  res.json({ text: 'Thinking...', }); }); //     app.start();</span></span></code> </pre> <br><p>  <strong>How it will work:</strong> </p><br><ol><li>  The microservice starts, starts listening to the queue of requests that Gateway will write to </li><li>  Microservice receives a request, processes it, driving it through all available middlewares </li><li>  Microservice sends a response to Gateway <br>  3.1.  Sending message (headers, HTTP code response body) to RabbitMQ queue <br>  3.2.  Gateway listens to this queue, receives a message, finds a client to whom to send a response <br>  3.3 Gateway sends response to client </li></ol><br><h2 id="migraciya-monolita-na-mikroservisnuyu-arhitekturu">  Monolith Migration to Microservice Architecture </h2><br><p>  Suppose that we already have an application on express, and we want to start transferring it to microservices. </p><br><p>  It looks like this: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = express(); app.get(<span class="hljs-string"><span class="hljs-string">'/balance'</span></span>, (req, res) =&gt; { res.json({ <span class="hljs-attr"><span class="hljs-attr">amount</span></span>: <span class="hljs-number"><span class="hljs-number">500</span></span>, }); }); app.get(<span class="hljs-string"><span class="hljs-string">'/friends'</span></span>, (req, res) =&gt; { res.json([ { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Mikhail Semin'</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'Ivan Ivanov'</span></span>, }, ]); }); app.get(<span class="hljs-string"><span class="hljs-string">'/status'</span></span>, (req, res) =&gt; { res.json({ <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'Thinking...'</span></span>, }); }); app.listen(process.env.PORT);</code> </pre> <br><p>  We want to take out from it 2 endpoints: / friends and / status.  What do we need to do for this? </p><br><ol><li>  Take business logic to microservice </li><li>  Implement the delegation of requests for these two endpoints to microservice </li><li>  Get a response from microservice </li><li>  Send response to customer </li></ol><br><p>  In the example above, when we created microservice users, we implemented two methods / friends and / status, which do the same thing that our monolith does. </p><br><p>  In order to proxy requests to microservice from gateway, we will use the same package, connecting the middleware to our express application: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   Gateway     micromq const Gateway = require('micromq/gateway'); const app = express(); //    Gateway const gateway = new Gateway({ //   (    ,    Gateway) name: 'users', //  rabbitmq rabbit: { //     rabbitmq (default: amqp://guest:guest@localhost:5672) url: process.env.RABBIT_URL, }, }); //  middleware  ,      app.use(gateway.middleware()); //    ,          app.get('/balance', (req, res) =&gt; { res.json({ amount: 500, }); }); //    /friends &amp; /status   GET app.get(['/friends', '/status'], async (req, res) =&gt; { //     users //  res.delegate   middleware,     await res.delegate('users'); }); //   app.listen(process.env.PORT);</span></span></code> </pre> <br><p>  This works in the same way as in the example above, where we wrote the pure Gateway.  In this example, the only difference is that the requests are received not by the Gateway, but by a monolith written in express. </p><br><h2 id="chto-dalshe">  What's next </h2><br><ol><li>  RPC (remote action call) from microservice to monolith / gateway (for example, for authorization) </li><li>  Communicate between microservices through the RabbitMQ queues for more information, because each microservice has its own database </li></ol><br><p>  I already told you this in the article <a href="https://habr.com/ru/post/447250/">‚ÄúLearning to communicate between microservices on Node.js via RabbitMQ‚Äù</a> . </p><br><ul><li>  <a href="https://github.com/bifot/micromq">Link to library source code</a> </li><li>  <a href="https://www.npmjs.com/package/micromq">Link to the package in the NPM registry</a> </li><li>  <a href="https://github.com/bifot/micromq/tree/master/examples">Code examples in the article</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/447074/">https://habr.com/ru/post/447074/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447062/index.html">The history of audio technology: synthesizers and samplers</a></li>
<li><a href="../447064/index.html">Meet the Open Source License Compliance Handbook</a></li>
<li><a href="../447068/index.html">Matching similar strings</a></li>
<li><a href="../447070/index.html">Crash tests SHD AERODISK ENGINE N2, strength test</a></li>
<li><a href="../447072/index.html">‚ÄúI did everything - it was a funny story‚Äù: a podcast about content marketing and a career in IT media</a></li>
<li><a href="../447076/index.html">OWASP Russia Meetup - recording speeches</a></li>
<li><a href="../447080/index.html">Networks for the smallest. Part oh, everything</a></li>
<li><a href="../447082/index.html">How to set up task types and not go crazy</a></li>
<li><a href="../447088/index.html">Cellular Breadboard</a></li>
<li><a href="../447090/index.html">Reference: how the process of continuous integration is arranged</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>