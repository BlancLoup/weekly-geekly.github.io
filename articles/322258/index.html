<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write game logic in C #. Part 1/2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. In connection with the release of my SpaceLab game at GreenLight, I decided to start a series of articles on game development in C # / Unity. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write game logic in C #. Part 1/2</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/681/92c/36d/68192c36d912459bac96e1cb223b3c98.jpg" align="left">  Hello.  In connection with the release of my SpaceLab game at GreenLight, I decided to start a series of articles on game development in C # / Unity.  It will be based on the actual experience of its development and slightly different from the standard guides for beginners: <br><br>  First, I will not repeat the documentation in other words. <br>  Secondly, you need programming knowledge to understand what I am writing about. <br><br><hr>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, this article will not be able to help you if you want to create your casual game using just a mouse. <br><br>  But then, step by step, I will talk about the creation of an engine, on which the game logic of our economic strategy will work. <br><br>  For those who love spoilers or just want to read the code - at the end there is a link not a repository, where each item is added by a separate commit. <br><br>  Anyone interested to know what the game is - at the bottom there is a video and a link to a free download. <br><a name="habracut"></a><br>  I‚Äôll warn you right away that I don‚Äôt have a goal to ideally apply a huge number of patterns or describe an approach to TTD methodology.  In the article I try to write a readable, maintainable, and reckless code, as it would have been written in life.  Perhaps people with a huge skill in C # and writing games will find this article obvious.  Nevertheless, the question of how to write game logic I heard quite often and this article is perfect for those who are interested in writing a server and those who are interested in writing a client on Unity. <br><br><h3>  A brief description of the GD we want to achieve </h3><br>  1. The player controls the ship.  In the ship, you can build rooms, in the rooms you can add modules to the slots. <br><br>  2. To build something you need to spend resources and wait for time. <br><br>  After six months of development, the result should look something like this) <br><br><img src="https://habrastorage.org/files/cc8/9a5/b92/cc89a5b928b44646bc29fe9d4bf0768d.jpg" width="640"><br><br><h3>  Work plan </h3><br>  1. Set up projects <br>  2. Create a core - basic facilities <br>  3. Add and test the first commands - build the structure and module <br>  4. We take out the settings of buildings and modules in a separate file. <br>  5. Add the flow of time <br>  6. Add Constructible, buildings are now under construction for some time. <br>  7. Add resources, for the construction of the necessary resources <br>  8. Add a production cycle - the module consumes and issues resources. <br><br>  The article was very voluminous, so I had to divide it into two parts.  In this part we will do the first five points, and <a href="https://habrahabr.ru/post/322268/">in the second part</a> we‚Äôll finish <br><br><h2>  1. Set up projects </h2><br>  At the beginning, we will not need the Unity Editor - we write Game Logic.  We open VS and we create two projects: <code>GameLogic</code> and <code>LogicTests</code> (Unit Tests Project).  In the first, we will write the actual logic of the game on pure C # without using the Unity namespace, the second will test our logic with the built-in test tool.  Let's add the first Core class to GameLogic and write the first test to check our bundle: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Core</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Core</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} }</code> </pre> <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestClass</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Init</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestMethod1</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Assert.IsInstanceOfType(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(), <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Core)); } }</code> </pre> </blockquote><br><img src="https://habrastorage.org/files/5a6/8f6/6cf/5a68f66cfa3043e8979ebba958152d69.png"><br><br><h2>  2. Create a core - basic facilities </h2><br>  Well, this indicates that we have set up correctly and you can proceed to programming logic. <br><br>  So, let's deal with our game design.  We have a ship (Ship), there are rooms (Room) in it, a Building can be built into each room, and there can be modules (Module) in each building.  Of course, Room and Building could be merged into one entity, but further such separation will only help us. <br><br>  For all these structures, I will create a separate namespace Architecture and base classes.  And also enum for indices of rooms.  Many things we are doing now are temporary and necessary to run the first test of game logic. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> BuildingType { Empty, PowerPlant }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ModuleType { Generator }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Core</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Ship Ship = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ship(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Core</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Ship.CreateEmptyRooms(); } }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Ship</span></span> { <span class="hljs-comment"><span class="hljs-comment">//      public readonly int RoomsLimit = 10; private readonly List&lt;Room&gt; rooms = new List&lt;Room&gt;(); public IEnumerable&lt;Room&gt; Rooms { get { return rooms; } } public void CreateEmptyRooms () { for (var i = 0; i &lt; RoomsLimit; i++) { rooms.Add(new Room(i)); } } public Room GetRoom (int index) { return rooms[index]; } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Room</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Index; <span class="hljs-comment"><span class="hljs-comment">//       public Building Building { get; set; } public Room (int index) { Index = index; //  - -    Building = new Building(BuildingType.Empty); } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Building</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ,      public readonly int ModulesLimit = 10; public readonly BuildingType Type; //        private readonly Dictionary&lt;int, Module&gt; modules = new Dictionary&lt;int, Module&gt;(); public IEnumerable&lt;Module&gt; Modules { get { return modules.Values; } } public Building (BuildingType type) { Type = type; } public Module GetModule (int position) { return modules.ContainsKey(position) ? modules[position] : null; } public void SetModule (int position, Module module) { if (position &lt; 0 || position &gt;= ModulesLimit) { throw new IndexOutOfRangeException( "Position " + position + " is out of range [0:" + ModulesLimit + "]" ); } modules[position] = module; } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Module</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ModuleType Type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Module</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModuleType type</span></span></span><span class="hljs-function">)</span></span> { Type = type; } }</code> </pre> </blockquote><br><h2>  3. Add and test the first commands - build the structure and module </h2><br><br>  Now we can write the first ‚Äúfeature‚Äù - the construction of the building and the construction of the module in it.  I will describe all such actions as a separate class that will inherit from the Command class: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Core Core { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsValid { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Command </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Core core</span></span></span><span class="hljs-function">)</span></span> { Core = core; IsValid = Run(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> </blockquote><br>  And although now even such a small structure is unnecessary - a little later, thanks to it, we will fix the events we need.  And the existence of each atomic action in a separate team will allow us to combine them.  Let's write our first two steps: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BuildingConstruct</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Room Room; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Building Building; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BuildingConstruct</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Room room, Building building</span></span></span><span class="hljs-function">)</span></span> { Room = room; Building = building; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ,   -  if (Room.Building.Type != BuildingType.Empty) { return false; } //     if (Building.Type == BuildingType.Empty) { return false; } Room.Building = Building; return true; } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConstruct</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Building Building; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Module Module; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Position; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModuleConstruct</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Building building, Module module, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> position</span></span></span><span class="hljs-function">)</span></span> { Building = building; Module = module; Position = position; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Building.Type == BuildingType.Empty) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Position &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || Position &gt;= Building.ModulesLimit) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Building.GetModule(Position) != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } Building.SetModule(Position, Module); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> </blockquote><br>  It's time to see if our engine works.  In tests we create a kernel, try to build a room, and in it we try to build a module.  In addition, it is worth adding a check that it is impossible to build something that the game logic should not allow to build: <br><br><blockquote><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestClass</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Architecture</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CorrectConstruction</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); Assert.AreEqual(BuildingType.Empty, room.Building.Type); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, room.Building.Modules.Count()); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Building(BuildingType.PowerPlant) ) .Execute(core) .IsValid ); Assert.AreEqual(BuildingType.PowerPlant, room.Building.Type); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, room.Building.Modules.Count()); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( room.Building, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Module(ModuleType.Generator), <span class="hljs-number"><span class="hljs-number">2</span></span> ) .Execute(core) .IsValid ); Assert.AreEqual(BuildingType.PowerPlant, room.Building.Type); Assert.AreEqual(ModuleType.Generator, room.Building.GetModule(<span class="hljs-number"><span class="hljs-number">2</span></span>).Type); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">1</span></span>, room.Building.Modules.Count()); } [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IncorrectConstruction</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Building(BuildingType.Empty) ) .Execute(core) .IsValid ); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( room.Building, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Module(ModuleType.Generator), <span class="hljs-number"><span class="hljs-number">2</span></span> ) .Execute(core) .IsValid ); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Building(BuildingType.PowerPlant) ) .Execute(core); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Building(BuildingType.PowerPlant) ) .Execute(core) .IsValid ); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( room.Building, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Module(ModuleType.Generator), <span class="hljs-number"><span class="hljs-number">666</span></span> ) .Execute(core) .IsValid ); } }</code> </pre> </blockquote><br><img src="https://habrastorage.org/files/40d/807/d3a/40d807d3a908424ea3e0583e9e26f1e2.png"><br><br><h2>  4. We take out the settings of buildings and modules in a separate file. </h2><br>  Fortunately, our tests are perfectly passed.  Now we need the ability to linearly expand the number of buildings and modules - for this we need to do the following: <br><br><ol><li>  Create a configuration for buildings and modules - " <code>class BuildingConfig</code> " and " <code>class ModuleConfig</code> ", they will keep all the settings of our facilities. </li><li>  Building and Module should take appropriate settings upon creation. </li><li>  Make a factory to create modules and buildings </li><li>  Add settings for multiple buildings and modules </li><li>  Adapt existing code to new input. </li></ol><br><blockquote><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   public class BuildingConfig { public BuildingType Type; //    public int ModulesLimit; //        public ModuleType[] AvailableModules; }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConfig</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ModuleType Type; }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Building</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public readonly BuildingConfig Config; // ... //    ,    public Building (BuildingConfig config) { Type = config.Type; ModulesLimit = config.ModulesLimit; Config = config; } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Module</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... public readonly ModuleConfig Config; //    ,    public Module (ModuleConfig config) { // ... Type = config.Type; Config = config; } }</span></span></code> </pre> </blockquote><br>  As you can see, now our code is non-working.  In order not to carry configs every time with us, we will create a factory that will manufacture our buildings knowing only their type.  I know that the name is still too general, but we can always easily rename it thanks to the IDE, as well as divide it into two factories: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Building </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProduceBuilding</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BuildingType type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Not implemented yet"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Module </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProduceModule</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModuleType type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Not implemented yet"</span></span>); } }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//       : public class Core { // ... public readonly Factory Factory = new Factory(); public Core () { //      Ship.CreateEmptyRooms(Factory); } }</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//       : public class Ship { // ... public void CreateEmptyRooms (Factory factory) { for (var i = 0; i &lt; RoomsLimit; i++) { rooms.Add(new Room(i, factory.ProduceBuilding(BuildingType.Empty))); } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   -   -: public class Room { // ... public Room (int index, Building building) { Index = index; Building = building; } }</span></span></code> </pre> </blockquote><br>  Now the IDE indicates where we have errors - we replace the constructor‚Äôs call for using the factory. <br><blockquote><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   new Building(Type); //   core.Factory.ProduceBuilding(Type);</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//   new Module(Type); //   core.Factory.ProduceModule(Type);</span></span></code> </pre> <br></blockquote><br>  And although the code is now correct - when we run our tests, we say <code>"Not implemented yet"</code> .  To do this, go back to our factory and implement several buildings and modules. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Factory</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;BuildingType, BuildingConfig&gt; buildings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;BuildingType, BuildingConfig&gt;() { { BuildingType.Empty, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConfig() { Type = BuildingType.Empty }}, { BuildingType.PowerPlant, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConfig() { Type = BuildingType.PowerPlant, ModulesLimit = <span class="hljs-number"><span class="hljs-number">5</span></span>, AvailableModules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[]{ ModuleType.Generator } }}, { BuildingType.Smeltery, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConfig() { Type = BuildingType.Smeltery, ModulesLimit = <span class="hljs-number"><span class="hljs-number">4</span></span>, AvailableModules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[]{ ModuleType.Furnace } }}, { BuildingType.Roboport, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConfig() { Type = BuildingType.Roboport, ModulesLimit = <span class="hljs-number"><span class="hljs-number">3</span></span>, AvailableModules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[]{ ModuleType.Digger, ModuleType.Miner } }} }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Dictionary&lt;ModuleType, ModuleConfig&gt; modules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;ModuleType, ModuleConfig&gt;() { { ModuleType.Generator, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConfig() { Type = ModuleType.Generator }}, { ModuleType.Furnace, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConfig() { Type = ModuleType.Furnace }}, { ModuleType.Digger, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConfig() { Type = ModuleType.Digger }}, { ModuleType.Miner, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConfig() { Type = ModuleType.Miner }} }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Building </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProduceBuilding</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BuildingType type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!buildings.ContainsKey(type)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Unknown building type: "</span></span> + type); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Building(buildings[type]); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Module </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProduceModule</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModuleType type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!modules.ContainsKey(type)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"Unknown module type: "</span></span> + type); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Module(modules[type]); } }</code> </pre></blockquote><br>  I immediately added several buildings and modules so that it could be covered with tests.  And I will immediately say - yes, there is no point in storing all these settings in the factory.  They will be stored separately in JSON files, one per structure, parsed and transferred to the factory.  Fortunately, our engine will not even notice this change.  In the meantime, we are not so critical to bring them to HSON, how to run tests and check whether everything works correctly.  Fortunately, yes.  At the same time, let's add tests that it is impossible to build a module in the wrong room, for example, Furnace in PowerPlant. <br><br><blockquote><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CantConstructInWrongBuilding</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameLogic.Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> room = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( room, core.Factory.ProduceBuilding(BuildingType.PowerPlant) ) .Execute(core); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( room.Building, core.Factory.ProduceModule(ModuleType.Furnace), <span class="hljs-number"><span class="hljs-number">2</span></span> ) .Execute(core) .IsValid ); Assert.AreEqual(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, room.Building.GetModule(<span class="hljs-number"><span class="hljs-number">2</span></span>)); }</code> </pre></blockquote><br>  Alas, as you can guess, no one has written the verification logic.  Add a validation condition to the module construction team and after that successfully pass the test: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ModuleConstruct</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... protected override bool Run () { // ... if (!Building.Config.AvailableModules.Contains(Module.Type)) { return false; } // ...</span></span></code> </pre></blockquote><br>  Well, now everything is correct.  At the same time, we add tests for the correct operation of the limits and move on. <br><br><blockquote><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ModulesLimits</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameLogic.Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roomRoboport = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roomPowerPlant = core.Ship.GetRoom(<span class="hljs-number"><span class="hljs-number">1</span></span>); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( roomRoboport, core.Factory.ProduceBuilding(BuildingType.Roboport) ) .Execute(core) .IsValid ); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BuildingConstruct( roomPowerPlant, core.Factory.ProduceBuilding(BuildingType.PowerPlant) ) .Execute(core) .IsValid ); Assert.IsFalse( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( roomRoboport.Building, core.Factory.ProduceModule(ModuleType.Miner), <span class="hljs-number"><span class="hljs-number">3</span></span> ) .Execute(core) .IsValid ); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ModuleConstruct( roomPowerPlant.Building, core.Factory.ProduceModule(ModuleType.Generator), <span class="hljs-number"><span class="hljs-number">3</span></span> ) .Execute(core) .IsValid ); }</code> </pre></blockquote><br><img src="https://habrastorage.org/files/6d9/8ae/783/6d98ae7838bc46ae9837a27bf31093b9.png"><br><br><h2>  5. Add the flow of time </h2><br>  Computers are discrete.  And all games are discrete.  Simply put, let's imagine that all games are step by step.  Most games skip steps automatically and 60 times per second.  Such games are called realtime.  I understand that this is very rough, but for the implementation of game logic it is quite convenient to imagine that your game is turn-based and to think in such categories.  And then already on the client, you can run tween between two states and the user will be beautiful and the game will work quickly.  To begin with, we introduce the concept of a move: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Turns</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CurrentTurn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextTurn</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CurrentTurn++; } }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Core</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Turns Turns = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Turns(); }</code> </pre></blockquote><br>  And also we will enter command which allows to switch the course.  I immediately added a command that allows you to switch several moves - it will be quite convenient during testing.  In tests, we will cut two birds with one stone at a time. <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NextTurn</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//       Core.Turns.NextTurn(); return true; } }</span></span></code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NextTurnCount</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Max = <span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Count; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextTurnCount</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { Count = count; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Run</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Count &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || Count &gt; Max) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nextTurn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurn().Execute(Core); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!nextTurn.IsValid) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre> <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestClass</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Turns</span></span> { [TestMethod] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NextTurnsCommand</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, core.Turns.CurrentTurn); Assert.IsTrue( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NextTurnCount(<span class="hljs-number"><span class="hljs-number">4</span></span>) .Execute(core) .IsValid ); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">4</span></span>, core.Turns.CurrentTurn); } }</code> </pre></blockquote><br>  Running far ahead I will write how to make a speed switch in the game, which will allow us to run at different speeds: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TimeWarp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Speed_Stop = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Speed_X1 = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Speed_X2 = <span class="hljs-number"><span class="hljs-number">500</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Speed_X5 = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Core Core; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentSpeed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentTime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimeWarp</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Core core</span></span></span><span class="hljs-function">)</span></span> { currentSpeed = Speed_Stop; Core = core; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetSpeed</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> speed</span></span></span><span class="hljs-function">)</span></span> { currentSpeed = speed; currentTime = Math.Min(speed, currentTime); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetSpeed</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSpeed; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsStopped</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> currentSpeed == Speed_Stop; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTime</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ms</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsStopped()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; currentTime += ms; <span class="hljs-comment"><span class="hljs-comment">//     // while (currentTime &gt;= currentSpeed) NextTurn //        ? //  20        if (currentTime &lt; currentSpeed) return; currentTime -= currentSpeed; new NextTurn().Execute(ore); } }</span></span></code> </pre><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestMethod</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TimeWarp</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> core = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Core(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> time = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TimeWarp(core); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">0</span></span>, core.Turns.CurrentTurn); time.SetSpeed(time.Speed_X5); time.AddTime(<span class="hljs-number"><span class="hljs-number">50</span></span>); time.AddTime(<span class="hljs-number"><span class="hljs-number">50</span></span>); time.AddTime(<span class="hljs-number"><span class="hljs-number">50</span></span>); time.AddTime(<span class="hljs-number"><span class="hljs-number">50</span></span>); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">1</span></span>, core.Turns.CurrentTurn); time.AddTime(<span class="hljs-number"><span class="hljs-number">199</span></span>); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">1</span></span>, core.Turns.CurrentTurn); time.AddTime(<span class="hljs-number"><span class="hljs-number">1</span></span>); Assert.AreEqual(<span class="hljs-number"><span class="hljs-number">2</span></span>, core.Turns.CurrentTurn); }</code> </pre></blockquote><br>  Now in Unity it will be enough to hang on any Update and transfer the delta time to our TimeWarp: <br><br><blockquote><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeComponent : MonoBehaviour { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeWarp timeWarp; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Awake</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { timeWarp = ...; <span class="hljs-comment"><span class="hljs-comment">// } public void Update () { timeWarp.AddTime( Time.deltaTime ); } }</span></span></code> </pre></blockquote><br><img src="https://habrastorage.org/files/269/e12/ab1/269e12ab1e064244bbd6432adfec94b9.png"><br><br><h2>  To be continued... </h2><br>  In the <a href="https://habrahabr.ru/post/322268/">next article</a> we will complete the creation of a workable basis for our engine by implementing the following points: <br><br>  6. Add Constructible, buildings are now under construction for some time. <br>  7. Add resources, for the construction of the necessary resources <br>  8. Add a production cycle - the module consumes and issues resources. <br><br>  For those who just love the code - there is a <a href="https://github.com/theshock/GameLogicArticle">separate repository on GitHub.</a> <br><br>  In addition, if you are interested in questions on the development of SpaceLab - ask, I will answer them in the comments or in a separate article <br><iframe width="560" height="315" src="https://www.youtube.com/embed/hurYrNk7u24" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Download for Windows, Linux, Mac for free and without SMS can be from the <a href="http://steamcommunity.com/sharedfiles/filedetails/%3Fid%3D868755125">SpaceLab page on GreenLight</a> </div><p>Source: <a href="https://habr.com/ru/post/322258/">https://habr.com/ru/post/322258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../322248/index.html">Physical backup: Veeam Endpoint Backup replaces Veeam Agent for Microsoft Windows</a></li>
<li><a href="../322250/index.html">Model of Actors and C ++: What, Why and How?</a></li>
<li><a href="../322252/index.html">What questions to ask at the interview</a></li>
<li><a href="../322254/index.html">Examples of how partners lose money when collaborating with CPA networks</a></li>
<li><a href="../322256/index.html">Why Kotlin sucks</a></li>
<li><a href="../322262/index.html">Mustached shooter of twenty-three polygons</a></li>
<li><a href="../322266/index.html">Tarantool: load testing</a></li>
<li><a href="../322268/index.html">We write game logic in C #. Part 2/2</a></li>
<li><a href="../322270/index.html">In defense, Zuckerberg takes Evan Spiegel "by the throat"</a></li>
<li><a href="../322272/index.html">How to wind 40k views on Habrahabr. Bug or feature?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>