<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Transition from DateTime to DateTimeOffset</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine that you want to transform your system from one state to another. The initial state is when DateTime is used everywhere, in C # code and in th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Transition from DateTime to DateTimeOffset</h1><div class="post__text post__text-html js-mediator-article">  Imagine that you want to transform your system from one state to another.  The initial state is when DateTime is used everywhere, in C # code and in the database.  The end state is when DateTimeOffset is used everywhere.  You want to make the transition smoothly and make as few changes as possible.  This description can be the beginning of a very interesting problem with a dead end at the end. <br><a name="habracut"></a><br>  The DateTime type was the default .NET type for working with date and time some time ago, and the logic usually built around it was made as if it would never change.  If you try to change the type in one step, it will lead to cascading changes in almost all parts of the system.  In extreme cases, you may need to change about 200 stored procedures for only one field.  This is the first problem.  And the second problem is that the consequences of such changes are difficult to find during testing.  Regression testing does not guarantee that you will not miss anything or that the system will function in all cases.  The necessary quality assurance efforts will increase as you work, and you will not have a clear understanding of when it will end. <br><br>  During my research, I found a possible approach to such transformations.  This approach has three stages and is based on the assumption that currently the system does not support time zones, and all subsystems are located in the same time zone. <br><br><ol><li>  Add a pair of calculated field to read the DateTimeOffset values ‚Äã‚Äãfrom the database. </li><li>  Make the conversion of read operations. </li><li>  Make the conversion of write operations. </li></ol><br>  This approach will help localize changes and limit QA efforts.  It will also provide good predictability for evaluating future work.  Below, I described the steps in more detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Failed Approach </h2><br>  Imagine that there are about 150 fields associated with date / time values.  You can use the following SQL script to find out the full list in your database. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> tbl.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'table'</span></span>, col.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'column'</span></span>, tp.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'type'</span></span>, def.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'default'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.columns <span class="hljs-keyword"><span class="hljs-keyword">col</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.tables tbl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tbl.[object_id] = col.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.types tp <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tp.system_type_id = col.system_type_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tp.name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'datetime'</span></span>, <span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'time'</span></span>, <span class="hljs-string"><span class="hljs-string">'datetime2'</span></span>, <span class="hljs-string"><span class="hljs-string">'datetimeoffset'</span></span>, <span class="hljs-string"><span class="hljs-string">'smalldatetime'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.default_constraints <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> def.parent_object_id = col.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> def.parent_column_id = col.column_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> tbl.name, col.name</code> </pre> <br>  While in DB the conversion from DateTime to DateTimeOffset and back is maintained at a very good level, in C # code it is difficult due to typing.  You cannot read the DateTime value if the database returns a DateTimeOffset value.  When changing the return type for one field, you need to change all the places where it is used throughout the system.  In some cases, this is simply not possible, because you may not know about some places if the system is very large.  It is for this reason that the approach of simply changing the field type will not work.  You can try to find all the uses of a specific table field in the database using the following script. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ROUTINE_NAME, ROUTINE_DEFINITION <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> INFORMATION_SCHEMA.ROUTINES <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROUTINE_DEFINITION <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%table%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> ROUTINE_DEFINITION <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%field%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ROUTINE_TYPE=<span class="hljs-string"><span class="hljs-string">'PROCEDURE'</span></span></code> </pre><br>  In order to make the transformation, it is important to predict in advance which parts of the system will be affected.  You should have an approach to localizing changes in a specific module of the system without disrupting the remaining parts. <br><br><h2>  Better approach </h2><br>  This approach is simply ‚Äúbetter‚Äù and not the best.  I still expect that some problems may appear in the future, but it looks more secure than the previous one.  The main difference is that you do not perform the conversion in one step.  There is a sequence of dependent changes that will give you control over the situation. <br><br><h3>  Creating a Computed Field </h3><br>  When you add a calculated duplicate field in the database, you enter a new field with the required type.  This will allow you to separate the read, write and separate the updated code from the old one.  This operation can easily be performed using a script, and no effort to ensure quality is required. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> sysname, @<span class="hljs-keyword"><span class="hljs-keyword">column</span></span> sysname, @<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> sysname, @<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> sysname <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> cols <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> tbl.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'table'</span></span>, col.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'column'</span></span>, tp.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'type'</span></span>, def.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">'default'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.columns <span class="hljs-keyword"><span class="hljs-keyword">col</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.tables tbl <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tbl.[object_id] = col.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.types tp <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> tp.system_type_id = col.system_type_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tp.name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'datetime'</span></span>, <span class="hljs-string"><span class="hljs-string">'date'</span></span>, <span class="hljs-string"><span class="hljs-string">'time'</span></span>, <span class="hljs-string"><span class="hljs-string">'datetime2'</span></span>, <span class="hljs-string"><span class="hljs-string">'smalldatetime'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.default_constraints <span class="hljs-keyword"><span class="hljs-keyword">def</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> def.parent_object_id = col.[object_id] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> def.parent_column_id = col.column_id <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> tbl.name, col.name <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> cols <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cols <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">column</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> @@FETCH_STATUS = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> @cmd <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> @cmd = <span class="hljs-string"><span class="hljs-string">'alter table ['</span></span>+@<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>+<span class="hljs-string"><span class="hljs-string">'] add ['</span></span>+@<span class="hljs-keyword"><span class="hljs-keyword">column</span></span>+<span class="hljs-string"><span class="hljs-string">'_dto] as todatetimeoffset(['</span></span>+@<span class="hljs-keyword"><span class="hljs-keyword">column</span></span>+<span class="hljs-string"><span class="hljs-string">'], ''+00:00'')'</span></span> exec (@cmd) <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cols <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">table</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">column</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">close</span></span> cols <span class="hljs-keyword"><span class="hljs-keyword">deallocate</span></span> cols</code> </pre><br>  Based on the result above, you can chop your system into sections where you want to enter a DateTimeOffset.  Now you can use a new type in only one stored procedure without having to change all the places associated with it. <br><br><h3>  Reading Transformation </h3><br>  Read operations were the most difficult to convert because of the approach used to integrate between client code and the database.  Date / time values ‚Äã‚Äãare transmitted by string serialization.  DateTimeOffset has a different format and cannot be read by default for client-side DateTime variables.  At the same time, write operations just work.  If you pass a DateTime value to an argument or a DateTimeOffset field, this value will be accepted with the assumption that it is adjusted to UTC.  The time offset after the conversion will be "+00: 00". <br><br>  Now you can take some section of the system and determine the exact number of storages that return DateTime to the client code.  Here it will be necessary to change the read operations in the C # code to read the values ‚Äã‚Äãof DateTimeOffset.  You will also need to change the database itself so that they return values ‚Äã‚Äãfrom the new calculated fields.  The expected result of this step is as follows: <br><br><ul><li>  C # code reads the DateTimeOffset and uses this type wherever possible to return values ‚Äã‚Äãfrom the system. </li><li>  Database presets use DateTimeOffset in arguments, and C # code passes them the value of DateTimeOffset. </li><li>  New type is used inside the database. </li><li>  Database strings return values ‚Äã‚Äãfrom newly added fields. </li></ul><br>  As a result, you will receive a system that reads data from new fields, while storing values ‚Äã‚Äãin the old ones.  Now, as soon as the time offset is transmitted in the write operations and stored in the system, the entire system will begin to work correctly with time zones. <br><br><h3>  Transformation Record </h3><br>  Now you need to fix the time offset in the system, send it to the database and save it in the fields.  It is necessary to take the old field and change it to the one calculated from the new, and the new one should now contain values.  You already read them, now write down the values, and the old ones, on the contrary, only read.  This approach will help you isolate changes for a specific section only.  The expected result is as follows: <br><br><ul><li>  C # code creates DateTimeOffset values ‚Äã‚Äãand transfers them to the database. </li><li>  New fields are now real fields with values. </li><li>  Old fields are now calculated and used for reading. </li><li>  Database preserves save values ‚Äã‚Äãto new fields. </li></ul><br>  As a result, you get a system that writes and reads a new type of DateTimeOffset.  This type has built-in support for time offset, so you will not need to do any manual conversion to UTC or between time zones, in general. <br><br><h2>  Further Steps </h2><br>  The only recommendation I can give regarding the division of the system into sections for the conversion is the following: it is necessary to provide sufficient isolation of the modules in accordance with the used storage.  Thus, you will achieve predictability of efforts and be able to evaluate them in advance.  Sure, some problems may still arise, but they will not grow like a snowball as you work.  Later you can get rid of the old fields.  Information about the time zone can be taken from the operating system or user settings.  Below I posted information about the compatibility of the two types in the database. <br><br><ul><li>  Changing the column type from DateTime to DateTimeOffset works with implicit conversion.  The time offset will be +00: 00.  If you need to specify a different time zone, you must use a temporary column. </li><li>  Formatting values ‚Äã‚Äãinto a string is supported. </li><li>  Comparison by all operators supported. </li><li>  SYSDATETIMEOFFSET () can replace GETDATE () without risk </li><li>  Any assignment between DateTime and DateTimeOffset works with an implicit conversion. </li></ul><br><table><tbody><tr><th>  Operation </th><th>  T-sql </th><th>  Comment </th></tr><tr><td>  Convert DateTime to DateTimeOffset </td><td>  TODATETIMEOFFSET (datetime_field, '+00: 00') </td><td>  Get value with added offset +00: 00 </td></tr><tr><td>  Convert DateTimeOffset to DateTime </td><td>  CONVERT (DATETIME, datetimeoffset_field) <br>  - or - SET @datetime = @datetimeoffset </td><td>  The offset information will be lost.  When converting, the offset will simply be ignored.  For example, for '2017-04-05 10:02:00 +01: 00' get '2017-04-05 10:02:00'. </td></tr><tr><td>  Current date / time </td><td>  SWITCHOFFSET (SYSDATETIMEOFFSET (), '+00: 00') </td><td>  These are two teams.  The result will be a point in the UTC zone. </td></tr><tr><td>  Embedded operations </td><td>  DATEPART, DATEDIFF, BETWEEN, &lt;,&gt;, =, etc. </td><td>  DATEDIFF, BETWEEN and comparison operations take into account the time offset, while the DateTime value is represented as a value with a UTC offset </td></tr><tr><td>  Formatting </td><td>  CONVERT (NVARCHAR, datetimeoffset_field, 103) </td><td>  Get the same result as for datetime. </td></tr></tbody></table><br>  It is very interesting to hear stories about a similar transformation from those who have already done this in their systems.  And also who and how supports timezone in their systems. </div><p>Source: <a href="https://habr.com/ru/post/323608/">https://habr.com/ru/post/323608/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323598/index.html">Digitizing sound on STM32 (ADC + DMA) and encoding to Speex for transmission</a></li>
<li><a href="../323600/index.html">+500 free tools to launch your startup in 2017</a></li>
<li><a href="../323602/index.html">Sticky Attacks: when key sticking helps hackers</a></li>
<li><a href="../323604/index.html">Magento BarCamp - the new season of reports. March 2017</a></li>
<li><a href="../323606/index.html">Check Point. What is it, what is it eaten with or briefly about the main thing</a></li>
<li><a href="../323612/index.html">The story of how we translated the project into almost a quarter of a million lines in TypeScript and survived</a></li>
<li><a href="../323614/index.html">Pygest # 5. Releases, articles, interesting projects from the world of Python [February 28, 2017 - March 13, 2017]</a></li>
<li><a href="../323616/index.html">A preliminary DUMP program is ready. Speakers from Dropbox, JetBrains, Mozilla, Mail.Ru, Yandex, Rambler & Co</a></li>
<li><a href="../323618/index.html">PostgreSQL data change audit</a></li>
<li><a href="../323620/index.html">Where the games go: the problem of preserving old video games. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>