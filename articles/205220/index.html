<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ShareJS hook logic</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are 4 hooks in the ShareJS commit loop. You can see the implementation of two of them (submit and after submit) in the ShareJS code . And the ot...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ShareJS hook logic</h1><div class="post__text post__text-html js-mediator-article">  There are 4 hooks in the ShareJS commit loop.  You can see the implementation of two of them (submit and after submit) in <a href="">the ShareJS code</a> .  And the other two (preValidate and validate) in the <a href="">code LiveDB</a> . <br><br><a name="habracut"></a><br>  The sequence for calling hooks is: <br><br><ol><li>  ShareJS launches submit middleware, which has access to the operation, collection name, document name (_id for MongoDB) and connect-session.  This middleware is launched asynchronously during the initial processing of the operation, before attempting to use it.  Thus, in it you can asynchronously get the data needed for access control or manipulate the operation. </li><li>  LiveDB calls the preValidate method.  He gets everything available in the submit middleware, as well as the document before the operation.  This method is called synchronously in the process of committing an operation and can be called multiple times. </li><li>  LiveDB runs the validate method.  It works the same as the previous one, only called after the operation with the document has been performed. </li><li>  ShareJS runs after submit middleware, which receives the same data as submit, and also the document after the operation.  It runs asynchronously, immediately after saving the operation and publishing it to subscribers. </li></ol>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We spent a lot of time discussing the details of these hooks and we deliberately left them fairly low-level within ShareJS / LiveDB. <br><br>  LiveDB methods are intentionally synchronized.  These methods can be invoked many times during the validation process, because if two different clients change the same document at the same time, the client first wins and subsequent attempts are rejected until the operation is completed.  Adding asynchronous calls to get additional data here would be inefficient given that methods can be called multiple times.  In addition, it couldn‚Äôt be consistently trying to complete the process.  Synchronous calls significantly reduce the likelihood of this. <br><br>  Validation in LiveDB is divided into two methods to avoid permanent, often unnecessary cloning of a document.  If you want to have a single validation call with document variants before and after the operation, you can deeply clone the document in preValidate and then use it and the modified version in validate. <br><br>  The correct method of obtaining additional data for access control is to use Express middleware or ShareJS submit middleware, and add their session, which is transmitted to preValidate / validate. <br><br>  The current implementation is a bit confusing and ideally racer-access should have a more intuitive API and documentation.  I‚Äôm happy to make suggestions for improving racer-access, but I don‚Äôt think it makes sense to change something in LiveDB. </div><p>Source: <a href="https://habr.com/ru/post/205220/">https://habr.com/ru/post/205220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../205204/index.html">Backup on hardlinks under Windows</a></li>
<li><a href="../205210/index.html">Flightstats API: We write our board of arrivals with Boeing and Airbus</a></li>
<li><a href="../205212/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 86 (December 1 - 7, 2013)</a></li>
<li><a href="../205214/index.html">Kindle Fire HDX - affordable tablet from Amazon</a></li>
<li><a href="../205218/index.html">SharePoint Code Check (SPCop) is a free code analysis tool.</a></li>
<li><a href="../205222/index.html">Warm lamp text interface. Just about simple</a></li>
<li><a href="../205230/index.html">The best textbook on Meteor - "Discover Meteor" - one day for free</a></li>
<li><a href="../205232/index.html">Anonymous Santa Claus 2014. Post boasting Christmas gifts</a></li>
<li><a href="../205234/index.html">The largest torrent trackers hit the Kaspersky Lab's parental control database</a></li>
<li><a href="../205236/index.html">WCF RIA Services. Receiving data. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>