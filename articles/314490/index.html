<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recommendations based on product images</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would like to consider in practice the option of constructing the simplest recommender system based on the similarity of product ima...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recommendations based on product images</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/post/314490/"><img src="https://habrastorage.org/files/d98/009/ebd/d98009ebd35e4b119a6f5a846fa1d541.png" alt="image"></a> <br><br>  In this article I would like to consider in practice the option of constructing the simplest recommender system based on the similarity of product images.  This material is intended for those who would like to try to apply Deep Learning, namely convolutional neural networks, in a simple, interesting and practically applicable project, but does not know where to start. <br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  By writing this prototype pushed me the process of choosing T-shirts in the online store.  Scrolling through 1000 out of 11,000 products, I got a bit tired.  I really wanted to be able to look for products similar to those that I have already selected.  The built-in recommendation system could not help with anything.  It was decided to file my version and see how it works on real data. <br><br><h3>  Parsing images </h3><br>  For a start, a simple parser of images from <a href="http://www.vsemayki.ru/catalog/type/manshortfull/fullprint/">this</a> category was implemented.  The previews with a resolution of 250x250 were put in one folder with names like ItemID.jpg.  It turned out about 11,000 pictures. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Feature extraction </h3><br>  To determine the similarity of images, we need to get their vector representations.  To do this, take the convolutional neural network used to classify images (VGG-16), already trained on a large dataset (ImageNet), and cut off the last layer from it, giving the output probabilities of each of the 1000 ImageNet classes.  As a result, we get a 4096-dimensional vector for each of the images. <br><br><img src="https://habrastorage.org/files/d87/658/a1c/d87658a1c0644e9183771af4553157e2.png" alt="image"><br><br>  The most convenient prototype to implement in ipython notebook, I strongly advise those who have not tried. <br><br>  This code was taken as a basis: <a href="https://gist.github.com/baraldilorenzo/07d7802847aaad0a35d3">gist.github.com/baraldilorenzo/07d7802847aaad0a35d3</a> <br><br>  We load libraries: <br><br><pre><code class="python hljs">%matplotlib inline <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Sequential <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.layers.core <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flatten, Dense, Dropout <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.layers.convolutional <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Convolution2D, MaxPooling2D, ZeroPadding2D <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> keras.optimizers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SGD <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2, numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> h5py <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> matplotlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> theano theano.config.openmp = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span></code> </pre> <br>  Load pre-trained on ImageNet VGG-16 and delete the last layer from it: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VGG_16</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(weights_path=None)</span></span></span><span class="hljs-function">:</span></span> model = Sequential() model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>),input_shape=(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>,<span class="hljs-number"><span class="hljs-number">224</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), strides=(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), strides=(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), strides=(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), strides=(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(ZeroPadding2D((<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>))) model.add(Convolution2D(<span class="hljs-number"><span class="hljs-number">512</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(MaxPooling2D((<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), strides=(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>))) model.add(Flatten()) model.add(Dense(<span class="hljs-number"><span class="hljs-number">4096</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) model.add(Dropout(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)) model.add(Dense(<span class="hljs-number"><span class="hljs-number">4096</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)) <span class="hljs-comment"><span class="hljs-comment"># model.add(Dropout(0.5)) # model.add(Dense(1000, activation='softmax')) assert os.path.exists(weights_path), 'Model weights not found (see "weights_path" variable in script).' f = h5py.File(weights_path) for k in range(f.attrs['nb_layers']): if k &gt;= len(model.layers): # we don't look at the last (fully-connected) layers in the savefile break g = f['layer_{}'.format(k)] weights = [g['param_{}'.format(p)] for p in range(g.attrs['nb_params'])] model.layers[k].set_weights(weights) f.close() print('Model loaded.') return model model = VGG_16('../../keras/vgg16_weights.h5') sgd = SGD(lr=0.1, decay=1e-6, momentum=0.9, nesterov=True) model.compile(optimizer=sgd, loss='categorical_crossentropy')</span></span></code> </pre><br>  We load and convert images into a format suitable for our neural network: <br><br><pre> <code class="python hljs">path = <span class="hljs-string"><span class="hljs-string">"../../keras/tshirts/out/"</span></span> ims = [] files = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> os.listdir(path): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f.endswith(<span class="hljs-string"><span class="hljs-string">".jpg"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (os.stat(path+f) &gt; <span class="hljs-number"><span class="hljs-number">10000</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: files.append(f) im = cv2.resize(cv2.imread(path+f), (<span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>)).astype(np.float32) <span class="hljs-comment"><span class="hljs-comment"># plt.imshow(im) # plt.show() im[:,:,0] -= 103.939 im[:,:,1] -= 116.779 im[:,:,2] -= 123.68 im = im.transpose((2,0,1)) im = np.expand_dims(im, axis=0) ims.append(im) except: print f images = np.vstack(ims)</span></span></code> </pre><br>  Create dictionaries for converting external IDs to ours and vice versa: <br><br><pre> <code class="python hljs">r1 =[] r2= [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i,x <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(files): r1.append((int(x[:<span class="hljs-number"><span class="hljs-number">-4</span></span>]),i)) r2.append((i,int(x[:<span class="hljs-number"><span class="hljs-number">-4</span></span>]))) extid_to_intid_dict = dict(r1) intid_to_extid_dict = dict(r2)</code> </pre><br>  Extract vector views from images: <br><br><pre> <code class="python hljs">out = model.predict(images) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> out <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> out.shape</code> </pre><br>  It turns out on a 4096-dimensional vector for each of 11,556 pictures: <br><br><pre> <code class="dos hljs">[[ <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00000000</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">96046448</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>.<span class="hljs-number"><span class="hljs-number">35693979</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> ..., <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">01165676</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> -<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">30967999</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">48017263</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span>] [ -<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">98023224</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">78813934</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">60834265</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> ..., <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">01165676</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">45058060</span></span>e-<span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>.<span class="hljs-number"><span class="hljs-number">42541122</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span>] [ <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">94069672</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00000000</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">79157162</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> ..., <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">01165676</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> -<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">30967999</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">50830841</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span>] ..., [ <span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">17337513</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> -<span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">96046448</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">89156103</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> ..., <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">01165676</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">45058060</span></span>e-<span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">49011612</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span>] [ <span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">18071890</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">78813934</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> -<span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">96046448</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> ..., <span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">01165676</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> -<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">30967999</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>.<span class="hljs-number"><span class="hljs-number">49011612</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span>] [ <span class="hljs-number"><span class="hljs-number">8</span></span>.<span class="hljs-number"><span class="hljs-number">19161701</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>.<span class="hljs-number"><span class="hljs-number">96046448</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>.<span class="hljs-number"><span class="hljs-number">62305927</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span> ..., -<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">72529030</span></span>e-<span class="hljs-number"><span class="hljs-number">08</span></span> -<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">30967999</span></span>e-<span class="hljs-number"><span class="hljs-number">07</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">47453260</span></span>e+<span class="hljs-number"><span class="hljs-number">00</span></span>]] (<span class="hljs-number"><span class="hljs-number">11556</span></span>, <span class="hljs-number"><span class="hljs-number">4096</span></span>)</code> </pre><br><h3>  Search for similar images </h3><br>  Find how closest in cosine images are: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sklearn.metrics.pairwise <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pairwise_distances extid = <span class="hljs-number"><span class="hljs-number">875317</span></span> i = extid_to_intid_dict[extid] <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> i plt.imshow(cv2.imread(path+files[i])) plt.show() dist = pairwise_distances(out[i],out, metric=<span class="hljs-string"><span class="hljs-string">'cosine'</span></span>, n_jobs=<span class="hljs-number"><span class="hljs-number">1</span></span>) top = np.argsort(dist[<span class="hljs-number"><span class="hljs-number">0</span></span>])[<span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-number"><span class="hljs-number">7</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> top: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> t,dist[<span class="hljs-number"><span class="hljs-number">0</span></span>][t] plt.imshow(cv2.imread(path+files[t])) plt.show()</code> </pre><br> <a href="http://imgrec.ddns.net/%3Fitemid%3D875317"><img src="https://habrastorage.org/files/cad/5ca/26f/cad5ca26f6064ce79a076930845477e9.png" alt="image"></a> <br><br><h3>  Web interface for tests </h3><br>  Testing all this in ipython is not very convenient, so it was decided to make a web interface on Django. <br><br>  Save the necessary data for use in the web interface: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> joblib joblib.dump((extid_to_intid_dict,intid_to_extid_dict,out),<span class="hljs-string"><span class="hljs-string">"../../keras/tshirts/models/wo_1_layer.pkl"</span></span>)</code> </pre><br>  Next, when we start, we raise the data into memory and, with each request, we find 5 nearest neighbors <br><br>  <a href="http://imgrec.ddns.net/">Here is the result</a> .  When prompted without a parameter, selects a random image.  Provides 5 nearest images for different distance metrics - ‚Äúcosine‚Äù, ‚Äúeuclidean‚Äù, ‚Äúmanhattan‚Äù <br><br>  In my opinion, it turned out not bad enough. <br><br>  Interestingly, the neural network, trained to classify images on ImageNet, can ‚Äúunderstand‚Äù what is depicted on a T-shirt and select images that are similar in meaning. <br><br>  For example: <br><br><blockquote>  <a href="http://imgrec.ddns.net/%3Fitemid%3D966730">Cats</a> <br>  <a href="http://imgrec.ddns.net/%3Fitemid%3D650443">The Bears</a> <br>  <a href="http://imgrec.ddns.net/%3Fitemid%3D847003">People</a> <br>  <a href="http://imgrec.ddns.net/%3Fitemid%3D1020961">Fruits</a> <br>  <a href="http://imgrec.ddns.net/%3Fitemid%3D932401">Similar style</a> <br>  <a href="http://imgrec.ddns.net/%3Fitemid%3D862294">Similar texture</a> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/314490/">https://habr.com/ru/post/314490/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../314474/index.html">How I tried to enable http2 in my project with nginx</a></li>
<li><a href="../314476/index.html">Microsoft will provide antiviruses with the ability to monitor the activity of the Linux subsystem on Windows 10</a></li>
<li><a href="../314478/index.html">Transfer domain? Get ready for trouble</a></li>
<li><a href="../314484/index.html">Basics of computer networks. Subject number 5. The concept of IP addressing, subnet masks and their calculation</a></li>
<li><a href="../314486/index.html">How enum is available for everyone to do, but write to the meta-type</a></li>
<li><a href="../314492/index.html">Problems with the image: image tag in site maps. Bypass misunderstanding Yandex validator</a></li>
<li><a href="../314494/index.html">Implementation of the performance indicator of queries, stored procedures and triggers in MS SQL Server. Autotrace</a></li>
<li><a href="../314496/index.html">How important is mathematical training in promising areas of software development</a></li>
<li><a href="../314500/index.html">Comparing objects by value - 2, or Features of the implementation of the Equals method</a></li>
<li><a href="../314502/index.html">A brief history of the development of game engines</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>