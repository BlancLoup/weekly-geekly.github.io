<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Xenoblade Chronicles - parsing game data</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Artem, in tyrnets, better known by the idiotic nickname TTEMMA , but not the essence. I am one of the founders of the amateur group ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Xenoblade Chronicles - parsing game data</h1><div class="post__text post__text-html js-mediator-article"><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/278736ddbe6803146d1e0fc9d0deae4c.png" alt="image"><br><br>  Hello!  My name is Artem, in tyrnets, better known by the idiotic nickname <i><b>TTEMMA</b></i> , but not the essence.  I am one of the founders of the amateur group of translators of <b><i><a href="https://vk.com/russian_studio_video_7">Russian Studio Video 7</a></i></b> and the only romhaker programmer in this team. <br><br>  The team and I were the first to give <b>Resident Evil</b> fans translations of two iconic games on the <b>Nintendo GameCube</b> - <b>Resident Evil Remake</b> and <b>Resident Evil Zero</b> , sometime I‚Äôll tell you how we all did it, but in this topic I would like to tell you about such a luxurious game like the <b>Xenoblade Chronicles</b> on the <b>Nintendo Wii</b> and how the romhak of this game went on and on.  In this game, everything is done in the Japanese style, it is strange and in some moments you just ask yourself the question ‚ÄúWhy?‚Äù, But then you remember how strange the Japanese are and these questions disappear.  Well, let's start? <br><a name="habracut"></a><br><h2>  Foreword </h2><br>  <b>Xenoblade Chronicles</b> is the kind of game that is worth it, no, you even need to purchase a <b>Nintendo Wii</b> .  JRPG, a large open world, a bunch of auxiliary quests and a fascinating storyline that will delay the passing of the game not for weeks, but for months.  Anyone who is familiar with <b>Nintendo Wii</b> knows that the console is designed for weak colorful family games like <b>Super Mario</b> , etc., but what <b><i>Monolith Soft</i></b> created was worthy of praise, their <b>Xenoblade Chronicles</b> has beautiful and beautiful graphics, despite the huge technical limitations of the console (only the <b>Resident Evil Remake</b> and <b>Resident Evil Zero</b> can compete in terms of graphics). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://s8.hostingkartinok.com/uploads/images/2017/06/ddf4e65b6682d253a906a575d3415520.jpeg" alt="image"><br><br>  Having looked with the team on this game, we decided that it needs to be translated into our great and mighty one.  But as you know, without understanding the technical component of the game, it is clearly not worthwhile to take on the translation.  And now we will talk about the technical component. <br><br><h2>  Technical nuances </h2><br>  I will talk a little about the <b>Wii</b> itself and about what it‚Äôs about in this topic will not go. <br><br>  With the <b>Nintendo GameCube</b> , that the <b>Nintendo Wii</b> runs on an <b><i>IBM</i></b> processor with a <b>PowerPC</b> architecture.  This processor works in Big-Endian mode, it is important to remember this (as for me, hacking Big-Endian files is much more convenient than Little-Endian due to byte order). <br><br>  Fortunately, <b><i>Nintendo</i></b> took great care of the game developers and in their SDKs they provided just a huge number of formats for any purpose, it is not about them that the topic will not go.  Maybe later I will talk about them in detail, but my laziness is unlikely to allow.  I want to single out only one of the <b><i>Nintendo</i></b> formats - BRFNA (Binary Revolution Font), which will be discussed further. <br><br><h2>  Font </h2><br>  The font in <b>Xenoblade Chronicles</b> (hereinafter referred to as XC) is stored in a standard but rarely used format in games with the extension BRFNA. <br><br>  There are only two standard <b>Wii</b> font formats: <br><br><ol><li>  BRFNT (more popular) </li><li>  BRFNA (rarely used) </li></ol><br>  I will not delve into their structure, but only talk about the differences: <br><br><ul><li>  A new block has been added to BRFNA that stores encoding information (ansi, kanji, european, etc.) </li><li>  In BRFNA, textures with characters are compressed in formats unknown to me, while in BRFNT they lie in clear text and are quietly edited. </li></ul><br>  BRFNA managed to deliver a lot of problems, firstly - an unknown type of compression, secondly - a slightly odd separation by encoding.  Saved us out of this situation, oddly enough, the official font converter from 3DS SDK from <b><i>Nintendo</i></b> .  But there were problems with it, I had to study the encodings used in the <b>XC</b> itself, write separate configuration files for the texture converter and play around with the settings of the converter itself so that the font was identical to the original.  And for good, after several days of torment, I was able to derive Russian letters using Russian character codes from UTF8. <br><br><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/d054ffec1a833d59e8af01695e88e1ff.jpg" alt="image"><br><br>  True, the game rested for a long time because of the size of the new font and crashed at the very beginning of the game loading.  At first there were suspicions that my crooked hands were doing something wrong, but after I removed the umlauts from the font, the game quietly started.  But I categorically did not want to remove umlauts, so I approached from the other side, I just changed the format of textures with IA4 (4 bits per color, 4 bits per transparency) to just I4 (4 bits per color, without transparency) and voila, XC flew off as pretty little <br><br>  Why did I decide to change the texture format?  Because I can!  Well, to be honest, this did not degrade the quality of the characters.  The output of characters in this game works in such a way that it displays only the alpha channel, without using the main channel in any way, but if you use the font format without transparency, then there is nothing to use it except as the main channel.  Ugliness, I thought, and decided to do without transparency, so as not to litter the place. <br><br>  At this point, the work with the font was completed and deleted from the task list. <br><br><h2>  PKB \ PKH - file containers </h2><br>  Something I did not begin my story with.  To get to many of the main files, you have to somehow extract them from the PKB container. <br><br>  PKB is just a container, without any pointers, sizes and file names.  All that can be noticed is a bunch of files equalized by 2048 bytes. <br><br><div class="spoiler">  <b class="spoiler_title">PKB Example</b> <div class="spoiler_text"><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/b3f9d6bd5f3a82b079bd51aa323b3711.png" alt="image"><br></div></div><br>  The most interesting is stored in the PKH files, but to get to them will have to try.  All PKH files are in a separate archive for each U8 language named static.arc. <br><br><div class="spoiler">  <b class="spoiler_title">STATIC.ARC English</b> <div class="spoiler_text"><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/adad298c272b597a58b2238ff8895e24.png" alt="image"><br></div></div><br>  PKH is a very strange markup for PKB, which stores the size, pointer and index of the file.  From the index, the game itself somehow gets the full file name, but I didn‚Äôt deal with it, because  it is too dreary and senseless. <br><br>  I could not make out the structure of this container to the end, but it was enough to extract and pack the files. <br><br>  PKH can be divided into 2 blocks: Header and Entry, which I did. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">pkhModuleEntry</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> ID; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> unk; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> sizeFile; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> offsetFile; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pkhModuleEntry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ID = unk = offsetFile = sizeFile = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">pkhModule</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Magic; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> version; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> tableOffset; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> pkhSize; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> countFiles; pkhModuleEntry[] entry; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] extensions; ... }</code> </pre> <br>  Entry starts with the tableOffset pointer.  The only problem is that the entry is divided into several blocks, the download of all the information about the files is as follows: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; countFiles; i++) { entry[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> pkhModuleEntry(); entry[i].ID = mainPkhSfa.ReadUInt32(); entry[i].unk = mainPkhSfa.ReadUInt32(); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; countFiles; i++) entry[i].sizeFile = mainPkhSfa.ReadUInt16(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; countFiles; i++) entry[i].offsetFile = mainPkhSfa.ReadUInt32();</code> </pre> <br>  By the code above, you can understand that all information about files is divided into 3 blocks: <br><br><ol><li>  File indices and unknown values </li><li>  File sizes </li><li>  File pointers </li></ol><br>  You can see that the pointer to a specific file is stored in uint32, that is, in a 4-byte variable, but the size, for some reason, in a 2-byte one.  I will explain this flaw, as I said above, in the PKB files are aligned to 2048 bytes, and this was done for a reason.  File size is not specified in bytes, but in the number of data blocks.  For example, the file size is specified 0xC, therefore the size in PKB will be 0xC * 0x800 = 0x6000. <br><br><div class="spoiler">  <b class="spoiler_title">PKH Example</b> <div class="spoiler_text"><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/2b18fbf421d9c9cd74dc2173e21b3814.png" alt="image"><br></div></div><br>  Having studied this structure, the unpacker / packer was quickly riveted and I began to study the containers that contain the text. <br><br><h2>  Containers with text </h2><br>  As always, the Japanese have done oddities in their game.  After a long study of gaming containers, 3 fronts were allocated with gaming text: <br><br><ol><li>  Container BDAT - stores in itself some data and lines, priority system (menu, trading, settings). </li><li>  Container SB - keeps in itself scripts and strings with conversations with residents. </li><li>  Container REV - stores data and strings used in cut scenes. </li></ol><br>  The Japanese approached the defense of their lines perfectly, but we didn‚Äôt like this fact at all. <br>  Only strings are encrypted in each container, it would not be a problem if only one encryption algorithm was used.  But alas, the Japanese decided to develop their own encryption algorithm for each container, which created many problems for us. <br><br>  In this topic, I will only talk about the BDAT container and its encryption algorithm, about the encryption in the SB container, so far I will keep silent, but I can‚Äôt say anything about encryption in the REV container, since  he is in the process of hacking so far. <br><br><h2>  BDAT Container </h2><br><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/77a655bfc3ed9dd66fc33b0e924bddfe.png" alt="image"><br><br>  The very first container that hacked me is BDAT.  After a quick inspection, it was difficult to understand that he is keeping the text in himself.  But we are not done with a finger, so we immediately googled about this format.  Some information about the structure of this container was found on the foreign forum and proofs were provided that the text was stored there.  Even the software was found, which extracts it, but for some reason he did not eat my files.  Poryskav even on foreign forums, I realized that their version of the game contains the text in clear text, but I do not see it in my files.  In my head immediately flowed information flows and various assumptions, and only one was true - the Japanese are encrypted, encrypted.  Only one thing remains, to figure out how. <br><br>  After several manipulations, I had a memory dump with decoded BDAT and original on my hands, and the process of analyzing these files began.  Having spent a lot of time comparing files, I could not figure out the encryption.  I did not see any patterns, and there was only one way out - debazhit! <br><br>  Unfortunately, Dolphin has a shitty debugger (or I just snickered and got used to the PCSX debugger, where there are all the possible functions for debugging).  I had to find out in what area of ‚Äã‚Äãmemory BDAT is decrypted and put brik on the record, but Dolphin can only put bryak on the command at the address, but on the read / write from the def.  The RAM section is not able, it became a problem.  Dolphin searches began with additional features for debugging and such was found - Dolphin DebugFast based on version 4, only one feature was added to it - a brik to read / write to RAM, what you need, I thought, and proceeded with the further hack. <br><br>  Finding in the memory of the site with the data I needed, I set the brick and began to study how the game decrypts its BDAT.  Everything turned out to be simple and interesting at the same time.  In BDAT, there is a 2-byte key, the first byte is loaded into the R5 register, the second in R0, respectively, there is also a boolean variable, which is set to 1 (true) at the beginning. <br><br>  If the Boolean variable is set to 1, then the decryption takes place using the R5 register, and if it is 0, then the decryption takes place using the R0 register. <br><br>  Encryption is based on simple XOR, the decryption procedure is as follows: <br><br><ol><li>  Encrypted byte = Encrypted byte ^ R (5 or 0) </li><li>  R (5 or 0) = (Encrypted Byte + R (5 or 0)) &amp; 0xFF </li><li>  Changing a Boolean variable to the opposite value </li></ol><br>  C # code: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BDAT_DecryptPart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, MemoryStream data</span></span></span><span class="hljs-function">)</span></span> { data.Position = offset; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> endOffset = offset + size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (endOffset &gt; data.Length) endOffset = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)data.Length; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> reg = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> _r0 = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(<span class="hljs-number"><span class="hljs-number">0xFF</span></span> - (key &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> _r5 = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(<span class="hljs-number"><span class="hljs-number">0xFF</span></span> - (key &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> inByte = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (offset &lt; endOffset) { inByte = data.GetBuffer()[offset]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reg) { data.GetBuffer()[offset] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(inByte ^ _r5); _r5 = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((_r5 + inByte) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); reg = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { data.GetBuffer()[offset] = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)(inByte ^ _r0); _r0 = (<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)((_r0 + inByte) &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); reg = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } offset += <span class="hljs-number"><span class="hljs-number">1</span></span>; } }</code> </pre> <br>  Encryption is designed very interesting, each next byte depends on the past, and even with alternation, brilliant!  Moreover, the resources for decryption are almost exhausted, and it is not possible to understand the essence of the algorithm without debugging. <br><br>  Having finished with encryption, I began to deal with the structure of BDAT itself.  After decrypting the string data, at the beginning of the file some names were noticed, more like the name of some blocks. <br><br><div class="spoiler">  <b class="spoiler_title">Try on</b> <div class="spoiler_text">  Encrypted block with 0x2C - 0x66. <br><br><img src="https://s8.hostingkartinok.com/uploads/images/2017/06/f3d6eca9e923995d5e8e1a037696ab5e.png" alt="image"><br></div></div><br>  But I postponed the analysis of this block, and decided to deal with the general structure.  By a difficult analysis, it was revealed that Header occupies only 0x20 bytes in us, I described its structure below. <br><br>  I will not go deep, as I have determined all this, but I‚Äôll just tell you what each of these bytes means. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">header</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> magic; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> mode; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> unk; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> offsetToNameBlock; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> sizeTableStruct; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> unkTableOffset; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> unk2; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> offsetToMainData; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> countEntryMain; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> unk3; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> unk4; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> cryptKey; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> offsetToStringBlock; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> sizeStringBlock; ... }</code> </pre><br><ul><li>  Magic is a constant and is always equal to BDAT (ansi) </li><li>  Mode - 1: no encryption, 3: encryption available </li><li>  unk - as you know, unknown, but this byte is always zero </li><li>  offsetToNameBlock - pointer to an encrypted block with block names </li><li>  sizeTableStruct - single block size with all data </li><li>  unkTableOffset - a pointer to a table that I could not make out until the end </li><li>  unk2 - unknown, but always equal to 0x3D </li><li>  offsetToMainData - pointer to the block containing all data </li><li>  countEntryMain - the number of blocks by pointer offsetToMainData (the block size of the MainData can be calculated as follows: sizeTableStruct * countEntryMain) </li><li>  unk3 - unknown, always 0x01 </li><li>  unk4 - unknown, always 0x02 </li><li>  cryptKey - 2-byte key for decryption </li><li>  offsetToStringBlock - pointer to block with text </li><li>  sizeStringBlock - block size with text (equal to 0 if there is no text) </li></ul><br>  After the Header, before the offsetToNameBlock, unknown data goes, as it turned out, this is information about the blocks in MainData and has this structure: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">typeStruct</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> unk; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> type; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> idx; ... }</code> </pre><br><ul><li>  unk - unknown </li><li>  type - data type </li><li>  idx - pointer to MainData (exact pointer is calculated as follows: offsetToMainData + (IndexStructure * sizeTableStruct) + idx </li></ul><br>  And the last block remained - offsetToNameBlock, it has the following structure: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">nameBlock</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> bdatName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> nameBlockEntry[] nameEntry; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameBlock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StreamFunctionAdd sfa, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> countName</span></span></span><span class="hljs-function">)</span></span> { bdatName = sfa.ReadAnsiStringStopByte(); sfa.SeekValue(<span class="hljs-number"><span class="hljs-number">2</span></span>); nameEntry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> nameBlockEntry[countName]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; countName; i++) { nameEntry[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> nameBlockEntry(sfa); } } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">nameBlockEntry</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> offsetToStructType; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> unk; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> typeStruct type; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nameBlockEntry</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StreamFunctionAdd sfa</span></span></span><span class="hljs-function">)</span></span> { offsetToStructType = sfa.ReadUInt16(); unk = sfa.ReadUInt16(); name = sfa.ReadAnsiStringStopByte(); type = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> typeStruct(sfa, offsetToStructType); sfa.SeekValue(<span class="hljs-number"><span class="hljs-number">2</span></span>); } }</code> </pre> <br>  I want to select only the countName variable, which is not found anywhere else in the Header, but it is calculated by taking the pointer to NameBlock 0x20 and dividing this number by 4. Let me explain why: Header ends at 0x20, NameBlock starts far after Header, and as we know, right after Header there is information about the structure of blocks in MainData, which occupies 4 bytes per structure.  And in order to find out the number of such structures, it is necessary to find out the size of only information about the structures and divide by their size, that is, 4. <br><br>  It seems, at first glance, a complex structure, but I will try to explain it in another way: <br><br>  There is a block where all data is stored - MainData.  This block is divided into several blocks, the number of which is described by the variable countEntryMain, and the size of one such block is described by the variable sizeTableStruct.  But what data is stored in one such block is already described using the typeStruct class, the number of which can be from 1 to several.  For each typeStruct there is a name that is stored in nameBlockEntry. <br><br>  That's all, BDAT has been disassembled software has been riveted to extract / replace text, which successfully plows. <br><br><div class="spoiler">  <b class="spoiler_title">Sample extracted lines from BDAT</b> <div class="spoiler_text"><img src="https://pp.userapi.com/c636522/v636522900/7ea85/AiOOrHgq09g.jpg" alt="image"><br></div></div><br><h2>  Conclusion </h2><br>  In this topic, I tried to voice how I tried to hack one of the legendary games on the <b>Wii</b> and bring to you, as the Japanese continue to do everything so that no one scans in their files. <br><br>  It will be possible to continue the parsing of formats in this game, but this is not accurate.  If you liked my article, I will tell you how we translated <b>Resident Evil Remake</b> and <b>Resident Evil Zero</b> . <br><br>  Thank you for your time! <br><br>  <b>PS</b> This is my first article in a similar subject, please do not throw slippers, but it is better to immediately point out errors.  Maybe I did not disclose something that was necessary or didn‚Äôt explain, I ask you to point this out so that there will be no more such errors. <br></div><p>Source: <a href="https://habr.com/ru/post/330612/">https://habr.com/ru/post/330612/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330598/index.html">Time of the brave. How to migrate to the clouds without violating the requirements of regulators?</a></li>
<li><a href="../330600/index.html">The third IT conference GeekDay - three days of free programming workshops</a></li>
<li><a href="../330602/index.html">Talk to me completely. Or how to get rid of cold hands at the interview</a></li>
<li><a href="../330604/index.html">Zabbix: LLD monitoring of IPMI sensors</a></li>
<li><a href="../330606/index.html">Recruitment for a Python course: why we think that Python 2.7. - this is serious, and Python 3 is fashionable</a></li>
<li><a href="../330614/index.html">Heisenbag 2.0: how was the testing conference in St. Petersburg</a></li>
<li><a href="../330616/index.html">We invite you to the official workshop on UE4 from Epic Games</a></li>
<li><a href="../330618/index.html">SQL Server Integration Services (SSIS) for Beginners - Part 1</a></li>
<li><a href="../330624/index.html">Russian language specification Java</a></li>
<li><a href="../330626/index.html">Security Week 23: EternalBlue ported to Win10, CIA attacks from file servers, marketers quietly infected the whole world</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>