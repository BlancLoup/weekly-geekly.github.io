<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two-digit thermometer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author made this two-digit LED thermometer as a birthday present to his friend's son. He is only two years old, and he already reads the numbers, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two-digit thermometer</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/i0/jr/au/i0jrauutpm6rrsutydyvv7hxb_c.jpeg"><br><br>  The author made this two-digit LED thermometer as a birthday present to his friend's son.  He is only two years old, and he already reads the numbers, but he doesn‚Äôt.  Now he can find out the temperature outside the window on his own.  The sensor in the thermometer is a DS18B20 microcircuit operating according to the 1-Wire protocol, and the microcontroller is of the ATtiny84 type.  The board is a square with a side of 25 mm, in size it is comparable to a 50 pence coin.  The author plans to place the board in a waterproof case and place it outside the window.  The display turns on briefly every 24 seconds, and the CR2032 battery lasts about a year. <a name="habracut"></a><br>  The thermometer operates in the range of -19 to +99 ¬∞ C.  If necessary, the minus and one are simultaneously displayed in the high-order digit.  When out of range, the letters Lo or Hi are displayed.  You can ‚Äúteach‚Äù the device to display temperatures below -19 ¬∞ C, using the dotted segment as a minus. <br><br>  According to this scheme, the device was pre-assembled on a breadboard: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/1u/e7/aj/1ue7aju6otdv_qjhwdjabjxejf8.gif"><br><br>  All microcontroller pins are involved, the built-in clock generator at 8 MHz is used.  The prototype turned out like this: <br><br><img src="https://habrastorage.org/webt/qf/91/nd/qf91ndinrn_16xfcxellk_lxzuq.jpeg"><br><br>  The prototype used the DS18B20 in the TO-92 package, the ATtiny84 in the PDIP package and a 3.6-inch 3621AS indicator.  Then the author developed a board in Eagle and ordered it in PCBway.  Here, the microcontroller is already in the SOIC package, the sensor is in the ¬µSOP package, and the resistors, capacitors and display are of size 0805. Everything except the display is soldered with Youyue 858D + hair dryer at a temperature of 250 ¬∞ C. <br><br>  Both on the prototype and on the printed circuit board, indicators with a common anode are used.  The device is made in two versions, with indicators of red and yellow.  Red - on KDPV, yellow - here: <br><br><img src="https://habrastorage.org/webt/qc/i9/wv/qci9wvs7mdqulra36wldskfg6sc.jpeg"><br><br>  A holder for a 20 mm lithium cell is soldered on the back side (any with a designation starting at 20, i.e., 2016, 2025 or 2032): <br><br><img src="https://habrastorage.org/webt/3i/ic/kx/3iickx0nahv0rh325lvawiebzdq.jpeg"><br><br>  The firmware is written in such a way that the microcontroller is in sleep mode most of the time and wakes up due to an interrupt from the watchdog timer.  This implementation of the same author is involved in the implementation of the 1-Wire interface.  The 16-bit microcontroller timer counter, operating at a frequency of 1 MHz, is timed: <br><br><pre><code class="plaintext hljs">void OneWireSetup () { TCCR1A = 0&lt;&lt;WGM10; // Normal mode TCCR1B = 0&lt;&lt;WGM12 | 2&lt;&lt;CS10; // Normal mode, divide clock by 8 }</code> </pre> <br>  The DelayMicros () subroutine provides a delay of a specified number of microseconds, based on the OCR0A output comparison register: <br><br><pre> <code class="plaintext hljs">void DelayMicros (unsigned int micro) { TCNT1 = 0; TIFR1 = 1&lt;&lt;OCF1A; OCR1A = micro; while ((TIFR1 &amp; 1&lt;&lt;OCF1A) == 0); }</code> </pre> <br>  The routine DisplayTemperature () reads the temperature value from the sensor and displays it.  Since there is only one sensor on the bus, you can ignore the serial number and simply issue the Skip ROM command, after which all subsequent commands go to any device: <br><br><pre> <code class="plaintext hljs">void DisplayTemperature () { cli(); // No interrupts if (OneWireReset() != 0) { sei(); DisplayError(0); // Device not found } else { OneWireWrite(SkipROM); OneWireWrite(ConvertT); while (OneWireRead() != 0xFF); OneWireReset(); OneWireWrite(SkipROM); OneWireWrite(ReadScratchpad); OneWireReadBytes(9); sei(); // Interrupts if (OneWireCRC(9) == 0) { int temp = DataWords[0]; Display((temp+8)&gt;&gt;4); // Round to nearest degree } else DisplayError(1); // CRC error } }</code> </pre> <br>  In response to a request, the sensor returns the temperature as a 16-bit signed integer in 1/16 degree units.  The number is rounded to the nearest integer degree and displayed by calling the Display () subroutine. <br><br>  The DisplayError () subroutine displays the errors of the microcontroller's interaction with the sensor via the 1-Wire bus: <br><br><pre> <code class="plaintext hljs">void DisplayError (int no) { Buffer[0] = Error; Buffer[1] = no; }</code> </pre> <br>  E0 - no sensor detected, E1 - CRC error. <br><br>  Data for dynamic indication is taken from the array Buffer [].  For example, to display the number 20, you need to run: <br><br><pre> <code class="plaintext hljs">Buffer[0]=2; Buffer[1]=0;</code> </pre> <br>  Timer counter 0 generates interrupts at a frequency of 125 Hz, which is enough to eliminate flicker.  Initially, the timer is configured in setup () " <br><br><pre> <code class="plaintext hljs">TCCR0A = 2&lt;&lt;WGM00; // CTC mode; count up to OCR0A TCCR0B = 0&lt;&lt;WGM02 | 4&lt;&lt;CS00; // Divide by 256 OCR0A = 250-1; // Compare match at 125Hz TIMSK0 = 0; // Interrupts initially off</code> </pre> <br>  The matching interrupt handling procedure calls the DisplayNextDigit () subroutine and then counts down: <br><br><pre> <code class="plaintext hljs">ISR(TIM0_COMPA_vect) { DisplayNextDigit(); Ticks--; }</code> </pre> <br>  The DisplayNextDigit () subroutine reads data from the corresponding cell of the Buffer [] array and includes the necessary segments in the corresponding display bit.  The program uses #define to select between an indicator with a common cathode or anode.  If during the power supply all segments are lit at once, then the display type does not match the one specified in the firmware.  For the common cathode, the subroutine should be replaced with the following: <br><br><pre> <code class="plaintext hljs">void DisplayNextDigit () { PORTB = PORTB | 1&lt;&lt;digit; // Turn old digit off digit = digit ^ 1; // Toggle between 0 and 1 char segs = charArray[Buffer[digit]]; PORTA = segs; // Lit segments high PORTB = PORTB &amp; ~(1&lt;&lt;digit); // Turn new digit on }</code> </pre> <br>  Finally, the Display () subroutine generates a two-digit number to write to the Buffer [] array: <br><br><pre> <code class="plaintext hljs">void Display (int n) { int units = n % 10; int tens = n / 10; int temp0 = tens; int temp1 = abs(units); if (tens &lt; -1) {temp0 = Lo; temp1 = Lo+1; } else if (tens &gt; 9) {temp0 = Hi; temp1 = Hi+1; } else if (tens == -1) temp0 = Minus1; else if ((tens == 0) &amp;&amp; (units &gt;= 0)) temp0 = Blank; else if ((tens == 0) &amp;&amp; (units &lt; 0)) temp0 = Minus; Buffer[0] = temp0; Buffer[1] = temp1; }</code> </pre> <br>  It also takes into account the cases of displaying a minus along with the unit in the high-order bit, as well as reports of temperature out of range. <br><br>  For the highest possible energy saving, the ADC, USI clock and ADC clock generators are disabled, and the PWR_DOWN sleep mode is enabled: <br><br><pre> <code class="plaintext hljs"> ADCSRA &amp;= ~(1&lt;&lt;ADEN); // Disable ADC to save power PRR = 1&lt;&lt;PRUSI | 1&lt;&lt;PRADC; // Turn off clocks to USI &amp; ADC to save power set_sleep_mode(SLEEP_MODE_PWR_DOWN);</code> </pre> <br>  The main program displays the temperature for tenths of a second, then turns on sleep mode.  It turned out that this is the minimum duration of the display, convenient for reading.  Two seconds before the temperature is displayed, a dot flashes briefly: <br><br><pre> <code class="plaintext hljs">void loop () { Buffer[0] = DP; Buffer[1] = Blank; DisplayOn(12); WDDelay(6); // Sleep for 1 second Buffer[0] = Blank; Buffer[1] = DP; DisplayOn(12); WDDelay(6); // Sleep for 1 second DisplayTemperature(); DisplayOn(12); WDDelay(9); // Sleep for 8 seconds WDDelay(9); // Sleep for 16 seconds WDDelay(9); // Sleep for 24 seconds }</code> </pre> <br>  The display remains off for 24 seconds due to three watchdog calls of 8 seconds each.  When the indicator is running, the current consumption is 6.6 mA, while in sleep mode it is 4.7 ŒºA, the average current consumption is 1/240 * 6.6 mA.  The typical capacity of the CR2032 element is 225 mAh, so it will suffice for (225 / 6.6) x 240/24 = 340 days - a little less than a year. <br><br>  The temperature ranges of the components are as follows: the microcontroller and the indicator are from -40 to + 85 ¬∞ C, the resistors and the capacitor are from -55 to +125 ¬∞ C, and the batteries are from -20 to +70 ¬∞ C.  The element with the extended temperature range BR2032 will operate in the range from -30 to +85 ¬∞ C. <br><br>  The microcontroller is made Arduino-compliant with <a href="https://github.com/SpenceKonde/ATTinyCore">this</a> Spence Konde development.  In IDE, select ATtiny24 / 44/84 in the ATTinyCore section of the Board menu.  Then you need to set the following options, regardless of the rest: <br><br><pre> <code class="plaintext hljs">Chip: "ATtiny84" Clock: "8 MHz (internal)" BOD: "BOD Disabled" Pin Mapping: "Clockwise (like damellis core)"</code> </pre> <br>  The program is flooded using the Pomona test clip, placed on top of the microcontroller and connected to the SparkFun Tiny AVR Programmer.  First you need to select Burn Bootloader, then - Upload. <br><br>  Links: the <a href="http://www.technoblogy.com/list%3F2GQO">full text of the program</a> , the <a href="https://github.com/technoblogy/two-digit-thermometer">board and the program on GitHub</a> , the <a href="https://oshpark.com/shared_projects/CWZO4SzB">board on OSHpark</a> . </div><p>Source: <a href="https://habr.com/ru/post/454220/">https://habr.com/ru/post/454220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454206/index.html">PHDays 9: AI CTF Parsing</a></li>
<li><a href="../454208/index.html">RISC-V from scratch</a></li>
<li><a href="../454210/index.html">Forgotten enchantjs + new 1C-Bitrix = Game for customer motivation</a></li>
<li><a href="../454214/index.html">I hate almost all software.</a></li>
<li><a href="../454216/index.html">Found evidence that all changes are a mixture of order and chance</a></li>
<li><a href="../454222/index.html">Upgrade the disk subsystem of the old server with a PCIe 1.0 bus - 2.0</a></li>
<li><a href="../454224/index.html">Recommendations in Okko: how to earn hundreds of millions by multiplying a couple of matrices</a></li>
<li><a href="../45423/index.html">Obamizator for everyone</a></li>
<li><a href="../454232/index.html">OOP in graphical programming languages. Part 2 MOP and OOP</a></li>
<li><a href="../454236/index.html">Two stories about how ANKI can help you learn a foreign language and prepare for an interview.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>