<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The problem with bound variables: how to turn the optimizer from enemy to friend</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The author of the article is Victor Varlamov ( varlamovVp18 ), OCP. 
 The original article was published on 07/07/2017. 
 Special thanks to the author...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The problem with bound variables: how to turn the optimizer from enemy to friend</h1><div class="post__text post__text-html js-mediator-article">  The author of the article is <a href="https://www.linkedin.com/in/victor-varlamov-a02a2567/">Victor Varlamov</a> ( <a href="https://habr.com/ru/users/varlamovvp18/" class="user_link">varlamovVp18</a> ), OCP. <br>  <a href="http://oracle.it-is-simple.ru/2017/07/19/a-problem-with-bind-variable-peeking-in-dss-systems/">The original article was</a> published on 07/07/2017. <br>  Special thanks to the author of the translation - <a href="https://habr.com/ru/users/brutaltag/" class="user_link">brutaltag</a> . <br><br>  Our reporting system typically runs hundreds of lengthy queries that are triggered by various events.  The query parameters are the list of clients and the time interval (daily, weekly, monthly).  Because of the irregular data in the tables, a single query can produce either a single row or a million rows, depending on the parameters of the report (for different clients there is a different number of rows in the fact tables).  Each report is designed as a package with a main function that accepts input parameters, performs additional transformations, then opens a static cursor with <a href="https://www.rdtex.ru/glossary/b/B47636/">associated variables</a> and returns this open cursor at the end.  The database parameter CURSOR_SHARING is set in FORCE. <br>  In such a situation, one has to deal with poor performance, both in the case of re-use of the query plan by the optimizer, and with <a href="https://www.rdtex.ru/glossary/h/H60952/">full parsing of the</a> query with <a href="https://www.rdtex.ru/glossary/L/L47933/">literal</a> parameters.  Associated variables may cause a non-optimal query plan. <br><a name="habracut"></a><br>  In his book ‚ÄúOracle Expert Practices,‚Äù Alex Gorbachev tells an interesting story told to him by Tom Kite.  Every rainy Monday, users had to deal with a modified query plan.  It is hard to believe, but it was so: <br><blockquote>  ‚ÄúAccording to the observations of end users, when it rained heavily on Monday, the database performance was terrible.  On any other day of the week or on Monday there were no problems without rain.  From a conversation with the database administrator Tom Kite learned that the difficulties continued until the forced restart of the database, after which the performance became normal.  That was such a workaround: rainy Monday - restart. ‚Äù </blockquote><br>  This is a real case, and the problem was solved completely without any magic, only thanks to the excellent knowledge of how Oracle works.  I will show the solution at the end of the article. <br>  Here is a small example of how related variables work. <br>  Create a table with irregular data. <br><br><pre><code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> VVP_HARD_PARSE_TEST(C1 <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, C2 <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, C3 VARCHAR2(<span class="hljs-number"><span class="hljs-number">300</span></span>)); TABLE created. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> VVP_HARD_PARSE_TEST <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROWNUM</span></span> C1, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> &lt; <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MOD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">ROWNUM</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>)=<span class="hljs-number"><span class="hljs-number">99</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">99</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> C2, RPAD(<span class="hljs-string"><span class="hljs-string">'A'</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span>) C3 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> DUAL <span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INDEX</span></span> IND_VVP_HARD_PARSE_TEST_C2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> VVP_HARD_PARSE_TEST(C2); INDEX created. SQL&gt; EXEC DBMS_STATS.GATHER_TABLE_STATS(OWNNAME =&gt; USER, TABNAME =&gt; 'VVP_HARD_PARSE_TEST', CASCADE =&gt; TRUE, METHOD_OPT=&gt;'FOR ALL INDEXED COLUMNS SIZE 254'); PL/SQL PROCEDURE successfully completed. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> histogram <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> user_tab_columns <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> table_name = <span class="hljs-string"><span class="hljs-string">'VVP_HARD_PARSE_TEST'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> column_name = <span class="hljs-string"><span class="hljs-string">'C2'</span></span>; HISTOGRAM <span class="hljs-comment"><span class="hljs-comment">--------- FREQUENCY SQL&gt; SELECT c2, COUNT(*) FROM VVP_HARD_PARSE_TEST GROUP BY c2 ORDER BY 1; C2 COUNT(*) ----------------------- 1 8 99 10000 1000000 989992</span></span></code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In other words, we have the table VVP_HARD_PARSE_TEST with a million rows, where in 10,000 cases the field C2 = 99, 8 records with C2 = 1, and the rest with C2 = 1000000. A histogram across the field C2 tells the Oracle optimizer about this data distribution.  This situation is known as a <a href="https://www.rdtex.ru/glossary/s/S47504/">non-uniform distribution of data</a> , and a histogram can help choose the right query plan, depending on the requested data. <br><br>  Observe simple queries to this table.  Obviously, for the request <br><br> <code>SELECT * FROM VVP_HARD_PARSE_TEST WHERE c2 = :p</code> <br> <br>  if p = 1, then the best choice would be INDEX RANGE SCAN, for the case of p = 1000000 it is better to use FULL TABLE SCAN.  Query1 and Query1000000 queries are identical, except for the text in the comments, this is done to get different identifiers of query plans. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>; v NUMBER; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> V := <span class="hljs-number"><span class="hljs-number">0</span></span>; p := 1000000; FOR rec IN (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+query1000000*/</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> VVP_HARD_PARSE_TEST <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c2 = p) <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> V := v + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; dbms_output.put_line(v); v : =0; p := 1; FOR rec IN (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+query1000000*/</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> VVP_HARD_PARSE_TEST <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c2 = p) <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> V := v + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; dbms_output.put_line(v); <span class="hljs-comment"><span class="hljs-comment">----------------- V := 0; p := 1; FOR rec IN (SELECT /*+query1*/ * FROM VVP_HARD_PARSE_TEST WHERE c2 = p) LOOP V := v + 1; END LOOP; dbms_output.put_line(v); v := 0; p := 1000000; FOR rec IN (SELECT /*+query1*/ * FROM VVP_HARD_PARSE_TEST WHERE c2 = p) LOOP V := v + 1; END LOOP; dbms_output.put_line(v); END;</span></span></code> </pre><br>  Now look at the query plans: <br><br><pre> <code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sql_id, child_number, executions, plan_hash_value, sql_text <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> v$<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> sql_text <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT % * FROM VVP_HARD_PARSE_TEST WHERE C2%'</span></span>; SQL_ID CHILD_NUMBER EXECUTIONS PLAN_HASH_VALUE SQL_TEXT <span class="hljs-comment"><span class="hljs-comment">------------------------------------------------- 7rqnhhp6pahw2 0 2 2782757451 SELECT /*+query1000000*/ * FROM VVP_HARD_PARSE_TEST WHERE C2 = :B1 7xwt28hvw3u9s 0 2 2463783749 SELECT /*+query1*/ * FROM VVP_HARD_PARSE_TEST WHERE C2 = :B1 SQL&gt; SELECT * FROM TABLE(dbms_xplan.display_cursor(sql_id =&gt; '7rqnhhp6pahw2', format =&gt; 'basic +peeked_binds')); SELECT /*+query1000000*/ * FROM VVP_HARD_PARSE_TEST WHERE C2 = :B1 PLAN hash VALUE: 2782757451 ------------------------------------------------- | Id | Operation | Name | ------------------------------------------------- | 0 | SELECT STATEMENT | | | 1 | TABLE ACCESS FULL| VVP_HARD_PARSE_TEST | ------------------------------------------------- Peeked Binds (IDENTIFIED BY position): -------------------------------------- 1 - :B1 (NUMBER): 1000000 SQl&gt; SELECT * FROM TABLE(dbms_xplan.display_cursor(sql_id =&gt; '7xwt28hvw3u9s', format =&gt; 'basic +peeked_binds')); SELECT /*+query1*/ * FROM VVP_HARD_PARSE_TEST WHERE C2 = :B1 PLAN hash VALUE: 2463783749 ------------------------------------------------------------------ | Id | Operation | Name | ------------------------------------------------------------------ | 0 | SELECT STATEMENT | | | 1 | TABLE ACCESS BY INDEX ROWID| VVP_HARD_PARSE_TEST | | 2 | INDEX RANGE SCAN | IND_VVP_HARD_PARSE_TEST_C2 | ------------------------------------------------------------------ Peeked Binds (IDENTIFIED BY position): -------------------------------------- 1 - :B1 (NUMBER): 1</span></span></code> </pre><br>  As you can see, a plan for different queries is created only once, at the time of the first execution (only one child cursor with CHILD_NUMBER = 0 exists for each query).  Each request is executed twice (EXECUTION = 2).  During a hard parse, Oracle retrieves the values ‚Äã‚Äãof the associated variables and selects a plan according to these values.  But he uses the same plan for the next run, despite the fact that the associated variables changed in the second run.  Non-optimal plans are used - Query1000000 with variable C2 = 1 uses FULL TABLE SCAN instead of INDEX RANGE SCAN, and vice versa. <br><br>  Clearly, patching an application and using parameters as literals in a query is the most appropriate way to solve a problem, but it leads to dynamic SQL with its known flaws.  Another way is to disable the query of related variables ( <code>ALTER SESSION SET "_OPTIM_PEEK_USER_BINDS" = FALSE</code> ) or delete histograms ( <a href="https://www.pythian.com/blog/stabilize-oracle-10gs-bind-peeking-behaviour/">link</a> ). <br><br>  One possible solution is the alternative use of data access policies, also known as <a href="https://www.rdtex.ru/glossary/v/V50029/">Virtual Private Database</a> (detailed access control, <a href="https://www.rdtex.ru/glossary/f/F48008/">Fine Grained Access Control</a> , row level control).  This allows you to change requests on the fly and therefore can cause a complete analysis of the query plan each time the query uses detailed access control.  This technique is described in detail in the <a href="http://oracle-randolf.blogspot.com/2009/02/how-to-force-hard-parse.html">article Randalph Geist</a> .  The disadvantage of this method is the increasing number of complete parses and the inability to manipulate query plans. <br><br>  See what we do now.  After analyzing our data, we decide to divide customers into three categories - Large, Medium and Small (LMS or 9-5-1) - according to the number of transactions or transactions during the year.  Also, the number of lines in the report strictly depends on the period: Monthly - Large, Weekly - Middle, Daily - Small or 9-5-1.  Further, the solution is simple - we will make the predicate of the security policy dependent on each category and on each period.  So, for each request, we get 9 possible child cursors.  Moreover, queries with different policies will lead us to the same query identifiers, this makes it possible to implement SQL PLAN MANAGEMENT (sql plan baseline). <br><br><pre> <code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> HARD_PARSE_TABLE <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual; TABLE created. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> CLIENTS_HP_STATISTICS (client_seqno <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, client_id VARCHAR2(<span class="hljs-number"><span class="hljs-number">255</span></span>), cnt_year <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>); TABLE created. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> CLIENTS_HP_STATISTICS (client_seqno, client_id, cnt_year) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'SMALL CLIENT'</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>); 1 ROW inserted. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> CLIENTS_HP_STATISTICS (client_seqno, client_id, cnt_year) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">99</span></span>, <span class="hljs-string"><span class="hljs-string">'MIDDLE CLIENT'</span></span>, <span class="hljs-number"><span class="hljs-number">50001</span></span>); 1 ROW inserted. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> CLIENTS_HP_STATISTICS (client_seqno, client_id, cnt_year) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1000000</span></span>,<span class="hljs-string"><span class="hljs-string">'LARGE CLIENT'</span></span>, <span class="hljs-number"><span class="hljs-number">989992</span></span>); 1 ROW inserted. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PACKAGE</span></span> FORCE_HARD_PARSE_PKG <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> gc_small <span class="hljs-keyword"><span class="hljs-keyword">CONSTANT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> := <span class="hljs-number"><span class="hljs-number">1</span></span>; gc_middle CONSTANT NUMBER := 5; gc_large CONSTANT NUMBER := 9; gc_client_middle CONSTANT NUMBER := 50000; gc_client_large CONSTANT NUMBER := 500000; gc_daterange_middle CONSTANT NUMBER := 10; gc_daterange_large CONSTANT NUMBER := 50; FUNCTION FORCE_HARD_PARSE(in_schema VARCHAR2, in_object VARCHAR2) RETURN VARCHAR2; PROCEDURE SET_PREDICATE (n NUMBER); PROCEDURE SET_PREDICATES (p_daterange NUMBER DEFAULT NULL, p_clientrange NUMBER DEFAULT NULL); PROCEDURE CALC_PREDICATE; PROCEDURE CALC_PREDICATES(p_date_interval NUMBER DEFAULT 1, p_client_seqno NUMBER DEFAULT NULL, p_client_id VARCHAR2 DEFAULT NULL, p_client_seqno_list VARCHAR2 DEFAULT NULL ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> FORCE_HARD_PARSE_PKG; PACKAGE created. SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PACKAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span> FORCE_HARD_PARSE_PKG <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> g_predicate <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>; <span class="hljs-comment"><span class="hljs-comment">-- g_daterange || 0 || g_clientrange g_daterange NUMBER; -- 1 - small, 5 - middle, 9 - large g_clientrange NUMBER; -- 1 - small, 5 - middle, 9 - large -- FUNCTION FORCE_HARD_PARSE(in_schema VARCHAR2, in_object VARCHAR2) RETURN VARCHAR2 IS BEGIN IF NVL(g_predicate, 0) = 0 THEN RETURN NULL; ELSE RETURN TO_CHAR(g_predicate, 'TM') || ' = ' || TO_CHAR(g_predicate, 'TM'); END IF; END FORCE_HARD_PARSE; -- PROCEDURE SET_PREDICATE (n NUMBER) IS BEGIN g_predicate := n; END; PROCEDURE SET_PREDICATES (p_daterange NUMBER DEFAULT NULL, p_clientrange NUMBER DEFAULT NULL) IS BEGIN IF p_daterange IS NOT NULL THEN g_daterange := p_daterange; CALC_PREDICATE; END IF; IF p_clientrange IS NOT NULL THEN g_clientrange := p_clientrange; CALC_PREDICATE; END IF; END SET_PREDICATES; PROCEDURE CALC_PREDICATE IS BEGIN g_predicate := NVL(g_daterange, 0) * 100 + NVL(g_clientrange, 0); END CALC_PREDICATE; PROCEDURE CALC_PREDICATES (p_date_interval NUMBER DEFAULT 1, p_client_seqno NUMBER DEFAULT NULL, p_client_id VARCHAR2 DEFAULT NULL, p_client_seqno_list VARCHAR2 DEFAULT NULL) IS v_cnt NUMBER; BEGIN IF p_date_interval IS NOT NULL THEN g_daterange := CASE WHEN p_date_interval &lt; gc_daterange_middle THEN gc_small WHEN p_date_interval &lt; gc_daterange_large THEN gc_middle ELSE gc_large END; CALC_PREDICATE; END IF; IF COALESCE(p_client_seqno, p_client_id, p_client_seqno_list) IS NOT NULL THEN SELECT NVL(SUM(cnt_year), 0) AS cnt INTO v_cnt FROM CLIENTS_HP_STATISTICS t WHERE 1=1 AND (p_client_seqno IS NULL OR p_client_seqno = t.client_seqno) AND (p_client_id IS NULL OR p_client_id = t.client_id) AND (p_client_seqno_list IS NULL OR t.client_seqno IN (SELECT SUBSTR(s, CASE WHEN LEVEL &gt; 1 THEN INSTR(s, ',', 1, LEVEL - 1 ) + 1 ELSE 1 END, INSTR(s, ',', 1, LEVEL) ‚Äì CASE WHEN LEVEL &gt; 1 THEN INSTR(s, ',', 1, LEVEL ‚Äì 1) + 1 ELSE 1 END) FROM (SELECT p_client_seqno_list||',' AS s FROM DUAL) CONNECT BY INSTR(s, ',', 1, LEVEL) &gt; 0)); g_clientrange := CASE WHEN v_cnt &gt; gc_client_large THEN gc_large WHEN v_cnt &gt; gc_client_middle THEN gc_middle ELSE gc_small END; CALC_PREDICATE; END IF; END CALC_PREDICATES; END FORCE_HARD_PARSE_PKG; PACKAGE BODY created. SQL&gt; EXEC DBMS_RLS.ADD_POLICY (USER, 'HARD_PARSE_TABLE', 'HARD_PARSE_POLICY', USER, 'FORCE_HARD_PARSE_PKG.FORCE_HARD_PARSE', 'select'); PL/SQL PROCEDURE successfully completed.</span></span></code> </pre><br>  Now, if we want to embed such a technology into a report, we need to add HARD_PARSE_TABLE to the query (this will not spoil it a bit) and call CALC_PREDICATES before the main query is executed. <br><br>  Let's see how this technique can transform the previous example: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> p <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>; v NUMBER; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> V := <span class="hljs-number"><span class="hljs-number">0</span></span>; p := 1000000; FORCE_HARD_PARSE_PKG.SET_PREDICATE(1000000); FOR rec IN (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+query_hp1000000*/</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c2 = p) <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> V := v + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; dbms_output.put_line(v); v := 0; p := 1; FORCE_HARD_PARSE_PKG.SET_PREDICATE(1); FOR rec IN (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-comment"><span class="hljs-comment">/*+query_hp1000000*/</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> c2 = p) <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> V := v + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; dbms_output.put_line(v); <span class="hljs-comment"><span class="hljs-comment">----------------- V := 0; p := 1; FORCE_HARD_PARSE_PKG.SET_PREDICATE(1); FOR rec IN (SELECT /*+query_hp1*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE c2 = p) LOOP V := v + 1; END LOOP; dbms_output.put_line(v); v := 0; p := 1000000; FORCE_HARD_PARSE_PKG.SET_PREDICATE(1000000); FOR rec IN (SELECT /*+query_hp1*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE c2 = p) LOOP V := v + 1; END LOOP; dbms_output.put_line(v); END;</span></span></code> </pre><br>  Let's look at the execution plans: <br><br><pre> <code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sql_id, child_number, executions, plan_hash_value, sql_text, s.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> v$<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> sql_text <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'SELECT % * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE c2%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>; SQL_ID CHILD_NUMBER EXECUTIONS PLAN_HASH_VALUE SQL_TEXT <span class="hljs-comment"><span class="hljs-comment">-------------------------------------------------------------------------------- 7wva3uqbgh4qf 0 1 1136240498 SELECT /*+query_hp1000000*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 7wva3uqbgh4qf 1 1 3246475190 SELECT /*+query_hp1000000*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 8cju3tfjvwm1p 0 1 3246475190 SELECT /*+query_hp1*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 8cju3tfjvwm1p 1 1 1136240498 SELECT /*+query_hp1*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 -- SQL&gt; SELECT * FROM TABLE(dbms_xplan.display_cursor(sql_id =&gt; '7wva3uqbgh4qf', cursor_child_no =&gt; 0, format =&gt; 'basic +peeked_binds')); SELECT /*+query_hp1000000*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 PLAN hash VALUE: 1136240498 ---------------------------------------------------- | Id | Operation | Name | ---------------------------------------------------- | 0 | SELECT STATEMENT | | | 1 | MERGE JOIN CARTESIAN| | | 2 | TABLE ACCESS FULL | HARD_PARSE_TABLE | | 3 | BUFFER SORT | | | 4 | TABLE ACCESS FULL | VVP_HARD_PARSE_TEST | ---------------------------------------------------- Peeked Binds (IDENTIFIED BY position): -------------------------------------- 1 - :B1 (NUMBER): 1000000 -- SQL&gt; SELECT * FROM TABLE(dbms_xplan.display_cursor(sql_id =&gt; '7wva3uqbgh4qf', cursor_child_no =&gt; 1, format =&gt; 'basic +peeked_binds')); SELECT /*+query_hp1000000*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 PLAN hash VALUE: 3246475190 -------------------------------------------------------------------- | Id | Operation | Name | -------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | 1 | MERGE JOIN CARTESIAN | | | 2 | TABLE ACCESS FULL | HARD_PARSE_TABLE | | 3 | BUFFER SORT | | | 4 | TABLE ACCESS BY INDEX ROWID| VVP_HARD_PARSE_TEST | | 5 | INDEX RANGE SCAN | IND_VVP_HARD_PARSE_TEST_C2 | -------------------------------------------------------------------- Peeked Binds (IDENTIFIED BY position): -------------------------------------- 1 - :B1 (NUMBER): 1 -- SQl&gt; SELECT * FROM TABLE(dbms_xplan.display_cursor(sql_id =&gt; '8cju3tfjvwm1p', cursor_child_no =&gt; 0, format =&gt; 'basic +peeked_binds')); SELECT /*+query_hp1*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 PLAN hash VALUE: 3246475190 -------------------------------------------------------------------- | Id | Operation | Name | -------------------------------------------------------------------- | 0 | SELECT STATEMENT | | | 1 | MERGE JOIN CARTESIAN | | | 2 | TABLE ACCESS FULL | HARD_PARSE_TABLE | | 3 | BUFFER SORT | | | 4 | TABLE ACCESS BY INDEX ROWID| VVP_HARD_PARSE_TEST | | 5 | INDEX RANGE SCAN | IND_VVP_HARD_PARSE_TEST_C2 | -------------------------------------------------------------------- Peeked Binds (IDENTIFIED BY position): -------------------------------------- 1 - :B1 (NUMBER): 1 -- SQL&gt; SELECT * FROM TABLE(dbms_xplan.display_cursor(sql_id =&gt; '8cju3tfjvwm1p', cursor_child_no =&gt; 1, format =&gt; 'basic +peeked_binds')); SELECT /*+query_hp1*/ * FROM VVP_HARD_PARSE_TEST, HARD_PARSE_TABLE WHERE C2 = :B1 PLAN hash VALUE: 1136240498 ---------------------------------------------------- | Id | Operation | Name | ---------------------------------------------------- | 0 | SELECT STATEMENT | | | 1 | MERGE JOIN CARTESIAN| | | 2 | TABLE ACCESS FULL | HARD_PARSE_TABLE | | 3 | BUFFER SORT | | | 4 | TABLE ACCESS FULL | VVP_HARD_PARSE_TEST | ---------------------------------------------------- Peeked Binds (IDENTIFIED BY position): -------------------------------------- 1 - :B1 (NUMBER): 1000000</span></span></code> </pre><br>  Looks good!  Each query is executed twice, with different child cursors and different plans.  For the parameter C2 = 1000000, we see the FULL TABLE SCAN in both queries, and for the parameter C1 = 1, we always see INDEX RANGE SCAN. <br><br>  At the end I cite a case with rainy Fridays: <br><br><blockquote>  ‚ÄúIt turns out that every weekend on Sunday there was a <a href="https://www.rdtex.ru/glossary/c/C58075/">cold backup</a> , so that all plans for requests were regenerated on the first execution on Monday morning.  One of the employees usually started his work before the others, and his query plan was well implemented for other users during the week.  However, if it was raining, this user was late for the start of the working day due to problems with his morning route.  Then the batch calculation of reports was first launched, but the query plan was completely bad for other cases due to inappropriate values ‚Äã‚Äãof the associated variables. ‚Äù </blockquote><br>  And a few useful system views: <br>  ‚Ä¢ <code>dba_tab_histograms, all_tab_histograms, user_tab_histograms</code> <br>  ‚Ä¢ <code>v$vpd_policy</code> <br>  ‚Ä¢ <code>v$sql_bind_capture</code> <br>  ‚Ä¢ <code>dba_hist_sqlbind</code> </div><p>Source: <a href="https://habr.com/ru/post/434444/">https://habr.com/ru/post/434444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../434430/index.html">IBM showed 8-bit analog phase memory chip</a></li>
<li><a href="../434432/index.html">Wii, Wai, Wai, Frond - ‚Äúdifficulties of translation‚Äù, or what lies behind the new platform SAS Viya (Frond)</a></li>
<li><a href="../434438/index.html">Excel performance in pure javascript is achievable</a></li>
<li><a href="../434440/index.html">[Video] Warships, bots and shooting money at servers</a></li>
<li><a href="../434442/index.html">Astronautics 2018 - year results</a></li>
<li><a href="../434446/index.html">What I don't like is Go</a></li>
<li><a href="../434448/index.html">We cover A / B tests with UI tests. How not to get lost in your own code</a></li>
<li><a href="../434450/index.html">TeamLead Conf: ‚ÄúMBA digital is not a friend‚Äù</a></li>
<li><a href="../434456/index.html">Where did we get the bottle?</a></li>
<li><a href="../434458/index.html">State-owned companies have launched the process of transition to domestic software.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>