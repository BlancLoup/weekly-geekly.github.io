<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Dynamic blur on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is plenty of information on how to quickly blur an image on Android. 
 But is it possible to do this so effectively that without lags redraw a b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Dynamic blur on Android</h1><div class="post__text post__text-html js-mediator-article">  There is plenty of information on how to quickly blur an image on Android. <br>  But is it possible to do this so effectively that without lags redraw a blurred bitmap for any content change, as it is implemented in iOS? <br><a name="habracut"></a><br>  So, what I would like to do: <br><ol><li>  ViewGroup, which can blur the content that is under it and display as its background.  Let's call it BlurView </li><li>  Ability to add children to it (any View) </li><li>  Do not depend on any particular implementation of the parent ViewGroup. </li><li>  Redraw blurred background if the content under our View changes </li><li>  Do a full cycle of blurring and rendering in less than 16ms </li><li>  Have the ability to change the blur strategy </li></ol><br>  In the article I will try to pay attention only to the key points, for details I ask <a href="https://github.com/Dimezis/BlurView">here</a> . <br><br><div class="spoiler">  <b class="spoiler_title">gif with an example (8mb)</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/2b1/518/0f9/2b15180f90614c989f7120a2eb46891d.gif"><br></div></div><br><h1>  How to get a bitmap with content under BlurView? </h1><br>  Create a Canvas, a Bitmap for it, and let the entire View hierarchy be drawn on this canvas. <br><br><pre><code class="java hljs">internalBitmap = Bitmap.createBitmap(viewWidth, viewHeight, Bitmap.Config.ARGB_8888); internalCanvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(internalBitmap); ... rootView.draw(internalCanvas);</code> </pre> <br>  Now in the internalBitmap all views are drawn, which are visible on the screen. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Problems:</b> <br>  If your rootView does not have a specified background, you must first draw a background Activity on the canvas, otherwise it will be transparent on the bitmap. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> View decorView = getWindow().getDecorView(); <span class="hljs-comment"><span class="hljs-comment">//Activity's root View. Can also be root View of your layout final View rootView = decorView.findViewById(android.R.id.content); final Drawable windowBackground = decorView.getBackground(); ... windowBackground.draw(internalCanvas); rootView.draw(internalCanvas);</span></span></code> </pre><br>  I would like to draw only that part of the hierarchy that we need.  That is, under our BlurView, with the appropriate size. <br>  In addition, it would be nice to reduce the Bitmap on which the drawing will take place.  This will speed up the rendering of the View hierarchy, blur itself, as well as reduce memory consumption. <br>  Add a scaleFactor field, it is desirable that this coefficient be a power of two. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaleFactor = <span class="hljs-number"><span class="hljs-number">8</span></span>;</code> </pre><br>  Reduce the bitmap by 8 times and adjust the canvas matrix so that it draws correctly on it, taking into account position, size and scale factor: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupInternalCanvasMatrix</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaledLeftPosition = -blurView.getLeft() / scaleFactor; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaledTopPosition = -blurView.getTop() / scaleFactor; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaledTranslationX = blurView.getTranslationX() / scaleFactor; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaledTranslationY = blurView.getTranslationY() / scaleFactor; internalCanvas.translate(scaledLeftPosition - scaledTranslationX, scaledTopPosition - scaledTranslationY); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaleX = blurView.getScaleX() / scaleFactor; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> scaleY = blurView.getScaleY() / scaleFactor; internalCanvas.scale(scaleX, scaleY); }</code> </pre><br>  Now, when calling rootView.draw (internalCanvas), we will have a smaller copy of the entire View hierarchy on the internalBitmap.  It will look scary, but it does not really bother me, because  I will continue to blur it anyway. <br><br>  <b>Problems:</b> <br>  rootView will tell all its children to draw on the canvas, including BlurView.  I would like to avoid this; BlurView should not blur itself.  To do this, you can override the draw (Canvas canvas) method in BlurView and make a check on what canvas it is asked to draw. <br>  If this is a system canvas, we allow rendering, if it is internalCanvas, then disable it. <br><br><h1>  Actually, blur </h1><br>  I made the interface BlurAlgorithm and the ability to customize the algorithm. <br>  Added 2 implementations, StackBlur (by Mario Klingemann) and RenderScriptBlur.  The RenderScript option runs on the GPU. <br>  To save memory, I write the result in the same bitmap that I came to the input.  This is optional. <br>  You can also try to cache outAllocation and reuse it if the size of the input image has not changed. <br><br><div class="spoiler">  <b class="spoiler_title">RenderScriptBlur</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">blur</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap bitmap, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> blurRadius)</span></span></span><span class="hljs-function"> </span></span>{ Allocation inAllocation = Allocation.createFromBitmap(renderScript, bitmap); Bitmap outputBitmap; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (canModifyBitmap) { outputBitmap = bitmap; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { outputBitmap = Bitmap.createBitmap(bitmap.getWidth(), bitmap.getHeight(), bitmap.getConfig()); } <span class="hljs-comment"><span class="hljs-comment">//do not use inAllocation in forEach. it will cause visual artifacts on blurred Bitmap Allocation outAllocation = Allocation.createTyped(renderScript, inAllocation.getType()); blurScript.setRadius(blurRadius); blurScript.setInput(inAllocation); blurScript.forEach(outAllocation); outAllocation.copyTo(outputBitmap); inAllocation.destroy(); outAllocation.destroy(); return outputBitmap; }</span></span></code> </pre><br></div></div><br><h1>  When to redraw blur? </h1><br>  There are several options: <br><ol><li>  Manually make an update when you know for sure that the content has changed </li><li>  Join scrolling events if BlurView is above a scrolling container. </li><li>  Play draw () calls via ViewTreeObserver </li></ol><br>  I chose option 3 using OnPreDrawListener.  It is worth noting that his onPreDraw method twitches every time any View in the hierarchy draws itself.  This, of course, is not ideal, because  BlurView will have to be redrawn for every sneeze, but this does not require any control by the programmer. <br><br>  <b>Problems:</b> <br>  onPreDraw will also be called when the entire hierarchy is drawn on the internalCanvas, as well as when the BlurView is drawn. <br>  To avoid this problem, I started the isMeDrawingNow flag. <br><br>  It seems everything is obvious, except for one moment.  You need to set it to false via handler, because  The draw dispatch occurs asynchronously through the UI thread of the thread.  Therefore, you also need to add this task to the event queue so that it runs exactly at the end of the drawing. <br><br><pre> <code class="java hljs">drawListener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ViewTreeObserver.OnPreDrawListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPreDraw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isMeDrawingNow) { updateBlur(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } }; rootView.getViewTreeObserver().addOnPreDrawListener(drawListener);</code> </pre><br><h1>  Performance </h1><br>  I haven't collected a lot of statistics, but on Nexus 4, Nexus 5, the whole drawing cycle takes 1-4ms on the screens from the demo project. <br>  Galaxy nexus - about 10ms. <br>  Sony Xperia Z3 compact for some reason copes worse - 8-16ms. <br>  Nevertheless, I am satisfied with the performance, the FPS is kept at a good level. <br><br><h1>  Conclusion </h1><br>  All code is on githab (library and demo project) - <a href="https://github.com/Dimezis/BlurView">BlurView</a> . <br>  Ideas, comments, bug reports and pull requests are welcome. </div><p>Source: <a href="https://habr.com/ru/post/302552/">https://habr.com/ru/post/302552/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../302538/index.html">Experience of using Liferay Portal in eCommerce</a></li>
<li><a href="../302542/index.html">10,000 virtual servers on RU VDS</a></li>
<li><a href="../302544/index.html">Unwanted DNS Unlocker uses the DNS hijack method to trick users</a></li>
<li><a href="../302548/index.html">Security Week 22: Microsoft against passwords, legal issues with Tor, crypto-fiber attacks Amazon customers</a></li>
<li><a href="../302550/index.html">IBM introduces the world's first PCM memory with three bits per cell</a></li>
<li><a href="../302554/index.html">Uber founder Travis Kalanik - "a rebel in the elite of Silicon Valley"</a></li>
<li><a href="../302556/index.html">Mastering programming - no problem</a></li>
<li><a href="../302560/index.html">Mars rover Opportunity more than 40 times the planned service life</a></li>
<li><a href="../302562/index.html">How to set up two-factor authentication for login and sudo</a></li>
<li><a href="../302566/index.html">Wolfram Technologies: 4th Russian Conference</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>