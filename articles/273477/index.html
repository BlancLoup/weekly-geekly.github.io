<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Symfony2 Voters and Doctrine Filters on guard for security</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It all started when I set up a single CRM security system. As it often happens, there were users with different levels of access to the main data (let...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Symfony2 Voters and Doctrine Filters on guard for security</h1><div class="post__text post__text-html js-mediator-article">  It all started when I set up a single CRM security system.  As it often happens, there were users with different levels of access to the main data (let's call them entities).  The view of the main grid was the same, the flexibility of access settings to entities was necessary.  At first I thought about the ACL, but ... <br><a name="habracut"></a><br>  ... nothing happened. <br><br>  <b>ACL</b> (Access Control List) - these are lists that store information about what each user (or group of users) can do with each protection object.  Symfony has a built-in <a href="http://symfony.com/doc/current/cookbook/security/acl.html">ACL</a> mechanism, and I got to study it.  To begin, I looked at an example of installing protection on an object.  At the first reading, I did not like that the privileges were hung on the user: thus I would have to fence huge tables of privileges, listing all users and their permitted actions.  However, a short googling led told me that in addition to UserSecurityIdentity, which was present in the example, there is <a href="http://api.symfony.com/2.7/Symfony/Component/Security/Acl/Domain/RoleSecurityIdentity.html">RoleSecurityIdentity</a> .  Fine!  In addition, I was pleasantly surprised to learn that it is possible to hang privileges not only on objects, but also on classes.  Well, fine, but it still does not suit me, since  privileges vary depending on the state of the entity.  Having collected all my thoughts in a heap, I presented how all this will look like in the future: create liseners that will catch the creation of Entity, change the state of Entity and write, write ACE in the database (for all roles, and there were more than 20 from the start).  And then, when the user needs to do something, I will look for one (or several, if the user has several roles) from many millions of ACEs to make sure that the action is allowed.  In general, the system seemed rather cumbersome and clumsy, although, and this can not be taken away from it, it performs its functions clearly and meticulously. <br><br>  For a while, I even considered writing my ACL system <s>with preference and confused</s> , but I rejected it as an unnecessary construction.  The only plus of all this tinsel - I decided that I would use masks, since each user could have many roles, and I liked cumulative privileges. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I decided to split the task, and first deal with restricting access when I receive Entities.  Then I thought - and I‚Äôll write a custom repository that would override all basic access operations.  But this would not have saved me if someone decided to use DQL, or even create a query with join from another repository.  Then I remembered about doctrine extensions, and specifically - <a href="">softdeletable</a> .  He himself has never been useful to me, I just knew that he is. <br><br>  This expansion can relieve pain when it is necessary to remove entities with a bunch of connections (I have always considered this a symptomatic treatment, and conscientiously set up the cascades).  It marks unwanted entities as deleted.  And that's all.  They remain in the database, but doctrine diligently pretends that they do not exist.  But still, there was an opportunity to ‚Äúremove‚Äù, or at least show everything at all, along with ‚Äútype of deleted‚Äù records. <br><br>  It was exactly this kind of behavior that I needed, so I thanked the gods for the open source and it‚Äôs useful to see how they did it.  So I found out about the <a href="http://doctrine-orm.readthedocs.org/projects/doctrine-orm/en/latest/reference/filters.html">filters</a> . <br><br>  After a short time, I learned how to live with it, and wrote my first filter.  Then the question of including this filter came to me.  It didn‚Äôt suit me to include it every time I request data - everything should be clear and ‚Äújust work‚Äù not only with me, but with other developers, as well as with those poor fellows who will ever be engaged in supporting this.  Now I don‚Äôt remember how I came to this, but I wrote the Configurator - a service that would run at every request, and actually turn on the filter, at the same time substituting the necessary parameters.  From the business logic side, you build the usual queries, and before it is executed, the filter appends a code there that will cut everything that you cannot see by status. <br><br>  Filter itself: <br><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">CRMBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Filter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Mapping</span></span>\<span class="hljs-title"><span class="hljs-title">ClassMetaData</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">ORM</span></span>\<span class="hljs-title"><span class="hljs-title">Query</span></span>\<span class="hljs-title"><span class="hljs-title">Filter</span></span>\<span class="hljs-title"><span class="hljs-title">SQLFilter</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityFilter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQLFilter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addFilterConstraint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassMetadata $targetEntity, $targetTableAlias)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($targetEntity-&gt;getName() != <span class="hljs-string"><span class="hljs-string">'CRMBundle\Entity\Entity'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $statuses = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getParameter(<span class="hljs-string"><span class="hljs-string">'statuses'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (\InvalidArgumentException $e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($statuses)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//   -  -   ,     "" $allowedStates = substr($allowedStates, 1, -1); $allowedStates = str_replace('\\', '', $allowedStates); return $targetTableAlias.".status in (".$allowedStates.")"; } }</span></span></code> </pre> <br>  Configurator: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">CRMBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">Filter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authentication</span></span>\<span class="hljs-title"><span class="hljs-title">Token</span></span>\<span class="hljs-title"><span class="hljs-title">Storage</span></span>\<span class="hljs-title"><span class="hljs-title">TokenStorageInterface</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Persistence</span></span>\<span class="hljs-title"><span class="hljs-title">ObjectManager</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Configurator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $em; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $tokenStorage; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjectManager $em, TokenStorageInterface $tokenStorage)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em = $em; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;tokenStorage = $tokenStorage; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onKernelRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($user = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;getUser()) { $entity_filter = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;em-&gt;getFilters()-&gt;enable(<span class="hljs-string"><span class="hljs-string">'entity_filter'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   implode -     $entity_filter-&gt;setParameter('allowedStates', "'".implode("', '", $this-&gt;getUser()-&gt;getAllowedStates('view'))."'"); } } private function getUser() { $token = $this-&gt;tokenStorage-&gt;getToken(); if (!$token) { return null; } $user = $token-&gt;getUser(); if (!($user instanceof UserInterface)) { return null; } return $user; } }</span></span></code> </pre><br>  And minimal configuration: <br><br><pre> <code class="hljs pgsql">// config.yml services: doctrine.<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span>.configurator: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: CRMBundle\Entity\<span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span>\Configurator arguments: - "@doctrine.orm.entity_manager" - "@security.token_storage" tags: - { <span class="hljs-type"><span class="hljs-type">name</span></span>: kernel.event_listener, event: kernel.request } doctrine: orm: filters: entity_filter: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: CRMBundle\Entity\<span class="hljs-keyword"><span class="hljs-keyword">Filter</span></span>\EntityFilter enabled: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre><br>  After that, call for example <code>$entity-&gt;getChildren();</code>  turns into <code>doctrine.DEBUG: SELECT * FROM entity t0 WHERE t0.parent_id = ? AND ((t0.state in ('new', 'in_work'))) [3]</code> <code>doctrine.DEBUG: SELECT * FROM entity t0 WHERE t0.parent_id = ? AND ((t0.state in ('new', 'in_work'))) [3]</code> <br><br>  So I solved the problem of access to reading.  And for everything else there is a <s>mastercard</s> <a href="http://symfony.com/doc/current/cookbook/security/voters.html">voters</a> .  I‚Äôll talk about using voters in Symfony 2.7, but keep in mind that in version 2.8, Voter was added to the class, which replaces the AbstractVoter that I used in my functionality. <br><br>  The voter itself is the simplest: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">CRMBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Authorization</span></span>\<span class="hljs-title"><span class="hljs-title">Voter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">Authorization</span></span>\<span class="hljs-title"><span class="hljs-title">Voter</span></span>\<span class="hljs-title"><span class="hljs-title">AbstractVoter</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">CRMBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Entity</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">Security</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">User</span></span>\<span class="hljs-title"><span class="hljs-title">UserInterface</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityVoter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractVoter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> VIEW = <span class="hljs-string"><span class="hljs-string">'view'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> EDIT = <span class="hljs-string"><span class="hljs-string">'edit'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INFO_VIEW = <span class="hljs-string"><span class="hljs-string">'info_view'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> INFO_EDIT = <span class="hljs-string"><span class="hljs-string">'info_edit'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ANS_VIEW = <span class="hljs-string"><span class="hljs-string">'ans_view'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ANS_EDIT = <span class="hljs-string"><span class="hljs-string">'ans_edit'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> HISTORY = <span class="hljs-string"><span class="hljs-string">'history'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSupportedAttributes</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::VIEW, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::EDIT, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::INFO_VIEW, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::INFO_EDIT, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ANS_VIEW, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ANS_EDIT, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::HISTORY); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSupportedClasses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'CRMBundle\Entity\Entity'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isGranted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action, $entity = null, $user = null)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$user <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> UserInterface) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($entity-&gt;getState(), $user-&gt;getAllowedStates($action))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre><br>  And connect it: <br><br><pre> <code class="hljs pgsql">// config.yml services: <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">access</span></span>.entity_voter: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: CRMBundle\<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>\<span class="hljs-keyword"><span class="hljs-keyword">Authorization</span></span>\Voter\EntityVoter <span class="hljs-built_in"><span class="hljs-built_in">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> tags: - { <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">security</span></span>.voter }</code> </pre><br>  Entity can have one of 13 states, and I had 7 actions for which permission was needed.  It didn‚Äôt fit even into a 64-bit int, so I did the mask for each action and entrusted their storage to roles.  Plus, I also had global privileges that were not tied to Entity, so in total, each role had 8 bit masks.  In the getMask ($ action) method, I did a bitwise ‚Äúand‚Äù for the user for the necessary mask of all its roles.  The masks are simple as a circle: 13 bits reflect the permission or prohibition of the action for which this mask is responsible for each of the 13 possible states of the Entity.  So, I added the getAllowedStates ($ action) method to users, which returns a list of states in which the $ action is allowed. <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// CRMBundle/Entity/User.php public function getMask($action) { $mask = 0; foreach ($this-&gt;userRoles as $role) { $mask = $mask | $role-&gt;getMask($action); } return $mask; } public function getAllowedStates($action = 'view') { $result = []; $mask = $this-&gt;getMask($action); foreach (['new', 'in_work', 'etc.'] as $key =&gt; $value) { if (((1 &lt;&lt; $key) &amp; $mask) != 0) { $result[] = $value; } } return $result; } // controller $this-&gt;denyAccessUnlessGranted('info_view', $entity, '  !');</span></span></code> </pre><br>  If it's simple: at key points of the application, before you perform an action on an Entity, you call denyAccessUnlessGranted ($ action, $ entity, $ declineMessage), transfer to it the action you want to perform, the Entity on which this action and message will be performed which will cause an Exception in case of a failure.  Just like that.  When you write custom voter, specify which actions and on what type of entities it checks.  Inside voter there is access to a user who wants to do $ action with $ enitity.  Thus, there is everything that is needed, and it remains for me to only check for the presence of the current state of $ entity in the getAllowedStates ($ action) response of the current user and return the result. <br><br>  Summarize.  I implemented data access control with the help of <a href="http://doctrine-orm.readthedocs.org/projects/doctrine-orm/en/latest/reference/filters.html">Doctrine Filter</a> .  Such a filter can add a condition to all requests to the selected entity.  Plus, the solution is that business logic does not require any corrections to make it work.  I implemented permission checking for other actions using <a href="http://symfony.com/doc/current/cookbook/security/voters.html">Symfony Voter</a> . </div><p>Source: <a href="https://habr.com/ru/post/273477/">https://habr.com/ru/post/273477/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../273455/index.html">Implement MVVM in iOS using RxSwift</a></li>
<li><a href="../273467/index.html">In workshops, start-up platforms, or what you need to get money from an investor</a></li>
<li><a href="../273469/index.html">Release DataGrip (ex-0xDBE) 1.0 - New IDE for SQL</a></li>
<li><a href="../273471/index.html">A collection of practical tips and notes on the layout</a></li>
<li><a href="../273473/index.html">PowerShell, AWS CLI and json</a></li>
<li><a href="../273481/index.html">Full URL in the address bar, tabs on the right and other improvements in the assembly Vivaldi 1.0.352.3</a></li>
<li><a href="../273483/index.html">Requirements for game functionality</a></li>
<li><a href="../273485/index.html">PHP application for apps.com - features and rakes</a></li>
<li><a href="../273487/index.html">Objective-C questions for middle / senior level</a></li>
<li><a href="../273489/index.html">Juniper Firewall Backdoors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>