<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automate and speed up the process of setting up cloud servers with Ansible. Part 2: output, debug, and reuse the playbook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the previous article, we began exploring Ansible, a popular tool for automating the configuration and deployment of IT infrastructure. Ansible was ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automate and speed up the process of setting up cloud servers with Ansible. Part 2: output, debug, and reuse the playbook</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/company/infobox/blog/249143/">In the previous article,</a> we began exploring Ansible, a popular tool for automating the configuration and deployment of IT infrastructure.  Ansible was successfully installed in <a href="http://infoboxcloud.ru/">InfoboxCloud</a> , described the principles of operation, the basic setting.  At the end of the article we showed how to quickly install nginx on multiple servers. <br><img src="https://habrastorage.org/getpro/habr/post_images/f6a/816/c99/f6a816c9949a7f826f18a2993a12b031.png" title="Ansible InfoboxCloud" alt="Ansible InfoboxCloud" width="200"><br>  In this article we will continue to study Ansible: analyze the output of the playbook, learn how to debug them and share them for easy reuse. <br><a name="habracut"></a><br><h4>  <b>Configuration Management</b> </h4><br><h5>  <b>Parsing our first playbook</b> </h5><br>  In the last article we got a conclusion from the performance of our first playbook.  Let's break it down. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/009/25e/403/00925e403af9b9d90d1d9be950336230.jpg" width="800"><br><br>  <strong>Gathering facts</strong> is the first default task in any playbook.  The task collects useful server metadata in the form of variables that can be used in the playbook in the future.  For example, such variables can be ip-address, OS architecture and host name. <br>  You can view these variables using the command: <br><pre><code class="bash hljs">ansible -m setup experiments</code> </pre>  where experiments is the name of the section in your inventory. <br>  or write it to a file <br><pre> <code class="bash hljs">ansible -m setup experiments &gt;&gt; facts</code> </pre><br>  Below in the output are the <strong>TASK</strong> tasks, according to the progress of the playbook: installing nginx, starting the service. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's run the playbook again. <br><pre> <code class="bash hljs">ansible-playbook playbooks/setup_nginx.yml</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/412/9c9/e56/4129c9e56b4d4ae537455c7509dd6046.jpg" width="800"><br><br>  Compared to the previous output, the <b>Install nginx package</b> task is completed without modification.  The state has already been reached: nginx is installed.  The task of starting the nginx service in both cases is completed without changes, since the nginx service starts itself immediately after installation.  If you manually stop the nginx service on one of the servers, it will rise after the start of the playbook. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8fd/312/d67/8fd312d67350ffb83ba3669033208f77.jpg" width="800"><br><br>  As we can see, one of the key properties of Ansible systems is fulfilled: <strong>Idempotency</strong> (an operation that, if applied to any value several times, always results in the same value as in a single application).  Most configuration management systems follow this principle and apply it on infrastructure. <br><br>  Let's look at the <strong>PLAY RECAP</strong> section below in the output.  The <strong>changed</strong> parameter shows how many times the status of the server has changed in the tasks.  <strong>ok</strong> is the number of tasks to be executed along with <b>Gathering facts</b> . <br><br><h5>  Debug playbook </h5><br>  Understanding what happened during the execution of the playbook can be very useful for correcting errors. <br>  There are 3 levels of debug output (Verbose). <br><br>  <strong>-v</strong> .  Display basic information. <br><pre> <code class="bash hljs">ansible-playbook playbooks/setup_nginx.yml -v</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/49e/d85/b29/49ed85b29434c3dbb2e92af6cb40b5c3.jpg" width="800"><br><br>  <strong>-vv</strong> .  More detailed output. <br><pre> <code class="bash hljs">ansible-playbook playbooks/setup_nginx.yml -vv</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/c9c/b07/180/c9cb0718050aa41365da85ccb075d3aa.jpg" width="800"><br><br>  <strong>-vvv</strong> .  The most detailed conclusion. <br>  This output specifies the SSH ‚Äì commands that Ansible uses to create temporary files on the remote host to run the script remotely. <br><pre> <code class="bash hljs">ansible-playbook playbooks/setup_nginx.yml -vvv</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/6ac/c8f/7bd/6acc8f7bd7389d92f0428dcd6b0c39c4.jpg" width="800"><br><br>  You can output any variables ansible for debugging.  To do this, add the following section to the playbook: <br><pre> <code class="xml hljs"> - name: Debug debug: msg={{ ansible_distribution }}</code> </pre><br>  When you start the playbook, you will see the output of this variable.  Each Ansible variable begins with the <strong>ansible_</strong> prefix. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b1/9c9/679/6b19c967987c1616ffc54072f42eb63e.jpg" width="800"><br><br>  Another useful command is the opportunity to look at all the tasks running in the playbook.  It is especially useful when there are several playbooks running other playbooks. <br><br><pre> <code class="bash hljs">ansible-playbook playbooks/setup_nginx.yml --list-tasks</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/060/f9e/19d/060f9e19dc4c86b006ed48e00c14b49c.jpg" width="800"><br><br>  You can perform only a specific task from the playbook: <br><pre> <code class="bash hljs">ansible-playbook playbooks/setup_nginx.yml --start-at-task=<span class="hljs-string"><span class="hljs-string">"Debug"</span></span></code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/3b7/800/628/3b780062849766b473bcdbb73160c627.jpg" width="800"><br><br><h4>  <b>Reuse in Playbook</b> </h4><br>  If a task or set of tasks is often used by you, it makes sense to arrange it as a separate file that can be used in other playbooks. <br><br>  Create a folder for reusable tasks: <br><pre> <code class="bash hljs">mkdir ~/ansible/playbooks/tasks</code> </pre><br>  Let's create an OS update task in the file ~ / ansible / playbooks / tasks / <b>os_update.yml</b> : <br><pre> <code class="xml hljs">--- #Update and upgrade apt-based linux - name: Update and upgrade apt-based Linux apt: update-cache=yes state=latest sudo: yes</code> </pre><br>  Now we can enable the OS update section in ~ / ansible / playbooks / <b>setup_nginx.yml</b> : <br><pre> <code class="xml hljs">--- - hosts: experiments remote_user: root tasks: - include: tasks/os_update.yml - name: Install nginx package apt: name=nginx update_cache=yes sudo: yes - name: Starting nginx service service: name=nginx state=started sudo: yes</code> </pre><br>  Now before installing nginx Ubuntu on the serviced servers from Inventory will be updated. <br>  It is worth setting up the nginx installation (~ / ansible / playbooks / tasks / <b>pkg_nginx_install.yml</b> ) to a separate task, if you often install nginx. <br><pre> <code class="xml hljs">--- #Install NGINX package - name: Install nginx package apt: name=nginx update_cache=yes sudo: yes - name: Starting nginx service service: name=nginx state=started sudo: yes</code> </pre><br>  As a result, our playbook will become quite simple: <br><pre> <code class="xml hljs">--- - hosts: experiments remote_user: root tasks: - include: tasks/os_update.yml - include: tasks/pkg_nginx_install.yml</code> </pre><br>  You can write a task to delete nginx (~ / ansible / tasks / <b>pkg_nginx_remove.yml</b> ): <br><pre> <code class="xml hljs">--- #Remove NGINX package - name: Stopping nginx service service: name=nginx state=stopped sudo: yes - name: Remove nginx package apt: name=nginx state=removed sudo: yes</code> </pre><br>  and call it (~ / ansible / playbooks / <b>remove_nginx.yml</b> ): <br><pre> <code class="xml hljs">--- - hosts: experiments remote_user: root tasks: - include: tasks/pkg_nginx_remove.yml</code> </pre><br><pre> <code class="bash hljs">ansible-playbook ~/ansible/playbooks/remove_nginx.yml -i ~/ansible/inventory</code> </pre><br>  where through -i we specify the path to the inventory file, which allows us to run the ansible-playbook not only from the ansible folder. <br><br>  In the next article we will talk about variables and Ansible conditions.  Finally, our playbook will work correctly on different operating systems. <br><br><h4>  Conclusion </h4><br>  The book " <a href="http://www.amazon.com/Learning-Ansible-Madhurranjan-Mohaan/dp/1783550635/ref%3Dsr_1_2%3Fie%3DUTF8%26qid%3D1422482924%26sr%3D8-2%26keywords%3Dansible">Learning Ansible</a> " and of course the <a href="http://docs.ansible.com/">official documentation</a> helped a lot in writing the article. <br><br>  It is convenient to do all experiments with Ansible in <a href="http://infoboxcloud.ru/">InfoboxCloud</a> , since there is an opportunity for each virtual server to set the exact amount of resources needed for the task (CPU / Ram / disk independently of each other) or to use autoscaling. <br><br>  If you find an error in the article, the author will gladly correct it.  Please write in the LAN or <a href="">in the mail</a> about it.  There you can also ask questions about Ansible for coverage in subsequent articles. <br><br>  <a href="http://habrahabr.ru/company/infobox/blog/252001/">Part 3: Variables and the inventory file</a> <br>  <a href="http://habrahabr.ru/company/infobox/blog/252239/">Part 4: working with modules</a> <br>  <a href="http://habrahabr.ru/company/infobox/blog/252461/">Part 5: local_action, conditions, cycles and roles</a> <br><br>  Successful work! </div><p>Source: <a href="https://habr.com/ru/post/250115/">https://habr.com/ru/post/250115/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../250103/index.html">How we prepare React, Require and Backbone</a></li>
<li><a href="../250105/index.html">Google Code-In 2014</a></li>
<li><a href="../250107/index.html">New research: excessive employee access rights to confidential information expose the company to risks and increase risks</a></li>
<li><a href="../250109/index.html">Why you need to update your SSL certificates</a></li>
<li><a href="../250113/index.html">IT spring in Minsk</a></li>
<li><a href="../250117/index.html">ANT +</a></li>
<li><a href="../250121/index.html">Books for "pumping" the brain</a></li>
<li><a href="../250123/index.html">PIC16F1503. Wheelbarrow for pumping - 1. Sound</a></li>
<li><a href="../250125/index.html">Trends 2015: 5 ways to put the API to serve the business</a></li>
<li><a href="../250127/index.html">Differentiation of information systems in the protection of personal data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>