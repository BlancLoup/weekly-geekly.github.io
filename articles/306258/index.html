<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using custom functions in OSSIM parsers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear! 
 In continuation of my article I want to review and share my experience with the ‚Äúcustom functions‚Äù functionality used in OSSIM. Thes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using custom functions in OSSIM parsers</h1><div class="post__text post__text-html js-mediator-article">  Good day, dear! <br>  In continuation of my <a href="https://habrahabr.ru/post/304374/">article</a> I want to review and share my experience with the ‚Äúcustom functions‚Äù functionality used in OSSIM.  These are functions that are intended for processing the information received as a result of parsing (logging) event logs.  Processing may consist in the resolution of the name by IP address, the definition of geolocation, and all that is enough imagination.  In the example below, I will analyze the use of ‚Äúcustom functions‚Äù for additional parsing of the information received. <a name="habracut"></a><br><br><h4>  <b>1. What is it for?</b> </h4><br>  Suppose that you retrieve event logs from the database (hereinafter - the database), as I described in the <a href="https://habrahabr.ru/post/304374/">article</a> .  And it so happened that in one of the database fields you have more than one value, for example, ‚Äúusername‚Äù or ‚ÄúIP address‚Äù, but the whole message line from which you need to select keywords (for example, the ‚Äúissued command: ls / root; result: ACCEPT ").  And you need to get the command text (ls / root) and the result of its execution (ACCEPT) from this line. <br>  Obviously, the standard functionality available for sources of event logs like ‚Äúmysql‚Äù cannot be done.  This is where the custom functions functionality comes to the rescue.  With its help from the received line we will be able to select pieces of information that interest us.  So let's get started. <br><br><h4>  <b>2. Task statement</b> </h4><br>  Based on the example from the <a href="https://habrahabr.ru/post/304374/">article,</a> it is necessary to select information about the command given (everything that follows ‚Äúcommand:‚Äù) and the result of its execution (everything that follows after ‚Äúresult:‚Äù) from the log line stored in the database in the field ‚Äúmessage‚Äù .  Write the command text in the ‚Äúuserdata3‚Äù field, and the result of the command in the ‚Äúuserdata4‚Äù field. <br>  An example of a database table: <br><pre><code class="bash hljs">+---------------------+----------+----------------------+----------+--------------------------------------------+ | date | event_id | event_type | username | message | +---------------------+----------+----------------------+----------+--------------------------------------------+ | 2016-07-22 17:17:05 | 283 | <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1 | net_adm | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:49 | 284 | suspicious activity | operator | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:50 | 285 | suspicious activity | admin | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:51 | 286 | suspicious activity | guest | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:52 | 287 | <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1 | unknown | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:53 | 288 | <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1 | valeriy | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:54 | 289 | suspicious activity | alex | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:55 | 290 | <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> 1 | cisco | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | | 2016-07-22 17:17:57 | 291 | suspicious activity | net_adm | issued <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: show arp; result: ACCEPT | +---------------------+----------+----------------------+----------+--------------------------------------------+</code> </pre> <br><h4>  <b>3. Decision</b> </h4><br>  To solve the problem will be performed: <br><ul><li>  creating a function to highlight information about the team; </li><li>  creating a function to highlight information about the result of the command; </li><li>  additional setting of the parser (previously created in the <a href="https://habrahabr.ru/post/304374/">example</a> ). </li></ul><br>  In order to use your own function in the OSSIM parser, you need to create a new file, for example: <br><pre> <code class="bash hljs">/usr/share/alienvault/ossim-agent/plugins/db_logs_func.cfg</code> </pre> <br>  And add functions to the file as: <br><pre> <code class="bash hljs">Start Function &lt; &gt; &lt; &gt; End Function</code> </pre> <br>  Functions are written in python. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  <b>3.1.</b>  <b>Creating a function to highlight information about the team</b> </h5><br>  I wrote the following function to extract information about the command given from the event text: <br><pre> <code class="bash hljs">def parse_command(input): res = re.search(r<span class="hljs-string"><span class="hljs-string">'command:.*;'</span></span>, input) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> (res.group(0).split(<span class="hljs-string"><span class="hljs-string">": "</span></span>)[1].strip(<span class="hljs-string"><span class="hljs-string">";"</span></span>))</code> </pre> <br>  As you can see, this function receives the necessary information using a regular expression (everything that is after "command:" and to the last ";". I say the last one because ";" may also be present in the command body and return it to the OSSIM agent for further processing by the parser. <br><br><h5>  <b>3.2.</b>  <b>Creating a function to highlight information about the result of the command</b> </h5><br>  Similarly, we write the second function and add it to the file: <br><pre> <code class="bash hljs">def parse_result(input): res = re.search(r<span class="hljs-string"><span class="hljs-string">'result:\s+\S+'</span></span>, input) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> (res.group(0).split(<span class="hljs-string"><span class="hljs-string">": "</span></span>)[1])</code> </pre> <br>  As a result, the file "/usr/share/alienvault/ossim-agent/plugins/db_logs_func.cfg" looks like: <br><pre> <code class="bash hljs">Start Function parse_command def parse_command(input): res = re.search(r<span class="hljs-string"><span class="hljs-string">'command:.*;'</span></span>, input) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> (res.group(0).split(<span class="hljs-string"><span class="hljs-string">": "</span></span>)[1].strip(<span class="hljs-string"><span class="hljs-string">";"</span></span>)) End Function Start Function parse_result def parse_result(input): res = re.search(r<span class="hljs-string"><span class="hljs-string">'result:\s+\S+'</span></span>, input) <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> (res.group(0).split(<span class="hljs-string"><span class="hljs-string">": "</span></span>)[1]) End Function</code> </pre> <br><h5>  <b>3.3.</b>  <b>Additional parser setting</b> </h5><br>  I will not dwell on the explanation of the entire configuration of the parser, since  This is already done earlier in the <a href="https://habrahabr.ru/post/304374/">example</a> . <br>  To notify the parser about the need to use the file with the created functions, add the following line to the [config] section of the parser configuration file: <br><pre> <code class="bash hljs">custom_functions_file=/etc/ossim/agent/plugin/db_logs_func.cfg</code> </pre> <br>  To use the created functions in the OSSIM parser, a configuration string of the following type is used: <br>  &lt;OSSIM field&gt; = {&lt;function name&gt; (&lt;parameter&gt;)} <br>  With this line we inform the OSSIM agent in which field of the OSSIM event description schema you need to place the information obtained by applying the function to the parameter.  And the parameter in our case is the information obtained from the database from the ‚Äúmessage‚Äù field, i.e.  event text ‚Äúissued command: show arp;  result: ACCEPT. <br>  The OSSIM fields in our example will be: userdata3, userdata4 <br>  Functions, respectively: "def parse_command" and "def parse_result" <br>  The parameter will be "$ 4" <br>  As a result, the lines that need to be added to the parser's configuration file look like this: <br><pre> <code class="bash hljs">userdata3={parse_command(<span class="hljs-variable"><span class="hljs-variable">$4</span></span>)} userdata4={parse_result(<span class="hljs-variable"><span class="hljs-variable">$4</span></span>)}</code> </pre> <br>  Below is the final fragment (query section) of the OSSIM parser configuration file: <br><pre> <code class="bash hljs">[query] query=<span class="hljs-string"><span class="hljs-string">"select event_id, date, event_type, username, message from data_table where event_id &gt; </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">;"</span></span> <span class="hljs-comment"><span class="hljs-comment">#order by event_id desc limit 1 regexp= ref=0 date={normalize_date($1)} plugin_sid={translate($2)} username={$3} userdata1={$4} userdata2={$2} userdata3={parse_command($4)} userdata4={parse_result($4)}</span></span></code> </pre> <br>  After performing these manipulations, you must restart the OSSIM agent: <br><pre> <code class="bash hljs">/etc/init.d/ossim-agent restart</code> </pre> <br>  After restarting, it will be useful to track the messages in the log file for errors (it has suddenly crept in somewhere): <br><pre> <code class="bash hljs">tail -f /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/alienvault/agent/agent.log|grep ERROR</code> </pre> <br>  If everything is done correctly, then in the graphical user interface OSSIM you can see the analysis of the event.  Approximately the same as in Figure 1. <br><img src="https://habrastorage.org/files/bad/426/4dd/bad4264ddee5442380c437be6f750e6d.jpg"><br>  <b>Figure 1</b> - Disassembled events in the OSSIM interface <br><br><h4>  <b>4. Improvement</b> </h4><br>  Here I would like to say that my first thought was to try to pass two parameters to a function in order to record different parts from the source text in the fields userdata3 and userdata4. <br>  For example, passing (text, 1) to receive a command, and (text, 2) - respectively, the result.  This decision seems to me the most elegant. <br>  I even wrote a function for this that works out if you run it on the server command line.  But the OSSIM agent does not want to take two parameters, only one. <br>  I turned to alienvault with this question, but so far I have not received an answer.  If anyone has thoughts on this topic, please write in a personal or comments. <br>  Thank you in advance! </div><p>Source: <a href="https://habr.com/ru/post/306258/">https://habr.com/ru/post/306258/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../306248/index.html">Greedy download in Yii2, for those who want to understand what it is</a></li>
<li><a href="../306250/index.html">Who was Ramanujan?</a></li>
<li><a href="../306252/index.html">Efficient caching. From theory to practice</a></li>
<li><a href="../306254/index.html">Visit 4 data centers per day and do not regret the time spent</a></li>
<li><a href="../306256/index.html">Prospects for native advertising in Russia and the world</a></li>
<li><a href="../306260/index.html">On the role of DevOps in IT - expert opinions</a></li>
<li><a href="../306266/index.html">RuHaxe 5 Online Conference</a></li>
<li><a href="../306272/index.html">Monitoring projects using the messenger on the example of Nagios and Telegram, with the analysis of fakapov from the life of Highload 24x7</a></li>
<li><a href="../306276/index.html">Simple Dependency Injection in Node.js</a></li>
<li><a href="../306278/index.html">A library that facilitates the development of forms on sites (v3)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>