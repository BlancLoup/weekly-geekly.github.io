<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Winning Kinect on Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second article in a series on developing C ++ applications that work with Microsoft Kinect. This part will discuss how to make a device wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Winning Kinect on Linux</h1><div class="post__text post__text-html js-mediator-article">  This is the second article in a series on developing C ++ applications that work with Microsoft Kinect.  This part will discuss how to make a device work in Linux and how it can be used in your applications. <br><br>  The first article on Kinect development can be read <a href="http://habrahabr.ru/blogs/cpp/123588/">here</a> .  I strongly recommend reading the first part, for without it the impressions of the second will be incomplete. <br><a name="habracut"></a><br><br><h2>  Introduction </h2><br>  As already mentioned in the first article, in addition to the official Microsoft SDK, there are several other third-party libraries: <br><ul><li>  <a href="http://openkinect.org/">OpenKinect project (libfreenect)</a> </li><li>  <a href="http://www.openni.org/">OpenNI project</a> </li><li>  <a href="http://codelaboratories.com/nui">CL NUI Project from the NUI Group</a> </li></ul><br>  Alternative SDK, unlike the official, can be used for development under Linux and Mac OS. <br>  The easiest to use is libfreenect (OpenNI, compiled and installed according to official documentation for me, for example, did not want to work in the latest Ubuntu, it is quite possible that the driver for Kinect requires an unstable version of the OpenNI platform, and an unstable is so unstable) .  Everything that is said in the <a href="http://openkinect.org/wiki/Getting_Started">official documentation</a> is true and yes, it works. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Install libfreenect </h2><br>  It is gratifying that for Ubuntu libfreenect is available as binary packages.  This allows you to save a lot of time during installation - no need to collect and configure anything, just install the dependencies and the library itself.  Examples work out of the box. <br>  But the Indians are not looking for easy ways and therefore we will consider the process of building a library from source.  What is good this way?  That allows you to get the source code of the examples that come with the library, and figure out what's what, and also, if necessary, experiment with the source code of the examples or debug if you have questions about how this all works from the inside. <br>  So the build process: <br><blockquote><code><a href=""></a> <font color="black">sudo apt-get install git-core cmake libglut3-dev pkg-config build-essential libxmu-dev libxi-dev libusb-1.0-0-dev <br> git clone github.com/OpenKinect/libfreenect.git <br> cd libfreenect <br> mkdir build <br> cd build <br> cmake .. <br> make <br> sudo make install <br> sudo ldconfig /usr/local/lib/ <br> sudo glview <br></font></code> </blockquote><br>  For Ubuntu x64, the last line will be <code>/usr/local/lib64/</code> . <br>  After that, you can drive on the build / bin folder - they illustrate quite well the library's capabilities. <br><br><h2>  Installing wxWidgets on Linux </h2><br>  Binary packages are also available for wxWidgets in Ubuntu (but only for the stable 2.8.x branch, which, however, is quite enough for work).  Install the <b>libwxgtk2.8-dev</b> package and the issue is resolved. <br><br><h2>  How not to do one job twice </h2><br>  Qt had a good motto: <a href="http://en.wikipedia.org/wiki/Write_once,_run_anywhere">Write Once, Run Anywhere</a> .  It would be nice to organize the same, but with wxWidgets.  But the situation is such that in addition to the source code, we still have project files (after the first part we got projects from Visual Studio, but there‚Äôs little use in Linux) and before writing the platform-specific part of the code for the new OS, it would be nice automate the creation and customization of project files.  This will help us utility <a href="http://cmake.org/">CMake</a> . <br>  What is CMake good for?  First, Linux is all different.  If some thirdparty library on your machine is on the same path, then it‚Äôs not a fact that all your colleagues or users will have it there.  Even when using the pkg-config output, in the case of changing some of the build parameters, there will be a lot of places in projects written by hand where new parameters will have to be written by hand.  By automating all this minor work through CMake, which creates project files already configured for a specific working machine, we can also save a lot of time. <br>  With Windows, the story is the same - why prescribe all parameters with your hands if CMake itself can search for a fairly large number of different libraries, if they are installed in the system, and then generate projects with already configured parameters. <br>  In addition to actually generating projects, in the script for CMake, you can specify conditional parameters for each platform, for example, include / exclude some files in a project for a particular OS, add or remove dependencies on thirdparty libraries specific for a particular OS, etc. <br>  In any case, the topic of using CMake is worthy of a separate article.  In our case, in order not to overload the text with listings of CMake scripts, I will provide links to them in the repository: <br><ul><li>  <a href="http://code.google.com/p/wxkinecthelper/source/browse/trunk/build/CMakeLists.txt">The main script, which contains general settings and a list of projects in the solution.</a> </li><li>  <a href="http://code.google.com/p/wxkinecthelper/source/browse/trunk/wxKinectHelper/CMakeLists.txt">Script to create a static library wxKinectHelper</a> </li><li>  <a href="http://code.google.com/p/wxkinecthelper/source/browse/trunk/KinectTest/CMakeLists.txt">Script for creating a test application project</a> </li></ul><br>  Let's summarize what we got from last time: <br><ul><li>  The solution is divided into two projects: the wxKinectHelper static library and the KinectTest test application. </li><li>  Project files (Visual Studio for Windows and Makefile / CodeBlocks for Linux) are generated using the CMake utility. </li><li>  In the wxKinectHelper project, there is a wxKinectHelper class that can return the number of Kinect devices in the system, give the device name by its index, and also create a grabber class </li><li>  The grabber class can capture images (depth, color) from the camera of the device, as well as get the position of players </li><li>  When you receive a new frame or information about the position of the players, an event is triggered to which you can subscribe, for example, the form class </li><li>  For drawing players, the wxKinectHelper class is used, which uses a separate implementation class for each platform, thereby implementing the <a href="http://en.wikipedia.org/wiki/Bridge_pattern">bridge</a> pattern. </li><li>  The test application consists of one form and can display a list of devices, a picture from the depth sensor, a color picture from the camera, and the position of the players </li></ul><br>  Well, remember everything, now you can move on to conquering libfreenect under Linux. <br><br><h2>  Coding </h2><br><br><h3>  Library initialization and deinitialization </h3><br>  Before you start using the API to access Kinect devices, you must call the <code>freenect_init()</code> method and pass the variable address as a parameter to it, which will contain the pointer to the initialized library context, in case of successful completion of the function. <br><blockquote> <code><font color="black">FREENECTAPI <font color="#0000ff">int</font> freenect_init( <br> freenect_context **ctx, <br> freenect_usb_context *usb_ctx);</font></code> </blockquote> <br>  After completing work with devices, it is necessary to deinitialize the library context using the <code>freenect_shutdown()</code> function: <br><blockquote> <code><font color="black">FREENECTAPI <font color="#0000ff">int</font> freenect_shutdown(freenect_context *ctx);</font></code> </blockquote> <br>  In our wrapper library, the initialization and deinitialization of the library context is handled by the <code>wxKinectHelper</code> class, for which, after switching to Linux, it was also necessary to implement the implementation classes separately for work on Windows and Linux. <br><br><h3>  Getting a list of devices </h3><br>  To get the number of available devices in libfreenect, use the <code>freenect_num_devices()</code> function: <br><blockquote> <code><font color="black">FREENECTAPI <font color="#0000ff">int</font> freenect_num_devices(freenect_context *ctx);</font></code> </blockquote> <br>  Unfortunately, libfreenect does not contain an API to get the unique name of a separate device, therefore, in order to somehow identify the devices in our application, we will have to come up with a workaround, for example, to produce some string value containing the device index, for example: <br><blockquote> <code><font color="black">wxString KinectHelperImplFreenect::GetDeviceName(size_t index) <br> { <br> wxString name = wxT( <font color="#A31515">"Unknown Kinect Sensor"</font> ); <br> <font color="#0000ff">if</font> (m_Context) <br> { <br> name = wxString::Format(wxT( <font color="#A31515">"Kinect %u"</font> ), index); <br> } <br> <font color="#0000ff">return</font> name; <br> }</font></code> </blockquote> <br><br><h3>  Image Capture with Kinect </h3><br>  There are two ways to capture images from Kinect in the libfreenect library - using the synchronous or asynchronous API variant.  In the case of the asynchronous variant, when a new frame arrives, the callback function will be called, in which the incoming buffer can be processed.  The memory for the buffer can be allocated independently or the library itself can take care of creating an internal buffer and clearing the memory upon completion. <br><br>  To start capturing images, you must call the function <code>freenect_open_device()</code> , which takes as parameters: <br><ul><li>  Pointer to library context </li><li>  Pointer to a variable that will contain the device context, in case of successful completion of the function </li><li>  device index </li></ul><br><blockquote> <code><font color="black">FREENECTAPI <font color="#0000ff">int</font> freenect_open_device( <br> freenect_context *ctx, <br> freenect_device **dev, <font color="#0000ff">int</font> index);</font></code> </blockquote> <br>  To complete the image capture, call the <code>freenect_close_device()</code> function. <br><blockquote> <code><font color="black">FREENECTAPI <font color="#0000ff">int</font> freenect_close_device(freenect_device *dev);</font></code> </blockquote> <br>  Although the API is ‚Äúasynchronous‚Äù, it‚Äôs still impossible to do without creating a control flow manually.  From time to time, you need to call the <code>freenect_process_events()</code> function, which will handle the event queue from libusb.  In a wxWidgets application, an event flow can be organized like this: <br><blockquote> <code><font color="black">wxThread::ExitCode KinectGrabberFreenect::Entry() <br> { <br> <font color="#0000ff">int</font> status(0); <br> <font color="#0000ff">while</font> (!GetThread()-&gt;TestDestroy() &amp;&amp; status &gt;= 0) <br> { <br> status = freenect_process_events(m_Context); <br> } <br> <font color="#0000ff">return</font> NULL; <br> }</font></code> </blockquote> <br><h4>  Getting depth buffer </h4><br>  In order to start receiving frames with a depth buffer, you need to call several functions that configure the device operation mode: <br><ul><li>  Using <code>freenect_set_depth_callback()</code> you can set a function that will be called when a new frame arrives with a depth buffer. </li><li>  Using <code>freenect_set_depth_buffer()</code> you can set a memory area in which libfreenect will write depth data from the device (this is an optional step, but using this function can be convenient if some post-processing is required) </li><li>  Using the <code>freenect_set_depth_mode()</code> function, you need to set the device operation mode.  The parameters of this function are passed to the freenect_frame_mode structure, which contains information about the desired image size and data format. </li></ul><br>  The freenect_resolution values ‚Äã‚Äãcan be: <br><blockquote> <code><font color="black">typedef <font color="#0000ff">enum</font> { <br> FREENECT_RESOLUTION_LOW  = 0, <font color="#008000">/**&lt; QVGA - 320x240 */</font> <br> FREENECT_RESOLUTION_MEDIUM = 1, <font color="#008000">/**&lt; VGA - 640x480 */</font> <br> FREENECT_RESOLUTION_HIGH  = 2, <font color="#008000">/**&lt; SXGA - 1280x1024 */</font> <br> FREENECT_RESOLUTION_DUMMY = 2147483647, <font color="#008000">/**&lt; Dummy value to force enum to be 32 bits wide */</font> <br> } freenect_resolution;</font></code> </blockquote> <br>  And freenect_depth_format are as follows: <br><blockquote> <code><font color="black">typedef <font color="#0000ff">enum</font> { <br> FREENECT_DEPTH_11BIT    = 0, <font color="#008000">/**&lt; 11 bit depth information in one uint16_t/pixel */</font> <br> FREENECT_DEPTH_10BIT    = 1, <font color="#008000">/**&lt; 10 bit depth information in one uint16_t/pixel */</font> <br> FREENECT_DEPTH_11BIT_PACKED = 2, <font color="#008000">/**&lt; 11 bit packed depth information */</font> <br> FREENECT_DEPTH_10BIT_PACKED = 3, <font color="#008000">/**&lt; 10 bit packed depth information */</font> <br> FREENECT_DEPTH_DUMMY    = 2147483647, <font color="#008000">/**&lt; Dummy value to force enum to be 32 bits wide */</font> <br> } freenect_depth_format;</font></code> </blockquote> <br>  As can be seen from the description, in libfreenect, in contrast to the official SDK from Microsoft, only 11 bits are used for the depth value, not 12. There is also no possibility of getting a player index. <br><br><h4>  Getting a color image </h4><br>  In principle, the device configuration algorithm for obtaining a color image is similar to the algorithm when obtaining the depth buffer, only the functions <code>freenect_set_video_callback()</code> , <code>freenect_set_video_buffer()</code> and <code>freenect_set_video_mode()</code> are used, respectively. <br><br><h4>  Some more general information about capturing images </h4><br>  After all the above, let's look at the image capture initialization code: <br><blockquote> <code><font color="black"><font color="#0000ff">if</font> (freenect_open_device(m_Context, &amp;m_Device, <br> ( <font color="#0000ff">int</font> )m_DeviceIndex) &lt; 0) <font color="#0000ff">break</font> ; <br> <br> freenect_set_depth_callback(m_Device, KinectGrabberFreenect::DepthCallback); <br> freenect_set_video_callback(m_Device, KinectGrabberFreenect::VideoCallback); <br> freenect_set_video_mode(m_Device, m_VideoMode); <br> freenect_set_depth_mode(m_Device, m_DepthMode); <br> m_VideoBufferLength = m_VideoMode.bytes; <br> m_DepthBufferLength = m_DepthFrameSize.GetWidth() * m_DepthFrameSize.GetHeight() * 3; <br> m_VideoBuffer = <font color="#0000ff">new</font> unsigned <font color="#0000ff">char</font> [m_VideoBufferLength]; <br> m_DepthBufferIndex = 0; <br> m_GotDepth = <font color="#0000ff">false</font> ; <br> m_DepthBuffers[0] = <font color="#0000ff">new</font> unsigned <font color="#0000ff">char</font> [ <br> m_DepthFrameSize.GetWidth() * <br> m_DepthFrameSize.GetHeight() * 3]; <br> m_DepthBuffers[1] = <font color="#0000ff">new</font> unsigned <font color="#0000ff">char</font> [ <br> m_DepthFrameSize.GetWidth() * <br> m_DepthFrameSize.GetHeight() * 3]; <br> freenect_set_video_buffer(m_Device, m_VideoBuffer); <br> DeviceHash[m_Device] = <font color="#0000ff">this</font> ; <br> freenect_start_video(m_Device); <br> freenect_start_depth(m_Device);</font></code> </blockquote> <br>  Because  the data format for the depth buffer is slightly different, and the function of converting the depth value to grayscale has also changed a bit: <br><blockquote> <code><font color="black">unsigned <font color="#0000ff">char</font> KinectGrabberFreenect::GetDepthValue(unsigned <font color="#0000ff">short</font> data) <br> { <br> <font color="#008000">// 0x7ff is 0000011111111111 in binary format - max value for 11bit depth;</font> <br> <font color="#0000ff">return</font> ( <font color="#0000ff">double</font> )255 * ( <font color="#0000ff">double</font> )data / ( <font color="#0000ff">double</font> )0x7ff; <br> }</font></code> </blockquote> <br>  As a result of all the actions described, a new grabber class was created, which works quite well in Linux.  Unfortunately, there is no API in libfreenect to get the position of players, for this purpose you will have to use third-party (or your own) developments, for example, based on OpenCV.  But the fact that there is enough for recognition, for example, movement. <br><br><img src="https://habrastorage.org/storage1/4a32a0f0/1e650449/1528df9e/f2a174de.png"><br><br><h2>  In conclusion </h2><br>  I think we‚Äôll finish this with theory.  The next part will be practice. <br>  I remind once again that all the source code of the sample and the wrapper library for working with Kinect can be downloaded <a href="http://code.google.com/p/wxkinecthelper/">here</a> . <br>  You can generate project files for Windows using the <b>build / cm.bat script</b> , for Linux, <b>build / cmLinux.sh</b> <br>  Also, I will not refuse to help taming OpenNI for Linux and Mac OS. </div><p>Source: <a href="https://habr.com/ru/post/124009/">https://habr.com/ru/post/124009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../124003/index.html">Plantronics BackBeat 903+ Overview</a></li>
<li><a href="../124004/index.html">Iap packaged by google</a></li>
<li><a href="../124005/index.html">How MTS provoked spam on Vkontakte</a></li>
<li><a href="../124006/index.html">New Android Market</a></li>
<li><a href="../124007/index.html">NeoAxis Game Engine 1.0 finally saw the light</a></li>
<li><a href="../124010/index.html">Mailing lists: choose - software or service</a></li>
<li><a href="../124011/index.html">Writers ask Yandex to remove pirated content from search results.</a></li>
<li><a href="../124012/index.html">Winners of the Second Programming Contest CUBRID it!</a></li>
<li><a href="../124018/index.html">Are you building a project? Get the prize!</a></li>
<li><a href="../124021/index.html">vSphere 5 - admin notes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>