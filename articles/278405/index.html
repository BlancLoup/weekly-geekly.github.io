<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating applications for Firebird with the use of various components and drivers: ADO.NET Entity Framework 6</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article will describe the process of creating applications for the Firebird database using the Entity Framework access components and the Visual ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating applications for Firebird with the use of various components and drivers: ADO.NET Entity Framework 6</h1><div class="post__text post__text-html js-mediator-article">  This article will describe the process of creating applications for the Firebird database using the Entity Framework access components and the Visual Studio 2015 environment. <br><br>  <b>The ADO.NET Entity Framework (EF)</b> , an object-oriented data access technology, is an object-relational mapping (ORM) solution for Microsoft's .NET Framework.  Provides the ability to interact with objects both through LINQ in the form of LINQ to Entities, and using Entity SQL. <br><br>  Entity Framework suggests three possible ways to interact with the database: <br><ul><li>  <b>Database first</b> : The Entity Framework creates a set of classes that reflect the model of a particular database. </li><li>  <b>Model first</b> : first, the developer creates a database model, by which the Entity Framework then creates a real database on the server. </li><li>  <b>Code first</b> : the developer creates a data model class that will be stored in the database, and then the Entity Framework generates a database and its tables using this model </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In our application, we will use the Code First approach, but you can easily use other approaches. <br><br>  Our application will work with the database, the model of which is shown in the figure below. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/aeb/2c3/d3f/aeb2c3d3fec4439dbf6217fce6efb2d4.png"></div><br><br><table><tbody><tr><td>  <b>Attention!</b> <br><br>  This model is just an example.  Your subject area may be more complicated, or completely different.  The model used in this article is simplified as much as possible in order not to clutter up the description of working with components with the description of creating and modifying the data model. <br></td></tr></tbody></table><a name="habracut"></a><br><br><h2>  Preparing Visual Studio 2015 to work with Firebird </h2><br>  To work with Firebird you need to install: <br><ul><li>  FirebirdSql.Data.FirebirdClient.dll </li><li>  EntityFramework.Firebird.dll </li><li>  DDEX Provider for Visual Studio </li></ul><br><br>  Installing the first two does not cause any difficulties.  They are currently distributed and installed into the project using NuGet.  But the latest library, designed for the work of the Visual Studio wizards, is not easily installed and can spend a lot of time and effort. <br><br>  Good people tried to automate the installation process and include the installation of all components in one <a href="http://sourceforge.net/projects/firebird-4-8-0-ddex-installer/">distribution</a> .  However, in some cases you may need to manually install all the components.  In this case, you will need to download: <br><ul><li>  <a href="http://sourceforge.net/projects/firebird/files/firebird-net-provider/4.10.0.0/FirebirdSql.Data.FirebirdClient-4.10.0.0.msi/download">FirebirdSql.Data.FirebirdClient-4.10.0.0.msi</a> </li><li>  <a href="http://sourceforge.net/projects/firebird/files/firebird-net-provider/4.10.0.0/EntityFramework.Firebird-4.10.0.0-NET45.7z/download">EntityFramework.Firebird-4.10.0.0-NET45.7z</a> </li><li>  <a href="http://sourceforge.net/projects/firebird/files/firebird-net-provider/DDEX%25203.0.2/DDEXProvider-3.0.2.0.7z/download">DDEXProvider-3.0.2.0.7z</a> </li><li>  <a href="http://sourceforge.net/projects/firebird/files/firebird-net-provider/DDEX%25203.0.2/DDEXProvider-3.0.2.0-src.7z/download">DDEXProvider-3.0.2.0-src.7z</a> </li></ul><br><br>  The following describes the installation process: <br><br><ol><li>  Install FirebirdSql.Data.FirebirdClient-4.10.0.0.msi </li><li>  Extract the EntityFramework.Firebird-4.10.0.0-NET45.7z to the folder with the installed Firebird client.  I have a folder c: \ Program Files (x86) \ FirebirdClient \ <br><table><tbody><tr><td>  <b>Important!</b> <br><br>  This must be done with administrator rights.  Like other actions with protected directories. <br></td></tr></tbody></table><br></li><li>  You need to install the Firebird builds in the GAC.  For convenience, write to% PATH% path to the gacutil utility for .NET Framework 4.5.  I have this path c: \ Program Files (x86) \ Microsoft SDKs \ Windows \ v10.0A \ bin \ NETFX 4.6.1 Tools \ </li><li> Run the cmd command line on behalf of the administrator and go to the directory with the installed client. <br> <code>chdir "c:\Program Files (x86)\FirebirdClient" <br></code> <br></li><li>  Now we check that FirebirdSql.Data.FirebirdClient is installed in the GAC.  To do this, type the command <br> <code>gacutil /l FirebirdSql.Data.FirebirdClient <br> Microsoft (R) .NET Global Assembly Cache Utility. Version 4.0.30319.0 <br> c   (Microsoft Corporation).   . <br> <br>       : <br> FirebirdSql.Data.FirebirdClient, Version=4.10.0.0, Culture=neutral, PublicKeyToken=3750abcc3150b00c, processorArchitecture=MSIL <br> <br>   = 1 <br></code> <br>  If FirebirdSql.Data.FirebirdClient was not installed in the GAC, then do it with the command <br> <code>gacutil /i FirebirdSql.Data.FirebirdClient.dll <br></code> <br></li><li>  Now install the EntityFramework.Firebird in the GAC <br> <code>gacutil /i EntityFramework.Firebird.dll <br></code> <br></li><li>  Unpacking DDEXProvider-3.0.2.0.7z into a convenient directory.  I unpacked it in c: \ Program Files (x86) \ FirebirdDDEX \ </li><li>  There we unpack DDEXProvider-3.0.2.0-src.7z contents of the archive / reg_files / VS2015 subdirectory of the archive <br><table><tbody><tr><td>  <b>Author's note</b> <br><br>  It's funny, but for some reason these files are not in the previous archive with compiled dll libraries, but they are present in the archive with source codes. <br></td></tr></tbody></table><br></li><li>  Open the FirebirdDDEXProvider64.reg file with notepad.  Find the line that contains% path% and change it to the full path to the FirebirdSql.VisualStudio.DataTools.dll file <br><br>  "CodeBase" = "c: \\ Program Files (x86) \\ FirebirdDDEX \\ FirebirdSql.VisualStudio.DataTools.dll" <br></li><li>  Save this file, run it.  At the request to add information to the registry, click YES. </li><li>  Now you need to edit the machine.config file, in my case it is located along the path: C: \ Windows \ Microsoft .NET \ Framework \ v4.0.30319 \ Config <br>  Open this file with notepad.  Find a section <br> <code>&lt;system.data&gt; <br> &lt;DbProviderFactories&gt; <br></code> <br>  Add a line to this section: <br> <code>&lt;add name="FirebirdClient Data Provider" invariant="FirebirdSql.Data.FirebirdClient" description=".Net Framework Data Provider for Firebird" type="FirebirdSql.Data.FirebirdClient.FirebirdClientFactory, FirebirdSql.Data.FirebirdClient, Version=4.10.0.0, Culture=neutral, PublicKeyToken=3750abcc3150b00c" /&gt; <br></code> <br><table><tbody><tr><td>  <b>Comment</b> <br>  All this is valid for version 4.10.0. <br></td></tr></tbody></table><br>  Do the same for machine.config.  which is located in c: \ Windows \ Microsoft .NET \ Framework64 \ v4.0.30319 \ Config \ <br></li></ol><br>  Installation is complete. <br><br>  To verify that everything was successfully installed, we launch Visual Studio 2015. We find the server browser and try to connect to one of the existing Firebird databases. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1d1/fb2/6e8/1d1fb26e87534530961406e38fa352a8.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/91d/a19/d2b/91da19d2bb504f019280e9c29d52f86d.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/32e/e2c/ded/32ee2cdede7c4a49af43337dddecd78d.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/7c0/4b9/8b1/7c04b98b158c4abdaedd7d82f745abad.png"></div><br><br><h2>  Project creation </h2><br><br>  In this article we will look at an example of creating a Windows Forms application.  The other types of applications are different, but the principles of working with Firebird through the Entity Framework remain the same. <br><br>  First of all, after creating the Windows Forms project, we need to add the following packages using the NuGet package manager: <br><ul><li>  FirebirdSql.Data.FirebirdClient </li><li>  EntityFramework </li><li>  EntityFramework.Firebird </li></ul><br><br>  To do this, right-click on the project name in the Solution Explorer and select the ‚ÄúNuGet Package Management‚Äù item in the drop-down menu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e3b/05f/b46/e3b05fb469864521988eadf073e47d72.png"></div><br><br>  In the package manager that appears, search for and install the required packages. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f4a/79d/24d/f4a79d24dc3e48be9b75d8766456c04d.png"></div><br><br><h2>  Creating an EDM model </h2><br>  In our application, we will use the Code First approach. <br><br>  To create an EDM model, right-click the project name in the Solution Explorer and select the menu item Add -&gt; Create Item. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cb3/3ca/664/cb33ca664d2749b291c79e684d01dafb.png"></div><br><br>  Next, in the Add New Item Wizard, select the ‚ÄúADO.NET EDM Model‚Äù item. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/26a/cd8/70e/26acd870e8694e3a97cd9eb5a36bbcc0.png"></div><br><br>  Since we already have a database (see <a href="https://habrahabr.ru/post/273549/">Creating Applications for Firebird DBMS Using Different Components and Drivers: FireDac</a> ), we will generate an EDM model from the database. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/36c/799/54d/36c79954d3c1445c9591bd7e55d226d0.png"></div><br><br>  Now you need to select the connection from which the model will be created.  If there is no such connection, then it must be created. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/53a/eb3/44b/53aeb344b7e04beea02460abb2fe62ab.png"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/def/8d8/105/def8d8105a6a4045b316f6f8086dd9b5.png"></div><br><br>  In addition to the basic connection parameters, you may also need to specify a number of additional parameters, for example, the isolation level of transactions (the default is Read Commited), connection pooling, etc. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/af3/02f/226/af302f22646b4dadae6edc09a347d4c1.png"></div><br><br>  In the process of creating a model wizard, you will be asked how to store the connection string. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d6b/422/3d9/d6b4223d94934d4ab0ffe4ca9e6924a2.png"></div><br><br>  If you are building a web application or a three-server system, where all users will work with the database under the same account, then feel free to choose ‚ÄúYes‚Äù.  If your application needs to ask for credentials to connect to the database, select "No".  However, it is much more convenient to work with masters when you have selected ‚ÄúYes‚Äù.  You can always change this in the finished application by simply editing the connection string in the application configuration file .exe.conf.  The connection string will be saved in the <b>connectionStrings</b> section approximately as follows. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DbModel"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">connectionString</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"character set=UTF8; data source=localhost;initial catalog=examples; port number=3050; user id=sysdba; dialect=3; isolationlevel=Snapshot; pooling=True; password=masterkey;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">providerName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FirebirdSql.Data.FirebirdClient"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  To stop the configuration file from storing confidential information, simply delete it from the connection string. <br><pre> <code class="xml hljs">password=masterkey;</code> </pre> <br><br><table><tbody><tr><td>  <b>A note about working with Firebird 3.0</b> <br><br>  Unfortunately, the current ADO .Net provider for Firebird (version 4.10.0) does not support SRP authentication (by default in Firebird 3.0).  Therefore, if you want to work with Firebird 3.0, then you need to change some settings in firebird.conf (or in databases.conf for a specific database) in order for Firebird to work through Legacy_Auth.  To do this, change the following settings: <br> <code>UserManager = Legacy_UserManager <br> WireCrypt = Disabled <br> AuthServer = Legacy_Auth, Srp, WinSspi <br></code> <br>  Save settings.  After that, you need to create a SYSDBA user and other users using Legacy_UserManager. <br></td></tr></tbody></table><br><br>  You will then be asked which tables and views should be included in the model. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/31c/2b7/769/31c2b77697e642d6bf5882bb25a04081.png"></div><br><br>  In principle, the EDM model is ready.  After running this wizard, you should have 5 new files.  One model file and four files describing each of the model entities. <br><br>  Let's see one of the generated files describing the essence of INVOICE. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Table(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Firebird.INVOICE"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">INVOICE</span></span> { [System.Diagnostics.CodeAnalysis.SuppressMessage(<span class="hljs-string"><span class="hljs-string">"Microsoft.Usage"</span></span>, <span class="hljs-string"><span class="hljs-string">"CA2214:DoNotCallOverridableMethodsInConstructors"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">INVOICE</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { INVOICE_LINES = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;INVOICE_LINE&gt;(); } [Key] [DatabaseGenerated(DatabaseGeneratedOption.None)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> INVOICE_ID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CUSTOMER_ID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime? INVOICE_DATE { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>? TOTAL_SALE { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> PAID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> CUSTOMER CUSTOMER { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [System.Diagnostics.CodeAnalysis.SuppressMessage(<span class="hljs-string"><span class="hljs-string">"Microsoft.Usage"</span></span>, <span class="hljs-string"><span class="hljs-string">"CA2227:CollectionPropertiesShouldBeReadOnly"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;INVOICE_LINE&gt; INVOICE_LINES { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><br>  The class contains properties that display the fields of the INVOICE table.  Each of these properties is provided with attributes that describe the constraints.  You can read more about various attributes in the Microsoft documentation for <a href="https://msdn.microsoft.com/en-us/data/jj591583">Code First Data Annotations</a> . <br><br>  In addition, two more navigation properties CUSTOMER and INVOICE_LINES were generated.  The first contains a link to the supplier‚Äôs entity, the second a collection of invoice lines.  It was generated because the INVOICE_LINE table has a foreign key to the INVOICE table.  Of course, you can remove this property from the INVOICE entity, but this is not necessarily done.  The fact is that in this case the properties CUSTOMER and INVOICE_LINES use the so-called ‚Äúlazy loading‚Äù.  With this, loading is performed at the first access to the object, i.e.  if the associated data is not needed, they are not loaded.  However, when you first access the navigation property, this data is automatically loaded from the database. <br><br>  When using lazy loading, some points should be kept in mind when declaring classes.  So, classes using lazy loading should be public, and their properties should have <b>public</b> and <b>virtual</b> modifiers. <br><br>  In the same class, we will have the first unpleasant surprise.  The TOTAL_SALE field was essentially displayed as double, although in the database it is of type NUMERIC (15, 2), so we have a loss of precision.  I tend to regard this as a bug in the Firebird ADO.NET Provider.  Let's try to fix this annoying mistake.  In C #, there is a decimal type for operations on fixed-precision numbers. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> TOTAL_SALE { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br><br>  In addition, we will change the description of all fields in all entities where the type Firebird NUMERIC (x, y) is used.  Namely PRODUCT.PRICE, INVOICE_LINE.QUANTITY, INVOICE_LINE.SALE_PRICE. <br><br>  Now open the DbModel.cs file describing the model as a whole. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbModel</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbModel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"name=DbModel"</span></span></span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> DbSet&lt;CUSTOMER&gt; CUSTOMERS { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> DbSet&lt;INVOICE&gt; INVOICES { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> DbSet&lt;INVOICE_LINE&gt; INVOICE_LINES { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> DbSet&lt;PRODUCT&gt; PRODUCTS { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Entity&lt;CUSTOMER&gt;() .Property(e =&gt; e.ZIPCODE) .IsFixedLength(); modelBuilder.Entity&lt;CUSTOMER&gt;() .HasMany(e =&gt; e.INVOICES) .WithRequired(e =&gt; e.CUSTOMER) .WillCascadeOnDelete(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); modelBuilder.Entity&lt;PRODUCT&gt;() .HasMany(e =&gt; e.INVOICE_LINES) .WithRequired(e =&gt; e.PRODUCT) .WillCascadeOnDelete(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); modelBuilder.Entity&lt;INVOICE&gt;() .HasMany(e =&gt; e.INVOICE_LINES) .WithRequired(e =&gt; e.INVOICE) .WillCascadeOnDelete(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } }</code> </pre><br><br>  Here we see the properties describing the data set for each entity.  As well as setting additional properties for creating a model using the Fluent API.  A full description of the Fluent API can be found in the Microsoft <a href="https://msdn.microsoft.com/en-us/data/jj591617.aspx">Configuring / Mapping Properties and Types with the Fluent API</a> documentation. <br><br>  In the OnModelCreating method, we set the accuracy for decimal properties using the Fluent API.  To do this, we add the following lines <br><br><pre> <code class="cs hljs"> modelBuilder.Entity&lt;PRODUCT&gt;() .Property(p =&gt; p.PRICE) .HasPrecision(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); modelBuilder.Entity&lt;INVOICE&gt;() .Property(p =&gt; p.TOTAL_SALE) .HasPrecision(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); modelBuilder.Entity&lt;INVOICE_LINE&gt;() .Property(p =&gt; p.SALE_PRICE) .HasPrecision(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); modelBuilder.Entity&lt;INVOICE_LINE&gt;() .Property(p =&gt; p.QUANTITY) .HasPrecision(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br><br><h2>  Creating user interface </h2><br>  In our application, we will create two directories: a reference book of goods and a reference book of customers.  Each directory contains a DataGridView grid, a panel with ToolStrip buttons, and a BindingSource component, which is used to simplify data binding to form controls. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/42e/a76/167/42ea7616734e4a0abac048cc95b002a8.png"></div><br><br>  Since both reference books are similar in functionality and implemented in a similar way, we will describe only one. <br><br><h3>  Getting context </h3><br>  To work with our model, we need a method to get the context (or model).  In principle, it‚Äôs enough to do this: <br><br><pre> <code class="cs hljs">DbModel dbContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbModel();</code> </pre> <br><br>  However, if the connection string does not store sensitive data (for example, a password), and we initialize it during the application startup, we will need a special method for storing and restoring the connection string or saving the previously created context.  To do this, we will create a special class that, in addition to the method for obtaining the context, will also contain some global variables of the application level, for example, the working period. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AppVariables</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> DbModel dbContext = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static DateTime StartDate { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">     </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public static DateTime FinishDate { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">    () </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;returns&gt;</span></span></span><span class="hljs-comment"></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/returns&gt;</span></span></span><span class="hljs-comment"> public static DbModel CreateDbContext() { dbContext = dbContext ?? new DbModel(); return dbContext; } }</span></span></code> </pre><br><br>  The connection string itself is initialized when the application starts, after the authorization is successful.  To do this, in the event handler for the main form, we will write the following code. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainForm_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dialog = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoginForm(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dialog.ShowDialog() == DialogResult.OK) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s = dbContext.Database.Connection.ConnectionString; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FbConnectionStringBuilder(s); builder.UserID = dialog.UserName; builder.Password = dialog.Password; dbContext.Database.Connection.ConnectionString = builder.ConnectionString; <span class="hljs-comment"><span class="hljs-comment">//   dbContext.Database.Connection.Open(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); Application.Exit(); } } else Application.Exit(); }</span></span></code> </pre><br><br>  Now we will use the static CreateDbContext method to get the context. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext()</code> </pre><br><br><h3>  Work with data </h3><br>  The entities of the model themselves do not contain any data.  The easiest way to load data is to call the Load method, like this: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadCustomersData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { dbContext.CUSTOMERS.Load(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customers = dbContext.CUSTOMERS.Local; bindingSource.DataSource = customers.ToBindingList(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomerForm_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { LoadCustomersData(); dataGridView.DataSource = bindingSource; dataGridView.Columns[<span class="hljs-string"><span class="hljs-string">"CUSTOMER_ID"</span></span>].Visible = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br><br>  However, this method has several disadvantages: <br><ol><li>  The Load method immediately loads all data from the CUSTOMER table into memory. </li><li>  Lazy properties (INVOICES), though not loaded immediately, but only as they are accessed, they will still be loaded when displaying records in the grid.  And exactly as many times as the records will be displayed. </li><li>  The order of the entries is undefined. </li></ol><br>  To circumvent these disadvantages, we will use LINQ (Language Integrated Query) technology, or more precisely LINQ to Entities.  <b>LINQ to Entities</b> offers a simple and intuitive approach to retrieving data using expressions that are close in form to SQL expressions.  LINQ syntax is available through <a href="https://msdn.microsoft.com/ru-ru/library/bb386964(v%3Dvs.110).aspx">LINQ to Entities</a> . <br><br>  LINQ extension methods can return two objects: <b>IEnumerable</b> and <b>IQueryable</b> .  The IQueryable interface is inherited from IEnumerable; therefore, in theory, the IQueryable object is also an IEnumerable object.  But between them there is a significant difference. <br><br>  The IEnumerable interface is in the <b>System.Collections</b> namespace.  An IEnumerable object represents a data set in memory and can only be moved forward through this data.  When executing the query, IEnumerable loads all the data, and if we need to filter it, the filtering itself takes place on the client side. <br><br>  The IQueryable interface is located in the System.Linq namespace.  The IQueryable object provides remote access to the database and allows you to navigate through the data in direct order from beginning to end, and in reverse order.  In the process of creating a query, the return object of which is IQueryable, query optimization occurs.  As a result, in the process of its execution, less memory is spent, less network bandwidth. <br><br>  The Local property returns an IEnumerable interface.  Therefore, we can make LINQ requests to it. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadCustomersData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); dbContext.CUSTOMERS.Load(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> customers = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> customer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dbContext.CUSTOMERS.Local <span class="hljs-keyword"><span class="hljs-keyword">orderby</span></span> customer.NAME <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> customer; bindingSource.DataSource = customers.ToBindingList(); }</code> </pre><br><br>  However, as already mentioned, this query will be executed on the data in memory.  In principle, for small tables that do not require pre-filtering, this is acceptable. <br><br>  In order for a LINQ query to be converted to SQL and run on the server side, we need to use the LINQ query instead of accessing the dbContext.CUSTOMERS.Local property to immediately refer to dbContext.CUSTOMERS.  In this case, we will not need to call dbContext.CUSTOMERS.Load (); <br>  to load the collection into memory. <br><br>  However, here we are trapped by one small ambush.  IQueryable objects do not know how to return a BindingList.  BindingList is the base class for creating a two-way data binding mechanism.  From the IQueryable interface, we can get a regular list by calling ToList, but in this case we lose pleasant bonuses, such as sorting in the grid and many others.  By the way, in .NET Framework 5 this has already been fixed and a special extension has been created.  Make your extension, which will do the same. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbExtensions</span></span> { <span class="hljs-comment"><span class="hljs-comment">//         private class IdResult { public int Id { get; set; } } //  IQueryable  BindingList public static BindingList&lt;T&gt; ToBindingList&lt;T&gt; (this IQueryable&lt;T&gt; source) where T : class { return (new ObservableCollection&lt;T&gt;(source)).ToBindingList(); } //     public static int NextValueFor(this DbModel dbContext, string genName) { string sql = String.Format( "SELECT NEXT VALUE FOR {0} AS Id FROM RDB$DATABASE", genName); return dbContext.Database.SqlQuery&lt;IdResult&gt;(sql).First().Id; } //     DbSet   //     public static void DetachAll&lt;T&gt;(this DbModel dbContext, DbSet&lt;T&gt; dbSet) where T : class { foreach (var obj in dbSet.Local.ToList()) { dbContext.Entry(obj).State = EntityState.Detached; } } //       public static void Refresh(this DbModel dbContext, RefreshMode mode, IEnumerable collection) { var objectContext = ((IObjectContextAdapter)dbContext).ObjectContext; objectContext.Refresh(mode, collection); } //   public static void Refresh(this DbModel dbContext, RefreshMode mode, object entity) { var objectContext = ((IObjectContextAdapter)dbContext).ObjectContext; objectContext.Refresh(mode, entity); } }</span></span></code> </pre><br><br>  In the same class there are some more extensions. <br><br>  The NextValueFor method is designed to get the next value of the generator.  The dbContext.Database.SqlQuery method allows you to execute SQL queries directly and display their results on some entity (projection).  You can use it if you need to execute a SQL query directly. <br><br>  The DetachAll method is designed to detach all objects of a DBSet collection from the context.  This is necessary to update the internal cache.  The point is that within the context, all recoverable are cached and not retrieved from the database again.  However, this is not always useful, as it makes it difficult to obtain modified entries made in a different context. <br><br><table><tbody><tr><td>  <b>Comment</b> <br><br>  In Web applications, the context usually lives for a very short time, and the new context does not have a full cache. <br></td></tr></tbody></table><br><br>  The Refresh method is used to update the properties of an entity object.  It is useful for updating properties of an object after editing or adding it. <br><br>  So our data load code will look like this. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadCustomersData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//     //       //        dbContext.DetachAll(dbContext.CUSTOMERS); var customers = from customer in dbContext.CUSTOMERS orderby customer.NAME select customer; bindingSource.DataSource = customers.ToBindingList(); } private void CustomerForm_Load(object sender, EventArgs e) { LoadCustomersData(); dataGridView.DataSource = bindingSource; dataGridView.Columns["INVOICES"].Visible = false; dataGridView.Columns["CUSTOMER_ID"].Visible = false; dataGridView.Columns["NAME"].HeaderText = "Name"; dataGridView.Columns["ADDRESS"].HeaderText = "Address"; dataGridView.Columns["ZIPCODE"].HeaderText = "ZipCode"; dataGridView.Columns["PHONE"].HeaderText = "Phone"; }</span></span></code> </pre><br><br>  The code of the event handler at the press of the add button is as follows. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAdd_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//     var customer = (CUSTOMER)bindingSource.AddNew(); //     using (CustomerEditorForm editor = new CustomerEditorForm()) { editor.Text = " "; editor.Customer = customer; //    editor.FormClosing += delegate (object fSender, FormClosingEventArgs fe) { if (editor.DialogResult == DialogResult.OK) { try { //     //     customer.CUSTOMER_ID = dbContext.NextValueFor("GEN_CUSTOMER_ID"); //    dbContext.CUSTOMERS.Add(customer); //    dbContext.SaveChanges(); //     dbContext.Refresh(RefreshMode.StoreWins, customer); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); //        fe.Cancel = true; } } else bindingSource.CancelEdit(); }; //    editor.ShowDialog(this); } }</span></span></code> </pre><br><br>  When adding a new record, we get the value of the next identifier using the generator.  We could not initialize the value of the identifier, and in this case the BEFORE INSERT would execute a trigger that would still pull the next value of the generator.  However, in this case, we could not update the newly added record. <br><br>  The code of the event handler for pressing the edit button is as follows. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnEdit_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//   var customer = (CUSTOMER)bindingSource.Current; //     using (CustomerEditorForm editor = new CustomerEditorForm()) { editor.Text = " "; editor.Customer = customer; //    editor.FormClosing += delegate (object fSender, FormClosingEventArgs fe) { if (editor.DialogResult == DialogResult.OK) { try { //    dbContext.SaveChanges(); dbContext.Refresh(RefreshMode.StoreWins, customer); //     bindingSource.ResetCurrentItem(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); //        fe.Cancel = true; } } else bindingSource.CancelEdit(); }; //    editor.ShowDialog(this); } }</span></span></code> </pre><br><br>  The form for editing the customer is as follows. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/0bc/c05/ff9/0bcc05ff953a482da9e48392bb1ebb12.png"></div><br><br>  The data binding code is very simple. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CUSTOMER Customer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomerEditorForm_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { edtName.DataBindings.Add(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Customer, <span class="hljs-string"><span class="hljs-string">"NAME"</span></span>); edtAddress.DataBindings.Add(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Customer, <span class="hljs-string"><span class="hljs-string">"ADDRESS"</span></span>); edtZipCode.DataBindings.Add(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Customer, <span class="hljs-string"><span class="hljs-string">"ZIPCODE"</span></span>); edtPhone.DataBindings.Add(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Customer, <span class="hljs-string"><span class="hljs-string">"PHONE"</span></span>); }</code> </pre><br><br>  The code of the event handler for pressing the delete button is as follows. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnDelete_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"    ?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, MessageBoxButtons.YesNo, MessageBoxIcon.Question); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == DialogResult.Yes) { <span class="hljs-comment"><span class="hljs-comment">//   var customer = (CUSTOMER)bindingSource.Current; try { dbContext.CUSTOMERS.Remove(customer); //    dbContext.SaveChanges(); //     bindingSource.RemoveCurrent(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); } } }</span></span></code> </pre><br><br><h3>  Magazines </h3><br>       ¬´-¬ª.              . <br><br> - ‚Äì   ,     (, ,  ‚Ä¶),   -   ,  ,   ..       :       ,    ‚Äî  .  ,         DataGridView,       BindingSource <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1e7/feb/83e/1e7feb83e76a4e9187daa3e8b2447828.png"></div><br><br>        .               ,       .   ‚Äì   ,     .       ,     ,       ,    AppVariables (.  ), ,   ,   ,   .              (   ).           . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since most often the last documents entered are required, it makes sense to sort them by date in the reverse order. </font><font style="vertical-align: inherit;">We will retrieve the data, as in the case with directories using LINQ. </font><font style="vertical-align: inherit;">Taking into account the above, the method for loading data of invoice caps will look as follows:</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadInvoicesData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//   LINQ   SQL var invoices = from invoice in dbContext.INVOICES where (invoice.INVOICE_DATE &gt;= AppVariables.StartDate) &amp;&amp; (invoice.INVOICE_DATE &lt;= AppVariables.FinishDate) orderby invoice.INVOICE_DATE descending select new InvoiceView { Id = invoice.INVOICE_ID, Cusomer_Id = invoice.CUSTOMER_ID, Customer = invoice.CUSTOMER.NAME, Date = invoice.INVOICE_DATE, Amount = invoice.TOTAL_SALE, Paid = (invoice.PAID == 1) ? "Yes" : "No" }; masterBinding.DataSource = invoices.ToBindingList(); }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As a projection, we used not the anonymous type, but the class InvoiceView. </font><font style="vertical-align: inherit;">This simplifies type casting. </font><font style="vertical-align: inherit;">The definition of the InvoiceView class is as follows:</font></font><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InvoiceView</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Cusomer_Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Customer { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime? Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>? Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Paid { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invoices = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> invoice <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dbContext.INVOICES <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> invoice.INVOICE_ID == Id <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvoiceView { Id = invoice.INVOICE_ID, Cusomer_Id = invoice.CUSTOMER_ID, Customer = invoice.CUSTOMER.NAME, Date = invoice.INVOICE_DATE, Amount = invoice.TOTAL_SALE, Paid = (invoice.PAID == <span class="hljs-number"><span class="hljs-number">1</span></span>) ? <span class="hljs-string"><span class="hljs-string">"Yes"</span></span> : <span class="hljs-string"><span class="hljs-string">"No"</span></span> }; InvoiceView invoiceView = invoices.ToList().First(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Id = invoiceView.Id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Cusomer_Id = invoiceView.Cusomer_Id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Customer = invoiceView.Customer; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Date = invoiceView.Date; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Amount = invoiceView.Amount; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Paid = invoiceView.Paid; } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Load method allows us to quickly update 1 added or updated record in the grid, rather than completely reloading all records. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The code of the event handler at the press of the add button is as follows.</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAddInvoice_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invoice = dbContext.INVOICES.Create(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (InvoiceEditorForm editor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvoiceEditorForm()) { editor.Text = <span class="hljs-string"><span class="hljs-string">"  "</span></span>; editor.Invoice = invoice; <span class="hljs-comment"><span class="hljs-comment">//    editor.FormClosing += delegate (object fSender, FormClosingEventArgs fe) { if (editor.DialogResult == DialogResult.OK) { try { //    invoice.INVOICE_ID = dbContext.NextValueFor("GEN_INVOICE_ID"); //   dbContext.INVOICES.Add(invoice); //    dbContext.SaveChanges(); //       ((InvoiceView)masterBinding.AddNew()).Load(invoice.INVOICE_ID); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); //        fe.Cancel = true; } } }; //    editor.ShowDialog(this); } }</span></span></code> </pre><br><br>               dbContext.Refresh,     Load  InvoiceView.   ,  dbContext.Refresh     ,    ,     LINQ . <br><br>          . <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnEditInvoice_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   var dbContext = AppVariables.getDbContext(); //     var invoice = dbContext.INVOICES.Find(this.CurrentInvoice.Id); if (invoice.PAID == 1) { MessageBox.Show("  ,    .", ""); return; } using (InvoiceEditorForm editor = new InvoiceEditorForm()) { editor.Text = "Edit invoice"; editor.Invoice = invoice; //    editor.FormClosing += delegate (object fSender, FormClosingEventArgs fe) { if (editor.DialogResult == DialogResult.OK) { try { //    dbContext.SaveChanges(); //   CurrentInvoice.Load(invoice.INVOICE_ID); masterBinding.ResetCurrentItem(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); //        fe.Cancel = true; } } }; //    editor.ShowDialog(this); } }</span></span></code> </pre><br><br>            .  CurrentInvoice       -.   : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InvoiceView CurrentInvoice { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (InvoiceView)masterBinding.Current; } }</code> </pre><br><br>        . <br><br>  ,     -      ,        : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnInvoicePay_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> invoice = dbContext.INVOICES.Find(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CurrentInvoice.Id); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (invoice.PAID == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"  ,    ."</span></span>); invoice.PAID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">//   dbContext.SaveChanges(); //    CurrentInvoice.Load(invoice.INVOICE_ID); masterBinding.ResetCurrentItem(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, ""); } }</span></span></code> </pre><br><br>    -   : <br><ol><li>     -    INVOICE_LINE       (   LINQ)   . </li><li>     -  LINQ ,          . </li></ol><br><br>        . <br><br>   ,     -      -         .      SQL ,      ,      .      WEB       . <br><br>       ,      -     ,           SQL      (   ). <br><br>        .            BindingSource. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">masterBinding_CurrentChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { LoadInvoiceLineData(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CurrentInvoice.Id); detailGridView.DataSource = detailBinding; }</code> </pre><br><br>       -   : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadInvoiceLineData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">? id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lines = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dbContext.INVOICE_LINES <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> line.INVOICE_ID == id <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvoiceLineView { Id = line.INVOICE_LINE_ID, Invoice_Id = line.INVOICE_ID, Product_Id = line.PRODUCT_ID, Product = line.PRODUCT.NAME, Quantity = line.QUANTITY, Price = line.SALE_PRICE, Total = Math.Round(line.QUANTITY * line.SALE_PRICE, <span class="hljs-number"><span class="hljs-number">2</span></span>) }; detailBinding.DataSource = lines.ToBindingList(); }</code> </pre><br><br>       InvoiceLineView. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InvoiceLineView</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Invoice_Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Product_Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Product { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Total { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br><br> ,      InvoiceView        .        ,       ,        . <br><br>            . <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InvoiceLineView CurrentInvoiceLine { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (InvoiceLineView)detailBinding.Current; } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the methods for adding, editing, and deleting, we show how to work with stored procedures in the Entity Framework. </font><font style="vertical-align: inherit;">For example, the method for adding a new entry looks like this:</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnAddInvoiceLine_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//   - var invoice = dbContext.INVOICES.Find(this.CurrentInvoice.Id); //     - if (invoice.PAID == 1) { MessageBox.Show(" , - .", "Error"); return; } //   - var invoiceLine = dbContext.INVOICE_LINES.Create(); invoiceLine.INVOICE_ID = invoice.INVOICE_ID; //      using (InvoiceLineEditorForm editor = new InvoiceLineEditorForm()) { editor.Text = "Add invoice line"; editor.InvoiceLine = invoiceLine; //    editor.FormClosing += delegate (object fSender, FormClosingEventArgs fe) { if (editor.DialogResult == DialogResult.OK) { try { //    var invoiceIdParam = new FbParameter("INVOICE_ID", FbDbType.Integer); var productIdParam = new FbParameter("PRODUCT_ID", FbDbType.Integer); var quantityParam = new FbParameter("QUANTITY", FbDbType.Integer); //    invoiceIdParam.Value = invoiceLine.INVOICE_ID; productIdParam.Value = invoiceLine.PRODUCT_ID; quantityParam.Value = invoiceLine.QUANTITY; //    dbContext.Database.ExecuteSqlCommand( "EXECUTE PROCEDURE SP_ADD_INVOICE_LINE(@INVOICE_ID, @PRODUCT_ID, @QUANTITY)", invoiceIdParam, productIdParam, quantityParam); //   //    - CurrentInvoice.Load(invoice.INVOICE_ID); //      LoadInvoiceLineData(invoice.INVOICE_ID); //    masterBinding.ResetCurrentItem(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); //        fe.Cancel = true; } } }; //    editor.ShowDialog(this); } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here updating the master master record is required because one of its fields (TotalSale) contains aggregated information by document lines. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The method for updating the record is implemented as follows.</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnEditInvoiceLine_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//   - var invoice = dbContext.INVOICES.Find(this.CurrentInvoice.Id); //     - if (invoice.PAID == 1) { MessageBox.Show("  ,   .", "Error"); return; } //    - var invoiceLine = invoice.INVOICE_LINES .Where(p =&gt; p.INVOICE_LINE_ID == this.CurrentInvoiceLine.Id) .First(); //      using (InvoiceLineEditorForm editor = new InvoiceLineEditorForm()) { editor.Text = "Edit invoice line"; editor.InvoiceLine = invoiceLine; //    editor.FormClosing += delegate (object fSender, FormClosingEventArgs fe) { if (editor.DialogResult == DialogResult.OK) { try { //    var idParam = new FbParameter("INVOICE_LINE_ID", FbDbType.Integer); var quantityParam = new FbParameter("QUANTITY", FbDbType.Integer); //    idParam.Value = invoiceLine.INVOICE_LINE_ID; quantityParam.Value = invoiceLine.QUANTITY; //    dbContext.Database.ExecuteSqlCommand( "EXECUTE PROCEDURE SP_EDIT_INVOICE_LINE(@INVOICE_LINE_ID, @QUANTITY)", idParam, quantityParam); //   //    - CurrentInvoice.Load(invoice.INVOICE_ID); //      LoadInvoiceLineData(invoice.INVOICE_ID); //    masterBinding.ResetCurrentItem(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); //        fe.Cancel = true; } } }; //    editor.ShowDialog(this); } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The method for deleting a record is implemented as follows. </font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnDeleteInvoiceLine_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = MessageBox.Show(<span class="hljs-string"><span class="hljs-string">"     -?"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, MessageBoxButtons.YesNo, MessageBoxIcon.Question); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == DialogResult.Yes) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//   - var invoice = dbContext.INVOICES.Find(this.CurrentInvoice.Id); try { //     - if (invoice.PAID == 1) throw new Exception("   , - ."); //    var idParam = new FbParameter("INVOICE_LINE_ID", FbDbType.Integer); //    idParam.Value = this.CurrentInvoiceLine.Id; //    dbContext.Database.ExecuteSqlCommand( "EXECUTE PROCEDURE SP_DELETE_INVOICE_LINE(@INVOICE_LINE_ID)", idParam); //   //    - CurrentInvoice.Load(invoice.INVOICE_ID); //      LoadInvoiceLineData(invoice.INVOICE_ID); //    masterBinding.ResetCurrentItem(); } catch (Exception ex) { //   MessageBox.Show(ex.Message, "Error"); } } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the methods for adding and editing invoice items, we used the form for editing. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/48f/b48/d4f/48fb48d4fc01422e962789f8569c9c3c.png"></div><br><br>       TextBox.   ,  ,         .           ,      .           : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">InvoiceLineEditorForm</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvoiceLineEditorForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> INVOICE_LINE InvoiceLine { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvoiceLineEditorForm_Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.InvoiceLine.PRODUCT != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { edtProduct.Text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.InvoiceLine.PRODUCT.NAME; edtPrice.Text = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.InvoiceLine.PRODUCT.PRICE.ToString(<span class="hljs-string"><span class="hljs-string">"F2"</span></span>); btnChooseProduct.Click -= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.btnChooseProduct_Click; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.InvoiceLine.QUANTITY == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.InvoiceLine.QUANTITY = <span class="hljs-number"><span class="hljs-number">1</span></span>; edtQuantity.DataBindings.Add(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.InvoiceLine, <span class="hljs-string"><span class="hljs-string">"QUANTITY"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnChooseProduct_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { GoodsForm goodsForm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GoodsForm(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (goodsForm.ShowDialog() == DialogResult.OK) { InvoiceLine.PRODUCT_ID = goodsForm.CurrentProduct.Id; edtProduct.Text = goodsForm.CurrentProduct.Name; edtPrice.Text = goodsForm.CurrentProduct.Price.ToString(<span class="hljs-string"><span class="hljs-string">"F2"</span></span>); } } }</code> </pre><br><br><h3>    </h3><br>     , ,   SaveChanges(),   Entity Framework     .    ,        .   EF         .       .       ,   .         : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (DataGridViewRow gridRows <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dataGridView.SelectedRows) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)gridRows.Cells[<span class="hljs-string"><span class="hljs-string">"Id"</span></span>].Value; <span class="hljs-comment"><span class="hljs-comment">//        var product = dbContext.PRODUCTS.Find(id); //  10% decimal discount = 10.0m; product.PRICE = product.PRICE * (100 - discount) /100; } //        //       dbContext.SaveChanges();</span></span></code> </pre><br><br> ,   10 .       10           .        ,     . ,  : <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-comment"><span class="hljs-comment">//      using (var dbTransaction = dbContext.Database.BeginTransaction()) { string sql = "UPDATE PRODUCT " + "SET PRICE = PRICE * ROUND((100 - @DISCOUNT)/100, 2) " + "WHERE PRODUCT_ID = @PRODUCT_ID"; try { //    var idParam = new FbParameter("PRODUCT_ID", FbDbType.Integer); var discountParam = new FbParameter("DISCOUNT", FbDbType.Decimal); //  SQL     var sqlCommand = dbContext.Database.Connection.CreateCommand(); sqlCommand.CommandText = sql; //  ,    sqlCommand.Transaction = dbTransaction.UnderlyingTransaction; sqlCommand.Parameters.Add(discountParam); sqlCommand.Parameters.Add(idParam); //   sqlCommand.Prepare(); //       foreach (DataGridViewRow gridRows in dataGridView.SelectedRows) { int id = (int)gridRows.Cells["Id"].Value; //    idParam.Value = id; discountParam.Value = 10.0m; //  10% //  sql  sqlCommand.ExecuteNonQuery(); } dbTransaction.Commit(); } catch (Exception ex) { dbTransaction.Rollback(); MessageBox.Show(ex.Message, "error"); } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In this case, we started the transaction with the default parameters. </font><font style="vertical-align: inherit;">In order to set your transaction parameters you must use the UseTransaction method.</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btnDiscount_Click</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, EventArgs e</span></span></span><span class="hljs-function">)</span></span> { DiscountEditorForm editor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DiscountEditorForm(); editor.Text = <span class="hljs-string"><span class="hljs-string">"Enter discount"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (editor.ShowDialog() != DialogResult.OK) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> needUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dbContext = AppVariables.getDbContext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connection = dbContext.Database.Connection; <span class="hljs-comment"><span class="hljs-comment">//      using (var dbTransaction = connection.BeginTransaction(IsolationLevel.Snapshot)) { dbContext.Database.UseTransaction(dbTransaction); string sql = "UPDATE PRODUCT " + "SET PRICE = ROUND(PRICE * (100 - @DISCOUNT)/100, 2) " + "WHERE PRODUCT_ID = @PRODUCT_ID"; try { //    var idParam = new FbParameter("PRODUCT_ID", FbDbType.Integer); var discountParam = new FbParameter("DISCOUNT", FbDbType.Decimal); //  SQL     var sqlCommand = connection.CreateCommand(); sqlCommand.CommandText = sql; //      sqlCommand.Transaction = dbTransaction; sqlCommand.Parameters.Add(discountParam); sqlCommand.Parameters.Add(idParam); //   sqlCommand.Prepare(); //       foreach (DataGridViewRow gridRows in dataGridView.SelectedRows) { int id = (int)gridRows.Cells["PRODUCT_ID"].Value; //    idParam.Value = id; discountParam.Value = editor.Discount; //  sql  needUpdate = (sqlCommand.ExecuteNonQuery() &gt; 0) || needUpdate; } dbTransaction.Commit(); } catch (Exception ex) { dbTransaction.Rollback(); MessageBox.Show(ex.Message, "error"); needUpdate = false; } } //   &lt;a href="http://ib-aid.com/download/docs/NET_DB.zip"&gt;&lt;/a&gt; if (needUpdate) { //       foreach (DataGridViewRow gridRows in dataGridView.SelectedRows) { var product = (PRODUCT)bindingSource.List[gridRows.Index]; dbContext.Refresh(RefreshMode.StoreWins, product); } bindingSource.ResetBindings(false); } }</span></span></code> </pre><br><br>  Here you go.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Now we have only one transaction for the entire set of updates, and there are no extra commands to search for data. </font><font style="vertical-align: inherit;">It remains only to add a dialog to enter the discount value and update the data in the grid. </font><font style="vertical-align: inherit;">Try it yourself. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I hope this article has helped you understand the features of writing a C # application using the Entity Framework when working with Firebird.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e27/38a/7ef/e2738a7eff774dda8347426091bfa510.png"></div><br><br><h2>  Links </h2><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Source codes of the sample application </font></font></a> <br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Database and scripts for its creation</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/278405/">https://habr.com/ru/post/278405/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278393/index.html">alter table without table locale</a></li>
<li><a href="../278395/index.html">We promote mobile applications in the AppStore and Google Play: how to use the method of featuring</a></li>
<li><a href="../278399/index.html">Grace "Grandma COBOL" Hopper</a></li>
<li><a href="../278401/index.html">JavaScript parser for treasure hunters of photographic depths</a></li>
<li><a href="../278403/index.html">Dollar</a></li>
<li><a href="../278407/index.html">The key to JetBrains products for all students on Stepic.org</a></li>
<li><a href="../278409/index.html">Introduction to practical analytics, or what is common in neural networks with diet pills</a></li>
<li><a href="../278411/index.html">Authentication using Spring Security and JWT tokens</a></li>
<li><a href="../278413/index.html">Overview of synchronization primitives - mutex and cond</a></li>
<li><a href="../278421/index.html">Emotional landing page? Wow wow, easy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>