<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The basic principles of setting up the Garbage Collection from scratch</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I would not want to focus on the principle of the garbage collector - this is beautifully and clearly described here: habrahabr.ru/pos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The basic principles of setting up the Garbage Collection from scratch</h1><div class="post__text post__text-html js-mediator-article">  In this article I would not want to focus on the principle of the garbage collector - this is beautifully and clearly described here: <a href="http://habrahabr.ru/post/112676/">habrahabr.ru/post/112676</a> .  I want to go more to the practical bases and quantitative characteristics of setting up the Garbage Collection in the JVM - and try to understand how effective this can be. <br><br><h4>  Quantitative characteristics of the evaluation of the effectiveness of GC </h4><br>  Consider the following indicators: <br><br><ul><li>  <b>Bandwidth</b> A measure that determines the ability of an application to operate at peak load, regardless of the pauses during the build and the size of the required memory. </li><li>  <b>Response time</b> Measure GC, which determines the ability of the application to cope with the number of stops and fluctuations in the work of GC </li><li>  <b>Size of memory in use</b> Size of memory that is necessary for effective GC operation </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As a rule, the listed characteristics are compromise and the improvement of one of them leads to costs for the rest.  For most applications, all three characteristics are important, but often one or two are more important to the application ‚Äî this will be the starting point for customization. <br><a name="habracut"></a><br><h4>  Basic GC Customization </h4><br><br>  Consider three basic fundamental rules for understanding GC customization: <br><ul><li>  It is necessary to strive to ensure that the maximum number of objects is cleared when running a small GC (minor grabage collection).  This principle reduces the number and frequency of the full garbage collection ‚Äî whose work is the main reason for the large delays in the application. </li><li>  The more memory is allocated to the application, the better the garbage collection works and the better the quantitative characteristics of throughput and response time are achieved. </li><li>  Only 2 of 3 quantitative characteristics ‚Äî bandwidth, response time, the size of the allocated memory ‚Äî can be effectively configured; effective value of the size of the required memory is understood as minimizing it </li></ul><br><br>  Consider an example of a simple application (which, for example, can emulate a web application, during which the database is accessed and the return result is accumulated), in which the makeObjects () method is accessed in several threads, during which a loop is continuously formed an object occupying a certain volume in the heap, then any calculations take place with it - a delay is made, the reference to the object does not flow away from the method, and upon its completion the GC can understand that this object is to be cleaned. <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> ru.skuptsov; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.ArrayList; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.ExecutorService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.concurrent.Executors; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MemoryConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OBJECT_SIZE = <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OBJECTS_NUMBER = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ADD_PROCESS_TIME = <span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> NUMBER_OF_REQUEST_THREADS = <span class="hljs-number"><span class="hljs-number">50</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> EXPERIMENT_TIME = <span class="hljs-number"><span class="hljs-number">30000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> stop = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException </span></span>{ start(); Thread.sleep(EXPERIMENT_TIME); stop(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ExecutorService execService = Executors.newCachedThreadPool(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUMBER_OF_REQUEST_THREADS; i++) execService.execute(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryConsumer()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ stop = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span> &amp;&amp; !stop) { makeObjects(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeObjects</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt; objectList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[]&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; OBJECTS_NUMBER; i++) { objectList.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[OBJECT_SIZE]); } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(ADD_PROCESS_TIME); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException e) { e.printStackTrace(); } } }</code> </pre> <br><br>  The experiment lasts for some time, then to assess the effectiveness we will use the total delay time caused by the garbage collector.  The delay is necessary so that after the final marking of objects for deletion there is no reference to the object being cleaned.  The fact that there is jvm, which can mark and clear objects without causing a ‚Äústop-the-world‚Äù pause and how various types of GCs function - described in detail here <a href="http://habrahabr.ru/post/148322/">habrahabr.ru/post/148322</a> - we do not consider this option. <br><br>  We will run the experiment on: <br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function">C:\&gt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">java</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XX</span></span></span><span class="hljs-function">:+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrintCommandLineFlags</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">version</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XX:MaxHeapSize</span></span></span><span class="hljs-function">=4290607104 -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XX:ParallelGCThreads</span></span></span><span class="hljs-function">=8 -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XX</span></span></span><span class="hljs-function">:+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PrintCommandLineFlags</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XX</span></span></span><span class="hljs-function">:-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseLargePagesIndividualAllocation</span></span></span><span class="hljs-function"> -</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XX</span></span></span><span class="hljs-function">:+</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UseParallelGC</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">java</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">version</span></span></span><span class="hljs-function"> "1.6.0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_16</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TM</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SE</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Runtime</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Environment</span></span></span><span class="hljs-function"> (</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-function"> 1.6.0</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_16</span></span></span><span class="hljs-function">-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b01</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HotSpot</span></span></span><span class="hljs-function">(</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TM</span></span></span><span class="hljs-function">) 64-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Bit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Server</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VM</span></span></span><span class="hljs-function"> (</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-function"> 14.2-</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b01</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mixed</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mode</span></span></span><span class="hljs-function">)</span></span></code> </pre><br>  For which by default the mode is enabled - server and UseParallelGC (multi-stream operation of the small garbage collection phase) <br><br>  To estimate the total amount of pause, the garbage collector can be run in the mode: <br><pre> <code class="dos hljs">java -XX:+PrintGCTimeStamps -XX:+PrintGCDetails -verbose:gc -Xloggc:gc.log ru.skuptsov.MemoryConsumer</code> </pre><br>  And summarize the delay in the gc.log: <br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">167</span></span>: [Full GC [PSYoungGen: <span class="hljs-number"><span class="hljs-number">21792</span></span>K-&gt;<span class="hljs-number"><span class="hljs-number">13324</span></span>K(<span class="hljs-number"><span class="hljs-number">152896</span></span>K)] [PSOldGen: <span class="hljs-number"><span class="hljs-number">341095</span></span>K-&gt;<span class="hljs-number"><span class="hljs-number">349363</span></span>K(<span class="hljs-number"><span class="hljs-number">349568</span></span>K)] <span class="hljs-number"><span class="hljs-number">362888</span></span>K-&gt;<span class="hljs-number"><span class="hljs-number">362687</span></span>K(<span class="hljs-number"><span class="hljs-number">502464</span></span>K) [PSPermGen: <span class="hljs-number"><span class="hljs-number">2581</span></span>K-&gt;<span class="hljs-number"><span class="hljs-number">2581</span></span>K(<span class="hljs-number"><span class="hljs-number">21248</span></span>K)], <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">0079385</span></span> secs] [Times: user=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> sys=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">00</span></span>, real=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">01</span></span> secs]</code> </pre><br>  Where real = 0.01 secs is the real time spent on the build. <br><br>  Or, you can use the VisualVm utility, with the VisualGC plugin installed, in which you can visually observe the memory distribution in different GC areas (Eden, Survivor1, Survivor2, Old) and see statistics on the launch and duration of garbage collection. <br><br><h4>  Determining the size of the required memory </h4><br>  To begin with, we have to start the application with the largest possible memory size than the application really needs.  If we do not initially know how much our application will occupy in memory - you can run the application without specifying -Xmx and -Xms and HotSpot VM will choose the size of the memory itself.  If at the start of the application we get OutOfMemory (Java heap space or PermGen space), then we can iteratively increase the amount of available memory (-Xmx or -XX: PermSize) until the errors go away. <br>  The next step is to calculate the size of the long-lived live data - the size of the old and permanent heap areas after the full garbage collection phase.  This size is an approximate amount of memory necessary for the functioning of the application.  As a rule, the size of the necessary memory for the application -Xms and -Xmx is 3-4 times larger than the amount of live data.  So, for the log mentioned above, the value of the old region after the full garbage collection phase is 349363K.  Then the suggested value is -Xmx and -Xms ~ 1400 MB.  -XX: PermSize and -XX: MaxPermSize - 1.5 times more than PermGenSize after the full garbage collection phase - 13324K ~ 20 MB.  The size of the young generation is assumed to be 1-1.5 of the size of the live data ~ 525 MB.  Then we get the jvm launch line with the following parameters: <br><br><pre> <code class="dos hljs">java -Xms1400m -Xmx1400m -Xmn525m -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br><br>  In VisualVm we get the following picture: <br><br><img src="//habrastorage.org/files/f9c/e4f/7de/f9ce4f7dead7421c9b45dc754405908f.png"><br><br>  In just 30 seconds, the experiment produced 54 assemblies ‚Äî 31 small and 23 full assemblies ‚Äî with a total stopping time of 3.227c.  This amount of delay may not meet the necessary requirements - see if we can improve the situation without changing the application code. <br><br><h4>  Setting the allowed response time </h4><br>  The following parameters must be measured and taken into account when setting the response time: <br><ul><li>  Measuring the duration of a small garbage collection </li><li>  Small garbage collection frequency measurement </li><li>  Measuring the duration of the worst case complete garbage collection </li><li>  Measure the frequency of the worst case complete garbage collection </li></ul><br><br><h5>  Adjustment of the size of young and old generation </h5><br>  The time required for the implementation of the phase of small garbage collection directly depends on the number of objects in the young generation, the smaller its size - the shorter the duration, but the frequency increases, since  the area starts to fill more often.  Let's try to reduce the time of each small assembly, reducing the size of the young generation, while maintaining the size of the old generation.  Approximately, we can estimate that every second we have to clear 50 young people * 8 objects * 1MB ~ 400MB in young generation.  Run with parameters: <br><br><pre> <code class="dos hljs">java -Xms1275m -Xmx1275m -Xmn400m -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br><br>  In VisualVm we get the following picture: <br><br><img src="//habrastorage.org/files/4f7/948/6c3/4f79486c3f304ce09c83733f517c8ddd.png"><br><br>  We could not influence the total time of small garbage collection - 1,533s - the frequency of small assemblies increased, but the total time worsened - 3,661 due to the fact that the filling rate of the old generation increased and the frequency of the full garbage collection call increased.  To overcome this - try to increase the size of the old generation - run jvm with the parameters: <br><br><pre> <code class="dos hljs">java -Xms1400m -Xmx1400m -Xmn400m -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br><br><img src="//habrastorage.org/files/6c9/608/98e/6c960898e8d4417e86223c7f6e792000.png"><br><br>  The total pause has now improved and is 2.637 s and the total value required for the application of memory has decreased, thus iteratively finding the right balance between old and young generation for distributing the lifetime of objects in a particular application. <br><br>  If the delay time still does not suit us - you can go to the concurrent garbage collector by turning on the -XX option: + UseConcMarkSweepGC is an algorithm that will try to perform the main work of marking objects for deletion in a separate stream in parallel to the application threads. <br><br><h5>  Configuring Concurrent garbage collector </h5><br>  ConcMarkSweep GC requires more careful tuning, - one of the main goals is to reduce the number of stop-the-world pauses in the absence of sufficient space in the old generation for the location of objects - because  this phase takes on average more time than the full garbage collection phase with throughCc.  As a result, the duration of the worst case of garbage collection may increase, it is necessary to avoid frequent overflows of the old generation.  As a rule, when switching to ConcMarkSweep GC, it is recommended to increase the size of the old generation by 20-30% - run jvm with the parameters: <br><br><pre> <code class="dos hljs">java -Xms1680m -Xmx1680m -Xmn400m -XX:+UseConcMarkSweepGC -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br><br><img src="//habrastorage.org/files/ad7/1dc/aeb/ad71dcaebcb54d418b4295dcdfaf026e.png"><br><br>  The total pause was reduced to 1,923 with. <br><br><h5>  Survivor size adjustment </h5><br>  Below the graph, you can see the distribution of the application's memory by the number of transitions between the Eden, Survivor1 and Survivor2 stages before they get into Old Generation.  The fact is that one of the ways to reduce the number of overflows of the old generation in the ConcMarkSweep GC is to prevent the direct flow of objects from the young generation directly to the old - bypassing the survivor area. <br><br>  To track the distribution of objects in stages, you can run jvm with the -XX: + PrintTenuringDistribution option. <br>  In gc.log we can observe: <br><pre> <code class="dos hljs">Desired survivor size <span class="hljs-number"><span class="hljs-number">20971520</span></span> bytes, new threshold <span class="hljs-number"><span class="hljs-number">1</span></span> (max <span class="hljs-number"><span class="hljs-number">4</span></span>) - age <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-number"><span class="hljs-number">40900584</span></span> bytes, <span class="hljs-number"><span class="hljs-number">40900584</span></span> total</code> </pre><br>  The total size of survivor objects is 40900584, the CMS defaults to using the 50% barrier to occupancy of the survivor area.  Thus we obtain the size of the region ~ 80 MB.  When you run jvm, it is specified by the -XX: SurvivorRatio parameter, which is determined from the formula: <br><pre> <code class="dos hljs">survivor space size = -Xmn&lt;value&gt;/(-XX:SurvivorRatio=&lt;ratio&gt; + <span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre><br><br><br>  Get <br><pre> <code class="dos hljs">java -Xms1680m -Xmx1680m -Xmn400m -XX:SurvivorRatio=<span class="hljs-number"><span class="hljs-number">3</span></span> -XX:+UseConcMarkSweepGC -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br>  Wanting to leave the size of eden space the same - we get: <br><pre> <code class="dos hljs">java -Xms1760m -Xmx1760m -Xmn480m -XX:SurvivorRatio=<span class="hljs-number"><span class="hljs-number">5</span></span> -XX:+UseConcMarkSweepGC -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ab3/1a7/52e/ab31a752e040a77878325f21f1db9698.png"><br><br>  The distribution is better, but the total time has not changed much due to the specifics of the application, the fact is that after frequent small garbage collections, the size of the surviving objects is always larger than the available size of survivor areas, so in our case we can donate the correct distribution to suit eden size space: <br><pre> <code class="dos hljs">java -Xms1760m -Xmx1760m -Xmn480m -XX:SurvivorRatio=<span class="hljs-number"><span class="hljs-number">100</span></span> -XX:+UseConcMarkSweepGC -XX:PermSize=<span class="hljs-number"><span class="hljs-number">20</span></span>m ru.skuptsov.MemoryConsumer</code> </pre><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e24/91c/39b/e2491c39b599c6d922112e53e1e05692.png"><br><br><h4>  Total </h4><br>  As a result, we were able to reduce the size of the total pause from 3.227 seconds to 1.481 seconds by 30 s of the experiment, while slightly increasing the total memory consumption.  Whether it is a lot or a little depends on the specific specifics, in particular, given the tendency to reduce the cost of physical memory and the principle of maximizing used memory, it is still important to find a balance between different areas of the GC and this process is more creative than scientific. </div><p>Source: <a href="https://habr.com/ru/post/223401/">https://habr.com/ru/post/223401/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../223385/index.html">Transition from 2 links to service architecture in the SOA paradigm</a></li>
<li><a href="../223387/index.html">Game ‚ÄúLAND‚Äù for DVK-3. Windows Reincarnation</a></li>
<li><a href="../223389/index.html">‚ÄúAyusha‚Äù - a controller on a 6502 processor</a></li>
<li><a href="../223395/index.html">LabView in robotics - creating a SCADA system to control the robot</a></li>
<li><a href="../223399/index.html">A little cycling under Linux or RSS-aggregator on the knee with your own hands</a></li>
<li><a href="../223403/index.html">Imagine Cup 2014: the path to victory</a></li>
<li><a href="../223405/index.html">PL / SQL Web Services Solution</a></li>
<li><a href="../223407/index.html">Convenient basket (and DAS) for HDD / SSD 3.5 "/2.5" from the designer with your own hands</a></li>
<li><a href="../223415/index.html">Intel GPA for Android - we optimize graphics in mobile applications</a></li>
<li><a href="../223419/index.html">Microwaves guard weather forecasts, or what a scatterometer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>