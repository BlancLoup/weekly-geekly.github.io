<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Half-HA cluster PostgreSQL on Windows 2012</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Thanks 
 Thank you, Habr, for what you are and for those wonderful hours that I spent in you! Thank you, brave habrifiers, for the articles of high qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Half-HA cluster PostgreSQL on Windows 2012</h1><div class="post__text post__text-html js-mediator-article"><h4>  Thanks </h4><br>  Thank you, Habr, for what you are and for those wonderful hours that I spent in you!  Thank you, brave habrifiers, for the <a href="https://habrahabr.ru/post/188096/">articles of high quality</a> , subtle humor and a broad outlook.  Only thanks to you and Mar. Ivanovna (who taught me to read in the first class) I achieved serious success in IT, and now I want to share a story when non-standard thinking helped solve the idiomatic task from the customer. <br><br><h3>  Introduction </h3><br>  Some time ago I was working on a proprietary product.  This software stored its data in an external DBMS.  Initially, work was carried out with MS SQL, but later, specifically for users ‚ÄúI only put * nix-like systems‚Äù, they made compatibility with <a href="https://www.postgresql.org/">PostgreSQL</a> .  Then they took me to solve the problems of the class ‚Äúthe database fell - you need to recover from the transaction logs‚Äù. <br><br>  One day, the team went to implement another project.  Initially, it was agreed that the site already has two Windows 2012 servers on which the MS SQL failover cluster will be deployed.  However, at the last moment, the customer did not have enough money for instances, and I was instructed to set up a roostge database, as well as somehow solve the fault tolerance task.  Thanks to the community of postgres developers who have compiled the installer for Windows.  Tasks: <br><a name="habracut"></a><br><ol><li>  Install PostgreSQL on Windows; </li><li>  Provide data replication between databases; </li><li>  Resolve the issue of fault tolerance. </li></ol><br><h3>  1. Installing PostgreSQL </h3><br>  Everything is simple here: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  Downloading the <a href="http://www.enterprisedb.com/products-services-training/pgdownload">distribution kit</a> for Windows - version 9.4 for x64 will do; </li><li>  Run the installer, select the Russian locale, install to the default directory and play Enikeyschik by clicking the "Next" button. </li></ul><br>  <b>Note:</b> Stack bilder at the end can not run - we will not need its elements. <br><br><h3>  2. Data Replication </h3><br>  By default, we will install Slony-I, however, asynchronous replication is already in the ‚Äúbox‚Äù, which we will use.  Sometimes access to the linux command line and the IBs settings files were refused to be issued, and I had to configure the DBMS via psql, so mad skillz would go on.  Here and later, all utilities are taken from the <i>C: \ Program Files \ PostgreSQL \ 9.4 \ bin \ folder</i> (it would be correct to specify the $ PGDATA variable, but for some reason it was not set by the installer by default).  On the master: <br><br>  Connect to the DBMS with the command: <br><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">psql</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-U</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">postgres</span></span></code> </pre> <br>  Enable data duplication mode: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wal_level=hot_standby;</code> </pre> <br>  Disable archiving mode: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> archive_mode=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span>;</code> </pre> <br>  Allow to create replication slots: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> max_replication_slots=<span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  We set the maximum number of data replication processes (the second process will serve the <b>pgadmin</b> utility): <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> max_wal_senders=<span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  Execute the command "\!"  and ... Haha!  We are in the Windows command line.  We edit the pg_hba.conf file (hereinafter, we mean the files from the <i>C: \ Program Files \ PostgreSQL \ 9.4 \ data</i> folder).  He is responsible for access of hosts / users to the DBMS.  Add lines: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#        host all all &lt;ip-&gt; md5 #           host all all &lt;ip-slave&gt; md5 host replication postgres &lt;ip-&gt; trust #   postgres        host replication postgres &lt;ip-slave&gt; trust&lt;/i&gt;&lt;br&gt;</span></span></code> </pre><br>  On the slave: <br><br>  <b>1.</b> Stop the postgresql service. <br><br>  <b>2.</b> Delete the contents of the folder <i>C: \ Program Files \ PostgreSQL \ 9.4 \ data</i> <br><br>  <b>3.</b> We make a backup from the wizard using the <b>pg_basebackup command</b> .  As parameters we use: <br><br><pre> <code class="hljs pgsql">pg_basebackup -h &lt;ip-&gt; -D "C:\Program Files\PostgreSQL\9.4\data" -U postgres</code> </pre> <br>  At the end of the utility, it is indignant that WAL archiving is not configured, but we don‚Äôt need this in principle because of the next step (as a bonus, saving disk space). <br><br>  <b>4.</b> Go to the postgresql.conf file and set the parameters: <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#  " " hot_standby=on #     hot_standby_feedback=on #    WAL- wal_receiver_status_interval=0</span></span></code> </pre> <br>  We return to the master: <br><br>  <b>1.</b> Assign a host to the master: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> hot_standby=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span>;</code> </pre> <br>  <b>2.</b> Turn off waiting for response from the slave: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> hot_standby_feedback=<span class="hljs-keyword"><span class="hljs-keyword">off</span></span>;</code> </pre> <br>  <b>3.</b> Turn off the interval in the transfer of WAL-log: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> wal_receiver_status_interval=<span class="hljs-number"><span class="hljs-number">0</span></span>;</code> </pre> <br>  <b>4.</b> Restart the DBMS service on the wizard (without leaving psql): <br><br><pre> <code class="hljs pgsql">\! pg_ctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> -D "C:\Program Files\PostgreSQL\9.4\data"</code> </pre> <br>  <b>5.</b> Create a replication slot: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_create_physical_replication_slot(<span class="hljs-string"><span class="hljs-string">'slot_1'</span></span>);</code> </pre> <br><h3>  3. Fault tolerance </h3><br>  Slony-I was not part of the project specification, and it was lazy for him to invent PowerShell scripts.  The customer completely refused to install an additional linux server, so the option with <b>pgpool-II</b> or <b>pgbouncer was</b> dropped (and it‚Äôs not clear how to work with Windows).  Therefore, there was a transition to the recording mode on the file-trigger.  Let's finish the slave to go to master mode.  To do this, you need to create a recovery.conf file and add lines to it: <br><br><pre> <code class="cs hljs">standby_mode=<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-meta"><span class="hljs-meta">#    primary_conninfo='host=&lt;ip_&gt; port=5432 user=postgres' #     primary_slot_name=slot_1 #     trigger_file=startmaster #  ,         </span></span></code> </pre> <br>  <b>Note:</b> if the slave enters master mode, the file will change its name to <u>recovery.done</u> . <br><br>  We start the postgres service on the slave.  In case of successful setup, it will start correctly and will drag the data from the wizard.  You can check replication: <br><br>  - On the master using the command: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (active) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pg_replication_slots;</code> </pre> <br>  - On the slave, you can try to create an object and get a read-only transaction error.  For the client, you can create a test table on the wizard, which is automatically duplicated on the slave. <br><br>  In the event of a master failure, the potential sysadmin must perform the following sequence of actions: <br><br><blockquote>  <b>a)</b> Make sure that the write wizard is unavailable; <br>  <b>b)</b> Check that the ip-address of the database cluster is free.  For example, pinganut ip or cut down the network interface wizard; <br>  <b>c)</b> Change the slave ip to the master; <br>  <b>d)</b> Point the slave to work like a master.  To do this, you can use <i>pg_ctl promote</i> (an error raised by service privileges has been thrown out on the object) or, since we configured the reconfiguration trigger file, create an empty <u>startmaster</u> file. </blockquote><br>  In addition (what was not included in the scope of the task): you can make a slave from a fallen master by following the slave configuration items from the second stage. <br><br>  My boss joked: " <em>Well, you know Sharpe - write!</em> ".  For two days the attempt in the field on my knee - <a href="https://github.com/nikroha/314g">I took and gash</a> .  About the basics of OOP and thread safety, please write all comments <a href="http:">here</a> ). <br><br>  The program uses the <a href="http://www.npgsql.org/install.html">Npgsql</a> library to work with the DBMS.  You need to unpack the archive on the slave and run the program for execution. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e91/b81/325/e91b813251cc4545b9a5faed83ddcedd.png"></div><br>  Next you need to enter: <br><br>  - ip slave; <br>  - ip wizard; <br>  - ip cluster (the main ip in theory should coincide with the ip-master, but anything can happen); <br>  - the name of the database to which the connection will be made (to create a test table <i>testofcluster</i> in it) <br><br>  To perform a cluster check, click the Test button.  The program will check that it is running on the slave, the wizard allows you to write to the test table and replication occurs in the normal mode.  As a bonus <u>, the recovery.conf, postgresql.conf, postgresql.auto.conf</u> files on the slave will be saved, which will simplify the procedure for transferring the master to slave mode. <br><br>  Start monitoring: the software cyclically checks the availability of the wizard and in the event of its failure - transfers the left to the recording mode and changes the ip from the left to the cluster one. <br><br>  <b>Specification:</b> <br><blockquote>  - Must be installed dotnet 4.5 <br>  - Compatibility tested on Windows 7 x64, Windows 2012 with PostgreSQL 9.4 (x64). <br>  - The response time to turn off the wizard is from 20 to 35 seconds (a phased check of the availability of the wizard and the main ip is performed). <br>  - The transfer time from the left to the master is less than 5 seconds (restart of the service is not required). <br>  - <b>Note:</b> on virtual machines (on VMware Workstation - 100%), the ip-address does not change. <br>  - Windows should be Russified;  In PostgreSQL, the Russian locale must be selected. </blockquote><br>  <b>Download:</b> download the archive with the compiled program and two libraries can be <a href="http://dropmefiles.com/KQWS8">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/308950/">https://habr.com/ru/post/308950/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../308938/index.html">Errors of questionnaires. Error 2: questionnaire wording. 13 cases of misunderstanding and manipulation in the survey (part 1)</a></li>
<li><a href="../308940/index.html">iKnow Review Analyzer (iKRA)</a></li>
<li><a href="../308944/index.html">Check the speed of the promis</a></li>
<li><a href="../308946/index.html">Finding errors in the GCC compiler code using the PVS-Studio analyzer</a></li>
<li><a href="../308948/index.html">How to use UrlManager to set up routing and create ‚Äúfriendly‚Äù URLs</a></li>
<li><a href="../308952/index.html">Porting a portfolio from Brainstorage to Freelansim</a></li>
<li><a href="../308954/index.html">How-to: interactive writing guide</a></li>
<li><a href="../308956/index.html">Microsoft Azure StorSimple: easy access to hybrid cloud. Part 1</a></li>
<li><a href="../308958/index.html">In the new list of the most profitable IT companies in Russia, 50% of the seats are occupied by foreign firms.</a></li>
<li><a href="../308960/index.html">Optimization by example. Imitation annealing against the ant algorithm. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>