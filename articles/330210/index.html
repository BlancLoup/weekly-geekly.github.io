<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Deploying Redmine with Capistrano</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second part of my guide on how to administer Redmine independently in the long term. The first part was devoted to managing your own versi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Deploying Redmine with Capistrano</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/761/d30/060/761d30060a14488daa56d47dda08da25.jpg"></p><br><p>  This is the second part of my guide on how to administer Redmine independently in the long term.  The first part was devoted to <a href="https://habrahabr.ru/company/southbridge/blog/329872/">managing your own version of Redmine using Git</a> (link to translation). </p><br><p>  Having your own Redmine repository, the time has come ... </p><a name="habracut"></a><br><h2 id="avtomatizirovat-razvertyvanie">  Automate Deployment </h2><br><p>  Seriously.  Do not try to deploy the old-fashioned way by copying everything manually. </p><br><p>  Deployment automation is a one-time investment that pays off with the time and effort saved each time you need (well, or have to) upgrade Redmine.  The goal of automation is to make subsequent deployments as easy as possible.  Even the smallest correction or improvement can be performed instantly, because the automated update procedure is fast, reliable and can be started with a single command. </p><br><p>  I ask you to learn how to "pro" (that is, people who make a living by developing and running Rails applications, deploying their systems. And it doesn't matter if you are a local server administrator or a Python developer who is assigned to support Redmine in an organization. Over the past years, many smart people have spent a lot of time developing a set of tools that, after installing with one easy keystroke, reduces the downtime of Rails applications to zero. Such tools exist, they just need to be used  I. And quite possibly, you will learn a couple of new magic tricks that will be useful outside the context of Redmine. </p><br><h2 id="capistrano">  Capistrano </h2><br><p>  <a href="http://www.capistranorb.com/">Capistrano</a> is a <em>remote multi-server automation tool</em> ‚Äî the ideal choice when it comes to automating deployment.  It is embedded in Ruby, but is not limited to deploying Ruby or Rails applications.  With the help of Capistrano, it is really possible to automate all actions performed in SSH.  And this can be done on any number of servers in parallel.  As Chef is designed for server deployment, Capistrano is designed for system deployment, but it is much easier to use. </p><br><p>  I give a very brief introduction to the specifics of Redmine, you can read more at <a href="http://capistranorb.com/">capistranorb.com</a> .  <a href="">A readme</a> for this is a good starting point. </p><br><h2 id="ustanovka-capistrano">  Install capistrano </h2><br><p> In the <code>Redmine local/xy-stable</code> branch, create a file called <code>Gemfile.local</code> .  This will keep any gems <em>local</em> to the private installation of Redmine. </p><br><p>  <strong><em>Gemfile.local</em></strong> </p><br><pre> <code class="hljs vhdl"><span class="hljs-keyword"><span class="hljs-keyword">group</span></span> :development do # uncomment <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you<span class="hljs-symbol"><span class="hljs-symbol">'re</span></span> using modern (<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> secure!) ed25519 ssh keys # gem <span class="hljs-symbol"><span class="hljs-symbol">'net</span></span>-ssh', '<span class="hljs-number"><span class="hljs-number">4.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.alpha2' gem <span class="hljs-symbol"><span class="hljs-symbol">'capistrano</span></span>', '~&gt; <span class="hljs-number"><span class="hljs-number">3.4</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>' gem <span class="hljs-symbol"><span class="hljs-symbol">'capistrano</span></span>-rails', require: <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  After creating this file, run the <code>bundle install</code> command and add / fix both the <code>Gemfile.local</code> file and the appeared <code>Gemfile.lock</code> . </p><br><p>  Now run the <code>bundle exec cap install</code> command to configure Capistrano.  This will add several new files: <code>config/deploy.rb</code> and two files in the <code>config/deploy/</code> directory, which correspond to two default settings (or <em>"stages"</em> ) <em>"stages"</em> ).  If you have a separate Redmine installation for testing, for example, new plug-ins, then this will be your <em>"staging target"</em> , while the live (working) <em>stage</em> is <em>production</em> .  The basic idea is that everything common goes in <code>deploy.rb</code> , and different for different <code>deploy.rb</code> in the corresponding files in the <code>config/deploy</code> directory.  Most often, only the target host is indicated here and it is possible that another git branch or username is being configured for deployment. </p><br><h2 id="bazovaya-ustanovka-capistrano-dlya-redmine">  Basic installation of Capistrano for Redmine </h2><br><p>  Here is what the Capistrano minimum configuration might look like: </p><br><p>  <strong><em>config / deploy.rb</em></strong> </p><br><pre> <code class="hljs vhdl"># config valid only <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> current version <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Capistrano lock '<span class="hljs-number"><span class="hljs-number">3.4</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>' set :application, <span class="hljs-symbol"><span class="hljs-symbol">'redmine</span></span>' set :scm, :git set :repo_url, <span class="hljs-symbol"><span class="hljs-symbol">'git</span></span>@code.yourcompany.com:redmine.git' # Target directory <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the server. # Should exist <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> the user account you<span class="hljs-symbol"><span class="hljs-symbol">'re</span></span> using <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> deployment should # have write <span class="hljs-keyword"><span class="hljs-keyword">access</span></span>. set :deploy_to, '/srv/webapps/redmine' set :pty, <span class="hljs-literal"><span class="hljs-literal">true</span></span> set :log_level, :info # Linked files are expected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> exist below /srv/webapps/redmine/<span class="hljs-keyword"><span class="hljs-keyword">shared</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> will be # symlinked into the deployed # code. Create them either manually <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> through an # automation tool like chef. The reason <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> doing so <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> keep database # credentials <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> server secrets <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> your git repository. set :linked_files, fetch(:linked_files, []).push(<span class="hljs-symbol"><span class="hljs-symbol">'config</span></span>/database.yml', <span class="hljs-symbol"><span class="hljs-symbol">'config</span></span>/secrets.yml') # Directories <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> contents you want <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> keep across deployments are declared here. # Most important <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> files where Redmine stores any uploaded files. set :linked_dirs, fetch(:linked_dirs, []).push(<span class="hljs-symbol"><span class="hljs-symbol">'log</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'tmp</span></span>', <span class="hljs-symbol"><span class="hljs-symbol">'vendor</span></span>/bundle', <span class="hljs-symbol"><span class="hljs-symbol">'files</span></span>') # keep the last <span class="hljs-number"><span class="hljs-number">5</span></span> deployed versions <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the server. # Useful <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> you have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> revert <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> an older version. set :keep_releases, <span class="hljs-number"><span class="hljs-number">5</span></span> namespace :deploy do # Declares a task <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be executed once the <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> code <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the server. <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> :updated, :plugin_assets do <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> roles(:app) do within release_path do <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> rails_env: fetch(:rails_env) do # Copy over plugin assets execute :rake, <span class="hljs-symbol"><span class="hljs-symbol">'redmine</span></span>:plugins:assets' # Run plugin migrations execute :rake, <span class="hljs-symbol"><span class="hljs-symbol">'redmine</span></span>:plugins:migrate' <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # This will run <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> the deployment finished <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> used <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> reload # the application. You most probably have <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> change that depending <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> # your server setup. <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> :published, :restart do <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> roles(:app) do sudo <span class="hljs-string"><span class="hljs-string">"/etc/init.d/unicorn reload redmine"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> # cleans up old versions <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> the server (keeping the number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> releases # configured above) <span class="hljs-keyword"><span class="hljs-keyword">after</span></span> :finished, <span class="hljs-symbol"><span class="hljs-symbol">'deploy</span></span>:cleanup' <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  It remains only to configure the server to which you intend to deploy a Capistrano user to log in to this server and branch for deployment: </p><br><p>  <strong><em>config / deploy / production.rb</em></strong> </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> :branch, <span class="hljs-string"><span class="hljs-string">'local/3.2-stable'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-string"><span class="hljs-string">'redmine.yourcompany.com'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: <span class="hljs-string"><span class="hljs-string">'deploy'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">roles</span></span>: %w{web app db}</code> </pre> <br><p>  If you are using the same machine for testing and production, simply transfer the <code>deploy_to</code> parameter to the <em>stage</em> configuration files to be able to set a separate directory for each <em>stage</em> .  Don't forget to add and commit the Gemfile.local, Gemfile.lock and the Capistrano configuration you just configured.  These files are part of the custom Redmine and should be saved with it in the version control system. </p><br><p>  If you are using <em>Git</em> submodules to add plugins or themes for Redmine, look at the <a href="https://github.com/ekho/capistrano-git-submodule-strategy">Capitrano Git submodules strategy</a> to automatically deploy them too. </p><br><h2 id="autentifikaciya">  Authentication </h2><br><p>  Capistrano uses SSH and relies on properly configured key-based authentication.  This is also very useful when using any SSH agent or redirecting agents to access the git repository through the deployment server with its local key. </p><br><p>  Be sure to read the <a href="http://capistranorb.com/documentation/getting-started/authentication-and-authorisation/">‚ÄúAuthentication and Authorization‚Äù</a> chapter in the Capistrano Manual. </p><br><h2 id="zapustit">  Run! </h2><br><p>  Now that everything is in place, it's time for the first deployment: </p><br><pre> <code class="hljs bash">$ bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cap</span></span> production deploy</code> </pre> <br><p>  If you set everything up correctly, this command will deploy Redmine for you.  Usually, failures happen because of permissions or authentication problems, but in most cases they are easy to fix. </p><br><h2 id="ssylki">  Links </h2><br><ol><li>  <a href="https://jkraemer.net/2016/04/deploying-redmine-with-capistrano">Deploying Redmine with Capistrano</a> . </li><li>  <a href="https://jkraemer.net/2016/03/deploy-and-maintain-redmine-the-right-way">Deploy and maintain Redmine the right way</a> . </li><li>  <a href="https://habrahabr.ru/company/southbridge/blog/329872/">Deploying and maintaining Redmine, the right way</a> . </li></ol></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330210/">https://habr.com/ru/post/330210/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330196/index.html">Concepts: set, type, attribute</a></li>
<li><a href="../330198/index.html">Useful utilities when working with Kubernetes</a></li>
<li><a href="../330204/index.html">Preventing Negative Impacts when Developing Artificial Intelligence Systems Beating the Human Mind</a></li>
<li><a href="../330206/index.html">Creating a design ecosystem for dozens of related IT solutions: a word to designers</a></li>
<li><a href="../330208/index.html">Understanding the new architectural components in Android</a></li>
<li><a href="../330214/index.html">The universal function of creating objects on the example of the implementation of $ injector.instantiate in angularjs</a></li>
<li><a href="../330216/index.html">Results of half a day! Break voting on RIT ++ for 50 stickers. Day two</a></li>
<li><a href="../330218/index.html">We roll the "resin ball" or create your own assembly rules using Qbs</a></li>
<li><a href="../330220/index.html">The append (x) .append (y) call chain in StringBuilder is faster than typical sb.append (x); sb.append (y)</a></li>
<li><a href="../330222/index.html">"MDM vs CRM" or who will help sell more?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>