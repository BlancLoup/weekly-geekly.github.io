<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Resurrection Sharepoint or how not to burn at the stake of the Inquisition</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What if one day you find that your favorite Sharepoint site is not available and all that is left of it is a content base that you cannot attach to th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Resurrection Sharepoint or how not to burn at the stake of the Inquisition</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cd8/fdf/0cc/cd8fdf0ccba029dd3d8b4037255d7c3f.jpg" alt="image"><br><br>  What if one day you find that your favorite Sharepoint site is not available and all that is left of it is a content base that you cannot attach to the Sharepoint server?  How to restore the "trillion" of the most important documents stored in the Sharepoint database?  A short sad story and answers to these questions can be found in this article. <br><a name="habracut"></a><br>  In one not the most beautiful morning I happened to face the situation described in Todd Klindt <a href="http://www.osp.ru/win2000/2012/01/13015207/">‚Äôs</a> article <a href="http://www.osp.ru/win2000/2012/01/13015207/">‚ÄúRecovering SharePoint 2010 in emergency situations.</a>  <a href="http://www.osp.ru/win2000/2012/01/13015207/">Part 2</a> : <br><blockquote>  Suppose you have a typical small farm consisting of one SQL Server system and one SharePoint server.  As a good SQL Server administrator, you make copies of all databases every night.  One fine morning you come and hear the cries of users: ‚ÄúSharePoint collapsed!‚Äù.  After drinking a cup of coffee, you are trying to connect to SharePoint and understand that it really refused.  And not only SharePoint, but the entire server.  You can not connect to the server via RDP, it does not respond to requests for ping - this is a clear death.  You rush to the server room and see that the SharePoint server is frozen on the download screen, because it cannot find the hard disk from which this download should be performed.  Whatever the disk subsystem, whether one disk, RAID 1 or RAID 5, all this can break.  The server and all the content on it disappeared.  What do you do other than to look in your pocket for a flash drive with your resume ?! <br>  In fact, this is not a serious type of emergency, as only your SharePoint server crashed.  Although the SharePoint server is an important part of the SharePoint system, SQL Server is just as important, so you can take advantage of the SQL Server system to quickly fix the situation.  You need to make the server work either with the help of a new server, or by repairing what was broken in the existing server, and then reinstall Windows and download all the updates, complete the settings and join the domain.  Then you need to reinstall SharePoint.  After all the prerequisites have been met and the SharePoint files are installed, you should run the SharePoint Products Configuration Wizard. <br>  That's exactly where the "magic".  Instead of building a new SharePoint farm, you can simply connect to an existing farm.  When you are asked which farm to connect to, specify the existing SQL Server system and the SharePoint configuration database that this system contains.  Armed with the information contained in your farm's configuration database, a newly built SharePoint server can access existing web applications and start their maintenance almost immediately.  SharePoint uses scheduled tasks to create the environment that is needed to serve content.  Your web applications will be created in Microsoft IIS using these targets.  The solutions that were installed in your farm will be installed on the new server using these tasks.  When the configuration parameters are set, it may be necessary to clean up some trivialities, but these tasks are nothing compared with the server recovery performed after a complete crash. <br></blockquote><br><br>  Sighing with relief, I thought - this is the solution to the problem, but my case was not simple and the ‚Äúmagic‚Äù did not happen, I could not connect to the existing SQL server and tighten the configuration database.  The SharePoint Import Wizard assured me in every way that the configuration database is not valid and nothing can be done.  It was also not possible to convince SharePoint of the opposite (as it turned out later, this SharePoint server was obtained by migrating from the SharePoint version of 2007 and even then it was not without dances with a tambourine). <br>  At this point, it became clear that the "resurrection" of SharePoint was delayed, and the user with torches and forks was already on the way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Half an hour of google tormenting various requests for SharePoint disaster recovery led me to Mike Smith's article <a href="http://techtrainingnotes.blogspot.ru/2007/12/exploring-sharepoint-cmp-backup-files.html">‚ÄúExploring SharePoint CMP Export Files‚Äù from the</a> blog ‚ÄúMike Smith's Tech Training Notes‚Äù. <br><br>  The article describes the process of exporting content from an unattached Sharepoint database (export is done to * .cmp files), as well as the process of extracting the necessary documents from * .cmp files.  The article also includes the compiled program and the source code of the project, which automatically unpacks cmp files and then extracts documents from them.  The ability to quickly recover documents that users really need right here and right now is not bad.  So I thought, launching the just downloaded program and mentally giving praise to its author.  But here, too, an unpleasant surprise awaited me ‚Äî when trying to retrieve documents, the program ended with an error of addressing to a nonexistent memory address.  One thing was pleasing - the algorithm described in the article for manually extracting documents from cmp files worked so that it was determined empirically.  The process consists in the following sequence of actions: <br><br><ul><li>  Export the necessary section of the site from the unlinked content database (output file in cmp format). </li><li>  Change the extension of the resulting file from cmp to cab and extract all files from it using the built-in Windows tools. </li><li>  Open the manifest.xml file, search the line with the name of the document of interest, find the value of the FileValue attribute in the found section </li><li>  Rename the dat file corresponding to the value of the FileValue attribute to the document of interest. </li></ul><br><br>  Extracting several thousand files manually seemed to me somewhat unproductive (finding and fixing the error that caused the Mike Smith program to work incorrectly also turned out to be not a trivial task for me), so it was decided to write a small console program in C # that performs the required operations.  In my case, the algorithm of actions was as follows: <br><br><ul><li>  Export the necessary section of the site from the unlinked content database (output file in cmp format). </li><li>  Change the extension of the resulting file from cmp to cab and extract all files from it using the built-in Windows tools. </li><li>  Delete all xml files except manifest.xml. </li><li>  Copy the program to the directory with the unpacked files, run it and wait until all the files are processed. </li></ul><br><br>  The program operates according to the following algorithm: <br><br><ul><li>  The manifest.xml is read. For each dat file in the current directory, the corresponding document name is searched in the manifest.xml.Dat file is copied with the original document name. The dat file is deleted. <br><br>  Source code of the program: <br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Windows.Forms; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading.Tasks; namespace SertConsole { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { try { //=========================================================== <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.<span class="hljs-keyword"><span class="hljs-keyword">Exists</span></span>("Manifest.xml")) { Console.WriteLine(" Manifest.xml "); //=========================================================== string ManifestXML = <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO.File.ReadAllText(@"Manifest.xml"); Console.WriteLine(" Manifest.xml "); //=========================================================== DirectoryInfo dir = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DirectoryInfo(Directory.GetCurrentDirectory() + "\\"); FileInfo[] DatFiles = dir.GetFiles("*.dat"); Console.WriteLine(" dat : " + DatFiles.Length); //=========================================================== <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; DatFiles.Length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.<span class="hljs-keyword"><span class="hljs-keyword">Exists</span></span>(GetNameFromDat(ManifestXML, DatFiles[i].Name))) { File.<span class="hljs-keyword"><span class="hljs-keyword">Move</span></span>(DatFiles[i].Name, GetFreeName(GetNameFromDat(ManifestXML, DatFiles[i].Name))); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { File.<span class="hljs-keyword"><span class="hljs-keyword">Move</span></span>(DatFiles[i].Name, GetNameFromDat(ManifestXML, DatFiles[i].Name)); } File.<span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span>(DatFiles[i].Name); Console.WriteLine(": " + DatFiles[i].Name + " -&gt; " + GetNameFromDat(ManifestXML, DatFiles[i].Name)); } Console.WriteLine(" ,    ..."); Console.ReadLine(); } } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> ex) { MessageBox.<span class="hljs-keyword"><span class="hljs-keyword">Show</span></span>("  :" + "\r\n\r\n" + ex.ToString(), "     ", MessageBoxButtons.OK,MessageBoxIcon.Error); } } //<span class="hljs-comment"><span class="hljs-comment">------------------------------------------------------------------------------------------- static string GetNameFromDat(string XMLString, string FileName) { string result = ""; int FileNamePos = XMLString.LastIndexOf(FileName); for (int i = FileNamePos-11; i &gt; 0; i--) { if (XMLString.Substring(i, 5) == "Name=") { for (int j = i+6; j &lt; FileNamePos-11; j++) { if (XMLString[j] == '"') { result = XMLString.Substring(i + 6, j - (i + 6)); goto to_Out; } } } } to_Out: return result; } //------------------------------------------------------------------------------------------- static string GetFreeName(string FileName) { string result = FileName; int count = 0; do { result = count.ToString() + "_" + FileName; count++; } while (File.Exists(result) == true); return result; } } }</span></span></code> </pre> <br><br>  Of course, the program is primitive and can cause a lot of complaints from any programmer, but the operation to cope with its task of automating routine tasks.  I hope that the information described in the article will not be useless and will find its reader.  Links to the compiled program and project files (used by Visual Studio Express 2013 for Desktop) are attached: <br><br>  <a href="https://drive.google.com/file/d/0B1Z8vw2pq4e-NTlta0pfZU9GYW8/edit%3Fusp%3Dsharing">Compiled program.</a> <br>  <a href="https://drive.google.com/file/d/0B1Z8vw2pq4e-ZURYQ2JEMTItUnM/edit%3Fusp%3Dsharing">Project VisualStudio 2013.</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/210818/">https://habr.com/ru/post/210818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../210800/index.html">DUMP-2014 will be held in Yekaterinburg on March 14</a></li>
<li><a href="../210808/index.html">We are not building our analogue Google Calendar in 30 lines</a></li>
<li><a href="../210812/index.html">Method of comparing algorithms and for what it may still be useful</a></li>
<li><a href="../210814/index.html">We do automatic watering of a room flower on Arduino in 15 minutes</a></li>
<li><a href="../210816/index.html">Creating and using Matlab clusters</a></li>
<li><a href="../210820/index.html">About using $ .Deferred to work with asynchronous tasks</a></li>
<li><a href="../210822/index.html">Better to lose a day, and then teleport wherever you want and how much you want</a></li>
<li><a href="../210824/index.html">Splitting web pages into semantic blocks</a></li>
<li><a href="../210826/index.html">About comparing and optimizing keyboard layouts</a></li>
<li><a href="../210828/index.html">Nanex: A Nightmare on Elm Street for High-Speed ‚Äã‚ÄãTrading, Part 4</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>