<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Checking the OpenJDK project with PVS-Studio</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Coauthor: Roman Fomichev. 

 Currently, many projects open their source code and allow the developer community to make changes in it. We will check on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Checking the OpenJDK project with PVS-Studio</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1f2/743/50c/1f274350c30f58cb53ee51d15aadb558.png" align="left">  Coauthor: Roman Fomichev. <br><br>  Currently, many projects open their source code and allow the developer community to make changes in it.  We will check one of these projects - OpenJDK, and help developers improve their code. <br><br><h2>  Introduction </h2><br>  <a href="http://openjdk.java.net/">OpenJDK</a> (Open Java Development Kit) - a project to create an implementation of the Java platform (Java SE), consisting entirely of free and open source.  The project started in 2006 through the efforts of Sun.  The project uses several languages ‚Äã‚Äã- C, C ++ and Java.  We are interested in source codes written in C and C ++.  For verification, take the 9th version of OpenJDK.  The code for this Java implementation of the platform is available in <a href="http://hg.openjdk.java.net/jdk9">the Mercurial repository</a> . <br><a name="habracut"></a><br>  The project was tested using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> static code analyzer.  It implements many diagnostic rules that allow you to find a large number of errors made during programming, including those that are difficult to detect with a simple view of the code.  Some of these errors do not affect the logic of the program, and some can lead to dire consequences during the execution of the program.  On the analyzer website there are <a href="http://www.viva64.com/ru/examples/">examples of errors</a> found in other projects.  Projects that use C, C ++, and C # are available for analysis.  You can download a trial version of the analyzer by the <a href="http://www.viva64.com/ru/pvs-studio-download/">link</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Errors in logical expressions </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9b3/282/9b3/9b32829b3a12f9f315942acbe6303e38.png"></div><br><br>  First, consider the errors in logical expressions: <br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> StubAssembler::call_RT(....) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _LP64 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// if there is any conflict use the stack if (arg1 == c_rarg2 || arg1 == c_rarg3 || arg2 == c_rarg1 || arg1 == c_rarg3 || arg3 == c_rarg1 || arg1 == c_rarg2) { .... }</span></span></span></span></code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V501 There are identical sub-expressions 'arg1 == c_rarg3'  operator.  c1_Runtime1_x86.cpp 174 <br><br>  The analyzer reports a duplicate check <i>arg1 == c_rarg3.</i>  In this snippet, there is either a redundant check or, much worse, a logical error.  Perhaps, instead of the duplicated condition, something else should be checked.  It makes sense for developers to take a closer look at this code. <br><br>  In the same condition there is one more repeated expression <i>arg1 == c_rarg2</i> : <br><br>  <b>PVS-Studio</b> warning <b>:</b> V501 There are identical sub-expressions 'arg1 == c_rarg2'  operator.  c1_Runtime1_x86.cpp 174 <br><br>  These warnings particularly well demonstrate the need to use a static analyzer.  In a large number of similar expressions it is very easy to make a mistake that is difficult to detect when superficially viewing the code. <br><br>  In the following snippet, a ‚Äúnon-ideal‚Äù test was found in the condition of the <i>Ideal</i> method: <br><pre> <code class="cpp hljs">Node *AddLNode::Ideal(PhaseGVN *phase, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> can_reshape) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( op2 == Op_AddL &amp;&amp; in2-&gt;in(<span class="hljs-number"><span class="hljs-number">1</span></span>) == in1 &amp;&amp; op1 != Op_ConL &amp;&amp; <span class="hljs-number"><span class="hljs-number">0</span></span> ) { .... }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V560 A part of conditional expression is always false: 0. addnode.cpp 435 <br><br>  It is rather strange to use 0 in a logical expression. Most likely, this code fragment is still under development and the condition was made impossible to debug.  There are no corresponding comments in the code, and in this case there is a high probability of forgetting to correct the code in the future.  The result of this error will be that everything that is inside this condition will never be executed, since the result of evaluating a logical expression will always be false. <br><br><h2>  Priorities for operations </h2><br>  Quite often, programmers rely on their knowledge of priorities and do not single out the component parts of a complex expression in parentheses: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Method)/wordSize + is_native() ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V502 Perhaps the '?:' Operator works in a different way.  The '?:' Operator has a lower limit than the '+' operator.  method.hpp 249 <br><br>  In this case, I do not know the specifics of the code, but there is a suspicion that the function planned to choose the offset value '2' or '0' depending on the result of the is_native () function call, but the expression has a different order of evaluation.  First, <i>sizeof (Method) / wordSize + is_native ()</i> will be <i>added</i> , and then the result will be 2 or 0. Most likely, the code should look like this: <br><pre> <code class="cpp hljs">{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Method)/wordSize + (is_native() ? <span class="hljs-number"><span class="hljs-number">2</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br>  This is a very common error with priority operations.  In the database of errors found by the analyzer, the most popular of them were identified and given in the article: <a href="http://www.viva64.com/ru/b/0390/">Logical expressions in C / C ++.</a>  <a href="http://www.viva64.com/ru/b/0390/">How wrong are the professionals</a> . <br><br><h2>  Copy paste </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8b4/45d/673/8b445d673eed2305780cdcbd12c4c7ff.png"></div><br><br>  The next characteristic error group is related to copying code.  One cannot get away from this favorite method of programmers, so we explore the places where copy paste was applied: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setImageHints</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dstCMP-&gt;isDefaultCompatCM) { hintP-&gt;allocDefaultDst = FALSE; hintP-&gt;cvtToDst = FALSE; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dstCMP-&gt;isDefaultCompatCM) { hintP-&gt;allocDefaultDst = FALSE; hintP-&gt;cvtToDst = FALSE; } .... }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V517 The use of if (A) {...} else if (A) {...} 'pattern was detected.  There is a possibility of logical error presence.  Check lines: 1873, 1877. awt_ImagingLib.c 1873 <br><br>  In this example, the conditions in <i>if</i> and <i>else if are</i> completely identical, and the code that must be executed.  The second condition is completely meaningless, it will never be executed. <br><br>  Another similar case: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expandPackedBCR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, RasterS_t *rasterP, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> component, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *outDataP)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">/* Convert the all bands */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rasterP-&gt;numBands &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Need to put in alpha */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (y=<span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; rasterP-&gt;height; y++) { inP = lineInP; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (x=<span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; rasterP-&gt;width; x++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c=<span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; rasterP-&gt;numBands; c++) { *outP++ = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (((*inP&amp;rasterP-&gt;sppsm.maskArray[c]) &gt;&gt; roff[c]) &lt;&lt;loff[c]); } inP++; } lineInP += rasterP-&gt;scanlineStride; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (y=<span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; rasterP-&gt;height; y++) { inP = lineInP; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (x=<span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; rasterP-&gt;width; x++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (c=<span class="hljs-number"><span class="hljs-number">0</span></span>; c &lt; rasterP-&gt;numBands; c++) { *outP++ = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) (((*inP&amp;rasterP-&gt;sppsm.maskArray[c]) &gt;&gt; roff[c]) &lt;&lt;loff[c]); } inP++; } lineInP += rasterP-&gt;scanlineStride; } } .... }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V523 The 'then' statement is equivalent to the 'else' statement.  awt_ImagingLib.c 2927 <br><br>  The executable code in both blocks is identical, respectively, there is no difference what is calculated in the condition.  It makes sense to look at this place and remove the unnecessary branch or, if different logic was meant, adjust the code to eliminate duplication. <br><br>  There are two more places with identical duplication.  Just point them out, without casting the code: <ul><li>  V523 The 'then' statement is equivalent to the 'else' statement.  awt_ImagingLib.c 3111 </li><li>  V523 The 'then' statement is equivalent to the 'else' statement.  awt_ImagingLib.c 3307 </li></ul><br><br>  Well, the last interesting example associated with a possible copy paste error: <br><br><pre> <code class="cpp hljs">Node* GraphKit::record_profiled_receiver_for_speculation(Node* n) { .... ciKlass* exact_kls = profile_has_unique_klass(); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> maybe_null = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (java_bc() == Bytecodes::_checkcast || java_bc() == Bytecodes::_instanceof || java_bc() == Bytecodes::_aastore) { ciProfileData* data = method()-&gt;method_data()-&gt;bci_to_data(bci()); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> maybe_null = data == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : &lt;== data-&gt;as_BitData()-&gt;null_seen(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> record_profile_for_speculation(n, exact_kls, maybe_null); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n; }</code> </pre> <br>  <b>PVS-Studio Warning:</b> V561 It's not better to declare it maybe.  Previous declaration: graphKit.cpp, line 2170. graphKit.cpp 2175 <br><br>  What happens in this code?  Before the <i>if</i> block, the variable <i>bool maybe_null = true;</i>  .  Then, when the code is executed in the <i>if</i> block <i>, a</i> variable with the same name is declared.  After exiting the block, the value of this variable will be lost, and the call to the function using this variable will in any case be <i>true</i> .  It is good if this variable was duplicated for debugging purposes.  Otherwise, this code is executed incorrectly and requires modification: <br><pre> <code class="cpp hljs">maybe_null = data == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ? <span class="hljs-literal"><span class="hljs-literal">true</span></span> : data-&gt;as_BitData()-&gt;null_seen();</code> </pre> <h2>  Work with pointers </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b59/e83/5bd/b59e835bd69b53954747b641da39818b.png"></div><br><br>  Working with pointers requires care and accuracy, since incorrect use of pointers can cause errors that will be difficult to identify.  As a rule, the main danger is the use of broken pointers or the use of pointers without checking for zero value. <br><br>  First consider the case of explicit use of the null pointer: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> jint JNICALL </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cbObjectTagInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(....)</span></span></span><span class="hljs-function"> </span></span>{ ClassInstancesData *data; <span class="hljs-comment"><span class="hljs-comment">/* Check data structure */</span></span> data = (ClassInstancesData*)user_data; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { data-&gt;error = AGENT_ERROR_ILLEGAL_ARGUMENT; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JVMTI_VISIT_ABORT; } .... }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V522 Dereferencing of the null pointer 'data' might take place.  util.c 2424 <br><br>  A completely incomprehensible code using a null pointer may cause the program to crash.  Perhaps, this thread never worked, thanks to which it was possible to avoid problems when the program is running.  In the same file there were three more similar places: <ul><li>  V522 Dereferencing of the null pointer 'data' might take place.  util.c 2543 </li><li>  V522 Dereferencing of the null pointer 'data' might take place.  util.c 2601 </li><li>  V522 Dereferencing of the null pointer 'data' might take place.  util.c 2760 </li></ul><br><br>  But in the following cases, the possibility of using a null pointer is hidden deeper.  This is a very common situation, such warnings are found in almost all checked projects: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> jboolean </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visibleClasses</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PacketInputStream *in, PacketOutputStream *out)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)outStream_writeInt(out, count); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { jbyte tag; jclass clazz; clazz = classes[i]; &lt;== tag = referenceTypeTag(clazz); (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)outStream_writeByte(out, tag); (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)outStream_writeObjectRef(env, out, clazz); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( classes != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) &lt;== jvmtiDeallocate(classes); .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JNI_TRUE; }</code> </pre><br>  <b>PVS-Studio</b> warning: V595 The 'classes' pointer was used before it was verified against nullptr.  Check lines: 58, 66. ClassLoaderReferenceImpl.c 58 <br><br>  In the lower block, the pointer is checked for a zero value, which means that the programmer assumes the possibility that the pointer value will be zero.  But in the block above, the pointer is used without checking.  Accordingly, if the pointer value is zero, then such a check will not help us, and we will get a program crash.  To correct this error, you need to check the pointer above both blocks. <br><br>  I will give one more similar example: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> InstructForm::needs_base_oop_edge(FormDict &amp;globals) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( is_simple_chain_rule(globals) ) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *src = _matrule-&gt;_rChild-&gt;_opType; OperandForm *src_op = globals[src]-&gt;is_operand(); assert( src_op, <span class="hljs-string"><span class="hljs-string">"Not operand class of chain rule"</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> src_op-&gt;_matrule ? src_op-&gt;_matrule-&gt;needs_base_oop_edge() : <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Else check instruction return _matrule ? _matrule-&gt;needs_base_oop_edge() : 0; }</span></span></code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V595 The '_matrule' pointer was used against nullptr.  Check lines: 3534, 3540. formssel.cpp 3534 <br><br>  Here, the pointer is checked from below in the ternary operator - <i>_matrule?</i>  <i>_matrule-&gt; needs_base_oop_edge (): 0 ;.</i>  And the above is a simple reference to this pointer - <i>const char * src = _matrule -&gt; _ rChild -&gt; _ opType ;.</i>  The recipe for correction is similar: you need to check the pointer before using it.  There are quite a few such places, I will give them a list: <ul><li>  V595 The '_pipeline' pointer was used before it was verified against nullptr.  Check lines: 3265, 3274. output_c.cpp 3265 </li><li>  V595 The 'index_bound' pointer was used before it was verified against nullptr.  Check lines: 790, 806. c1_RangeCheckElimination.cpp 790 </li><li>  V595 The 'g_type_init' pointer was used before it was verified against nullptr.  Check lines: 94, 108. GioFileTypeDetector.c 94 </li><li>  V595 The 'classArray' pointer was used before it was verified against nullptr.  Check lines: 1169, 1185. JPLISAgent.c 1169 </li><li>  V595 The 'q' pointer has been verified against nullptr.  Check lines: 594, 599. mpi.c 594 </li><li>  V595 The 'info.waiters' pointer was used before it was verified against nullptr.  Check lines: 224, 228. ObjectReferenceImpl.c 224 </li><li>  It was verified against nullptr.  Check lines: 225, 229. ReferenceTypeImpl.c 225 </li><li>  It was verified against nullptr.  Check lines: 433, 437. ReferenceTypeImpl.c 433 </li><li>  V595 The 'nested' pointer was used before it was verified nullptr.  Check lines: 538, 540. ReferenceTypeImpl.c 538 </li><li>  V595 The 'interfaces'  Check lines: 593, 595. ReferenceTypeImpl.c 593 </li><li>  V595 'bu f pointer pointer pointer  Check lines: 265, 266. ps_proc.c 265 </li><li>  V595 The 'monitors'  Check lines: 382, ‚Äã‚Äã387. ThreadReferenceImpl.c 382 </li><li>  V595 The 'monitors'  Check lines: 557, 560. ThreadReferenceImpl.c 557 </li><li>  V595 The 'signature' pointer has been verified against nullptr.  Check lines: 520, 526. debugInit.c 520 </li><li>  V595 The BlackPoint  Check lines: 192, 208. cmssamp.c 192 </li><li>  V595 The 'nativename' pointer was used before it was verified against nullptr.  Check lines: 506, 511. awt_Font.c 506 </li><li>  V595 The 'pseq-&gt; seq' pointer was used before it was verified against nullptr.  Check lines: 788, 791. cmsnamed.c 788 </li><li>  V595 The 'GammaTables' pointer was used before it was verified against nullptr.  Check lines: 1430, 1434. cmsopt.c 1430 </li></ul><br><br>  Sometimes programmers check pointers on the contrary, but they do it incorrectly: <br><pre> <code class="cpp hljs">FileBuff::FileBuff( BufferedFile *fptr, ArchDesc&amp; archDesc) : _fp(fptr), _AD(archDesc) { .... _bigbuf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[_bufferSize]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( !_bigbuf ) { file_error(SEMERR, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">"Buffer allocation failed\n"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); .... }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V668 against using b b allocated allocated allocated allocated allocated allocated...  The exception will be generated in the case of memory allocation error.  filebuff.cpp 47 <br><br>  In this case, checking the _bigbuf pointer to zero after using new is meaningless.  If the system fails to allocate memory, an exception will be generated and the function will stop.  To correct the error, you can use several approaches.  Make a memory allocation in a <i>try catch block</i> , or use the <i>new (std :: nothrow)</i> construction to allocate memory, which will not generate an exception in case of failure.  There are several more such incorrect checks: <ul><li>  V668 has been allocated using the 'new' operator.  The exception will be generated in the case of memory allocation error.  psParallelCompact.cpp 455 </li><li>  V668 allocated P P P P allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated allocated  The exception will be generated in the case of memory allocation error.  jni.cpp 113 </li></ul><br><br>  The last error in working with pointers was made when explicitly casting a pointer of one type to a pointer of another type: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">mlib_status </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mlib_convMxNext_f32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ mlib_d64 dspace[<span class="hljs-number"><span class="hljs-number">1024</span></span>], *dsa = dspace; .... mlib_f32 *fsa; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span> * wid_e + m &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>) { dsa = mlib_malloc((<span class="hljs-number"><span class="hljs-number">3</span></span> * wid_e + m) * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(mlib_d64)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dsa == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MLIB_FAILURE; } fsa = (mlib_f32 *) dsa; &lt;== .... }</code> </pre> <br>  <b>PVS-Studio</b> warning: V615 An odd explicit conversion from 'double *' type to 'float *' type.  mlib_ImageConvMxN_Fp.c 294 <br><br>  A pointer to float <i>mlib_f32 * fsa is</i> attempted to assign a pointer to double <i>mlib_d64 dspace [1024], * dsa = dspace</i> .  The types float and double have a different size and similar type conversion is most likely erroneous.  The mismatch of the sizes of the types given will result in the <i>fsa</i> pointer pointing to the number format incorrect for the float type. <br><br>  In another file there are two more such similar conversions, you need to carefully check this code and use the correct type conversions. <ul><li>  V615 An odd explicit conversion from 'double *' type to 'float *' type.  mlib_ImageLookUp_Bit.c 525 </li><li>  V615 An odd explicit conversion from 'double *' type to 'float *' type.  mlib_ImageLookUp_Bit.c 526 </li></ul><br>  This concludes the consideration of errors associated with the use of pointers and examines the remaining warnings of the analyzer. <br><br><h2>  Mistakes </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b4/e25/b03/7b4e25b03f78e135e4ddb623168741e3.png"></div><br><br>  The following error is probably also the result of a failed copy of the code: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_bool</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **pp, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *end, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv)</span></span></span><span class="hljs-function"> </span></span>{ .... <span class="hljs-comment"><span class="hljs-comment">/* CSS allows on/off as aliases 1/0. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*pp - p == <span class="hljs-number"><span class="hljs-number">2</span></span> || <span class="hljs-number"><span class="hljs-number">0</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span> (p, <span class="hljs-string"><span class="hljs-string">"on"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)) *pv = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*pp - p == <span class="hljs-number"><span class="hljs-number">3</span></span> || <span class="hljs-number"><span class="hljs-number">0</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span> (p, <span class="hljs-string"><span class="hljs-string">"off"</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>)) *pv = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V666 Consider the third argument of the function 'strncmp'.  This is not the case.  hb-shape.cc 104 <br><br>  Here is the case when the error does not affect the performance of the program.  Instead of comparing three characters, only the first two are compared, I do not exclude that the author of the code can and specifically made such a check.  Since the value in the buffer <i>p</i> can be on or off, it is sufficient to compare the first two characters.  But for order, you can still adjust the code: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (*pp - p == <span class="hljs-number"><span class="hljs-number">3</span></span> || <span class="hljs-number"><span class="hljs-number">0</span></span> == <span class="hljs-built_in"><span class="hljs-built_in">strncmp</span></span> (p, <span class="hljs-string"><span class="hljs-string">"off"</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>))</code> </pre> <br>  There are several places where errors are possible when implementing classes: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProductionState</span></span></span><span class="hljs-class"> {</span></span> .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: <span class="hljs-comment"><span class="hljs-comment">// Disable public use of constructor, copy-ctor, ... ProductionState( ) : _production(cmpstr, hashstr, Form::arena) { assert( false, "NotImplemented"); }; ProductionState( const ProductionState &amp; ) : _production(cmpstr, hashstr, Form::arena) { assert( false, "NotImplemented"); }; // Deep-copy };</span></span></code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V690 Copy, it will be generated by the compiler.  It is dangerous to use such a class.  dfa.cpp 76 <br><br>  In this class, they tried to prohibit copying, but forgot to add a copy statement to the private area.  It will be generated by default and will be available for use.  Even if now this code is not used anywhere in the code, then there is no guarantee that in the future someone will accidentally call it.  When such an operator is called, a post-entry copy will occur for a class that should not be copied.  This can lead to various effects up to a program crash.  In this case, add the statement "=" to the private area. <br><br>  There are two more classes where there are similar problems; it is advisable to correct them in such a way as not to violate the ‚Äú <a href="http://www.artima.com/cppsource/bigtwo.html">Law of the Big Two</a> ‚Äù. <ul><li>  V690 The 'MemRegion' class implements a copy constructor, but lacks the '=' operator.  It is dangerous to use such a class.  memRegion.hpp 43 </li><li>  If you‚Äôre still in the ‚ÄúLabel‚Äù class, you‚Äôll still be generated by the compiler.  It is dangerous to use such a class.  assembler.hpp 73 </li></ul><br><br>  The last error looks like a simple typo: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> os::start_debugging(<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> buflen) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> len = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)<span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(buf); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *p = &amp;buf[len]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (yes) { <span class="hljs-comment"><span class="hljs-comment">// yes, user asked VM to launch debugger jio_snprintf(buf, sizeof(buf), "gdb /proc/%d/exe %d", os::current_process_id(), os::current_process_id()); os::fork_and_exec(buf); yes = false; } return yes; }</span></span></code> </pre> <br>  <b>PVS-Studio</b> warning <b>:</b> V579  It is possibly a mistake.  Inspect the second argument.  os_linux.cpp 6094 <br><br>  The programmer wanted to pass the length of the buffer, but did not take into account that it is not a locally declared array, but a pointer coming in the function argument.  As a result of evaluating the expression <i>sizeof (buf),</i> we get not the length of the buffer, but the size of the pointer, which will be 4 or 8 bytes.  It is easy to correct the error, as the above buffer length has already been obtained: <i>int len ‚Äã‚Äã= (int) strlen (buf) ;.</i>  The correct option would be as follows: <br><pre> <code class="cpp hljs">jio_snprintf(buf, len ....</code> </pre> <h2>  Conclusion </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/caf/fbb/ba9/caffbbba951e060cb3e851a0779eafea.png"></div><br><br>  It is always interesting to check a project that uses a lot of people and monitors its quality.  There was a sufficiently large number of errors, only a certain number of them were described in this article, the rest require more in-depth research.  The errors found once again confirm the effectiveness of using a static analyzer, as it allows you to detect errors that are difficult to detect when viewed with the simple eye.  It is best to use the analyzer on an ongoing basis, as it will save a lot of time that would have been spent debugging the program when searching for bugs.  I remind you that you can try the work of the PVS-Studio static analyzer on your project by downloading its <a href="http://www.viva64.com/ru/pvs-studio-download/">trial version</a> . <br><br><div style="text-align:center;"> <a href="http://www.viva64.com/en/b/0404/"><img src="https://habrastorage.org/getpro/habr/post_images/35e/064/ddf/35e064ddf91f5d99b620384893909ff7.png"></a> </div><br>  If you want to share this article with an English-speaking audience, then please use the link to the translation: Svyatoslav Razmyslov.  <a href="http://www.viva64.com/en/b/0404/">OpenJDK check by PVS-Studio</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Read the article and have a question?</b> <div class="spoiler_text">  Often our articles are asked the same questions.  We collected answers to them here: <a href="http://www.viva64.com/ru/a/0085/">Answers to questions from readers of articles about PVS-Studio, version 2015</a> .  Please review the list. <br></div></div></div><p>Source: <a href="https://habr.com/ru/post/303534/">https://habr.com/ru/post/303534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303522/index.html">Validation of Fuel Plugins within the Mirantis Unlocked validation program. Do you need it?</a></li>
<li><a href="../303524/index.html">The experience of switching from Sublime to Vim</a></li>
<li><a href="../303526/index.html">Influence of game icon on user attraction cost</a></li>
<li><a href="../303528/index.html">Telegram bot for support service (part 1)</a></li>
<li><a href="../303532/index.html">About the importance of user stories</a></li>
<li><a href="../303536/index.html">Android Security Rewards is 1 year old</a></li>
<li><a href="../303538/index.html">Relinx is another implementation of .NET LINQ methods in C ++, with support for lazy evaluation.</a></li>
<li><a href="../303540/index.html">NetApp AltaVault Storage Systems</a></li>
<li><a href="../303542/index.html">What is useful monomorphism?</a></li>
<li><a href="../303546/index.html">How to distinguish a trademark from a trademark</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>