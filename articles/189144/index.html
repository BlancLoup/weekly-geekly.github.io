<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Running Siesta tests from the console using PhantomJS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here it will be described how to run Siesta tests from the console without using the paid (standard) version of the product (which costs $ 499). 

 Pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Running Siesta tests from the console using PhantomJS</h1><div class="post__text post__text-html js-mediator-article">  Here it will be described how to run Siesta tests from the console without using the paid (standard) version of the product (which costs $ 499). <br><br><h5>  Problem </h5><br>  The fact is that the free (light) version of the <a href="http://www.bryntum.com/products/siesta/">Siesta</a> tool allows you to run tests only from a browser.  And if you need to run tests for CI from the console, you will have to look at the standard version, which has a lot of goodies, including running from the console.  The tool itself uses the well-known free engine <a href="http://phantomjs.org/">PhantomJS</a> to run its tests. <br><br><h5>  Decision </h5><br>  After reviewing the PhantomJS, Siesta documentation and ready-made examples for running the Jasmine and QUnit tests, I wrote some code to save our money with you. <br><a name="habracut"></a><br><h5>  Toolkit Overview </h5><br>  The <a href="http://www.bryntum.com/products/siesta/">Siesta</a> tool is written on the <a href="http://www.sencha.com/products/extjs/">ExtJS</a> framework.  This powerful tool is designed for testing javascript applications written using various popular frameworks such as ExtJS, jQuery, Dojo, etc.  Testing can be carried out both modular and functional, up to a complete imitation of user actions in the browser. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The <a href="http://phantomjs.org/">PhantomJS</a> tool <a href="http://phantomjs.org/">is</a> used to launch web pages from the console and is based on the WebKit engine.  It is widely covered in the Russian segment of the Internet, including on Habr√©.  In contrast to the tool Siesta, on which information "the cat wept." <br><br>  Actually, therefore I am writing this post. <br><br><h5>  The necessary conditions </h5><br><ol><li> You already know how to run Siesta tests from a browser (if not, go <a href="http://www.bryntum.com/docs/siesta/">here</a> ).  For example, we will run our tests at <code><a href="http://localhost/tests/index.html"></a> localhost/tests/index.html</code> <br> </li><li>  You have PhantomJS installed (if not, then <a href="http://phantomjs.org/download.html">here</a> ) <br></li></ol><br><br><h5>  Required code </h5><br>  I wrote runner-siesta.js runner <a href="https://github.com/suvorov/run-siesta">-script</a> for PhantomJS to run the Siesta tests. <br><br><div class="spoiler">  <b class="spoiler_title">Run-siesta.js code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> start = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime(), system = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'system'</span></span>), page = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpage'</span></span>).create(); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'\nStart tests...\n'</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> globalLog = (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> store = []; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-comment"><span class="hljs-comment">/** *    . * * @param msg */</span></span> add: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ store.push(msg); }, <span class="hljs-comment"><span class="hljs-comment">/** *    . */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i= <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; store.length; i++) { log += store[i] + <span class="hljs-string"><span class="hljs-string">'\n'</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(log); } }; }()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (system.args.length !== <span class="hljs-number"><span class="hljs-number">2</span></span>) { globalLog.add(<span class="hljs-string"><span class="hljs-string">'Usage: phantomjs run-siesta.js URL'</span></span>); myExit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/** *         . * * @param exitCode   (0 - ) */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myExit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exitCode</span></span></span><span class="hljs-function">) </span></span>{ globalLog.add(<span class="hljs-string"><span class="hljs-string">'Total time: '</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>().getTime() - start) + <span class="hljs-string"><span class="hljs-string">' ms'</span></span>); globalLog.add(<span class="hljs-string"><span class="hljs-string">'Exit code: '</span></span> + exitCode); globalLog.console(); phantom.exit(exitCode); } <span class="hljs-comment"><span class="hljs-comment">/** *     . * @param msg */</span></span> page.onConsoleMessage = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (msg.match(<span class="hljs-regexp"><span class="hljs-regexp">/END_TESTS/</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exitCode = page.evaluate( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> totalPass = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByClassName(<span class="hljs-string"><span class="hljs-string">'total-pass'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].innerText; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> totalFail = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByClassName(<span class="hljs-string"><span class="hljs-string">'total-fail'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].innerText; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (totalFail !== <span class="hljs-string"><span class="hljs-string">'0'</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'\nFailed!'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'\nCompleted!'</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'\nTotal pass: '</span></span> + totalPass); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Total fail: '</span></span> + totalFail); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> totalFail === <span class="hljs-string"><span class="hljs-string">'0'</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; } ); myExit(exitCode); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!msg.match(<span class="hljs-regexp"><span class="hljs-regexp">/\[object Object\]/</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(msg); } }; <span class="hljs-comment"><span class="hljs-comment">/** *  . * @param {String} URL  */</span></span> page.open(system.args[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">status</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (status !== <span class="hljs-string"><span class="hljs-string">"success"</span></span>) { globalLog.add(<span class="hljs-string"><span class="hljs-string">"Unable to access network"</span></span>); myExit(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } );</code> </pre><br></div></div><br>  This code uses the PhantomJS API to run a page with tests and displays logs to the console, which are generated on the index.html page. <br><br>  As you already know, index.html includes the index.js script, which describes the test run configuration.  A simple example of <a href="http://www.bryntum.com/docs/siesta/">index.js is</a> provided on the official Siesta website. <br><br>  In order for tests to run automatically, you need to add an option to the configuration: <br><br> <code>autoRun: true</code> <br> <br>  Thus, when PhantomJS accesses the page, tests will run automatically.  If you need to launch tests through the browser, this is done via the page settings menu by selecting the ‚ÄúAuto launch‚Äù option. <br><br>  In order for PhantomJS to receive information about each passed test, it is necessary to use the Siesta event - <a href="http://www.bryntum.com/docs/siesta/">testfinalize</a> , which is thrown every time at the end of the next test.  A handler for this event is added to the configuration and displays information about the passed test in the page console (which PhantomJS, in turn, is picked up by using <b>page.onsoleMessage</b> ). <br><br>  The completion of all tests is tracked using the <a href="http://www.bryntum.com/docs/siesta/">testsuiteend</a> event.  The handler of this event outputs to the console a special code that PhantomJS knows.  Due to this, he can complete his work and display the summary information in the console. <br><br><div class="spoiler">  <b class="spoiler_title">Handler code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"> listeners: { <span class="hljs-attr"><span class="hljs-attr">testfinalize</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, test</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fail = test.$failCount, pass = test.$passCount; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = (fail ? <span class="hljs-string"><span class="hljs-string">'~~~~~~~~\n FAILED '</span></span> : <span class="hljs-string"><span class="hljs-string">'[PASSED] '</span></span>) + test.url + <span class="hljs-string"><span class="hljs-string">' [pass: '</span></span> + pass + <span class="hljs-string"><span class="hljs-string">', fail: '</span></span> + fail + <span class="hljs-string"><span class="hljs-string">']'</span></span> + (fail ? <span class="hljs-string"><span class="hljs-string">'\n~~~~~~~~'</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(log); }, <span class="hljs-attr"><span class="hljs-attr">testsuiteend</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event, harness</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'END_TESTS'</span></span>); } }</code> </pre><br></div></div><br><br>  If you put it all together using a simple example from the office.  Siesta, then <a href="https://github.com/suvorov/run-siesta">index.js</a> will look like this <br><br><div class="spoiler">  <b class="spoiler_title">Code index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Harness = Siesta.Harness.Browser.ExtJS; Harness.configure({ <span class="hljs-attr"><span class="hljs-attr">title</span></span> : <span class="hljs-string"><span class="hljs-string">'Awesome Test Suite'</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   autoRun : true, preload : [ // version of ExtJS used by your application '../ext-4.1.1/resources/css/ext-all.css', '../resources/yourproject-css-all.css', // version of ExtJS used by your application '../ext-4.1.1/ext-all-debug.js', '../yourproject-all.js' ], listeners: { //        testfinalize: function(event, test) { var fail = test.$failCount, pass = test.$passCount; var log = (fail ? '~~~~~~~~\n FAILED ' : '[PASSED] ') + test.url + ' [pass: ' + pass + ', fail: ' + fail + ']' + (fail ? '\n~~~~~~~~' : ''); console.log(log); }, //         testsuiteend: function(event, harness) { console.log('END_TESTS'); } } }); Harness.start( '010_sanity.t.js', '020_basic.t.js' );</span></span></code> </pre><br></div></div><br><br>  When tests are completed, run-siesta.js parses the test page for the total number of tests passed, displays the total elapsed time and returns the corresponding numeric identifier to the console (0 is success, 1 is error), which is important for CI. <br><br>  An example of how it all looks in action. <br><div class="spoiler">  <b class="spoiler_title">screenshot</b> <div class="spoiler_text"><img src="https://habrastorage.org/storage2/7c4/b6e/464/7c4b6e4644f8971bcc750327c4806f1a.jpg"></div></div><br><br><h5>  Todo </h5><br>  It is necessary to provide for the possibility of PhantomJS shutting down on a timeout in case it never receives an END_TESTS termination code. <br><br><h5>  Total </h5><br>  It took only two small files with simple code to save $ 499. <br><br>  Profit? </div><p>Source: <a href="https://habr.com/ru/post/189144/">https://habr.com/ru/post/189144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../189134/index.html">The risks of using speech recognition from Google in their business projects</a></li>
<li><a href="../189136/index.html">Minnowboard Now Available</a></li>
<li><a href="../189138/index.html">Overview of the projector Aiptek PocketCinema V60: 60 inches, inexpensive</a></li>
<li><a href="../189140/index.html">Rover Curiosity sang "Happy Birthday" to himself</a></li>
<li><a href="../189142/index.html">IR controller for domestic air conditioner or reverse engineering remote control</a></li>
<li><a href="../189146/index.html">Flashing LED string for stop light on Arduino Pro Mini</a></li>
<li><a href="../189148/index.html">Implementing a VoIP card platform on FreeSWITCH using RADIUS</a></li>
<li><a href="../189150/index.html">Value of beauty</a></li>
<li><a href="../189154/index.html">New experiment from NASA: one twin brother in orbit, the second - on Earth</a></li>
<li><a href="../189158/index.html">CloudLinux - divide and conquer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>