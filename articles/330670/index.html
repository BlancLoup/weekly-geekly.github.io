<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring Reverse Proxy Apache (Debian 8) with automatic issue of Let's Encrypt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Since often there are a lot of sites in the organization, and there are few IP addresses, you need to have a solution with Reverse Proxy. For my purpo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring Reverse Proxy Apache (Debian 8) with automatic issue of Let's Encrypt</h1><div class="post__text post__text-html js-mediator-article">  Since often there are a lot of sites in the organization, and there are few IP addresses, you need to have a solution with Reverse Proxy.  For my purposes, Microsoft TMG has always spoken before, but it has its drawbacks, as well as advantages.  One of the main drawbacks is that TMG needs to upload certificates of a published resource, which is rather inconvenient with Let's Encrypt, since certificates are updated every 90 days. <br><br>  The solution was found: to raise Reverse Proxy on Apache and make sure that auto issuing of Let's Encrypt certificates.  And then calmly publish it on the Firewall, while the ports will be redirected from http to https. <br><br>  We take as a basis that we have a clean Debian GNU / Linux 8 (jessie).  More under the cut. <br><a name="habracut"></a><br>  Well then, let's go. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs sql">aptitude <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y <span class="hljs-keyword"><span class="hljs-keyword">build</span></span>-essential aptitude <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y libapache2-<span class="hljs-keyword"><span class="hljs-keyword">mod</span></span>-proxy-html libxml2-dev aptitude <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y apache2</code> </pre> <br>  Then we activate the following modules: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">a2enmod</span></span> proxy a2enmod proxy_http a2enmod proxy_ajp a2enmod rewrite a2enmod deflate a2enmod headers a2enmod proxy_balancer a2enmod proxy_html a2enmod proxy_ftp a2enmod proxy_connect a2enmod ssl</code> </pre> <br>  and restart Apache: <br><br><pre> <code class="hljs pgsql">service apache2 <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br>  Here the first failure awaits us, Apach does not have enough mod_xml2enc module for proper operation, BUT!  In Jessie, this module does not work, we need to consistently enter the following commands: <br><br><pre> <code class="hljs ruby">aptitude install apache2-prefork-dev libxml2 libxml2-dev apache2-dev mkdir ~<span class="hljs-regexp"><span class="hljs-regexp">/modbuild/</span></span> &amp;&amp; cd ~<span class="hljs-regexp"><span class="hljs-regexp">/modbuild/</span></span> wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/apache.webthing.com/svn</span></span><span class="hljs-regexp"><span class="hljs-regexp">/apache/filters</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mod_xml2enc.c wget http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/apache.webthing.com/svn</span></span><span class="hljs-regexp"><span class="hljs-regexp">/apache/filters</span></span><span class="hljs-regexp"><span class="hljs-regexp">/mod_xml2enc.h apxs2 -aic -I/usr</span></span><span class="hljs-regexp"><span class="hljs-regexp">/include/libxml</span></span>2 ./mod_xml2enc.c cd ~ rm -rfd ~<span class="hljs-regexp"><span class="hljs-regexp">/modbuild/</span></span> service apache2 restart</code> </pre> <br>  After that, everything is good, the module is worth it.  Going further) <br><br>  Since we want to publish an HTTPS site, until we install Let's Encrypt, we need to make a self-signed certificate for our site, enter the command: <br><br><pre> <code class="hljs pgsql">mkdir /etc/apache2/ssl cd /etc/apache2/ssl openssl req -x509 -nodes -days <span class="hljs-number"><span class="hljs-number">365</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">2048</span></span> -keyout <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.key -<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.crt</code> </pre> <br>  We need to create a configuration file and name it with a friendly name: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">touch</span></span> /etc/apache2/sites-available/sambi4.conf</code> </pre> <br>  And ask the file something like this: <br><br><pre> <code class="apache hljs"><span class="hljs-section"><span class="hljs-section">&lt;VirtualHost *:80&gt;</span></span> <span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">ServerName</span></span></span></span> sambi4.ru Redirect permanent / https://sambi4.ru/ #    https &lt;/VirtualHost&gt; &lt;VirtualHost *:443&gt; SSLEngine <span class="hljs-literal"><span class="hljs-literal">On</span></span> SSLProxyEngine <span class="hljs-literal"><span class="hljs-literal">On</span></span> ProxyRequests <span class="hljs-literal"><span class="hljs-literal">Off</span></span> ProxyPreserveHost <span class="hljs-literal"><span class="hljs-literal">On</span></span> ProxyVia full SSLCertificateFile /etc/apache2/ssl/server.crt #      SSLCertificateKeyFile /etc/apache2/ssl/server.key #       ProxyHTMLInterp <span class="hljs-literal"><span class="hljs-literal">On</span></span> ProxyHTMLExtended <span class="hljs-literal"><span class="hljs-literal">On</span></span> &lt;proxy *&gt; Order deny,allow Allow from <span class="hljs-literal"><span class="hljs-literal">all</span></span> &lt;/proxy&gt; ProxyPass / https://192.168.199.78/ #IP   . ProxyPassReverse / https://192.168.199.78/ #IP   . ServerName sambi4.ru ServerAdmin sambi4@sambi4.ru #    email  DocumentRoot <span class="hljs-string"><span class="hljs-string">"/var/www/html"</span></span> #       ,        . &lt;/VirtualHost&gt;</code> </pre> <br>  After completing the creation, do not forget to include our site: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">a2ensite</span></span> /etc/apache2/sites-available/sambi4.conf</code> </pre> <br>  restart apache: <br><br><pre> <code class="hljs pgsql">service apache2 <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span></code> </pre> <br>  <b>After all the procedures we have done, we have a configured Reverse Proxy on Apache2, now we can proceed to setting up Let's Encrypt:</b> <br><br>  Of all the free certificates, only Let's Encrypt remained alive, but its peculiarity is that the certificate is issued for a period of 3 months. <br><br>  We need to put a certificate, and make an automatic issue at the end of the certification period. <br><br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">'deb http://ftp.debian.org/debian jessie-backports main'</span></span> | tee /etc/apt/sources.<span class="hljs-keyword"><span class="hljs-keyword">list</span></span>.d/backports.<span class="hljs-keyword"><span class="hljs-keyword">list</span></span></code> </pre> <br>  after: <br><br><pre> <code class="hljs pgsql">aptitude <span class="hljs-keyword"><span class="hljs-keyword">update</span></span></code> </pre> <br>  Well, now we set Let's Encrypt: <br><br><pre> <code class="hljs sql">aptitude <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> -y python-certbot-apache -t jessie-backports</code> </pre> <br>  We are waiting for the installation process, and we are trying to issue a certificate: <br><br><pre> <code class="hljs pgsql">certbot <span class="hljs-comment"><span class="hljs-comment">--apache</span></span></code> </pre> <br>  And here we are waiting for failure: <br><blockquote>  ERROR: letsencrypt_apache.configurator: No vhost exists with servername or alias of: sambi4.ru.  No vhost was selected.  Please specify servernames in the Apache config </blockquote><br>  This is due to the fact that the repositories are still the old version (at the time of writing 0.10.2), in which errors are observed.  Namely errors in python scripts.  The solution is as usual simple: <br>  Downloading the latest version of certbot: <br><br><pre> <code class="hljs php">git <span class="hljs-keyword"><span class="hljs-keyword">clone</span></span> https:<span class="hljs-comment"><span class="hljs-comment">//github.com/certbot/certbot.git</span></span></code> </pre> <br>  After that, we go along the way: <br><br><pre> <code class="hljs dos"> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/lib/python2.<span class="hljs-number"><span class="hljs-number">7</span></span>/dist-packages</code> </pre> <br>  Delete the folders (and better backup): <br><br>  <strong>acme</strong> <br>  <strong>certbot</strong> <br>  <strong>certbot_apache</strong> <br>  And copy the files from the new release: <br><br><pre> <code class="hljs coffeescript">cp <span class="hljs-regexp"><span class="hljs-regexp">/root/certbot/certbot /usr/lib/python2.7/dist-packages/</span></span> cp <span class="hljs-regexp"><span class="hljs-regexp">/root/certbot/acme/acme/</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/usr/lib/python2.7/dist-packages/</span></span> cp <span class="hljs-regexp"><span class="hljs-regexp">/root/certbot/certbot-apache/certbot_apache/</span></span> <span class="hljs-regexp"><span class="hljs-regexp">/usr/lib/python2.7/dist-packages/</span></span></code> </pre> <br>  Now you can start the process of issuing a certificate with peace of mind: <br><br><pre> <code class="hljs pgsql">certbot <span class="hljs-comment"><span class="hljs-comment">--apache</span></span></code> </pre> <br>  We answer questions and that's it! <br><br>  Congratulations, we issued the certificate, now we need to add the certificate auto-renew script, because  Let's Encrypt issue certificates for a period of only 90 days (we remember that). <br><br>  It's simple.  We need to add the line to cron: <br><br><pre> <code class="hljs pgsql"><span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> * * <span class="hljs-number"><span class="hljs-number">1</span></span> /usr/bin/certbot renew &gt;&gt; /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/le-renew.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre> <br>  Those.  recruit: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">crontab</span></span> -e</code> </pre> <br>  And add our line (be sure to go to the next term, otherwise it will not be saved) <br><br>  And all, repeat infinitely many times with your other resources. <br><br>  Good luck, admins! </div><p>Source: <a href="https://habr.com/ru/post/330670/">https://habr.com/ru/post/330670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330660/index.html">Attention! Hackers have begun to use the SambaCry vulnerability to crack Linux systems</a></li>
<li><a href="../330662/index.html">Approaches to versioning database changes</a></li>
<li><a href="../330664/index.html">It was in the evening. An autoscale load-balanced web service using the example of Bitrix in the Google Cloud Platform</a></li>
<li><a href="../330666/index.html">Internet Magnets 5 - Lighthouses and Messages (Personal, Public, and Updates)</a></li>
<li><a href="../330668/index.html">Self-made drive emulator for Amiga</a></li>
<li><a href="../330672/index.html">Making a dragon bot in Google Chrome</a></li>
<li><a href="../330674/index.html">Introducing 3CX Phone System V15.5</a></li>
<li><a href="../330676/index.html">Client-server step-by-step, from single-threaded to multi-threaded (Client-Server step by step)</a></li>
<li><a href="../330678/index.html">SPL programming language - an example of solving a problem</a></li>
<li><a href="../330680/index.html">Estimation of aging parameters using wearable electronics. Lecture in Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>