<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GIS utilities: establishing a secure connection and signing messages using WCF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Now the state information system of housing and public utilities is being actively developed, and from January 1, 2017, responsibility for managers an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GIS utilities: establishing a secure connection and signing messages using WCF</h1><div class="post__text post__text-html js-mediator-article">  Now the state information system of housing and public utilities is being actively developed, and from January 1, 2017, responsibility for managers and resource supplying organizations for failure to provide information in the system begins. <br><br>  As practice shows, developers who integrate their information systems with GIS utilities spend a lot of time on establishing a secure connection and signing messages.  Despite the fact that the developers of the GIS utilities provided a <a href="https://github.com/Good-Samaritan/signature-demo-net">demo application for signing messages</a> , I will describe how to solve this problem with the help of WCF.  I want to note that in this case, additional software (such as stunnel) is not needed to establish a secure connection. <br><br>  I hope this article will help developers who in the future will integrate with GIS utilities. <a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, without buying additional software is not enough.  We need <a href="https://www.cryptopro.ru/products/net">CryptoPro .NET</a> .  There is a three-month free use period.  This library will provide an https connection and message signature using the XAdES-BES algorithm.  Also, do not forget that you need a certificate of a qualified electronic signature. <br><br><h2>  Training </h2><br>  First you need to install a certificate of qualified electronic signature in the personal store of the local computer.  It must be installed with the private key. <br>  I will not describe the process in detail here, information can be found <a href="http://pro-zakupki.ru/publ/kak_ustanovit_kljuchi_ehcp_v_reestr_kriptopro/1-1-0-32">here</a> and <a href="http://www.kontur-extern.ru/support/faq/34/64">here</a> . <br><br><h2>  Proxy class generation </h2><br>  On the site of GIS housing and public utilities in the <a href="https://dom.gosuslugi.ru/">Regulations and instructions</a> section there is a file ‚ÄúRegulations and formats of information interaction of external information systems with GIS housing and public utilities‚Äù.  The current version is 10.0.1.2.  This file contains wsdl and xsd files, we will use them to create WCF proxy classes. <br><br>  Copy all wsdl and xsd files to a folder, for example ‚Äúc: / gis‚Äù.  This is necessary so that the generation utility can find all the basic xsd files for which the xsd service file is used. <br><br>  To generate proxy classes we will use the standard utility SvcUtil. <br><br><pre><code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.6.1 Tools\SvcUtil.exe"</span></span> c:/gis/hcs-nsi-common-service.wsdl c:/gis/*.xsd /messageContract /enableDataBinding /syncOnly /directory:<span class="hljs-string"><span class="hljs-string">"c:/gis/proxies"</span></span> /noConfig /noLogo /out:NsiCommonService.cs /namespace:*,Gis.Infrastructure.NsiCommonService</code> </pre> <br>  This command will create us a proxy class of service for getting common directories (hcs-nsi-common).  This command specifies where to find the wsdl and xsd service description file, where to put the resulting cs file, and how to name the namespace.  Similarly, you need to run this command for the rest of the GIS utilities services. <br><br>  Add the generated proxy class to the project <br><br><h2>  Configuring the application config </h2><br>  Add the following sections to the application config <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviorExtensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MessageInspectorBehavior"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Gis.Crypto.MessageInspectorBehaviorElement, Gis"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviorExtensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">extensions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpointBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clientCertificateConf"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clientCredentials</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   findValue     --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clientCertificate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">findValue</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">storeLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"LocalMachine"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x509FindType</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FindBySerialNumber"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">serviceCertificate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">authentication</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">certificateValidationMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"None"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">revocationMode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"NoCheck"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">serviceCertificate</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">clientCredentials</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">MessageInspectorBehavior</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behavior</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpointBehaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">behaviors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">customBinding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textMessageEncoding</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">messageVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Soap11"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">readerQuotas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxDepth</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"32"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxStringContentLength</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2147483647"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxArrayLength</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16348"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxBytesPerRead</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"4096"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxNameTableCharCount</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"16384"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">textMessageEncoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">httpsTransport</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">authenticationScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Basic"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">useDefaultWebProxy</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">requireClientCertificate</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxBufferSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2147483647"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">maxReceivedMessageSize</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2147483647"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">binding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">customBinding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bindings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">client</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">endpoint</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://api.dom.gosuslugi.ru/ext-bus-nsi-common-service/services/NsiCommon"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"customBinding"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">behaviorConfiguration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clientCertificateConf"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">contract</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Gis.Infrastructure.NsiCommonService.NsiPortsType"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"NsiCommonPort"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">client</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.serviceModel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><h2>  Class descriptions </h2><br>  In the config, we register MessageInspectorBehavior, which adds the ClientMessageInspector: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageInspectorBehavior</span></span> : <span class="hljs-title"><span class="hljs-title">IEndpointBehavior</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Validate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddBindingParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint, BindingParameterCollection bindingParameters</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyDispatchBehavior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint, EndpointDispatcher endpointDispatcher</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApplyClientBehavior</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ServiceEndpoint endpoint, ClientRuntime clientRuntime</span></span></span><span class="hljs-function">)</span></span> { SignatureMessageInspector inspector = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignatureMessageInspector(); clientRuntime.MessageInspectors.Add(inspector); } }</code> </pre> <br>  I‚Äôll also give the listing of the SignatureMessageInspector class, which deals with the signing of messages: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SignatureMessageInspector : IClientMessageInspector { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> BeforeSendRequest(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Message request, IClientChannel channel) { string st = GetSignElement(MessageString(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> request)); //place <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> request request = CreateMessageFromString(st, request.<span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> AfterReceiveReply(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Message reply, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> correlationState) { string st = MessageString(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> reply); //place <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> response reply = CreateMessageFromString(st, reply.<span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static string GetSignElement(string messageString) { var originalDoc = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> XmlDocument { PreserveWhitespace = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }; originalDoc.LoadXml(messageString); var nodes = originalDoc.SelectNodes($"//node()[@Id='{CryptoConsts.CONTAINER_ID}']"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nodes == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || nodes.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> originalDoc.OuterXml; } var gostXadesBesService = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> GostXadesBesService(); string st = gostXadesBesService.Sign(messageString, CryptoConsts.CONTAINER_ID, CryptoConsts.CERTIFICATE_THUMBPRINT, string.Empty); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> st; } Message CreateMessageFromString(String <span class="hljs-type"><span class="hljs-type">xml</span></span>, MessageVersion ver) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Message.CreateMessage(XmlReaderFromString(<span class="hljs-type"><span class="hljs-type">xml</span></span>), <span class="hljs-type"><span class="hljs-type">int</span></span>.MaxValue, ver); } XmlReader XmlReaderFromString(String <span class="hljs-type"><span class="hljs-type">xml</span></span>) { var stream = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MemoryStream(); // NOTE: don<span class="hljs-string"><span class="hljs-string">'t use using(var writer ...){...} // because the end of the StreamWriter'</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> closes the Stream itself. // var writer = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> StreamWriter(stream); writer.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>(<span class="hljs-type"><span class="hljs-type">xml</span></span>); writer.Flush(); stream.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> XmlReader.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(stream); } String MessageString(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> Message m) { // <span class="hljs-keyword"><span class="hljs-keyword">copy</span></span> the message <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> a working buffer. MessageBuffer mb = m.CreateBufferedCopy(<span class="hljs-type"><span class="hljs-type">int</span></span>.MaxValue); // re-<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> the original message, because "copy" changes its state. m = mb.CreateMessage(); Stream s = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MemoryStream(); XmlWriter xw = XmlWriter.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(s); mb.CreateMessage().WriteMessage(xw); xw.Flush(); s.Position = <span class="hljs-number"><span class="hljs-number">0</span></span>; byte[] bXml = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[s.Length]; s.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>(bXml, <span class="hljs-number"><span class="hljs-number">0</span></span>, (<span class="hljs-type"><span class="hljs-type">int</span></span>) s.Length); // sometimes bXML[] starts <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> a BOM <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bXml[<span class="hljs-number"><span class="hljs-number">0</span></span>] != (byte) <span class="hljs-string"><span class="hljs-string">'&lt;'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetString(bXml, <span class="hljs-number"><span class="hljs-number">3</span></span>, bXml.Length - <span class="hljs-number"><span class="hljs-number">3</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetString(bXml, <span class="hljs-number"><span class="hljs-number">0</span></span>, bXml.Length); } }</code> </pre> <br><h2>  Using </h2><br>  To execute a direct request to the GIS utilities, you need to create an instance of the client of the generated proxy class, specify the client authorization settings, create the request object and call the required method: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NsiPortsTypeClient(); service.ClientCredentials.UserName.UserName = <span class="hljs-string"><span class="hljs-string">"lanit"</span></span>; service.ClientCredentials.UserName.Password = <span class="hljs-string"><span class="hljs-string">"tv,n8!Ya"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> exportNsiListRequest1 { ISRequestHeader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HeaderType { Date = DateTime.Now, MessageGUID = Guid.NewGuid().ToString() }, exportNsiListRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> exportNsiListRequest { version = <span class="hljs-string"><span class="hljs-string">"10.0.1.2"</span></span>, ListGroup = ListGroup.NSI, ListGroupSpecified = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, Id = CryptoConsts.CONTAINER_ID } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = service.exportNsiList(request); } }</code> </pre> <br>  ¬ª <a href="https://github.com/nkochnev/gis-wcf-sign">Project Source Code</a> </div><p>Source: <a href="https://habr.com/ru/post/311062/">https://habr.com/ru/post/311062/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311038/index.html">Smart pointer for Pimpl</a></li>
<li><a href="../311040/index.html">How we almost lost 5,000,000 hryvnia per month due to the ‚Äúwrong‚Äù hosting: client history</a></li>
<li><a href="../311042/index.html">The realities of the game designer in a large studio on the example of BioWare</a></li>
<li><a href="../311046/index.html">We measure battery consumption on mobile devices. Experiment in Yandex</a></li>
<li><a href="../311050/index.html">RamQA First Mitap</a></li>
<li><a href="../311064/index.html">Why use UITableViewController and UICollectionViewController</a></li>
<li><a href="../311066/index.html">We make our first browser 2d game with physics</a></li>
<li><a href="../311068/index.html">Springboard Calling Magic Functions in PHP 7</a></li>
<li><a href="../311070/index.html">Partner Workshop "1C" - Open Sunday - the full program is available.</a></li>
<li><a href="../311076/index.html">Internet of things security: progress, hype and headache</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>