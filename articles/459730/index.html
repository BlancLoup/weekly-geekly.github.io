<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting Qt to STM32</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! We in the Embox project launched Qt on STM32F7-Discovery and would like to tell about it. Earlier, we already told how we managed to run Ope...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting Qt to STM32</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/qt/lf/ek/qtlfekuzcrawgi0xxsc93ct4p60.png" align="right" width="320">  Good day!  We in the <a href="https://github.com/embox/embox">Embox</a> project launched Qt on STM32F7-Discovery and would like to tell about it.  Earlier, we already told how we managed to run <a href="https://habr.com/ru/company/embox/blog/457724/">OpenCV</a> . <br><br>  Qt is a cross-platform framework that includes not only graphic components, but also such things as QtNetwork, a set of classes for working with databases, Qt for Automation (including for implementing IoT) and much more.  The developers of the Qt team have foreseen the use of Qt in embedded systems, so the libraries are pretty well configured.  However, until recently, few people thought about porting Qt to microcontrollers, probably because such a task looks complicated - Qt is large, MCUs are small. <br><a name="habracut"></a><br>  On the other hand, at the moment there are microcontrollers designed for working with multimedia and surpassing the first Pentium.  About a year ago, a post appeared on the Qt blog.  The developers made a Qt port under RTEMS, and launched examples with widgets on several boards running stm32f7.  We are interested.  It was noticeable, and the developers themselves write about this, that Qt slows down on the STM32F7-Discovery.  We wondered if we could run Qt under Embox, and not just draw the widget, but start the animation. <br><br>  In Embox, Qt 4.8 has long been ported, so we decided to try it on it.  Chose the moveblocks application - an example of springy animation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Qt moveblocks on QEMU</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ce/fk/c9/cefkc9i71yjrn8_c2lgggnnbvvo.gif"><br></div></div><br>  To begin with, we configure Qt with as few components as possible with the minimum components required to support animation.  For this there is an option ‚Äú-qconfig minimal, small, medium ...‚Äù.  It connects the Qt configuration file with many macros - what to enable / what to disable.  After this option we add other flags to the configuration if we want to disable something else additionally.  Here is an example of our <a href="https://github.com/embox/embox/blob/master/third-party/qt/Makefile">configuration</a> . <br><br>  In order for Qt to work, you need to add an OS compatibility layer.  One way is to implement QPA (Qt Platform Abstraction).  It was based on the already ready fb_base plugin in Qt, on the basis of which QPA works for Linux.  The result was a small plugin emboxfb, which provides Qt with Embox'a framebuffer, and then it draws there without any help. <br><br><div class="spoiler">  <b class="spoiler_title">Here is the creation of a plugin</b> <div class="spoiler_text"><pre><code class="cpp hljs">QEmboxFbIntegration::QEmboxFbIntegration() : fontDb(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QGenericUnixFontDatabase()) { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fb_var_screeninfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vinfo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fb_fix_screeninfo</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">finfo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *fbPath = <span class="hljs-string"><span class="hljs-string">"/dev/fb0"</span></span>; fbFd = open(fbPath, O_RDWR); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fbPath &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error open framebuffer %s"</span></span>, fbPath); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ioctl(fbFd, FBIOGET_FSCREENINFO, &amp;finfo) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error ioctl framebuffer %s"</span></span>, fbPath); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ioctl(fbFd, FBIOGET_VSCREENINFO, &amp;vinfo) == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error ioctl framebuffer %s"</span></span>, fbPath); } fbWidth = vinfo.xres; fbHeight = vinfo.yres; fbBytesPerLine = finfo.line_length; fbSize = fbBytesPerLine * fbHeight; fbFormat = vinfo.fmt; fbData = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)mmap(<span class="hljs-number"><span class="hljs-number">0</span></span>, fbSize, PROT_READ | PROT_WRITE, MAP_SHARED, fbFd, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fbData == MAP_FAILED) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Error mmap framebuffer %s"</span></span>, fbPath); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!fbData || !fbSize) { qFatal(<span class="hljs-string"><span class="hljs-string">"QEmboxFbIntegration: Wrong framebuffer: base = %p,"</span></span> <span class="hljs-string"><span class="hljs-string">"size=%d"</span></span>, fbData, fbSize); } mPrimaryScreen = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QEmboxFbScreen(fbData, fbWidth, fbHeight, fbBytesPerLine, emboxFbFormatToQImageFormat(fbFormat)); mPrimaryScreen-&gt;setPhysicalSize(QSize(fbWidth, fbHeight)); mScreens.append(mPrimaryScreen); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;printFbInfo(); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">This is how a redraw will look like.</b> <div class="spoiler_text"><pre> <code class="cpp hljs">QRegion QEmboxFbScreen::doRedraw() { QVector&lt;QRect&gt; rects; QRegion touched = QFbScreen::doRedraw(); DPRINTF(<span class="hljs-string"><span class="hljs-string">"QEmboxFbScreen::doRedraw\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!compositePainter) { compositePainter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QPainter(mFbScreenImage); } rects = touched.rects(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; rects.size(); i++) { compositePainter-&gt;drawImage(rects[i], *mScreenImage, rects[i]); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> touched; }</code> </pre><br></div></div><br>  As a result, with the compiler optimization turned on by the size of the memory -Os, the library image turned out to be 3.5 MB, which of course does not fit into the main memory of the STM32F746.  As we wrote in our other article about OpenCV, this board has: <br><br><ul><li>  1 MB ROM </li><li>  320 KB RAM </li><li>  8 MB SDRAM </li><li>  16 MB QSPI </li></ul><br>  Since OpenCV has already added support for executing code from QSPI, we decided to start by loading the Embox image from Qt into QSPI as a whole.  And hooray, everything almost immediately started from QSPI!  But as in the case of OpenCV, it turned out that it works too slowly. <br><br><img src="https://habrastorage.org/webt/oj/f-/y9/ojf-y9zfsv_h5nca9qm209f1hxi.gif"><br><br>  Therefore, we decided to do this - first copy the image into QSPI, then load it into SDRAM and run from there.  From SDRAM was a little faster, but still far from QEMU. <br><br><img src="https://habrastorage.org/webt/nb/qx/0z/nbqx0z83ec4in7fdv0sdpauksbk.gif"><br><br>  Next was the idea to include a floating point - because Qt does some calculations for the coordinates of the squares in the animation.  We tried, but we did not get any visible acceleration here, although in the <a href="https://blog.qt.io/blog/2018/05/03/qt-microncontrollers-mcu/">article</a> , Qt developers claimed that FPU gives a significant increase in speed for ‚Äúdragging animation‚Äù on the touchscreen.  Perhaps moveblocks has significantly fewer floating point calculations, and this depends on the specific example. <br><br>  The most effective was the idea to transfer the framebuffer from SDRAM to the internal memory.  To do this, we made the screen dimensions not 480x272, but 272x272.  They also lowered the color depth from A8R8G8B8 to R5G6B5, thus reducing the size of one pixel from 4 to 2 bytes.  Received the size of the framebuffer 272 * 272 * 2 = 147968 bytes.  This gave a significant acceleration, perhaps the most noticeable, the animation became almost smooth. <br><br>  The last optimization was the execution of Embox code from RAM, and Qt from SDRAM.  To do this, we first link Statically Embox along with Qt, as usual, but we place the text, rodata, data and bss segments of the library in QSPI so that we can later copy it into SDRAM. <br><br><pre> <code class="cpp hljs">section (qt_text, SDRAM, QSPI) phdr (qt_text, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">5</span></span>)) section (qt_rodata, SDRAM, QSPI) phdr (qt_rodata, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">5</span></span>)) section (qt_data, SDRAM, QSPI) phdr (qt_data, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">6</span></span>)) section (qt_bss, SDRAM, QSPI) phdr (qt_bss, PT_LOAD, FLAGS(<span class="hljs-number"><span class="hljs-number">6</span></span>))</code> </pre><br>  Due to the execution of the Embox code from ROM, we also received significant acceleration.  As a result, the animation turned out quite smooth: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/_BpWQCtW02M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Right at the end, preparing the article and trying different configurations of Embox, it turned out that Qt moveblocks works fine from QSPI with a framebuffer in SDRAM, and the size of the framebuffer was the bottleneck!  Apparently, in order to overcome the initial ‚Äúslideshow‚Äù, acceleration was 2 times due to the banal reduction in the size of the framebuffer.  But it was not possible to achieve such a result by transferring only the Embox code to various fast memories (the acceleration was not about 2, but about 1.5 times). <br><br><h3>  How to try it yourself </h3><br>  If you have STM32F7-Discovery, you can run Qt under Embox yourself.  Read how this can be done on our <a href="https://github.com/embox/embox/wiki/Qt-on-STM32">wiki</a> . <br><br><h3>  Conclusion </h3><br>  In the end, we managed to run Qt!  The complexity of the task, in our opinion, is somewhat exaggerated.  Naturally, you need to take into account the specifics of microcontrollers and generally understand the architecture of computing systems.  The optimization results point to the well-known fact that the bottleneck in a computer system is not a processor, but memory. <br><br>  This year we will participate in the <a href="https://techtrain.ru/">TechTrain</a> festival.  There we will describe and show in more detail Qt, OpenCV on microcontrollers and our other achievements. </div><p>Source: <a href="https://habr.com/ru/post/459730/">https://habr.com/ru/post/459730/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459714/index.html">Virtual machine on ESP8266 to run games</a></li>
<li><a href="../459716/index.html">Some aspects of optimizing LINQ queries in C # .NET for MS SQL Server</a></li>
<li><a href="../459718/index.html">10 tips to review a code that you don‚Äôt like</a></li>
<li><a href="../459726/index.html">7 pieces that just do not need to do when opening a circle of robotics. That does not have to do</a></li>
<li><a href="../459728/index.html">Smart phone with a breeze: a review of ZTE Red Magic 3</a></li>
<li><a href="../459732/index.html">How to choose an open source license for a RAD framework on GitHub</a></li>
<li><a href="../459734/index.html">Smok-test release candidate autotests for 15 minutes</a></li>
<li><a href="../459739/index.html">Why is Mozilla called the ‚Äúmain villain of the Internet‚Äù?</a></li>
<li><a href="../459741/index.html">We write multilingual application on React Native</a></li>
<li><a href="../459743/index.html">Mastermind groups for entrepreneurs instead of conferences and trainings: my experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>