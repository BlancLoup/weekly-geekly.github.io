<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of the introduction of DLL and installation of hooks in Modern-applications Windows 8/10</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why do you need to inject your DLLs into other processes and install hooks there? In order to understand what functions this application will call, wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of the introduction of DLL and installation of hooks in Modern-applications Windows 8/10</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/c4c/4e8/026/c4c4e8026191481185234a6f6490bb0c.png" align="right">  Why do you need to inject your DLLs into other processes and install hooks there?  In order to understand what functions this application will call, with what parameters and what these functions will be returned.  Thus, we can understand the internal logic of this application, find out which files it is trying to gain access to, what data is being sent over the network, we can add logging, profiling, debug a bug, get some data from the application, or vice versa - add its interface anything we need.  Hooks use the well-known <a href="https://msdn.microsoft.com/en-us/library/aa264396%2528v%3Dvs.60%2529.aspx">Spy ++</a> utility for working with application windows, DirectX debuggers like <a href="http://habrahabr.ru/company/infopulse/blog/234619/">RenderDoc</a> , some utilities from SysInternals, programs like <a href="http://www.rohitab.com/apimonitor">ApiMonitor</a> , etc. <br><br>  Some time ago I wrote introductory articles about using hooks using the examples of the <a href="http://habrahabr.ru/company/infopulse/blog/140456/">Microsoft Detours</a> and <a href="http://habrahabr.ru/company/infopulse/blog/213309/">madCodeHook</a> libraries (if you are not familiar with hooks at all - this is where to start).  The technician described there is enough to work with ordinary applications, but time does not stand still, and today we already have <s>Metro</s> Modern-applications that come with Windows 8 and Windows 10, as well as third-party software distributed through Microsoft Store.  For example, the new Spartan browser is a Modern application.  The introduction of DLL in these processes has its own characteristics and at first glance it may even seem impossible, but it is not.  In this article I will tell you how we can get inside the Modern-application and install hooks in it for our <s>insidious</s> purposes. <br><a name="habracut"></a><br><br>  <b>32-bit and 64-bit applications</b> <br>  The Windows operating system is 32-bit and 64-bit.  Accordingly, Modern applications can also be 32-bit or 64-bit.  When the application is downloaded to the Microsoft store, the developer builds both versions (plus, perhaps, ARM), and Windows itself decides which one to download to the user.  This leads to the obvious conclusion that the DLL, which we will implement in the Modern-application, should also be in two versions.  A less obvious conclusion is that the application that will ‚Äúthrow‚Äù our DLL-ku into someone else's process must also have corresponding bitness.  After all, we need to start a thread inside another process that will load our library and call some function from it.  This is done through a call to <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682437%2528v%3Dvs.85%2529.aspx">CreateRemoteThread</a> (Ex), but now it requires the same bitness of the calling and called processes (and how else to pass addresses?). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Those.  as a result, our kit will consist of two ‚Äúimplemented‚Äù libraries and two ‚Äúinjectors‚Äù: <br><ul><li>  InjectedLibrary32.dll </li><li>  InjectedLibrary64.dll </li><li>  Injector32.exe </li><li>  Injector64.exe </li></ul><br><br>  <b>Access to the DLL being implemented</b> <br>  As you may know, Modern-applications live in their sandboxes, from where they have access only to their own folder and some other (limited) OS resources available to them.  For example, a Modern-application cannot simply take and open any file from a disk.  For us, this means that by trying to force someone else's application to load our library into its address space, we will get an access error.  This can be easily seen using, for example, the ProcMon utility. <br><br><img src="https://habrastorage.org/files/804/8ce/ce5/8048cece56334ad7a847b79c87fa2e75.PNG"><br><br>  What to do?  Allow file access to the embedded library for Modern applications.  For this there is a system utility icacls.  This command opens access to the file on the disk for all Modern applications: <br><br><pre><code class="bash hljs">icacls.exe some_file.ext /grant *S-1-15-2-1:(F)</code> </pre> <br><br>  Now we will not have access errors. <br><br>  <b>Link DLLs</b> <br>  But not everything is so simple.  DLLs may have dependencies.  And even if it seems to you that there are none, you may forget about the dependency on the VC ++ Runtime Library.  By default, the library created in Visual Studio C ++ assumes dynamic linking with the C ++ runtime library.  This means that when an application wants to load your library, the LoadLibrary () function first sees that you need, for example, the msvcp90r.dll library and will try to find it, which in general will work if we are talking about the usual ( non-modern application and the availability of the <a href="https://support.microsoft.com/en-us/kb/2977003">corresponding</a> VC ++ Redistribution Package.  As for Modern applications, the search order for a DLL is <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682586(v%3Dvs.85).aspx">quite different</a> .  In short: being called from a Modern-application, LoadLibrary () will not find the VC ++ Redistribution Package library, even if they have been successfully installed before. <br><br>  This is a bit unexpected and slightly surprising.  Options out of the situation: <br><ul><li>  Copy VC ++ Runtime Library to Modern-application folder </li><li>  Copy VC ++ Runtime Library to% SystemRoot% \ system32 </li><li>  Register libraries in a special section in the registry (HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ Session Manager \ KnownDLLs) </li><li>  Use static linking (when VC ++ Runtime Library code is included in the body of our DLL) </li></ul><br><br>  The first two methods are extremely ugly (and without an administrator account they are impossible), the third one will work, but it affects the global configuration of the OS, which can also be fraught with consequences.  So the simplest option is static linking (/ MTd and / MT keys on the Code Generation tab). <br><br><img src="https://habrastorage.org/files/237/ad6/60a/237ad660ac0c43c49eee560fb80d0fe3.png"><br><br>  <b>Digital signature</b> <br>  Having solved all the issues with access to the DLL file, it may seem that everything worked out for us - ProcMon does not show any access errors.  But the injection still does not work - DLL-ka does not appear in the list of loaded process modules.  What went wrong?  This question is answered by viewing the Windows Event Viewer. <br><br><img src="https://habrastorage.org/files/529/a3b/fc0/529a3bfc0ce94f7c839e71624453cdd0.png"><br><br>  The operating system does not want to load our DLL, because it is not signed.  At this point, I became anxious, since I already thought that all modules loaded into the Modern-application should be digitally signed by one publisher (developer).  But, fortunately, it is not.  Windows requires that DLLs simply have a valid digital signature, but does not require its matching the signature of the application author.  Those.  we can take a signed DLL from Chrome and drop it into Spartan.  What should we do?  Get a certificate and <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/jj835835%2528v%3Dvs.85%2529.aspx">sign</a> our DLL. <br><br>  Yes, it seriously complicates the work.  But after all, in principle, if we develop a normal product, and not any viruses \ Trojans \ Malvari \ Keyloggers \ Lockers - we will not have problems with obtaining a certificate and using it to sign DLLs.  In general, I consider this protection one of the most serious steps Microsoft takes in protecting user data and isolating Modern applications in the sandbox.  In fact, those who wish to forward the bridge to the application are required to submit documents and identify themselves, and this will stop 99% of the script Kiddies. <br><br>  <b>Access rights to the communication channel</b> <br>  Ok, now our DLL is embedded in someone else's process, it can hang hooks on various system functions, do something useful, but ... It lives in the same sandbox as the parent process, that is, neither send the data "outside" , it cannot receive commands "from outside", because for this it is necessary to create a communication channel, to which it does not have rights by default.  I have already described how to solve this problem separately <a href="http://habrahabr.ru/company/infopulse/blog/206656/">in this article</a> , but here I simply mention it as an item that is important not to forget. </div><p>Source: <a href="https://habr.com/ru/post/256829/">https://habr.com/ru/post/256829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256819/index.html">Interesting notes on C # and CLR</a></li>
<li><a href="../256821/index.html">How IQueryable and LINQ Data Providers Work</a></li>
<li><a href="../256823/index.html">Features of conceptual domain modeling</a></li>
<li><a href="../256825/index.html">What prepares us for C # 7 (Part 1. Tuples)</a></li>
<li><a href="../256827/index.html">Reverse engineering integer division by constant</a></li>
<li><a href="../256831/index.html">As we thought out the designer for children's robotics. #one</a></li>
<li><a href="../256835/index.html">Fans of Chinese pioneers</a></li>
<li><a href="../256839/index.html">Remote control of lighting on standard wiring</a></li>
<li><a href="../256841/index.html">The Telecommunications Regulatory Authority of India (TRAI) leaked more than 2 million email addresses; revenge on Anonymous India</a></li>
<li><a href="../256843/index.html">Once again about encryption GOST 28147-89</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>