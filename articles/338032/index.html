<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Jenkins Pipeline Shared Libraries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello. In this article I want to share the knowledge gained in the process of automating the deployment of our services to different servers in differ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Jenkins Pipeline Shared Libraries</h1><div class="post__text post__text-html js-mediator-article">  Hello.  In this article I want to share the knowledge gained in the process of automating the deployment of our services to different servers in different data centers. <br><br>  The task was the following: there is a certain set of scripts for deploying services that need to be run on each server of each data center.  Scripts perform a series of operations: status check, output from under load balancer, release version, deployment, status check, sending notifications via email and Slack, etc.  This is simple and convenient, but as the number of data centers and services grows, the process of rolling out a new version can take a whole day.  In addition, some commands are responsible for some actions, for example, the setting of a load balancer.  I also wanted the process control code to be stored in a public repository, so that each team member could support it. <br><br>  The problem was solved with the help of Jenkins Pipeline Shared Libraries: the process steps were divided visually into logical parts, the code is stored in the repository, and it became possible to deliver to 20 servers in one click.  Below is an example of a similar test project: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/web/d8f/52b/65a/d8f52b65a43d488cb3d34f222b23f71c.png" alt="image"><br><br>  Now I will tell and show examples of how to achieve this.  I hope this article will help save time to other developers, and I will also be glad to make useful comments. <br><a name="habracut"></a><br><h4>  Creating a library </h4><br>  The first thing you need to do is create your own library in which our functions will be stored. <br>  Create a new repository, which should have the following structure: <br><br><img src="https://habrastorage.org/web/315/ac1/50b/315ac150b8204e478d20cab1d51a95c9.png" alt="image"><br>  The <i>src</i> directory is used for Groovy classes that are added to the classpath when executing Pipeline. <br><br>  The <i>vars</i> directory <i>is</i> used in scripts that define global variables accessible from Pipeline. <br><br>  Below is an example Groovy class <br><br><pre><code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Grab</span></span>(group = <span class="hljs-string"><span class="hljs-string">'org.apache.commons'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = <span class="hljs-string"><span class="hljs-string">'commons-lang3'</span></span>, version = <span class="hljs-string"><span class="hljs-string">'3.6'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.lang3.StringUtils <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Deployer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tries = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-function">Script script def </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (tries &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) tries++ script.echo(<span class="hljs-string"><span class="hljs-string">"tries is numeric: "</span></span> + StringUtils.isAlphanumeric(<span class="hljs-string"><span class="hljs-string">""</span></span> + tries)) } } }</code> </pre> <br>  In classes, you can use any language features: create streams, connect via FTP, etc. <br><br>  <b>Important:</b> <br>  - to output console logs from Pipeline, you need to transfer Script; <br>  - to import libraries simply use <code>@Grab</code> . <br><br>  Below is an example script: <br><br><pre> <code class="hljs scala">#!/usr/bin/env groovy <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span></span>(body) { echo <span class="hljs-string"><span class="hljs-string">"Start Deploy"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Deployer</span></span>(script:<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).run() echo <span class="hljs-string"><span class="hljs-string">"Deployed"</span></span> currentBuild.result = <span class="hljs-symbol"><span class="hljs-symbol">'SUCCES</span></span>S' <span class="hljs-comment"><span class="hljs-comment">//FAILURE to fail return this }</span></span></code> </pre><br>  You can use any language features in scripts and also get Jenkins assembly variables and parameters. <br><br>  <b>Important:</b> <br><br>  - To stop execution, it is enough to set the value of <code>currentBuild.result = 'FAILURE'</code> ; <br>  - You can get the parameters of a parameterized assembly through the <code>env</code> variable.  For example, <code>env.param1</code> . <br><br>  Here is <a href="https://github.com/AndreyVMarkelov/jenkins-pipeline-shared-lib-sample">an example</a> repository with other examples. <br><br><h4>  Repository connection </h4><br>  The next step is to add our repository as a global Pipeline library. <br>  To do this, go to Jenkins: <i>Manage Jenkins ‚Üí Configure System</i> ( <i>Configure Jenkins ‚Üí Configure the system</i> ).  In the <i>Global Pipeline Libraries</i> block <i>,</i> add our repository as in the picture below: <br><br><img src="https://habrastorage.org/web/031/b99/df6/031b99df63ca46898d0239a99100bb93.png" alt="image"><br><br><h4>  Create Pipeline </h4><br>  The final step is to create a Pipeline. <br><br>  Our Pipeline will look like this: <br><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Library</span></span>(<span class="hljs-string"><span class="hljs-string">'jenkins-pipeline-shared-lib-sample'</span></span>)<span class="hljs-function"><span class="hljs-function">_ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'Print Build Info'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ printBuildinfo { name = <span class="hljs-string"><span class="hljs-string">"Sample Name"</span></span> } } stage(<span class="hljs-string"><span class="hljs-string">'Disable balancer'</span></span>) { disableBalancerUtils() } stage(<span class="hljs-string"><span class="hljs-string">'Deploy'</span></span>) { deploy() } stage(<span class="hljs-string"><span class="hljs-string">'Enable balancer'</span></span>) { enableBalancerUtils() } stage(<span class="hljs-string"><span class="hljs-string">'Check Status'</span></span>) { checkStatus() }</code> </pre><br>  Those.  we simply add <code>@Library('jenkins-pipeline-shared-lib-sample')_</code> (do not forget to add _ at the end) and call our functions by the name of scripts, for example, <code>deploy</code> . <br><br>  Our Pipeline is ready. <br><br>  Next time, I'll show you how I set up a parameterized build to elegantly get dependent parameters from a REST service. <br><br>  Thanks for attention! <br></div><p>Source: <a href="https://habr.com/ru/post/338032/">https://habr.com/ru/post/338032/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338018/index.html">QuadBraces III</a></li>
<li><a href="../338020/index.html">Volkov Design System</a></li>
<li><a href="../338024/index.html">Development for Sailfish OS: working with sound on the example of the DayTimer application</a></li>
<li><a href="../338026/index.html">The results of the summer internship 2017 in Digital Security. Security Analysis Division</a></li>
<li><a href="../338028/index.html">New series of webinars on the SAP Cloud Platform: development, integration, mobile applications and much more for the month</a></li>
<li><a href="../338036/index.html">A good designer copies other people's logos, great - steals.</a></li>
<li><a href="../338038/index.html">Farm management for Android devices. Lecture in Yandex</a></li>
<li><a href="../338040/index.html">The evolution of cross-platform development: the pros and cons of Xamarin</a></li>
<li><a href="../338044/index.html">Development for Sailfish OS: Using Sensors (Part 1)</a></li>
<li><a href="../338046/index.html">Analysis of the article ‚ÄúChief, I want to work from home‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>