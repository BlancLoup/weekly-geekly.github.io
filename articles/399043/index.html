<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hakay CAN bus auto for voice control</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A modern car is not only a means of transportation, but also an advanced gadget with multimedia functions and an electronic control system for units a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hakay CAN bus auto for voice control</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/9c4/914/a47/9c4914a47e5249c9acff9db678ff6f82.jpg"><br><br>  A modern car is not only a means of transportation, but also an advanced gadget with multimedia functions and an electronic control system for units and a bunch of sensors.  Many automakers offer the functions of traffic assistants, parking assistants, monitoring and controlling cars from the phone.  This is possible due to the use of an auto CAN bus to which all systems are connected: engine, brake system, steering wheel, multimedia, climate, etc. <br><br>  My car Skoda Octavia 2011 in.  It does not offer management capabilities from the phone, so I decided to correct this shortcoming, and at the same time add the voice control function.  As a gateway between the CAN bus and the phone, I use the Raspberry Pi with the CAN BUS shield and the TP-Link WiFi router.  The protocol of communication units auto closed, and all my letters to provide documentation of the protocol Volkswagen refused.  Therefore, the only way to learn how devices communicate in cars and learn how to control them is reverse engineering of the CAN bus VW protocol. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I acted in stages: <br><br><ol><li>  CAN Shield Development for Raspberry Pi </li><li>  Installing software to work with CAN bus </li><li>  CAN bus connection </li><li>  Development of a sniffer and study of the CAN bus protocol </li><li>  Phone application development </li><li>  Voice control with Homekit and Siri </li></ol><br>  At the end of the voice control video window lifter. <br><a name="habracut"></a><br><h2>  CAN Shield Development for Raspberry Pi </h2><br>  Schild took the scheme here <a href="http://lnxpps.de/rpie/">lnxpps.de/rpie</a> , in the same place the description of the conclusions, for communication with CAN 2 chips are used MCP2515 and MCP2551.  2 CAN-High and CAN-Low wires are connected to the shield.  In SprintLayout 6, spread the board, who can use <a href="">CANBoardRPi.lay</a> (in the title photo, the prototype of the shield on the breadboard). <br><br><img src="https://habrastorage.org/files/3b2/37d/a55/3b237da55bf640f09b88e609ba02c54f.jpg"><br><br><img src="https://habrastorage.org/files/cd7/63f/cb4/cd763fcb4fce4b01afa57b0b34cf7afe.png"><br><br><h2>  Installing software to work with CAN bus </h2><br>  On Raspbian 2-x a year ago, I needed to patch bcm2708.c to add support for CAN (maybe this is not needed now).  To work with the CAN bus, you need to install the can-utils utilities package from <a href="https://github.com/linux-can/can-utils">github.com/linux-can/can-utils</a> , then load the modules and raise the can interface: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># initialize insmod spi-bcm2708 insmod can insmod can-dev insmod can-raw insmod can-bcm insmod mcp251x # Maerklin Gleisbox (60112 and 60113) uses 250000 # loopback mode for testing ip link set can0 type can bitrate 125000 loopback on ifconfig can0 up</span></span></code> </pre> <br>  Check that the CAN interface has gone up with the <b>ifconfig</b> command: <br><br><img src="https://habrastorage.org/files/3f5/4f9/065/3f54f9065c764213a2ff3d644b58e8db.png"><br><br>  Check that everything works by sending a command and receiving it. <br><br>  In one terminal we listen: <br><br><pre> <code class="bash hljs">root@raspberrypi ~ <span class="hljs-comment"><span class="hljs-comment"># candump any,0:0,#FFFFFFFF</span></span></code> </pre><br>  In another terminal we send: <br><br><pre> <code class="bash hljs">root@raspberrypi ~ <span class="hljs-comment"><span class="hljs-comment"># cansend can0 123#deadbeef</span></span></code> </pre><br>  A more detailed installation process is described here <a href="http://lnxpps.de/rpie/">lnxpps.de/rpie</a> . <br><br><h2>  CAN bus connection </h2><br>  A little studying the <a href="http://vwts.ru/diag/can_2_obmen_rus.pdf">open documentation on the CAN bus VW,</a> I found out that I use 2 buses. <br><br>  <b>The CAN bus of the power unit</b> , transmitting data at a speed of 500 kbit / s, connects all control units servicing this unit. <br><br>  For example, the following devices can be connected to the CAN bus of a power unit: <br><br><ul><li>  the engine control unit, </li><li>  ABS control unit, </li><li>  the control unit of the exchange rate stabilization system, </li><li>  gearbox control unit </li><li>  airbag control unit </li><li>  instrument cluster. </li></ul><br>  <b>The CAN bus of the Comfort system and the information</b> command <b>system</b> allows data transfer at a speed of 100 kbit / s between control units servicing these systems. <br><br>  For example, to the CAN bus, the Comfort system and the information command system may be <br>  The following devices are connected: <br><br><ul><li>  Climatronic control unit or air conditioning system </li><li>  control units in the door of the car, </li><li>  Comfort control unit, </li><li>  control unit with display for radio and navigation system. </li></ul><br>  Having access to the first, you can control the movement (in my version on mechanics, at a minimum, you can control the cruise control), by gaining access to the second, you can control the radio, climate, central locking, power windows, headlights, etc. <br><br>  Both buses are connected through the gateway, which is located in the area under the steering wheel, the diagnostic OBD2 connector is also connected to the gateway, unfortunately you cannot listen to the traffic from both buses through the OBD2 connector, you can only send the command and request the status.  I decided that I would work only with the Comfort bus and the most convenient place to connect to the bus was the connector in the driver's door. <br><br><img src="https://habrastorage.org/files/d74/ec6/63a/d74ec663afd44450bd2240160d3d84ce.jpg"><br><br>  Now I can listen, everything that happens in the CAN bus "Comfort" and send commands. <br><br><h2>  Development of a sniffer and study of the CAN bus protocol </h2><br><img src="https://habrastorage.org/files/ec4/f74/c60/ec4f74c609bd43ad8ce6b316047e42e1.png"><br><br>  After I got access to listening to the CAN bus, I need to decipher who is transmitting what to whom.  The format of the CAN packet is shown in the figure. <br><br><img src="https://habrastorage.org/files/97f/667/5f6/97f6675f65d64506bbff0e797ef9826e.jpg"><br><br>  All utilities from the can-utils kit themselves can disassemble CAN packets and give only useful information, namely: <br><br><ul><li>  Identifier </li><li>  Data length </li><li>  Data </li></ul><br>  Data is transmitted in an unencrypted form, which facilitates the study of the protocol.  On the Raspberry Pi, I wrote a small server that redirects data from the candump to TCP / IP in order to parse the data stream on the computer and beautifully show it. <br><br>  For macOS, I wrote a simple application that for each device address adds a cell to the table and in this cell I can already see what data is changing. <br><br><img src="https://habrastorage.org/files/19e/944/bbe/19e944bbe865425db15e9af90e69edd9.png"><br><br>  I press the power window button, I found a cell in which the data is changing, then I determined which commands correspond to pressing down, pressing up, holding up, holding down. <br><br>  You can check that the command is working by sending from the terminal, for example, the command to lift the left glass up: <br><br><pre> <code class="bash hljs">cansend can0 181<span class="hljs-comment"><span class="hljs-comment">#0200</span></span></code> </pre> <br>  Commands that transmit devices over CAN bus in VAG cars (Skoda Octavia 2011), obtained by the reverse engineering method: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// Front Left Glass Up 181#0200 // Front Left Glass Down 181#0800 // Front Right Glass Up 181#2000 // Front Right Glass Down 181#8000 // Back Left Glass Up 181#0002 // Back Left Glass Down 181#0008 // Back Right Glass Up 181#0020 // Back Right Glass Down 181#0080 // Central Lock Open 291#09AA020000 // Central Lock Close 291#0955040000 // Update Light status of central lock (   /          ,       ,    ) 291#0900000000</span></span></code> </pre> <br>  I was too lazy to study all the other devices, so on this list, only that which was interesting to me. <br><br><h2>  Phone application development </h2><br>  Using the commands I received, I wrote an iPhone application that opens / closes the windows and controls the central lock. <br><br>  On the Raspberry Pi, I launched 2 small servers, the first one sends the data from the candump to TCP / IP, the second one takes the commands from the iPhone and sends them to the cansend. <br><br><img src="https://habrastorage.org/files/8ab/4be/824/8ab4be824e4946bfb0151492c5c5e0d5.png"><br><div class="spoiler">  <b class="spoiler_title">Sources of the auto management application for iOS</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// // FirstViewController.m // Car Control // // Created by Vitaliy Yurkin on 17.05.15. // Copyright (c) 2015 Vitaliy Yurkin. All rights reserved. // #import "FirstViewController.h" #import "DataConnection.h" #import "CommandConnection.h" @interface FirstViewController () &lt;DataConnectionDelegate&gt; @property (nonatomic, strong) DataConnection *dataConnection; @property (nonatomic, strong) CommandConnection *commandConnection; @property (weak, nonatomic) IBOutlet UILabel *Door_1; @property (weak, nonatomic) IBOutlet UILabel *Door_2; @property (weak, nonatomic) IBOutlet UILabel *Door_3; @property (weak, nonatomic) IBOutlet UILabel *Door_4; @property (weak, nonatomic) IBOutlet UIButton *CentralLock; - (IBAction)lockUnlock:(UIButton *)sender; @end @implementation FirstViewController - (void)viewDidLoad { self.dataConnection = [DataConnection new]; self.dataConnection.delegate = self; [self.dataConnection connectToCanBus]; self.commandConnection = [CommandConnection new]; [self.commandConnection connectToCanBus]; } - (void)didReceiveMemoryWarning { [super didReceiveMemoryWarning]; // Dispose of any resources that can be recreated. } - (void)doorStatusChanged:(char)value { /* 1 - Front Left Door 2 - Front Right Door 4 - Back Left Door 8 - Back Right Door 3 - Front Left&amp;Right Door = 1 + 3 5 - Front&amp; Back left Door = 1 + 4 */ // Front Left Door if (value &amp; 1) { self.Door_1.backgroundColor = [UIColor yellowColor]; self.Door_1.text = @""; NSLog(@"1"); } else { self.Door_1.backgroundColor = [UIColor lightGrayColor]; self.Door_1.text = @""; } // Front Right Door if (value &amp; 2) { self.Door_2.backgroundColor = [UIColor yellowColor]; self.Door_2.text = @""; NSLog(@"2"); } else { self.Door_2.backgroundColor = [UIColor lightGrayColor]; self.Door_2.text = @""; } // Back Left Door if (value &amp; 4) { self.Door_3.backgroundColor = [UIColor yellowColor]; self.Door_3.text = @""; NSLog(@"4"); } else { self.Door_3.backgroundColor = [UIColor lightGrayColor]; self.Door_3.text = @""; } // Back Right Door if (value &amp; 8) { self.Door_4.backgroundColor = [UIColor yellowColor]; self.Door_4.text = @""; NSLog(@"8"); } else { self.Door_4.backgroundColor = [UIColor lightGrayColor]; self.Door_4.text = @""; } } BOOL firstStatusChange = YES; BOOL lastStatus; -(void) centralLockStatusChanged:(BOOL)status { // At first status changes set lastStatus variable if (firstStatusChange) { firstStatusChange = NO; // Invert status, to pass the next test lastStatus = !status; } // Change Lock image only if status changed if (!(lastStatus == status)) { // Check status if (status) { [self.CentralLock setBackgroundImage:[UIImage imageNamed:@"lock_close"] forState:UIControlStateNormal]; } else { [self.CentralLock setBackgroundImage:[UIImage imageNamed:@"lock_open"] forState:UIControlStateNormal]; } lastStatus = status; } } // Front Left Glass - (IBAction)frontLeftUp:(UIButton *)sender { [self.commandConnection sendMessage:@"cansend can0 181#0200"]; } - (IBAction)frontLeftDown:(id)sender { [self.commandConnection sendMessage:@"cansend can0 181#0800"]; } // Front Right Glass - (IBAction)frontRightUp:(UIButton *)sender { [self.commandConnection sendMessage:@"cansend can0 181#2000"]; } - (IBAction)frontRightDown:(id)sender { [self.commandConnection sendMessage:@"cansend can0 181#8000"]; } // Back Left Glass - (IBAction)backLeftUp:(UIButton *)sender { [self.commandConnection sendMessage:@"cansend can0 181#0002"]; } - (IBAction)backLeftDown:(id)sender { [self.commandConnection sendMessage:@"cansend can0 181#0008"]; } // Back Right Glass - (IBAction)backRightUp:(UIButton *)sender { [self.commandConnection sendMessage:@"cansend can0 181#0020"]; } - (IBAction)backtRightDown:(id)sender { [self.commandConnection sendMessage:@"cansend can0 181#0080"]; } - (IBAction)lockUnlock:(UIButton *)sender { // If central lock closed if (lastStatus) { // Open [self.commandConnection sendMessage:@"cansend can0 291#09AA020000"]; int64_t delayInSeconds = 1; // 1 sec dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, delayInSeconds * NSEC_PER_SEC); dispatch_after(popTime, dispatch_get_main_queue(), ^(void){ [self.commandConnection sendMessage:@"cansend can0 291#0900000000"]; }); } else { // Close [self.commandConnection sendMessage:@"cansend can0 291#0955040000"]; int64_t delayInSeconds = 1; // 1 sec dispatch_time_t popTime = dispatch_time(DISPATCH_TIME_NOW, delayInSeconds * NSEC_PER_SEC); dispatch_after(popTime, dispatch_get_main_queue(), ^(void){ [self.commandConnection sendMessage:@"cansend can0 291#0900000000"]; }); } } @end</span></span></code> </pre><br></div></div><br>  There is a way not to write your own application for a phone, but to use a ready-made from the world of smart homes, you just need to install the <a href="http://razberry.z-wave.me/">Z-Way</a> automation system on the Raspberry Pi: <br><br><pre> <code class="bash hljs">wget -q -O - razberry.z-wave.me/install | sudo bash</code> </pre> <br>  After that we add our CAN devices to the Z-Way automation system <br><br><img src="https://habrastorage.org/files/ae9/f3f/da1/ae9f3fda1c0c4c0d946b3d052ec655de.png"><br>  And control the window as an ordinary switch: <br><br><img src="https://habrastorage.org/files/33b/87d/a28/33b87da284b2450b92abe7c75d398556.png"><br>  Mobile application for Z-Way: ZWay Home Control and ZWay Control. <br><br><h2>  Voice control with Homekit and Siri </h2><br>  In one of my articles, I described <a href="https://geektimes.ru/post/276706/">the installation process of Homebridge on the Raspberry Pi for voice control of the Z-Way home automation system</a> .  After installing Homebridge, you will be able to voice control with Siri.  I am sure that for Android there are many applications that allow voice to send HTTP requests to control the Z-Way. <br><br>  Video voice control windows attached. <br><iframe width="560" height="315" src="https://www.youtube.com/embed/IHX86-q6OGY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div><p>Source: <a href="https://habr.com/ru/post/399043/">https://habr.com/ru/post/399043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../399031/index.html">Microsoft returns money to Call of Duty: Infinite Warfare customers in the Windows Store</a></li>
<li><a href="../399033/index.html">British scientists told about how "British scientists" appeared</a></li>
<li><a href="../399035/index.html">The share of Google Chrome among browsers has reached 55% and continues to grow</a></li>
<li><a href="../399037/index.html">What happens when a person far from this sphere writes about a guitar tube sound</a></li>
<li><a href="../399039/index.html">Panda among the penguins. x86_64 LattePanda microcomputer</a></li>
<li><a href="../399047/index.html">Freedom of the programmer</a></li>
<li><a href="../399051/index.html">November 11-13, digital blockchain development hackaton will be held at Digital October</a></li>
<li><a href="../399053/index.html">Physics in the animal world: dragonflies and their flight</a></li>
<li><a href="../399055/index.html">Ways to use blockchain technology in business: February 18, the Digital October Education Center project starts</a></li>
<li><a href="../399057/index.html">Decentralized decentralized currency trading</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>