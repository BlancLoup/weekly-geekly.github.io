<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CRON in the cloud: the complete guide to the new Windows Azure Scheduler task scheduler service</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Performing scheduled tasks in Windows Azure has always been an interesting topic with a number of off-the-shelf solutions that helped to get the job d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CRON in the cloud: the complete guide to the new Windows Azure Scheduler task scheduler service</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://www.windowsazure.com/en-us/pricing/free-trial/%3FWT.mc_id%3DA398D1F7B"><img alt="image" src="https://habrastorage.org/getpro/habr/post_images/5d6/f02/fa8/5d6f02fa8263beb3e216389a9397974e.jpg"></a> <br><br>  Performing scheduled tasks in Windows Azure has always been an interesting topic with a number of off-the-shelf solutions that helped to get the job done right: <a href="http://www.windowsazure.com/en-us/develop/mobile/tutorials/schedule-backend-tasks/">mobile services scheduler</a> , Quartz Scheduler, <a href="https://github.com/jgeurts/FluentScheduler">FluentScheduler</a> , <a href="https://github.com/NuGet/WebBackgrounder">WebBackgrounder</a> , <a href="http://msdn.microsoft.com/en-us/library/microsoft.servicebus.messaging.brokeredmessage.scheduledenqueuetimeutc.aspx">ScheduledEnqueueTimeUtc</a> , etc.  Although you could successfully use these options, in fact they were not designed specifically for your Windows Azure applications that are based on the role of cloud services or websites. <br><br>  For this reason, almost a year ago, Aditi announced its new service - a scalable task scheduler that was built specifically to meet the needs of applications running in Windows Azure.  <a href="https://www.windowsazure.com/en-us/store/service/%3Fid%3D53765649-ba4b-4fe2-a834-21b334b551e2">Aditi Scheduler</a> was created by <a href="http://dunnry.com/blog/2013/01/29/AnatomyOfAScalableTaskScheduler.aspx">Ryan Dunn</a> , a legend from the Windows Azure team, a <a href="http://blog.aditi.com/cloud/scheduler-2-0-celebrating-500000-jobs-with-new-features-plans/">few months ago, the</a> service celebrated 500,000 tasks and added support for Windows Azure Storage Queues. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But recently, Microsoft announced an excellent alternative to Aditi Scheduler - a new Windows Azure Scheduler service: <br><br><blockquote>  <em><strong>Windows Azure Scheduler</strong> allows you to perform various actions, such as HTTP / S requests or sending messages to the storage queue, on a schedule.</em>  <em>With the help of the scheduler, you can create tasks in the cloud that are guaranteed to cause services both inside the cloud infrastructure and outside it.</em>  <em>You can perform these tasks on demand or on a regular basis on a schedule, as well as schedule a performance on some date in the future.</em> </blockquote><br>  Let's take a closer look at the new service. <br><a name="habracut"></a><br><h3>  Activation of the preview service </h3><br>  The Windows Azure Scheduler service is currently available as a preview, so to use it you must subscribe to it on the advanced services page: <a href="http://www.windowsazure.com/en-us/services/preview/">http://www.windowsazure.com/en-us/services/preview/</a> . <br><br><img title="Step1-PreviewFeature" src="https://habrastorage.org/getpro/habr/post_images/730/07c/59b/73007c59bc671f9941966ce17e907b2d.png" width="800" height="428"><br><br>  Service management is not yet available in the Windows Azure administration portal.  The only way to interact with the scheduler is the open REST API or the use of a ready-made SDK.  The service APIs are described in detail on MSDN in the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/dn528946.aspx">Scheduler REST API Reference</a> section. <br><br><h3>  Install SDK </h3><br>  Scheduler SDK is available as a NuGet package (in the first version) and is part of the new <a href="http://habrahabr.ru/company/microsoft/blog/201566/">Windows Azure Management Libraries</a> management libraries released some time ago.  First you need to install the package: <br><blockquote>  <em>PM&gt; Install-Package Microsoft.WindowsAzure.Management.Scheduler ‚ÄìPre</em> <br></blockquote><h3>  Getting started </h3><br>  In order to quickly test new features, I used the Windows Azure Publishing Settings File (which you can download <a href="https://manage.windowsazure.com/publishsettings/index%3Fclient%3Dvsserverexplorer%26amp%3Bschemaversion%3D2.0">from here</a> ).  The following class extracts data from a file and creates a CertificateCloudCredentials object on its base, which you can use for authentication when working with the management library: <br><br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CertificateCloudCredentialsFactory</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CertificateCloudCredentials </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromPublishSettingsFile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subscriptionName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> profile = XDocument.Load(path); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriptionId = profile.Descendants(<span class="hljs-string"><span class="hljs-string">"Subscription"</span></span>) .First(element =&gt; element.Attribute(<span class="hljs-string"><span class="hljs-string">"Name"</span></span>).Value == subscriptionName) .Attribute(<span class="hljs-string"><span class="hljs-string">"Id"</span></span>).Value; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> certificate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> X509Certificate2( Convert.FromBase64String(profile.Descendants(<span class="hljs-string"><span class="hljs-string">"PublishProfile"</span></span>).Descendants(<span class="hljs-string"><span class="hljs-string">"Subscription"</span></span>).Single().Attribute(<span class="hljs-string"><span class="hljs-string">"ManagementCertificate"</span></span>).Value)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CertificateCloudCredentials(subscriptionId, certificate); } }</code> </pre> <br>  Using this class is a very simple task: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> publishSettingsFilePath = @<span class="hljs-string"><span class="hljs-string">"D:\\azdem.publishsettings"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriptionName = <span class="hljs-string"><span class="hljs-string">"Azdem194D92901Y"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credentials = <span class="hljs-type"><span class="hljs-type">CertificateCloudCredentialsFactory</span></span> .<span class="hljs-type"><span class="hljs-type">FromPublishSettingsFile</span></span>(publishSettingsFilePath, subscriptionName);</code> </pre> <br>  The task scheduler service is executed in the cloud service (Cloud Service), which is why we started with the creation of a cloud service.  At the moment, you should take into account one thing: the cloud service created should be located in the region where the Windows Azure Scheduler service is supported (at the preview stage, support is limited to only some of the regions, but the rest will be added later with the service coming into commercial operation). <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cloudServiceClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloudServiceManagementClient(credentials); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = cloudServiceClient.CloudServices.Create(<span class="hljs-string"><span class="hljs-string">"sandrino-cs1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloudServiceCreateParameters() { Description = <span class="hljs-string"><span class="hljs-string">"sandrino-cs1"</span></span>, GeoRegion = <span class="hljs-string"><span class="hljs-string">"north europe"</span></span>, Label = <span class="hljs-string"><span class="hljs-string">"sandrino-cs1"</span></span> }); Console.WriteLine(result.Status); Console.WriteLine(result.HttpStatusCode);</code> </pre> <br><h3>  Registering a task scheduler resource provider </h3><br>  It is known that a cloud service can contain both virtual machines (IaaS) and web or worker roles (PaaS).  However, we can now make sure that the cloud service can also contain a Resource Provider, such as the Windows Azure Scheduler. In order to use such a resource provider in your cloud service, you first need to enable it for your Subscriptions. If you do not do this, then you will encounter the following error: <br><blockquote>  <em>An unhandled exception of type 'Microsoft.WindowsAzure.CloudException' occurred in Microsoft.WindowsAzure.Management.Scheduler.dll</em> <br><br>  <em>Additional information: ForbiddenError:</em> <br></blockquote>  Now let's register the task scheduler provider (registration is valid for the entire subscription): <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerServiceClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerManagementClient(credentials); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerServiceClient.RegisterResourceProvider(); Console.WriteLine(result.RequestId); Console.WriteLine(result.StatusCode); Console.ReadLine();</code> </pre> <br>  After registering a resource provider, it becomes possible to request its properties: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerServiceClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerManagementClient(credentials); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerServiceClient.GetResourceProviderProperties(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prop <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> result.Properties) { Console.WriteLine(prop.Key + <span class="hljs-string"><span class="hljs-string">": "</span></span> + prop.Value); } Console.ReadLine();</code> </pre> <br>  For example, this code allows us to find out the usage plans available for the service and the regions in which the service can operate: <br><br><img title="Step2-Properties" src="https://habrastorage.org/getpro/habr/post_images/f13/ccd/1f2/f13ccd1f250ca07ee2ecee4781263d18.png" width="757" height="204"><br><br><h3>  Job Collections </h3><br>  The next step is to create a ‚ÄúJob Collection‚Äù (Job Collection), which is a container for storing your tasks and a mechanism for applying various quotas to them.  In addition, this is the place where you need to choose free or paid service usage levels: <br><blockquote>  <em>A task collection contains a group of tasks and manages settings, quotas, and restrictions that are common to all tasks in the collection.</em>  <em>The collection of tasks is created by the owner of the subscription, it combines tasks together based on the consumption or boundaries of the application.</em>  <em>The collection of tasks is limited to one region.</em>  <em>It also allows you to set MaxJobs and MaxRecurrence quotas on the consumption metrics of all tasks in the collection.</em> <br></blockquote>  More information on quotas that can be used on both plans can be found at this link: <a href="http://msdn.microsoft.com/en-us/library/windowsazure/dn479786.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/dn479786.aspx</a> . <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerServiceClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerManagementClient(credentials); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerServiceClient.JobCollections.Create(<span class="hljs-string"><span class="hljs-string">"sandrino-cs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCollectionCreateParameters() { Label = <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>, IntrinsicSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCollectionIntrinsicSettings() { Plan = JobCollectionPlan.Standard, Quota = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCollectionQuota() { MaxJobCount = <span class="hljs-number"><span class="hljs-number">100</span></span>, MaxJobOccurrence = <span class="hljs-number"><span class="hljs-number">100</span></span>, MaxRecurrence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCollectionMaxRecurrence() { Frequency = JobCollectionRecurrenceFrequency.Minute, Interval = <span class="hljs-number"><span class="hljs-number">1</span></span> } } } }); Console.WriteLine(result.RequestId); Console.WriteLine(result.StatusCode); Console.ReadLine();</code> </pre> <br><h3>  HTTP (S) and Store Queue Tasks </h3><br>  Now that we have a collection of tasks, we can start creating tasks for the scheduler.  Task Scheduler currently supports three types of tasks: HTTP, HTTPS, and storage queues.  Let's first look at http support: <br><br><pre> <code class="hljs pgsql">var schedulerClient = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SchedulerClient(credentials, "sandrino-cs2", "jobcoll001"); var result = schedulerClient.Jobs.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobCreateParameters() { Action = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobAction() { <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = JobActionType.Http, Request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobHttpRequest() { Body = "customer=sandrino&amp;command=sendnewsletter", Headers = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>() { { "Content-Type", "application/x-www-form-urlencoded" }, { "x-something", "value123" } }, <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> = "POST", Uri = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Uri("http://postcatcher.in/catchers/527af9acfe325802000001cb") } }, StartTime = DateTime.UtcNow, Recurrence = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobRecurrence() { Frequency = JobRecurrenceFrequency.Minute, <span class="hljs-type"><span class="hljs-type">Interval</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, Count = <span class="hljs-number"><span class="hljs-number">5</span></span> } }); Console.WriteLine(result.RequestId); Console.WriteLine(result.StatusCode); Console.ReadLine();</code> </pre> <br>  This task is created in my ‚Äújobcoll001‚Äù task collection, it will send a POST request with a specific body and request headers.  Please note that I specify the content type for the request, as it is required to perform HTTP (S) type tasks.  As I use the paid plan of the scheduler, I am allowed to create tasks with repetition every minute.  For this demonstration, I limited the task to five executions. <br><br>  Finally, if you pay attention to the URI, you will notice that I use the service <a href="http://postcatcher.in/">http://postcatcher.in</a> .  This is a free service that allows you to debug POST requests, which is exactly what I do.  Let's take a look at what the task scheduler does: <br><br><img title="Step3-content" src="https://habrastorage.org/getpro/habr/post_images/7b3/fd0/89c/7b3fd089ce2dc758de808b8b63265d23.png" width="704" height="640"><br><br>  As you can see, the scheduler sends the request body and the headers specified by me, including some other data.  Additional headers contain information about where the task was performed and within which of the collections of tasks the implementation took place. <br><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"connection"</span></span>: <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"content-length"</span></span>: <span class="hljs-string"><span class="hljs-string">"40"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"content-type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"postcatcher.in"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-forwarded-for"</span></span>: <span class="hljs-string"><span class="hljs-string">"137.116.241.137"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-ms-client-request-id"</span></span>: <span class="hljs-string"><span class="hljs-string">"988c7a64-55e1-41e4-8cf0-ce1eeca240ac"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-ms-execution-tag"</span></span>: <span class="hljs-string"><span class="hljs-string">"0726fa245447c91674c75db3f3564d63"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-ms-scheduler-execution-region"</span></span>: <span class="hljs-string"><span class="hljs-string">"North Europe"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-ms-scheduler-expected-execution-time"</span></span>: <span class="hljs-string"><span class="hljs-string">"2013-11-07T02:39:27"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-ms-scheduler-jobcollectionid"</span></span>: <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-ms-scheduler-jobid"</span></span>: <span class="hljs-string"><span class="hljs-string">"7ce6971c-5aa1-4701-b6bd-02f63ee82d17"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-real-ip"</span></span>: <span class="hljs-string"><span class="hljs-string">"137.116.241.137"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-request-start"</span></span>: <span class="hljs-string"><span class="hljs-string">"1383791968800"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"x-something"</span></span>: <span class="hljs-string"><span class="hljs-string">"value123"</span></span> }</code> </pre> <br>  Now let's change the task type to the storage queue. <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> storageAccount = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CloudStorageAccount(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageCredentials(<span class="hljs-string"><span class="hljs-string">"labdrino"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queueClient = storageAccount.CreateCloudQueueClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queue = queueClient.GetQueueReference(<span class="hljs-string"><span class="hljs-string">"scheduled-tasks"</span></span>); queue.CreateIfNotExists(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> perm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> QueuePermissions(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> policy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedAccessQueuePolicy { SharedAccessExpiryTime = DateTime.MaxValue, Permissions = SharedAccessQueuePermissions.Add }; perm.SharedAccessPolicies.Add(<span class="hljs-string"><span class="hljs-string">"jobcoll001policy"</span></span>, policy); queue.SetPermissions(perm); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sas = queue.GetSharedAccessSignature(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedAccessQueuePolicy(), <span class="hljs-string"><span class="hljs-string">"jobcoll001policy"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerClient(credentials, <span class="hljs-string"><span class="hljs-string">"sandrino-cs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerClient.Jobs.Create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCreateParameters() { Action = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobAction() { Type = JobActionType.StorageQueue, QueueMessage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobQueueMessage() { Message = <span class="hljs-string"><span class="hljs-string">"hello there!"</span></span>, QueueName = <span class="hljs-string"><span class="hljs-string">"scheduled-tasks"</span></span>, SasToken = sas, StorageAccountName = <span class="hljs-string"><span class="hljs-string">"labdrino"</span></span> } }, StartTime = DateTime.UtcNow, Recurrence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobRecurrence() { Frequency = JobRecurrenceFrequency.Minute, Interval = <span class="hljs-number"><span class="hljs-number">1</span></span>, Count = <span class="hljs-number"><span class="hljs-number">5</span></span> } }); Console.WriteLine(result.RequestId); Console.WriteLine(result.StatusCode); Console.ReadLine();</code> </pre> <br>  As you can see, to create a task of the type of storage queues we need some more work and code.  First you need to create a queue, as well as policies for it with permission to add.  For this policy, you need to create a Shared Access Signature signature, which will later be used by the scheduler to send messages to the queue. <br><br>  The result of the code execution will be a message in the queue, which contains information about the task along with the text of the message ‚Äúhello there!‚Äù: <br><br><img title="Step4-queues" src="https://habrastorage.org/getpro/habr/post_images/0e8/41b/5bc/0e841b5bc39129aeacc116b17f6f38cb.png" width="800" height="332"><br><br><h3>  Task history </h3><br>  After your tasks have been completed, you definitely want to know the results of the work of the scheduler.  This can be done using the GetHistory method with passing the task ID parameter to it.  After creating the task, the task ID is returned as a response.  You can also scroll through all the tasks in the collection by calling the List method: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerClient(credentials, <span class="hljs-string"><span class="hljs-string">"sandrino-cs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> job <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> schedulerClient.Jobs.List(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobListParameters() { State = JobState.Enabled })) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Job: {0} - Action: {1} - State: {2} - Status: {3}"</span></span>, job.Id, job.Action, job.State, job.Status); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> history <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> schedulerClient.Jobs.GetHistory(job.Id, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobGetHistoryParameters())) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">" &gt; {0} - {1}: {2}"</span></span>, history.StartTime, history.EndTime, history.Message); } } Console.ReadLine();</code> </pre> <br>  By running this code, you will get a result similar to the following: <br><blockquote>  Job: 34851054-f576-48b8-8c77-73b62b502022 - Action: Microsoft.WindowsAzure.Scheduler.Models.JobAction - State: Faulted - Status: Microsoft.WindowsAzure.Scheduler.Models.JobStatus <br>  &gt; 7/11/2013 2:52:18 - 7/11/2013 2:52:19: StorageQueue Action - The provided queue: "scheduled-tasks" to the given queue <br>  &gt; 7/11/2013 2:52:48 - 7/11/2013 2:52:50: StorageQueue Action - The provided queue: "scheduled-tasks" doesn‚Äôt have to be to the given queue <br>  &gt; 7/11/2013 2:53:19 - 7/11/2013 2:53:19: StorageQueue Action - The provided queue: "scheduled-tasks" does not exist to the given queue <br>  &gt; 7/11/2013 2:53:48 - 7/11/2013 2:53:50: StorageQueue Action - The provided queue: "scheduled-tasks" does not exist to the given queue <br>  &gt; 7/11/2013 2:54:20 - 7/11/2013 2:54:20: StorageQueue Action - The provided queue: "scheduled-tasks" does not exist to the given queue <br>  &gt; 7/11/2013 3:05:19 - 7/11/2013 3:05:19: StorageQueue Action - The provided queue: "scheduled-tasks" does not exist to the given queue <br>  &gt; 7/11/2013 3:05:49 AM - 7/11/2013 3:05:49 AM: StorageQueue Action - The provided queue: "scheduled-tasks" doesn‚Äôt have to be to the given queue <br>  &gt; 7/11/2013 3:06:18 - 7/11/2013 3:06:19: StorageQueue Action - The provided queue: "scheduled-tasks" doesn‚Äôt exist to the given queue <br><br>  Job: 4db6da21-af4a-4703-b988-671cbb6d5fd5 - Action: Microsoft.WindowsAzure.Scheduler.Models.JobAction - State: Completed - Status: Microsoft.WindowsAzure.Scheduler.Models.JobStatus <br>  &gt; 7/11/2013 2:32:13 - 7/11/2013 2:32:15: Http Action - Response from host 'postcatcher.in': 'Created' Response Headers: Connection: keep-alive <br>  X-Response-Time: 6ms <br>  Date: Thu, 07 Nov 2013 02:32:14 GMT <br>  Set-Cookie: connect.sid = 8SxhjZXandfZQc158Ng2tiYs.kyW9OSZGymzcIJW1eTJJ2MIACyhSyK6mfHVVqqj2r0E;  path = /;  expires = Thu, 07 Nov 2013 06:32:14 GMT;  httpOnly <br>  Server: nginx <br>  X-Powered-By: Express <br>  Body: Created <br>  &gt; 7/11/2013 2:33:14 - 7/11/2013 2:33:15: Http Action - Response from host 'postcatcher.in': 'Created' Response Headers: Connection: keep-alive <br>  X-Response-Time: 18ms <br>  Date: Thu, 07 Nov 2013 02:33:15 GMT <br>  Set-Cookie: connect.sid = BJYkjeu3m26wBfr6G2SDgXZl.nhXEo24T3AVHEMYe4xJIm7gjDmhZvj69edIv4bui% 2Bzs;  path = /;  expires = Thu, 07 Nov 2013 06:33:15 GMT;  httpOnly <br>  Server: nginx <br>  X-Powered-By: Express <br>  Body: Created </blockquote>  Task history can provide interesting information on task execution.  If something goes wrong during the execution of a task, history is the first place where you should start looking for the source of the problem. <br><br><h3>  Retries in case of errors (Retries) </h3><br>  Ok, suppose you send an HTTP request to your website, which is unavailable (bug, scheduled work, code update, etc.).  In this case, you may want to repeat the task again after a few seconds.  The good news is that you can do this by specifying the retry policy during task creation: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerClient(credentials, <span class="hljs-string"><span class="hljs-string">"sandrino-cs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerClient.Jobs.Create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCreateParameters() { Action = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobAction() { Type = JobActionType.Http, Request = ..., RetryPolicy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RetryPolicy() { RetryCount = <span class="hljs-number"><span class="hljs-number">5</span></span>, RetryInterval = TimeSpan.FromMinutes(<span class="hljs-number"><span class="hljs-number">1</span></span>), RetryType = RetryType.Fixed } }, StartTime = DateTime.UtcNow, Recurrence = ... });</code> </pre> <br>  In this example, I specify to perform a maximum of five repetitions at intervals of once per minute between them. <br><br><h3>  Error processing </h3><br>  In the case when something went wrong, you may want to receive some kind of signal, for example, a message sent to another queue (or to another data center) or call another URL.  All this is possible by specifying the parameters of the Error special section when creating a task.  In the following example, I create a task for the StorageQueue storage queue, but specify an erroneous SAS signature.  This will cause the scheduler to not be able to complete the task of sending a message to the queue and the ErrorAction section will be called (the code in which sends an error message to my page in postcatcher.in). <br><br><pre> <code class="hljs pgsql">var schedulerClient = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SchedulerClient(credentials, "sandrino-cs2", "jobcoll001"); var result = schedulerClient.Jobs.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobCreateParameters() { Action = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobAction() { <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = JobActionType.StorageQueue, QueueMessage = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobQueueMessage() { Message = "hello there!", QueueName = "scheduled-tasks", SasToken = "not working", StorageAccountName = "labdrino" }, ErrorAction = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobErrorAction() { <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = JobActionType.Http, Request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobHttpRequest() { Uri = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Uri("http://postcatcher.in/catchers/527b0b75fe325802000002b6"), Body = "type=somethingiswrong", Headers = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>() { { "Content-Type", "application/x-www-form-urlencoded" }, { "x-something", "value123" } }, <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> = "POST" } } }, StartTime = DateTime.UtcNow, Recurrence = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobRecurrence() { Frequency = JobRecurrenceFrequency.Minute, <span class="hljs-type"><span class="hljs-type">Interval</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>, Count = <span class="hljs-number"><span class="hljs-number">5</span></span> } }); Console.WriteLine(result.RequestId); Console.WriteLine(result.StatusCode); Console.ReadLine();</code> </pre> <br>  After this, you can observe the error message in the postcatcher (the message header contains all the necessary information related to your task): <br><br><img title="Step5-Error" src="https://habrastorage.org/getpro/habr/post_images/f08/c13/6d0/f08c136d011e4b3f251e80eaddff50c7.png" width="800" height="480"><br><br><h3>  Periodic task repetition </h3><br>  The scheduler allows you to configure several types of periodic repetition of a task, for example, run a task every day, but a maximum of 10 times (Count property): <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerClient(credentials, <span class="hljs-string"><span class="hljs-string">"sandrino-cs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerClient.Jobs.Create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCreateParameters() { Action = ..., Recurrence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobRecurrence() { Frequency = JobRecurrenceFrequency.Day, Interval = <span class="hljs-number"><span class="hljs-number">1</span></span>, Count = <span class="hljs-number"><span class="hljs-number">10</span></span> } });</code> </pre> <br>  You can specify that the task should be executed every day before a specific date: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> schedulerClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SchedulerClient(credentials, <span class="hljs-string"><span class="hljs-string">"sandrino-cs2"</span></span>, <span class="hljs-string"><span class="hljs-string">"jobcoll001"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = schedulerClient.Jobs.Create(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobCreateParameters() { Action = ..., Recurrence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JobRecurrence() { Frequency = JobRecurrenceFrequency.Day, Interval = <span class="hljs-number"><span class="hljs-number">1</span></span>, EndTime = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2013</span></span>, <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>) } });</code> </pre> <br>  At the same time, you can specify more complex parameters of periodic repetition of tasks.  For example, for the mailing list, you can specify the task to be performed weekly on Monday at 11:00 am. <br><br><pre> <code class="hljs pgsql">var schedulerClient = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SchedulerClient(credentials, "sandrino-cs2", "jobcoll001"); var result = schedulerClient.Jobs.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobCreateParameters() { Action = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobAction() { <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> = JobActionType.Http, Request = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobHttpRequest() { Body = "customers=Europe-West", Headers = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>() { { "Content-Type", "application/x-www-form-urlencoded" }, }, <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> = "POST", Uri = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Uri("http://postcatcher.in/catchers/527af9acfe325802000001cb") } }, StartTime = DateTime.UtcNow, Recurrence = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobRecurrence() { // Frequency = JobRecurrenceFrequency.<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, Schedule = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> JobRecurrenceSchedule() { Days = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List() { JobScheduleDay.Monday }, Hours = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List() { <span class="hljs-number"><span class="hljs-number">9</span></span> }, Minutes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List() { <span class="hljs-number"><span class="hljs-number">11</span></span> } } } });</code> </pre> <br>  <strong>Note.</strong>  To date, the control library contains a small bug that does not allow you to set the frequency (Frequency) to None (or Schedule).  Because of this, you will not be able to create tasks with this type of frequency. <br><br><h3>  Conclusion </h3><br>  Windows Azure Scheduler has a simple API, support for storage queues, retry policies, error handling.  This makes the new service a great tool for performing your scheduled tasks.  In addition, the new service opens up a lot of scenarios: scheduling tasks for your Windows Azure Web Site website (without the need to raise worker roles);  sending data to your worker role;  use of the scheduler in your applications for PHP, Node.js, etc .;  building your own agent for Windows Azure SQL Database, etc. <br><br>  More information can be found at the following links: <br><br><ul><li>  Windows Azure Scheduler service home page: <a title="http://www.windowsazure.com/en-ru/services/scheduler/" href="http://www.windowsazure.com/ru-ru/services/scheduler/">http://www.windowsazure.com/en-ru/services/scheduler/</a> ; </li><li>  Information about prices: <a title="http://www.windowsazure.com/en-ru/pricing/details/scheduler/" href="http://www.windowsazure.com/ru-ru/pricing/details/scheduler/">http://www.windowsazure.com/ru-ru/pricing/details/scheduler/</a> (do not forget to read the FAQ); </li><li>  Information about quotas <a title="http://msdn.microsoft.com/en-us/library/windowsazure/dn479786.aspx" href="http://msdn.microsoft.com/en-us/library/windowsazure/dn479786.aspx">http://msdn.microsoft.com/en-us/library/windowsazure/dn479786.aspx</a> </li><li>  Information on the use of Windows Azure Management Libraries <a title="http://blogs.msdn.com/b/vyunev/archive/2013/11/10/windows-azure-management-libraries-net.aspx" href="http://blogs.msdn.com/b/vyunev/archive/2013/11/10/windows-azure-management-libraries-net.aspx">http://habrahabr.ru/company/microsoft/blog/201566/</a> </li></ul><br>  Enjoy! </div><p>Source: <a href="https://habr.com/ru/post/201840/">https://habr.com/ru/post/201840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../201830/index.html">Power of Community: New Attack Scenarios for PCS or Choo Choo PWN in Korea</a></li>
<li><a href="../201832/index.html">Make your AngularJS: Part 1 - Scope and Digest</a></li>
<li><a href="../201834/index.html">A Tale of the Present PRINTRBOT (Part 3: Trial by Fire)</a></li>
<li><a href="../201836/index.html">PDF generation from a WPF application ‚Äúfor everyone, for nothing, and let no one leave offended‚Äù</a></li>
<li><a href="../201838/index.html">Updates and plans</a></li>
<li><a href="../201844/index.html">Microsoft released a set of updates, November 2013</a></li>
<li><a href="../201854/index.html">Astronauts assistant Robonaut finally gets legs</a></li>
<li><a href="../201856/index.html">Problems removing regular clutter on printed forms</a></li>
<li><a href="../201860/index.html">Lua API ++</a></li>
<li><a href="../201862/index.html">Comparison of the performance of the entire line of Nexus smartphones in one video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>