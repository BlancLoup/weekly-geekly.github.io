<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Caching and tags when using ZF + memcached</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 

 In the development process using the Zend Framework + Memcached bundle, we sometimes have to deal with the (excessive) abundance of the ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Caching and tags when using ZF + memcached</h1><div class="post__text post__text-html js-mediator-article"><h5>  Foreword </h5><br><br>  In the development process using the Zend Framework + Memcached bundle, we sometimes have to deal with the (excessive) abundance of the existing functionality of the framework, and with certain limitations.  I will try to tell about one of such cases and the found solution in this article. <br><br><h5>  Description of the problem </h5><br>  As you know, Memcached is a relatively simple to use Key / Value storage with simple, necessary and sufficient functionality.  The ZF interfaces provided for interacting with Memcached are included in the general cache library (also includes adapters for Sqlite, Xcache, ZendServer, etc.).  Some of these caching systems support the use of tags for caching objects, however Memcached does not have such a function, therefore attempts to use standard ZF class interfaces for caching objects with tags when working with Memcached will only lead to errors (in logs) up to exceptions.  (You can read more in the <a href="http://framework.zend.com/manual/ru/zend.cache.html">documentation</a> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  One of the tasks in the development was the "smart" use of the cache in the following sense: <br><ul><li>  if necessary, all objects and lists of objects for any model can be put in the cache; </li><li>  if the object is changed (edited in the admin): <br><ol><li>  it should be removed from the cache, no matter how it was found (i.e., whatever the search parameters of this object would be, even by the primary key, at least by any other set of parameters); </li><li>  All lists that have this object (or all lists for this model (table)) should be removed from the cache. </li></ol><br></li><li>  such functionality should be transparent for controllers, final models, and, in part, for mappers (except for possible indication of using or not using the cache when retrieving data); </li><li>  The cache interface should not change. </li></ul><br><br>  Thus, it turns out that by saving the results of a database query in the cache, you need to add a certain tag for it, by which you can determine which object / list / model the value stored in the cache belongs to.  Yes, and store this tag is also somehow required. <br><br>  Some ideas for solving the problem in due time came from an article on the Habr√© about <a href="http://habrahabr.ru/blogs/webdev/111508/">clever deletion from the cache using the memcached + MongoDB bundle</a> .  However, there were no possibilities to add to the MongoDB server.  Now and in the near future, other caching systems (Redis etc.) on the server are not provided. <br><br><h5>  Solution and Code </h5><br>  The basic idea is simple: storing all caching keys for a specific tag in an array ‚Äî in the cache itself, using the tag as the caching key for that array.  In this case, the tag itself is built automatically based on the type of request and the caching key itself. <br>  Without spreading further along the tree, we will immediately consider the first part of the base mapper code, from which all mappers used in the project are inherited (except for the solution code for the task itself, the example will have a certain amount and accompanying code that is necessary for the system to work and is partially related to the task) .  Immediately I apologize if the code seems a lot, but inside it left enough comments. <br><br><pre><code class="hljs bash">class System_ModelMapper { protected <span class="hljs-variable"><span class="hljs-variable">$_dbTable</span></span>; //         protected <span class="hljs-variable"><span class="hljs-variable">$_modelName</span></span> = <span class="hljs-string"><span class="hljs-string">''</span></span>; //  ,       -      public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span></span>() { parent::__construct(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (empty(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName)) { <span class="hljs-variable"><span class="hljs-variable">$parts</span></span> = explode(<span class="hljs-string"><span class="hljs-string">'_'</span></span>, get_class(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName = str_replace(<span class="hljs-string"><span class="hljs-string">'Mapper'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-variable"><span class="hljs-variable">$parts</span></span>[2]); } } //      dbtable    /** * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> /Zend_Db_Table_Abstract */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDbTable</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (null === <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_dbTable) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;setDbTable(<span class="hljs-string"><span class="hljs-string">'Application_Model_DbTable_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_dbTable; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> setDbTable(<span class="hljs-variable"><span class="hljs-variable">$dbTable</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_string(<span class="hljs-variable"><span class="hljs-variable">$dbTable</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$dbTable</span></span> = new <span class="hljs-variable"><span class="hljs-variable">$dbTable</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-variable"><span class="hljs-variable">$dbTable</span></span> instanceof Zend_Db_Table_Abstract) { throw new Exception(<span class="hljs-string"><span class="hljs-string">'Invalid table data gateway provided'</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_dbTable = <span class="hljs-variable"><span class="hljs-variable">$dbTable</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>; } /** *       * @param array <span class="hljs-variable"><span class="hljs-variable">$params</span></span> * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> System_Model */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getModel(<span class="hljs-variable"><span class="hljs-variable">$params</span></span> = array()) { <span class="hljs-variable"><span class="hljs-variable">$getInstance</span></span> = <span class="hljs-string"><span class="hljs-string">'Application_Model_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new <span class="hljs-variable"><span class="hljs-variable">$getInstance</span></span>(<span class="hljs-variable"><span class="hljs-variable">$params</span></span>); } ‚Ä¶ }</code> </pre> <br><br>  Then there are several methods for searching for a single object: <br><br><pre> <code class="hljs bash"> /** *             * @param array <span class="hljs-variable"><span class="hljs-variable">$data</span></span>   * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> string */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> objectCacheId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fields</span></span> = array_keys(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>); <span class="hljs-variable"><span class="hljs-variable">$values</span></span> = md5(json_encode(array_values(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>))); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-string"><span class="hljs-string">'find_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName . <span class="hljs-string"><span class="hljs-string">'_'</span></span> . join(<span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$fields</span></span>) . <span class="hljs-string"><span class="hljs-string">'_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$values</span></span>; } /** *           * @param <span class="hljs-variable"><span class="hljs-variable">$object</span></span> System_Model * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> string */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getObjectCacheTag(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-string"><span class="hljs-string">'object_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName . <span class="hljs-string"><span class="hljs-string">'_'</span></span> .<span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_id(); } /** *       * @param numeric <span class="hljs-variable"><span class="hljs-variable">$id</span></span>  ID * @param mixed <span class="hljs-variable"><span class="hljs-variable">$obj</span></span> ,      * @param bool <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>         * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> bool|System_Model */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> find(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>, <span class="hljs-variable"><span class="hljs-variable">$obj</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;findByFields(array(<span class="hljs-string"><span class="hljs-string">'id'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$id</span></span>), <span class="hljs-variable"><span class="hljs-variable">$obj</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>); } /** *      * @param array <span class="hljs-variable"><span class="hljs-variable">$data</span></span>     * @param mixed <span class="hljs-variable"><span class="hljs-variable">$obj</span></span> ,      * @param bool <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>         * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> bool|System_Model */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> findByFields(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>, <span class="hljs-variable"><span class="hljs-variable">$obj</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { //     -    ,        (        ,         (   :) ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$cache</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;objectCacheId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Zend_Registry::isRegistered(CACHE_NAME) { /** @var <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> System_Cache_Core */ <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> =&amp; Zend_Registry::get(CACHE_NAME); //      -    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>(<span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } //   Zend_Db_Table         <span class="hljs-variable"><span class="hljs-variable">$select</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;select(); foreach (<span class="hljs-variable"><span class="hljs-variable">$data</span></span> as <span class="hljs-variable"><span class="hljs-variable">$field</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$value</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;getAdapter()-&gt;quoteIdentifier(<span class="hljs-variable"><span class="hljs-variable">$field</span></span>) . <span class="hljs-string"><span class="hljs-string">' = ?'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$value</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$row</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;fetchRow(<span class="hljs-variable"><span class="hljs-variable">$select</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$row</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$obj</span></span> === <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$obj</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getModel(); } <span class="hljs-variable"><span class="hljs-variable">$obj</span></span>-&gt;setOptions(<span class="hljs-variable"><span class="hljs-variable">$row</span></span>-&gt;toArray()); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$obj</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } //    -     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$cache</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$obj</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$obj</span></span>; }</code> </pre><br><br>  By the above code - as you can see, the object search methods have no idea about the tag system.  It will work at the $ cache object level. <br>  Further, there are several methods for searching a set of objects or even all objects in a table, taking into account pagination and sorting: <br><br><pre> <code class="hljs bash"> /** *          ,    * @param array <span class="hljs-variable"><span class="hljs-variable">$data</span></span>   * @param bool|string|array <span class="hljs-variable"><span class="hljs-variable">$order</span></span>   * @param bool|System_Paginator <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>     * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> string */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> listCacheId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span> = array(), <span class="hljs-variable"><span class="hljs-variable">$order</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fields</span></span> = array_keys(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>); <span class="hljs-variable"><span class="hljs-variable">$values</span></span> = md5(json_encode(array_values(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>))); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> sprintf(<span class="hljs-string"><span class="hljs-string">'%s_%s_%s_%s_%s'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getListCacheTag(), join(<span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$fields</span></span>), <span class="hljs-variable"><span class="hljs-variable">$values</span></span>, empty(<span class="hljs-variable"><span class="hljs-variable">$order</span></span>) ? <span class="hljs-string"><span class="hljs-string">''</span></span> : md5(json_encode(<span class="hljs-variable"><span class="hljs-variable">$order</span></span>)), is_object(<span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>) ? <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;page . <span class="hljs-string"><span class="hljs-string">'_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> : <span class="hljs-string"><span class="hljs-string">''</span></span> ); } /** *         * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> string */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getListCacheTag</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-string"><span class="hljs-string">'list_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;_modelName; } /** *        * @param array <span class="hljs-variable"><span class="hljs-variable">$data</span></span>   * @param bool|string|array <span class="hljs-variable"><span class="hljs-variable">$order</span></span>   * @param bool|System_Paginator <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>     * @param bool|string <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>         */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> fetchByFields(<span class="hljs-variable"><span class="hljs-variable">$data</span></span> = array(), <span class="hljs-variable"><span class="hljs-variable">$order</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$cache</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;listCacheId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>, <span class="hljs-variable"><span class="hljs-variable">$order</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>); <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> .= <span class="hljs-string"><span class="hljs-string">'Cache'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Zend_Registry::isRegistered(CACHE_NAME)) { /** @var <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> System_Cache_Core */ <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> =&amp; Zend_Registry::get(CACHE_NAME); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>(<span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } //   ,           ,    <span class="hljs-variable"><span class="hljs-variable">$select</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;select(); <span class="hljs-variable"><span class="hljs-variable">$select_paginator</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;select(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); foreach (<span class="hljs-variable"><span class="hljs-variable">$data</span></span> as <span class="hljs-variable"><span class="hljs-variable">$field</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$value</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$s</span></span> = <span class="hljs-string"><span class="hljs-string">'='</span></span>; // value      (<span class="hljs-string"><span class="hljs-string">'='</span></span>, 2)  (<span class="hljs-string"><span class="hljs-string">'&lt;='</span></span>, 10) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_array(<span class="hljs-variable"><span class="hljs-variable">$value</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$s</span></span> = <span class="hljs-variable"><span class="hljs-variable">$value</span></span>[0]; <span class="hljs-variable"><span class="hljs-variable">$value</span></span> = <span class="hljs-variable"><span class="hljs-variable">$value</span></span>[1]; } <span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;getAdapter()-&gt;quoteIdentifier(<span class="hljs-variable"><span class="hljs-variable">$field</span></span>) . <span class="hljs-string"><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$s</span></span></span><span class="hljs-string"> ?"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$value</span></span>); <span class="hljs-variable"><span class="hljs-variable">$select_paginator</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;getAdapter()-&gt;quoteIdentifier(<span class="hljs-variable"><span class="hljs-variable">$field</span></span>) . <span class="hljs-string"><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$s</span></span></span><span class="hljs-string"> ?"</span></span>, <span class="hljs-variable"><span class="hljs-variable">$value</span></span>); } //    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$order</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;order(<span class="hljs-variable"><span class="hljs-variable">$order</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;order(<span class="hljs-string"><span class="hljs-string">'id ASC'</span></span>); } //   ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_object(<span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>)) { //        ,    <span class="hljs-variable"><span class="hljs-variable">$fetch_count</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;fetchRow(<span class="hljs-variable"><span class="hljs-variable">$select_paginator</span></span>-&gt;columns(<span class="hljs-string"><span class="hljs-string">'count(id) as _c'</span></span>))-&gt;toArray(); <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;total = <span class="hljs-variable"><span class="hljs-variable">$fetch_count</span></span>[<span class="hljs-string"><span class="hljs-string">'_c'</span></span>]; //    ,     ,     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;page &gt; <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;getLastPage()) <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;page = <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;getLastPage(); //       <span class="hljs-variable"><span class="hljs-variable">$select</span></span>-&gt;limitPage(<span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;page, <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$resultSet</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;fetchAll(<span class="hljs-variable"><span class="hljs-variable">$select</span></span>); <span class="hljs-variable"><span class="hljs-variable">$result</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;rowsToObj(<span class="hljs-variable"><span class="hljs-variable">$resultSet</span></span>); //      -         (        <span class="hljs-built_in"><span class="hljs-built_in">limit</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (is_object(<span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>-&gt;inlist = count(<span class="hljs-variable"><span class="hljs-variable">$result</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$cache</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$result</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$result</span></span>; } /** *         * @param bool|string|array <span class="hljs-variable"><span class="hljs-variable">$order</span></span>   * @param bool|System_Paginator <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>     * @param bool|string <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>         * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array|bool */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> fetchAll(<span class="hljs-variable"><span class="hljs-variable">$order</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;fetchByFields(array(), <span class="hljs-variable"><span class="hljs-variable">$order</span></span>, <span class="hljs-variable"><span class="hljs-variable">$paginator</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>); } /** *         * @param Zend_Db_Table_Rowset_Abstract <span class="hljs-variable"><span class="hljs-variable">$rowset</span></span>     * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array|bool */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> rowsToObj(<span class="hljs-variable"><span class="hljs-variable">$rowset</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$rowset</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$entries</span></span> = array(); foreach (<span class="hljs-variable"><span class="hljs-variable">$rowset</span></span> as <span class="hljs-variable"><span class="hljs-variable">$row</span></span>) { /** @var <span class="hljs-variable"><span class="hljs-variable">$entry</span></span> System_Model */ <span class="hljs-variable"><span class="hljs-variable">$entry</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getModel(<span class="hljs-variable"><span class="hljs-variable">$row</span></span>-&gt;toArray()); <span class="hljs-variable"><span class="hljs-variable">$entries</span></span>[<span class="hljs-variable"><span class="hljs-variable">$entry</span></span>-&gt;get_id()] = <span class="hljs-variable"><span class="hljs-variable">$entry</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$entries</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre><br><br>  By the code given here, it is also clear that the sampling methods themselves are not directly related to the tag system. <br><br>  Below is the class code that inherits from the standard Zend_Cache_Core and is used when bootstrap objects are initialized to work with Memcached.  And after that we will return again to the mapper and methods for saving, updating and deleting objects in the database. <br><br><pre> <code class="hljs bash">class System_Cache_Core extends Zend_Cache_Core { /** *    save   */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> save(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>, <span class="hljs-variable"><span class="hljs-variable">$id</span></span> = null, <span class="hljs-variable"><span class="hljs-variable">$tags</span></span> = array(), <span class="hljs-variable"><span class="hljs-variable">$specificLifetime</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-variable"><span class="hljs-variable">$priority</span></span> = 8) { //      <span class="hljs-variable"><span class="hljs-variable">$ida</span></span> = explode(<span class="hljs-string"><span class="hljs-string">'_'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$id</span></span>); //        ,          switch (<span class="hljs-variable"><span class="hljs-variable">$ida</span></span>[0]) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'list'</span></span>: //       2   (    ) <span class="hljs-variable"><span class="hljs-variable">$tag</span></span> = join(<span class="hljs-string"><span class="hljs-string">'_'</span></span>, array_splice(<span class="hljs-variable"><span class="hljs-variable">$ida</span></span>, 0, 2)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;updateTagList(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>, <span class="hljs-variable"><span class="hljs-variable">$id</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'find'</span></span>: //   -       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$data</span></span> instanceof System_Model) { <span class="hljs-variable"><span class="hljs-variable">$tag</span></span> = <span class="hljs-variable"><span class="hljs-variable">$data</span></span>-&gt;get_mapper()-&gt;getObjectCacheTag(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;updateTagList(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>, <span class="hljs-variable"><span class="hljs-variable">$id</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">break</span></span>; } //           <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> parent::save(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>, <span class="hljs-variable"><span class="hljs-variable">$id</span></span>, <span class="hljs-variable"><span class="hljs-variable">$tags</span></span>, <span class="hljs-variable"><span class="hljs-variable">$specificLifetime</span></span>, <span class="hljs-variable"><span class="hljs-variable">$priority</span></span>); } /** *        * @param string <span class="hljs-variable"><span class="hljs-variable">$tag</span></span> * @param string <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span> */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> updateTagList(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>, <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>) { //       <span class="hljs-variable"><span class="hljs-variable">$list</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getListByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>); <span class="hljs-variable"><span class="hljs-variable">$list</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>; //         <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;saveListByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>, <span class="hljs-variable"><span class="hljs-variable">$list</span></span>); } /** *      * @param string <span class="hljs-variable"><span class="hljs-variable">$tag</span></span> */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> getListByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$tagcacheId</span></span> = <span class="hljs-string"><span class="hljs-string">'_taglist_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$tag</span></span>; <span class="hljs-variable"><span class="hljs-variable">$list</span></span> = array(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>(<span class="hljs-variable"><span class="hljs-variable">$tagcacheId</span></span>)) { <span class="hljs-variable"><span class="hljs-variable">$list</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$tagcacheId</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$list</span></span>; } /** *         * @param string <span class="hljs-variable"><span class="hljs-variable">$tag</span></span> * @param array <span class="hljs-variable"><span class="hljs-variable">$list</span></span> */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> saveListByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>, <span class="hljs-variable"><span class="hljs-variable">$list</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$tagcacheId</span></span> = <span class="hljs-string"><span class="hljs-string">'_taglist_'</span></span> . <span class="hljs-variable"><span class="hljs-variable">$tag</span></span>; <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$list</span></span>, <span class="hljs-variable"><span class="hljs-variable">$tagcacheId</span></span>); } /** *         * @param System_Model <span class="hljs-variable"><span class="hljs-variable">$object</span></span> */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> removeByObject(<span class="hljs-variable"><span class="hljs-variable">$object</span></span> = null) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$object</span></span> instanceof System_Model) { //       <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;removeByTag(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_mapper()-&gt;getListCacheTag()); //             <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_id()) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;removeByTag(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_mapper()-&gt;getObjectCacheTag(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>)); } } } /** *         * @param string <span class="hljs-variable"><span class="hljs-variable">$tag</span></span> */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> removeByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>) { //      <span class="hljs-variable"><span class="hljs-variable">$list</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getListByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>); //      foreach ((array)<span class="hljs-variable"><span class="hljs-variable">$list</span></span> as <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;remove(<span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>); } //      , ,    <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;saveListByTag(<span class="hljs-variable"><span class="hljs-variable">$tag</span></span>, array()); } }</code> </pre><br><br>  Well, it remains to mention the methods of the mapper for saving and deleting objects: <br><br><pre> <code class="hljs bash"> /** *     * @param System_Model <span class="hljs-variable"><span class="hljs-variable">$object</span></span>   * @param boolean <span class="hljs-variable"><span class="hljs-variable">$isInsert</span></span>    * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array|bool|mixed */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> save(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>, <span class="hljs-variable"><span class="hljs-variable">$isInsert</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$data</span></span> = <span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;toArray(); <span class="hljs-variable"><span class="hljs-variable">$find</span></span> = array(<span class="hljs-string"><span class="hljs-string">'id = ?'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_id()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (null === (<span class="hljs-variable"><span class="hljs-variable">$id_value</span></span> = <span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_id())) { <span class="hljs-variable"><span class="hljs-variable">$isInsert</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">unset</span></span>(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>[<span class="hljs-string"><span class="hljs-string">'id'</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$isInsert</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$pk</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;insert(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$pk</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;set_id(<span class="hljs-variable"><span class="hljs-variable">$pk</span></span>); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;resetCache(); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$pk</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //    -       <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;update(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>, <span class="hljs-variable"><span class="hljs-variable">$find</span></span>) &amp;&amp; <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;resetCache(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>); } } /** *     * @param <span class="hljs-variable"><span class="hljs-variable">$object</span></span> System_Model * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array|bool|mixed */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> insert(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } /** *     * @param <span class="hljs-variable"><span class="hljs-variable">$object</span></span> System_Model   * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> bool */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> remove(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$primary</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;get_primary(); <span class="hljs-variable"><span class="hljs-variable">$where</span></span> = array(<span class="hljs-string"><span class="hljs-string">'id = ?'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$object</span></span>-&gt;get_id()); //   -      <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getDbTable()-&gt;delete(<span class="hljs-variable"><span class="hljs-variable">$where</span></span>) &amp;&amp; <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;resetCache(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>)); } /** *         * @param System_Model <span class="hljs-variable"><span class="hljs-variable">$object</span></span> * @param array <span class="hljs-variable"><span class="hljs-variable">$cacheIds</span></span> * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> bool */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> resetCache(<span class="hljs-variable"><span class="hljs-variable">$object</span></span> = null, <span class="hljs-variable"><span class="hljs-variable">$cacheIds</span></span> = array()) { //       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Zend_Registry::isRegistered(CACHE_NAME)) { /** @var <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> System_Cache_Core */ <span class="hljs-variable"><span class="hljs-variable">$cache</span></span> = Zend_Registry::get(CACHE_NAME); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!empty(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>)) { //       <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;removeByObject(<span class="hljs-variable"><span class="hljs-variable">$object</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //     <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;removeByTag(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getListCacheTag()); } foreach (<span class="hljs-variable"><span class="hljs-variable">$cacheIds</span></span> as <span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$cache</span></span>-&gt;remove(<span class="hljs-variable"><span class="hljs-variable">$cacheId</span></span>); } } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }</code> </pre><br><br>  As a result, we got a certain basic tag system for objects and models, which is transparent when used and does not require an explicit indication of the tag name either in the models or in the mappers themselves - the tag names are automatically generated based on the data of the model itself and the objects. <br><br>  For other problems and details (which are planned to be made and solved): <br><ul><li>  put all prefixes ('list', 'object', '_taglist_' etc.) in constants; </li><li>  The tag for lists inside System_Cache_Core is defined as $ tag = join ('_', array_splice ($ ida, 0, 2)); which is not very good and does not directly correspond to the definition of the tag in the mapper.  Localization of the tag definition for the list in one place (in the mapper method) will allow the end mappers to override this method and add parameters to the tag generation algorithm and the tag itself; </li><li>  the tag for an object is built on the basis of the primary key of this object, which can lead to the following problems: if the object is searched taking into account, for example, the parameter is_published = 1 and is not (it is, but not published), then the caching key for the request is understandable reasons will not be included in the tag list for this object, and after we have ‚Äúpublished‚Äù the object in the admin panel of the project - the cache will not clear the record by this key and the object will not be found again (and will take false from the cache) until TTL end for this cache entry. </li></ul><br><br>  One way or another, we will gradually solve all these problems. <br>  However, I want to listen to reviews and experienced habravchan and get a fair share of criticism of the proposed method. <br><br>  PS Happy New Year! </div><p>Source: <a href="https://habr.com/ru/post/135047/">https://habr.com/ru/post/135047/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135041/index.html">How love of music helped find vulnerabilities in Flash</a></li>
<li><a href="../135042/index.html">Redis, hiredis, libev and multithread. Part 2</a></li>
<li><a href="../135043/index.html">Android + Arduino + 4 wheels</a></li>
<li><a href="../135044/index.html">D programming language</a></li>
<li><a href="../135045/index.html">We released to the world: Java Card Runtime Environment Simulator "jCardSim"</a></li>
<li><a href="../135048/index.html">Facebook has improved machine learning algorithms, users are scared</a></li>
<li><a href="../135051/index.html">Detailed video review of Galaxy Nexus - with ice cream and all the chips</a></li>
<li><a href="../135054/index.html">About ICQ</a></li>
<li><a href="../135055/index.html">Your console bike to check broken links - LinkInspector</a></li>
<li><a href="../135056/index.html">Password recovery - hackers, welcome!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>