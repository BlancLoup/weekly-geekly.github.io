<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Web Alerts in Loaded Projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In modern WEB Design, problems often arise when it is necessary to notify a user about an event: a new message has arrived, the exchange rate has chan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Web Alerts in Loaded Projects</h1><div class="post__text post__text-html js-mediator-article">  In modern WEB Design, problems often arise when it is necessary to notify a user about an event: a new message has arrived, the exchange rate has changed or the order status has changed, video content has been converted or the temperature of a sick grandmother has jumped. <br><br>  There are several options for solving this class of problems.  The most optimal and common solution is to subscribe to events.  How is this implemented in loaded projects? <br><a name="habracut"></a><br>  Suppose we are developing a brokerage service in which thousands of clients are served.  In order to find out the status of stock prices on the stock exchange or to find out the number of available places in hotels, we need to apply to one or several external services.  Since the external service responds with a delay, and we have thousands of customers, if we make requests directly from the WEB application and wait for a response from the service, everything will hang as a result. <br><br>  Therefore, we have to do the so-called pending request.  Our WEB application immediately returns the generated HTML page to the user with no result, which shows the splash screen that the request is being executed, and the result comes a little later, as it is executed.  How does this happen? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Before starting the formation of the HTML page, our WEB application puts the data into the queue.  The daemon, or the task called on the crown, scans the queue and takes data from it.  Further, on the basis of this data, it forms a request and sends it to an external service (picture 1). <br><br><img src="https://habrastorage.org/files/946/80a/6ec/94680a6ecc0246498ffa260fa64d149d.png" alt="image"><br><br>  It seems that everything in this scheme is good - it works without delay.  But we need feedback. The end user needs the information he requested.  And so, we received this information in our cron script.  Now it is necessary to forward it to the user. <br><br>  Here the Publisher-Subscriber pattern will help us.  Many who use JavaScript know this scheme: <br><br>  The subscriber (Subscriber) subscribes to a channel, and when a certain event occurs, the Publisher (Producer) sends a message to this channel.  As such a notification mechanism, you can use many different solutions: Redis, RabbitMQ, Tarantool, MsMQ, ZMQ, Kafka (message broker).  Since we have a number of services already tied to Redis, we decided not to introduce new entities. <br><br>  How would you use it?  There are several options here, but experts at once in three throats will say ‚ÄúTo connect the WEB page and the server, use websockets‚Äù.  I will not argue, yes, today is the most advanced technology of instant communication between the WEB client and the server.  Consider the server side. <br><br>  I‚Äôm not going to reveal to anyone that already, like a few years, how nginx can proxy websockets.  If we use php-fpm as a backend, then for every running WEB client, we need to have a PHP process running.  There is a 10K problem when 10K processes will hang on 10K requests.  Tritely not enough memory.  As one of the options, you can use node.js.  This is just his class of problems where long-playing non-blocking connections are used. <br><br>  And you can do without him?  After all, I would not like to introduce a new entity, especially as we assign it a very simple task.  The more complex the architecture, the more points of failure and the less likelihood of failure-free operation.  We already had a positive experience with the implementation of the <a href="https://github.com/openresty/lua-nginx-module">nginx-lua</a> module (You can read more about nginx-lua <a href="https://habrahabr.ru/post/270463/">here</a> and <a href="https://habrahabr.ru/company/2gis/blog/199504/">here</a> ).  And can he perform these functions?  In general, the result was this picture (picture 2): <br><br><img src="https://habrastorage.org/files/fea/ae8/0d5/feaae80d5ece4953945c47f5f660d269.png" alt="image"><br><br>  It turns out it is not so difficult.  In addition to lua-nginx-module, we connect <a href="https://github.com/openresty/lua-resty-redis">lua-resty-redis</a> and <a href="https://github.com/openresty/lua-resty-websocket">lua-resty-websocket</a> .  To do this, unlike lua-nginx-module, you don‚Äôt need to compile anything, just copy all source codes of the modules in the lib directory into the folder: / usr / share / nginx / lua / lib and connect with the http ( configuration file nginx.conf): <br><br><pre><code class="hljs objectivec">http { lua_package_path <span class="hljs-string"><span class="hljs-string">"/usr/share/nginx/lua/lib/?.lua;;"</span></span>; ... }</code> </pre> <br>  Next, in the nginx.conf configuration file (or the plugin config for our virtual host), we define location / ws: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">location</span></span> /ws { content_by_lua_file /<span class="hljs-type"><span class="hljs-type">path</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>/file/websocket_server.lua; }</code> </pre> <br>  The websocket_server.lua file itself is not so complicated, I don‚Äôt see the point here in parts.  Its full version can be found on <a href="https://github.com/akalend/subscribe-websockets-nginx-lua">github</a> . <br><br>  For verification, there is a test console client that can be modified and run into several thousand instances with different time-outs and verified in practice.  This version of the client is interactive, the name of the channel is entered from the console, and if a publication is sent to the channel, it is instantly sent to the client.  The client has a timeout of 5 minutes. <br><br>  I hope this feature will be useful to someone. </div><p>Source: <a href="https://habr.com/ru/post/312504/">https://habr.com/ru/post/312504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312492/index.html">OpenShift v3. Part II. Continue dating. ROR4</a></li>
<li><a href="../312494/index.html">Saga about the cluster. Everything you wanted to know about Postgres horizontal scaling</a></li>
<li><a href="../312496/index.html">How we built our mini data center. Part 2 - Hermoson</a></li>
<li><a href="../312498/index.html">A few words about moving to Cyprus</a></li>
<li><a href="../312500/index.html">Do not step on our rake with TK: an epic contest experience and a couple of tales</a></li>
<li><a href="../312506/index.html">.NET Portability Analyzer</a></li>
<li><a href="../312508/index.html">Toolkit for front-end development for Linux</a></li>
<li><a href="../312510/index.html">‚ÄúThe world is a collection of facts, not things‚Äù: Wittgenstein and operation-oriented programming</a></li>
<li><a href="../312512/index.html">BizTalk Server Support: helpful tips. Part 2</a></li>
<li><a href="../312514/index.html">Do not postpone to the mailbox: 2GIS b2c-messenger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>