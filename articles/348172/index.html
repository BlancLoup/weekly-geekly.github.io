<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL keys in full detail</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The Internet is full of dogmatic commandments about how to choose and use keys in relational databases. Sometimes disputes even go into holivars: use ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL keys in full detail</h1><div class="post__text post__text-html js-mediator-article">  The Internet is full of dogmatic commandments about how to choose and use keys in relational databases.  Sometimes disputes even go into holivars: use natural or artificial keys?  Auto-increment integers or UUIDs? <br><br>  After reading sixty-four articles, scrolling through sections of five books and asking a bunch of questions in IRC and StackOverflow, I (the author of the original article <strong>Joe ‚Äúbegriffs‚Äù Nelson</strong> ), I think, put the pieces of the puzzle together and now I can reconcile the opponents.  Many disputes regarding the keys arise, in fact, because of a wrong understanding of someone else's point of view. <br><br><h3>  Content </h3><br><ul><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">What is the "keys"?</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">Curious case of primary keys</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">The choice of natural keys</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">Artificial keys</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">Surrogate keys</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">Auto-increment BIGINT</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">UUID</a> </li><li>  <a href="https://habr.com/ru/company/oleg-bunin/blog/348172/">Results and recommendations</a> </li></ul><br>  Let's divide the problem into parts, and in the end we will collect it again.  To begin, let us ask the question - what is the ‚Äúkey‚Äù? <br><a name="habracut"></a><a name="keys"></a><br><h3>  What is the "keys"? </h3><br>  Let's forget for a minute about the <em>primary</em> keys, we are interested in a more general idea.  The key is a column or columns that do not have duplicate values ‚Äã‚Äãin the rows.  In addition, the columns must be irreducibly unique, that is, no subset of the columns is so unique. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, consider the table for counting cards in a card game: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cards_seen ( suit <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, face <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> );</code> </pre> <br>  If we track one deck (that is, without duplicate cards), then the combination of shirt and face is unique and we would not want to add the same shirt and face to the table twice, because it would be redundant.  If the map is in the table, then we saw it, otherwise - we did not see it. <br><br>  We can and should set the database to this restriction by adding the following: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cards_seen ( suit <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, face <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (suit, face) );</code> </pre> <br>  Neither <code>suit</code> (shirt) nor <code>face</code> (face) is unique, we can see different cards with the same shirt or face.  Since <code>(suit, face)</code> unique, and the individual columns are not unique, it can be argued that their combination is irreducible, and <code>(suit, face)</code> is the key. <br><br>  In a more general situation, when you need to track several decks of cards, you can add a new field and record how many times we have seen a card: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cards_seen ( suit <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, face <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, seen <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> );</code> </pre> <br>  Although the triple <code>(suit, face, seen)</code> turns out to be unique, it is not the key, because the subset <code>(suit, face)</code> must also be unique.  This is necessary because two lines with the same shirt and face, but different values <code>seen</code> will be contradictory information.  Therefore, the key is <code>(suit, face)</code> , and there are no more keys in this table. <br><br><blockquote><h4>  Uniqueness constraints </h4><br>  In PostgreSQL, the preferred way to add a uniqueness constraint is its direct declaration, as in our example.  Using indexes to enforce uniqueness constraints may be necessary in some cases, but it is not necessary to contact them directly.  It is not necessary to manually create indexes for columns already declared unique;  such actions will simply duplicate the automatic index creation. </blockquote><br>  Also, there may be several keys in the table without problems, and we must declare them <em>all</em> in order to observe their uniqueness in the database. <br><br>  Here are two examples of tables with multiple keys. <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   CREATE TABLE tax_brackets ( min_income numeric(8,2), max_income numeric(8,2), tax_percent numeric(3,1), UNIQUE(min_income), UNIQUE(max_income), UNIQUE(tax_percent) ); --   CREATE TABLE flight_roster ( departure timestamptz, gate text, pilot text UNIQUE(departure, gate), UNIQUE(departure, pilot) );</span></span></code> </pre> <br>  For the sake of brevity, there are no other limitations in the examples that would be in practice.  For example, maps should not have a negative number of views, and a NULL value is unacceptable for most of the columns considered (with the exception of the <code>max_income</code> column for tax groups, in which NULL can denote infinity). <br><a name="happening"></a><br><h3>  Curious case of primary keys </h3><br>  What we called simply ‚Äúkeys‚Äù in the previous section is usually called ‚Äúcandidate keys‚Äù.  The term ‚Äúcandidate‚Äù implies that all such keys compete for the honorable role of a ‚Äúprimary key‚Äù (primary key), and the remaining ones are assigned to ‚Äúalternative keys‚Äù (alternate keys). <br><br>  It took some time for the mismatch between keys and the relational model to disappear in SQL implementations, the earliest databases were sharpened under the low-level concept of a primary key.  Primary keys in such databases were required to identify the physical location of the string on media with sequential access to data.  Here is how Joe Selco explains it: <br><br><blockquote>  The term ‚Äúkey‚Äù meant the sort key of a file that was needed to perform any processing operations on a sequential file system.  A set of punched cards was read in one and only one order;  it was impossible to "go back."  The first tape drives imitated the same behavior and did not allow bidirectional access.  That is, the original Sybase SQL Server to read the previous line required to "rewind" the table to the beginning. </blockquote><br>  In modern SQL, there is no need to focus on the physical presentation of information; tables model relationships and the internal order of rows is not important at all.  However, now the SQL server by default creates a clustered index for primary keys and, according to the old tradition, physically builds the order of the rows. <br><br>  In most databases, the primary keys are preserved as a relic of the past, and they hardly provide anything but a reflection or definition of physical location.  For example, in a PostgreSQL table, a primary key declaration automatically imposes a NOT NULL constraint and determines the default foreign key.  In addition, primary keys are the preferred columns for the JOIN operator. <br><br>  The primary key does not cancel the possibility of declaring other keys.  At the same time, if no key is assigned primary, the table will still work normally.  Lightning, in any case, will not strike you. <br><a name="choice"></a><br><h3>  Finding Natural Keys </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jm/md/3o/jmmd3odorwwctoymsqqob8vh1zu.jpeg"></div><br>  The keys discussed above are called ‚Äúnatural‚Äù because they are the properties of the object being simulated interesting in and of themselves, even if no one wants to make a key out of them. <br><br>  The first thing to remember when examining the table for possible natural keys is to try not to be too smart.  The user sqlvogel on StackExchange gives the following advice: <br><br><blockquote>  Some people have difficulty choosing the ‚Äúnatural‚Äù key because they come up with hypothetical situations in which a certain key may not be unique.  They do not understand the very meaning of the problem.  The meaning of the key is to determine the rule according to which attributes at any time should be and always will be unique in a particular table.  The table contains data in a specific and well-understood context (in the "subject area" or in the "area of ‚Äã‚Äãdiscourse") and the application of a restriction in this particular area is of the only importance. </blockquote><br>  Practice shows that it is necessary to impose a restriction on the key, when the column is unique with the available values ‚Äã‚Äãand will remain that under probable scenarios.  And if necessary, the restriction can be eliminated (if it bothers you, then we will tell you about the stability of the key.) <br><br>  For example, a database of members of a hobby club may be unique in two columns - first_name, last_name.  With a small amount of data, duplicates are unlikely, and it is quite reasonable to use such a key until a real conflict occurs. <br><br>  As the database grows and the amount of information increases, choosing a natural key can become more difficult.  The data stored by us are a simplification of external reality, and do not contain some aspects that distinguish objects in the world, such as their coordinates changing with time.  If an object does not have any code, then how to distinguish between two cans of drink or two boxes of oatmeal, except by their location in space or by slight differences in weight or packaging? <br><br>  That is why standardization bodies create and apply distinctive marks on products.  Vehicle Identification Number (VIN) is stamped on cars, an ISBN is printed in books, there is a UPC on the food packaging.  You can argue that these numbers do not seem natural.  So why do I call them natural keys? <br><br>  The naturalness or artificiality of unique properties in a database is relative to the outside world.  The key, which, when created in a standardization body or a state institution, was artificial, becomes natural for us, because in the whole world it becomes a standard and / or printed on objects. <br>  There are many industry, public, and international standards for various sites, including currencies, languages, financial instruments, chemicals, and medical diagnoses.  Here are some of the values ‚Äã‚Äãthat are often used as natural keys: <br><br><ul><li>  ISO 3166 country codes </li><li>  ISO 639 language codes </li><li>  Currency codes according to ISO 4217 </li><li>  ISIN exchange symbols </li><li>  UPC / EAN, VIN, GTIN, ISBN </li><li>  login names </li><li>  email addresses </li><li>  rooms numbers </li><li>  mac address in network </li><li>  (latitude, longitude) for points on the surface of the earth </li></ul><br>  We recommend declaring keys when it is possible and reasonable, maybe even a few keys per table.  But remember that all of the above may have exceptions. <br><br><ul><li>  Not everyone has an email address, although this may be acceptable in some database usage conditions.  In addition, people change their email addresses from time to time.  (More on key stability later.) </li><li>  ISIN trade names change from time to time, for example, the characters GOOG and GOOGL do not accurately describe the reorganization of a company from Google into Alphabet.  Sometimes there may be confusion, such as with TWTR and TWTRQ, some investors mistakenly bought the last during the Twitter IPO. </li><li>  Social Security numbers are used only by US citizens, have confidentiality restrictions and are reused after death.  In addition, after the theft of documents, people can get new numbers.  Finally, the same number can identify both the person and the tax ID. </li><li>  Zip codes are a poor choice for cities.  Some cities have a common index, or vice versa, there are several indices in one city. </li></ul><br><a name="artificial"></a><br><h3>  Artificial keys </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i8/d7/gx/i8d7gx7j1n5dp71oiowl2qhyfyo.png"></div><br>  Taking into account that the key is a column, in each row of which there are unique values, one of the ways to create it is a scam - you can write imaginary unique values ‚Äã‚Äãinto each row.  These are artificial keys: invented code used to refer to data or objects. <br><br>  It is very important that the code is generated from the database itself and is unknown to anyone other than database users.  This is what distinguishes artificial keys from standardized natural keys. <br><br>  The advantage of natural keys is to protect against duplication or inconsistency of rows of the table, artificial keys are useful because they allow people or other systems to more easily refer to a row, and also increase the speed of search and merge operations, since they do not use string comparisons (or multi-column) keys. <br><blockquote><h4>  Surrogates </h4><br>  Artificial keys are used as a binding - regardless of changes to the rules and columns, one line can always be identified in the same way.  The artificial key used for this purpose is called the ‚Äúsurrogate key‚Äù and requires special attention.  Surrogates will be discussed below. </blockquote>  Non-surrogate artificial keys are convenient for references to a string <em>outside</em> the database.  An artificial key briefly identifies data or an object: it can be specified as a URL, attached to an account, dictated by telephone, received in a bank or printed on a license plate.  (The license plate of the car is a natural key for us, but it was designed by the state as an artificial key.) <br><br>  Artificial keys should be chosen, taking into account possible ways of their transmission, in order to minimize typos and errors.  It should be noted that the key can be pronounced, read typed, sent via SMS, read handwritten, entered from the keyboard and embedded in the URL.  Additionally, some artificial keys, such as credit card numbers, contain <a href="https://begriffs.com/posts/2017-10-21-sql-domain-integrity.html">a checksum</a> so that when certain errors occur they can at least be recognized. <br><br>  Examples: <br><br><ul><li>  For US license plates, there are <a href="https://en.wikipedia.org/wiki/United_States_license_plate_designs_and_serial_formats">rules</a> on the use of ambiguous features, such as <code>O</code> and <code>0</code> . </li><li>  Hospitals and pharmacies should be especially careful, given the doctors' handwriting. </li><li>  Do you pass the confirmation code to the sms?  Do not go beyond the <a href="https://en.wikipedia.org/wiki/GSM_03.38">GSM 03.38</a> character set. </li><li>  Unlike Base64, which encodes arbitrary byte data, <a href="https://philzimmermann.com/docs/human-oriented-base-32-encoding.txt">Base32</a> uses a limited set of characters that is convenient for people to use and process on older computer systems. </li><li>  <a href="">Proquints</a> are readable, writable, and spoken identifiers.  These are the pronounced (PRO-nouncable) fives (QUINT-uplets) of uniquely understood consonants and vowels. </li></ul><br>  Consider that as soon as you introduce the world to your artificial key, people will start giving special attention to it in a strange way.  Just look at the "thieves" license plates or the system for creating pronounced identifiers, which has become a notorious <a href="http://thedailywtf.com/articles/The-Automated-Curse-Generator">automated curse generator</a> . <br><br>  Even if we restrict ourselves to numeric keys, there is a taboo of the <a href="https://en.wikipedia.org/wiki/Thirteenth_floor">thirteenth floor</a> type.  Despite the fact that proquints have a greater density of information on the spoken syllable, the numbers are also quite good in many cases: in the URL, pin-keyboards and handwritten entries, if the recipient knows that the key consists only of numbers. <br>  However, please note that you should not use a sequential order in publicly open numeric keys, as this allows you to rummage through resources ( <code>/videos/1.mpeg</code> , <code>/videos/2.mpeg</code> , and so on), and also creates a leak of information about data.  Overlay a network of its Feistel on a sequence of numbers and preserve its uniqueness, while hiding the order of numbers. <br>  The PostgreSQL wiki has an example of a <a href="https://wiki.postgresql.org/wiki/Pseudo_encrypt">pseudo-encryption</a> function: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pseudo_encrypt(<span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> l1 <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; l2 int; r1 int; r2 int; i int:=0; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> l1:= (<span class="hljs-keyword"><span class="hljs-keyword">VALUE</span></span> &gt;&gt; <span class="hljs-number"><span class="hljs-number">16</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">65535</span></span>; r1:= VALUE &amp; 65535; WHILE i &lt; 3 LOOP l2 := r1; r2 := l1 <span class="hljs-comment"><span class="hljs-comment"># ((((1366 * r1 + 150889) % 714025) / 714025.0) * 32767)::int; l1 := l2; r1 := r2; i := i + 1; END LOOP; RETURN ((r1 &lt;&lt; 16) + l1); END; $$ LANGUAGE plpgsql strict immutable;</span></span></code> </pre> <br>  This function is the inverse of itself (i.e., <code>pseudo_encrypt(pseudo_encrypt(x)) = x</code> ).  Exact reproduction of a function is a kind of security through obscurity, and if someone guesses that you used the Feistel network from the PostgreSQL documentation, it will be easy for him to get the original sequence.  However, instead of <code>(((1366 * r1 + 150889) % 714025) / 714025.0)</code> you can use another function with a range of values ‚Äã‚Äãfrom 0 to 1, for example, just experiment with the numbers in the previous expression. <br><br>  Here's how to use pseudo_encrypt: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> my_table_seq; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> my_table ( short_id <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> pseudo_encrypt( <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'my_table_seq'</span></span>)::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> ), <span class="hljs-comment"><span class="hljs-comment">--   ‚Ä¶ UNIQUE (short_id) );</span></span></code> </pre> <br>  This solution saves random values ‚Äã‚Äãin the <code>short_id</code> column, but if it is important to maintain high processing speeds, then you can store the incremental sequence itself in the table and convert it when you request a display using <code>pseudo_encrypt</code> .  As we will see later, indexing randomized values ‚Äã‚Äãcan lead to an increase in the recording volume. <br><br>  In the previous example, normal-sized integer values ‚Äã‚Äãwere used for <code>short_id</code> , for <code>bigint</code> there are other Feistel functions, for example <a href="https://en.wikipedia.org/wiki/XTEA">XTEA</a> . <br><br>  Another way to confuse a sequence of integers is to convert it to short strings.  Try using the <a href="https://github.com/iCyberon/pg_hashids">pg_hashids</a> extension: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION pg_hashids; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SEQUENCE</span></span> my_table_seq; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> my_table ( short_id <span class="hljs-built_in"><span class="hljs-built_in">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> id_encode( <span class="hljs-keyword"><span class="hljs-keyword">nextval</span></span>(<span class="hljs-string"><span class="hljs-string">'my_table_seq'</span></span>), <span class="hljs-string"><span class="hljs-string">' long string as table-specific salt '</span></span> ), <span class="hljs-comment"><span class="hljs-comment">--   ‚Ä¶ UNIQUE (short_id) ); INSERT INTO my_table VALUES (DEFAULT), (DEFAULT), (DEFAULT); SELECT * FROM my_table; /* ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ short_id ‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ R4 ‚îÇ ‚îÇ ya ‚îÇ ‚îÇ Ll ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò */</span></span></code> </pre> <br>  Here again it will be faster to store the whole numbers in the table and convert them on demand, but measure the performance and see if it really makes sense. <br><br>  Now, clearly distinguishing between the meaning of artificial and natural keys, we see that the ‚Äúnatural vs. artificial‚Äù disputes are a false dichotomy.  Artificial and natural keys are not mutually exclusive!  In one table there can be both.  In fact, a table with an artificial key should also provide a natural key, with rare exceptions, when there is no natural key (for example, in the coupon code table): <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   :    , --        "code" CREATE TABLE coupons ( code text NOT NULL, amount numeric(5,2) NOT NULL, redeemed boolean NOT NULL DEFAULT false, UNIQUE (code) );</span></span></code> </pre> <br>  If you have an artificial key and you do not declare natural keys when they exist, then leave the latter unprotected: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> cars ( car_id bigserial <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, vin <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">year</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (car_id) <span class="hljs-comment"><span class="hljs-comment">--    -- UNIQUE (vin) ); --  ,    INSERT INTO cars (vin, year) VALUES ('1FTJW36F2TEA03179', 1996), ('1FTJW36F2TEA03179', 1997);</span></span></code> </pre> <br>  The only argument against declaring additional keys is that each new one carries with it another unique index and increases the cost of writing to the table.  Of course, it depends on how important the data is to you, but, most likely, the keys are still worth declaring. <br><br>  Also worth declaring a few artificial keys, if any.  For example, an organization has applicants for work (Applicants) and employees (Employees).  Each employee was once a candidate, and refers to candidates by their own identifier, which must also be the key of the employee.  One more example, you can set an employee ID and login name as two keys in Employees. <br><a name="surrogate"></a><br><h3>  Surrogate keys </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dd/-f/zg/dd-fzgs_e5sakqf9cstti_kpcr0.jpeg"></div><br>  As already mentioned, an important type of artificial key is called a ‚Äúsurrogate key‚Äù.  It should not be short and transferable, like other artificial keys, but is used as an internal label, always identifying a string.  It is used in SQL, but the application does not explicitly refer to it. <br><br>  If you are familiar with the <a href="https://www.postgresql.org/docs/10/static/ddl-system-columns.html">system columns</a> from the PostgreSQL system, then you can take surrogates almost as a database implementation parameter (like ctid), which, however, never changes.  The value of the surrogate is selected once for each line and then never changes. <br><br>  Surrogate keys are great as foreign keys, with cascading constraints <code>ON UPDATE RESTRICT</code> necessary to match the immutability of the surrogate. <br><br>  On the other hand, foreign keys to publicly transmitted keys must be labeled <code>ON UPDATE CASCADE</code> to provide maximum flexibility.  (A cascading update is performed at the same <a href="https://begriffs.com/posts/2017-08-01-practical-guide-sql-isolation.html">isolation level</a> as the transaction surrounding it, so don‚Äôt worry about concurrent access problems ‚Äî the database can handle if you choose a strict isolation level.) <br><br>  Do not make surrogate keys "natural."<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As soon as you show the value of the surrogate key to the end users, or, worse, let them work with this value (in particular through a search), you will in fact give the key meaning. </font><font style="vertical-align: inherit;">Then the displayed key from your database can become a natural key in someone else's database. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Forcing external systems to use other artificial keys specifically designed for transmission allows us, if necessary, to change these keys in accordance with changing needs, while at the same time maintaining the internal integrity of the links using surrogates.</font></font><br><a name="auto-increment"></a><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Auto-increment bigint </font></font></h4><br>         ¬´bigserial¬ª,    <code>IDENTITY</code> . (  , PostgreSQL 10 ,   Oracle,   IDENTITY, . <a href="https://www.postgresql.org/docs/10/static/sql-createtable.html">CREATE TABLE</a> .) <br><br> ,  ,        .   ,    . <br><br>   : <br><br><ul><li>      1   ,          .   ,         , , ,         JOIN    . (     ,      ,   ,     .) </li><li>  <code>nextval()</code>       SQL,   ,     . </li><li>     ,      ,   ,          . </li><li>           ,     .       ,     ,       -     .       . </li><li> ( , )        -. </li></ul><br><a name="uuid"></a><br><h4> UUID </h4><br>    :     (128-),      .       (universally unique identifier, UUID)        ,        . <br><br>   , UUID         ,   ?       ,       ! <br><br>         PostgreSQL?         ,   ,    ,    . <br><br>  ,    .   ,  UUID ‚Äî  ,          : 5bd68e64-ff52-4f54-ace4-3cd9161c8b7f. ,       (128-)  uuid,   PostgreSQL <a href="https://www.postgresql.org/docs/current/static/datatype-uuid.html"> </a>     bigint, ..,         ,  . <br><br>  UUID    ,     ,   ?  ,        ,   ( )     UUID. ,  UUID    ,   SQL  psql   ,    .            ,   . <br><br> <strong>   UUID  ,          (write amplification) -         (write-ahead log, WAL).</strong> ,          UUID. <br><br>   write amplification.   ,     .  PostgreSQL    ,   ¬´¬ª  .                ,      .  PostgreSQL     ,         . <br><br>  PostgreSQL     / /     ,              (write-ahead log),         .      UUID              ( 4  8 )  WAL    .      (full-page write, FPW). <br><br>    UUID (,  ¬´snowflake¬ª  Twitter  <code>uuid_generate_v1()</code>   <a href="https://www.postgresql.org/docs/10/static/uuid-ossp.html">uuid-ossp</a>  PostgreSQL)       .            FPW. <br><br>    FPW     UUID,     WAL.      . <br><br><ul><li>  EC2   ami-aa2ea6d0 <br><ul><li> Ubuntu Server 16.04 LTS (HVM) </li><li> EBS General Purpose (SSD) </li><li> c3.xlarge </li><li> vCPU: 4 </li><li> RAM GiB: 7.5 </li><li> Disk GB: 2 x 40 (SSD) </li></ul></li><li> PostgreSQL,    <br><ul><li> <a href="">ftp.postgresql.org/pub/source/v10.1/postgresql-10.1.tar.gz</a> </li><li> <code>./configure --with-uuid=ossp CFLAGS="-O3"</code> </li> </ul></li><li>     ,   : <br><ul><li> max_wal_size='10GB'; </li><li> checkpoint_timeout='2h'; </li><li> synchronous_commit='off'; </li></ul></li></ul><br>  Scheme: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION <span class="hljs-string"><span class="hljs-string">"uuid-ossp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> EXTENSION pgcrypto; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> u_v1 ( u <span class="hljs-keyword"><span class="hljs-keyword">uuid</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> u_crypto ( u <span class="hljs-keyword"><span class="hljs-keyword">uuid</span></span> PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> );</code> </pre> <br>  ,   UUID   ,    write-ahead log. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_walfile_name(pg_current_wal_lsn()); <span class="hljs-comment"><span class="hljs-comment">/* , pg_walfile_name -------------------------- 000000010000000000000001 */</span></span></code> </pre> <br>    ,      WAL   .     ,     : <br><br><pre> <code class="sql hljs">pg_waldump <span class="hljs-comment"><span class="hljs-comment">--stats 000000010000000000000001</span></span></code> </pre> <br>     : <br><br><ol><li>  UUID,   <code>gen_random_uuid()</code> ( <a href="https://www.postgresql.org/docs/10/static/pgcrypto.html">pgcrypto</a> ) </li><li>   <code>uuid_generate_v1()</code> ( [uuid-ossp] (https://www.postgresql.org/docs/10/static/uuid-ossp.html) </li><li>    <code>gen_random_uuid()</code> ,     <code>full_page_writes='off'</code>   .  ,       FPW. </li></ol><br>             2 <sup>20</sup> UUID     ,    ,  ,         . <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- ,     psql 16    \timing INSERT INTO u_crypto ( SELECT gen_random_uuid() FROM generate_series(1, 1024*1024) );</span></span></code> </pre> <br>     : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yf/nq/li/yfnqliema9cvcptjyar_ibmdctu.png"></div><br> <i>   UUID</i> <br><br>   WAL    : <br><br><pre> gen_random_uuid()<font></font>
<font></font>
 N (%)   (%)  FPI (%)<font></font>
---- - --- ----------- --- -------- ---<font></font>
XLOG 260 ( 0.15) 13139 ( 0.09) 484420 ( 30.94)<font></font>
Heap2 765 ( 0.45) 265926 ( 1.77) 376832 ( 24.07)<font></font>
Heap 79423 ( 46.55) 6657121 ( 44.20) 299776 ( 19.14)<font></font>
Btree 89354 ( 52.37) 7959710 ( 52.85) 404832 ( 25.85)<font></font>
<font></font>
uuid_generate_v1()<font></font>
<font></font>
 N (%)   (%)  FPI (%)<font></font>
---- - --- ----------- --- -------- ---<font></font>
XLOG 0 ( 0.00) 0 ( 0.00) 0 ( 0.00)<font></font>
Heap2 0 ( 0.00) 0 ( 0.00) 0 ( 0.00)<font></font>
Heap 104326 ( 49.88) 7407146 ( 44.56) 0 ( 0.00)<font></font>
Btree 104816 ( 50.12) 9215394 ( 55.44) 0 ( 0.00)<font></font>
<font></font>
gen_random_uuid() with fpw=off<font></font>
<font></font>
 N (%)   (%)  FPI (%)<font></font>
---- - --- ----------- --- -------- ---<font></font>
XLOG 4 ( 0.00) 291 ( 0.00) 64 ( 0.84)<font></font>
Heap2 0 ( 0.00) 0 ( 0.00) 0 ( 0.00)<font></font>
Heap 107778 ( 49.88) 7654268 ( 46.08) 0 ( 0.00)<font></font>
Btree 108260 ( 50.11) 8956097 ( 53.91) 7556 ( 99.16) </pre><br>  ,  <code>gen_random_uuid</code>     WAL -   (full-page images, FPI),      . ,          .   FPW   ,      ,            .  <a href="https://blog.2ndquadrant.com/pg-phriday-postgres-zfs/"> </a> ,  ZFS      FPW,     . <br><br>       <code>uuid_generate_v1()</code> ‚Äì        .  uuid-ossp        ,  RDS  Citus Cloud,      . <br><br>      uuid_generate_v1: <br><br><blockquote>    MAC-    . ,  UUID      ,   ,    ,    ,    . </blockquote><br><br>    ,   ,      .    -   ,    <code>uuid_generate_v1mc()</code> ,  mac- . <br><a name="sum"></a><br><h3>    </h3><br> ,           ,            . <br><br>   : <br><br><ol><li>      . </li><li>    <code>&lt;table_name&gt;_id</code>  <code>uuid</code>      <code>uuid_generate_v1()</code> .       .       ,   JOIN, ..  <code>JOIN foo USING (bar_id)</code>  <code>JOIN foo ON (foo.bar_id = bar.id)</code> .             . </li><li>   ,    JOIN,          . </li><li>     ,     URL      .     pg_hashids,    . </li><li>    <code>ON UPDATE RESTRICT</code> ,   UUID    ,      ‚Äì <code>ON UPDATE CASCADE</code> .   ,    . </li></ol><br><br>      ,          .   ,       - .    ,      ¬´ ¬ª      . <br><br><hr><br>         .         -, ,    ,    -  ,      <a href="http://ritfest.ru/">++</a>     , 8        ,   DevOps  .      <a href="http://speakers.ritfest.ru/"></a> . </div><p>Source: <a href="https://habr.com/ru/post/348172/">https://habr.com/ru/post/348172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348160/index.html">Zimbra vs. Microsoft Office 365</a></li>
<li><a href="../348162/index.html">Anonymous cryptocurrencies: why Edward Snowden supports the concept of proof with zero disclosure</a></li>
<li><a href="../348164/index.html">Great developer, true engineer and real leader - RIP Shawn O. Pearce</a></li>
<li><a href="../348168/index.html">Basics of programming on the SAS Base. Lesson 1</a></li>
<li><a href="../348170/index.html">JS Transducers - Are They Necessary?</a></li>
<li><a href="../348174/index.html">Implementing a simple pixel game in the Ethereum blockchain</a></li>
<li><a href="../348176/index.html">Automate when you can, program when necessary</a></li>
<li><a href="../348182/index.html">Testing the performance of hyperconvergent systems and SDS do it yourself</a></li>
<li><a href="../348184/index.html">Wine 3.0 and many goodies</a></li>
<li><a href="../348188/index.html">Introduction to Data Vault</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>